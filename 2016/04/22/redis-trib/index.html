<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="redis,redis cluster," />





  <link rel="alternate" href="/atom.xml" title="IdiotSky" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。为了看懂redis-trib.rb，我特意花了一个星期学习了ruby，也被ruby的简洁、明了所吸引。ruby是门非常灵活的语言，redis-trib.rb只用了1">
<meta name="keywords" content="redis,redis cluster">
<meta property="og:type" content="article">
<meta property="og:title" content="redis cluster管理工具redis-trib.rb详解">
<meta property="og:url" content="http://idiotsky.me/2016/04/22/redis-trib/index.html">
<meta property="og:site_name" content="IdiotSky">
<meta property="og:description" content="redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。为了看懂redis-trib.rb，我特意花了一个星期学习了ruby，也被ruby的简洁、明了所吸引。ruby是门非常灵活的语言，redis-trib.rb只用了1">
<meta property="og:updated_time" content="2017-09-10T15:23:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis cluster管理工具redis-trib.rb详解">
<meta name="twitter:description" content="redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。为了看懂redis-trib.rb，我特意花了一个星期学习了ruby，也被ruby的简洁、明了所吸引。ruby是门非常灵活的语言，redis-trib.rb只用了1">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '4C652JRMON',
      apiKey: 'ef468e206fb85903f33c4fc8b4bb2cd6',
      indexName: 'myblog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://idiotsky.me/2016/04/22/redis-trib/"/>





  <title>redis cluster管理工具redis-trib.rb详解 | IdiotSky</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c2da852ee703ae71196b173fd6edef51";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IdiotSky</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            Books
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://idiotsky.me/2016/04/22/redis-trib/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ejunjsh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars7.githubusercontent.com/u/22493186?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IdiotSky">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">redis cluster管理工具redis-trib.rb详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-22T23:40:47+08:00">
                22 Apr 16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>redis-trib.rb是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具。redis-trib.rb是redis作者用ruby完成的。为了看懂redis-trib.rb，我特意花了一个星期学习了ruby，也被ruby的简洁、明了所吸引。ruby是门非常灵活的语言，redis-trib.rb只用了1600行左右的代码，就实现了强大的集群操作。本文对redis-trib.rb的介绍是基于redis 3.0.6版本的源码。阅读本文需要对redis集群功能有一定的了解。关于redis集群功能的介绍，可以参考本人的另一篇文章《redis3.0 cluster功能介绍》。</p>
</blockquote>
<a id="more"></a>
<h1 id="help-信息"><a href="#help-信息" class="headerlink" title="help 信息"></a>help 信息</h1><p>先从redis-trib.rb的help信息，看下redis-trib.rb提供了哪些功能。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb <span class="built_in">help</span></div><div class="line">Usage: redis-trib &lt;<span class="built_in">command</span>&gt; &lt;options&gt; &lt;arguments ...&gt;</div><div class="line"></div><div class="line">  create          host1:port1 ... hostN:portN</div><div class="line">                  --replicas &lt;arg&gt;</div><div class="line">  check           host:port</div><div class="line">  info            host:port</div><div class="line">  fix             host:port</div><div class="line">                  --timeout &lt;arg&gt;</div><div class="line">  reshard         host:port</div><div class="line">                  --from &lt;arg&gt;</div><div class="line">                  --to &lt;arg&gt;</div><div class="line">                  --slots &lt;arg&gt;</div><div class="line">                  --yes</div><div class="line">                  --timeout &lt;arg&gt;</div><div class="line">                  --pipeline &lt;arg&gt;</div><div class="line">  rebalance       host:port</div><div class="line">                  --weight &lt;arg&gt;</div><div class="line">                  --auto-weights</div><div class="line">                  --threshold &lt;arg&gt;</div><div class="line">                  --use-empty-masters</div><div class="line">                  --timeout &lt;arg&gt;</div><div class="line">                  --simulate</div><div class="line">                  --pipeline &lt;arg&gt;</div><div class="line">  add-node        new_host:new_port existing_host:existing_port</div><div class="line">                  --slave</div><div class="line">                  --master-id &lt;arg&gt;</div><div class="line">  del-node        host:port node_id</div><div class="line">  <span class="built_in">set</span>-timeout     host:port milliseconds</div><div class="line">  call            host:port <span class="built_in">command</span> arg arg .. arg</div><div class="line">  import          host:port</div><div class="line">                  --from &lt;arg&gt;</div><div class="line">                  --copy</div><div class="line">                  --replace</div><div class="line">  <span class="built_in">help</span>            (show this <span class="built_in">help</span>)</div><div class="line"></div><div class="line">For check, fix, reshard, del-node, <span class="built_in">set</span>-timeout you can specify the host and port of any working node <span class="keyword">in</span> the cluster.</div></pre></td></tr></table></figure></p>
<p>可以看到redis-trib.rb具有以下功能：<br>1、create：创建集群<br>2、check：检查集群<br>3、info：查看集群信息<br>4、fix：修复集群<br>5、reshard：在线迁移slot<br>6、rebalance：平衡集群节点slot数量<br>7、add-node：将新节点加入集群<br>8、del-node：从集群中删除节点<br>9、set-timeout：设置集群节点间心跳连接的超时时间<br>10、call：在集群全部节点上执行命令<br>11、import：将外部redis数据导入集群<br>下面从redis-trib.rb使用和源码的角度详细介绍redis-trib.rb的每个功能。</p>
<p>redis-trib.rb主要有两个类：ClusterNode和RedisTrib。ClusterNode保存了每个节点的信息，RedisTrib则是redis-trib.rb各个功能的实现。</p>
<h1 id="ClusterNode对象"><a href="#ClusterNode对象" class="headerlink" title="ClusterNode对象"></a>ClusterNode对象</h1><p>先分析ClusterNode源码。ClusterNode有下面几个成员变量（ruby的类成员变量是以@开头的）：<br>@r：执行redis命令的客户端对象。<br>@info：保存了该节点的详细信息，包括cluster nodes命令中自己这行的信息和cluster info的信息。<br>@dirty：节点信息是否需要更新，如果为true，我们需要把内存的节点更新信息到节点上。<br>@friends：保存了集群其他节点的info信息。其信息为通过cluster nodes命令获得的其他节点信息。<br>ClusterNode有下面一些成员方法：<br>initialize：ClusterNode的构造方法，需要传入节点的地址信息。<br>friends：返回@friends对象。<br>slots：返回该节点负责的slots信息。<br>has_flag?：判断节点info信息的的flags中是否有给定的flag。<br>to_s：类似java的toString方法，返回节点的地址信息。<br>connect：连接redis节点。<br>assert_cluster：判断节点开启了集群配置。<br>assert_empty：确定节点目前没有跟任何其他节点握手，同时自己的db数据为空。<br>load_info：通过cluster info和cluster nodes导入节点信息。<br>add_slots：给节点增加slot，该操作只是在内存中修改，并把dirty设置成true，等待flush_node_config将内存中的数据同步在节点执行。<br>set_as_replica：slave设置复制的master地址。dirty设置成true。<br>flush_node_config：将内存的数据修改同步在集群节点中执行。<br>info_string：简单的info信息。<br>get_config_signature：用来验证集群节点见的cluster nodes信息是否一致。该方法返回节点的签名信息。<br>info：返回@info对象，包含详细的info信息。<br>is_dirty?：判断@dirty。<br>r：返回执行redis命令的客户端对象。</p>
<p>有了ClusterNode对象，在处理集群操作的时候，就获得了集群的信息，可以进行集群相关操作。在此先简单介绍下redis-trib.rb脚本的使用，以create为例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">create host1:port1 ... hostN:portN</div><div class="line">       --replicas &lt;arg&gt;</div></pre></td></tr></table></figure></p>
<p>host1:port1 … hostN:portN表示子参数，这个必须在可选参数之后，–replicas <arg>是可选参数，带的表示后面必须填写一个参数，像–slave这样，后面就不带参数，掌握了这个基本规则，就能从help命令中获得redis-trib.rb的使用方法。</arg></p>
<p>其他命令大都需要传递host:port，这是redis-trib.rb为了连接集群，需要选择集群中的一个节点，然后通过该节点获得整个集群的信息。</p>
<p>下面就一一详细介绍redis-trib.rb的每个功能。</p>
<h1 id="create创建集群"><a href="#create创建集群" class="headerlink" title="create创建集群"></a>create创建集群</h1><p>create命令可选replicas参数，replicas表示需要有几个slave。最简单命令使用如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb create 10.180.157.199:6379 10.180.157.200:6379 10.180.157.201:6379</div></pre></td></tr></table></figure></p>
<p>有一个slave的创建命令如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb create --replicas 1 10.180.157.199:6379 10.180.157.200:6379 10.180.157.201:6379 10.180.157.202:6379  10.180.157.205:6379  10.180.157.208:6379</div></pre></td></tr></table></figure></p>
<p>创建流程如下：<br>1、首先为每个节点创建ClusterNode对象，包括连接每个节点。检查每个节点是否为独立且db为空的节点。执行load_info方法导入节点信息。<br>2、检查传入的master节点数量是否大于等于3个。只有大于3个节点才能组成集群。<br>3、计算每个master需要分配的slot数量，以及给master分配slave。分配的算法大致如下：<br>先把节点按照host分类，这样保证master节点能分配到更多的主机中。<br>不停遍历遍历host列表，从每个host列表中弹出一个节点，放入interleaved数组。直到所有的节点都弹出为止。<br>master节点列表就是interleaved前面的master数量的节点列表。保存在masters数组。<br>计算每个master节点负责的slot数量，保存在slots_per_node对象，用slot总数除以master数量取整即可。<br>遍历masters数组，每个master分配slots_per_node个slot，最后一个master，分配到16384个slot为止。<br>接下来为master分配slave，分配算法会尽量保证master和slave节点不在同一台主机上。对于分配完指定slave数量的节点，还有多余的节点，也会为这些节点寻找master。分配算法会遍历两次masters数组。<br>第一次遍历masters数组，在余下的节点列表找到replicas数量个slave。每个slave为第一个和master节点host不一样的节点，如果没有不一样的节点，则直接取出余下列表的第一个节点。<br>第二次遍历是在对于节点数除以replicas不为整数，则会多余一部分节点。遍历的方式跟第一次一样，只是第一次会一次性给master分配replicas数量个slave，而第二次遍历只分配一个，直到余下的节点被全部分配出去。<br>4、打印出分配信息，并提示用户输入“yes”确认是否按照打印出来的分配方式创建集群。<br>5、输入“yes”后，会执行flush_nodes_config操作，该操作执行前面的分配结果，给master分配slot，让slave复制master，对于还没有握手（cluster meet）的节点，slave复制操作无法完成，不过没关系，flush_nodes_config操作出现异常会很快返回，后续握手后会再次执行flush_nodes_config。<br>6、给每个节点分配epoch，遍历节点，每个节点分配的epoch比之前节点大1。<br>7、节点间开始相互握手，握手的方式为节点列表的其他节点跟第一个节点握手。<br>8、然后每隔1秒检查一次各个节点是否已经消息同步完成，使用ClusterNode的get_config_signature方法，检查的算法为获取每个节点cluster nodes信息，排序每个节点，组装成node_id1:slots|node_id2:slot2|…的字符串。如果每个节点获得字符串都相同，即认为握手成功。<br>9、此后会再执行一次flush_nodes_config，这次主要是为了完成slave复制操作。<br>10、最后再执行check_cluster，全面检查一次集群状态。包括和前面握手时检查一样的方式再检查一遍。确认没有迁移的节点。确认所有的slot都被分配出去了。<br>11、至此完成了整个创建流程，返回[OK] All 16384 slots covered.。</p>
<h1 id="check检查集群"><a href="#check检查集群" class="headerlink" title="check检查集群"></a>check检查集群</h1><p>检查集群状态的命令，没有其他参数，只需要选择一个集群中的一个节点即可。执行命令以及结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb check 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)</div><div class="line">M: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">S: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates b2506515b38e6bbd3034d540599f4cd2a5279ad1</div><div class="line">M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">[OK] All nodes agree about slots configuration.</div><div class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</div><div class="line">&gt;&gt;&gt; Check slots coverage...</div><div class="line">[OK] All 16384 slots covered.</div></pre></td></tr></table></figure></p>
<p>检查前会先执行load_cluster_info_from_node方法，把所有节点数据load进来。load的方式为通过自己的cluster nodes发现其他节点，然后连接每个节点，并加入nodes数组。接着生成节点间的复制关系。</p>
<p>load完数据后，开始检查数据，检查的方式也是调用创建时候使用的check_cluster。</p>
<h1 id="info查看集群信息"><a href="#info查看集群信息" class="headerlink" title="info查看集群信息"></a>info查看集群信息</h1><p>info命令用来查看集群的信息。info命令也是先执行load_cluster_info_from_node获取完整的集群信息。然后显示ClusterNode的info_string结果，示例如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb info 10.180.157.199:6379</div><div class="line">10.180.157.199:6379 (b2506515...) -&gt; 0 keys | 5461 slots | 1 slaves.</div><div class="line">10.180.157.201:6379 (15126fb3...) -&gt; 0 keys | 5461 slots | 1 slaves.</div><div class="line">10.180.157.200:6379 (e36c46db...) -&gt; 0 keys | 5462 slots | 1 slaves.</div><div class="line">[OK] 0 keys <span class="keyword">in</span> 3 masters.</div><div class="line">0.00 keys per slot on average.</div></pre></td></tr></table></figure></p>
<h1 id="fix修复集群"><a href="#fix修复集群" class="headerlink" title="fix修复集群"></a>fix修复集群</h1><p>fix命令的流程跟check的流程很像，显示加载集群信息，然后在check_cluster方法内传入fix为<br>true的变量，会在集群检查出现异常的时候执行修复流程。目前fix命令能修复两种异常，一种是集群有处于迁移中的slot的节点，一种是slot未完全分配的异常。</p>
<p>fix_open_slot方法是修复集群有处于迁移中的slot的节点异常。<br>1、先检查该slot是谁负责的，迁移的源节点如果没完成迁移，owner还是该节点。没有owner的slot无法完成修复功能。<br>2、遍历每个节点，获取哪些节点标记该slot为migrating状态，哪些节点标记该slot为importing状态。对于owner不是该节点，但是通过cluster countkeysinslot获取到该节点有数据的情况，也认为该节点为importing状态。<br>3、如果migrating和importing状态的节点均只有1个，这可能是迁移过程中redis-trib.rb被中断所致，直接执行move_slot继续完成迁移任务即可。传递dots和fix为true。<br>4、如果migrating为空，importing状态的节点大于0，那么这种情况执行回滚流程，将importing状态的节点数据通过move_slot方法导给slot的owner节点，传递dots、fix和cold为true。接着对importing的节点执行cluster stable命令恢复稳定。<br>5、如果importing状态的节点为空，有一个migrating状态的节点，而且该节点在当前slot没有数据，那么可以直接把这个slot设为stable。<br>6、如果migrating和importing状态不是上述情况，目前redis-trib.rb工具无法修复，上述的三种情况也已经覆盖了通过redis-trib.rb工具迁移出现异常的各个方面，人为的异常情形太多，很难考虑完全。</p>
<p>fix_slots_coverage方法能修复slot未完全分配的异常。未分配的slot有三种状态。<br>1、所有节点的该slot都没有数据。该状态redis-trib.rb工具直接采用随机分配的方式，并没有考虑节点的均衡。本人尝试对没有分配slot的集群通过fix修复集群，结果slot还是能比较平均的分配，但是没有了连续性，打印的slot信息非常离散。<br>2、有一个节点的该slot有数据。该状态下，直接把slot分配给该slot有数据的节点。<br>3、有多个节点的该slot有数据。此种情况目前还处于TODO状态，不过redis作者列出了修复的步骤，对这些节点，除第一个节点，执行cluster migrating命令，然后把这些节点的数据迁移到第一个节点上。清除migrating状态，然后把slot分配给第一个节点。</p>
<h1 id="reshard在线迁移slot"><a href="#reshard在线迁移slot" class="headerlink" title="reshard在线迁移slot"></a>reshard在线迁移slot</h1><p>reshard命令可以在线把集群的一些slot从集群原来slot负责节点迁移到新的节点，利用reshard可以完成集群的在线横向扩容和缩容。<br>reshard的参数很多，下面来一一解释一番：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">reshard         host:port</div><div class="line">                --from &lt;arg&gt;</div><div class="line">                --to &lt;arg&gt;</div><div class="line">                --slots &lt;arg&gt;</div><div class="line">                --yes</div><div class="line">                --timeout &lt;arg&gt;</div><div class="line">                --pipeline &lt;arg&gt;</div></pre></td></tr></table></figure></p>
<p>host:port：这个是必传参数，用来从一个节点获取整个集群信息，相当于获取集群信息的入口。<br>–from <arg>：需要从哪些源节点上迁移slot，可从多个源节点完成迁移，以逗号隔开，传递的是节点的node id，还可以直接传递–from all，这样源节点就是集群的所有节点，不传递该参数的话，则会在迁移过程中提示用户输入。<br>–to <arg>：slot需要迁移的目的节点的node id，目的节点只能填写一个，不传递该参数的话，则会在迁移过程中提示用户输入。<br>–slots <arg>：需要迁移的slot数量，不传递该参数的话，则会在迁移过程中提示用户输入。<br>–yes：设置该参数，可以在打印执行reshard计划的时候，提示用户输入yes确认后再执行reshard。<br>–timeout <arg>：设置migrate命令的超时时间。<br>–pipeline <arg>：定义cluster getkeysinslot命令一次取出的key数量，不传的话使用默认值为10。</arg></arg></arg></arg></arg></p>
<p>迁移的流程如下：<br>1、通过load_cluster_info_from_node方法装载集群信息。<br>2、执行check_cluster方法检查集群是否健康。只有健康的集群才能进行迁移。<br>3、获取需要迁移的slot数量，用户没传递–slots参数，则提示用户手动输入。<br>4、获取迁移的目的节点，用户没传递–to参数，则提示用户手动输入。此处会检查目的节点必须为master节点。<br>5、获取迁移的源节点，用户没传递–from参数，则提示用户手动输入。此处会检查源节点必须为master节点。–from all的话，源节点就是除了目的节点外的全部master节点。这里为了保证集群slot分配的平均，建议传递–from all。<br>6、执行compute_reshard_table方法，计算需要迁移的slot数量如何分配到源节点列表，采用的算法是按照节点负责slot数量由多到少排序，计算每个节点需要迁移的slot的方法为：迁移slot数量 * (该源节点负责的slot数量 / 源节点列表负责的slot总数)。这样算出的数量可能不为整数，这里代码用了下面的方式处理：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">n = (numslots/source_tot_slots*s.slots.length)</div><div class="line"><span class="keyword">if</span> i == <span class="number">0</span></div><div class="line">    n = n.ceil</div><div class="line"><span class="keyword">else</span></div><div class="line">    n = n.floor</div></pre></td></tr></table></figure></p>
<p>这样的处理方式会带来最终分配的slot与请求迁移的slot数量不一致，这个BUG已经在github上提给作者，<a href="https://github.com/antirez/redis/issues/2990。" target="_blank" rel="external">https://github.com/antirez/redis/issues/2990。</a><br>7、打印出reshard计划，如果用户没传–yes，就提示用户确认计划。<br>8、根据reshard计划，一个个slot的迁移到新节点上，迁移使用move_slot方法，该方法被很多命令使用，具体可以参见下面的迁移流程。move_slot方法传递dots为true和pipeline数量。<br>9、至此，就完成了全部的迁移任务。<br>下面看下一次reshard的执行结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb reshard --from all --to 80b661ecca260c89e3d8ea9b98f77edaeef43dcd --slots 11 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)</div><div class="line">S: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates 460b3a11e296aafb2615043291b7dd98274bb351</div><div class="line">S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">M: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">M: 80b661ecca260c89e3d8ea9b98f77edaeef43dcd 10.180.157.200:6380</div><div class="line">   slots: (0 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">[OK] All nodes agree about slots configuration.</div><div class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</div><div class="line">&gt;&gt;&gt; Check slots coverage...</div><div class="line">[OK] All 16384 slots covered.</div><div class="line"></div><div class="line">Ready to move 11 slots.</div><div class="line">  Source nodes:</div><div class="line">    M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">    M: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">    M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">  Destination node:</div><div class="line">    M: 80b661ecca260c89e3d8ea9b98f77edaeef43dcd 10.180.157.200:6380</div><div class="line">   slots: (0 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">  Resharding plan:</div><div class="line">    Moving slot 5461 from e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">    Moving slot 5462 from e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">    Moving slot 5463 from e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">    Moving slot 5464 from e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">    Moving slot 0 from 460b3a11e296aafb2615043291b7dd98274bb351</div><div class="line">    Moving slot 1 from 460b3a11e296aafb2615043291b7dd98274bb351</div><div class="line">    Moving slot 2 from 460b3a11e296aafb2615043291b7dd98274bb351</div><div class="line">    Moving slot 10923 from 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">    Moving slot 10924 from 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">    Moving slot 10925 from 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">Do you want to proceed with the proposed reshard plan (yes/no)? yes</div><div class="line">Moving slot 5461 from 10.180.157.200:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 5462 from 10.180.157.200:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 5463 from 10.180.157.200:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 5464 from 10.180.157.200:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 0 from 10.180.157.202:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 1 from 10.180.157.202:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 2 from 10.180.157.202:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 10923 from 10.180.157.201:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 10924 from 10.180.157.201:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 10925 from 10.180.157.201:6379 to 10.180.157.200:6380:</div></pre></td></tr></table></figure></p>
<p>move_slot方法可以在线将一个slot的全部数据从源节点迁移到目的节点，fix、reshard、rebalance都需要调用该方法迁移slot。<br>move_slot接受下面几个参数，<br>1、pipeline：设置一次从slot上获取多少个key。<br>2、quiet：迁移会打印相关信息，设置quiet参数，可以不用打印这些信息。<br>3、cold：设置cold，会忽略执行importing和migrating。<br>4、dots：设置dots，则会在迁移过程打印迁移key数量的进度。<br>5、update：设置update，则会更新内存信息，方便以后的操作。</p>
<p>move_slot流程如下：<br>1、如果没有设置cold，则对源节点执行cluster importing命令，对目的节点执行migrating命令。fix的时候有可能importing和migrating已经执行过来，所以此种场景会设置cold。<br>2、通过cluster getkeysinslot命令，一次性获取远节点迁移slot的pipeline个key的数量.<br>3、对这些key执行migrate命令，将数据从源节点迁移到目的节点。<br>4、如果migrate出现异常，在fix模式下，BUSYKEY的异常，会使用migrate的replace模式再执行一次，BUSYKEY表示目的节点已经有该key了，replace模式可以强制替换目的节点的key。不是fix模式就直接返回错误了。<br>5、循环执行cluster getkeysinslot命令，直到返回的key数量为0，就退出循环。<br>6、如果没有设置cold，对每个节点执行cluster setslot命令，把slot赋给目的节点。<br>7、如果设置update，则修改源节点和目的节点的slot信息。<br>8、至此完成了迁移slot的流程。</p>
<h1 id="rebalance平衡集群节点slot数量"><a href="#rebalance平衡集群节点slot数量" class="headerlink" title="rebalance平衡集群节点slot数量"></a>rebalance平衡集群节点slot数量</h1><p>rebalance命令可以根据用户传入的参数平衡集群节点的slot数量，rebalance功能非常强大，可以传入的参数很多，以下是rebalance的参数列表和命令示例。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">rebalance       host:port</div><div class="line">                --weight &lt;arg&gt;</div><div class="line">                --auto-weights</div><div class="line">                --threshold &lt;arg&gt;</div><div class="line">                --use-empty-masters</div><div class="line">                --timeout &lt;arg&gt;</div><div class="line">                --simulate</div><div class="line">                --pipeline &lt;arg&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb rebalance --threshold 1 --weight b31e3a2e=5 --weight 60b8e3a1=5 --use-empty-masters  --simulate 10.180.157.199:6379</div></pre></td></tr></table></figure>
<p>下面也先一一解释下每个参数的用法：<br>host:port：这个是必传参数，用来从一个节点获取整个集群信息，相当于获取集群信息的入口。<br>–weight <arg>：节点的权重，格式为node_id=weight，如果需要为多个节点分配权重的话，需要添加多个–weight <arg>参数，即–weight b31e3a2e=5 –weight 60b8e3a1=5，node_id可为节点名称的前缀，只要保证前缀位数能唯一区分该节点即可。没有传递–weight的节点的权重默认为1。<br>–auto-weights：这个参数在rebalance流程中并未用到。<br>–threshold <arg>：只有节点需要迁移的slot阈值超过threshold，才会执行rebalance操作。具体计算方法可以参考下面的rebalance命令流程的第四步。<br>–use-empty-masters：rebalance是否考虑没有节点的master，默认没有分配slot节点的master是不参与rebalance的，设置–use-empty-masters可以让没有分配slot的节点参与rebalance。<br>–timeout <arg>：设置migrate命令的超时时间。<br>–simulate：设置该参数，可以模拟rebalance操作，提示用户会迁移哪些slots，而不会真正执行迁移操作。<br>–pipeline <arg>：与reshar的pipeline参数一样，定义cluster getkeysinslot命令一次取出的key数量，不传的话使用默认值为10。</arg></arg></arg></arg></arg></p>
<p>rebalance命令流程如下：<br>1、load_cluster_info_from_node方法先加载集群信息。<br>2、计算每个master的权重，根据参数–weight <arg>，为每个设置的节点分配权重，没有设置的节点，则权重默认为1。<br>3、根据每个master的权重，以及总的权重，计算自己期望被分配多少个slot。计算的方式为：总slot数量 <em> （自己的权重 / 总权重）。<br>4、计算每个master期望分配的slot是否超过设置的阈值，即–threshold <arg>设置的阈值或者默认的阈值。计算的方式为：先计算期望移动节点的阈值，算法为：(100-(100.0</arg></em>expected/n.slots.length)).abs，如果计算出的阈值没有超出设置阈值，则不需要为该节点移动slot。只要有一个master的移动节点超过阈值，就会触发rebalance操作。<br>5、如果触发了rebalance操作。那么就开始执行rebalance操作，先将每个节点当前分配的slots数量减去期望分配的slot数量获得balance值。将每个节点的balance从小到大进行排序获得sn数组。<br>6、用dst_idx和src_idx游标分别从sn数组的头部和尾部开始遍历。目的是为了把尾部节点的slot分配给头部节点。</arg></p>
<p>sn数组保存的balance列表排序后，负数在前面，正数在后面。负数表示需要有slot迁入，所以使用dst_idx游标，正数表示需要有slot迁出，所以使用src_idx游标。理论上sn数组各节点的balance值加起来应该为0，不过由于在计算期望分配的slot的时候只是使用直接取整的方式，所以可能出现balance值之和不为0的情况，balance值之和不为0即为节点不平衡的slot数量，由于slot总数有16384个，不平衡数量相对于总数，基数很小，所以对rebalance流程影响不大。</p>
<p>7、获取sn[dst_idx]和sn[src_idx]的balance值较小的那个值，该值即为需要从sn[src_idx]节点迁移到sn[dst_idx]节点的slot数量。<br>8、接着通过compute_reshard_table方法计算源节点的slot如何分配到源节点列表。这个方法在reshard流程中也有调用，具体步骤可以参考reshard流程的第六步。<br>9、如果是simulate模式，则只是打印出迁移列表。<br>10、如果没有设置simulate，则执行move_slot操作，迁移slot，传入的参数为:quiet=&gt;true,:dots=&gt;false,:update=&gt;true。<br>11、迁移完成后更新sn[dst_idx]和sn[src_idx]的balance值。如果balance值为0后，游标向前进1。<br>12、直到dst_idx到达src_idx游标，完成整个rebalance操作。</p>
<h1 id="add-node将新节点加入集群"><a href="#add-node将新节点加入集群" class="headerlink" title="add-node将新节点加入集群"></a>add-node将新节点加入集群</h1><p>add-node命令可以将新节点加入集群，节点可以为master，也可以为某个master节点的slave。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">add-node    new_host:new_port existing_host:existing_port</div><div class="line">          --slave</div><div class="line">          --master-id &lt;arg&gt;</div></pre></td></tr></table></figure></p>
<p>add-node有两个可选参数：<br>–slave：设置该参数，则新节点以slave的角色加入集群<br>–master-id：这个参数需要设置了–slave才能生效，–master-id用来指定新节点的master节点。如果不设置该参数，则会随机为节点选择master节点。<br>可以看下add-node命令的执行示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb add-node --slave --master-id dcb792b3e85726f012e83061bf237072dfc45f99 10.180.157.202:6379 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Adding node 10.180.157.202:6379 to cluster 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)</div><div class="line">M: dcb792b3e85726f012e83061bf237072dfc45f99 10.180.157.199:6379</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">M: 464d740bf48953ebcf826f4113c86f9db3a9baf3 10.180.157.201:6379</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">M: befa7e17b4e5f239e519bc74bfef3264a40f96ae 10.180.157.200:6379</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">[OK] All nodes agree about slots configuration.</div><div class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</div><div class="line">&gt;&gt;&gt; Check slots coverage...</div><div class="line">[OK] All 16384 slots covered.</div><div class="line">&gt;&gt;&gt; Send CLUSTER MEET to node 10.180.157.202:6379 to make it join the cluster.</div><div class="line">Waiting <span class="keyword">for</span> the cluster to join.</div><div class="line">&gt;&gt;&gt; Configure node as replica of 10.180.157.199:6379.</div><div class="line">[OK] New node added correctly.</div></pre></td></tr></table></figure></p>
<p>add-node流程如下：<br>1、通过load_cluster_info_from_node方法转载集群信息，check_cluster方法检查集群是否健康。<br>2、如果设置了–slave，则需要为该节点寻找master节点。设置了–master-id，则以该节点作为新节点的master，如果没有设置–master-id，则调用get_master_with_least_replicas方法，寻找slave数量最少的master节点。如果slave数量一致，则选取load_cluster_info_from_node顺序发现的第一个节点。load_cluster_info_from_node顺序的第一个节点是add-node设置的existing_host:existing_port节点，后面的顺序根据在该节点执行cluster nodes返回的结果返回的节点顺序。<br>3、连接新的节点并与集群第一个节点握手。<br>4、如果没设置–slave就直接返回ok，设置了–slave，则需要等待确认新节点加入集群，然后执行cluster replicate命令复制master节点。<br>5、至此，完成了全部的增加节点的流程。</p>
<h1 id="del-node从集群中删除节点"><a href="#del-node从集群中删除节点" class="headerlink" title="del-node从集群中删除节点"></a>del-node从集群中删除节点</h1><p>del-node可以把某个节点从集群中删除。del-node只能删除没有分配slot的节点。删除命令传递两个参数：<br>host:port：从该节点获取集群信息。<br>node_id：需要删除的节点id。<br>del-node执行结果示例如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb del-node 10.180.157.199:6379 d5f6d1d17426bd564a6e309f32d0f5b96962fe53</div><div class="line">&gt;&gt;&gt; Removing node d5f6d1d17426bd564a6e309f32d0f5b96962fe53 from cluster 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</div><div class="line">&gt;&gt;&gt; SHUTDOWN the node.</div></pre></td></tr></table></figure></p>
<p>del-node流程如下：<br>1、通过load_cluster_info_from_node方法转载集群信息。<br>2、根据传入的node id获取节点，如果节点没找到，则直接提示错误并退出。<br>3、如果节点分配的slot不为空，则直接提示错误并退出。<br>4、遍历集群内的其他节点，执行cluster forget命令，从每个节点中去除该节点。如果删除的节点是master，而且它有slave的话，这些slave会去复制其他master，调用的方法是get_master_with_least_replicas，与add-node没设置–master-id寻找master的方法一样。<br>5、然后关闭该节点</p>
<p>set-timeout设置集群节点间心跳连接的超时时间<br>set-timeout用来设置集群节点间心跳连接的超时时间，单位是毫秒，不得小于100毫秒，因为100毫秒对于心跳时间来说太短了。该命令修改是节点配置参数cluster-node-timeout，默认是15000毫秒。通过该命令，可以给每个节点设置超时时间，设置的方式使用config set命令动态设置，然后执行config rewrite命令将配置持久化保存到硬盘。以下是示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ruby redis-trib.rb <span class="built_in">set</span>-timeout 10.180.157.199:6379 30000</div><div class="line">&gt;&gt;&gt; Reconfiguring node timeout <span class="keyword">in</span> every cluster node...</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.199:6379</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.205:6379</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.201:6379</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.200:6379</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.208:6379</div><div class="line">&gt;&gt;&gt; New node timeout <span class="built_in">set</span>. 5 OK, 0 ERR.</div></pre></td></tr></table></figure></p>
<h1 id="call在集群全部节点上执行命令"><a href="#call在集群全部节点上执行命令" class="headerlink" title="call在集群全部节点上执行命令"></a>call在集群全部节点上执行命令</h1><p>call命令可以用来在集群的全部节点执行相同的命令。call命令也是需要通过集群的一个节点地址，连上整个集群，然后在集群的每个节点执行该命令。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb call 10.180.157.199:6379 get key</div><div class="line">&gt;&gt;&gt; Calling GET key</div><div class="line">10.180.157.199:6379: MOVED 12539 10.180.157.201:6379</div><div class="line">10.180.157.205:6379: MOVED 12539 10.180.157.201:6379</div><div class="line">10.180.157.201:6379:</div><div class="line">10.180.157.200:6379: MOVED 12539 10.180.157.201:6379</div><div class="line">10.180.157.208:6379: MOVED 12539 10.180.157.201:6379</div></pre></td></tr></table></figure></p>
<h1 id="import将外部redis数据导入集群"><a href="#import将外部redis数据导入集群" class="headerlink" title="import将外部redis数据导入集群"></a>import将外部redis数据导入集群</h1><p>import命令可以把外部的redis节点数据导入集群。导入的流程如下：<br>1、通过load_cluster_info_from_node方法转载集群信息，check_cluster方法检查集群是否健康。<br>2、连接外部redis节点，如果外部节点开启了cluster_enabled，则提示错误。<br>3、通过scan命令遍历外部节点，一次获取1000条数据。<br>4、遍历这些key，计算出key对应的slot。<br>5、执行migrate命令,源节点是外部节点,目的节点是集群slot对应的节点，如果设置了–copy参数，则传递copy参数，如果设置了–replace，则传递replace参数。<br>6、不停执行scan命令，直到遍历完全部的key。<br>7、至此完成整个迁移流程<br>这中间如果出现异常，程序就会停止。没使用–copy模式，则可以重新执行import命令，使用–copy的话，最好清空新的集群再导入一次。</p>
<p>import命令更适合离线的把外部Redis数据导入，在线导入的话最好使用更专业的导入工具，以slave的方式连接redis节点去同步节点数据应该是更好的方式。</p>
<p>下面是一个例子<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./redis-trib.rb import --from 10.0.10.1:6379 10.10.10.1:7000</div><div class="line">上面的命令是把 10.0.10.1:6379（redis 2.8）上的数据导入到 10.10.10.1:7000这个节点所在的集群</div></pre></td></tr></table></figure></p>
<p>原文地址<a href="http://blog.csdn.net/huwei2003/article/details/50973967" target="_blank" rel="external">http://blog.csdn.net/huwei2003/article/details/50973967</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis/" rel="tag"># redis</a>
          
            <a href="/tags/redis-cluster/" rel="tag"># redis cluster</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/03/24/linux-route/" rel="next" title="route 命令">
                <i class="fa fa-chevron-left"></i> route 命令
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/04/24/linux-curl/" rel="prev" title="curl 命令">
                curl 命令 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars7.githubusercontent.com/u/22493186?v=4&s=460"
               alt="ejunjsh" />
          <p class="site-author-name" itemprop="name">ejunjsh</p>
           
              <p class="site-description motion-element" itemprop="description">code freak</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">139</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">128</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ejunjsh" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/339238080" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:sjj050121014@163.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      Email
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/junjie.shao.9" target="_blank" title="FB Page">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                    
                      FB Page
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#help-信息"><span class="nav-number">1.</span> <span class="nav-text">help 信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ClusterNode对象"><span class="nav-number">2.</span> <span class="nav-text">ClusterNode对象</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#create创建集群"><span class="nav-number">3.</span> <span class="nav-text">create创建集群</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#check检查集群"><span class="nav-number">4.</span> <span class="nav-text">check检查集群</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#info查看集群信息"><span class="nav-number">5.</span> <span class="nav-text">info查看集群信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#fix修复集群"><span class="nav-number">6.</span> <span class="nav-text">fix修复集群</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#reshard在线迁移slot"><span class="nav-number">7.</span> <span class="nav-text">reshard在线迁移slot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rebalance平衡集群节点slot数量"><span class="nav-number">8.</span> <span class="nav-text">rebalance平衡集群节点slot数量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#add-node将新节点加入集群"><span class="nav-number">9.</span> <span class="nav-text">add-node将新节点加入集群</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#del-node从集群中删除节点"><span class="nav-number">10.</span> <span class="nav-text">del-node从集群中删除节点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#call在集群全部节点上执行命令"><span class="nav-number">11.</span> <span class="nav-text">call在集群全部节点上执行命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#import将外部redis数据导入集群"><span class="nav-number">12.</span> <span class="nav-text">import将外部redis数据导入集群</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <a href="/mylove" style="border-bottom:none">
    <i class="fa fa-heart"></i>
    </a>
  </span>
  <span class="author" itemprop="copyrightHolder">ejunjsh</span>

  
</div>


  <div class="powered-by">
    Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    Theme &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Gemini
    </a>
  </div>


        







        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.2"></script>



  

  

  

  

  

  

</body>
</html>
