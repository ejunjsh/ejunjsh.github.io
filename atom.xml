<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>IdiotSky</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://idiotsky.top/"/>
  <updated>2018-12-07T15:49:45.867Z</updated>
  <id>http://idiotsky.top/</id>
  
  <author>
    <name>ejunjsh</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>linuxå†…å­˜ç®¡ç†</title>
    <link href="http://idiotsky.top/2018/12/07/linux-mm/"/>
    <id>http://idiotsky.top/2018/12/07/linux-mm/</id>
    <published>2018-12-07T15:49:22.000Z</published>
    <updated>2018-12-07T15:49:45.867Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
    
    </summary>
    
      <category term="linux" scheme="http://idiotsky.top/categories/linux/"/>
    
    
      <category term="linux" scheme="http://idiotsky.top/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Go initå‡½æ•°è¯¦è§£</title>
    <link href="http://idiotsky.top/2018/12/05/go-init/"/>
    <id>http://idiotsky.top/2018/12/05/go-init/</id>
    <published>2018-12-05T13:24:32.000Z</published>
    <updated>2018-12-05T13:41:23.890Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>go ä¸€å¤©ä¸ç”¨å°±å¿˜äº†è¿™ä¸ªï¼Œmarkä¸€ä¸ªä»¥é˜²ä¸‡ä¸€ğŸ‘¿</p>
</blockquote>
<p><code>init()</code>å‡½æ•°ä¼šåœ¨æ¯ä¸ªåŒ…å®Œæˆåˆå§‹åŒ–åè‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶ä¸”æ‰§è¡Œä¼˜å…ˆçº§æ¯”mainå‡½æ•°é«˜ã€‚init å‡½æ•°é€šå¸¸è¢«ç”¨æ¥ï¼š</p>
<ul>
<li>å¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–</li>
<li>æ£€æŸ¥/ä¿®å¤ç¨‹åºçš„çŠ¶æ€</li>
<li>æ³¨å†Œ</li>
<li>è¿è¡Œä¸€æ¬¡è®¡ç®—</li>
</ul>
<a id="more"></a>
<h1 id="åŒ…çš„åˆå§‹åŒ–"><a href="#åŒ…çš„åˆå§‹åŒ–" class="headerlink" title="åŒ…çš„åˆå§‹åŒ–"></a>åŒ…çš„åˆå§‹åŒ–</h1><p>ä¸ºäº†ä½¿ç”¨å¯¼å…¥çš„åŒ…ï¼Œé¦–å…ˆå¿…é¡»å°†å…¶åˆå§‹åŒ–ã€‚åˆå§‹åŒ–æ€»æ˜¯ä»¥å•çº¿ç¨‹æ‰§è¡Œï¼Œå¹¶ä¸”æŒ‰ç…§åŒ…çš„ä¾èµ–å…³ç³»é¡ºåºæ‰§è¡Œã€‚è¿™é€šè¿‡Golangçš„è¿è¡Œæ—¶ç³»ç»Ÿæ§åˆ¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<ol>
<li>åˆå§‹åŒ–å¯¼å…¥çš„åŒ…ï¼ˆé€’å½’å¯¼å…¥ï¼‰</li>
<li>å¯¹åŒ…å—ä¸­å£°æ˜çš„å˜é‡è¿›è¡Œè®¡ç®—å’Œåˆ†é…åˆå§‹å€¼</li>
<li>æ‰§è¡ŒåŒ…ä¸­çš„initå‡½æ•°</li>
</ol>
<p><a href="http://idiotsky.top/images4/go-init.png"><img src="http://idiotsky.top/images4/go-init.png" alt=""></a></p>
<p><strong>initial.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ <span class="keyword">int64</span>=s()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(<span class="string">"init function ---&gt;"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">s</span><span class="params">()</span> <span class="title">int64</span></span>&#123;</span><br><span class="line">    fmt.Println(<span class="string">"function s() ---&gt;"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(<span class="string">"main ---&gt;"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ‰§è¡Œç»“æœ</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function s() ---&gt;</span><br><span class="line">init function ---&gt;</span><br><span class="line">main ---&gt;</span><br></pre></td></tr></table></figure>
<p>å³ä½¿åŒ…è¢«å¯¼å…¥å¤šæ¬¡ï¼Œåˆå§‹åŒ–åªéœ€è¦ä¸€æ¬¡ã€‚</p>
<h1 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h1><p>initå‡½æ•°ä¸éœ€è¦ä¼ å…¥å‚æ•°ï¼Œä¹Ÿä¸ä¼šè¿”å›ä»»ä½•å€¼ã€‚ä¸mainç›¸æ¯”è€Œè¨€ï¼Œinitæ²¡æœ‰è¢«å£°æ˜ï¼Œå› æ­¤ä¹Ÿä¸èƒ½è¢«å¼•ç”¨ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(<span class="string">"init"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    init()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç¼–è¯‘ä¸Šé¢çš„å‡½æ•°æ—¶ï¼Œä¼šå‡ºé”™â€œundefinedï¼šinitâ€ã€‚</p>
<p>æ¯ä¸ªæºæ–‡ä»¶ä¸­å¯ä»¥åŒ…å«å¤šä¸ªinitå‡½æ•°.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(<span class="string">"init 1"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(<span class="string">"init2"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(<span class="string">"main"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init1</span><br><span class="line">init2</span><br><span class="line">main</span><br></pre></td></tr></table></figure>
<p>initå‡½æ•°å¸¸ç”¨çš„ä¸€ä¸ªä¾‹å­å°±æ˜¯ç”¨æ¥è®¾ç½®åˆå§‹è¡¨è¾¾å¼çš„å€¼ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> precomputed=[<span class="number">20</span>]<span class="keyword">float64</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> current <span class="keyword">float64</span>=<span class="number">1</span></span><br><span class="line">    precomputed[<span class="number">0</span>]=current</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">1</span>;i&lt;<span class="built_in">len</span>(precomputed);i++&#123;</span><br><span class="line">        precomputed[i]=precomputed[i<span class="number">-1</span>]*<span class="number">1.2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºä¸Šé¢ä»£ç ä¸­ä¸å¯èƒ½ç”¨forå¾ªç¯æ¥ä½œä¸ºprecomputedçš„å€¼ï¼ˆè¿™æ˜¯ä¸€å¥å£°æ˜ï¼‰ï¼Œå› æ­¤å¯ä»¥ç”¨initå‡½æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h1 id="GoåŒ…å¯¼å…¥è§„åˆ™çš„å‰¯ä½œç”¨"><a href="#GoåŒ…å¯¼å…¥è§„åˆ™çš„å‰¯ä½œç”¨" class="headerlink" title="GoåŒ…å¯¼å…¥è§„åˆ™çš„å‰¯ä½œç”¨"></a>GoåŒ…å¯¼å…¥è§„åˆ™çš„å‰¯ä½œç”¨</h1><p>Goè¦æ±‚éå¸¸ä¸¥æ ¼ï¼Œä¸å…è®¸å¼•ç”¨ä¸ä½¿ç”¨çš„åŒ…ã€‚ä½†æ˜¯æœ‰æ—¶ä½ å¼•ç”¨åŒ…åªæ˜¯ä¸ºäº†è°ƒç”¨initå‡½æ•°å»åšä¸€äº›åˆå§‹åŒ–å·¥ä½œã€‚æ­¤æ—¶ç©ºæ ‡è¯†ç¬¦ï¼ˆä¹Ÿå°±æ˜¯ä¸‹åˆ’çº¿ï¼‰çš„ä½œç”¨å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">"com/pkg"</span></span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://blog.csdn.net/benben_2015/article/details/79486077" target="_blank" rel="noopener">https://blog.csdn.net/benben_2015/article/details/79486077</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;go ä¸€å¤©ä¸ç”¨å°±å¿˜äº†è¿™ä¸ªï¼Œmarkä¸€ä¸ªä»¥é˜²ä¸‡ä¸€ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;code&gt;init()&lt;/code&gt;å‡½æ•°ä¼šåœ¨æ¯ä¸ªåŒ…å®Œæˆåˆå§‹åŒ–åè‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶ä¸”æ‰§è¡Œä¼˜å…ˆçº§æ¯”mainå‡½æ•°é«˜ã€‚init å‡½æ•°é€šå¸¸è¢«ç”¨æ¥ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¯¹å˜é‡è¿›è¡Œåˆå§‹åŒ–&lt;/li&gt;
&lt;li&gt;æ£€æŸ¥/ä¿®å¤ç¨‹åºçš„çŠ¶æ€&lt;/li&gt;
&lt;li&gt;æ³¨å†Œ&lt;/li&gt;
&lt;li&gt;è¿è¡Œä¸€æ¬¡è®¡ç®—&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.top/categories/go/"/>
    
    
      <category term="go" scheme="http://idiotsky.top/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥Linux procæ–‡ä»¶ç³»ç»Ÿ</title>
    <link href="http://idiotsky.top/2018/11/28/linux-proc/"/>
    <id>http://idiotsky.top/2018/11/28/linux-proc/</id>
    <published>2018-11-28T14:38:53.000Z</published>
    <updated>2018-12-02T13:48:20.315Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ç»§ç»­æ·±å…¥å­¦ä¹ LinuxğŸ‘¿</p>
</blockquote>
<p>åœ¨Linuxä¸Šï¼Œprocæ˜¯ä¸€ä¸ªä¼ªæ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›äº†è®¿é—®å†…æ ¸æ•°æ®çš„æ–¹æ³•ï¼Œä¸€èˆ¬æŒ‚è½½åœ¨â€œ/procâ€ç›®å½•ï¼Œå…¶ä¸­çš„å¤§éƒ¨åˆ†å†…å®¹æ˜¯åªè¯»çš„ï¼ŒæŒ‚è½½ï¼ˆmountï¼‰ä¿¡æ¯å¯èƒ½ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢åˆ—ä¸¾â€œ/procâ€æ–‡ä»¶ç³»ç»Ÿä¸‹çš„æ–‡ä»¶å’Œç›®å½•ã€‚</p>
<h1 id="pidç›®å½•"><a href="#pidç›®å½•" class="headerlink" title="pidç›®å½•"></a>pidç›®å½•</h1><p><code>/proc/[pid]</code>ç›®å½•ï¼Œpidä¸ºè¿›ç¨‹çš„æ•°å­—IDï¼Œæ˜¯ä¸ªæ•°å€¼ï¼Œæ¯ä¸ªè¿è¡Œç€çš„è¿›ç¨‹éƒ½æœ‰è¿™ä¹ˆä¸€ä¸ªç›®å½•ã€‚</p>
<h2 id="cmdline"><a href="#cmdline" class="headerlink" title="cmdline"></a>cmdline</h2><p><code>/proc/[pid]/cmdline</code>æ˜¯ä¸€ä¸ªåªè¯»æ–‡ä»¶ï¼ŒåŒ…å«è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤è¡Œä¿¡æ¯ã€‚å¦‚æœè¿™ä¸ªè¿›ç¨‹æ˜¯zombieè¿›ç¨‹ï¼Œåˆ™è¿™ä¸ªæ–‡ä»¶æ²¡æœ‰ä»»ä½•å†…å®¹ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ps -ef | grep 2948</span><br><span class="line">root       2948      1  0 Nov05 ?        00:00:04 /usr/sbin/libvirtd --listen</span><br><span class="line"></span><br><span class="line"># cat /proc/2948/cmdline</span><br><span class="line">/usr/sbin/libvirtd--listen</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="comm"><a href="#comm" class="headerlink" title="comm"></a>comm</h2><p><code>/proc/[pid]/comm</code>åŒ…å«è¿›ç¨‹çš„å‘½ä»¤åã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat /proc/2948/comm</span><br><span class="line"></span><br><span class="line">libvirtd</span><br></pre></td></tr></table></figure>
<h2 id="cwd"><a href="#cwd" class="headerlink" title="cwd"></a>cwd</h2><p><code>/proc/[pid]/cwd</code>æ˜¯è¿›ç¨‹å½“å‰å·¥ä½œç›®å½•çš„ç¬¦å·é“¾æ¥ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ls -lt /proc/2948/cwd</span><br><span class="line">lrwxrwxrwx 1 root root 0 Nov  9 12:14 /proc/2948/cwd -&gt; /</span><br></pre></td></tr></table></figure>
<h2 id="environ"><a href="#environ" class="headerlink" title="environ"></a>environ</h2><p><code>/proc/[pid]/environ</code>æ˜¾ç¤ºè¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># strings /proc/2948/environ</span><br><span class="line">LANG=POSIX</span><br><span class="line">LC_CTYPE=en_US.UTF-8</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">NOTIFY_SOCKET=@/org/freedesktop/systemd1/notify</span><br><span class="line">LIBVIRTD_CONFIG=/etc/libvirt/libvirtd.conf</span><br><span class="line">LIBVIRTD_ARGS=--listen</span><br><span class="line">LIBVIRTD_NOFILES_LIMIT=2048</span><br></pre></td></tr></table></figure>
<h2 id="exe"><a href="#exe" class="headerlink" title="exe"></a>exe</h2><p><code>/proc/[pid]/exe</code>ä¸ºå®é™…è¿è¡Œç¨‹åºçš„ç¬¦å·é“¾æ¥ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ls -lt /proc/2948/exe</span><br><span class="line">lrwxrwxrwx 1 root root 0 Nov  5 13:04 /proc/2948/exe -&gt; /usr/sbin/libvirtd</span><br></pre></td></tr></table></figure>
<h2 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h2><p><code>/proc/[pid]/fd</code>æ˜¯ä¸€ä¸ªç›®å½•ï¼ŒåŒ…å«è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„æƒ…å†µã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># ls -lt /proc/3801/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 0 -&gt; socket:[37445]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 1 -&gt; socket:[37446]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 10 -&gt; socket:[31729]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 11 -&gt; socket:[34562]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 12 -&gt; socket:[39978]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 13 -&gt; socket:[34574]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 14 -&gt; socket:[39137]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 15 -&gt; socket:[39208]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 16 -&gt; socket:[39221]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 17 -&gt; socket:[41080]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 18 -&gt; socket:[40014]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 19 -&gt; socket:[34617]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 20 -&gt; socket:[34620]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 23 -&gt; socket:[42357]</span><br><span class="line">lr-x------. 1 root root 64 Apr 18 16:51 3 -&gt; /dev/urandom</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 4 -&gt; socket:[37468]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 5 -&gt; socket:[37471]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 6 -&gt; socket:[289532]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 7 -&gt; socket:[31728]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 8 -&gt; socket:[37450]</span><br><span class="line">lrwx------. 1 root root 64 Apr 18 16:51 9 -&gt; socket:[37451]</span><br><span class="line">l-wx------. 1 root root 64 Apr 13 16:35 2 -&gt; /root/.vnc/localhost.localdomain:1.log</span><br></pre></td></tr></table></figure>
<p>ç›®å½•ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ•°å­—åˆ™ä»£è¡¨æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<h2 id="limits"><a href="#limits" class="headerlink" title="limits"></a>limits</h2><p><code>/proc/[pid]/limits</code>æ˜¾ç¤ºå½“å‰è¿›ç¨‹çš„èµ„æºé™åˆ¶ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># cat /proc/2948/limits</span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max cpu time              unlimited            unlimited            seconds</span><br><span class="line">Max file size             unlimited            unlimited            bytes</span><br><span class="line">Max data size             unlimited            unlimited            bytes</span><br><span class="line">Max stack size            8388608              unlimited            bytes</span><br><span class="line">Max core file size        0                    unlimited            bytes</span><br><span class="line">Max resident set          unlimited            unlimited            bytes</span><br><span class="line">Max processes             6409                 6409                 processes</span><br><span class="line">Max open files            1024                 4096                 files</span><br><span class="line">Max locked memory         65536                65536                bytes</span><br><span class="line">Max address space         unlimited            unlimited            bytes</span><br><span class="line">Max file locks            unlimited            unlimited            locks</span><br><span class="line">Max pending signals       6409                 6409                 signals</span><br><span class="line">Max msgqueue size         819200               819200               bytes</span><br><span class="line">Max nice priority         0                    0</span><br><span class="line">Max realtime priority     0                    0</span><br><span class="line">Max realtime timeout      unlimited            unlimited            us</span><br></pre></td></tr></table></figure>
<p>Soft Limitè¡¨ç¤ºkernelè®¾ç½®ç»™èµ„æºçš„å€¼ï¼ŒHard Limitè¡¨ç¤ºSoft Limitçš„ä¸Šé™ï¼Œè€ŒUnitsåˆ™ä¸ºè®¡é‡å•å…ƒã€‚</p>
<h2 id="maps"><a href="#maps" class="headerlink" title="maps"></a>maps</h2><p><code>/proc/[pid]/maps</code>æ˜¾ç¤ºè¿›ç¨‹çš„å†…å­˜åŒºåŸŸæ˜ å°„ä¿¡æ¯ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">address           perms offset  dev   inode        pathname</span><br><span class="line">00400000-00452000 r-xp 00000000 08:02 173521      /usr/bin/dbus-daemon</span><br><span class="line">00651000-00652000 r--p 00051000 08:02 173521      /usr/bin/dbus-daemon</span><br><span class="line">00652000-00655000 rw-p 00052000 08:02 173521      /usr/bin/dbus-daemon</span><br><span class="line">00e03000-00e24000 rw-p 00000000 00:00 0           [heap]</span><br><span class="line">00e24000-011f7000 rw-p 00000000 00:00 0           [heap]</span><br><span class="line">...</span><br><span class="line">35b1800000-35b1820000 r-xp 00000000 08:02 135522  /usr/lib64/ld-2.15.so</span><br><span class="line">35b1a1f000-35b1a20000 r--p 0001f000 08:02 135522  /usr/lib64/ld-2.15.so</span><br><span class="line">35b1a20000-35b1a21000 rw-p 00020000 08:02 135522  /usr/lib64/ld-2.15.so</span><br><span class="line">35b1a21000-35b1a22000 rw-p 00000000 00:00 0</span><br><span class="line">35b1c00000-35b1dac000 r-xp 00000000 08:02 135870  /usr/lib64/libc-2.15.so</span><br><span class="line">35b1dac000-35b1fac000 ---p 001ac000 08:02 135870  /usr/lib64/libc-2.15.so</span><br><span class="line">35b1fac000-35b1fb0000 r--p 001ac000 08:02 135870  /usr/lib64/libc-2.15.so</span><br><span class="line">35b1fb0000-35b1fb2000 rw-p 001b0000 08:02 135870  /usr/lib64/libc-2.15.so</span><br><span class="line">...</span><br><span class="line">f2c6ff8c000-7f2c7078c000 rw-p 00000000 00:00 0    [stack:986]</span><br><span class="line">...</span><br><span class="line">7fffb2c0d000-7fffb2c2e000 rw-p 00000000 00:00 0   [stack]</span><br><span class="line">7fffb2d48000-7fffb2d49000 r-xp 00000000 00:00 0   [vdso]</span><br></pre></td></tr></table></figure>
<ul>
<li>addresså­—æ®µè¡¨ç¤ºè¿›ç¨‹ä¸­å†…å­˜æ˜ å°„å æ®çš„åœ°å€ç©ºé—´ï¼Œæ ¼å¼ä¸ºåå…­è¿›åˆ¶çš„BeginAddress-EndAddressã€‚ </li>
<li>permså­—æ®µè¡¨ç¤ºæƒé™ï¼Œå…±å››ä¸ªå­—ç¬¦ï¼Œä¾æ¬¡ä¸ºrwxsæˆ–rwxpï¼Œå…¶ä¸­rä¸ºreadï¼Œwä¸ºwriteï¼Œxä¸ºexecuteï¼Œsä¸ºsharedï¼Œpä¸ºprivateï¼Œå¯¹åº”ä½ç½®æ²¡æœ‰æƒé™æ—¶ç”¨ä¸€ä¸ªçŸ­æ¨ªçº¿ä»£æ›¿ã€‚ </li>
<li>offsetå­—æ®µè¡¨ç¤ºå†…å­˜æ˜ å°„åœ°å€åœ¨æ–‡ä»¶ä¸­çš„å­—èŠ‚åç§»é‡ã€‚ </li>
<li>devå­—æ®µè¡¨ç¤ºdeviceï¼Œæ ¼å¼ä¸ºmajor:minorã€‚ </li>
<li>inodeå­—æ®µè¡¨ç¤ºå¯¹åº”deviceçš„inodeï¼Œ0è¡¨ç¤ºå†…å­˜æ˜ å°„åŒºåŸŸæ²¡æœ‰å…³è”çš„inodeï¼Œå¦‚æœªåˆå§‹åŒ–çš„BSSæ•°æ®æ®µå°±æ˜¯è¿™ç§æƒ…å†µã€‚ </li>
<li>pathnameå­—æ®µç”¨äºå†…å­˜æ˜ å°„çš„æ–‡ä»¶ï¼Œå¯¹äºELFæ ¼å¼çš„æ–‡ä»¶æ¥è¯´ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤readelf -læŸ¥çœ‹ELFç¨‹åºå¤´éƒ¨çš„Offsetå­—æ®µï¼Œä¸mapsæ–‡ä»¶çš„offsetå­—æ®µä½œå¯¹æ¯”ã€‚pathnameå¯èƒ½ä¸ºç©ºï¼Œè¡¨ç¤ºåŒ¿åæ˜ å°„ï¼Œè¿™ç§æƒ…å†µä¸‹éš¾ä»¥è°ƒè¯•è¿›ç¨‹ï¼Œå¦‚gdbã€straceç­‰å‘½ä»¤ã€‚é™¤äº†æ­£å¸¸çš„æ–‡ä»¶è·¯å¾„ä¹‹å¤–ï¼Œpathnameè¿˜å¯èƒ½æ˜¯ä¸‹é¢çš„å€¼ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[stack]    åˆå§‹è¿›ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰çš„stack</span><br><span class="line">[stack:&lt;tid&gt;]    çº¿ç¨‹IDä¸ºtidçš„stack. å¯¹åº”äº/proc/[pid]/task/[tid]/è·¯å¾„</span><br><span class="line">[vdso]    Virtual Dynamically linked Shared Object</span><br><span class="line">[heap]    è¿›ç¨‹çš„heap</span><br></pre></td></tr></table></figure>
<h2 id="root"><a href="#root" class="headerlink" title="root"></a>root</h2><p><code>/proc/[pid]/root</code>æ˜¯è¿›ç¨‹æ ¹ç›®å½•çš„ç¬¦å·é“¾æ¥ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ls -lt /proc/2948/root</span><br><span class="line">lrwxrwxrwx 1 root root 0 Nov  9 12:14 /proc/2948/root -&gt; /</span><br></pre></td></tr></table></figure>
<h2 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h2><p><code>/proc/[pid]/stack</code>æ˜¾ç¤ºå½“å‰è¿›ç¨‹çš„å†…æ ¸è°ƒç”¨æ ˆä¿¡æ¯ï¼Œåªæœ‰å†…æ ¸ç¼–è¯‘æ—¶æ‰“å¼€äº†CONFIG_STACKTRACEç¼–è¯‘é€‰é¡¹ï¼Œæ‰ä¼šç”Ÿæˆè¿™ä¸ªæ–‡ä»¶ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cat /proc/2948/stack</span><br><span class="line">[&lt;ffffffff80168375&gt;] poll_schedule_timeout+0x45/0x60</span><br><span class="line">[&lt;ffffffff8016994d&gt;] do_sys_poll+0x49d/0x550</span><br><span class="line">[&lt;ffffffff80169abd&gt;] SyS_poll+0x5d/0xf0</span><br><span class="line">[&lt;ffffffff804c16e7&gt;] system_call_fastpath+0x16/0x1b</span><br><span class="line">[&lt;00007f4a41ff2c1d&gt;] 0x7f4a41ff2c1d</span><br><span class="line">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff</span><br></pre></td></tr></table></figure>
<h2 id="statm"><a href="#statm" class="headerlink" title="statm"></a>statm</h2><p><code>/proc/[pid]/statm</code>æ˜¾ç¤ºè¿›ç¨‹æ‰€å ç”¨å†…å­˜å¤§å°çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…å«ä¸ƒä¸ªå€¼ï¼Œåº¦é‡å•ä½æ˜¯pageï¼ˆpageå¤§å°å¯é€šè¿‡getconf PAGESIZEå¾—åˆ°ï¼‰ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat /proc/2948/statm  </span><br><span class="line">72362 12945 4876 569 0 24665 0</span><br></pre></td></tr></table></figure>
<p>å„ä¸ªå€¼å«ä¹‰ï¼š<br>aï¼‰è¿›ç¨‹å ç”¨çš„æ€»çš„å†…å­˜ï¼›<br>bï¼‰è¿›ç¨‹å½“å‰æ—¶åˆ»å ç”¨çš„ç‰©ç†å†…å­˜ï¼›<br>cï¼‰åŒå…¶å®ƒè¿›ç¨‹å…±äº«çš„å†…å­˜ï¼›<br>dï¼‰è¿›ç¨‹çš„ä»£ç æ®µï¼›<br>eï¼‰å…±äº«åº“ï¼ˆä»2.6ç‰ˆæœ¬èµ·ï¼Œè¿™ä¸ªå€¼ä¸º0ï¼‰ï¼›<br>fï¼‰è¿›ç¨‹çš„å †æ ˆï¼›<br>gï¼‰dirty pagesï¼ˆä»2.6ç‰ˆæœ¬èµ·ï¼Œè¿™ä¸ªå€¼ä¸º0ï¼‰ã€‚</p>
<h2 id="status"><a href="#status" class="headerlink" title="status"></a>status</h2><p>statusæ–‡ä»¶å†…å®¹çš„æ ¼å¼å¦‚ä¸‹ï¼ˆæŸ¥çœ‹å½“å‰shellå‘½ä»¤æ‰€åœ¨è¿›ç¨‹çš„ä¿¡æ¯ï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/$$/status</span><br><span class="line">Name:   bash</span><br><span class="line">State:  S (sleeping)</span><br><span class="line">Tgid:   3515</span><br><span class="line">Pid:    3515</span><br><span class="line">PPid:   3452</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    1000    1000    1000    1000</span><br><span class="line">Gid:    100     100     100     100</span><br><span class="line">FDSize: 256</span><br><span class="line">Groups: 16 33 100</span><br><span class="line">VmPeak:     9136 kB</span><br><span class="line">VmSize:     7896 kB</span><br><span class="line">VmLck:         0 kB</span><br><span class="line">VmPin:         0 kB</span><br><span class="line">VmHWM:      7572 kB</span><br><span class="line">VmRSS:      6316 kB</span><br><span class="line">VmData:     5224 kB</span><br><span class="line">VmStk:        88 kB</span><br><span class="line">VmExe:       572 kB</span><br><span class="line">VmLib:      1708 kB</span><br><span class="line">VmPMD:         4 kB</span><br><span class="line">VmPTE:        20 kB</span><br><span class="line">VmSwap:        0 kB</span><br><span class="line">Threads:        1</span><br><span class="line">SigQ:   0/3067</span><br><span class="line">SigPnd: 0000000000000000</span><br><span class="line">ShdPnd: 0000000000000000</span><br><span class="line">SigBlk: 0000000000010000</span><br><span class="line">SigIgn: 0000000000384004</span><br><span class="line">SigCgt: 000000004b813efb</span><br><span class="line">CapInh: 0000000000000000</span><br><span class="line">CapPrm: 0000000000000000</span><br><span class="line">CapEff: 0000000000000000</span><br><span class="line">CapBnd: ffffffffffffffff</span><br><span class="line">CapAmb:   0000000000000000</span><br><span class="line">Seccomp:        0</span><br><span class="line">Cpus_allowed:   00000001</span><br><span class="line">Cpus_allowed_list:      0</span><br><span class="line">Mems_allowed:   1</span><br><span class="line">Mems_allowed_list:      0</span><br><span class="line">voluntary_ctxt_switches:        150</span><br><span class="line">nonvoluntary_ctxt_switches:     545</span><br></pre></td></tr></table></figure>
<h2 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h2><p><code>/proc/[pid]/syscall</code>æ˜¾ç¤ºå½“å‰è¿›ç¨‹æ­£åœ¨æ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat /proc/2948/syscall</span><br><span class="line">7 0x7f4a452cbe70 0xb 0x1388 0xffffffffffdff000 0x7f4a4274a750 0x0 0x7ffd1a8033f0 0x7f4a41ff2c1d</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªå€¼æ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼ˆ7ä»£è¡¨pollï¼‰ï¼Œåé¢è·Ÿç€6ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°å€¼ï¼ˆä½äºå¯„å­˜å™¨ä¸­ï¼‰ï¼Œæœ€åä¸¤ä¸ªå€¼ä¾æ¬¡æ˜¯å †æ ˆæŒ‡é’ˆå’ŒæŒ‡ä»¤è®¡æ•°å™¨çš„å€¼ã€‚å¦‚æœå½“å‰è¿›ç¨‹è™½ç„¶é˜»å¡ï¼Œä½†é˜»å¡å‡½æ•°å¹¶ä¸æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ™ç³»ç»Ÿè°ƒç”¨å·çš„å€¼ä¸º-1ï¼Œåé¢åªæœ‰å †æ ˆæŒ‡é’ˆå’ŒæŒ‡ä»¤è®¡æ•°å™¨çš„å€¼ã€‚å¦‚æœè¿›ç¨‹æ²¡æœ‰é˜»å¡ï¼Œåˆ™è¿™ä¸ªæ–‡ä»¶åªæœ‰ä¸€ä¸ªâ€œrunningâ€çš„å­—ç¬¦ä¸²ã€‚</p>
<p>å†…æ ¸ç¼–è¯‘æ—¶æ‰“å¼€äº†CONFIG_HAVE_ARCH_TRACEHOOKç¼–è¯‘é€‰é¡¹ï¼Œæ‰ä¼šç”Ÿæˆè¿™ä¸ªæ–‡ä»¶ã€‚</p>
<h2 id="wchan"><a href="#wchan" class="headerlink" title="wchan"></a>wchan</h2><p><code>/proc/[pid]/wchan</code>æ˜¾ç¤ºå½“è¿›ç¨‹ä¼‘çœ æ—¶ï¼Œå†…æ ¸å½“å‰è¿è¡Œçš„å‡½æ•°ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat /proc/2948/wchan</span><br><span class="line">kauditd_</span><br></pre></td></tr></table></figure>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p><code>/proc/[pid]/task</code>ï¼Œç›®å½•ï¼Œæ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªå­ç›®å½•ï¼Œç›®å½•åä¸ºçº¿ç¨‹IDã€‚<br><code>/proc/[pid]/stat</code>ï¼Œæ–‡ä»¶ï¼Œè¿›ç¨‹çŠ¶æ€ä¿¡æ¯ï¼Œç”¨äºpså‘½ä»¤ã€‚<br><code>/proc/[pid]/uid_map</code>ï¼Œæ–‡ä»¶ï¼Œç”¨æˆ·IDæ˜ å°„ä¿¡æ¯ï¼Œè¯¦è§ï¼ˆman user_namespacesï¼‰ã€‚<br><code>/proc/[pid]/gid_map</code>ï¼Œæ–‡ä»¶ï¼Œç»„IDæ˜ å°„ä¿¡æ¯ï¼Œè¯¦è§ï¼ˆman user_namespacesï¼‰ã€‚<br><code>/proc/[pid]/mountinfo</code>ï¼Œæ–‡ä»¶ï¼ŒæŒ‚è½½ä¿¡æ¯ï¼Œæ ¼å¼ä¸º36 35 98:0 /mnt1 /mnt2 rw,noatime master:1 - ext3 /dev/root rw,errors=continueï¼Œä»¥ç©ºæ ¼ä½œä¸ºåˆ†éš”ç¬¦ï¼Œä»å·¦åˆ°å³å„å­—æ®µçš„æ„æ€åˆ†åˆ«æ˜¯å”¯ä¸€æŒ‚è½½IDã€çˆ¶æŒ‚è½½IDã€æ–‡ä»¶ç³»ç»Ÿçš„è®¾å¤‡ä¸»ä»å·ç ã€æ–‡ä»¶ç³»ç»Ÿä¸­æŒ‚è½½çš„æ ¹èŠ‚ç‚¹ã€ç›¸å¯¹äºè¿›ç¨‹æ ¹èŠ‚ç‚¹çš„æŒ‚è½½ç‚¹ã€æŒ‚è½½æƒé™ç­‰æŒ‚è½½é…ç½®ã€å¯é€‰é…ç½®ã€çŸ­æ¨ªçº¿è¡¨ç¤ºå‰é¢å¯é€‰é…ç½®çš„ç»“æŸã€æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€æ–‡ä»¶ç³»ç»Ÿç‰¹æœ‰çš„æŒ‚è½½æºæˆ–è€…ä¸ºnoneã€é¢å¤–é…ç½®ã€‚<br><code>/proc/[pid]/mounts</code>ï¼Œæ–‡ä»¶ï¼ŒæŒ‚è½½åœ¨å½“å‰è¿›ç¨‹çš„æ–‡ä»¶ç³»ç»Ÿåˆ—è¡¨ï¼Œæ ¼å¼å‚ç…§ï¼ˆman fstabï¼‰ã€‚<br><code>/proc/[pid]/mountstats</code>ï¼Œæ–‡ä»¶ï¼ŒæŒ‚è½½ä¿¡æ¯ï¼Œæ ¼å¼å½¢å¦‚device /dev/sda7 mounted on /home with fstype ext3 [statistics]ã€‚<br><code>/proc/[pid]/ns/</code>ï¼Œç›®å½•ï¼Œä¿å­˜äº†æ¯ä¸ªåå­—ç©ºé—´çš„å…¥å£ï¼Œè¯¦è§ï¼ˆman namespacesï¼‰ã€‚ </p>
<h1 id="netç›®å½•"><a href="#netç›®å½•" class="headerlink" title="netç›®å½•"></a>netç›®å½•</h1><p>/proc/netï¼Œç›®å½•ï¼Œç½‘ç»œä¼ªæ–‡ä»¶ç³»ç»Ÿç›¸å…³ã€‚ </p>
<p>/proc/net/arp<br>/proc/net/dev<br>/proc/net/dev_mcast<br>/proc/net/igmp<br>/proc/net/rarp<br>/proc/net/raw<br>/proc/net/snmp<br>/proc/net/tcp<br>/proc/net/udp<br>/proc/net/unix<br>/proc/net/netfilter/nfnetlink_queue</p>
<h1 id="sysç›®å½•"><a href="#sysç›®å½•" class="headerlink" title="sysç›®å½•"></a>sysç›®å½•</h1><p>/proc/sysï¼Œç›®å½•ï¼Œç³»ç»Ÿå˜é‡ç›¸å…³ä¿¡æ¯ï¼Œè¯¦ç»†å¦‚ä¸‹ã€‚ </p>
<p>/proc/sys/abi<br>/proc/sys/debug<br>/proc/sys/dev<br>/proc/sys/fs<br>/proc/sys/fs/binfmt_misc<br>/proc/sys/fs/dentry-state<br>/proc/sys/fs/dir-notify-enable<br>/proc/sys/fs/dquot-max<br>/proc/sys/fs/dquot-nr<br>/proc/sys/fs/epoll<br>/proc/sys/fs/file-max<br>/proc/sys/fs/file-nr<br>/proc/sys/fs/inode-max<br>/proc/sys/fs/inode-nr<br>/proc/sys/fs/inode-state<br>/proc/sys/fs/inotify<br>/proc/sys/fs/lease-break-time<br>/proc/sys/fs/leases-enable<br>/proc/sys/fs/mqueue<br>/proc/sys/fs/nr_open<br>/proc/sys/fs/overflowgid<br>/proc/sys/fs/overflowuid<br>/proc/sys/fs/pipe-max-size<br>/proc/sys/fs/protected_hardlinks<br>/proc/sys/fs/protected_symlinks<br>/proc/sys/fs/suid_dumpable<br>/proc/sys/fs/super-max<br>/proc/sys/fs/super-nr<br>/proc/sys/kernel<br>/proc/sys/kernel/acct<br>/proc/sys/kernel/auto_msgmni<br>/proc/sys/kernel/cap_last_cap<br>/proc/sys/kernel/cap-bound<br>/proc/sys/kernel/core_pattern<br>/proc/sys/kernel/core_uses_pid<br>/proc/sys/kernel/ctrl-alt-del<br>/proc/sys/kernel/dmesg_restrict<br>/proc/sys/kernel/domainname<br>/proc/sys/kernel/hostname<br>/proc/sys/kernel/hotplug<br>/proc/sys/kernel/htab-reclaim<br>/proc/sys/kernel/kptr_restrict<br>/proc/sys/kernel/l2cr<br>/proc/sys/kernel/modprobe<br>/proc/sys/kernel/modules_disabled<br>/proc/sys/kernel/msgmax<br>/proc/sys/kernel/msgmni<br>/proc/sys/kernel/msgmnb<br>/proc/sys/kernel/ngroups_max<br>/proc/sys/kernel/ostype<br>/proc/sys/kernel/osrelease<br>/proc/sys/kernel/overflowgid<br>/proc/sys/kernel/overflowuid<br>/proc/sys/kernel/panic<br>/proc/sys/kernel/panic_on_oops<br>/proc/sys/kernel/pid_max<br>/proc/sys/kernel/powersave-nap<br>/proc/sys/kernel/printk<br>/proc/sys/kernel/pty<br>/proc/sys/kernel/pty/max<br>/proc/sys/kernel/pty/nr<br>/proc/sys/kernel/random<br>/proc/sys/kernel/random/uuid<br>/proc/sys/kernel/randomize_va_space<br>/proc/sys/kernel/real-root-dev<br>/proc/sys/kernel/reboot-cmd<br>/proc/sys/kernel/rtsig-max<br>/proc/sys/kernel/rtsig-nr<br>/proc/sys/kernel/sched_rr_timeslice_ms<br>/proc/sys/kernel/sched_rt_period_us<br>/proc/sys/kernel/sched_rt_period_us<br>/proc/sys/kernel/sem<br>/proc/sys/kernel/sg-big-buff<br>/proc/sys/kernel/shm_rmid_forced<br>/proc/sys/kernel/shmall<br>/proc/sys/kernel/shmmax<br>/proc/sys/kernel/shmmni<br>/proc/sys/kernel/sysctl_writes_strict<br>/proc/sys/kernel/sysrq<br>/proc/sys/kernel/version<br>/proc/sys/kernel/threads-max<br>/proc/sys/kernel/yama/ptrace_scope<br>/proc/sys/kernel/zero-paged<br>/proc/sys/net<br>/proc/sys/net/core/bpf_jit_enable<br>/proc/sys/net/core/somaxconn<br>/proc/sys/proc<br>/proc/sys/sunrpc<br>/proc/sys/vm<br>/proc/sys/vm/compact_memory<br>/proc/sys/vm/drop_caches<br>/proc/sys/vm/legacy_va_layout<br>/proc/sys/vm/memory_failure_early_kill<br>/proc/sys/vm/memory_failure_recovery<br>/proc/sys/vm/oom_dump_tasks<br>/proc/sys/vm/oom_kill_allocating_task<br>/proc/sys/vm/overcommit_kbytes<br>/proc/sys/vm/overcommit_memory<br>/proc/sys/vm/overcommit_ratio<br>/proc/sys/vm/panic_on_oom<br>/proc/sys/vm/swappiness</p>
<h1 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h1><p>/proc/apmï¼Œæ–‡ä»¶ï¼Œapmå³Advanced Power Managementï¼Œéœ€è¦é…ç½®CONFIG_APMã€‚<br>/proc/buddyinfoï¼Œæ–‡ä»¶ï¼Œç”¨äºè¯Šæ–­å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚<br>/proc/cmdlineï¼Œæ–‡ä»¶ï¼Œç³»ç»Ÿå¯åŠ¨æ—¶ä¼ é€’ç»™Linuxå†…æ ¸çš„å‚æ•°ï¼Œå¦‚liloã€grubç­‰bootç®¡ç†æ¨¡å—ã€‚<br>/proc/config.gzï¼Œæ–‡ä»¶ï¼Œå†…æ ¸ç¼–è¯‘é…ç½®é€‰é¡¹ï¼Œéœ€è¦é…ç½®CONFIG_IKCONFIG_PROCã€‚<br>/proc/cryptoï¼Œæ–‡ä»¶ï¼Œå†…æ ¸åŠ å¯†APIæä¾›çš„åŠ å¯†åˆ—è¡¨ã€‚<br>/proc/cpuinfoï¼Œæ–‡ä»¶ï¼ŒCPUå’Œç³»ç»Ÿæ¶æ„ä¿¡æ¯ï¼Œlscpuå‘½ä»¤ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ã€‚<br>/proc/devicesï¼Œæ–‡ä»¶ï¼Œè®¾å¤‡ç›¸å…³ä¿¡æ¯ã€‚<br>/proc/diskstatsï¼Œæ–‡ä»¶ï¼Œç£ç›˜çŠ¶æ€ã€‚<br>/proc/dmaï¼Œæ–‡ä»¶ï¼Œdmaå³Direct Memory Accessã€‚<br>/proc/driver/rtcï¼Œæ–‡ä»¶ï¼Œç³»ç»Ÿè¿è¡Œæ—¶é…ç½®ã€‚<br>/proc/execdomainsï¼Œæ–‡ä»¶ï¼Œæ‰§è¡ŒåŸŸåˆ—è¡¨ã€‚<br>/proc/fbï¼Œæ–‡ä»¶ï¼ŒFrame Bufferä¿¡æ¯ï¼Œéœ€è¦é…ç½®CONFIG_FBã€‚<br>/proc/filesystemsï¼Œæ–‡ä»¶ï¼Œå†…æ ¸æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ˆman filesystemsï¼‰ã€‚<br>/proc/fsï¼Œç›®å½•ï¼ŒæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ã€‚<br>/proc/ideï¼Œç›®å½•ï¼Œç”¨äºIDEæ¥å£ã€‚<br>/proc/interruptsï¼Œæ–‡ä»¶ï¼Œæ¯ä¸ªCPUæ¯ä¸ªIOçš„ä¸­æ–­ä¿¡æ¯ã€‚<br>/proc/iomemï¼Œæ–‡ä»¶ï¼ŒIOå†…å­˜æ˜ å°„ä¿¡æ¯ã€‚<br>/proc/ioportsï¼Œæ–‡ä»¶ï¼ŒIOç«¯å£ä¿¡æ¯ã€‚<br>/proc/kallsymsï¼Œæ–‡ä»¶ï¼Œç”¨äºåŠ¨æ€é“¾æ¥å’Œå’Œæ¨¡å—ç»‘å®šçš„ç¬¦å·å®šä¹‰ã€‚<br>/proc/kcoreï¼Œæ–‡ä»¶ï¼Œç³»ç»Ÿä¸­ELFæ ¼å¼çš„ç‰©ç†å†…å­˜ã€‚<br>/proc/kmsgï¼Œæ–‡ä»¶ï¼Œå†…æ ¸ä¿¡æ¯ï¼Œdmsgå‘½ä»¤ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ã€‚<br>/proc/kpagecountï¼Œæ–‡ä»¶ï¼Œæ¯ä¸ªç‰©ç†é¡µå¸§æ˜ å°„çš„æ¬¡æ•°ï¼Œéœ€è¦é…ç½®CONFIG_PROC_PAGE_MONITORã€‚<br>/proc/kpageflagsï¼Œæ–‡ä»¶ï¼Œæ¯ä¸ªç‰©ç†é¡µå¸§çš„æ©ç ï¼Œéœ€è¦é…ç½®CONFIG_PROC_PAGE_MONITORã€‚<br>/proc/ksymsï¼Œæ–‡ä»¶ï¼ŒåŒkallsymsã€‚<br>/proc/loadavgï¼Œæ–‡ä»¶ï¼Œå·¥ä½œè´Ÿè·ã€‚<br>/proc/locksï¼Œæ–‡ä»¶ï¼Œå½“å‰æ–‡ä»¶é”çš„çŠ¶æ€ã€‚<br>/proc/mallocï¼Œæ–‡ä»¶ï¼Œéœ€è¦é…ç½®CONFIG_DEBUG_MALLOCã€‚<br>/proc/meminfoï¼Œæ–‡ä»¶ï¼Œç³»ç»Ÿå†…å­˜ä½¿ç”¨ç»Ÿè®¡ï¼Œfreeå‘½ä»¤ä½¿ç”¨äº†è¿™ä¸ªæ–‡ä»¶ã€‚<br>/proc/modulesï¼Œæ–‡ä»¶ï¼Œç³»ç»ŸåŠ è½½çš„æ¨¡å—ä¿¡æ¯ï¼Œç›¸å…³å‘½ä»¤ä¸ºlsmodã€‚<br>/proc/mountsï¼Œæ–‡ä»¶ï¼Œé“¾æ¥åˆ°äº†/self/mountsã€‚<br>/proc/mtrrï¼Œæ–‡ä»¶ï¼ŒMemory Type Range Registersã€‚<br>/proc/partitionsï¼Œæ–‡ä»¶ï¼Œåˆ†åŒºä¿¡æ¯ã€‚<br>/proc/pciï¼Œæ–‡ä»¶ï¼ŒPCIæ¥å£è®¾å¤‡ã€‚<br>/proc/profileï¼Œæ–‡ä»¶ï¼Œç”¨äºreadprofileå‘½ä»¤ä½œæ€§èƒ½åˆ†æã€‚<br>/proc/scsiï¼Œç›®å½•ï¼ŒSCSIæ¥å£è®¾å¤‡ã€‚<br>/proc/scsi/scsi<br>/proc/scsi/[drivername]<br>/proc/selfï¼Œç›®å½•ï¼Œé“¾æ¥åˆ°äº†å½“å‰è¿›ç¨‹æ‰€åœ¨çš„ç›®å½•ã€‚<br>/proc/slabinfoï¼Œæ–‡ä»¶ï¼Œå†…æ ¸ç¼“å­˜ä¿¡æ¯ï¼Œéœ€è¦é…ç½®CONFIG_SLABã€‚<br>/proc/statï¼Œæ–‡ä»¶ï¼Œç³»ç»Ÿä¿¡æ¯ç»Ÿè®¡ã€‚<br>/proc/swapsï¼Œæ–‡ä»¶ï¼Œä½¿ç”¨çš„äº¤æ¢ç©ºé—´ã€‚<br>/proc/sysrq-triggerï¼Œæ–‡ä»¶ï¼Œå¯å†™ï¼Œè§¦å‘ç³»ç»Ÿè°ƒç”¨ã€‚<br>/proc/sysvipcï¼Œç›®å½•ï¼ŒåŒ…æ‹¬msgã€semã€shmä¸‰ä¸ªæ–‡ä»¶ï¼Œä¸ºSystem V IPCå¯¹è±¡ã€‚<br>/proc/thread-selfï¼Œæ–‡ä»¶ï¼Œé“¾æ¥åˆ°äº†å½“å‰è¿›ç¨‹ä¸‹çš„taskç›®å½•ä¸­çš„çº¿ç¨‹æ–‡ä»¶ã€‚<br>/proc/timer_listï¼Œæ–‡ä»¶ï¼Œè¿˜åœ¨è¿è¡Œç€çš„å®šæ—¶å™¨åˆ—è¡¨ã€‚<br>/proc/timer_statsï¼Œæ–‡ä»¶ï¼Œå®šæ—¶å™¨çŠ¶æ€ã€‚<br>/proc/ttyï¼Œç›®å½•ï¼Œttyè®¾å¤‡ç›¸å…³ã€‚<br>/proc/uptimeï¼Œæ–‡ä»¶ï¼Œç³»ç»Ÿæ›´æ–°æ—¶é—´å’Œè¿›ç¨‹ç©ºé—²æ—¶é—´ã€‚<br>/proc/versionï¼Œæ–‡ä»¶ï¼Œå†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ã€‚<br>/proc/vmstatï¼Œæ–‡ä»¶ï¼Œå†…å­˜ç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥é”®å€¼å¯¹å½¢å¼æ˜¾ç¤ºã€‚<br>/proc/zoneinfoï¼Œæ–‡ä»¶ï¼Œå†…å­˜åŒºå—ä¿¡æ¯ï¼Œç”¨äºåˆ†æè™šæ‹Ÿå†…å­˜çš„è¡Œä¸ºã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://blog.csdn.net/ieearth/article/details/72849990" target="_blank" rel="noopener">https://blog.csdn.net/ieearth/article/details/72849990</a></p>
<p><a href="https://www.cnblogs.com/likui360/p/6181927.html" target="_blank" rel="noopener">https://www.cnblogs.com/likui360/p/6181927.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç»§ç»­æ·±å…¥å­¦ä¹ LinuxğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨Linuxä¸Šï¼Œprocæ˜¯ä¸€ä¸ªä¼ªæ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›äº†è®¿é—®å†…æ ¸æ•°æ®çš„æ–¹æ³•ï¼Œä¸€èˆ¬æŒ‚è½½åœ¨â€œ/procâ€ç›®å½•ï¼Œå…¶ä¸­çš„å¤§éƒ¨åˆ†å†…å®¹æ˜¯åªè¯»çš„ï¼ŒæŒ‚è½½ï¼ˆmountï¼‰ä¿¡æ¯å¯èƒ½ä¸ºï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä¸‹é¢åˆ—ä¸¾â€œ/procâ€æ–‡ä»¶ç³»ç»Ÿä¸‹çš„æ–‡ä»¶å’Œç›®å½•ã€‚&lt;/p&gt;
&lt;h1 id=&quot;pidç›®å½•&quot;&gt;&lt;a href=&quot;#pidç›®å½•&quot; class=&quot;headerlink&quot; title=&quot;pidç›®å½•&quot;&gt;&lt;/a&gt;pidç›®å½•&lt;/h1&gt;&lt;p&gt;&lt;code&gt;/proc/[pid]&lt;/code&gt;ç›®å½•ï¼Œpidä¸ºè¿›ç¨‹çš„æ•°å­—IDï¼Œæ˜¯ä¸ªæ•°å€¼ï¼Œæ¯ä¸ªè¿è¡Œç€çš„è¿›ç¨‹éƒ½æœ‰è¿™ä¹ˆä¸€ä¸ªç›®å½•ã€‚&lt;/p&gt;
&lt;h2 id=&quot;cmdline&quot;&gt;&lt;a href=&quot;#cmdline&quot; class=&quot;headerlink&quot; title=&quot;cmdline&quot;&gt;&lt;/a&gt;cmdline&lt;/h2&gt;&lt;p&gt;&lt;code&gt;/proc/[pid]/cmdline&lt;/code&gt;æ˜¯ä¸€ä¸ªåªè¯»æ–‡ä»¶ï¼ŒåŒ…å«è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤è¡Œä¿¡æ¯ã€‚å¦‚æœè¿™ä¸ªè¿›ç¨‹æ˜¯zombieè¿›ç¨‹ï¼Œåˆ™è¿™ä¸ªæ–‡ä»¶æ²¡æœ‰ä»»ä½•å†…å®¹ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# ps -ef | grep 2948&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;root       2948      1  0 Nov05 ?        00:00:04 /usr/sbin/libvirtd --listen&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# cat /proc/2948/cmdline&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/usr/sbin/libvirtd--listen&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="linux" scheme="http://idiotsky.top/categories/linux/"/>
    
    
      <category term="linux" scheme="http://idiotsky.top/tags/linux/"/>
    
      <category term="proc" scheme="http://idiotsky.top/tags/proc/"/>
    
  </entry>
  
  <entry>
    <title>è¯´è¯´cçš„volatile</title>
    <link href="http://idiotsky.top/2018/11/27/c-volatile/"/>
    <id>http://idiotsky.top/2018/11/27/c-volatile/</id>
    <published>2018-11-27T13:07:59.000Z</published>
    <updated>2018-11-27T13:55:00.218Z</updated>
    
    <content type="html"><![CDATA[<h1 id="volatile-ä»‹ç»"><a href="#volatile-ä»‹ç»" class="headerlink" title="volatile ä»‹ç»"></a>volatile ä»‹ç»</h1><p>è¡¨ç¤ºä¸€ä¸ªå˜é‡ä¹Ÿè®¸ä¼šè¢«åå°ç¨‹åºæ”¹å˜ï¼Œå…³é”®å­— volatile æ˜¯ä¸ const ç»å¯¹å¯¹ç«‹çš„ã€‚å®ƒæŒ‡ç¤ºä¸€ä¸ªå˜é‡ä¹Ÿè®¸ä¼šè¢«æŸç§æ–¹å¼ä¿®æ”¹ï¼Œè¿™ç§æ–¹å¼æŒ‰ç…§æ­£å¸¸ç¨‹åºæµç¨‹åˆ†ææ˜¯æ— æ³•é¢„çŸ¥çš„ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªå˜é‡ä¹Ÿè®¸ä¼šè¢«ä¸€ä¸ªä¸­æ–­æœåŠ¡ç¨‹åºæ‰€ä¿®æ”¹ï¼‰ã€‚</p>
<p>å˜é‡å¦‚æœåŠ äº† volatile ä¿®é¥°ï¼Œåˆ™ä¼šä»å†…å­˜é‡æ–°è£…è½½å†…å®¹ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»å¯„å­˜å™¨æ‹·è´å†…å®¹ã€‚ </p>
<a id="more"></a>
<h1 id="ä¸ºä»€ä¹ˆä½¿ç”¨-volatile"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨-volatile" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨ volatile"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ volatile</h1><p>volatile çš„ä½œç”¨ æ˜¯ä½œä¸ºæŒ‡ä»¤å…³é”®å­—ï¼Œç¡®ä¿æœ¬æ¡æŒ‡ä»¤ä¸ä¼šå› ç¼–è¯‘å™¨çš„ä¼˜åŒ–è€Œçœç•¥ï¼Œä¸”è¦æ±‚æ¯æ¬¡ç›´æ¥è¯»å€¼ã€‚</p>
<p>ç°åœ¨è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œç¼–è¯‘å™¨å¦‚ä½•å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–çš„ï¼Ÿ</p>
<p>æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹ä¸€</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">int</span> a = i; <span class="comment">//ä¼˜åŒ–</span></span><br><span class="line">	<span class="keyword">int</span> b = i;</span><br><span class="line"> </span><br><span class="line">	<span class="built_in">printf</span> (<span class="string">"i = %d\n"</span>, b);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//ç¼–è¯‘ä¼˜åŒ–ã€æŸ¥çœ‹æ±‡ç¼–</span><br><span class="line">gcc -O2 -S test.c </span><br><span class="line">cat test.s </span><br><span class="line"> </span><br><span class="line">	.file	&quot;test.c&quot;</span><br><span class="line">	.section	.rodata.str1.1,&quot;aMS&quot;,@progbits,1</span><br><span class="line">.LC0:</span><br><span class="line">	.string	&quot;i = %d\n&quot;</span><br><span class="line">	.section	.text.startup,&quot;ax&quot;,@progbits</span><br><span class="line">	.p2align 4,,15</span><br><span class="line">	.globl	main</span><br><span class="line">	.type	main, @function</span><br><span class="line">main:</span><br><span class="line">.LFB22:</span><br><span class="line">	.cfi_startproc</span><br><span class="line">	pushl	%ebp</span><br><span class="line">	.cfi_def_cfa_offset 8</span><br><span class="line">	.cfi_offset 5, -8</span><br><span class="line">	movl	%esp, %ebp</span><br><span class="line">	.cfi_def_cfa_register 5</span><br><span class="line">	andl	$-16, %esp</span><br><span class="line">	subl	$16, %esp</span><br><span class="line">	movl	$10, 8(%esp)</span><br><span class="line">	movl	$.LC0, 4(%esp)</span><br><span class="line">	movl	$1, (%esp)</span><br><span class="line">	call	__printf_chk</span><br><span class="line">	xorl	%eax, %eax</span><br><span class="line">	leave</span><br><span class="line">	.cfi_restore 5</span><br><span class="line">	.cfi_def_cfa 4, 4</span><br><span class="line">	ret</span><br><span class="line">	.cfi_endproc</span><br><span class="line">.LFE22:</span><br><span class="line">	.size	main, .-main</span><br><span class="line">	.ident	&quot;GCC: (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3&quot;</span><br><span class="line">	.section	.note.GNU-stack,&quot;&quot;,@progbits</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹äºŒ</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">int</span> a = i; <span class="comment">//æœªä¼˜åŒ–</span></span><br><span class="line">	<span class="keyword">int</span> b = i;</span><br><span class="line"> </span><br><span class="line">	<span class="built_in">printf</span> (<span class="string">"i = %d\n"</span>, b);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">//ç¼–è¯‘ä¼˜åŒ–ã€æŸ¥çœ‹æ±‡ç¼–</span><br><span class="line">gcc -O2 -S test.c </span><br><span class="line">cat test.s </span><br><span class="line"> </span><br><span class="line">	.file	&quot;test.c&quot;</span><br><span class="line">	.section	.rodata.str1.1,&quot;aMS&quot;,@progbits,1</span><br><span class="line">.LC0:</span><br><span class="line">	.string	&quot;i = %d\n&quot;</span><br><span class="line">	.section	.text.startup,&quot;ax&quot;,@progbits</span><br><span class="line">	.p2align 4,,15</span><br><span class="line">	.globl	main</span><br><span class="line">	.type	main, @function</span><br><span class="line">main:</span><br><span class="line">.LFB22:</span><br><span class="line">	.cfi_startproc</span><br><span class="line">	pushl	%ebp</span><br><span class="line">	.cfi_def_cfa_offset 8</span><br><span class="line">	.cfi_offset 5, -8</span><br><span class="line">	movl	%esp, %ebp</span><br><span class="line">	.cfi_def_cfa_register 5</span><br><span class="line">	andl	$-16, %esp</span><br><span class="line">	subl	$32, %esp</span><br><span class="line">	movl	$10, 28(%esp)</span><br><span class="line">	movl	28(%esp), %eax</span><br><span class="line">	movl	28(%esp), %eax</span><br><span class="line">	movl	$.LC0, 4(%esp)</span><br><span class="line">	movl	$1, (%esp)</span><br><span class="line">	movl	%eax, 8(%esp)</span><br><span class="line">	call	__printf_chk</span><br><span class="line">	xorl	%eax, %eax</span><br><span class="line">	leave</span><br><span class="line">	.cfi_restore 5</span><br><span class="line">	.cfi_def_cfa 4, 4</span><br><span class="line">	ret</span><br><span class="line">	.cfi_endproc</span><br><span class="line">.LFE22:</span><br><span class="line">	.size	main, .-main</span><br><span class="line">	.ident	&quot;GCC: (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3&quot;</span><br><span class="line">	.section	.note.GNU-stack,&quot;&quot;,@progbits</span><br></pre></td></tr></table></figure>
<p>æ¯”è¾ƒï¼š</p>
<p><a href="http://idiotsky.top/images3/c-volatile-1.png"><img src="http://idiotsky.top/images3/c-volatile-1.png" alt=""></a></p>
<p>å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼šä½¿ç”¨ volatile çš„ä»£ç ç¼–è¯‘æœªä¼˜åŒ–ã€‚</p>
<p>volatile æŒ‡å‡º i æ˜¯éšæ—¶å¯èƒ½å‘ç”Ÿå˜åŒ–çš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒçš„æ—¶å€™å¿…é¡»ä» içš„åœ°å€ä¸­è¯»å–ï¼Œå› è€Œç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¼šé‡æ–°ä»içš„åœ°å€è¯»å–æ•°æ®æ”¾åœ¨ b ä¸­ã€‚è€Œä¼˜åŒ–åšæ³•æ˜¯ï¼Œç”±äºç¼–è¯‘å™¨å‘ç°ä¸¤æ¬¡ä» iè¯»æ•°æ®çš„ä»£ç ä¹‹é—´çš„ä»£ç æ²¡æœ‰å¯¹ i è¿›è¡Œè¿‡æ“ä½œï¼Œå®ƒä¼šè‡ªåŠ¨æŠŠä¸Šæ¬¡è¯»çš„æ•°æ®æ”¾åœ¨ b ä¸­ã€‚è€Œä¸æ˜¯é‡æ–°ä» i é‡Œé¢è¯»ã€‚</p>
<p>ä¸Šé¢ä¾‹å­è¿˜æ²¡æœ‰çœ‹åˆ°å½±å“ï¼Œä¸‹é¢è¿™ä¸ªä¾‹å­å¯ä»¥è¯´æ˜volatileçš„ä½œç”¨</p>
<p>ä¸€ä¸ªä¸­æ–­æœåŠ¡å­ç¨‹åºä¸­ä¼šè®¿é—®åˆ°çš„éè‡ªåŠ¨å˜é‡ï¼ˆNon-automatic variables)</p>
<p>ç”±äºè®¿é—®å¯„å­˜å™¨çš„é€Ÿåº¦è¦å¿«è¿‡RAMï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸€èˆ¬éƒ½ä¼šä½œå‡å°‘å­˜å–å¤–éƒ¨RAMçš„ä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> i=<span class="number">0</span>; <span class="comment">//i ä¸ºéè‡ªåŠ¨å˜é‡</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">if</span> (i) dosomething();</span><br><span class="line">&#125;</span><br><span class="line">ï½</span><br><span class="line"><span class="comment">/* Interrupt service routine. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ISR_2</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      i=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¨‹åºçš„æœ¬æ„æ˜¯å¸Œæœ› ISR_2 ä¸­æ–­äº§ç”Ÿæ—¶ï¼Œåœ¨mainå‡½æ•°ä¸­è°ƒç”¨ dosomething å‡½æ•°ï¼Œä½†æ˜¯ï¼Œç”±äºç¼–è¯‘å™¨åˆ¤æ–­åœ¨ main å‡½æ•°é‡Œé¢æ²¡æœ‰ä¿®æ”¹è¿‡ iï¼Œå› æ­¤å¯èƒ½åªæ‰§è¡Œä¸€æ¬¡å¯¹ä»iåˆ°æŸå¯„å­˜å™¨çš„è¯»æ“ä½œï¼Œç„¶åæ¯æ¬¡ifåˆ¤æ–­éƒ½åªä½¿ç”¨è¿™ä¸ªå¯„å­˜å™¨é‡Œé¢çš„â€œiå‰¯æœ¬â€ï¼Œå¯¼è‡´ dosomething æ°¸è¿œä¹Ÿä¸ä¼šè¢«è°ƒç”¨ã€‚å¦‚æœå°†å˜é‡åŠ ä¸Š volatile ä¿®é¥°ï¼Œåˆ™ç¼–è¯‘å™¨ä¿è¯å¯¹æ­¤å˜é‡çš„è¯»å†™æ“ä½œéƒ½ä¸ä¼šè¢«ä¼˜åŒ–ï¼ˆè‚¯å®šæ‰§è¡Œï¼‰ã€‚æ­¤ä¾‹ä¸­iä¹Ÿåº”è¯¥å¦‚æ­¤è¯´æ˜ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹å¤šçº¿ç¨‹çš„åœºæ™¯</p>
<p>å¤šçº¿ç¨‹åº”ç”¨ä¸­è¢«å‡ ä¸ªä»»åŠ¡å…±äº«çš„å˜é‡</p>
<p>å½“ä¸¤ä¸ªçº¿ç¨‹éƒ½è¦ç”¨åˆ°æŸä¸€ä¸ªå˜é‡ä¸”è¯¥å˜é‡çš„å€¼ä¼šè¢«æ”¹å˜æ—¶ï¼Œåº”è¯¥ç”¨ volatile å£°æ˜ï¼Œè¯¥å…³é”®å­—çš„ä½œç”¨æ˜¯é˜²æ­¢ä¼˜åŒ–ç¼–è¯‘å™¨æŠŠå˜é‡ä»å†…å­˜è£…å…¥CPUå¯„å­˜å™¨ä¸­ã€‚å¦‚æœå˜é‡è¢«è£…å…¥å¯„å­˜å™¨ï¼Œé‚£ä¹ˆä¸¤ä¸ªçº¿ç¨‹æœ‰å¯èƒ½ä¸€ä¸ªä½¿ç”¨å†…å­˜ä¸­çš„å˜é‡ï¼Œä¸€ä¸ªä½¿ç”¨å¯„å­˜å™¨ä¸­çš„å˜é‡ï¼Œè¿™ä¼šé€ æˆç¨‹åºçš„é”™è¯¯æ‰§è¡Œã€‚volatileçš„æ„æ€æ˜¯è®©ç¼–è¯‘å™¨æ¯æ¬¡æ“ä½œè¯¥å˜é‡æ—¶ä¸€å®šè¦ä»å†…å­˜ä¸­çœŸæ­£å–å‡ºï¼Œè€Œä¸æ˜¯ä½¿ç”¨å·²ç»å­˜åœ¨å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span>  BOOL  bStop  =  FALSE;  <span class="comment">//bStop  ä¸ºå…±äº«å…¨å±€å˜é‡</span></span><br><span class="line"><span class="comment">//åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼š  </span></span><br><span class="line">  <span class="keyword">while</span>(  !bStop  )  &#123;  ...  &#125;  </span><br><span class="line">  bStop  =  FALSE;  </span><br><span class="line">  <span class="keyword">return</span>;    </span><br><span class="line"> </span><br><span class="line"><span class="comment">//åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œè¦ç»ˆæ­¢ä¸Šé¢çš„çº¿ç¨‹å¾ªç¯ï¼š  </span></span><br><span class="line">  bStop  =  TRUE;  </span><br><span class="line">  <span class="keyword">while</span>(  bStop  );</span><br></pre></td></tr></table></figure>
<p>ç­‰å¾…ä¸Šé¢çš„çº¿ç¨‹ç»ˆæ­¢ï¼Œå¦‚æœbStopä¸ä½¿ç”¨volatileç”³æ˜ï¼Œé‚£ä¹ˆè¿™ä¸ªå¾ªç¯å°†æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå› ä¸ºbStopå·²ç»è¯»å–åˆ°äº†å¯„å­˜å™¨ä¸­ï¼Œå¯„å­˜å™¨ä¸­bStopçš„å€¼æ°¸è¿œä¸ä¼šå˜æˆFALSEï¼ŒåŠ ä¸Švolatileï¼Œç¨‹åºåœ¨æ‰§è¡Œæ—¶ï¼Œæ¯æ¬¡å‡ä»å†…å­˜ä¸­è¯»å‡ºbStopçš„å€¼ï¼Œå°±ä¸ä¼šæ­»å¾ªç¯äº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>volatile å…³é”®å­—æ˜¯ä¸€ç§ç±»å‹ä¿®é¥°ç¬¦ï¼Œç”¨å®ƒå£°æ˜çš„ç±»å‹å˜é‡è¡¨ç¤ºå¯ä»¥è¢«æŸäº›ç¼–è¯‘å™¨æœªçŸ¥çš„å› ç´ æ›´æ”¹ã€‚volatile æé†’ç¼–è¯‘å™¨å®ƒåé¢æ‰€å®šä¹‰çš„å˜é‡éšæ—¶éƒ½æœ‰å¯èƒ½æ”¹å˜ï¼Œå› æ­¤ç¼–è¯‘åçš„ç¨‹åºæ¯æ¬¡éœ€è¦å­˜å‚¨æˆ–è¯»å–è¿™ä¸ªå˜é‡çš„æ—¶å€™ï¼Œéƒ½ä¼šç›´æ¥ä»å˜é‡åœ°å€ä¸­è¯»å–æ•°æ®ã€‚å¦‚æœæ²¡æœ‰ volatile å…³é”®å­—ï¼Œåˆ™ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–è¯»å–å’Œå­˜å‚¨ï¼Œå¯èƒ½æš‚æ—¶ä½¿ç”¨å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œå¦‚æœè¿™ä¸ªå˜é‡ç”±åˆ«çš„ç¨‹åºæ›´æ–°äº†çš„è¯ï¼Œå°†å‡ºç°ä¸ä¸€è‡´çš„ç°è±¡ã€‚æ‰€ä»¥é‡åˆ°è¿™ä¸ªå…³é”®å­—å£°æ˜çš„å˜é‡ï¼Œç¼–è¯‘å™¨å¯¹è®¿é—®è¯¥å˜é‡çš„ä»£ç å°±ä¸å†è¿›è¡Œä¼˜åŒ–ï¼Œä»è€Œå¯ä»¥æä¾›å¯¹ç‰¹æ®Šåœ°å€çš„ç¨³å®šè®¿é—®ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://blog.csdn.net/qq_29350001/article/details/54024070" target="_blank" rel="noopener">https://blog.csdn.net/qq_29350001/article/details/54024070</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;volatile-ä»‹ç»&quot;&gt;&lt;a href=&quot;#volatile-ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;volatile ä»‹ç»&quot;&gt;&lt;/a&gt;volatile ä»‹ç»&lt;/h1&gt;&lt;p&gt;è¡¨ç¤ºä¸€ä¸ªå˜é‡ä¹Ÿè®¸ä¼šè¢«åå°ç¨‹åºæ”¹å˜ï¼Œå…³é”®å­— volatile æ˜¯ä¸ const ç»å¯¹å¯¹ç«‹çš„ã€‚å®ƒæŒ‡ç¤ºä¸€ä¸ªå˜é‡ä¹Ÿè®¸ä¼šè¢«æŸç§æ–¹å¼ä¿®æ”¹ï¼Œè¿™ç§æ–¹å¼æŒ‰ç…§æ­£å¸¸ç¨‹åºæµç¨‹åˆ†ææ˜¯æ— æ³•é¢„çŸ¥çš„ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªå˜é‡ä¹Ÿè®¸ä¼šè¢«ä¸€ä¸ªä¸­æ–­æœåŠ¡ç¨‹åºæ‰€ä¿®æ”¹ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;å˜é‡å¦‚æœåŠ äº† volatile ä¿®é¥°ï¼Œåˆ™ä¼šä»å†…å­˜é‡æ–°è£…è½½å†…å®¹ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»å¯„å­˜å™¨æ‹·è´å†…å®¹ã€‚ &lt;/p&gt;
    
    </summary>
    
      <category term="c" scheme="http://idiotsky.top/categories/c/"/>
    
    
      <category term="c" scheme="http://idiotsky.top/tags/c/"/>
    
      <category term="volatile" scheme="http://idiotsky.top/tags/volatile/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨iostatåˆ†æIOæ€§èƒ½</title>
    <link href="http://idiotsky.top/2018/11/25/linux-iostat/"/>
    <id>http://idiotsky.top/2018/11/25/linux-iostat/</id>
    <published>2018-11-25T09:39:20.000Z</published>
    <updated>2018-11-25T12:31:35.258Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>iostatç”¨äºè¾“å‡ºCPUå’Œç£ç›˜I/Oç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯.ğŸ‘¿</p>
</blockquote>
<h1 id="ä¸åŠ é€‰é¡¹æ‰§è¡Œiostat"><a href="#ä¸åŠ é€‰é¡¹æ‰§è¡Œiostat" class="headerlink" title="ä¸åŠ é€‰é¡¹æ‰§è¡Œiostat"></a>ä¸åŠ é€‰é¡¹æ‰§è¡Œiostat</h1><p>å•ç‹¬æ‰§è¡Œiostatï¼Œæ˜¾ç¤ºçš„ç»“æœä¸ºä»ç³»ç»Ÿå¼€æœºåˆ°å½“å‰æ‰§è¡Œæ—¶åˆ»çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ iostat</span><br><span class="line">Linux 2.6.32-279.19.3.el6.ucloud.x86_64 (vm1)   06/11/2017  _x86_64_    (8 CPU)</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           0.08    0.00    0.06    0.00    0.00   99.86</span><br><span class="line"></span><br><span class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</span><br><span class="line">vda               0.45         0.29         8.10    6634946  183036680</span><br><span class="line">vdb               0.12         3.11        30.55   70342034  689955328</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>ä»¥ä¸Šè¾“å‡ºä¸­ï¼ŒåŒ…å«ä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>ç¬¬ä¸€è¡Œ:æœ€ä¸Šé¢æŒ‡ç¤ºç³»ç»Ÿç‰ˆæœ¬ã€ä¸»æœºåå’Œå½“å‰æ—¥æœŸ</li>
<li>avg-cpu:æ€»ä½“cpuä½¿ç”¨æƒ…å†µç»Ÿè®¡ä¿¡æ¯ï¼Œå¯¹äºå¤šæ ¸cpuï¼Œè¿™é‡Œä¸ºæ‰€æœ‰cpuçš„å¹³å‡å€¼</li>
<li>Device:å„ç£ç›˜è®¾å¤‡çš„IOç»Ÿè®¡ä¿¡æ¯</li>
</ul>
<p>avg-cpuä¸­å„åˆ—å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>%user:CPUåœ¨ç”¨æˆ·æ€æ‰§è¡Œè¿›ç¨‹çš„æ—¶é—´ç™¾åˆ†æ¯”ã€‚</li>
<li>%nice:CPUåœ¨ç”¨æˆ·æ€æ¨¡å¼ä¸‹ï¼Œç”¨äºniceæ“ä½œï¼Œæ‰€å ç”¨CPUæ€»æ—¶é—´çš„ç™¾åˆ†æ¯”</li>
<li>%system:CPUå¤„åœ¨å†…æ ¸æ€æ‰§è¡Œè¿›ç¨‹çš„æ—¶é—´ç™¾åˆ†æ¯”</li>
<li>%iowait:CPUç”¨äºç­‰å¾…I/Oæ“ä½œå ç”¨CPUæ€»æ—¶é—´çš„ç™¾åˆ†æ¯”</li>
<li>%steal:ç®¡ç†ç¨‹åº(hypervisor)ä¸ºå¦ä¸€ä¸ªè™šæ‹Ÿè¿›ç¨‹æä¾›æœåŠ¡è€Œç­‰å¾…è™šæ‹ŸCPUçš„ç™¾åˆ†æ¯”</li>
<li>%idle:CPUç©ºé—²æ—¶é—´ç™¾åˆ†æ¯”</li>
</ul>
<ol>
<li>è‹¥ %iowait çš„å€¼è¿‡é«˜ï¼Œè¡¨ç¤ºç¡¬ç›˜å­˜åœ¨I/Oç“¶é¢ˆ </li>
<li>è‹¥ %idle çš„å€¼é«˜ä½†ç³»ç»Ÿå“åº”æ…¢æ—¶ï¼Œæœ‰å¯èƒ½æ˜¯CPUç­‰å¾…åˆ†é…å†…å­˜ï¼Œæ­¤æ—¶åº”åŠ å¤§å†…å­˜å®¹é‡ </li>
<li>è‹¥ %idle çš„å€¼æŒç»­ä½äº1ï¼Œåˆ™ç³»ç»Ÿçš„CPUå¤„ç†èƒ½åŠ›ç›¸å¯¹è¾ƒä½ï¼Œè¡¨æ˜ç³»ç»Ÿä¸­æœ€éœ€è¦è§£å†³çš„èµ„æºæ˜¯ CPU</li>
</ol>
<p>Deviceä¸­å„åˆ—å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>Device:è®¾å¤‡åç§°</li>
<li>tps:æ¯ç§’å‘ç£ç›˜è®¾å¤‡è¯·æ±‚æ•°æ®çš„æ¬¡æ•°ï¼ŒåŒ…æ‹¬è¯»ã€å†™è¯·æ±‚ï¼Œä¸ºrtpsä¸wtpsçš„å’Œã€‚å‡ºäºæ•ˆç‡è€ƒè™‘ï¼Œæ¯ä¸€æ¬¡IOä¸‹å‘åå¹¶ä¸æ˜¯ç«‹å³å¤„ç†è¯·æ±‚ï¼Œè€Œæ˜¯å°†è¯·æ±‚åˆå¹¶(merge)ï¼Œè¿™é‡ŒtpsæŒ‡è¯·æ±‚åˆå¹¶åçš„è¯·æ±‚è®¡æ•°ã€‚</li>
<li>Blk_read/s:Indicate the amount of data read from the device expressed in a number of blocks per second. Blocks are equivalent to sectors with kernels 2.4 and later and therefore have a size of 512 bytes. With older kernels, a block is of indeterminate size.</li>
<li>Blk_wrtn/s    Indicate the amount of data written to the device expressed in a number of blocks per second.</li>
<li>Blk_read:å–æ ·æ—¶é—´é—´éš”å†…è¯»æ‰‡åŒºæ€»æ•°é‡</li>
<li>Blk_wrtn:å–æ ·æ—¶é—´é—´éš”å†…å†™æ‰‡åŒºæ€»æ•°é‡</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨-cé€‰é¡¹å•ç‹¬æ˜¾ç¤ºavg-cpuéƒ¨åˆ†çš„ç»“æœï¼Œä½¿ç”¨-dé€‰é¡¹å•ç‹¬æ˜¾ç¤ºDeviceéƒ¨åˆ†çš„ä¿¡æ¯ã€‚</p>
<h1 id="æŒ‡å®šé‡‡æ ·æ—¶é—´é—´éš”ä¸é‡‡æ ·æ¬¡æ•°"><a href="#æŒ‡å®šé‡‡æ ·æ—¶é—´é—´éš”ä¸é‡‡æ ·æ¬¡æ•°" class="headerlink" title="æŒ‡å®šé‡‡æ ·æ—¶é—´é—´éš”ä¸é‡‡æ ·æ¬¡æ•°"></a>æŒ‡å®šé‡‡æ ·æ—¶é—´é—´éš”ä¸é‡‡æ ·æ¬¡æ•°</h1><p>ä»¥â€iostat interval [count] â€å½¢å¼æŒ‡å®šiostatå‘½ä»¤çš„é‡‡æ ·é—´éš”å’Œé‡‡æ ·æ¬¡æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ iostat -d 2 3</span><br><span class="line">Linux 2.6.32-279.19.3.el6.ucloud.x86_64 (vm1)   06/12/2017  _x86_64_    (8 CPU)</span><br><span class="line"></span><br><span class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</span><br><span class="line">vda               0.45         0.29         8.10    6634946  183051408</span><br><span class="line">vdb               0.12         3.11        30.55   70342034  689955328</span><br><span class="line"></span><br><span class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</span><br><span class="line">vda               0.00         0.00         0.00          0          0</span><br><span class="line">vdb               0.00         0.00         0.00          0          0</span><br><span class="line"></span><br><span class="line">Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn</span><br><span class="line">vda               1.50         0.00        12.00          0         24</span><br><span class="line">vdb               0.00         0.00         0.00          0          0</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå‘½ä»¤è¾“å‡ºDeviceçš„ä¿¡æ¯ï¼Œé‡‡æ ·æ—¶é—´ä¸º1ç§’ï¼Œé‡‡æ ·2æ¬¡ï¼Œè‹¥ä¸æŒ‡å®šé‡‡æ ·æ¬¡æ•°ï¼Œåˆ™iostatä¼šä¸€ç›´è¾“å‡ºé‡‡æ ·ä¿¡æ¯ï¼Œç›´åˆ°æŒ‰â€ctrl+câ€é€€å‡ºå‘½ä»¤ã€‚æ³¨æ„ï¼Œç¬¬1æ¬¡é‡‡æ ·ä¿¡æ¯ä¸å•ç‹¬æ‰§è¡Œiostatçš„æ•ˆæœä¸€æ ·ï¼Œä¸ºä»ç³»ç»Ÿå¼€æœºåˆ°å½“å‰æ‰§è¡Œæ—¶åˆ»çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
<h1 id="ä»¥kBä¸ºå•ä½æ˜¾ç¤ºè¯»å†™ä¿¡æ¯-ké€‰é¡¹-ä»¥mBä¸ºå•ä½æ˜¾ç¤ºè¯»å†™ä¿¡æ¯-mé€‰é¡¹"><a href="#ä»¥kBä¸ºå•ä½æ˜¾ç¤ºè¯»å†™ä¿¡æ¯-ké€‰é¡¹-ä»¥mBä¸ºå•ä½æ˜¾ç¤ºè¯»å†™ä¿¡æ¯-mé€‰é¡¹" class="headerlink" title="ä»¥kBä¸ºå•ä½æ˜¾ç¤ºè¯»å†™ä¿¡æ¯(-ké€‰é¡¹)/ä»¥mBä¸ºå•ä½æ˜¾ç¤ºè¯»å†™ä¿¡æ¯(-mé€‰é¡¹)"></a>ä»¥kBä¸ºå•ä½æ˜¾ç¤ºè¯»å†™ä¿¡æ¯(-ké€‰é¡¹)/ä»¥mBä¸ºå•ä½æ˜¾ç¤ºè¯»å†™ä¿¡æ¯(-mé€‰é¡¹)</h1><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨-ké€‰é¡¹ï¼ŒæŒ‡å®šiostatçš„éƒ¨åˆ†è¾“å‡ºç»“æœä»¥kBä¸ºå•ä½ï¼Œè€Œä¸æ˜¯ä»¥å—æ•°ä¸ºå•ä½ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ iostat -d -k</span><br><span class="line">Linux 2.6.32-279.19.3.el6.ucloud.x86_64 (vm1)   06/12/2017  _x86_64_    (8 CPU)</span><br><span class="line"></span><br><span class="line">Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">vda               0.45         0.15         4.05    3317473   91525980</span><br><span class="line">vdb               0.12         1.56        15.27   35171017  344977664</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šè¾“å‡ºä¸­ï¼ŒkB_read/sã€kB_wrtn/sã€kB_readå’ŒkB_wrtnçš„å€¼å‡ä»¥kBä¸ºå•ä½ï¼Œç›¸æ¯”ä»¥å—æ•°ä¸ºå•ä½ï¼Œè¿™é‡Œçš„å€¼ä¸ºåŸå€¼çš„ä¸€åŠ(1kB=512bytes*2)</p>
<h1 id="æ›´è¯¦ç»†çš„ioç»Ÿè®¡ä¿¡æ¯-xé€‰é¡¹"><a href="#æ›´è¯¦ç»†çš„ioç»Ÿè®¡ä¿¡æ¯-xé€‰é¡¹" class="headerlink" title="æ›´è¯¦ç»†çš„ioç»Ÿè®¡ä¿¡æ¯(-xé€‰é¡¹)"></a>æ›´è¯¦ç»†çš„ioç»Ÿè®¡ä¿¡æ¯(-xé€‰é¡¹)</h1><p>ä¸ºæ˜¾ç¤ºæ›´è¯¦ç»†çš„ioè®¾å¤‡ç»Ÿè®¡ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨-xé€‰é¡¹ï¼Œåœ¨åˆ†æioç“¶é¢ˆæ—¶ï¼Œä¸€èˆ¬éƒ½ä¼šå¼€å¯-xé€‰é¡¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ iostat -x -k -d 1</span><br><span class="line">Linux 2.6.32-279.19.16.el6.ucloud.x86_64 (yg-uhost724)  06/12/2017  _x86_64_    (24 CPU)</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await  svctm  %util</span><br><span class="line">sda               0.00  9915.00    1.00   90.00     4.00 34360.00   755.25    11.79  120.57   6.33  57.60</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šå„åˆ—çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>rrqm/s:æ¯ç§’å¯¹è¯¥è®¾å¤‡çš„è¯»è¯·æ±‚è¢«åˆå¹¶æ¬¡æ•°ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šå¯¹è¯»å–åŒå—(block)çš„è¯·æ±‚è¿›è¡Œåˆå¹¶</li>
<li>wrqm/s:æ¯ç§’å¯¹è¯¥è®¾å¤‡çš„å†™è¯·æ±‚è¢«åˆå¹¶æ¬¡æ•°</li>
<li>r/s:æ¯ç§’å®Œæˆçš„è¯»æ¬¡æ•°</li>
<li>w/s:æ¯ç§’å®Œæˆçš„å†™æ¬¡æ•°</li>
<li>rkB/s:æ¯ç§’è¯»æ•°æ®é‡(kBä¸ºå•ä½)</li>
<li>wkB/s:æ¯ç§’å†™æ•°æ®é‡(kBä¸ºå•ä½)</li>
<li>avgrq-sz:å¹³å‡æ¯æ¬¡IOæ“ä½œçš„æ•°æ®é‡(æ‰‡åŒºæ•°ä¸ºå•ä½)</li>
<li>avgqu-sz:å¹³å‡ç­‰å¾…å¤„ç†çš„IOè¯·æ±‚é˜Ÿåˆ—é•¿åº¦</li>
<li>await:å¹³å‡æ¯æ¬¡IOè¯·æ±‚ç­‰å¾…æ—¶é—´(åŒ…æ‹¬ç­‰å¾…æ—¶é—´å’Œå¤„ç†æ—¶é—´ï¼Œæ¯«ç§’ä¸ºå•ä½)</li>
<li>svctm:å¹³å‡æ¯æ¬¡IOè¯·æ±‚çš„å¤„ç†æ—¶é—´(æ¯«ç§’ä¸ºå•ä½)</li>
<li>%util:é‡‡ç”¨å‘¨æœŸå†…ç”¨äºIOæ“ä½œçš„æ—¶é—´æ¯”ç‡ï¼Œå³IOé˜Ÿåˆ—éç©ºçš„æ—¶é—´æ¯”ç‡</li>
</ul>
<p>å¯¹äºä»¥ä¸Šç¤ºä¾‹è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š </p>
<ul>
<li>æ¯ç§’å‘ç£ç›˜ä¸Šå†™30Må·¦å³æ•°æ®(wkB/så€¼) </li>
<li>æ¯ç§’æœ‰91æ¬¡IOæ“ä½œ(r/s+w/s)ï¼Œå…¶ä¸­ä»¥å†™æ“ä½œä¸ºä¸»ä½“ </li>
<li>å¹³å‡æ¯æ¬¡IOè¯·æ±‚ç­‰å¾…æ—¶é—´ä¸º120.57æ¯«ç§’ï¼Œå¤„ç†æ—¶é—´ä¸º6.33æ¯«ç§’ </li>
<li>ç­‰å¾…å¤„ç†çš„IOè¯·æ±‚é˜Ÿåˆ—ä¸­ï¼Œå¹³å‡æœ‰11.79ä¸ªè¯·æ±‚é©»ç•™</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;iostatç”¨äºè¾“å‡ºCPUå’Œç£ç›˜I/Oç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯.ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;ä¸åŠ é€‰é¡¹æ‰§è¡Œiostat&quot;&gt;&lt;a href=&quot;#ä¸åŠ é€‰é¡¹æ‰§è¡Œiostat&quot; class=&quot;headerlink&quot; title=&quot;ä¸åŠ é€‰é¡¹æ‰§è¡Œiostat&quot;&gt;&lt;/a&gt;ä¸åŠ é€‰é¡¹æ‰§è¡Œiostat&lt;/h1&gt;&lt;p&gt;å•ç‹¬æ‰§è¡Œiostatï¼Œæ˜¾ç¤ºçš„ç»“æœä¸ºä»ç³»ç»Ÿå¼€æœºåˆ°å½“å‰æ‰§è¡Œæ—¶åˆ»çš„ç»Ÿè®¡ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ iostat&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Linux 2.6.32-279.19.3.el6.ucloud.x86_64 (vm1)   06/11/2017  _x86_64_    (8 CPU)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;avg-cpu:  %user   %nice %system %iowait  %steal   %idle&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           0.08    0.00    0.06    0.00    0.00   99.86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vda               0.45         0.29         8.10    6634946  183036680&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vdb               0.12         3.11        30.55   70342034  689955328&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="linuxå‘½ä»¤" scheme="http://idiotsky.top/categories/linux%E5%91%BD%E4%BB%A4/"/>
    
    
      <category term="linux" scheme="http://idiotsky.top/tags/linux/"/>
    
      <category term="iostat" scheme="http://idiotsky.top/tags/iostat/"/>
    
  </entry>
  
  <entry>
    <title>ç¡¬ç›˜åŸºæœ¬çŸ¥è¯†</title>
    <link href="http://idiotsky.top/2018/11/23/harddisk-knowledge/"/>
    <id>http://idiotsky.top/2018/11/23/harddisk-knowledge/</id>
    <published>2018-11-23T15:21:31.000Z</published>
    <updated>2018-11-23T15:35:22.722Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>markå§ï¼Œæ²¡ä»€ä¹ˆå¯å†™äº†ğŸ‘¿</p>
</blockquote>
<h1 id="ç›˜ç‰‡-ç‰‡é¢-å’Œ-ç£å¤´"><a href="#ç›˜ç‰‡-ç‰‡é¢-å’Œ-ç£å¤´" class="headerlink" title="ç›˜ç‰‡ ç‰‡é¢ å’Œ ç£å¤´"></a>ç›˜ç‰‡ ç‰‡é¢ å’Œ ç£å¤´</h1><p>ç¡¬ç›˜ä¸­ä¸€èˆ¬ä¼šæœ‰å¤šä¸ªç›˜ç‰‡ç»„æˆï¼Œæ¯ä¸ªç›˜ç‰‡åŒ…å«ä¸¤ä¸ªé¢ï¼Œæ¯ä¸ªç›˜é¢éƒ½å¯¹åº”åœ°æœ‰ä¸€ä¸ªè¯»/å†™ç£å¤´ã€‚å—åˆ°ç¡¬ç›˜æ•´ä½“ä½“ç§¯å’Œç”Ÿäº§æˆæœ¬çš„é™åˆ¶ï¼Œç›˜ç‰‡æ•°é‡éƒ½å—åˆ°é™åˆ¶ï¼Œä¸€èˆ¬éƒ½åœ¨5ç‰‡ä»¥å†…ã€‚ç›˜ç‰‡çš„ç¼–å·è‡ªä¸‹å‘ä¸Šä»0å¼€å§‹ï¼Œå¦‚æœ€ä¸‹è¾¹çš„ç›˜ç‰‡æœ‰0é¢å’Œ1é¢ï¼Œå†ä¸Šä¸€ä¸ªç›˜ç‰‡å°±ç¼–å·ä¸º2é¢å’Œ3é¢ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images3/harddisk-1.png"><img src="http://idiotsky.top/images3/harddisk-1.png" alt=""></a></p>
<a id="more"></a>
<h1 id="æ‰‡åŒº-å’Œ-ç£é“"><a href="#æ‰‡åŒº-å’Œ-ç£é“" class="headerlink" title="æ‰‡åŒº å’Œ ç£é“"></a>æ‰‡åŒº å’Œ ç£é“</h1><p>ä¸‹å›¾æ˜¾ç¤ºçš„æ˜¯ä¸€ä¸ªç›˜é¢ï¼Œç›˜é¢ä¸­ä¸€åœˆåœˆç°è‰²åŒå¿ƒåœ†ä¸ºä¸€æ¡æ¡ç£é“ï¼Œä»åœ†å¿ƒå‘å¤–ç”»ç›´çº¿ï¼Œå¯ä»¥å°†ç£é“åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªå¼§æ®µï¼Œæ¯ä¸ªç£é“ä¸Šä¸€ä¸ªå¼§æ®µè¢«ç§°ä¹‹ä¸ºä¸€ä¸ªæ‰‡åŒºï¼ˆå›¾è·µç»¿è‰²éƒ¨åˆ†ï¼‰ã€‚æ‰‡åŒºæ˜¯ç£ç›˜çš„æœ€å°ç»„æˆå•å…ƒï¼Œé€šå¸¸æ˜¯512å­—èŠ‚ã€‚ï¼ˆç”±äºä¸æ–­æé«˜ç£ç›˜çš„å¤§å°ï¼Œéƒ¨åˆ†å‚å•†è®¾å®šæ¯ä¸ªæ‰‡åŒºçš„å¤§å°æ˜¯4096å­—èŠ‚ï¼‰</p>
<p><a href="http://idiotsky.top/images3/harddisk-2.png"><img src="http://idiotsky.top/images3/harddisk-2.png" alt=""></a></p>
<h1 id="ç£å¤´-å’Œ-æŸ±é¢"><a href="#ç£å¤´-å’Œ-æŸ±é¢" class="headerlink" title="ç£å¤´ å’Œ æŸ±é¢"></a>ç£å¤´ å’Œ æŸ±é¢</h1><p>ç¡¬ç›˜é€šå¸¸ç”±é‡å çš„ä¸€ç»„ç›˜ç‰‡æ„æˆï¼Œæ¯ä¸ªç›˜é¢éƒ½è¢«åˆ’åˆ†ä¸ºæ•°ç›®ç›¸ç­‰çš„ç£é“ï¼Œå¹¶ä»å¤–ç¼˜çš„â€œ0â€å¼€å§‹ç¼–å·ï¼Œå…·æœ‰ç›¸åŒç¼–å·çš„ç£é“å½¢æˆä¸€ä¸ªåœ†æŸ±ï¼Œç§°ä¹‹ä¸ºç£ç›˜çš„æŸ±é¢ã€‚ç£ç›˜çš„æŸ±é¢æ•°ä¸ä¸€ä¸ªç›˜é¢ä¸Šçš„ç£é“æ•°æ˜¯ç›¸ç­‰çš„ã€‚ç”±äºæ¯ä¸ªç›˜é¢éƒ½æœ‰è‡ªå·±çš„ç£å¤´ï¼Œå› æ­¤ï¼Œç›˜é¢æ•°ç­‰äºæ€»çš„ç£å¤´æ•°ã€‚ å¦‚ä¸‹å›¾</p>
<p><a href="http://idiotsky.top/images3/harddisk-3.png"><img src="http://idiotsky.top/images3/harddisk-3.png" alt=""></a></p>
<h1 id="ç£ç›˜å®¹é‡è®¡ç®—"><a href="#ç£ç›˜å®¹é‡è®¡ç®—" class="headerlink" title="ç£ç›˜å®¹é‡è®¡ç®—"></a>ç£ç›˜å®¹é‡è®¡ç®—</h1><p>å­˜å‚¨å®¹é‡ ï¼ ç£å¤´æ•° Ã— ç£é“(æŸ±é¢)æ•° Ã— æ¯é“æ‰‡åŒºæ•° Ã— æ¯æ‰‡åŒºå­—èŠ‚æ•°</p>
<p>å›¾3ä¸­ç£ç›˜æ˜¯ä¸€ä¸ª 3ä¸ªåœ†ç›˜6ä¸ªç£å¤´ï¼Œ7ä¸ªæŸ±é¢ï¼ˆæ¯ä¸ªç›˜ç‰‡7ä¸ªç£é“ï¼‰ çš„ç£ç›˜ï¼Œå›¾3ä¸­æ¯æ¡ç£é“æœ‰12ä¸ªæ‰‡åŒºï¼Œæ‰€ä»¥æ­¤ç£ç›˜çš„å®¹é‡ä¸ºï¼š</p>
<p>å­˜å‚¨å®¹é‡ 6 <em> 7 </em> 12 * 512 = 258048</p>
<blockquote>
<p>æ¯ä¸ªç£é“çš„æ‰‡åŒºæ•°ä¸€æ ·æ˜¯è¯´çš„è€çš„ç¡¬ç›˜ï¼Œå¤–åœˆçš„å¯†åº¦å°ï¼Œå†…åœˆçš„å¯†åº¦å¤§ï¼Œæ¯åœˆå¯å­˜å‚¨çš„æ•°æ®é‡æ˜¯ä¸€æ ·çš„ã€‚æ–°çš„ç¡¬ç›˜æ•°æ®çš„å¯†åº¦éƒ½ä¸€è‡´ï¼Œè¿™æ ·ç£é“çš„å‘¨é•¿è¶Šé•¿ï¼Œæ‰‡åŒºå°±è¶Šå¤šï¼Œå­˜å‚¨çš„æ•°æ®é‡å°±è¶Šå¤§ã€‚</p>
</blockquote>
<h1 id="ç£ç›˜è¯»å–å“åº”æ—¶é—´"><a href="#ç£ç›˜è¯»å–å“åº”æ—¶é—´" class="headerlink" title="ç£ç›˜è¯»å–å“åº”æ—¶é—´"></a>ç£ç›˜è¯»å–å“åº”æ—¶é—´</h1><ol>
<li>å¯»é“æ—¶é—´ï¼šç£å¤´ä»å¼€å§‹ç§»åŠ¨åˆ°æ•°æ®æ‰€åœ¨ç£é“æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå¯»é“æ—¶é—´è¶ŠçŸ­ï¼ŒI/Oæ“ä½œè¶Šå¿«ï¼Œç›®å‰ç£ç›˜çš„å¹³å‡å¯»é“æ—¶é—´ä¸€èˆ¬åœ¨3ï¼15msï¼Œä¸€èˆ¬éƒ½åœ¨10mså·¦å³ã€‚</li>
<li>æ—‹è½¬å»¶è¿Ÿï¼šç›˜ç‰‡æ—‹è½¬å°†è¯·æ±‚æ•°æ®æ‰€åœ¨æ‰‡åŒºç§»è‡³è¯»å†™ç£å¤´ä¸‹æ–¹æ‰€éœ€è¦çš„æ—¶é—´ï¼Œæ—‹è½¬å»¶è¿Ÿå–å†³äºç£ç›˜è½¬é€Ÿã€‚æ™®é€šç¡¬ç›˜ä¸€èˆ¬éƒ½æ˜¯7200rpmï¼Œæ…¢çš„5400rpmã€‚</li>
<li>æ•°æ®ä¼ è¾“æ—¶é—´ï¼šå®Œæˆä¼ è¾“æ‰€è¯·æ±‚çš„æ•°æ®æ‰€éœ€è¦çš„æ—¶é—´ã€‚</li>
</ol>
<p>å°ç»“ä¸€ä¸‹ï¼šä»ä¸Šé¢çš„æŒ‡æ ‡æ¥çœ‹ã€å…¶å®æœ€é‡è¦çš„ã€æˆ–è€…è¯´ã€æˆ‘ä»¬æœ€å…³å¿ƒçš„åº”è¯¥åªæœ‰ä¸¤ä¸ªï¼šå¯»é“æ—¶é—´ï¼›æ—‹è½¬å»¶è¿Ÿã€‚</p>
<blockquote>
<p>è¯»å†™ä¸€æ¬¡ç£ç›˜ä¿¡æ¯æ‰€éœ€çš„æ—¶é—´å¯åˆ†è§£ä¸ºï¼šå¯»é“æ—¶é—´ã€å»¶è¿Ÿæ—¶é—´ã€ä¼ è¾“æ—¶é—´ã€‚ä¸ºæé«˜ç£ç›˜ä¼ è¾“æ•ˆç‡ï¼Œè½¯ä»¶åº”ç€é‡è€ƒè™‘å‡å°‘å¯»é“æ—¶é—´å’Œå»¶è¿Ÿæ—¶é—´ã€‚</p>
</blockquote>
<h1 id="å—-ç°‡"><a href="#å—-ç°‡" class="headerlink" title="å—/ç°‡"></a>å—/ç°‡</h1><p>æ¦‚è¿°</p>
<p>ç£ç›˜å—/ç°‡ï¼ˆè™šæ‹Ÿå‡ºæ¥çš„ï¼‰ã€‚ å—æ˜¯æ“ä½œç³»ç»Ÿä¸­æœ€å°çš„é€»è¾‘å­˜å‚¨å•ä½ã€‚æ“ä½œç³»ç»Ÿä¸ç£ç›˜æ‰“äº¤é“çš„æœ€å°å•ä½æ˜¯ç£ç›˜å—ã€‚<br>é€šä¿—çš„æ¥è®²ï¼Œåœ¨Windowsä¸‹å¦‚NTFSç­‰æ–‡ä»¶ç³»ç»Ÿä¸­å«åšç°‡ï¼›åœ¨Linuxä¸‹å¦‚Ext4ç­‰æ–‡ä»¶ç³»ç»Ÿä¸­å«åšå—ï¼ˆblockï¼‰ã€‚æ¯ä¸ªç°‡æˆ–è€…å—å¯ä»¥åŒ…æ‹¬2ã€4ã€8ã€16ã€32ã€64â€¦2çš„næ¬¡æ–¹ä¸ªæ‰‡åŒºã€‚</p>
<p>ä¸ºä»€ä¹ˆå­˜åœ¨ç£ç›˜å—ï¼Ÿ</p>
<p>è¯»å–æ–¹ä¾¿ï¼šç”±äºæ‰‡åŒºçš„æ•°é‡æ¯”è¾ƒå°ï¼Œæ•°ç›®ä¼—å¤šåœ¨å¯»å€æ—¶æ¯”è¾ƒå›°éš¾ï¼Œæ‰€ä»¥æ“ä½œç³»ç»Ÿå°±å°†ç›¸é‚»çš„æ‰‡åŒºç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå—ï¼Œå†å¯¹å—è¿›è¡Œæ•´ä½“çš„æ“ä½œã€‚</p>
<p>åˆ†ç¦»å¯¹åº•å±‚çš„ä¾èµ–ï¼šæ“ä½œç³»ç»Ÿå¿½ç•¥å¯¹åº•å±‚ç‰©ç†å­˜å‚¨ç»“æ„çš„è®¾è®¡ã€‚é€šè¿‡è™šæ‹Ÿå‡ºæ¥ç£ç›˜å—çš„æ¦‚å¿µï¼Œåœ¨ç³»ç»Ÿä¸­è®¤ä¸ºå—æ˜¯æœ€å°çš„å•ä½ã€‚</p>
<h1 id="page"><a href="#page" class="headerlink" title="page"></a>page</h1><p>æ“ä½œç³»ç»Ÿç»å¸¸ä¸å†…å­˜å’Œç¡¬ç›˜è¿™ä¸¤ç§å­˜å‚¨è®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œç±»ä¼¼äºâ€œå—â€çš„æ¦‚å¿µï¼Œéƒ½éœ€è¦ä¸€ç§è™šæ‹Ÿçš„åŸºæœ¬å•ä½ã€‚æ‰€ä»¥ï¼Œä¸å†…å­˜æ“ä½œï¼Œæ˜¯è™šæ‹Ÿä¸€ä¸ªé¡µçš„æ¦‚å¿µæ¥ä½œä¸ºæœ€å°å•ä½ã€‚ä¸ç¡¬ç›˜æ‰“äº¤é“ï¼Œå°±æ˜¯ä»¥å—ä¸ºæœ€å°å•ä½ã€‚</p>
<p>#æ‰‡åŒºã€å—/ç°‡ã€pageçš„å…³ç³»</p>
<p>æ‰‡åŒºï¼š ç¡¬ç›˜çš„æœ€å°è¯»å†™å•å…ƒ<br>å—/ç°‡ï¼š æ˜¯æ“ä½œç³»ç»Ÿé’ˆå¯¹ç¡¬ç›˜è¯»å†™çš„æœ€å°å•å…ƒ<br>pageï¼š æ˜¯å†…å­˜ä¸æ“ä½œç³»ç»Ÿä¹‹é—´æ“ä½œçš„æœ€å°å•å…ƒã€‚</p>
<p>æ‰‡åŒº &lt;= å—/ç°‡ &lt;= page</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://www.jianshu.com/p/9aa66f634ed6" target="_blank" rel="noopener">https://www.jianshu.com/p/9aa66f634ed6</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;markå§ï¼Œæ²¡ä»€ä¹ˆå¯å†™äº†ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;ç›˜ç‰‡-ç‰‡é¢-å’Œ-ç£å¤´&quot;&gt;&lt;a href=&quot;#ç›˜ç‰‡-ç‰‡é¢-å’Œ-ç£å¤´&quot; class=&quot;headerlink&quot; title=&quot;ç›˜ç‰‡ ç‰‡é¢ å’Œ ç£å¤´&quot;&gt;&lt;/a&gt;ç›˜ç‰‡ ç‰‡é¢ å’Œ ç£å¤´&lt;/h1&gt;&lt;p&gt;ç¡¬ç›˜ä¸­ä¸€èˆ¬ä¼šæœ‰å¤šä¸ªç›˜ç‰‡ç»„æˆï¼Œæ¯ä¸ªç›˜ç‰‡åŒ…å«ä¸¤ä¸ªé¢ï¼Œæ¯ä¸ªç›˜é¢éƒ½å¯¹åº”åœ°æœ‰ä¸€ä¸ªè¯»/å†™ç£å¤´ã€‚å—åˆ°ç¡¬ç›˜æ•´ä½“ä½“ç§¯å’Œç”Ÿäº§æˆæœ¬çš„é™åˆ¶ï¼Œç›˜ç‰‡æ•°é‡éƒ½å—åˆ°é™åˆ¶ï¼Œä¸€èˆ¬éƒ½åœ¨5ç‰‡ä»¥å†…ã€‚ç›˜ç‰‡çš„ç¼–å·è‡ªä¸‹å‘ä¸Šä»0å¼€å§‹ï¼Œå¦‚æœ€ä¸‹è¾¹çš„ç›˜ç‰‡æœ‰0é¢å’Œ1é¢ï¼Œå†ä¸Šä¸€ä¸ªç›˜ç‰‡å°±ç¼–å·ä¸º2é¢å’Œ3é¢ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://idiotsky.top/images3/harddisk-1.png&quot;&gt;&lt;img src=&quot;http://idiotsky.top/images3/harddisk-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="linux" scheme="http://idiotsky.top/categories/linux/"/>
    
    
      <category term="linux" scheme="http://idiotsky.top/tags/linux/"/>
    
      <category term="ç¡¬ç›˜" scheme="http://idiotsky.top/tags/%E7%A1%AC%E7%9B%98/"/>
    
  </entry>
  
  <entry>
    <title>ç†”æ–­å™¨æ¦‚å¿µ</title>
    <link href="http://idiotsky.top/2018/11/06/CircuitBreaker/"/>
    <id>http://idiotsky.top/2018/11/06/CircuitBreaker/</id>
    <published>2018-11-06T14:41:21.000Z</published>
    <updated>2018-11-25T12:42:22.648Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç»å¸¸ä¼šå‡ºç°æŸä¸ªåŸºç¡€æœåŠ¡ä¸å¯ç”¨é€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨çš„æƒ…å†µ, è¿™ç§ç°è±¡è¢«ç§°ä¸ºæœåŠ¡é›ªå´©æ•ˆåº”. ä¸ºäº†åº”å¯¹æœåŠ¡é›ªå´©, ä¸€ç§å¸¸è§çš„åšæ³•æ˜¯æ‰‹åŠ¨æœåŠ¡é™çº§. è€ŒHystrixçš„å‡ºç°,ç»™æˆ‘ä»¬æä¾›äº†å¦ä¸€ç§é€‰æ‹©.</p>
<h1 id="æœåŠ¡é›ªå´©æ•ˆåº”çš„å®šä¹‰"><a href="#æœåŠ¡é›ªå´©æ•ˆåº”çš„å®šä¹‰" class="headerlink" title="æœåŠ¡é›ªå´©æ•ˆåº”çš„å®šä¹‰"></a>æœåŠ¡é›ªå´©æ•ˆåº”çš„å®šä¹‰</h1><p>æœåŠ¡é›ªå´©æ•ˆåº”æ˜¯ä¸€ç§å›  æœåŠ¡æä¾›è€… çš„ä¸å¯ç”¨å¯¼è‡´ æœåŠ¡è°ƒç”¨è€… çš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨ é€æ¸æ”¾å¤§ çš„è¿‡ç¨‹.å¦‚æœæ‰€ç¤º:</p>
<p><a href="http://idiotsky.top/images3/CircuitBreaker-1.png"><img src="http://idiotsky.top/images3/CircuitBreaker-1.png" alt=""></a></p>
<p>ä¸Šå›¾ä¸­, Aä¸ºæœåŠ¡æä¾›è€…, Bä¸ºAçš„æœåŠ¡è°ƒç”¨è€…, Cå’ŒDæ˜¯Bçš„æœåŠ¡è°ƒç”¨è€…. å½“Açš„ä¸å¯ç”¨,å¼•èµ·Bçš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨é€æ¸æ”¾å¤§Cå’ŒDæ—¶, æœåŠ¡é›ªå´©å°±å½¢æˆäº†.</p>
<a id="more"></a>
<h1 id="æœåŠ¡é›ªå´©æ•ˆåº”å½¢æˆçš„åŸå› "><a href="#æœåŠ¡é›ªå´©æ•ˆåº”å½¢æˆçš„åŸå› " class="headerlink" title="æœåŠ¡é›ªå´©æ•ˆåº”å½¢æˆçš„åŸå› "></a>æœåŠ¡é›ªå´©æ•ˆåº”å½¢æˆçš„åŸå› </h1><p>æˆ‘æŠŠæœåŠ¡é›ªå´©çš„å‚ä¸è€…ç®€åŒ–ä¸º æœåŠ¡æä¾›è€… å’Œ æœåŠ¡è°ƒç”¨è€…, å¹¶å°†æœåŠ¡é›ªå´©äº§ç”Ÿçš„è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µæ¥åˆ†æå½¢æˆçš„åŸå› :</p>
<ol>
<li>æœåŠ¡æä¾›è€…ä¸å¯ç”¨</li>
<li>é‡è¯•åŠ å¤§æµé‡</li>
<li>æœåŠ¡è°ƒç”¨è€…ä¸å¯ç”¨</li>
</ol>
<p><a href="http://idiotsky.top/images3/CircuitBreaker-2.png"><img src="http://idiotsky.top/images3/CircuitBreaker-2.png" alt=""></a></p>
<p>æœåŠ¡é›ªå´©çš„æ¯ä¸ªé˜¶æ®µéƒ½å¯èƒ½ç”±ä¸åŒçš„åŸå› é€ æˆ, æ¯”å¦‚é€ æˆ<strong>æœåŠ¡ä¸å¯ç”¨</strong>çš„åŸå› æœ‰:</p>
<ul>
<li>ç¡¬ä»¶æ•…éšœ</li>
<li>ç¨‹åºBug</li>
<li>ç¼“å­˜å‡»ç©¿</li>
<li>ç”¨æˆ·å¤§é‡è¯·æ±‚</li>
</ul>
<p>ç¡¬ä»¶æ•…éšœå¯èƒ½ä¸ºç¡¬ä»¶æŸåé€ æˆçš„æœåŠ¡å™¨ä¸»æœºå®•æœº, ç½‘ç»œç¡¬ä»¶æ•…éšœé€ æˆçš„æœåŠ¡æä¾›è€…çš„ä¸å¯è®¿é—®.<br>ç¼“å­˜å‡»ç©¿ä¸€èˆ¬å‘ç”Ÿåœ¨ç¼“å­˜åº”ç”¨é‡å¯, æ‰€æœ‰ç¼“å­˜è¢«æ¸…ç©ºæ—¶,ä»¥åŠçŸ­æ—¶é—´å†…å¤§é‡ç¼“å­˜å¤±æ•ˆæ—¶. å¤§é‡çš„ç¼“å­˜ä¸å‘½ä¸­, ä½¿è¯·æ±‚ç›´å‡»åç«¯,é€ æˆæœåŠ¡æä¾›è€…è¶…è´Ÿè·è¿è¡Œ,å¼•èµ·æœåŠ¡ä¸å¯ç”¨.<br>åœ¨ç§’æ€å’Œå¤§ä¿ƒå¼€å§‹å‰,å¦‚æœå‡†å¤‡ä¸å……åˆ†,ç”¨æˆ·å‘èµ·å¤§é‡è¯·æ±‚ä¹Ÿä¼šé€ æˆæœåŠ¡æä¾›è€…çš„ä¸å¯ç”¨.</p>
<p>è€Œå½¢æˆ<strong>é‡è¯•åŠ å¤§æµé‡</strong>çš„åŸå› æœ‰:</p>
<ul>
<li>ç”¨æˆ·é‡è¯•</li>
<li>ä»£ç é€»è¾‘é‡è¯•</li>
</ul>
<p>åœ¨æœåŠ¡æä¾›è€…ä¸å¯ç”¨å, ç”¨æˆ·ç”±äºå¿å—ä¸äº†ç•Œé¢ä¸Šé•¿æ—¶é—´çš„ç­‰å¾…,è€Œä¸æ–­åˆ·æ–°é¡µé¢ç”šè‡³æäº¤è¡¨å•.<br>æœåŠ¡è°ƒç”¨ç«¯çš„ä¼šå­˜åœ¨å¤§é‡æœåŠ¡å¼‚å¸¸åçš„é‡è¯•é€»è¾‘.<br>è¿™äº›é‡è¯•éƒ½ä¼šè¿›ä¸€æ­¥åŠ å¤§è¯·æ±‚æµé‡.</p>
<p>æœ€å, <strong>æœåŠ¡è°ƒç”¨è€…ä¸å¯ç”¨</strong>äº§ç”Ÿçš„ä¸»è¦åŸå› æ˜¯:</p>
<ul>
<li>åŒæ­¥ç­‰å¾…é€ æˆçš„èµ„æºè€—å°½</li>
</ul>
<p>å½“æœåŠ¡è°ƒç”¨è€…ä½¿ç”¨<strong>åŒæ­¥è°ƒç”¨</strong>æ—¶, ä¼šäº§ç”Ÿå¤§é‡çš„ç­‰å¾…çº¿ç¨‹å ç”¨ç³»ç»Ÿèµ„æº. ä¸€æ—¦çº¿ç¨‹èµ„æºè¢«è€—å°½,æœåŠ¡è°ƒç”¨è€…æä¾›çš„æœåŠ¡ä¹Ÿå°†å¤„äºä¸å¯ç”¨çŠ¶æ€, äºæ˜¯æœåŠ¡é›ªå´©æ•ˆåº”äº§ç”Ÿäº†.</p>
<h1 id="æœåŠ¡é›ªå´©çš„åº”å¯¹ç­–ç•¥"><a href="#æœåŠ¡é›ªå´©çš„åº”å¯¹ç­–ç•¥" class="headerlink" title="æœåŠ¡é›ªå´©çš„åº”å¯¹ç­–ç•¥"></a>æœåŠ¡é›ªå´©çš„åº”å¯¹ç­–ç•¥</h1><p>é’ˆå¯¹é€ æˆæœåŠ¡é›ªå´©çš„ä¸åŒåŸå› , å¯ä»¥ä½¿ç”¨ä¸åŒçš„åº”å¯¹ç­–ç•¥:</p>
<ol>
<li>æµé‡æ§åˆ¶</li>
<li>æ”¹è¿›ç¼“å­˜æ¨¡å¼</li>
<li>æœåŠ¡è‡ªåŠ¨æ‰©å®¹</li>
<li>æœåŠ¡è°ƒç”¨è€…é™çº§æœåŠ¡</li>
</ol>
<p><strong>æµé‡æ§åˆ¶</strong>çš„å…·ä½“æªæ–½åŒ…æ‹¬:</p>
<ul>
<li>ç½‘å…³é™æµ</li>
<li>ç”¨æˆ·äº¤äº’é™æµ</li>
<li>å…³é—­é‡è¯•</li>
</ul>
<p>å› ä¸ºNginxçš„é«˜æ€§èƒ½, ç›®å‰ä¸€çº¿äº’è”ç½‘å…¬å¸å¤§é‡é‡‡ç”¨Nginx+Luaçš„ç½‘å…³è¿›è¡Œæµé‡æ§åˆ¶, ç”±æ­¤è€Œæ¥çš„OpenRestyä¹Ÿè¶Šæ¥è¶Šçƒ­é—¨.</p>
<p>ç”¨æˆ·äº¤äº’é™æµçš„å…·ä½“æªæ–½æœ‰: 1. é‡‡ç”¨åŠ è½½åŠ¨ç”»,æé«˜ç”¨æˆ·çš„å¿è€ç­‰å¾…æ—¶é—´. 2. æäº¤æŒ‰é’®æ·»åŠ å¼ºåˆ¶ç­‰å¾…æ—¶é—´æœºåˆ¶.</p>
<p><strong>æ”¹è¿›ç¼“å­˜æ¨¡å¼</strong>çš„æªæ–½åŒ…æ‹¬:</p>
<ul>
<li>ç¼“å­˜é¢„åŠ è½½</li>
<li>åŒæ­¥æ”¹ä¸ºå¼‚æ­¥åˆ·æ–°</li>
</ul>
<p><strong>æœåŠ¡è‡ªåŠ¨æ‰©å®¹</strong>çš„æªæ–½ä¸»è¦æœ‰:</p>
<ul>
<li>AWSçš„auto scaling</li>
</ul>
<p><strong>æœåŠ¡è°ƒç”¨è€…é™çº§æœåŠ¡</strong>çš„æªæ–½åŒ…æ‹¬:</p>
<ul>
<li>èµ„æºéš”ç¦»</li>
<li>å¯¹ä¾èµ–æœåŠ¡è¿›è¡Œåˆ†ç±»</li>
<li>ä¸å¯ç”¨æœåŠ¡çš„è°ƒç”¨å¿«é€Ÿå¤±è´¥</li>
</ul>
<p>èµ„æºéš”ç¦»ä¸»è¦æ˜¯å¯¹è°ƒç”¨æœåŠ¡çš„çº¿ç¨‹æ± è¿›è¡Œéš”ç¦».</p>
<p>æˆ‘ä»¬æ ¹æ®å…·ä½“ä¸šåŠ¡,å°†ä¾èµ–æœåŠ¡åˆ†ä¸º: å¼ºä¾èµ–å’Œè‹¥ä¾èµ–. å¼ºä¾èµ–æœåŠ¡ä¸å¯ç”¨ä¼šå¯¼è‡´å½“å‰ä¸šåŠ¡ä¸­æ­¢,è€Œå¼±ä¾èµ–æœåŠ¡çš„ä¸å¯ç”¨ä¸ä¼šå¯¼è‡´å½“å‰ä¸šåŠ¡çš„ä¸­æ­¢.</p>
<p>ä¸å¯ç”¨æœåŠ¡çš„è°ƒç”¨å¿«é€Ÿå¤±è´¥ä¸€èˆ¬é€šè¿‡<strong>è¶…æ—¶æœºåˆ¶</strong>, <strong>ç†”æ–­å™¨</strong>å’Œç†”æ–­åçš„<strong>é™çº§æ–¹æ³•</strong>æ¥å®ç°.</p>
<h1 id="ä½¿ç”¨Hystrixé¢„é˜²æœåŠ¡é›ªå´©"><a href="#ä½¿ç”¨Hystrixé¢„é˜²æœåŠ¡é›ªå´©" class="headerlink" title="ä½¿ç”¨Hystrixé¢„é˜²æœåŠ¡é›ªå´©"></a>ä½¿ç”¨Hystrixé¢„é˜²æœåŠ¡é›ªå´©</h1><h2 id="ç†”æ–­å™¨æ¨¡å¼"><a href="#ç†”æ–­å™¨æ¨¡å¼" class="headerlink" title="ç†”æ–­å™¨æ¨¡å¼"></a>ç†”æ–­å™¨æ¨¡å¼</h2><p>ç†”æ–­å™¨æ¨¡å¼å®šä¹‰äº†ç†”æ–­å™¨å¼€å…³ç›¸äº’è½¬æ¢çš„é€»è¾‘:</p>
<p><a href="http://idiotsky.top/images3/CircuitBreaker-3.png"><img src="http://idiotsky.top/images3/CircuitBreaker-3.png" alt=""></a></p>
<p>æœåŠ¡çš„å¥åº·çŠ¶å†µ = è¯·æ±‚å¤±è´¥æ•° / è¯·æ±‚æ€»æ•°.<br>ç†”æ–­å™¨å¼€å…³ç”±å…³é—­åˆ°æ‰“å¼€çš„çŠ¶æ€è½¬æ¢æ˜¯é€šè¿‡å½“å‰æœåŠ¡å¥åº·çŠ¶å†µå’Œè®¾å®šé˜ˆå€¼æ¯”è¾ƒå†³å®šçš„.</p>
<ol>
<li>å½“ç†”æ–­å™¨å¼€å…³å…³é—­æ—¶, è¯·æ±‚è¢«å…è®¸é€šè¿‡ç†”æ–­å™¨. å¦‚æœå½“å‰å¥åº·çŠ¶å†µé«˜äºè®¾å®šé˜ˆå€¼, å¼€å…³ç»§ç»­ä¿æŒå…³é—­. å¦‚æœå½“å‰å¥åº·çŠ¶å†µä½äºè®¾å®šé˜ˆå€¼, å¼€å…³åˆ™åˆ‡æ¢ä¸ºæ‰“å¼€çŠ¶æ€.</li>
<li>å½“ç†”æ–­å™¨å¼€å…³æ‰“å¼€æ—¶, è¯·æ±‚è¢«ç¦æ­¢é€šè¿‡.</li>
<li>å½“ç†”æ–­å™¨å¼€å…³å¤„äºæ‰“å¼€çŠ¶æ€, ç»è¿‡ä¸€æ®µæ—¶é—´å, ç†”æ–­å™¨ä¼šè‡ªåŠ¨è¿›å…¥åŠå¼€çŠ¶æ€, è¿™æ—¶ç†”æ–­å™¨åªå…è®¸ä¸€ä¸ªè¯·æ±‚é€šè¿‡. å½“è¯¥è¯·æ±‚è°ƒç”¨æˆåŠŸæ—¶, ç†”æ–­å™¨æ¢å¤åˆ°å…³é—­çŠ¶æ€. è‹¥è¯¥è¯·æ±‚å¤±è´¥, ç†”æ–­å™¨ç»§ç»­ä¿æŒæ‰“å¼€çŠ¶æ€, æ¥ä¸‹æ¥çš„è¯·æ±‚è¢«ç¦æ­¢é€šè¿‡.</li>
</ol>
<p>ç†”æ–­å™¨çš„å¼€å…³èƒ½ä¿è¯æœåŠ¡è°ƒç”¨è€…åœ¨è°ƒç”¨å¼‚å¸¸æœåŠ¡æ—¶, å¿«é€Ÿè¿”å›ç»“æœ, é¿å…å¤§é‡çš„åŒæ­¥ç­‰å¾…. å¹¶ä¸”ç†”æ–­å™¨èƒ½åœ¨ä¸€æ®µæ—¶é—´åç»§ç»­ä¾¦æµ‹è¯·æ±‚æ‰§è¡Œç»“æœ, æä¾›æ¢å¤æœåŠ¡è°ƒç”¨çš„å¯èƒ½.</p>
<blockquote>
<p>to be continueâ€¦</p>
</blockquote>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://segmentfault.com/a/1190000005988895" target="_blank" rel="noopener">https://segmentfault.com/a/1190000005988895</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç»å¸¸ä¼šå‡ºç°æŸä¸ªåŸºç¡€æœåŠ¡ä¸å¯ç”¨é€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨çš„æƒ…å†µ, è¿™ç§ç°è±¡è¢«ç§°ä¸ºæœåŠ¡é›ªå´©æ•ˆåº”. ä¸ºäº†åº”å¯¹æœåŠ¡é›ªå´©, ä¸€ç§å¸¸è§çš„åšæ³•æ˜¯æ‰‹åŠ¨æœåŠ¡é™çº§. è€ŒHystrixçš„å‡ºç°,ç»™æˆ‘ä»¬æä¾›äº†å¦ä¸€ç§é€‰æ‹©.&lt;/p&gt;
&lt;h1 id=&quot;æœåŠ¡é›ªå´©æ•ˆåº”çš„å®šä¹‰&quot;&gt;&lt;a href=&quot;#æœåŠ¡é›ªå´©æ•ˆåº”çš„å®šä¹‰&quot; class=&quot;headerlink&quot; title=&quot;æœåŠ¡é›ªå´©æ•ˆåº”çš„å®šä¹‰&quot;&gt;&lt;/a&gt;æœåŠ¡é›ªå´©æ•ˆåº”çš„å®šä¹‰&lt;/h1&gt;&lt;p&gt;æœåŠ¡é›ªå´©æ•ˆåº”æ˜¯ä¸€ç§å›  æœåŠ¡æä¾›è€… çš„ä¸å¯ç”¨å¯¼è‡´ æœåŠ¡è°ƒç”¨è€… çš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨ é€æ¸æ”¾å¤§ çš„è¿‡ç¨‹.å¦‚æœæ‰€ç¤º:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://idiotsky.top/images3/CircuitBreaker-1.png&quot;&gt;&lt;img src=&quot;http://idiotsky.top/images3/CircuitBreaker-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾ä¸­, Aä¸ºæœåŠ¡æä¾›è€…, Bä¸ºAçš„æœåŠ¡è°ƒç”¨è€…, Cå’ŒDæ˜¯Bçš„æœåŠ¡è°ƒç”¨è€…. å½“Açš„ä¸å¯ç”¨,å¼•èµ·Bçš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨é€æ¸æ”¾å¤§Cå’ŒDæ—¶, æœåŠ¡é›ªå´©å°±å½¢æˆäº†.&lt;/p&gt;
    
    </summary>
    
      <category term="é«˜å¯ç”¨" scheme="http://idiotsky.top/categories/%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
    
      <category term="ç†”æ–­å™¨" scheme="http://idiotsky.top/tags/%E7%86%94%E6%96%AD%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>dockeræ€»ç»“</title>
    <link href="http://idiotsky.top/2018/10/24/docker-summary/"/>
    <id>http://idiotsky.top/2018/10/24/docker-summary/</id>
    <published>2018-10-24T14:50:22.000Z</published>
    <updated>2018-11-10T04:34:41.277Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ä¸æƒ³åˆ†å‡ ç« äº†ï¼Œæ‰€ä»¥å¾ˆé•¿å¾ˆé•¿ğŸ‘¿</p>
</blockquote>
<h1 id="docker-å®¹å™¨çš„çŠ¶æ€æœº"><a href="#docker-å®¹å™¨çš„çŠ¶æ€æœº" class="headerlink" title="docker å®¹å™¨çš„çŠ¶æ€æœº"></a>docker å®¹å™¨çš„çŠ¶æ€æœº</h1><p><a href="http://idiotsky.top/images3/docker-summary-1.jpg"><img src="http://idiotsky.top/images3/docker-summary-1.jpg" alt=""></a></p>
<p>ä¸€ä¸ªå®¹å™¨åœ¨æŸä¸ªæ—¶åˆ»å¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p>
<ul>
<li>createdï¼šå·²ç»è¢«åˆ›å»º ï¼ˆä½¿ç”¨ docker ps -a å‘½ä»¤å¯ä»¥åˆ—å‡ºï¼‰ä½†æ˜¯è¿˜æ²¡æœ‰è¢«å¯åŠ¨ ï¼ˆä½¿ç”¨ docker ps å‘½ä»¤è¿˜æ— æ³•åˆ—å‡ºï¼‰</li>
<li>runningï¼šè¿è¡Œä¸­</li>
<li>pausedï¼šå®¹å™¨çš„è¿›ç¨‹è¢«æš‚åœäº†</li>
<li>restartingï¼šå®¹å™¨çš„è¿›ç¨‹æ­£åœ¨é‡å¯è¿‡ç¨‹ä¸­</li>
<li>exitedï¼šä¸Šå›¾ä¸­çš„ stopped çŠ¶æ€ï¼Œè¡¨ç¤ºå®¹å™¨ä¹‹å‰è¿è¡Œè¿‡ä½†æ˜¯ç°åœ¨å¤„äºåœæ­¢çŠ¶æ€ï¼ˆè¦åŒºåˆ«äº created çŠ¶æ€ï¼Œå®ƒæ˜¯æŒ‡ä¸€ä¸ªæ–°åˆ›å‡ºçš„å°šæœªè¿è¡Œè¿‡çš„å®¹å™¨ï¼‰ã€‚å¯ä»¥é€šè¿‡ start å‘½ä»¤ä½¿å…¶é‡æ–°è¿›å…¥ running çŠ¶æ€</li>
<li>destroyedï¼šå®¹å™¨è¢«åˆ é™¤äº†ï¼Œå†ä¹Ÿä¸å­˜åœ¨äº†</li>
</ul>
<a id="more"></a>
<h1 id="Docker-å‘½ä»¤æ¦‚è¿°"><a href="#Docker-å‘½ä»¤æ¦‚è¿°" class="headerlink" title="Docker å‘½ä»¤æ¦‚è¿°"></a>Docker å‘½ä»¤æ¦‚è¿°</h1><p>æˆ‘ä»¬å¯ä»¥æŠŠDocker çš„å‘½ä»¤å¤§æ¦‚åœ°åˆ†ç±»å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">é•œåƒæ“ä½œï¼š</span><br><span class="line">    build     Build an image from a Dockerfile</span><br><span class="line">    commit    Create a new image from a container&apos;s changes</span><br><span class="line">    images    List images</span><br><span class="line">    load      Load an image from a tar archive or STDIN</span><br><span class="line">    pull      Pull an image or a repository from a registry</span><br><span class="line">    push      Push an image or a repository to a registry</span><br><span class="line">    rmi       Remove one or more images</span><br><span class="line">    search    Search the Docker Hub for images</span><br><span class="line">    tag       Tag an image into a repository</span><br><span class="line">    save      Save one or more images to a tar archive (streamed to STDOUT by default)</span><br><span class="line">    history   æ˜¾ç¤ºæŸé•œåƒçš„å†å²</span><br><span class="line">    inspect   è·å–é•œåƒçš„è¯¦ç»†ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">    å®¹å™¨åŠå…¶ä¸­åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸæ“ä½œï¼š</span><br><span class="line">    create    Create a new container ï¼ˆåˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼‰        </span><br><span class="line">    kill      Kill one or more running containers</span><br><span class="line">    inspect   Return low-level information on a container, image or task</span><br><span class="line">    pause     Pause all processes within one or more containers</span><br><span class="line">    ps        List containers</span><br><span class="line">    rm        Remove one or more containers ï¼ˆåˆ é™¤ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼‰</span><br><span class="line">    rename    Rename a container</span><br><span class="line">    restart   Restart a container</span><br><span class="line">    run       Run a command in a new container ï¼ˆåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼‰</span><br><span class="line">    start     Start one or more stopped containers ï¼ˆå¯åŠ¨ä¸€ä¸ªå¤„äºåœæ­¢çŠ¶æ€çš„å®¹å™¨ï¼‰</span><br><span class="line">    stats     Display a live stream of container(s) resource usage statistics ï¼ˆæ˜¾ç¤ºå®¹å™¨å®æ—¶çš„èµ„æºæ¶ˆè€—ä¿¡æ¯ï¼‰</span><br><span class="line">    stop      Stop one or more running containers ï¼ˆåœæ­¢ä¸€ä¸ªå¤„äºè¿è¡ŒçŠ¶æ€çš„å®¹å™¨ï¼‰</span><br><span class="line">    top       Display the running processes of a container</span><br><span class="line">    unpause   Unpause all processes within one or more containers</span><br><span class="line">    update    Update configuration of one or more containers</span><br><span class="line">    wait      Block until a container stops, then print its exit code</span><br><span class="line">    attach    Attach to a running container</span><br><span class="line">    exec      Run a command in a running container</span><br><span class="line">    port      List port mappings or a specific mapping for the container</span><br><span class="line">    logs      è·å–å®¹å™¨çš„æ—¥å¿—    </span><br><span class="line">    </span><br><span class="line">    å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼š</span><br><span class="line">    cp        Copy files/folders between a container and the local filesystem</span><br><span class="line">    diff      Inspect changes on a container&apos;s filesystem</span><br><span class="line">    export    Export a container&apos;s filesystem as a tar archive</span><br><span class="line">    import    Import the contents from a tarball to create a filesystem image</span><br><span class="line">    </span><br><span class="line">    Docker registry æ“ä½œï¼š</span><br><span class="line">    login     Log in to a Docker registry.</span><br><span class="line">    logout    Log out from a Docker registry.</span><br><span class="line">    </span><br><span class="line">    Volume æ“ä½œ</span><br><span class="line">    volume    Manage Docker volumes</span><br><span class="line">    </span><br><span class="line">    ç½‘ç»œæ“ä½œ</span><br><span class="line">    network   Manage Docker networks</span><br><span class="line">    </span><br><span class="line">    Swarm ç›¸å…³æ“ä½œ</span><br><span class="line">    swarm     Manage Docker Swarm</span><br><span class="line">    service   Manage Docker services</span><br><span class="line">    node      Manage Docker Swarm nodes       </span><br><span class="line">    </span><br><span class="line">    ç³»ç»Ÿæ“ä½œï¼š    </span><br><span class="line">    version   Show the Docker version information</span><br><span class="line">    events    Get real time events from the server  (æŒç»­è¿”å›docker äº‹ä»¶)</span><br><span class="line">    info      Display system-wide information ï¼ˆæ˜¾ç¤ºDocker ä¸»æœºç³»ç»ŸèŒƒå›´å†…çš„ä¿¡æ¯ï¼‰</span><br></pre></td></tr></table></figure>
<h1 id="Doker-å¹³å°çš„åŸºæœ¬æ„æˆ"><a href="#Doker-å¹³å°çš„åŸºæœ¬æ„æˆ" class="headerlink" title="Doker å¹³å°çš„åŸºæœ¬æ„æˆ"></a>Doker å¹³å°çš„åŸºæœ¬æ„æˆ</h1><p><a href="http://idiotsky.top/images3/docker-summary-2.jpg"><img src="http://idiotsky.top/images3/docker-summary-2.jpg" alt=""></a></p>
<p>Docker å¹³å°åŸºæœ¬ä¸Šç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯ï¼šç”¨æˆ·ä½¿ç”¨ Docker æä¾›çš„å·¥å…·ï¼ˆCLI ä»¥åŠ API ç­‰ï¼‰æ¥æ„å»ºï¼Œä¸Šä¼ é•œåƒå¹¶å‘å¸ƒå‘½ä»¤æ¥åˆ›å»ºå’Œå¯åŠ¨å®¹å™¨</li>
<li>Docker ä¸»æœºï¼šä» Docker registry ä¸Šä¸‹è½½é•œåƒå¹¶å¯åŠ¨å®¹å™¨</li>
<li>Docker registryï¼šDocker é•œåƒä»“åº“ï¼Œç”¨äºä¿å­˜é•œåƒï¼Œå¹¶æä¾›é•œåƒä¸Šä¼ å’Œä¸‹è½½</li>
</ul>
<h1 id="Host-OS-VS-Guest-OS-VS-Base-image"><a href="#Host-OS-VS-Guest-OS-VS-Base-image" class="headerlink" title="Host OS VS Guest OS VS Base image"></a>Host OS VS Guest OS VS Base image</h1><p>æ¯”å¦‚ï¼Œä¸€å°ä¸»æœºå®‰è£…çš„æ˜¯ Centos æ“ä½œç³»ç»Ÿï¼Œç°åœ¨åœ¨ä¸Šé¢è·‘ä¸€ä¸ª Ubuntu å®¹å™¨ã€‚æ­¤æ—¶ï¼ŒHost OS æ˜¯ Centosï¼ŒGuest OS æ˜¯ Ubuntuã€‚Guest OS ä¹Ÿè¢«æˆä¸ºå®¹å™¨çš„ Base Imageã€‚</p>
<p><a href="http://idiotsky.top/images3/docker-summary-9.png"><img src="http://idiotsky.top/images3/docker-summary-9.png" alt=""></a></p>
<p>ä¸€äº›è¯´æ˜ï¼š</p>
<ul>
<li>å…³äº linux å†…æ ¸å’Œç‰ˆæœ¬ï¼šæ‰€æœ‰ Linux å‘è¡Œç‰ˆéƒ½é‡‡ç”¨ç›¸åŒçš„ Linux å†…æ ¸ï¼ˆkernelï¼‰ï¼Œç„¶åæ‰€æœ‰å‘è¡Œç‰ˆå¯¹å†…æ ¸éƒ½æœ‰è½»å¾®æ”¹åŠ¨ã€‚è¿™äº›æ”¹åŠ¨éƒ½ä¼šä¸Šä¼ å› linux ç¤¾åŒºï¼Œå¹¶è¢«åˆå¹¶ã€‚</li>
<li>å…³äºLinux å®¹å™¨ç¯å¢ƒï¼šå› ä¸ºæ‰€æœ‰Linuxå‘è¡Œç‰ˆéƒ½åŒ…å«åŒä¸€ä¸ªlinux å†…æ ¸ï¼ˆæœ‰è½»å¾®ä¿®æ”¹ï¼‰ï¼Œä»¥åŠä¸åŒçš„è‡ªå·±çš„è½¯ä»¶ï¼Œå› æ­¤ï¼Œä¼šå¾ˆå®¹æ˜“åœ°å°†æŸä¸ª userland è½¯ä»¶å®‰è£…åœ¨linux å†…æ ¸ä¸Šï¼Œæ¥æ¨¡æ‹Ÿä¸åŒçš„å‘è¡Œç‰ˆç¯å¢ƒã€‚æ¯”å¦‚è¯´ï¼Œåœ¨ Ubuntu ä¸Šè¿è¡Œ Centos å®¹å™¨ï¼Œè¿™æ„å‘³ç€ä» Centos è·å– userland è½¯ä»¶ï¼Œè¿è¡Œåœ¨ Ubuntu å†…æ ¸ä¸Šã€‚å› æ­¤ï¼Œè¿™å°±åƒåœ¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼ˆlinux å†…æ ¸ï¼‰ä¸Šè¿è¡Œä¸åŒçš„ userland è½¯ä»¶ï¼ˆå‘è¡Œç‰ˆçš„ï¼‰ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆDocker ä¸æ”¯æŒåœ¨ Linux ä¸»æœºä¸Šè¿è¡Œ FreeBSD æˆ–è€…windows å®¹å™¨ã€‚</li>
</ul>
<p>å¯è§ï¼Œå®¹å™¨çš„ base image å¹¶ä¸çœŸçš„æ˜¯ base OSã€‚Base image ä¼šè¿œè¿œæ¯” base OS æ›´è½»é‡ã€‚å®ƒåªå®‰è£…å‘è¡Œç‰ˆç‰¹æ®Šçš„éƒ¨åˆ†ï¼ˆuserland è½¯ä»¶ï¼‰ã€‚</p>
<p><a href="http://idiotsky.top/images3/docker-summary-10.png"><img src="http://idiotsky.top/images3/docker-summary-10.png" alt=""></a></p>
<p>é‚£ä¸ºä»€ä¹ˆè¿˜éœ€è¦ base image å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œdocker å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸ host OS æ˜¯éš”ç¦»çš„ã€‚å®¹å™¨é•œåƒä¸­çš„åº”ç”¨è½¯ä»¶æ— æ³•çœ‹åˆ°ä¸»æœºæ–‡ä»¶ç³»ç»Ÿï¼Œé™¤éå°†ä¸»æœºæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¸ºå®¹å™¨çš„å·ã€‚å› æ­¤ï¼Œå¯ä»¥æƒ³åƒä¸€ä¸‹ï¼Œä½ å®¹å™¨ä¸­çš„åº”ç”¨ä¾èµ–äºå„ç§æ“ä½œç³»ç»Ÿåº“ï¼Œå› æ­¤æˆ‘ä»¬ä¸å¾—ä¸å°†è¿™äº›åº“æ‰“åŒ…åˆ°é•œåƒä¹‹ä¸­ã€‚å¦å¤–ï¼Œbase image ä¼šè®©æˆ‘ä»¬ä½¿ç”¨åˆ°å„ä¸ªå‘è¡Œç‰ˆçš„åŒ…ç®¡ç†ç³»ç»Ÿï¼Œæ¯”å¦‚ yum å’Œ apt-getã€‚è€Œä¸”ï¼Œå„ä¸ªlinux å‘è¡Œç‰ˆçš„ base image ä¹Ÿä¸æ˜¯æ™®é€šçš„å‘è¡Œç‰ˆï¼Œè€Œæ˜¯ä¸€ä¸ªç®€åŒ–äº†çš„ç‰ˆæœ¬ã€‚è€Œä¸”ï¼Œbase image å¹¶ä¸å¸¦æœ‰ linux å†…æ ¸ï¼Œå› ä¸ºå®¹å™¨ä¼šä½¿ç”¨ä¸»æœºçš„å†…æ ¸ã€‚</p>
<p>å› æ­¤ï¼Œéœ€è¦æ³¨é‡ç†è§£ image å’Œ OS è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚ä¹‹æ‰€ä»¥æˆä¸º base imageï¼Œè€Œä¸æ˜¯ base OSï¼Œæ˜¯å› ä¸º base image ä¸­å¹¶ä¸åŒ…æ‹¬å®Œæ•´çš„ OSã€‚è€Œè¿™ä¸€ç‚¹ï¼Œæ˜¯å®¹å™¨ä¸è™šæ‹Ÿæœºä¹‹å‰çš„æœ¬è´¨åŒºåˆ«ä¹‹ä¸€ã€‚é‚£å°±æ˜¯ï¼Œå®¹å™¨å¹¶æ²¡æœ‰è™šæ‹ŸåŒ–ï¼Œè€Œæ˜¯å…±äº«ä¸»æœºä¸Šçš„linux å†…æ ¸ã€‚</p>
<h1 id="Docker-é•œåƒåˆ†å±‚-COW-å’Œ-é•œåƒå¤§å°ï¼ˆsizeï¼‰"><a href="#Docker-é•œåƒåˆ†å±‚-COW-å’Œ-é•œåƒå¤§å°ï¼ˆsizeï¼‰" class="headerlink" title="Docker é•œåƒåˆ†å±‚,COW å’Œ é•œåƒå¤§å°ï¼ˆsizeï¼‰"></a>Docker é•œåƒåˆ†å±‚,COW å’Œ é•œåƒå¤§å°ï¼ˆsizeï¼‰</h1><h2 id="é•œåƒåˆ†å±‚å’Œå®¹å™¨å±‚"><a href="#é•œåƒåˆ†å±‚å’Œå®¹å™¨å±‚" class="headerlink" title="é•œåƒåˆ†å±‚å’Œå®¹å™¨å±‚"></a>é•œåƒåˆ†å±‚å’Œå®¹å™¨å±‚</h2><p>ä¸€ä¸ª Docker é•œåƒæ˜¯åŸºäºåŸºç¡€é•œåƒçš„å¤šå±‚å åŠ ï¼Œæœ€ç»ˆæ„æˆå’Œå®¹å™¨çš„ rootfs ï¼ˆæ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚å½“ Docker åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå®ƒä¼šåœ¨åŸºç¡€é•œåƒçš„å®¹å™¨å±‚ä¹‹ä¸Šæ·»åŠ ä¸€å±‚æ–°çš„è–„è–„çš„å¯å†™å®¹å™¨å±‚ã€‚æ¥ä¸‹æ¥ï¼Œæ‰€æœ‰å¯¹å®¹å™¨çš„å˜åŒ–ï¼Œæ¯”å¦‚å†™æ–°çš„æ–‡ä»¶ï¼Œä¿®æ”¹å·²æœ‰æ–‡ä»¶å’Œåˆ é™¤æ–‡ä»¶ï¼Œéƒ½åªä¼šä½œç”¨åœ¨è¿™ä¸ªå®¹å™¨å±‚ä¹‹ä¸­ã€‚å› æ­¤ï¼Œé€šè¿‡ä¸æ‹·è´å®Œæ•´çš„ rootfsï¼ŒDocker å‡å°‘äº†å®¹å™¨æ‰€å ç”¨çš„ç©ºé—´ï¼Œä»¥åŠå‡å°‘äº†å®¹å™¨å¯åŠ¨æ‰€éœ€æ—¶é—´ã€‚</p>
<p><a href="http://idiotsky.top/images3/docker-summary-3.jpg"><img src="http://idiotsky.top/images3/docker-summary-3.jpg" alt=""></a></p>
<h2 id="COW-å’Œé•œåƒå¤§å°"><a href="#COW-å’Œé•œåƒå¤§å°" class="headerlink" title="COW å’Œé•œåƒå¤§å°"></a>COW å’Œé•œåƒå¤§å°</h2><p>COWï¼Œcopy-on-write æŠ€æœ¯ï¼Œä¸€æ–¹é¢å¸¦æ¥äº†å®¹å™¨å¯åŠ¨çš„å¿«æ·ï¼Œå¦ä¸€æ–¹ä¹Ÿé€ æˆäº†å®¹å™¨é•œåƒå¤§å°çš„å¢åŠ ã€‚æ¯ä¸€æ¬¡ RUN å‘½ä»¤éƒ½ä¼šåœ¨é•œåƒä¸Šå¢åŠ ä¸€å±‚ï¼Œæ¯ä¸€å±‚éƒ½ä¼šå ç”¨ç£ç›˜ç©ºé—´ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ Ubuntu 14.04 åŸºç¡€é•œåƒä¸­è¿è¡Œ RUN apt-get upgrade ä¼šåœ¨ä¿ç•™åŸºç¡€å±‚çš„åŒæ—¶å†åˆ›å»ºä¸€ä¸ªæ–°å±‚æ¥æ”¾æ‰€æœ‰æ–°çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¿®æ”¹è€çš„æ–‡ä»¶ï¼Œå› æ­¤ï¼Œæ–°çš„é•œåƒå¤§å°ä¼šè¶…è¿‡ç›´æ¥åœ¨è€çš„æ–‡ä»¶ç³»ç»Ÿä¸Šåšæ›´æ–°æ—¶çš„æ–‡ä»¶å¤§å°ã€‚å› æ­¤ï¼Œä¸ºäº†å‡å°‘é•œåƒå¤§å°èµ·è§ï¼Œæ‰€æœ‰æ–‡ä»¶ç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚åˆ é™¤ï¼Œé‡Šæ”¾å’Œç§»åŠ¨ç­‰ï¼Œéƒ½éœ€è¦å°½å¯èƒ½åœ°æ”¾åœ¨ä¸€ä¸ª RUN æŒ‡ä»¤ä¸­è¿›è¡Œã€‚</p>
<h2 id="ä½¿ç”¨å®¹å™¨éœ€è¦é¿å…çš„ä¸€äº›åšæ³•"><a href="#ä½¿ç”¨å®¹å™¨éœ€è¦é¿å…çš„ä¸€äº›åšæ³•" class="headerlink" title="ä½¿ç”¨å®¹å™¨éœ€è¦é¿å…çš„ä¸€äº›åšæ³•"></a>ä½¿ç”¨å®¹å™¨éœ€è¦é¿å…çš„ä¸€äº›åšæ³•</h2><p>è¿™ç¯‡æ–‡ç«  <a href="http://developers.redhat.com/blog/2016/02/24/10-things-to-avoid-in-docker-containers/" target="_blank" rel="noopener">10 things to avoid in docker containers</a> åˆ—ä¸¾äº†ä¸€äº›åœ¨ä½¿ç”¨å®¹å™¨æ—¶éœ€è¦é¿å…çš„åšæ³•ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>ä¸è¦åœ¨å®¹å™¨ä¸­ä¿å­˜æ•°æ®ï¼ˆDonâ€™t store data in containersï¼‰</li>
<li>å°†åº”ç”¨æ‰“åŒ…åˆ°é•œåƒå†éƒ¨ç½²è€Œä¸æ˜¯æ›´æ–°åˆ°å·²æœ‰å®¹å™¨ï¼ˆDonâ€™t ship your application in two piecesï¼‰</li>
<li>ä¸è¦äº§ç”Ÿè¿‡å¤§çš„é•œåƒ ï¼ˆDonâ€™t create large imagesï¼‰</li>
<li>ä¸è¦ä½¿ç”¨å•å±‚é•œåƒ ï¼ˆDonâ€™t use a single layer imageï¼‰</li>
<li>ä¸è¦ä»è¿è¡Œç€çš„å®¹å™¨ä¸Šäº§ç”Ÿé•œåƒ ï¼ˆDonâ€™t create images from running containers ï¼‰</li>
<li>ä¸è¦åªæ˜¯ä½¿ç”¨ â€œlatestâ€æ ‡ç­¾ ï¼ˆDonâ€™t use only the â€œlatestâ€ tagï¼‰</li>
<li>ä¸è¦åœ¨å®¹å™¨å†…è¿è¡Œè¶…è¿‡ä¸€ä¸ªçš„è¿›ç¨‹ ï¼ˆDonâ€™t run more than one process in a single container ï¼‰</li>
<li>ä¸è¦åœ¨å®¹å™¨å†…ä¿å­˜ credentialsï¼Œè€Œæ˜¯è¦ä»å¤–é¢é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ ï¼ˆ Donâ€™t store credentials in the image. Use environment variablesï¼‰</li>
<li>ä¸è¦ä½¿ç”¨ root ç”¨æˆ·è·‘å®¹å™¨è¿›ç¨‹ï¼ˆDonâ€™t run processes as a root user ï¼‰</li>
<li>ä¸è¦ä¾èµ–äºIPåœ°å€ï¼Œè€Œæ˜¯è¦ä»å¤–é¢é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ ï¼ˆDonâ€™t rely on IP addresses ï¼‰</li>
</ul>
<h1 id="Linux-namespace-çš„æ¦‚å¿µ"><a href="#Linux-namespace-çš„æ¦‚å¿µ" class="headerlink" title="Linux namespace çš„æ¦‚å¿µ"></a>Linux namespace çš„æ¦‚å¿µ</h1><p>Linux å†…æ ¸ä»ç‰ˆæœ¬ 2.4.19 å¼€å§‹é™†ç»­å¼•å…¥äº† namespace çš„æ¦‚å¿µã€‚å…¶ç›®çš„æ˜¯å°†æŸä¸ªç‰¹å®šçš„å…¨å±€ç³»ç»Ÿèµ„æºï¼ˆglobal system resourceï¼‰é€šè¿‡æŠ½è±¡æ–¹æ³•ä½¿å¾—namespace ä¸­çš„è¿›ç¨‹çœ‹èµ·æ¥æ‹¥æœ‰å®ƒä»¬è‡ªå·±çš„éš”ç¦»çš„å…¨å±€ç³»ç»Ÿèµ„æºå®ä¾‹ï¼ˆThe purpose of each namespace is to wrap a particular global system resource in an abstraction that makes it appear to the processes within the namespace that they have their own isolated instance of the global resource. ï¼‰ã€‚Linux å†…æ ¸ä¸­å®ç°äº†å…­ç§ namespaceï¼ŒæŒ‰ç…§å¼•å…¥çš„å…ˆåé¡ºåºï¼Œåˆ—è¡¨å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>namespace</th>
<th>å¼•å…¥çš„ç›¸å…³å†…æ ¸ç‰ˆæœ¬</th>
<th>è¢«éš”ç¦»çš„å…¨å±€ç³»ç»Ÿèµ„æº</th>
<th>åœ¨å®¹å™¨è¯­å¢ƒä¸‹çš„éš”ç¦»æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mount namespaces</td>
<td>Linux 2.4.19</td>
<td>æ–‡ä»¶ç³»ç»ŸæŒ‚æ¥ç‚¹</td>
<td>æ¯ä¸ªå®¹å™¨èƒ½çœ‹åˆ°ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„</td>
</tr>
<tr>
<td>ÂšUTS namespaces</td>
<td>Linux 2.6.19</td>
<td>nodename å’Œ domainname</td>
<td>æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰è‡ªå·±çš„ hostname å’Œ domainame</td>
</tr>
<tr>
<td>IPC namespaces</td>
<td>Linux 2.6.19</td>
<td>ç‰¹å®šçš„è¿›ç¨‹é—´é€šä¿¡èµ„æºï¼ŒåŒ…æ‹¬System V IPC å’Œ  POSIX message queues</td>
<td>æ¯ä¸ªå®¹å™¨æœ‰å…¶è‡ªå·±çš„ System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ª IPC namespace çš„è¿›ç¨‹ä¹‹é—´æ‰èƒ½äº’ç›¸é€šä¿¡</td>
</tr>
<tr>
<td>PID namespaces</td>
<td>Linux 2.6.24</td>
<td>è¿›ç¨‹ ID æ•°å­—ç©ºé—´ ï¼ˆprocess ID number spaceï¼‰</td>
<td>æ¯ä¸ª PID namespace ä¸­çš„è¿›ç¨‹å¯ä»¥æœ‰å…¶ç‹¬ç«‹çš„ PIDï¼› æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰å…¶ PID ä¸º 1 çš„root è¿›ç¨‹ï¼›ä¹Ÿä½¿å¾—å®¹å™¨å¯ä»¥åœ¨ä¸åŒçš„ host ä¹‹é—´è¿ç§»ï¼Œå› ä¸º namespace ä¸­çš„è¿›ç¨‹ ID å’Œ host æ— å…³äº†ã€‚è¿™ä¹Ÿä½¿å¾—å®¹å™¨ä¸­çš„æ¯ä¸ªè¿›ç¨‹æœ‰ä¸¤ä¸ªPIDï¼šå®¹å™¨ä¸­çš„ PID å’Œ host ä¸Šçš„ PIDã€‚</td>
</tr>
<tr>
<td>Network namespaces</td>
<td>å§‹äºLinux 2.6.24 å®Œæˆäº Linux 2.6.29</td>
<td>ç½‘ç»œç›¸å…³çš„ç³»ç»Ÿèµ„æº</td>
<td>æ¯ä¸ªå®¹å™¨ç”¨æœ‰å…¶ç‹¬ç«‹çš„ç½‘ç»œè®¾å¤‡ï¼ŒIP åœ°å€ï¼ŒIP è·¯ç”±è¡¨ï¼Œ/proc/net ç›®å½•ï¼Œç«¯å£å·ç­‰ç­‰ã€‚è¿™ä¹Ÿä½¿å¾—ä¸€ä¸ª host ä¸Šå¤šä¸ªå®¹å™¨å†…çš„åŒä¸€ä¸ªåº”ç”¨éƒ½ç»‘å®šåˆ°å„è‡ªå®¹å™¨çš„ 80 ç«¯å£ä¸Šã€‚</td>
</tr>
<tr>
<td>User namespaces</td>
<td>å§‹äº Linux 2.6.23 å®Œæˆäº Linux 3.8)</td>
<td>ç”¨æˆ·å’Œç»„ ID ç©ºé—´</td>
<td>åœ¨ user namespace ä¸­çš„è¿›ç¨‹çš„ç”¨æˆ·å’Œç»„ ID å¯ä»¥å’Œåœ¨ host ä¸Šä¸åŒï¼› æ¯ä¸ª container å¯ä»¥æœ‰ä¸åŒçš„ user å’Œ group idï¼›ä¸€ä¸ª host ä¸Šçš„éç‰¹æƒç”¨æˆ·å¯ä»¥æˆä¸º user namespace ä¸­çš„ç‰¹æƒç”¨æˆ·ï¼›</td>
</tr>
</tbody>
</table>
<p>Linux namespace çš„æ¦‚å¿µè¯´ç®€å•ä¹Ÿç®€å•è¯´å¤æ‚ä¹Ÿå¤æ‚ã€‚ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“ï¼Œå¤„äºæŸä¸ª namespace ä¸­çš„è¿›ç¨‹ï¼Œèƒ½çœ‹åˆ°ç‹¬ç«‹çš„å®ƒè‡ªå·±çš„éš”ç¦»çš„æŸäº›ç‰¹å®šç³»ç»Ÿèµ„æºï¼›å¤æ‚æ¥è¯´ï¼Œå¯ä»¥å»çœ‹çœ‹ Linux å†…æ ¸ä¸­å®ç° namespace çš„åŸç†ï¼Œç½‘ç»œä¸Šä¹Ÿæœ‰å¤§é‡çš„æ–‡æ¡£ä¾›å‚è€ƒï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h1 id="Docker-å®¹å™¨ä½¿ç”¨-linux-namespace-åšè¿è¡Œç¯å¢ƒéš”ç¦»"><a href="#Docker-å®¹å™¨ä½¿ç”¨-linux-namespace-åšè¿è¡Œç¯å¢ƒéš”ç¦»" class="headerlink" title="Docker å®¹å™¨ä½¿ç”¨ linux namespace åšè¿è¡Œç¯å¢ƒéš”ç¦»"></a>Docker å®¹å™¨ä½¿ç”¨ linux namespace åšè¿è¡Œç¯å¢ƒéš”ç¦»</h1><p>å½“ Docker åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå®ƒä¼šåˆ›å»ºæ–°çš„ä»¥ä¸Šå…­ç§ namespace çš„å®ä¾‹ï¼Œç„¶åæŠŠå®¹å™¨ä¸­çš„æ‰€æœ‰è¿›ç¨‹æ”¾åˆ°è¿™äº› namespace ä¹‹ä¸­ï¼Œä½¿å¾—Docker å®¹å™¨ä¸­çš„è¿›ç¨‹åªèƒ½çœ‹åˆ°éš”ç¦»çš„ç³»ç»Ÿèµ„æºã€‚ </p>
<h2 id="Mount-Namespace"><a href="#Mount-Namespace" class="headerlink" title="Mount Namespace"></a>Mount Namespace</h2><p>Mount namespaceç”¨æ¥éš”ç¦»æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹, ä½¿å¾—ä¸åŒçš„mount namespaceæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„æŒ‚è½½ç‚¹ä¿¡æ¯ï¼Œä¸åŒçš„namespaceä¹‹é—´ä¸ä¼šç›¸äº’å½±å“ï¼Œè¿™å¯¹äºæ„å»ºç”¨æˆ·æˆ–è€…å®¹å™¨è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•éå¸¸æœ‰ç”¨ã€‚</p>
<p>å½“å‰è¿›ç¨‹æ‰€åœ¨mount namespaceé‡Œçš„æ‰€æœ‰æŒ‚è½½ä¿¡æ¯å¯ä»¥åœ¨/proc/[pid]/mountsã€/proc/[pid]/mountinfoå’Œ/proc/[pid]/mountstatsé‡Œé¢æ‰¾åˆ°ã€‚</p>
<p>Mount namespacesæ˜¯ç¬¬ä¸€ä¸ªè¢«åŠ å…¥Linuxçš„namespaceï¼Œç”±äºå½“æ—¶æ²¡æƒ³åˆ°è¿˜ä¼šå¼•å…¥å…¶å®ƒçš„namespaceï¼Œæ‰€ä»¥å–åä¸ºCLONE_NEWNSï¼Œè€Œæ²¡æœ‰å«CLONE_NEWMOUNTã€‚</p>
<p>æ¯ä¸ªmount namespaceéƒ½æ‹¥æœ‰ä¸€ä»½è‡ªå·±çš„æŒ‚è½½ç‚¹åˆ—è¡¨ï¼Œå½“ç”¨cloneæˆ–è€…unshareå‡½æ•°åˆ›å»ºæ–°çš„mount namespaceæ—¶ï¼Œæ–°åˆ›å»ºçš„namespaceå°†æ‹·è´ä¸€ä»½è€namespaceé‡Œçš„æŒ‚è½½ç‚¹åˆ—è¡¨ï¼Œä½†ä»è¿™ä¹‹åï¼Œä»–ä»¬å°±æ²¡æœ‰å…³ç³»äº†ï¼Œé€šè¿‡mountå’Œumountå¢åŠ å’Œåˆ é™¤å„è‡ªnamespaceé‡Œé¢çš„æŒ‚è½½ç‚¹éƒ½ä¸ä¼šç›¸äº’å½±å“ã€‚</p>
<h2 id="PID-namespace"><a href="#PID-namespace" class="headerlink" title="PID namespace"></a>PID namespace</h2><p>æˆ‘ä»¬èƒ½çœ‹åˆ°åŒä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨å®¹å™¨å†…å¤–çš„ PID æ˜¯ä¸åŒçš„ï¼š</p>
<ul>
<li>åœ¨å®¹å™¨å†… PID æ˜¯ 1ï¼ŒPPID æ˜¯ 0ã€‚</li>
<li>åœ¨å®¹å™¨å¤– PID æ˜¯ 2198ï¼Œ PPID æ˜¯ 2179 å³ docker-containerd-shim è¿›ç¨‹.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# ps -ef | grep python</span><br><span class="line">root 2198 2179 0 00:06 ? 00:00:00 python app.py</span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# ps -ef | grep 2179</span><br><span class="line">root 2179 765 0 00:06 ? 00:00:00 docker-containerd-shim 8b7dd09fbcae00373207f01e2acde45740871c9e3b98286b5458b4ea09f41b3e /var/run/docker/libcontainerd/8b7dd09fbcae00373207f01e2acde45740871c9e3b98286b5458b4ea09f41b3e docker-runc</span><br><span class="line">root 2198 2179 0 00:06 ? 00:00:00 python app.py</span><br><span class="line">root 2249 1692 0 00:06 pts/0 00:00:00 grep --color=auto 2179</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# docker exec -it web31 ps -ef</span><br><span class="line">UID PID PPID C STIME TTY TIME CMD</span><br><span class="line">root 1 0 0 16:06 ? 00:00:00 python app.py</span><br></pre></td></tr></table></figure>
<p>å…³äº containerdï¼Œcontainerd-shim å’Œ container çš„å…³ç³»ï¼Œ<a href="https://github.com/crosbymichael/dockercon-2016/blob/master/Creating%20Containerd.pdf" target="_blank" rel="noopener">æ–‡ç« </a> ä¸­çš„ä¸‹å›¾å¯ä»¥è¯´æ˜ï¼š</p>
<p><a href="http://idiotsky.top/images3/docker-summary-3.jpg"><img src="http://idiotsky.top/images3/docker-summary-3.jpg" alt=""></a></p>
<ul>
<li>Docker å¼•æ“ç®¡ç†ç€é•œåƒï¼Œç„¶åç§»äº¤ç»™ containerd è¿è¡Œï¼Œcontainerd å†ä½¿ç”¨ runC è¿è¡Œå®¹å™¨ã€‚</li>
<li>Containerd æ˜¯ä¸€ä¸ªç®€å•çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ runC ç®¡ç†å®¹å™¨ï¼Œä½¿ç”¨ gRPC æš´éœ²å®¹å™¨çš„å…¶ä»–åŠŸèƒ½ã€‚å®ƒç®¡ç†å®¹å™¨çš„å¼€å§‹ï¼Œåœæ­¢ï¼Œæš‚åœå’Œé”€æ¯ã€‚ç”±äºå®¹å™¨è¿è¡Œæ—¶æ˜¯å­¤ç«‹çš„å¼•æ“ï¼Œå¼•æ“æœ€ç»ˆèƒ½å¤Ÿå¯åŠ¨å’Œå‡çº§è€Œæ— éœ€é‡æ–°å¯åŠ¨å®¹å™¨ã€‚</li>
<li>runCæ˜¯ä¸€ä¸ªè½»é‡çº§çš„å·¥å…·ï¼Œå®ƒæ˜¯ç”¨æ¥è¿è¡Œå®¹å™¨çš„ï¼Œåªç”¨æ¥åšè¿™ä¸€ä»¶äº‹ï¼Œå¹¶ä¸”è¿™ä¸€ä»¶äº‹è¦åšå¥½ã€‚runCåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªå°å‘½ä»¤è¡Œå·¥å…·ä¸”å®ƒå¯ä»¥ä¸ç”¨é€šè¿‡Dockerå¼•æ“ï¼Œç›´æ¥å°±å¯ä»¥ä½¿ç”¨å®¹å™¨ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œå®¹å™¨ä¸­çš„ä¸»åº”ç”¨åœ¨ host ä¸Šçš„çˆ¶è¿›ç¨‹æ˜¯ containerd-shimï¼Œæ˜¯å®ƒé€šè¿‡å·¥å…· runC æ¥å¯åŠ¨è¿™äº›è¿›ç¨‹çš„ã€‚</p>
<p>è¿™ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œpid namespace é€šè¿‡å°† host ä¸Š PID æ˜ å°„ä¸ºå®¹å™¨å†…çš„ PIDï¼Œ ä½¿å¾—å®¹å™¨å†…çš„è¿›ç¨‹çœ‹èµ·æ¥æœ‰ä¸ªç‹¬ç«‹çš„ PID ç©ºé—´ã€‚</p>
<h2 id="UTS-namespace"><a href="#UTS-namespace" class="headerlink" title="UTS namespace"></a>UTS namespace</h2><p>ç±»ä¼¼åœ°ï¼Œå®¹å™¨å¯ä»¥æœ‰è‡ªå·±çš„ hostname å’Œ domainnameï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# hostname</span><br><span class="line">devstack</span><br><span class="line">root@devstack:/home/sammy# docker exec -it web31 hostname</span><br><span class="line">8b7dd09fbcae</span><br></pre></td></tr></table></figure>
<h2 id="IPC-Namespace"><a href="#IPC-Namespace" class="headerlink" title="IPC Namespace"></a>IPC Namespace</h2><p>IPCå…¨ç§° Inter-Process Communicationï¼Œæ˜¯Unix/Linuxä¸‹è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼ï¼ŒIPCæœ‰å…±äº«å†…å­˜ã€ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œä¸ºäº†éš”ç¦»ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æŠŠIPCç»™éš”ç¦»å¼€æ¥ï¼Œè¿™æ ·ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªNamespaceä¸‹çš„è¿›ç¨‹æ‰èƒ½ç›¸äº’é€šä¿¡ã€‚å¦‚æœä½ ç†Ÿæ‚‰IPCçš„åŸç†çš„è¯ï¼Œä½ ä¼šçŸ¥é“ï¼ŒIPCéœ€è¦æœ‰ä¸€ä¸ªå…¨å±€çš„IDï¼Œå³ç„¶æ˜¯å…¨å±€çš„ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æˆ‘ä»¬çš„Namespaceéœ€è¦å¯¹è¿™ä¸ªIDéš”ç¦»ï¼Œä¸èƒ½è®©åˆ«çš„Namespaceçš„è¿›ç¨‹çœ‹åˆ°ã€‚</p>
<h2 id="user-namespace"><a href="#user-namespace" class="headerlink" title="user namespace"></a>user namespace</h2><p>åœ¨ Docker 1.10 ç‰ˆæœ¬ä¹‹å‰ï¼ŒDocker æ˜¯ä¸æ”¯æŒ user namespaceã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤åœ°ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹çš„è¿è¡Œç”¨æˆ·å°±æ˜¯ host ä¸Šçš„ root ç”¨æˆ·ï¼Œè¿™æ ·çš„è¯ï¼Œå½“ host ä¸Šçš„æ–‡ä»¶æˆ–è€…ç›®å½•ä½œä¸º volume è¢«æ˜ å°„åˆ°å®¹å™¨ä»¥åï¼Œå®¹å™¨å†…çš„è¿›ç¨‹å…¶å®æ˜¯æœ‰ root çš„å‡ ä¹æ‰€æœ‰æƒé™å»ä¿®æ”¹è¿™äº› host ä¸Šçš„ç›®å½•çš„ï¼Œè¿™ä¼šæœ‰å¾ˆå¤§çš„å®‰å…¨é—®é¢˜ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<ul>
<li>å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼š docker run -d -v /bin:/host/bin â€“name web34 training/webapp python app.py</li>
<li>æ­¤æ—¶è¿›ç¨‹çš„ç”¨æˆ·åœ¨å®¹å™¨å†…å’Œå¤–éƒ½æ˜¯rootï¼Œå®ƒåœ¨å®¹å™¨å†…å¯ä»¥å¯¹ host ä¸Šçš„ /bin ç›®å½•åšä»»æ„ä¿®æ”¹</li>
</ul>
<p>è€Œ Docker 1.10 ä¸­å¼•å…¥çš„ user namespace å°±å¯ä»¥è®©å®¹å™¨æœ‰ä¸€ä¸ª â€œå‡â€çš„  root ç”¨æˆ·ï¼Œå®ƒåœ¨å®¹å™¨å†…æ˜¯ rootï¼Œåœ¨å®¹å™¨å¤–æ˜¯ä¸€ä¸ªé root ç”¨æˆ·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œuser namespace å®ç°äº† host users å’Œ container users ä¹‹é—´çš„æ˜ å°„ã€‚</p>
<p>å¯ç”¨æ­¥éª¤ï¼š</p>
<ol>
<li>ä¿®æ”¹ /etc/default/docker æ–‡ä»¶ï¼Œæ·»åŠ è¡Œ  DOCKER_OPTS=â€â€“userns-remap=defaultâ€</li>
<li>é‡å¯ docker æœåŠ¡ï¼Œæ­¤æ—¶ dockerd è¿›ç¨‹ä¸º /usr/bin/dockerd â€“userns-remap=default â€“raw-logs</li>
<li>ç„¶ååˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼šdocker run -d -v /bin:/host/bin â€“name web35 training/webapp python app.py</li>
<li>æŸ¥çœ‹è¿›ç¨‹åœ¨å®¹å™¨å†…å¤–çš„ç”¨æˆ·ï¼š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# ps -ef | grep python</span><br><span class="line">231072    1726  1686  0 01:44 ?        00:00:00 python app.py</span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# docker exec web35 ps -ef</span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">root         1     0  0 17:44 ?        00:00:00 python app.py</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æ–‡ä»¶/etc/subuid å’Œ /etc/subgidï¼Œå¯ä»¥çœ‹åˆ° dockermap ç”¨æˆ·åœ¨host ä¸Šçš„ uid å’Œ gid éƒ½æ˜¯ 231072ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# cat /etc/subuid</span><br><span class="line">sammy:100000:65536</span><br><span class="line">stack:165536:65536</span><br><span class="line">dockremap:231072:65536</span><br><span class="line">root@devstack:/home/sammy# cat /etc/subgid</span><br><span class="line">sammy:100000:65536</span><br><span class="line">stack:165536:65536</span><br><span class="line">dockremap:231072:65536</span><br></pre></td></tr></table></figure>
<p>å†çœ‹æ–‡ä»¶/proc/1726/uid_mapï¼Œå®ƒè¡¨ç¤ºäº†å®¹å™¨å†…å¤–ç”¨æˆ·çš„æ˜ å°„å…³ç³»ï¼Œå³å°†host ä¸Šçš„ 231072 ç”¨æˆ·æ˜ å°„ä¸ºå®¹å™¨å†…çš„ 0 ï¼ˆå³rootï¼‰ç”¨æˆ·ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# cat /proc/1726/uid_map</span><br><span class="line">         0     231072      65536</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬è¯•å›¾åœ¨å®¹å™¨å†…ä¿®æ”¹ host ä¸Šçš„ /bin æ–‡ä»¶å¤¹ï¼Œå°±ä¼šæç¤ºæƒé™ä¸è¶³äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@80993d821f7b:/host/bin# touch test2</span><br><span class="line">touch: cannot touch &apos;test2&apos;: Permission denied</span><br></pre></td></tr></table></figure>
<p>è¿™è¯´æ˜é€šè¿‡ä½¿ç”¨ user namespaceï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ°é™åˆ¶äº†å®¹å™¨å†…è¿›ç¨‹çš„æƒé™ã€‚</p>
<h2 id="network-namespace"><a href="#network-namespace" class="headerlink" title="network namespace"></a>network namespace</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ docker å®ä¾‹è¢«åˆ›å»ºå‡ºæ¥åï¼Œä½¿ç”¨ ip netns  å‘½ä»¤æ— æ³•çœ‹åˆ°å®¹å™¨å®ä¾‹å¯¹åº”çš„ network namespaceã€‚è¿™æ˜¯å› ä¸º ip netns å‘½ä»¤æ˜¯ä» /var/run/netns æ–‡ä»¶å¤¹ä¸­è¯»å–å†…å®¹çš„ã€‚</p>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li><p>æ‰¾åˆ°å®¹å™¨çš„ä¸»è¿›ç¨‹ ID</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# docker inspect --format &apos;&#123;&#123;.State.Pid&#125;&#125;&apos; web5</span><br><span class="line">2704</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º  /var/run/netns ç›®å½•ä»¥åŠç¬¦å·è¿æ¥</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# mkdir /var/run/netns</span><br><span class="line">root@devstack:/home/sammy# ln -s /proc/2704/ns/net /var/run/netns/web5</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ­¤æ—¶å¯ä»¥ä½¿ç”¨ ip netns å‘½ä»¤äº†</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# ip netns</span><br><span class="line">web5</span><br><span class="line">root@devstack:/home/sammy# ip netns exec web5 ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default</span><br><span class="line">link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">inet 127.0.0.1/8 scope host lo</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">inet6 ::1/128 scope host</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">15: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet 172.17.0.3/16 scope global eth0</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">inet6 fe80::42:acff:fe11:3/64 scope link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="Linux-control-groups"><a href="#Linux-control-groups" class="headerlink" title="Linux control groups"></a>Linux control groups</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>Linux Cgroup å¯â€‹â€‹â€‹è®©â€‹â€‹â€‹æ‚¨â€‹â€‹â€‹ä¸ºâ€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä¸­â€‹â€‹â€‹æ‰€â€‹â€‹â€‹è¿â€‹â€‹â€‹è¡Œâ€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹ï¼ˆè¿›â€‹â€‹â€‹ç¨‹â€‹â€‹â€‹ï¼‰çš„â€‹â€‹â€‹ç”¨â€‹â€‹â€‹æˆ·â€‹â€‹â€‹å®šâ€‹â€‹â€‹ä¹‰â€‹â€‹â€‹ç»„â€‹â€‹â€‹ç¾¤â€‹â€‹â€‹åˆ†â€‹â€‹â€‹é…â€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹ â€” æ¯”â€‹â€‹â€‹å¦‚â€‹â€‹â€‹ CPU æ—¶â€‹â€‹â€‹é—´â€‹â€‹â€‹ã€â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹å†…â€‹â€‹â€‹å­˜â€‹â€‹â€‹ã€â€‹â€‹â€‹ç½‘â€‹â€‹â€‹ç»œâ€‹â€‹â€‹å¸¦â€‹â€‹â€‹å®½â€‹â€‹â€‹æˆ–â€‹â€‹â€‹è€…â€‹â€‹â€‹è¿™â€‹â€‹â€‹äº›â€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹çš„â€‹â€‹â€‹ç»„â€‹â€‹â€‹åˆâ€‹â€‹â€‹ã€‚â€‹â€‹â€‹æ‚¨â€‹â€‹â€‹å¯â€‹â€‹â€‹ä»¥â€‹â€‹â€‹ç›‘â€‹â€‹â€‹æ§â€‹â€‹â€‹æ‚¨â€‹â€‹â€‹é…â€‹â€‹â€‹ç½®â€‹â€‹â€‹çš„â€‹â€‹â€‹ cgroupï¼Œæ‹’â€‹â€‹â€‹ç»cgroup è®¿â€‹â€‹â€‹é—®â€‹â€‹â€‹æŸâ€‹â€‹â€‹äº›â€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹ï¼Œç”šâ€‹â€‹â€‹è‡³â€‹â€‹â€‹åœ¨â€‹â€‹â€‹è¿â€‹â€‹â€‹è¡Œâ€‹â€‹â€‹çš„â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä¸­â€‹â€‹â€‹åŠ¨â€‹â€‹â€‹æ€â€‹â€‹â€‹é…â€‹â€‹â€‹ç½®â€‹â€‹â€‹æ‚¨â€‹â€‹â€‹çš„â€‹â€‹â€‹ cgroupã€‚æ‰€ä»¥ï¼Œå¯ä»¥å°† controll groups ç†è§£ä¸º controller ï¼ˆsystem resourceï¼‰ ï¼ˆforï¼‰ ï¼ˆprocessï¼‰groupsï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´å®ƒä»¥ä¸€ç»„è¿›ç¨‹ä¸ºç›®æ ‡è¿›è¡Œç³»ç»Ÿèµ„æºåˆ†é…å’Œæ§åˆ¶ã€‚</p>
<p>å®ƒä¸»è¦æä¾›äº†å¦‚ä¸‹åŠŸèƒ½ï¼š </p>
<ul>
<li>Resource limitation: é™åˆ¶èµ„æºä½¿ç”¨ï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨ä¸Šé™ä»¥åŠæ–‡ä»¶ç³»ç»Ÿçš„ç¼“å­˜é™åˆ¶ã€‚</li>
<li>Prioritization: ä¼˜å…ˆçº§æ§åˆ¶ï¼Œæ¯”å¦‚ï¼šCPUåˆ©ç”¨å’Œç£ç›˜IOååã€‚</li>
<li>Accounting: ä¸€äº›å®¡è®¡æˆ–ä¸€äº›ç»Ÿè®¡ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è®¡è´¹ã€‚</li>
<li>Control: æŒ‚èµ·è¿›ç¨‹ï¼Œæ¢å¤æ‰§è¡Œè¿›ç¨‹ã€‚</li>
</ul>
<p>ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹ cgroupï¼Œç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ç®¡â€‹â€‹â€‹ç†â€‹â€‹â€‹å‘˜â€‹â€‹â€‹å¯â€‹â€‹â€‹æ›´â€‹â€‹â€‹å…·â€‹â€‹â€‹ä½“â€‹â€‹â€‹åœ°â€‹â€‹â€‹æ§â€‹â€‹â€‹åˆ¶â€‹â€‹â€‹å¯¹â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹çš„â€‹â€‹â€‹åˆ†â€‹â€‹â€‹é…â€‹â€‹â€‹ã€â€‹â€‹â€‹ä¼˜â€‹â€‹â€‹å…ˆâ€‹â€‹â€‹é¡ºâ€‹â€‹â€‹åºâ€‹â€‹â€‹ã€â€‹â€‹â€‹æ‹’â€‹â€‹â€‹ç»â€‹â€‹â€‹ã€â€‹â€‹â€‹ç®¡â€‹â€‹â€‹ç†â€‹â€‹â€‹å’Œâ€‹â€‹â€‹ç›‘â€‹â€‹â€‹æ§â€‹â€‹â€‹ã€‚â€‹â€‹â€‹å¯â€‹â€‹â€‹æ›´â€‹â€‹â€‹å¥½â€‹â€‹â€‹åœ°â€‹â€‹â€‹æ ¹â€‹â€‹â€‹æ®â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹å’Œâ€‹â€‹â€‹ç”¨â€‹â€‹â€‹æˆ·â€‹â€‹â€‹åˆ†â€‹â€‹â€‹é…â€‹â€‹â€‹ç¡¬â€‹â€‹â€‹ä»¶â€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹ï¼Œæâ€‹â€‹â€‹é«˜â€‹â€‹â€‹æ€»â€‹â€‹â€‹ä½“â€‹â€‹â€‹æ•ˆâ€‹â€‹â€‹ç‡â€‹â€‹â€‹ã€‚</p>
<p>åœ¨å®è·µä¸­ï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¸€èˆ¬ä¼šåˆ©ç”¨CGroupåšä¸‹é¢è¿™äº›äº‹ï¼ˆæœ‰ç‚¹åƒä¸ºæŸä¸ªè™šæ‹Ÿæœºåˆ†é…èµ„æºä¼¼çš„ï¼‰ï¼š</p>
<ul>
<li>éš”ç¦»ä¸€ä¸ªè¿›ç¨‹é›†åˆï¼ˆæ¯”å¦‚ï¼šnginxçš„æ‰€æœ‰è¿›ç¨‹ï¼‰ï¼Œå¹¶é™åˆ¶ä»–ä»¬æ‰€æ¶ˆè´¹çš„èµ„æºï¼Œæ¯”å¦‚ç»‘å®šCPUçš„æ ¸ã€‚</li>
<li>ä¸ºè¿™ç»„è¿›ç¨‹åˆ†é…å…¶è¶³å¤Ÿä½¿ç”¨çš„å†…å­˜</li>
<li>ä¸ºè¿™ç»„è¿›ç¨‹åˆ†é…ç›¸åº”çš„ç½‘ç»œå¸¦å®½å’Œç£ç›˜å­˜å‚¨é™åˆ¶</li>
<li>é™åˆ¶è®¿é—®æŸäº›è®¾å¤‡ï¼ˆé€šè¿‡è®¾ç½®è®¾å¤‡çš„ç™½åå•ï¼‰</li>
</ul>
<p>Linux ç³»ç»Ÿä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ã€‚Linux ä¹Ÿå°† cgroups å®ç°æˆäº†æ–‡ä»¶ç³»ç»Ÿï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# mount -t cgroup</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,relatime,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu type cgroup (rw,relatime,cpu)</span><br><span class="line">systemd on /sys/fs/cgroup/systemd type cgroup (rw,noexec,nosuid,nodev,none,name=systemd)</span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# lssubsys -m</span><br><span class="line">cpuset /sys/fs/cgroup/cpuset</span><br><span class="line">cpu /sys/fs/cgroup/cpu</span><br><span class="line">cpuacct /sys/fs/cgroup/cpuacct</span><br><span class="line">memory /sys/fs/cgroup/memory</span><br><span class="line">devices /sys/fs/cgroup/devices</span><br><span class="line">freezer /sys/fs/cgroup/freezer</span><br><span class="line">blkio /sys/fs/cgroup/blkio</span><br><span class="line">perf_event /sys/fs/cgroup/perf_event</span><br><span class="line">hugetlb /sys/fs/cgroup/hugetlb</span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# ls /sys/fs/cgroup/ -l</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 blkio</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 cpu</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 cpuacct</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 cpuset</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 devices</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 freezer</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 hugetlb</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 memory</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 perf_event</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 systemd</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ° /sys/fs/cgroup ç›®å½•ä¸­æœ‰è‹¥å¹²ä¸ªå­ç›®å½•ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™äº›éƒ½æ˜¯å— cgroups æ§åˆ¶çš„èµ„æºä»¥åŠè¿™äº›èµ„æºçš„ä¿¡æ¯ã€‚</p>
<ul>
<li>blkio â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä¸ºâ€‹â€‹â€‹å—â€‹â€‹â€‹è®¾â€‹â€‹â€‹å¤‡â€‹â€‹â€‹è®¾â€‹â€‹â€‹å®šâ€‹â€‹â€‹è¾“â€‹â€‹â€‹å…¥â€‹â€‹â€‹/è¾“â€‹â€‹â€‹å‡ºâ€‹â€‹â€‹é™â€‹â€‹â€‹åˆ¶â€‹â€‹â€‹ï¼Œæ¯”â€‹â€‹â€‹å¦‚â€‹â€‹â€‹ç‰©â€‹â€‹â€‹ç†â€‹â€‹â€‹è®¾â€‹â€‹â€‹å¤‡â€‹â€‹â€‹ï¼ˆç£â€‹â€‹â€‹ç›˜â€‹â€‹â€‹ï¼Œå›ºâ€‹â€‹â€‹æ€â€‹â€‹â€‹ç¡¬â€‹â€‹â€‹ç›˜â€‹â€‹â€‹ï¼ŒUSB ç­‰â€‹â€‹â€‹ç­‰â€‹â€‹â€‹ï¼‰ã€‚</li>
<li>cpu â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹è°ƒâ€‹â€‹â€‹åº¦â€‹â€‹â€‹ç¨‹â€‹â€‹â€‹åºâ€‹â€‹â€‹æâ€‹â€‹â€‹ä¾›â€‹â€‹â€‹å¯¹â€‹â€‹â€‹ CPU çš„â€‹â€‹â€‹ cgroup ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹è®¿â€‹â€‹â€‹é—®â€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>cpuacct â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹è‡ªâ€‹â€‹â€‹åŠ¨â€‹â€‹â€‹ç”Ÿâ€‹â€‹â€‹æˆâ€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹æ‰€â€‹â€‹â€‹ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹çš„â€‹â€‹â€‹ CPU æŠ¥â€‹â€‹â€‹å‘Šâ€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>cpuset â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä¸ºâ€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹çš„â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹åˆ†â€‹â€‹â€‹é…â€‹â€‹â€‹ç‹¬â€‹â€‹â€‹ç«‹â€‹â€‹â€‹ CPUï¼ˆåœ¨â€‹â€‹â€‹å¤šâ€‹â€‹â€‹æ ¸â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ï¼‰å’Œâ€‹â€‹â€‹å†…â€‹â€‹â€‹å­˜â€‹â€‹â€‹èŠ‚â€‹â€‹â€‹ç‚¹ã€‚</li>
<li>devices â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹å¯â€‹â€‹â€‹å…â€‹â€‹â€‹è®¸â€‹â€‹â€‹æˆ–â€‹â€‹â€‹è€…â€‹â€‹â€‹æ‹’â€‹â€‹â€‹ç»â€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹çš„â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹è®¿â€‹â€‹â€‹é—®â€‹â€‹â€‹è®¾â€‹â€‹â€‹å¤‡â€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>freezer â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹æŒ‚â€‹â€‹â€‹èµ·â€‹â€‹â€‹æˆ–â€‹â€‹â€‹è€…â€‹â€‹â€‹æ¢â€‹â€‹â€‹å¤â€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹çš„â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>memory â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹è®¾â€‹â€‹â€‹å®šâ€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹çš„â€‹â€‹â€‹å†…â€‹â€‹â€‹å­˜â€‹â€‹â€‹é™â€‹â€‹â€‹åˆ¶â€‹â€‹â€‹ï¼Œå¹¶â€‹â€‹â€‹è‡ªâ€‹â€‹â€‹åŠ¨â€‹â€‹â€‹ç”Ÿâ€‹â€‹â€‹æˆâ€‹â€‹â€‹â€‹â€‹å†…â€‹â€‹â€‹å­˜â€‹â€‹â€‹èµ„â€‹æºä½¿ç”¨â€‹â€‹â€‹æŠ¥â€‹â€‹â€‹å‘Šâ€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>net_cls â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹ç­‰â€‹â€‹â€‹çº§â€‹â€‹â€‹è¯†â€‹â€‹â€‹åˆ«â€‹â€‹â€‹ç¬¦â€‹â€‹â€‹ï¼ˆclassidï¼‰æ ‡â€‹â€‹â€‹è®°â€‹â€‹â€‹ç½‘â€‹â€‹â€‹ç»œâ€‹â€‹â€‹æ•°â€‹â€‹â€‹æ®â€‹â€‹â€‹åŒ…â€‹â€‹â€‹ï¼Œå¯â€‹â€‹â€‹å…â€‹â€‹â€‹è®¸â€‹â€‹â€‹ Linux æµé‡â€‹â€‹â€‹æ§â€‹â€‹â€‹åˆ¶â€‹â€‹â€‹ç¨‹â€‹â€‹â€‹åºâ€‹â€‹â€‹ï¼ˆtcï¼‰è¯†â€‹â€‹â€‹åˆ«â€‹â€‹â€‹ä»â€‹â€‹â€‹å…·â€‹â€‹â€‹ä½“â€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹ç”Ÿâ€‹â€‹â€‹æˆâ€‹â€‹â€‹çš„â€‹â€‹â€‹æ•°â€‹â€‹â€‹æ®â€‹â€‹â€‹åŒ…â€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>net_prio â€” è¿™ä¸ªå­ç³»ç»Ÿç”¨æ¥è®¾è®¡ç½‘ç»œæµé‡çš„ä¼˜å…ˆçº§</li>
<li>hugetlb â€” è¿™ä¸ªå­ç³»ç»Ÿä¸»è¦é’ˆå¯¹äºHugeTLBç³»ç»Ÿè¿›è¡Œé™åˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤§é¡µæ–‡ä»¶ç³»ç»Ÿã€‚</li>
</ul>
<p>é»˜è®¤çš„è¯ï¼Œåœ¨ Ubuntu ç³»ç»Ÿä¸­ï¼Œä½ å¯èƒ½çœ‹ä¸åˆ° net_cls å’Œ net_prio ç›®å½•ï¼Œå®ƒä»¬éœ€è¦ä½ æ‰‹å·¥åš mountï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup# modprobe cls_cgroup</span><br><span class="line">root@devstack:/sys/fs/cgroup# mkdir net_cls</span><br><span class="line">root@devstack:/sys/fs/cgroup# mount -t cgroup -o net_cls none net_cls</span><br><span class="line"></span><br><span class="line">root@devstack:/sys/fs/cgroup# modprobe netprio_cgroup</span><br><span class="line">root@devstack:/sys/fs/cgroup# mkdir net_prio</span><br><span class="line">root@devstack:/sys/fs/cgroup# mount -t cgroup -o net_prio none net_prio</span><br><span class="line"></span><br><span class="line">root@devstack:/sys/fs/cgroup# ls net_prio/cgroup.clone_children  cgroup.procs          net_prio.ifpriomap  notify_on_release  tasks</span><br><span class="line">cgroup.event_control   cgroup.sane_behavior  net_prio.prioidx    release_agent</span><br><span class="line">root@devstack:/sys/fs/cgroup# ls net_cls/</span><br><span class="line">cgroup.clone_children  cgroup.event_control  cgroup.procs  cgroup.sane_behavior  net_cls.classid  notify_on_release  release_agent  tasks</span><br></pre></td></tr></table></figure>
<h2 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h2><h3 id="é€šè¿‡-cgroups-é™åˆ¶è¿›ç¨‹çš„-CPU"><a href="#é€šè¿‡-cgroups-é™åˆ¶è¿›ç¨‹çš„-CPU" class="headerlink" title="é€šè¿‡ cgroups é™åˆ¶è¿›ç¨‹çš„ CPU"></a>é€šè¿‡ cgroups é™åˆ¶è¿›ç¨‹çš„ CPU</h3><p>å†™ä¸€æ®µæœ€ç®€å•çš„ C ç¨‹åºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;) i++;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘ï¼Œè¿è¡Œï¼Œå‘ç°å®ƒå ç”¨çš„ CPU å‡ ä¹åˆ°äº† 100%ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">2204 root      20   0    4188    356    276 R 99.6  0.0   0:46.03 hello</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åšå¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy/c# mkdir /sys/fs/cgroup/cpu/hello</span><br><span class="line">root@devstack:/home/sammy/c# cd /sys/fs/cgroup/cpu/hello</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# ls</span><br><span class="line">cgroup.clone_children  cgroup.procs       cpu.cfs_quota_us  cpu.stat           tasks</span><br><span class="line">cgroup.event_control   cpu.cfs_period_us  cpu.shares        notify_on_release</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# cat cpu.cfs_quota_us</span><br><span class="line">-1</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# echo 20000 &gt; cpu.cfs_quota_us</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# cat cpu.cfs_quota_us</span><br><span class="line">20000</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# echo 2428 &gt; tasks</span><br></pre></td></tr></table></figure>
<p>ç„¶åå†æ¥çœ‹çœ‹è¿™ä¸ªè¿›ç¨‹çš„ CPU å ç”¨æƒ…å†µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">2428 root      20   0    4188    356    276 R 19.9  0.0   0:46.03 hello</span><br></pre></td></tr></table></figure>
<p>å®ƒå ç”¨çš„ CPU å‡ ä¹å°±æ˜¯ 20%ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é¢„è®¾çš„é˜ˆå€¼ã€‚è¿™è¯´æ˜æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ï¼ŒæˆåŠŸåœ°å°†è¿™ä¸ªè¿›ç¨‹è¿è¡Œæ‰€å ç”¨çš„ CPU èµ„æºé™åˆ¶åœ¨æŸä¸ªé˜ˆå€¼ä¹‹å†…äº†ã€‚</p>
<p>å¦‚æœæ­¤æ—¶å†å¯åŠ¨å¦ä¸€ä¸ª hello è¿›ç¨‹å¹¶å°†å…¶ id åŠ å…¥ tasks æ–‡ä»¶ï¼Œåˆ™ä¸¤ä¸ªè¿›ç¨‹ä¼šå…±äº«è®¾å®šçš„ CPU é™åˆ¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 2428 root      20   0    4188    356    276 R 10.0  0.0 285:39.54 hello</span><br><span class="line">12526 root      20   0    4188    356    276 R 10.0  0.0   0:25.09 hello</span><br></pre></td></tr></table></figure>
<h3 id="é€šè¿‡-cgroups-é™åˆ¶è¿›ç¨‹çš„-Memory"><a href="#é€šè¿‡-cgroups-é™åˆ¶è¿›ç¨‹çš„-Memory" class="headerlink" title="é€šè¿‡ cgroups é™åˆ¶è¿›ç¨‹çš„ Memory"></a>é€šè¿‡ cgroups é™åˆ¶è¿›ç¨‹çš„ Memory</h3><p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬é’ˆå¯¹å®ƒå ç”¨çš„å†…å­˜åšå¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup/memory# mkdir hello</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory# cd hello/</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory/hello# cat memory.limit_in_bytes</span><br><span class="line">18446744073709551615</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory/hello# echo 64k &gt; memory.limit_in_bytes</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory/hello# echo 2428 &gt; tasks</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory/hello#</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ­¥éª¤ä¼šæŠŠè¿›ç¨‹ 2428 è¯´å ç”¨çš„å†…å­˜é˜ˆå€¼è®¾ç½®ä¸º 64Kã€‚è¶…è¿‡çš„è¯ï¼Œå®ƒä¼šè¢«æ€æ‰ã€‚</p>
<h3 id="é™åˆ¶è¿›ç¨‹çš„-I-O"><a href="#é™åˆ¶è¿›ç¨‹çš„-I-O" class="headerlink" title="é™åˆ¶è¿›ç¨‹çš„ I/O"></a>é™åˆ¶è¿›ç¨‹çš„ I/O</h3><p>è¿è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dd if=/dev/sda1 of=/dev/null</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ iotop å‘½ä»¤çœ‹ IO ï¼ˆæ­¤æ—¶ç£ç›˜åœ¨å¿«é€Ÿè½¬åŠ¨ï¼‰ï¼Œæ­¤æ—¶å…¶å†™é€Ÿåº¦ä¸º 242M/sï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND</span><br><span class="line">2555 be/4 root      242.60 M/s    0.00 B/s  0.00 % 61.66 % dd if=/dev/sda1 of=/dev/null</span><br></pre></td></tr></table></figure>
<p>æ¥ç€åšä¸‹é¢çš„æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# mkdir /sys/fs/cgroup/blkio/io</span><br><span class="line">root@devstack:/home/sammy# cd /sys/fs/cgroup/blkio/io</span><br><span class="line">root@devstack:/sys/fs/cgroup/blkio/io# ls -l /dev/sda1</span><br><span class="line">brw-rw---- 1 root disk 8, 1 Sep 18 21:46 /dev/sda1</span><br><span class="line">root@devstack:/sys/fs/cgroup/blkio/io# echo &apos;8:0 1048576&apos;  &gt; /sys/fs/cgroup/blkio/io/blkio.throttle.read_bps_device</span><br><span class="line">root@devstack:/sys/fs/cgroup/blkio/io# echo 2725 &gt; /sys/fs/cgroup/blkio/io/tasks</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼Œè¿™ä¸ªè¿›ç¨‹çš„IO é€Ÿåº¦å°±è¢«é™åˆ¶åœ¨ 1Mb/s ä¹‹å†…äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND</span><br><span class="line">2555 be/4 root      990.44 K/s    0.00 B/s  0.00 % 96.29 % dd if=/dev/sda1 of=/dev/null</span><br></pre></td></tr></table></figure>
<h2 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><p>cgroups çš„æœ¯è¯­åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä»»åŠ¡ï¼ˆTasksï¼‰ï¼šå°±æ˜¯ç³»ç»Ÿçš„ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
<li>æ§åˆ¶ç»„ï¼ˆControl Groupï¼‰ï¼šä¸€ç»„æŒ‰ç…§æŸç§æ ‡å‡†åˆ’åˆ†çš„è¿›ç¨‹ï¼Œæ¯”å¦‚å®˜æ–¹æ–‡æ¡£ä¸­çš„Professorå’ŒStudentï¼Œæˆ–æ˜¯WWWå’ŒSystemä¹‹ç±»çš„ï¼Œå…¶è¡¨ç¤ºäº†æŸè¿›ç¨‹ç»„ã€‚Cgroupsä¸­çš„èµ„æºæ§åˆ¶éƒ½æ˜¯ä»¥æ§åˆ¶ç»„ä¸ºå•ä½å®ç°ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŠ å…¥åˆ°æŸä¸ªæ§åˆ¶ç»„ã€‚è€Œèµ„æºçš„é™åˆ¶æ˜¯å®šä¹‰åœ¨è¿™ä¸ªç»„ä¸Šï¼Œå°±åƒä¸Šé¢ç¤ºä¾‹ä¸­æˆ‘ç”¨çš„ hello ä¸€æ ·ã€‚ç®€å•ç‚¹è¯´ï¼Œcgroupçš„å‘ˆç°å°±æ˜¯ä¸€ä¸ªç›®å½•å¸¦ä¸€ç³»åˆ—çš„å¯é…ç½®æ–‡ä»¶ã€‚</li>
<li>å±‚çº§ï¼ˆHierarchyï¼‰ï¼šæ§åˆ¶ç»„å¯ä»¥ç»„ç»‡æˆhierarchicalçš„å½¢å¼ï¼Œæ—¢ä¸€é¢—æ§åˆ¶ç»„çš„æ ‘ï¼ˆç›®å½•ç»“æ„ï¼‰ã€‚æ§åˆ¶ç»„æ ‘ä¸Šçš„å­èŠ‚ç‚¹ç»§æ‰¿çˆ¶ç»“ç‚¹çš„å±æ€§ã€‚ç®€å•ç‚¹è¯´ï¼Œhierarchyå°±æ˜¯åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªå­ç³»ç»Ÿä¸Šçš„cgroupsç›®å½•æ ‘ã€‚</li>
<li>å­ç³»ç»Ÿï¼ˆSubsystemï¼‰ï¼šä¸€ä¸ªå­ç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªèµ„æºæ§åˆ¶å™¨ï¼Œæ¯”å¦‚CPUå­ç³»ç»Ÿå°±æ˜¯æ§åˆ¶CPUæ—¶é—´åˆ†é…çš„ä¸€ä¸ªæ§åˆ¶å™¨ã€‚å­ç³»ç»Ÿå¿…é¡»é™„åŠ åˆ°ä¸€ä¸ªå±‚çº§ä¸Šæ‰èƒ½èµ·ä½œç”¨ï¼Œä¸€ä¸ªå­ç³»ç»Ÿé™„åŠ åˆ°æŸä¸ªå±‚çº§ä»¥åï¼Œè¿™ä¸ªå±‚çº§ä¸Šçš„æ‰€æœ‰æ§åˆ¶æ—ç¾¤éƒ½å—åˆ°è¿™ä¸ªå­ç³»ç»Ÿçš„æ§åˆ¶ã€‚Cgroupçš„å­ç³»ç»Ÿå¯ä»¥æœ‰å¾ˆå¤šï¼Œä¹Ÿåœ¨ä¸æ–­å¢åŠ ä¸­ã€‚</li>
</ul>
<h1 id="Docker-å¯¹-cgroups-çš„ä½¿ç”¨"><a href="#Docker-å¯¹-cgroups-çš„ä½¿ç”¨" class="headerlink" title="Docker å¯¹ cgroups çš„ä½¿ç”¨"></a>Docker å¯¹ cgroups çš„ä½¿ç”¨</h1><h2 id="é»˜è®¤æƒ…å†µ"><a href="#é»˜è®¤æƒ…å†µ" class="headerlink" title="é»˜è®¤æƒ…å†µ"></a>é»˜è®¤æƒ…å†µ</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker å¯åŠ¨ä¸€ä¸ªå®¹å™¨åï¼Œä¼šåœ¨ /sys/fs/cgroup ç›®å½•ä¸‹çš„å„ä¸ªèµ„æºç›®å½•ä¸‹ç”Ÿæˆä»¥å®¹å™¨ ID ä¸ºåå­—çš„ç›®å½•ï¼ˆgroupï¼‰ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sys/fs/cgroup/cpu/docker/03dd196f415276375f754d51ce29b418b170bd92d88c5e420d6901c32f93dc14</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ cpu.cfs_quota_us çš„å†…å®¹ä¸º -1ï¼Œè¡¨ç¤ºé»˜è®¤æƒ…å†µä¸‹å¹¶æ²¡æœ‰é™åˆ¶å®¹å™¨çš„ CPU ä½¿ç”¨ã€‚åœ¨å®¹å™¨è¢« stopped åï¼Œè¯¥ç›®å½•è¢«åˆ é™¤ã€‚</p>
<p>è¿è¡Œå‘½ä»¤ docker run -d â€“name web41 â€“cpu-quota 25000 â€“cpu-period 100 â€“cpu-shares 30 training/webapp python app.py å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup/cpu/docker/06bd180cd340f8288c18e8f0e01ade66d066058dd053ef46161eb682ab69ec24# cat cpu.cfs_quota_us</span><br><span class="line">25000</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/docker/06bd180cd340f8288c18e8f0e01ade66d066058dd053ef46161eb682ab69ec24# cat tasks</span><br><span class="line">3704</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/docker/06bd180cd340f8288c18e8f0e01ade66d066058dd053ef46161eb682ab69ec24# cat cpu.cfs_period_us</span><br><span class="line">2000</span><br></pre></td></tr></table></figure>
<p>Docker ä¼šå°†å®¹å™¨ä¸­çš„è¿›ç¨‹çš„ ID åŠ å…¥åˆ°å„ä¸ªèµ„æºå¯¹åº”çš„ tasks æ–‡ä»¶ä¸­ã€‚è¡¨ç¤º Docker ä¹Ÿæ˜¯ä»¥ä¸Šé¢çš„æœºåˆ¶æ¥ä½¿ç”¨ cgroups å¯¹å®¹å™¨çš„ CPU ä½¿ç”¨è¿›è¡Œé™åˆ¶ã€‚</p>
<p>ç›¸ä¼¼åœ°ï¼Œå¯ä»¥é€šè¿‡ docker run ä¸­ mem ç›¸å…³çš„å‚æ•°å¯¹å®¹å™¨çš„å†…å­˜ä½¿ç”¨è¿›è¡Œé™åˆ¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    --cpuset-mems string          MEMs in which to allow execution (0-3, 0,1)</span><br><span class="line">    --kernel-memory string        Kernel memory limit</span><br><span class="line">-m, --memory string               Memory limit</span><br><span class="line">    --memory-reservation string   Memory soft limit</span><br><span class="line">    --memory-swap string          Swap limit equal to memory plus swap: &apos;-1&apos; to enable unlimited swap</span><br><span class="line">    --memory-swappiness int       Tune container memory swappiness (0 to 100) (default -1)</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚  docker run -d â€“name web42 â€“blkio-weight 100 â€“memory 10M â€“cpu-quota 25000 â€“cpu-period 2000 â€“cpu-shares 30 training/webapp python app.pyï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup/memory/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410# cat memory.limit_in_bytes</span><br><span class="line">10485760</span><br><span class="line">  root@devstack:/sys/fs/cgroup/blkio/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410# cat blkio.weight</span><br><span class="line">  100</span><br></pre></td></tr></table></figure>
<p>ç›®å‰ docker å·²ç»å‡ ä¹æ”¯æŒäº†æ‰€æœ‰çš„ cgroups èµ„æºï¼Œå¯ä»¥é™åˆ¶å®¹å™¨å¯¹åŒ…æ‹¬ networkï¼Œdeviceï¼Œcpu å’Œ memory åœ¨å†…çš„èµ„æºçš„ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup# find -iname ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./net_prio/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./net_cls/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./systemd/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./hugetlb/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./perf_event/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./blkio/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./freezer/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./devices/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./memory/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./cpuacct/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./cpu/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./cpuset/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br></pre></td></tr></table></figure>
<h1 id="Docker-run-å‘½ä»¤ä¸­-cgroups-ç›¸å…³å‘½ä»¤"><a href="#Docker-run-å‘½ä»¤ä¸­-cgroups-ç›¸å…³å‘½ä»¤" class="headerlink" title="Docker run å‘½ä»¤ä¸­ cgroups ç›¸å…³å‘½ä»¤"></a>Docker run å‘½ä»¤ä¸­ cgroups ç›¸å…³å‘½ä»¤</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">block IO:</span><br><span class="line">      --blkio-weight value          Block IO (relative weight), between 10 and 1000</span><br><span class="line">      --blkio-weight-device value   Block IO weight (relative device weight) (default [])</span><br><span class="line">      --cgroup-parent string        Optional parent cgroup for the container</span><br><span class="line">CPU:</span><br><span class="line">      --cpu-percent int             CPU percent (Windows only)</span><br><span class="line">      --cpu-period int              Limit CPU CFS (Completely Fair Scheduler) period</span><br><span class="line">      --cpu-quota int               Limit CPU CFS (Completely Fair Scheduler) quota</span><br><span class="line">  -c, --cpu-shares int              CPU shares (relative weight)</span><br><span class="line">      --cpuset-cpus string          CPUs in which to allow execution (0-3, 0,1)</span><br><span class="line">      --cpuset-mems string          MEMs in which to allow execution (0-3, 0,1)</span><br><span class="line">Device:    </span><br><span class="line">      --device value                Add a host device to the container (default [])</span><br><span class="line">      --device-read-bps value       Limit read rate (bytes per second) from a device (default [])</span><br><span class="line">      --device-read-iops value      Limit read rate (IO per second) from a device (default [])</span><br><span class="line">      --device-write-bps value      Limit write rate (bytes per second) to a device (default [])</span><br><span class="line">      --device-write-iops value     Limit write rate (IO per second) to a device (default [])</span><br><span class="line">Memory:      </span><br><span class="line">      --kernel-memory string        Kernel memory limit</span><br><span class="line">  -m, --memory string               Memory limit</span><br><span class="line">      --memory-reservation string   Memory soft limit</span><br><span class="line">      --memory-swap string          Swap limit equal to memory plus swap: &apos;-1&apos; to enable unlimited swap</span><br><span class="line">      --memory-swappiness int       Tune container memory swappiness (0 to 100) (default -1)</span><br></pre></td></tr></table></figure>
<p>ä¸€äº›è¯´æ˜ï¼š</p>
<ol>
<li>cgroup åªèƒ½é™åˆ¶ CPU çš„ä½¿ç”¨ï¼Œè€Œä¸èƒ½ä¿è¯CPUçš„ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ ä½¿ç”¨ cpuset-cpusï¼Œå¯ä»¥è®©å®¹å™¨åœ¨æŒ‡å®šçš„CPUæˆ–è€…æ ¸ä¸Šè¿è¡Œï¼Œä½†æ˜¯ä¸èƒ½ç¡®ä¿å®ƒç‹¬å è¿™äº›CPUï¼›cpu-shares æ˜¯ä¸ªç›¸å¯¹å€¼ï¼Œåªæœ‰åœ¨CPUä¸å¤Ÿç”¨çš„æ—¶å€™æ‰å…¶ä½œç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“CPUå¤Ÿç”¨çš„æ—¶å€™ï¼Œæ¯ä¸ªå®¹å™¨ä¼šåˆ†åˆ°è¶³å¤Ÿçš„CPUï¼›ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§æŒ‡å®šçš„æ¯”é‡åœ¨å¤šä¸ªå®¹å™¨ä¹‹é—´åˆ†é…CPUã€‚</li>
<li>å¯¹å†…å­˜æ¥è¯´ï¼Œcgroups å¯ä»¥é™åˆ¶å®¹å™¨æœ€å¤šä½¿ç”¨çš„å†…å­˜ã€‚ä½¿ç”¨ -m å‚æ•°å¯ä»¥è®¾ç½®æœ€å¤šå¯ä»¥ä½¿ç”¨çš„å†…å­˜ã€‚</li>
</ol>
<h1 id="Docker-ç½‘ç»œæ¦‚å†µ"><a href="#Docker-ç½‘ç»œæ¦‚å†µ" class="headerlink" title="Docker ç½‘ç»œæ¦‚å†µ"></a>Docker ç½‘ç»œæ¦‚å†µ</h1><p>ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜ Docker ç½‘ç»œçš„åŸºæœ¬æ¦‚å†µï¼š</p>
<p><a href="http://idiotsky.top/images3/docker-summary-5.jpg"><img src="http://idiotsky.top/images3/docker-summary-5.jpg" alt=""></a></p>
<h1 id="å››ç§å•èŠ‚ç‚¹ç½‘ç»œæ¨¡å¼"><a href="#å››ç§å•èŠ‚ç‚¹ç½‘ç»œæ¨¡å¼" class="headerlink" title="å››ç§å•èŠ‚ç‚¹ç½‘ç»œæ¨¡å¼"></a>å››ç§å•èŠ‚ç‚¹ç½‘ç»œæ¨¡å¼</h1><h2 id="bridge-æ¨¡å¼"><a href="#bridge-æ¨¡å¼" class="headerlink" title="bridge æ¨¡å¼"></a>bridge æ¨¡å¼</h2><p>Docker å®¹å™¨é»˜è®¤ä½¿ç”¨ bridge æ¨¡å¼çš„ç½‘ç»œã€‚å…¶ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä½¿ç”¨ä¸€ä¸ª linux bridgeï¼Œé»˜è®¤ä¸º docker0</li>
<li>ä½¿ç”¨ veth å¯¹ï¼Œä¸€å¤´åœ¨å®¹å™¨çš„ç½‘ç»œ namespace ä¸­ï¼Œä¸€å¤´åœ¨ docker0 ä¸Š</li>
<li>è¯¥æ¨¡å¼ä¸‹Docker Containerä¸å…·æœ‰ä¸€ä¸ªå…¬æœ‰IPï¼Œå› ä¸ºå®¿ä¸»æœºçš„IPåœ°å€ä¸veth pairçš„ IPåœ°å€ä¸åœ¨åŒä¸€ä¸ªç½‘æ®µå†…</li>
<li>Dockeré‡‡ç”¨ NAT æ–¹å¼ï¼Œå°†å®¹å™¨å†…éƒ¨çš„æœåŠ¡ç›‘å¬çš„ç«¯å£ä¸å®¿ä¸»æœºçš„æŸä¸€ä¸ªç«¯å£port è¿›è¡Œâ€œç»‘å®šâ€ï¼Œä½¿å¾—å®¿ä¸»æœºä»¥å¤–çš„ä¸–ç•Œå¯ä»¥ä¸»åŠ¨å°†ç½‘ç»œæŠ¥æ–‡å‘é€è‡³å®¹å™¨å†…éƒ¨</li>
<li>å¤–ç•Œè®¿é—®å®¹å™¨å†…çš„æœåŠ¡æ—¶ï¼Œéœ€è¦è®¿é—®å®¿ä¸»æœºçš„ IP ä»¥åŠå®¿ä¸»æœºçš„ç«¯å£ port</li>
<li>NAT æ¨¡å¼ç”±äºæ˜¯åœ¨ä¸‰å±‚ç½‘ç»œä¸Šçš„å®ç°æ‰‹æ®µï¼Œæ•…è‚¯å®šä¼šå½±å“ç½‘ç»œçš„ä¼ è¾“æ•ˆç‡ã€‚</li>
<li>å®¹å™¨æ‹¥æœ‰ç‹¬ç«‹ã€éš”ç¦»çš„ç½‘ç»œæ ˆï¼›è®©å®¹å™¨å’Œå®¿ä¸»æœºä»¥å¤–çš„ä¸–ç•Œé€šè¿‡NATå»ºç«‹é€šä¿¡</li>
</ul>
<p>iptables çš„ SNTA è§„åˆ™ï¼Œä½¿å¾—ä»å®¹å™¨ç¦»å¼€å»å¤–ç•Œçš„ç½‘ç»œåŒ…çš„æº IP åœ°å€è¢«è½¬æ¢ä¸º Docker ä¸»æœºçš„IPåœ°å€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">MASQUERADE  all  --  172.17.0.0/16        0.0.0.0/0</span><br><span class="line">MASQUERADE  all  --  172.18.0.0/16        0.0.0.0/0</span><br></pre></td></tr></table></figure>
<p>ç¤ºæ„å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images3/docker-summary-6.jpg"><img src="http://idiotsky.top/images3/docker-summary-6.jpg" alt=""></a></p>
<h2 id="Host-æ¨¡å¼"><a href="#Host-æ¨¡å¼" class="headerlink" title="Host æ¨¡å¼"></a>Host æ¨¡å¼</h2><p>å®šä¹‰ï¼š</p>
<p>Host æ¨¡å¼å¹¶æ²¡æœ‰ä¸ºå®¹å™¨åˆ›å»ºä¸€ä¸ªéš”ç¦»çš„ç½‘ç»œç¯å¢ƒã€‚è€Œä¹‹æ‰€ä»¥ç§°ä¹‹ä¸ºhostæ¨¡å¼ï¼Œæ˜¯å› ä¸ºè¯¥æ¨¡å¼ä¸‹çš„ Docker å®¹å™¨ä¼šå’Œ host å®¿ä¸»æœºå…±äº«åŒä¸€ä¸ªç½‘ç»œ namespaceï¼Œæ•… Docker Containerå¯ä»¥å’Œå®¿ä¸»æœºä¸€æ ·ï¼Œä½¿ç”¨å®¿ä¸»æœºçš„eth0ï¼Œå®ç°å’Œå¤–ç•Œçš„é€šä¿¡ã€‚æ¢è¨€ä¹‹ï¼ŒDocker Containerçš„ IP åœ°å€å³ä¸ºå®¿ä¸»æœº eth0 çš„ IP åœ°å€ã€‚å…¶ç‰¹ç‚¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>è¿™ç§æ¨¡å¼ä¸‹çš„å®¹å™¨æ²¡æœ‰éš”ç¦»çš„ network namespace</li>
<li>å®¹å™¨çš„ IP åœ°å€åŒ Docker host çš„ IP åœ°å€</li>
<li>éœ€è¦æ³¨æ„å®¹å™¨ä¸­æœåŠ¡çš„ç«¯å£å·ä¸èƒ½ä¸ Docker host ä¸Šå·²ç»ä½¿ç”¨çš„ç«¯å£å·ç›¸å†²çª</li>
<li>host æ¨¡å¼èƒ½å¤Ÿå’Œå…¶å®ƒæ¨¡å¼å…±å­˜</li>
</ul>
<p>ç¤ºæ„å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images3/docker-summary-7.jpg"><img src="http://idiotsky.top/images3/docker-summary-7.jpg" alt=""></a></p>
<h2 id="container-æ¨¡å¼"><a href="#container-æ¨¡å¼" class="headerlink" title="container æ¨¡å¼"></a>container æ¨¡å¼</h2><p>å®šä¹‰ï¼š</p>
<p>Container ç½‘ç»œæ¨¡å¼æ˜¯ Docker ä¸­ä¸€ç§è¾ƒä¸ºç‰¹åˆ«çš„ç½‘ç»œçš„æ¨¡å¼ã€‚å¤„äºè¿™ä¸ªæ¨¡å¼ä¸‹çš„ Docker å®¹å™¨ä¼šå…±äº«å…¶ä»–å®¹å™¨çš„ç½‘ç»œç¯å¢ƒï¼Œå› æ­¤ï¼Œè‡³å°‘è¿™ä¸¤ä¸ªå®¹å™¨ä¹‹é—´ä¸å­˜åœ¨ç½‘ç»œéš”ç¦»ï¼Œè€Œè¿™ä¸¤ä¸ªå®¹å™¨åˆä¸å®¿ä¸»æœºä»¥åŠé™¤æ­¤ä¹‹å¤–å…¶ä»–çš„å®¹å™¨å­˜åœ¨ç½‘ç»œéš”ç¦»ã€‚  </p>
<p>ç¤ºæ„å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images3/docker-summary-8.jpg"><img src="http://idiotsky.top/images3/docker-summary-8.jpg" alt=""></a></p>
<h2 id="none-æ¨¡å¼"><a href="#none-æ¨¡å¼" class="headerlink" title="none æ¨¡å¼"></a>none æ¨¡å¼</h2><p>å®šä¹‰ï¼š</p>
<p>ç½‘ç»œæ¨¡å¼ä¸º noneï¼Œå³ä¸ä¸º Docker å®¹å™¨æ„é€ ä»»ä½•ç½‘ç»œç¯å¢ƒã€‚ä¸€æ—¦Docker å®¹å™¨é‡‡ç”¨äº†none ç½‘ç»œæ¨¡å¼ï¼Œé‚£ä¹ˆå®¹å™¨å†…éƒ¨å°±åªèƒ½ä½¿ç”¨loopbackç½‘ç»œè®¾å¤‡ï¼Œä¸ä¼šå†æœ‰å…¶ä»–çš„ç½‘ç»œèµ„æºã€‚Docker Containerçš„noneç½‘ç»œæ¨¡å¼æ„å‘³ç€ä¸ç»™è¯¥å®¹å™¨åˆ›å»ºä»»ä½•ç½‘ç»œç¯å¢ƒï¼Œå®¹å™¨åªèƒ½ä½¿ç”¨127.0.0.1çš„æœ¬æœºç½‘ç»œã€‚</p>
<blockquote>
<p>to be continue â€¦</p>
</blockquote>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.cnblogs.com/sammyliu/p/5875470.html" target="_blank" rel="noopener">http://www.cnblogs.com/sammyliu/p/5875470.html</a></p>
<p><a href="http://www.cnblogs.com/sammyliu/p/5878973.html" target="_blank" rel="noopener">http://www.cnblogs.com/sammyliu/p/5878973.html</a></p>
<p><a href="http://www.cnblogs.com/sammyliu/p/5886833.html" target="_blank" rel="noopener">http://www.cnblogs.com/sammyliu/p/5886833.html</a></p>
<p><a href="https://segmentfault.com/a/1190000006912742" target="_blank" rel="noopener">https://segmentfault.com/a/1190000006912742</a></p>
<p><a href="https://coolshell.cn/articles/17010.html" target="_blank" rel="noopener">https://coolshell.cn/articles/17010.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸æƒ³åˆ†å‡ ç« äº†ï¼Œæ‰€ä»¥å¾ˆé•¿å¾ˆé•¿ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;docker-å®¹å™¨çš„çŠ¶æ€æœº&quot;&gt;&lt;a href=&quot;#docker-å®¹å™¨çš„çŠ¶æ€æœº&quot; class=&quot;headerlink&quot; title=&quot;docker å®¹å™¨çš„çŠ¶æ€æœº&quot;&gt;&lt;/a&gt;docker å®¹å™¨çš„çŠ¶æ€æœº&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;http://idiotsky.top/images3/docker-summary-1.jpg&quot;&gt;&lt;img src=&quot;http://idiotsky.top/images3/docker-summary-1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸€ä¸ªå®¹å™¨åœ¨æŸä¸ªæ—¶åˆ»å¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ä¹‹ä¸€ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;createdï¼šå·²ç»è¢«åˆ›å»º ï¼ˆä½¿ç”¨ docker ps -a å‘½ä»¤å¯ä»¥åˆ—å‡ºï¼‰ä½†æ˜¯è¿˜æ²¡æœ‰è¢«å¯åŠ¨ ï¼ˆä½¿ç”¨ docker ps å‘½ä»¤è¿˜æ— æ³•åˆ—å‡ºï¼‰&lt;/li&gt;
&lt;li&gt;runningï¼šè¿è¡Œä¸­&lt;/li&gt;
&lt;li&gt;pausedï¼šå®¹å™¨çš„è¿›ç¨‹è¢«æš‚åœäº†&lt;/li&gt;
&lt;li&gt;restartingï¼šå®¹å™¨çš„è¿›ç¨‹æ­£åœ¨é‡å¯è¿‡ç¨‹ä¸­&lt;/li&gt;
&lt;li&gt;exitedï¼šä¸Šå›¾ä¸­çš„ stopped çŠ¶æ€ï¼Œè¡¨ç¤ºå®¹å™¨ä¹‹å‰è¿è¡Œè¿‡ä½†æ˜¯ç°åœ¨å¤„äºåœæ­¢çŠ¶æ€ï¼ˆè¦åŒºåˆ«äº created çŠ¶æ€ï¼Œå®ƒæ˜¯æŒ‡ä¸€ä¸ªæ–°åˆ›å‡ºçš„å°šæœªè¿è¡Œè¿‡çš„å®¹å™¨ï¼‰ã€‚å¯ä»¥é€šè¿‡ start å‘½ä»¤ä½¿å…¶é‡æ–°è¿›å…¥ running çŠ¶æ€&lt;/li&gt;
&lt;li&gt;destroyedï¼šå®¹å™¨è¢«åˆ é™¤äº†ï¼Œå†ä¹Ÿä¸å­˜åœ¨äº†&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="docker" scheme="http://idiotsky.top/categories/docker/"/>
    
    
      <category term="docker" scheme="http://idiotsky.top/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>TCMallocï¼šThread-Caching(çº¿ç¨‹ç¼“å­˜)Malloc</title>
    <link href="http://idiotsky.top/2018/09/17/tcmalloc/"/>
    <id>http://idiotsky.top/2018/09/17/tcmalloc/</id>
    <published>2018-09-17T14:56:41.000Z</published>
    <updated>2018-09-25T14:02:35.895Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŠ¨æœº"><a href="#åŠ¨æœº" class="headerlink" title="åŠ¨æœº"></a>åŠ¨æœº</h1><p>TCMallocæ¯”glibc 2.3 mallocï¼ˆä½œä¸ºä¸€ä¸ªåä¸ºptmalloc2çš„ç‹¬ç«‹åº“æä¾›ï¼‰å’Œæˆ‘æµ‹è¯•çš„å…¶ä»–mallocæ›´å¿«ã€‚ptmalloc2åœ¨2.8 GHz P4ä¸Šæ‰§è¡Œmalloc/freeæ“ä½œå¯¹ï¼ˆå¯¹äºå°å¯¹è±¡ï¼‰éœ€è¦å¤§çº¦300çº³ç§’ã€‚å¯¹äºç›¸åŒçš„æ“ä½œå¯¹ï¼ŒTCMallocå®ç°å¤§çº¦éœ€è¦50çº³ç§’ã€‚é€Ÿåº¦å¯¹äºmallocå®ç°å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœmallocä¸å¤Ÿå¿«ï¼Œåº”ç”¨ç¨‹åºç¼–å†™è€…å€¾å‘äºåœ¨mallocä¹‹ä¸Šç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰ç©ºé—²åˆ—è¡¨ã€‚è¿™å¯èƒ½å¯¼è‡´é¢å¤–çš„å¤æ‚æ€§å’Œæ›´å¤šçš„å†…å­˜ä½¿ç”¨ï¼Œé™¤éåº”ç”¨ç¨‹åºç¼–å†™è€…éå¸¸å°å¿ƒåœ°é€‚å½“è°ƒæ•´ç©ºé—²åˆ—è¡¨çš„å¤§å°å¹¶ä»ç©ºé—²åˆ—è¡¨ä¸­æ¸…é™¤ç©ºé—²å¯¹è±¡</p>
<p>TCMallocè¿˜å‡å°‘äº†å¤šçº¿ç¨‹ç¨‹åºçš„é”äº‰ç”¨ã€‚å¯¹äºå°å‹å¯¹è±¡ï¼Œå‡ ä¹æ²¡æœ‰äº‰ç”¨ã€‚å¯¹äºå¤§å‹å¯¹è±¡ï¼ŒTCMallocå°è¯•ä½¿ç”¨ç»†ç²’åº¦å’Œé«˜æ•ˆçš„è‡ªæ—‹é”ã€‚ptmalloc2è¿˜é€šè¿‡ä½¿ç”¨æ¯çº¿ç¨‹arenaæ¥å‡å°‘é”äº‰ç”¨ï¼Œä½†æ˜¯ptmalloc2ä½¿ç”¨æ¯çº¿ç¨‹arenaå­˜åœ¨å¾ˆå¤§é—®é¢˜ã€‚åœ¨ptmalloc2ä¸­ï¼Œå†…å­˜æ°¸è¿œä¸ä¼šä»ä¸€ä¸ªarenaè½¬ç§»åˆ°å¦ä¸€ä¸ªarenaã€‚è¿™å¯èƒ½å¯¼è‡´å¤§é‡æµªè´¹çš„ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªGoogleåº”ç”¨ç¨‹åºä¸­ï¼Œç¬¬ä¸€é˜¶æ®µå°†ä¸ºå…¶æ•°æ®ç»“æ„åˆ†é…å¤§çº¦300MBçš„å†…å­˜ã€‚å½“ç¬¬ä¸€é˜¶æ®µç»“æŸæ—¶ï¼Œç¬¬äºŒé˜¶æ®µå°†åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¼€å§‹ã€‚å¦‚æœç¬¬äºŒé˜¶æ®µè¢«æŒ‡å®šä¸ºä¸ç¬¬ä¸€é˜¶æ®µä½¿ç”¨çš„arenaä¸åŒçš„arenaï¼Œæ­¤é˜¶æ®µä¸ä¼šé‡ç”¨ç¬¬ä¸€é˜¶æ®µä¹‹åå‰©ä½™çš„ä»»ä½•å†…å­˜ï¼Œå¹¶ä¼šå‘åœ°å€ç©ºé—´æ·»åŠ å¦å¤–300MBã€‚åœ¨å…¶ä»–åº”ç”¨ä¸­ä¹Ÿæ³¨æ„åˆ°ç±»ä¼¼çš„å†…å­˜çˆ†ç‚¸é—®é¢˜ã€‚<br><a id="more"></a><br>TCMallocçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯å°å¯¹è±¡éƒ½èƒ½èŠ‚çœæ›´å¤šç©ºé—´ã€‚ä¾‹å¦‚ï¼Œåˆ†é…Nä¸ª8å­—èŠ‚å¯¹è±¡ï¼Œæ‰ä½¿ç”¨å¤§çº¦8N * 1.01å­—èŠ‚çš„ç©ºé—´ã€‚å³ï¼Œä¸€ä¸ªç™¾åˆ†ä¹‹ä¸€çš„ç©ºé—´å¼€é”€ã€‚è€Œptmalloc2ä¸ºæ¯ä¸ªå¯¹è±¡ä½¿ç”¨ä¸€ä¸ªå››å­—èŠ‚çš„å¤´ï¼Œå¹¶ä¸”ï¼ˆæˆ‘è®¤ä¸ºï¼‰å°†å¤§å°å››èˆäº”å…¥ä¸º8ä¸ªå­—èŠ‚çš„å€æ•°ï¼Œæœ€åä½¿ç”¨16Nå­—èŠ‚ã€‚</p>
<h1 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h1><p>è¦ä½¿ç”¨TCmallocï¼Œåªéœ€é€šè¿‡â€œ-ltcmallocâ€é“¾æ¥å™¨æ ‡å¿—å°†tcmallocé“¾æ¥åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨LD_PRELOADåœ¨è‡ªå·±æ²¡æœ‰ç¼–è¯‘çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨tcmallocï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ LD_PRELOAD =â€œ/ usr / lib / libtcmalloc.so</span><br></pre></td></tr></table></figure>
<p>LD_PRELOADå¾ˆæ£˜æ‰‹ï¼Œæˆ‘ä»¬ä¸ä¸€å®šæ¨èè¿™ç§ä½¿ç”¨æ¨¡å¼ã€‚</p>
<p>TCMallocè¿˜åŒ…æ‹¬<a href="http://goog-perftools.sourceforge.net/doc/heap_checker.html" target="_blank" rel="noopener">æ£€æŸ¥å™¨</a> å’Œ<a href="http://goog-perftools.sourceforge.net/doc/heap_profiler.html" target="_blank" rel="noopener">å †åˆ†æå™¨</a>ã€‚</p>
<p>å¦‚æœæ‚¨æ›´å–œæ¬¢é“¾æ¥ä¸åŒ…å«å †åˆ†æå™¨å’Œæ£€æŸ¥å™¨çš„TCMallocç‰ˆæœ¬ï¼ˆå¯èƒ½å‡å°‘é™æ€äºŒè¿›åˆ¶æ–‡ä»¶çš„äºŒè¿›åˆ¶å¤§å°ï¼‰ï¼Œåˆ™å¯ä»¥é“¾æ¥libtcmalloc_minimal ã€‚</p>
<h1 id="æ¦‚è§‚"><a href="#æ¦‚è§‚" class="headerlink" title="æ¦‚è§‚"></a>æ¦‚è§‚</h1><p>TCMallocä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…çº¿ç¨‹æœ¬åœ°ç¼“å­˜ã€‚çº¿ç¨‹æœ¬åœ°ç¼“å­˜æ»¡è¶³å°å†…å­˜çš„åˆ†é…ã€‚æ ¹æ®éœ€è¦å°†å¯¹è±¡ä»centralæ•°æ®ç»“æ„ç§»åŠ¨åˆ°çº¿ç¨‹æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå¹¶ä½¿ç”¨å‘¨æœŸæ€§åƒåœ¾æ”¶é›†å°†å†…å­˜ä»çº¿ç¨‹æœ¬åœ°ç¼“å­˜è¿ç§»å›centralæ•°æ®ç»“æ„ã€‚</p>
<p><a href="http://idiotsky.top/images3/tcmalloc-1.gif"><img src="http://idiotsky.top/images3/tcmalloc-1.gif" alt=""></a></p>
<p>TCMallocä»¥ä¸åŒäºè¾ƒå¤§å¯¹è±¡çš„æ–¹å¼å¤„ç†å¤§å°&lt;= 32Kï¼ˆâ€œå°â€å¯¹è±¡ï¼‰çš„å¯¹è±¡ã€‚ä½¿ç”¨é¡µçº§åˆ†é…å™¨ç›´æ¥ä»centralå †åˆ†é…å¤§å¯¹è±¡ï¼ˆé¡µæ˜¯4Kå¯¹é½çš„å†…å­˜åŒºåŸŸï¼‰ã€‚å³ï¼Œå¤§å¯¹è±¡æ€»æ˜¯é¡µå¯¹é½å¹¶å æ®æ•´æ•°é¡µã€‚</p>
<p>å¯ä»¥å°†ä¸€ç³»åˆ—é¡µåˆ’åˆ†ä¸ºä¸€ç³»åˆ—å°å¯¹è±¡ï¼Œæ¯ä¸ªå°å¯¹è±¡çš„å¤§å°ç›¸åŒã€‚ä¾‹å¦‚ï¼Œä¸€é¡µï¼ˆ4Kï¼‰å¯ä»¥è¢«åˆ†æˆ32ä¸ªå¤§å°ä¸º128å­—èŠ‚çš„å¯¹è±¡ã€‚</p>
<h1 id="å°å¯¹è±¡åˆ†é…"><a href="#å°å¯¹è±¡åˆ†é…" class="headerlink" title="å°å¯¹è±¡åˆ†é…"></a>å°å¯¹è±¡åˆ†é…</h1><p>æ¯ä¸ªå°å¯¹è±¡å¤§å°æ˜ å°„åˆ°å¤§çº¦170ä¸ªå¯åˆ†é…size-classä¸­çš„ä¸€ä¸ªã€‚ä¾‹å¦‚ï¼Œ961åˆ°1024å­—èŠ‚èŒƒå›´å†…çš„æ‰€æœ‰åˆ†é…éƒ½å‘ä¸Šèˆå…¥åˆ°1024.size-classé—´éš”å¼€ï¼Œä»¥ä¾¿å°çš„å¤§å°åˆ†éš”8ä¸ªå­—èŠ‚ï¼Œè¾ƒå¤§çš„å¤§å°åˆ†éš”16ä¸ªå­—èŠ‚ï¼Œç”šè‡³æ›´å¤§çš„å¤§å°åˆ†éš”32ä¸ªå­—èŠ‚ï¼Œä¾æ­¤ç±»æ¨ã€‚æœ€å¤§é—´è·ï¼ˆå¯¹äºå¤§å°&gt; = ~2Kï¼‰æ˜¯256ä¸ªå­—èŠ‚ã€‚<br>çº¿ç¨‹ç¼“å­˜åŒ…å«æ¯ä¸ªsize-classçš„å•â€‹â€‹ç‹¬çš„ç©ºé—²å¯¹è±¡é“¾è¡¨ã€‚</p>
<p><a href="http://idiotsky.top/images3/tcmalloc-2.gif"><img src="http://idiotsky.top/images3/tcmalloc-2.gif" alt=""></a></p>
<p>åˆ†é…å°å¯¹è±¡æ—¶ï¼šï¼ˆ1ï¼‰æˆ‘ä»¬å°†å…¶å¤§å°æ˜ å°„åˆ°ç›¸åº”çš„size-classã€‚ï¼ˆ2ï¼‰æŸ¥æ‰¾å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ç¼“å­˜ä¸­çš„ç›¸åº”ç©ºé—²åˆ—è¡¨ã€‚ï¼ˆ3ï¼‰å¦‚æœç©ºé—²åˆ—è¡¨ä¸ä¸ºç©ºï¼Œæˆ‘ä»¬ä»åˆ—è¡¨ä¸­åˆ é™¤ç¬¬ä¸€ä¸ªå¯¹è±¡å¹¶å°†å…¶è¿”å›ã€‚éµå¾ªæ­¤å¿«é€Ÿè·¯å¾„æ—¶ï¼ŒTCMallocæ ¹æœ¬ä¸ä¼šè·å–ä»»ä½•é”ã€‚è¿™æœ‰åŠ©äºæ˜¾ç€åŠ é€Ÿåˆ†é…ï¼Œå› ä¸ºåŠ é”/è§£é”å¯¹åœ¨2.8 GHz Xeonä¸Šå¤§çº¦éœ€è¦100çº³ç§’ã€‚</p>
<p>å¦‚æœç©ºé—²åˆ—è¡¨ä¸ºç©ºï¼šï¼ˆ1ï¼‰æˆ‘ä»¬ä»è¿™ä¸ªsize-classçš„centralç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€å †å¯¹è±¡ï¼ˆæ‰€æœ‰çº¿ç¨‹å…±äº«centralç©ºé—²åˆ—è¡¨ï¼‰ã€‚ï¼ˆ2ï¼‰å°†å®ƒä»¬æ”¾åœ¨çº¿ç¨‹æœ¬åœ°ç©ºé—²åˆ—è¡¨ä¸­ã€‚ï¼ˆ3ï¼‰å°†ä¸€ä¸ªæ–°è·å–çš„å¯¹è±¡è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚</p>
<p>å¦‚æœcentralç©ºé—²åˆ—è¡¨ä¹Ÿæ˜¯ç©ºçš„ï¼šï¼ˆ1ï¼‰æˆ‘ä»¬ä»centralé¡µåˆ†é…å™¨åˆ†é…ä¸€ç³»åˆ—é¡µã€‚ï¼ˆ2ï¼‰å°†ä¸€ç³»åˆ—é¡µåˆ†æˆè¿™ä¸ªsize-classçš„ä¸€ç»„å¯¹è±¡ã€‚ï¼ˆ3ï¼‰å°†æ–°å¯¹è±¡æ”¾åœ¨centralç©ºé—²åˆ—è¡¨ä¸­ã€‚ï¼ˆ4ï¼‰å’Œä»¥å‰ä¸€æ ·ï¼Œå°†å…¶ä¸­ä¸€äº›å¯¹è±¡ç§»åŠ¨åˆ°çº¿ç¨‹æœ¬åœ°ç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
<h1 id="å¤§å¯¹è±¡åˆ†é…"><a href="#å¤§å¯¹è±¡åˆ†é…" class="headerlink" title="å¤§å¯¹è±¡åˆ†é…"></a>å¤§å¯¹è±¡åˆ†é…</h1><p>å¤§å¯¹è±¡å¤§å°ï¼ˆ&gt; 32Kï¼‰å‘ä¸Šèˆå…¥åˆ°é¡µå¤§å°ï¼ˆ4Kï¼‰å¹¶ç”±centralé¡µå †å¤„ç†ã€‚centralé¡µå †ä¹Ÿæ˜¯ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ•°ç»„ã€‚å¯¹äºi &lt; 256ï¼Œç¬¬kä¸ªæ•°ç»„å…ƒç´ æ˜¯ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œåˆ—è¡¨å…ƒç´ ç”±kä¸ªé¡µç»„æˆã€‚æ‰€ä»¥ç¬¬256ä¸ªæ•°ç»„å…ƒç´ çš„ç©ºé—²åˆ—è¡¨å…ƒç´ æ˜¯ç”±&gt;= 256ä¸ªé¡µç»„æˆï¼š</p>
<p><a href="http://idiotsky.top/images3/tcmalloc-3.gif"><img src="http://idiotsky.top/images3/tcmalloc-3.gif" alt=""></a></p>
<p>åˆ†é…ä¸€ä¸ªkä¸ªé¡µçš„å†…å­˜é¦–å…ˆè¦åˆ°ç¬¬kä¸ªç©ºé—²åˆ—è¡¨çœ‹çœ‹æ˜¯å¦æ»¡è¶³ã€‚å¦‚æœè¯¥ç©ºé—²åˆ—è¡¨ä¸ºç©ºï¼Œæˆ‘ä»¬å°†æŸ¥çœ‹ä¸‹ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œä¾æ­¤ç±»æ¨ã€‚æœ€åï¼Œå¦‚æœ‰å¿…è¦ï¼Œæˆ‘ä»¬ä¼šæŸ¥çœ‹æœ€åä¸€ä¸ªç©ºé—²åˆ—è¡¨ã€‚å¦‚æœå¤±è´¥ï¼Œæˆ‘ä»¬ä»ç³»ç»Ÿä¸­è·å–å†…å­˜ï¼ˆä½¿ç”¨sbrkï¼Œmmapæˆ–åœ¨/dev/memæ˜ å°„éƒ¨åˆ†å†…å­˜ï¼‰ã€‚</p>
<p>å¦‚æœæ»¡è¶³kä¸ªé¡µå†…å­˜åˆ†é…çš„æ˜¯é¡µå¤§å°&gt;kï¼Œåˆ™å°†åˆ†é…åå‰©ä½™éƒ¨åˆ†é‡æ–°æ’å…¥é¡µå †ä¸­çš„ç›¸åº”ç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
<h1 id="Spansï¼ˆè·¨åº¦ï¼‰"><a href="#Spansï¼ˆè·¨åº¦ï¼‰" class="headerlink" title="Spansï¼ˆè·¨åº¦ï¼‰"></a>Spansï¼ˆè·¨åº¦ï¼‰</h1><p>ç”±TCMallocç®¡ç†çš„å †ç”±ä¸€ç»„é¡µç»„æˆã€‚ä¸€ç³»åˆ—è¿ç»­é¡µé¢ç”±Spanå¯¹è±¡è¡¨ç¤ºã€‚Spanå¯ä»¥åˆ†é…ï¼Œä¹Ÿå¯ä»¥æ˜¯ç©ºé—²çš„ã€‚å¦‚æœç©ºé—²ï¼Œåˆ™spanæ˜¯é¡µå †é“¾æ¥åˆ—è¡¨ä¸­çš„æ¡ç›®ä¹‹ä¸€ã€‚å¦‚æœå·²åˆ†é…ï¼Œåˆ™å®ƒæ˜¯å·²ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„å¤§å¯¹è±¡ï¼Œæˆ–è€…å·²åˆ†å‰²ä¸ºä¸€ç³»åˆ—å°å¯¹è±¡çš„ä¸€ç»„é¡µã€‚å¦‚æœæ‹†åˆ†ä¸ºå°å¯¹è±¡ï¼Œåˆ™ä¼šåœ¨Spanä¸­è®°å½•å¯¹è±¡çš„size-classã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ç”±é¡µç ç´¢å¼•çš„centralæ•°ç»„æ¥æŸ¥æ‰¾é¡µé¢æ‰€å±çš„Spanã€‚ä¾‹å¦‚ï¼ŒSpan aå ç”¨2é¡µï¼ŒSpan bå 1é¡µï¼ŒSpan cå 5é¡µï¼ŒSpan då 3é¡µã€‚</p>
<p><a href="http://idiotsky.top/images3/tcmalloc-4.gif"><img src="http://idiotsky.top/images3/tcmalloc-4.gif" alt=""></a></p>
<p>32ä½åœ°å€ç©ºé—´å¯ä»¥å®¹çº³2 ^ 20ä¸ª4Ké¡µé¢ï¼Œå› æ­¤è¿™ä¸ªä¸­å¤®é˜µåˆ—å ç”¨4MBç©ºé—´ï¼Œè¿™ä¼¼ä¹æ˜¯å¯ä»¥æ¥å—çš„ã€‚åœ¨64ä½è®¡ç®—æœºä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨3å±‚åŸºæ•°æ ‘(radix tree)è€Œä¸æ˜¯æ•°ç»„æ¥ä»é¡µç æ˜ å°„åˆ°ç›¸åº”çš„SpanæŒ‡é’ˆã€‚</p>
<h1 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h1><p>å½“ä¸€ä¸ªå¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬è®¡ç®—å…¶é¡µç å¹¶åœ¨centralæ•°ç»„ä¸­æŸ¥æ‰¾å®ƒä»¥æ‰¾åˆ°ç›¸åº”çš„spanå¯¹è±¡ã€‚spanå‘Šè¯‰æˆ‘ä»¬å¯¹è±¡æ˜¯å¦å¾ˆå°ï¼Œå¦‚æœå¯¹è±¡å¾ˆå°ï¼Œspanå‘Šè¯‰æˆ‘ä»¬å¯¹è±¡çš„size-classã€‚å¦‚æœå¯¹è±¡å¾ˆå°ï¼Œæˆ‘ä»¬å°†å®ƒæ’å…¥å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ç¼“å­˜ä¸­çš„ç›¸åº”ç©ºé—²åˆ—è¡¨ä¸­ã€‚å¦‚æœçº¿ç¨‹ç¼“å­˜ç°åœ¨è¶…è¿‡é¢„å®šå¤§å°ï¼ˆé»˜è®¤ä¸º2MBï¼‰ï¼Œæˆ‘ä»¬è¿è¡Œåƒåœ¾æ”¶é›†å™¨ï¼Œå°†æœªä½¿ç”¨çš„å¯¹è±¡ä»çº¿ç¨‹ç¼“å­˜ç§»åŠ¨åˆ°centralç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
<p>å¦‚æœå¯¹è±¡å¾ˆå¤§ï¼Œåˆ™spanå‘Šè¯‰æˆ‘ä»¬å¯¹è±¡è¦†ç›–çš„é¡µèŒƒå›´ã€‚å‡è®¾è¿™ä¸ªèŒƒå›´æ˜¯[p,q]ã€‚æˆ‘ä»¬è¿˜ä¸ºspanæŸ¥æ‰¾é¡µp-1å’Œé¡µq+1ã€‚å¦‚æœè¿™äº›ç›¸é‚»spanä¸­çš„ä»»ä½•ä¸€ä¸ªæ˜¯ç©ºé—²çš„ï¼Œæˆ‘ä»¬å°†å®ƒä»¬ä¸[p,q]çš„spanåˆå¹¶ ã€‚ç”Ÿæˆçš„spanå°†æ’å…¥é¡µå †ä¸­çš„ç›¸åº”ç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
<h1 id="å°å¯¹è±¡çš„centralç©ºé—²åˆ—è¡¨"><a href="#å°å¯¹è±¡çš„centralç©ºé—²åˆ—è¡¨" class="headerlink" title="å°å¯¹è±¡çš„centralç©ºé—²åˆ—è¡¨"></a>å°å¯¹è±¡çš„centralç©ºé—²åˆ—è¡¨</h1><p>å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªsize-classä¿ç•™ä¸€ä¸ªcentralç©ºé—²åˆ—è¡¨ã€‚æ¯ä¸ªcentralç©ºé—²åˆ—è¡¨éƒ½è¢«ç»„ç»‡ä¸ºä¸€ä¸ªä¸¤çº§æ•°æ®ç»“æ„ï¼šä¸€ç»„spanï¼Œä»¥åŠæ¯ä¸ªspançš„ç©ºé—²å¯¹è±¡çš„é“¾è¡¨ã€‚</p>
<p>ä»centralç©ºé—²åˆ—è¡¨åˆ†é…å¯¹è±¡,æ˜¯é€šè¿‡ä»æŸä¸ªspançš„é“¾è¡¨ä¸­åˆ é™¤ç¬¬ä¸€ä¸ªæ¡ç›®ã€‚ï¼ˆå¦‚æœæ‰€æœ‰spanéƒ½æœ‰ç©ºé“¾è¡¨ï¼Œåˆ™é¦–å…ˆä»centralé¡µå †åˆ†é…é€‚å½“å¤§å°çš„spanã€‚ï¼‰</p>
<p>å°†å¯¹è±¡è¿”å›åˆ°centralç©ºé—²åˆ—è¡¨ï¼Œæ˜¯é€šè¿‡å°†å¯¹è±¡æ·»åŠ åˆ°å…¶åŒ…å«spançš„é“¾è¡¨ã€‚å¦‚æœé“¾è¡¨é•¿åº¦ç°åœ¨ç­‰äºspanä¸­çš„å°å¯¹è±¡æ€»æ•°ï¼Œåˆ™æ­¤spanç°åœ¨å®Œå…¨ç©ºé—²å¹¶è¿”å›åˆ°é¡µå †ã€‚</p>
<h1 id="çº¿ç¨‹ç¼“å­˜çš„åƒåœ¾å›æ”¶"><a href="#çº¿ç¨‹ç¼“å­˜çš„åƒåœ¾å›æ”¶" class="headerlink" title="çº¿ç¨‹ç¼“å­˜çš„åƒåœ¾å›æ”¶"></a>çº¿ç¨‹ç¼“å­˜çš„åƒåœ¾å›æ”¶</h1><p>å½“ç¼“å­˜ä¸­æ‰€æœ‰å¯¹è±¡çš„ç»„åˆå¤§å°è¶…è¿‡2MBæ—¶ï¼Œå°†å¯¹çº¿ç¨‹ç¼“å­˜è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚éšç€çº¿ç¨‹æ•°é‡çš„å¢åŠ ï¼Œåƒåœ¾æ”¶é›†é˜ˆå€¼ä¼šè‡ªåŠ¨é™ä½ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šåœ¨å…·æœ‰å¤§é‡çº¿ç¨‹çš„ç¨‹åºä¸­æµªè´¹è¿‡å¤šçš„å†…å­˜ã€‚</p>
<p>æˆ‘ä»¬éå†ç¼“å­˜ä¸­çš„æ‰€æœ‰ç©ºé—²åˆ—è¡¨ï¼Œå¹¶å°†ä¸€äº›å¯¹è±¡ä»ç©ºé—²åˆ—è¡¨ç§»åŠ¨åˆ°ç›¸åº”çš„centralåˆ—è¡¨ã€‚</p>
<p>ä»ç©ºé—²åˆ—è¡¨ç§»åŠ¨çš„å¯¹è±¡æ•°é‡æ˜¯ä½¿ç”¨æ¯ä¸ªåˆ—è¡¨çš„ä½æ°´ä½æ ‡è®°Lå†³å®šçš„ã€‚ Lè®°å½•è‡ªä¸Šæ¬¡åƒåœ¾å›æ”¶ä»¥æ¥åˆ—è¡¨çš„æœ€å°é•¿åº¦ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Læœ€åä¸€ä¸ªåƒåœ¾æ”¶é›†ä¸­çš„å¯¹è±¡ç¼©çŸ­åˆ—è¡¨ï¼Œè€Œæ— éœ€å¯¹centralè¡¨è¿›è¡Œä»»ä½•é¢å¤–è®¿é—®ã€‚æˆ‘ä»¬ä½¿ç”¨æ­¤å†å²è®°å½•ä½œä¸ºå°†æ¥è®¿é—®çš„é¢„æµ‹å™¨ï¼Œå¹¶å°†L/2å¯¹è±¡ä»çº¿ç¨‹ç¼“å­˜ç©ºé—²åˆ—è¡¨ç§»åŠ¨åˆ°ç›¸åº”çš„centralç©ºé—²åˆ—è¡¨ã€‚è¯¥ç®—æ³•å…·æœ‰è‰¯å¥½çš„å±æ€§ï¼Œå¦‚æœçº¿ç¨‹åœæ­¢ä½¿ç”¨ç‰¹å®šå¤§å°ï¼Œåˆ™è¯¥å¤§å°çš„æ‰€æœ‰å¯¹è±¡å°†å¿«é€Ÿä»çº¿ç¨‹é«˜é€Ÿç¼“å­˜ç§»åŠ¨åˆ°centralç©ºé—²åˆ—è¡¨ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>ç¿»è¯‘ <a href="http://goog-perftools.sourceforge.net/doc/tcmalloc.html" target="_blank" rel="noopener">http://goog-perftools.sourceforge.net/doc/tcmalloc.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;åŠ¨æœº&quot;&gt;&lt;a href=&quot;#åŠ¨æœº&quot; class=&quot;headerlink&quot; title=&quot;åŠ¨æœº&quot;&gt;&lt;/a&gt;åŠ¨æœº&lt;/h1&gt;&lt;p&gt;TCMallocæ¯”glibc 2.3 mallocï¼ˆä½œä¸ºä¸€ä¸ªåä¸ºptmalloc2çš„ç‹¬ç«‹åº“æä¾›ï¼‰å’Œæˆ‘æµ‹è¯•çš„å…¶ä»–mallocæ›´å¿«ã€‚ptmalloc2åœ¨2.8 GHz P4ä¸Šæ‰§è¡Œmalloc/freeæ“ä½œå¯¹ï¼ˆå¯¹äºå°å¯¹è±¡ï¼‰éœ€è¦å¤§çº¦300çº³ç§’ã€‚å¯¹äºç›¸åŒçš„æ“ä½œå¯¹ï¼ŒTCMallocå®ç°å¤§çº¦éœ€è¦50çº³ç§’ã€‚é€Ÿåº¦å¯¹äºmallocå®ç°å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœmallocä¸å¤Ÿå¿«ï¼Œåº”ç”¨ç¨‹åºç¼–å†™è€…å€¾å‘äºåœ¨mallocä¹‹ä¸Šç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰ç©ºé—²åˆ—è¡¨ã€‚è¿™å¯èƒ½å¯¼è‡´é¢å¤–çš„å¤æ‚æ€§å’Œæ›´å¤šçš„å†…å­˜ä½¿ç”¨ï¼Œé™¤éåº”ç”¨ç¨‹åºç¼–å†™è€…éå¸¸å°å¿ƒåœ°é€‚å½“è°ƒæ•´ç©ºé—²åˆ—è¡¨çš„å¤§å°å¹¶ä»ç©ºé—²åˆ—è¡¨ä¸­æ¸…é™¤ç©ºé—²å¯¹è±¡&lt;/p&gt;
&lt;p&gt;TCMallocè¿˜å‡å°‘äº†å¤šçº¿ç¨‹ç¨‹åºçš„é”äº‰ç”¨ã€‚å¯¹äºå°å‹å¯¹è±¡ï¼Œå‡ ä¹æ²¡æœ‰äº‰ç”¨ã€‚å¯¹äºå¤§å‹å¯¹è±¡ï¼ŒTCMallocå°è¯•ä½¿ç”¨ç»†ç²’åº¦å’Œé«˜æ•ˆçš„è‡ªæ—‹é”ã€‚ptmalloc2è¿˜é€šè¿‡ä½¿ç”¨æ¯çº¿ç¨‹arenaæ¥å‡å°‘é”äº‰ç”¨ï¼Œä½†æ˜¯ptmalloc2ä½¿ç”¨æ¯çº¿ç¨‹arenaå­˜åœ¨å¾ˆå¤§é—®é¢˜ã€‚åœ¨ptmalloc2ä¸­ï¼Œå†…å­˜æ°¸è¿œä¸ä¼šä»ä¸€ä¸ªarenaè½¬ç§»åˆ°å¦ä¸€ä¸ªarenaã€‚è¿™å¯èƒ½å¯¼è‡´å¤§é‡æµªè´¹çš„ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªGoogleåº”ç”¨ç¨‹åºä¸­ï¼Œç¬¬ä¸€é˜¶æ®µå°†ä¸ºå…¶æ•°æ®ç»“æ„åˆ†é…å¤§çº¦300MBçš„å†…å­˜ã€‚å½“ç¬¬ä¸€é˜¶æ®µç»“æŸæ—¶ï¼Œç¬¬äºŒé˜¶æ®µå°†åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¼€å§‹ã€‚å¦‚æœç¬¬äºŒé˜¶æ®µè¢«æŒ‡å®šä¸ºä¸ç¬¬ä¸€é˜¶æ®µä½¿ç”¨çš„arenaä¸åŒçš„arenaï¼Œæ­¤é˜¶æ®µä¸ä¼šé‡ç”¨ç¬¬ä¸€é˜¶æ®µä¹‹åå‰©ä½™çš„ä»»ä½•å†…å­˜ï¼Œå¹¶ä¼šå‘åœ°å€ç©ºé—´æ·»åŠ å¦å¤–300MBã€‚åœ¨å…¶ä»–åº”ç”¨ä¸­ä¹Ÿæ³¨æ„åˆ°ç±»ä¼¼çš„å†…å­˜çˆ†ç‚¸é—®é¢˜ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="c" scheme="http://idiotsky.top/categories/c/"/>
    
    
      <category term="tcmalloc" scheme="http://idiotsky.top/tags/tcmalloc/"/>
    
      <category term="malloc" scheme="http://idiotsky.top/tags/malloc/"/>
    
  </entry>
  
  <entry>
    <title>MySqlä¸­çš„é”æœºåˆ¶</title>
    <link href="http://idiotsky.top/2018/09/10/mysql-lock/"/>
    <id>http://idiotsky.top/2018/09/10/mysql-lock/</id>
    <published>2018-09-10T09:51:52.000Z</published>
    <updated>2018-09-11T15:26:07.796Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¹è§‚é”ä¸æ‚²è§‚é”"><a href="#ä¹è§‚é”ä¸æ‚²è§‚é”" class="headerlink" title="ä¹è§‚é”ä¸æ‚²è§‚é”"></a>ä¹è§‚é”ä¸æ‚²è§‚é”</h1><ul>
<li>ä¹è§‚é”ï¼šæ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºå…¶ä»–äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œè€Œæ˜¯åœ¨æ›´æ–°çš„æ—¶å€™å»åˆ¤æ–­åœ¨æ­¤æœŸé—´æœ‰æ²¡æœ‰å…¶ä»–äººæ›´æ–°äº†æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶ã€‚åœ¨æ•°æ®åº“ä¸­å¯ä»¥é€šè¿‡ä¸ºæ•°æ®è¡¨å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·å­—æ®µå®ç°ã€‚è¯»å–æ•°æ®æ—¶å°†ç‰ˆæœ¬å·ä¸€åŒè¯»å‡ºï¼Œæ•°æ®æ¯æ¬¡æ›´æ–°æ—¶å¯¹ç‰ˆæœ¬å·åŠ ä¸€ã€‚å½“æˆ‘ä»¬æ›´æ–°çš„æ—¶å€™ï¼Œåˆ¤æ–­æ•°æ®åº“è¡¨å¯¹åº”è®°å½•çš„å½“å‰ç‰ˆæœ¬å·ä¸ç¬¬ä¸€æ¬¡å–å‡ºæ¥çš„ç‰ˆæœ¬å·å€¼è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœå€¼ç›¸ç­‰ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ®ã€‚ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œå¯ä»¥æé«˜ååé‡ã€‚</li>
<li>æ‚²è§‚é”ï¼šæ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨è¯»æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³è¯»è¿™ä¸ªæ•°æ®æ—¶å°±ä¼šè¢«é˜»å¡ã€‚MySQLä¸­å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨æ“ä½œä¹‹å‰å…ˆä¸Šé”ã€‚</li>
</ul>
<a id="more"></a>
<h1 id="å…±äº«é”ä¸æ’ä»–é”"><a href="#å…±äº«é”ä¸æ’ä»–é”" class="headerlink" title="å…±äº«é”ä¸æ’ä»–é”"></a>å…±äº«é”ä¸æ’ä»–é”</h1><ul>
<li><p>å…±äº«é”ï¼šå…±äº«é”åˆå«åšè¯»é”æˆ–Sé”ï¼ŒåŠ ä¸Šå…±äº«é”ååœ¨äº‹åŠ¡ç»“æŸä¹‹å‰å…¶ä»–äº‹åŠ¡åªèƒ½å†åŠ å…±äº«é”ã€åªèƒ½å¯¹å…¶è¿›è¡Œè¯»æ“ä½œä¸èƒ½å†™æ“ä½œï¼Œé™¤æ­¤ä¹‹å¤–å…¶ä»–ä»»ä½•ç±»å‹çš„é”éƒ½ä¸èƒ½å†åŠ äº†ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># åŠ ä¸Šlock in share mode</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span> book_book <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ’ä»–é”ï¼šæ’ä»–é”åˆå«å†™é”æˆ–Xé”ï¼ŒæŸä¸ªäº‹åŠ¡å¯¹æ•°æ®åŠ ä¸Šæ’ä»–é”åï¼Œåªèƒ½è¿™ä¸ªäº‹åŠ¡å¯¹å…¶è¿›è¡Œè¯»å†™ï¼Œåœ¨æ­¤äº‹åŠ¡ç»“æŸä¹‹å‰ï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½å¯¹å…¶åŠ ä»»ä½•é”ï¼Œå¯ä»¥è¯»å–,ä¸èƒ½è¿›è¡Œå†™æ“ä½œï¼Œéœ€ç­‰å¾…å…¶é‡Šæ”¾ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># åŠ ä¸Šfor update</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span> book_book <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="è¡Œé”ä¸è¡¨é”"><a href="#è¡Œé”ä¸è¡¨é”" class="headerlink" title="è¡Œé”ä¸è¡¨é”"></a>è¡Œé”ä¸è¡¨é”</h1><blockquote>
<p>è¡Œé”ä¸è¡¨é”åŒºåˆ«åœ¨äºé”çš„ç²’åº¦ï¼Œåœ¨Innodbå¼•æ“ä¸­æ—¢æ”¯æŒè¡Œé”ä¹Ÿæ”¯æŒè¡¨é”(MyISAMå¼•æ“åªæ”¯æŒè¡¨é”)ï¼Œåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®InnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ã€‚</p>
</blockquote>
<ul>
<li>è¡¨é”ï¼šå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡é«˜ï¼Œå¹¶å‘åº¦æœ€ä½</li>
<li>è¡Œé”ï¼šå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡ä½ï¼Œå¹¶å‘åº¦é«˜</li>
</ul>
<p>ä¸‹é¢ä¸¾ä¸¤ä¸ªä¾‹å­è¯´æ˜ä¸Šé¢å‡ ç§é”ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># äº‹åŠ¡1</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span> book_book <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'JAVAç¼–ç¨‹æ€æƒ³'</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"></span><br><span class="line"># äº‹åŠ¡2</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> book_book <span class="keyword">SET</span> <span class="keyword">name</span> = <span class="string">'new book'</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'new'</span>;</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_TRX;</span><br><span class="line"></span><br><span class="line">trx_id  trx_state       trx_started           trx_tables_locked    trx_rows_locked</span><br><span class="line">39452	<span class="keyword">LOCK</span> <span class="keyword">WAIT</span>	<span class="number">2018</span><span class="number">-09</span><span class="number">-08</span> <span class="number">19</span>:<span class="number">01</span>:<span class="number">39</span>	    <span class="number">1</span>	                <span class="number">1</span>	</span><br><span class="line"><span class="number">282907511143936</span>	RUNNING	<span class="number">2018</span><span class="number">-09</span><span class="number">-08</span> <span class="number">18</span>:<span class="number">58</span>:<span class="number">47</span>	    <span class="number">1</span>	                <span class="number">38</span></span><br></pre></td></tr></table></figure>
<p>äº‹åŠ¡1ç»™bookè¡¨åŠ ä¸Šäº†å…±äº«é”ï¼Œäº‹åŠ¡2å°è¯•ä¿®æ”¹bookè¡¨å‘ç”Ÿäº†é˜»å¡ï¼ŒæŸ¥çœ‹äº‹åŠ¡çŠ¶æ€å¯ä»¥çŸ¥é“äº‹åŠ¡ä¸€ç”±äºæ²¡æœ‰èµ°ç´¢å¼•ä½¿ç”¨äº†è¡¨é”ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># äº‹åŠ¡1</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span> book_book <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">2</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"></span><br><span class="line"># äº‹åŠ¡2</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> book_book <span class="keyword">SET</span> <span class="keyword">name</span> = <span class="string">'new book'</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>; </span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_TRX;</span><br><span class="line"></span><br><span class="line">trx_id          trx_state   trx_started     trx_tables_locked    trx_rows_locked</span><br><span class="line">39454	        RUNNING	2018-09-08 19:10:44	1	                1	</span><br><span class="line">282907511143936	RUNNING	2018-09-08 19:10:35	1	                1</span><br></pre></td></tr></table></figure>
<p>äº‹åŠ¡1ç»™bookè¡¨åŠ ä¸Šäº†å…±äº«é”ï¼Œäº‹åŠ¡2å°è¯•ä¿®æ”¹bookè¡¨å¹¶æ²¡æœ‰å‘ç”Ÿé˜»å¡ã€‚è¿™æ˜¯ç”±äºäº‹åŠ¡ä¸€å’Œäº‹åŠ¡äºŒéƒ½èµ°äº†ç´¢å¼•ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯è¡Œé”ï¼Œå¹¶ä¸ä¼šå‘ç”Ÿé˜»å¡ã€‚</p>
<h1 id="æ„å‘é”-InnoDBç‰¹æœ‰"><a href="#æ„å‘é”-InnoDBç‰¹æœ‰" class="headerlink" title="æ„å‘é”(InnoDBç‰¹æœ‰)"></a>æ„å‘é”(InnoDBç‰¹æœ‰)</h1><blockquote>
<p>æ„å‘é”çš„æ„ä¹‰åœ¨äºæ–¹ä¾¿æ£€æµ‹è¡¨é”å’Œè¡Œé”ä¹‹é—´çš„å†²çª</p>
</blockquote>
<ul>
<li>æ„å‘é”ï¼šæ„å‘é”æ˜¯ä¸€ç§è¡¨çº§é”ï¼Œä»£è¡¨è¦å¯¹æŸè¡Œè®°å½•è¿›è¡Œæ“ä½œã€‚åˆ†ä¸ºæ„å‘å…±äº«é”(IS)å’Œæ„å‘æ’ä»–é”(IX)ã€‚</li>
<li>è¡Œé”å’Œè¡¨é”ä¹‹é—´çš„å†²çªï¼šäº‹åŠ¡Aç»™è¡¨ä¸­çš„æŸä¸€è¡ŒåŠ äº†å…±äº«é”ï¼Œè®©è¿™ä¸€è¡Œåªèƒ½è¯»ä¸èƒ½å†™ã€‚ä¹‹åäº‹åŠ¡Bç”³è¯·æ•´ä¸ªè¡¨çš„æ’ä»–é”ã€‚å¦‚æœäº‹åŠ¡Bç”³è¯·æˆåŠŸï¼Œé‚£ä¹ˆå®ƒå°±èƒ½ä¿®æ”¹è¡¨ä¸­çš„ä»»æ„ä¸€è¡Œï¼Œè¿™ä¸AæŒæœ‰çš„è¡Œé”æ˜¯å†²çªçš„ã€‚InnoDBå¼•å…¥äº†æ„å‘é”æ¥åˆ¤æ–­å®ƒä»¬ä¹‹é—´çš„å†²çªã€‚<ul>
<li>æ²¡æœ‰æ„å‘é”çš„æƒ…å†µï¼š1ã€åˆ¤æ–­è¡¨æ˜¯å¦å·²è¢«å…¶ä»–äº‹åŠ¡ç”¨è¡¨é”é”è¡¨ã€‚2ã€åˆ¤æ–­è¡¨ä¸­çš„æ¯ä¸€è¡Œæ˜¯å¦å·²è¢«è¡Œé”é”ä½ï¼Œè¿™æ ·è¦éå†æ•´ä¸ªè¡¨ï¼Œæ•ˆç‡å¾ˆä½ã€‚</li>
<li>æ„å‘é”å­˜åœ¨çš„æƒ…å†µï¼š1ã€åˆ¤æ–­è¡¨æ˜¯å¦å·²è¢«å…¶ä»–äº‹åŠ¡ç”¨è¡¨é”é”è¡¨ã€‚2ã€åˆ¤æ–­è¡¨ä¸Šæ˜¯å¦æœ‰æ„å‘é”</li>
</ul>
</li>
<li>æ„å‘é”å­˜åœ¨æ—¶ç”³è¯·é”ï¼šç”³è¯·æ„å‘é”çš„åŠ¨ä½œæ˜¯æ•°æ®åº“å®Œæˆçš„ï¼Œä¸Šè¿°ä¾‹å­ä¸­äº‹åŠ¡Aç”³è¯·ä¸€è¡Œçš„è¡Œé”çš„æ—¶å€™ï¼Œæ•°æ®åº“ä¼šè‡ªåŠ¨å…ˆå¼€å§‹ç”³è¯·è¡¨çš„æ„å‘é”ï¼Œå½“äº‹åŠ¡Bç”³è¯·è¡¨çš„æ’ä»–é”æ—¶æ£€æµ‹åˆ°å­˜åœ¨æ„å‘é”åˆ™ä¼šé˜»å¡ã€‚</li>
<li>æ„å‘é”ä¼šä¸ä¼šå­˜åœ¨å†²çªï¼š æ„å‘é”ä¹‹é—´ä¸ä¼šå†²çª, å› ä¸ºæ„å‘é”åªæ˜¯ä»£è¡¨è¦å¯¹æŸè¡Œè®°å½•è¿›è¡Œæ“ä½œã€‚</li>
</ul>
<h1 id="å„ç§é”ä¹‹é—´çš„å…±å­˜æƒ…å†µ"><a href="#å„ç§é”ä¹‹é—´çš„å…±å­˜æƒ…å†µ" class="headerlink" title="å„ç§é”ä¹‹é—´çš„å…±å­˜æƒ…å†µ"></a>å„ç§é”ä¹‹é—´çš„å…±å­˜æƒ…å†µ</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">       IX     IS       X      S</span><br><span class="line">IX    å…¼å®¹    å…¼å®¹    å†²çª    å†²çª</span><br><span class="line">IS    å…¼å®¹    å…¼å®¹    å†²çª    å…¼å®¹</span><br><span class="line">X     å†²çª    å†²çª    å†²çª    å†²çª</span><br><span class="line">S     å†²çª    å…¼å®¹    å†²çª    å…¼å®¹</span><br></pre></td></tr></table></figure>
<h1 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h1><ul>
<li>æ¦‚å¿µï¼šä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ã€‚</li>
<li>å­˜åœ¨æ¡ä»¶ï¼š1ã€ äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨ã€‚2ã€ è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªäº‹åŠ¡å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚3ã€ä¸å‰¥å¤ºæ¡ä»¶ï¼šå·²è·å¾—çš„èµ„æºï¼Œåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚4ã€å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šå½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…å…³ç³»</li>
<li>è§£é™¤æ­£åœ¨æ­»é”çš„çŠ¶æ€ï¼šæ’¤é”€å…¶ä¸­ä¸€ä¸ªäº‹åŠ¡</li>
</ul>
<h1 id="é—´éš™é”-Next-Keyé”"><a href="#é—´éš™é”-Next-Keyé”" class="headerlink" title="é—´éš™é”(Next-Keyé”)"></a>é—´éš™é”(Next-Keyé”)</h1><blockquote>
<p>é—´éš™é”ä½¿å¾—InnoDBè§£å†³å¹»è¯»é—®é¢˜ï¼ŒåŠ ä¸ŠMVCCä½¿å¾—InnoDBçš„RRéš”ç¦»çº§åˆ«å®ç°äº†ä¸²è¡ŒåŒ–çº§åˆ«çš„æ•ˆæœï¼Œå¹¶ä¸”ä¿ç•™äº†æ¯”è¾ƒå¥½çš„å¹¶å‘æ€§èƒ½ã€‚</p>
</blockquote>
<p>å®šä¹‰ï¼šå½“æˆ‘ä»¬ç”¨èŒƒå›´æ¡ä»¶æ£€ç´¢æ•°æ®æ—¶è¯·æ±‚å…±äº«æˆ–æ’ä»–é”æ—¶ï¼ŒInnoDBä¼šç»™ç¬¦åˆæ¡ä»¶çš„å·²æœ‰æ•°æ®çš„ç´¢å¼•åŠ é”ï¼›å¯¹äºé”®å€¼åœ¨æ¡ä»¶èŒƒå›´å†…ä½†å¹¶ä¸å­˜åœ¨çš„è®°å½•ï¼Œå«åšé—´éš™(GAP)ï¼ŒInnoDBä¹Ÿä¼šå¯¹è¿™ä¸ªâ€é—´éš™â€åŠ é”ï¼Œè¿™ç§é”æœºåˆ¶å°±æ˜¯é—´éš™é”ã€‚</p>
<p>ä¾‹å¦‚ï¼šbookè¡¨ä¸­å­˜åœ¨bookId 1-80ï¼Œ90-99çš„è®°å½•ã€‚SELECT * FROM book WHERE bookId &lt; 100 FOR UPDATEã€‚InnoDBä¸ä»…ä¼šå¯¹bookIdå€¼ä¸º1-80ï¼Œ90-99çš„è®°å½•åŠ é”ï¼Œä¹Ÿä¼šå¯¹bookIdåœ¨81-89ä¹‹é—´(è¿™äº›è®°å½•å¹¶ä¸å­˜åœ¨)çš„é—´éš™åŠ é”ã€‚è¿™æ ·å°±èƒ½é¿å…äº‹åŠ¡éš”ç¦»çº§åˆ«å¯é‡å¤è¯»ä¸‹çš„å¹»è¯»ã€‚</p>
<h1 id="MVCC-å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"><a href="#MVCC-å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶" class="headerlink" title="MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)"></a>MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)</h1><blockquote>
<p>MVCC (Multiversion Concurrency Control)ï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æŠ€æœ¯,å®ƒä½¿å¾—å¤§éƒ¨åˆ†æ”¯æŒè¡Œé”çš„äº‹åŠ¡å¼•æ“ï¼Œä¸å†å•çº¯çš„ä½¿ç”¨è¡Œé”æ¥è¿›è¡Œæ•°æ®åº“çš„å¹¶å‘æ§åˆ¶ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æŠŠæ•°æ®åº“çš„è¡Œé”ä¸è¡Œçš„å¤šä¸ªç‰ˆæœ¬ç»“åˆèµ·æ¥ï¼Œåªéœ€è¦å¾ˆå°çš„å¼€é”€,å°±å¯ä»¥å®ç°éé”å®šè¯»ï¼Œä»è€Œå¤§å¤§æé«˜æ•°æ®åº“ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½</p>
</blockquote>
<h2 id="MVCCå®ç°åŸç†"><a href="#MVCCå®ç°åŸç†" class="headerlink" title="MVCCå®ç°åŸç†"></a>MVCCå®ç°åŸç†</h2><p>innodb MVCCä¸»è¦æ˜¯ä¸ºRepeatable-Readäº‹åŠ¡éš”ç¦»çº§åˆ«åšçš„ã€‚åœ¨æ­¤éš”ç¦»çº§åˆ«ä¸‹ï¼ŒAã€Bå®¢æˆ·ç«¯æ‰€ç¤ºçš„æ•°æ®ç›¸äº’éš”ç¦»ï¼Œäº’ç›¸æ›´æ–°ä¸å¯è§</p>
<p>äº†è§£innodbçš„è¡Œç»“æ„ã€Read-Viewçš„ç»“æ„å¯¹äºç†è§£innodb mvccçš„å®ç°ç”±é‡è¦æ„ä¹‰</p>
<p>innodbå­˜å‚¨çš„æœ€åŸºæœ¬rowä¸­åŒ…å«ä¸€äº›é¢å¤–çš„å­˜å‚¨ä¿¡æ¯ DATA_TRX_IDï¼ŒDATA_ROLL_PTRï¼ŒDB_ROW_IDï¼ŒDELETE BIT</p>
<ul>
<li>6å­—èŠ‚çš„DATA_TRX_ID æ ‡è®°äº†æœ€æ–°æ›´æ–°è¿™æ¡è¡Œè®°å½•çš„transaction idï¼Œæ¯å¤„ç†ä¸€ä¸ªäº‹åŠ¡ï¼Œå…¶å€¼è‡ªåŠ¨+1</li>
<li>7å­—èŠ‚çš„DATA_ROLL_PTR æŒ‡å‘å½“å‰è®°å½•é¡¹çš„rollback segmentçš„undo logè®°å½•ï¼Œæ‰¾ä¹‹å‰ç‰ˆæœ¬çš„æ•°æ®å°±æ˜¯é€šè¿‡è¿™ä¸ªæŒ‡</li>
<li>6å­—èŠ‚çš„DB_ROW_IDï¼Œå½“ç”±innodbè‡ªåŠ¨äº§ç”Ÿèšé›†ç´¢å¼•æ—¶ï¼Œèšé›†ç´¢å¼•åŒ…æ‹¬è¿™ä¸ªDB_ROW_IDçš„å€¼ï¼Œå¦åˆ™èšé›†ç´¢å¼•ä¸­ä¸åŒ…æ‹¬è¿™ä¸ªå€¼.ï¼Œè¿™ä¸ªç”¨äºç´¢å¼•å½“ä¸­</li>
<li>DELETE BITä½ç”¨äºæ ‡è¯†è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤ï¼Œè¿™é‡Œçš„ä¸æ˜¯çœŸæ­£çš„åˆ é™¤æ•°æ®ï¼Œè€Œæ˜¯æ ‡å¿—å‡ºæ¥çš„åˆ é™¤ã€‚çœŸæ­£æ„ä¹‰çš„åˆ é™¤æ˜¯åœ¨commitçš„æ—¶å€™</li>
</ul>
<p><a href="http://idiotsky.top/images3/mysql-lock.png"><img src="http://idiotsky.top/images3/mysql-lock.png" alt=""></a></p>
<p>å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹</p>
<p>begin-&gt;ç”¨æ’ä»–é”é”å®šè¯¥è¡Œ-&gt;è®°å½•redo log-&gt;è®°å½•undo log-&gt;ä¿®æ”¹å½“å‰è¡Œçš„å€¼ï¼Œå†™äº‹åŠ¡ç¼–å·ï¼Œå›æ»šæŒ‡é’ˆæŒ‡å‘undo logä¸­çš„ä¿®æ”¹å‰çš„è¡Œ</p>
<p>ä¸Šè¿°è¿‡ç¨‹ç¡®åˆ‡åœ°è¯´æ˜¯æè¿°äº†UPDATEçš„äº‹åŠ¡è¿‡ç¨‹ï¼Œå…¶å®undo logåˆ†insertå’Œupdate undo logï¼Œå› ä¸ºinsertæ—¶ï¼ŒåŸå§‹çš„æ•°æ®å¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å›æ»šæ—¶æŠŠinsert undo logä¸¢å¼ƒå³å¯ï¼Œè€Œupdate undo logåˆ™å¿…é¡»éµå®ˆä¸Šè¿°è¿‡ç¨‹</p>
<p>ä¸‹é¢åˆ†åˆ«ä»¥ <strong>select</strong>ã€<strong>delete</strong>ã€ <strong>insert</strong>ã€ <strong>update</strong>è¯­å¥æ¥è¯´æ˜</p>
<p><strong>SELECT</strong></p>
<p>Innodbæ£€æŸ¥æ¯è¡Œæ•°æ®ï¼Œç¡®ä¿ä»–ä»¬ç¬¦åˆä¸¤ä¸ªæ ‡å‡†ï¼š</p>
<p>1.InnoDBåªæŸ¥æ‰¾ç‰ˆæœ¬æ—©äºå½“å‰äº‹åŠ¡ç‰ˆæœ¬çš„æ•°æ®è¡Œ(ä¹Ÿå°±æ˜¯æ•°æ®è¡Œçš„ç‰ˆæœ¬å¿…é¡»å°äºç­‰äºäº‹åŠ¡çš„ç‰ˆæœ¬)ï¼Œè¿™ç¡®ä¿å½“å‰äº‹åŠ¡è¯»å–çš„è¡Œéƒ½æ˜¯äº‹åŠ¡ä¹‹å‰å·²ç»å­˜åœ¨çš„ï¼Œæˆ–è€…æ˜¯ç”±å½“å‰äº‹åŠ¡åˆ›å»ºæˆ–ä¿®æ”¹çš„è¡Œ<br>2.è¡Œçš„åˆ é™¤æ“ä½œçš„ç‰ˆæœ¬ä¸€å®šæ˜¯æœªå®šä¹‰çš„æˆ–è€…å¤§äºå½“å‰äº‹åŠ¡çš„ç‰ˆæœ¬å·ï¼Œç¡®å®šäº†å½“å‰äº‹åŠ¡å¼€å§‹ä¹‹å‰ï¼Œè¡Œæ²¡æœ‰è¢«åˆ é™¤</p>
<p>ç¬¦åˆäº†ä»¥ä¸Šä¸¤ç‚¹åˆ™è¿”å›æŸ¥è¯¢ç»“æœã€‚</p>
<p><strong>INSERT</strong></p>
<p>InnoDBä¸ºæ¯ä¸ªæ–°å¢è¡Œè®°å½•å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºåˆ›å»ºIDã€‚</p>
<p><strong>DELETE</strong></p>
<p>InnoDBä¸ºæ¯ä¸ªåˆ é™¤è¡Œçš„è®°å½•å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºè¡Œçš„åˆ é™¤IDã€‚</p>
<p><strong>UPDATE</strong></p>
<p>InnoDBå¤åˆ¶äº†ä¸€è¡Œã€‚è¿™ä¸ªæ–°è¡Œçš„ç‰ˆæœ¬å·ä½¿ç”¨äº†ç³»ç»Ÿç‰ˆæœ¬å·ã€‚å®ƒä¹ŸæŠŠç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºäº†åˆ é™¤è¡Œçš„ç‰ˆæœ¬ã€‚</p>
<p><strong>è¯´æ˜</strong></p>
<p>insertæ“ä½œæ—¶ â€œåˆ›å»ºæ—¶é—´â€=DB_ROW_IDï¼Œè¿™æ—¶ï¼Œâ€œåˆ é™¤æ—¶é—´ â€æ˜¯æœªå®šä¹‰çš„ï¼›</p>
<p>updateæ—¶ï¼Œå¤åˆ¶æ–°å¢è¡Œçš„â€œåˆ›å»ºæ—¶é—´â€=DB_ROW_IDï¼Œåˆ é™¤æ—¶é—´æœªå®šä¹‰ï¼Œæ—§æ•°æ®è¡Œâ€œåˆ›å»ºæ—¶é—´â€ä¸å˜ï¼Œåˆ é™¤æ—¶é—´=è¯¥äº‹åŠ¡çš„DB_ROW_IDï¼›</p>
<p>deleteæ“ä½œï¼Œç›¸åº”æ•°æ®è¡Œçš„â€œåˆ›å»ºæ—¶é—´â€ä¸å˜ï¼Œåˆ é™¤æ—¶é—´=è¯¥äº‹åŠ¡çš„DB_ROW_IDï¼›</p>
<p>selectæ“ä½œå¯¹ä¸¤è€…éƒ½ä¸ä¿®æ”¹ï¼Œåªè¯»ç›¸åº”çš„æ•°æ®</p>
<h2 id="å¯¹äºMVCCçš„æ€»ç»“"><a href="#å¯¹äºMVCCçš„æ€»ç»“" class="headerlink" title="å¯¹äºMVCCçš„æ€»ç»“"></a>å¯¹äºMVCCçš„æ€»ç»“</h2><p>ä¸Šè¿°æ›´æ–°å‰å»ºç«‹undo logï¼Œæ ¹æ®å„ç§ç­–ç•¥è¯»å–æ—¶éé˜»å¡å°±æ˜¯MVCCï¼Œundo logä¸­çš„è¡Œå°±æ˜¯MVCCä¸­çš„å¤šç‰ˆæœ¬ï¼Œè¿™ä¸ªå¯èƒ½ä¸æˆ‘ä»¬æ‰€ç†è§£çš„MVCCæœ‰è¾ƒå¤§çš„å‡ºå…¥ï¼Œä¸€èˆ¬æˆ‘ä»¬è®¤ä¸ºMVCCæœ‰ä¸‹é¢å‡ ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¯è¡Œæ•°æ®éƒ½å­˜åœ¨ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ¯æ¬¡æ•°æ®æ›´æ–°æ—¶éƒ½æ›´æ–°è¯¥ç‰ˆæœ¬</li>
<li>ä¿®æ”¹æ—¶Copyå‡ºå½“å‰ç‰ˆæœ¬éšæ„ä¿®æ”¹ï¼Œå„ä¸ªäº‹åŠ¡ä¹‹é—´æ— å¹²æ‰°</li>
<li>ä¿å­˜æ—¶æ¯”è¾ƒç‰ˆæœ¬å·ï¼Œå¦‚æœæˆåŠŸï¼ˆcommitï¼‰ï¼Œåˆ™è¦†ç›–åŸè®°å½•ï¼›å¤±è´¥åˆ™æ”¾å¼ƒcopyï¼ˆrollbackï¼‰</li>
</ul>
<p>å°±æ˜¯æ¯è¡Œéƒ½æœ‰ç‰ˆæœ¬å·ï¼Œä¿å­˜æ—¶æ ¹æ®ç‰ˆæœ¬å·å†³å®šæ˜¯å¦æˆåŠŸï¼Œå¬èµ·æ¥å«æœ‰ä¹è§‚é”çš„å‘³é“ï¼Œè€ŒInnodbçš„å®ç°æ–¹å¼æ˜¯ï¼š</p>
<ul>
<li>äº‹åŠ¡ä»¥æ’ä»–é”çš„å½¢å¼ä¿®æ”¹åŸå§‹æ•°æ®</li>
<li>æŠŠä¿®æ”¹å‰çš„æ•°æ®å­˜æ”¾äºundo logï¼Œé€šè¿‡å›æ»šæŒ‡é’ˆä¸ä¸»æ•°æ®å…³è”</li>
<li>ä¿®æ”¹æˆåŠŸï¼ˆcommitï¼‰å•¥éƒ½ä¸åšï¼Œå¤±è´¥åˆ™æ¢å¤undo logä¸­çš„æ•°æ®ï¼ˆrollbackï¼‰</li>
</ul>
<p>äºŒè€…æœ€æœ¬è´¨çš„åŒºåˆ«æ˜¯ï¼Œå½“ä¿®æ”¹æ•°æ®æ—¶æ˜¯å¦è¦æ’ä»–é”å®šï¼Œå¦‚æœé”å®šäº†è¿˜ç®—ä¸ç®—æ˜¯MVCCï¼Ÿ </p>
<p>Innodbçš„å®ç°çœŸç®—ä¸ä¸ŠMVCCï¼Œå› ä¸ºå¹¶æ²¡æœ‰å®ç°æ ¸å¿ƒçš„å¤šç‰ˆæœ¬å…±å­˜ï¼Œundo logä¸­çš„å†…å®¹åªæ˜¯ä¸²è¡ŒåŒ–çš„ç»“æœï¼Œè®°å½•äº†å¤šä¸ªäº‹åŠ¡çš„è¿‡ç¨‹ï¼Œä¸å±äºå¤šç‰ˆæœ¬å…±å­˜ã€‚ä½†ç†æƒ³çš„MVCCæ˜¯éš¾ä»¥å®ç°çš„ï¼Œå½“äº‹åŠ¡ä»…ä¿®æ”¹ä¸€è¡Œè®°å½•ä½¿ç”¨ç†æƒ³çš„MVCCæ¨¡å¼æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¯ä»¥é€šè¿‡æ¯”è¾ƒç‰ˆæœ¬å·è¿›è¡Œå›æ»šï¼›ä½†å½“äº‹åŠ¡å½±å“åˆ°å¤šè¡Œæ•°æ®æ—¶ï¼Œç†æƒ³çš„MVCCæ®æ— èƒ½ä¸ºåŠ›äº†ã€‚</p>
<p>æ¯”å¦‚ï¼Œå¦‚æœTransaciton1æ‰§è¡Œç†æƒ³çš„MVCCï¼Œä¿®æ”¹Row1æˆåŠŸï¼Œè€Œä¿®æ”¹Row2å¤±è´¥ï¼Œæ­¤æ—¶éœ€è¦å›æ»šRow1ï¼Œä½†å› ä¸ºRow1æ²¡æœ‰è¢«é”å®šï¼Œå…¶æ•°æ®å¯èƒ½åˆè¢«Transaction2æ‰€ä¿®æ”¹ï¼Œå¦‚æœæ­¤æ—¶å›æ»šRow1çš„å†…å®¹ï¼Œåˆ™ä¼šç ´åTransaction2çš„ä¿®æ”¹ç»“æœï¼Œå¯¼è‡´Transaction2è¿åACIDã€‚</p>
<p>ç†æƒ³MVCCéš¾ä»¥å®ç°çš„æ ¹æœ¬åŸå› åœ¨äºä¼å›¾é€šè¿‡ä¹è§‚é”ä»£æ›¿äºŒæ®µæäº¤ã€‚ä¿®æ”¹ä¸¤è¡Œæ•°æ®ï¼Œä½†ä¸ºäº†ä¿è¯å…¶ä¸€è‡´æ€§ï¼Œä¸ä¿®æ”¹ä¸¤ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®å¹¶æ— åŒºåˆ«ï¼Œè€ŒäºŒæäº¤æ˜¯ç›®å‰è¿™ç§åœºæ™¯ä¿è¯ä¸€è‡´æ€§çš„å”¯ä¸€æ‰‹æ®µã€‚äºŒæ®µæäº¤çš„æœ¬è´¨æ˜¯é”å®šï¼Œä¹è§‚é”çš„æœ¬è´¨æ˜¯æ¶ˆé™¤é”å®šï¼ŒäºŒè€…çŸ›ç›¾ï¼Œæ•…ç†æƒ³çš„MVCCéš¾ä»¥çœŸæ­£åœ¨å®é™…ä¸­è¢«åº”ç”¨ï¼ŒInnodbåªæ˜¯å€Ÿäº†MVCCè¿™ä¸ªåå­—ï¼Œæä¾›äº†è¯»çš„éé˜»å¡è€Œå·²ã€‚</p>
<h2 id="å¿«ç…§è¯»å’Œå½“å‰è¯»"><a href="#å¿«ç…§è¯»å’Œå½“å‰è¯»" class="headerlink" title="å¿«ç…§è¯»å’Œå½“å‰è¯»"></a>å¿«ç…§è¯»å’Œå½“å‰è¯»</h2><p>åœ¨ä¸€ä¸ªæ”¯æŒMVCCå¹¶å‘æ§åˆ¶çš„ç³»ç»Ÿä¸­ï¼Œå“ªäº›è¯»æ“ä½œæ˜¯å¿«ç…§è¯»ï¼Ÿå“ªäº›æ“ä½œåˆæ˜¯å½“å‰è¯»å‘¢ï¼Ÿä»¥MySQL InnoDBä¸ºä¾‹ï¼š</p>
<p>å¿«ç…§è¯»ï¼šç®€å•çš„selectæ“ä½œï¼Œå±äºå¿«ç…§è¯»ï¼Œä¸åŠ é”ã€‚(å½“ç„¶ï¼Œä¹Ÿæœ‰ä¾‹å¤–ï¼Œä¸‹é¢ä¼šåˆ†æ)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from table where ?;</span><br></pre></td></tr></table></figure>
<p>å½“å‰è¯»ï¼šç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œï¼Œå±äºå½“å‰è¯»ï¼Œéœ€è¦åŠ é”ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select * from table where ? lock in share mode;</span><br><span class="line">select * from table where ? for update;</span><br><span class="line">insert into table values (â€¦);</span><br><span class="line">update table set ? where ?;</span><br><span class="line">delete from table where ?;</span><br></pre></td></tr></table></figure></p>
<p>æ‰€æœ‰ä»¥ä¸Šçš„è¯­å¥ï¼Œéƒ½å±äºå½“å‰è¯»ï¼Œè¯»å–è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ã€‚å¹¶ä¸”ï¼Œè¯»å–ä¹‹åï¼Œè¿˜éœ€è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œå¯¹è¯»å–è®°å½•åŠ é”ã€‚å…¶ä¸­ï¼Œé™¤äº†ç¬¬ä¸€æ¡è¯­å¥ï¼Œå¯¹è¯»å–è®°å½•åŠ Sé” (å…±äº«é”)å¤–ï¼Œå…¶ä»–çš„æ“ä½œï¼Œéƒ½åŠ çš„æ˜¯Xé” (æ’å®ƒé”)ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://juejin.im/post/5b9332685188255c432279aa" target="_blank" rel="noopener">https://juejin.im/post/5b9332685188255c432279aa</a><br><a href="https://www.cnblogs.com/chenpingzhao/p/5041968.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenpingzhao/p/5041968.html</a><br><a href="https://www.cnblogs.com/chenpingzhao/p/5065316.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenpingzhao/p/5065316.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ä¹è§‚é”ä¸æ‚²è§‚é”&quot;&gt;&lt;a href=&quot;#ä¹è§‚é”ä¸æ‚²è§‚é”&quot; class=&quot;headerlink&quot; title=&quot;ä¹è§‚é”ä¸æ‚²è§‚é”&quot;&gt;&lt;/a&gt;ä¹è§‚é”ä¸æ‚²è§‚é”&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;ä¹è§‚é”ï¼šæ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºå…¶ä»–äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œè€Œæ˜¯åœ¨æ›´æ–°çš„æ—¶å€™å»åˆ¤æ–­åœ¨æ­¤æœŸé—´æœ‰æ²¡æœ‰å…¶ä»–äººæ›´æ–°äº†æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶ã€‚åœ¨æ•°æ®åº“ä¸­å¯ä»¥é€šè¿‡ä¸ºæ•°æ®è¡¨å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·å­—æ®µå®ç°ã€‚è¯»å–æ•°æ®æ—¶å°†ç‰ˆæœ¬å·ä¸€åŒè¯»å‡ºï¼Œæ•°æ®æ¯æ¬¡æ›´æ–°æ—¶å¯¹ç‰ˆæœ¬å·åŠ ä¸€ã€‚å½“æˆ‘ä»¬æ›´æ–°çš„æ—¶å€™ï¼Œåˆ¤æ–­æ•°æ®åº“è¡¨å¯¹åº”è®°å½•çš„å½“å‰ç‰ˆæœ¬å·ä¸ç¬¬ä¸€æ¬¡å–å‡ºæ¥çš„ç‰ˆæœ¬å·å€¼è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœå€¼ç›¸ç­‰ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ®ã€‚ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œå¯ä»¥æé«˜ååé‡ã€‚&lt;/li&gt;
&lt;li&gt;æ‚²è§‚é”ï¼šæ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨è¯»æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³è¯»è¿™ä¸ªæ•°æ®æ—¶å°±ä¼šè¢«é˜»å¡ã€‚MySQLä¸­å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨æ“ä½œä¹‹å‰å…ˆä¸Šé”ã€‚&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="mysql" scheme="http://idiotsky.top/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://idiotsky.top/tags/mysql/"/>
    
      <category term="æ‚²è§‚é”" scheme="http://idiotsky.top/tags/%E6%82%B2%E8%A7%82%E9%94%81/"/>
    
      <category term="ä¹è§‚é”" scheme="http://idiotsky.top/tags/%E4%B9%90%E8%A7%82%E9%94%81/"/>
    
      <category term="å…±äº«é”" scheme="http://idiotsky.top/tags/%E5%85%B1%E4%BA%AB%E9%94%81/"/>
    
      <category term="æ’ä»–é”" scheme="http://idiotsky.top/tags/%E6%8E%92%E4%BB%96%E9%94%81/"/>
    
      <category term="é—´éš™é”" scheme="http://idiotsky.top/tags/%E9%97%B4%E9%9A%99%E9%94%81/"/>
    
      <category term="æ„å‘é”" scheme="http://idiotsky.top/tags/%E6%84%8F%E5%90%91%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>epollçš„ETå’ŒLTä¸¾ä¾‹</title>
    <link href="http://idiotsky.top/2018/08/14/epoll-et-lt/"/>
    <id>http://idiotsky.top/2018/08/14/epoll-et-lt/</id>
    <published>2018-08-14T13:30:07.000Z</published>
    <updated>2018-08-16T13:27:15.541Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ET"><a href="#ET" class="headerlink" title="ET"></a>ET</h1><p>Edge Triggered (ET) è¾¹ç¼˜è§¦å‘åªæœ‰æ•°æ®åˆ°æ¥,æ‰è§¦å‘,ä¸ç®¡ç¼“å­˜åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®ã€‚</p>
<p>LT(level triggered)æ˜¯ç¼ºçœçš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒblock(é˜»å¡)å’Œno-block(éé˜»å¡) socket.åœ¨è¿™ç§åšæ³•ä¸­ï¼Œå†…æ ¸å‘Šè¯‰ä½ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªäº†ï¼Œç„¶åä½ å¯ä»¥å¯¹è¿™ä¸ªå°±ç»ªçš„fdè¿›è¡ŒIOæ“ä½œã€‚å¦‚æœä½ ä¸ä½œä»»ä½•æ“ä½œï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­é€šçŸ¥ä½ çš„ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ¨¡å¼ç¼–ç¨‹å‡ºé”™è¯¯å¯èƒ½æ€§è¦å°ä¸€ç‚¹ã€‚ä¼ ç»Ÿçš„select/polléƒ½æ˜¯è¿™ç§æ¨¡å‹çš„ä»£è¡¨ï¼</p>
<p>ä¼˜ç‚¹ï¼šå½“è¿›è¡Œsocketé€šä¿¡çš„æ—¶å€™ï¼Œä¿è¯äº†æ•°æ®çš„å®Œæ•´è¾“å‡ºï¼Œè¿›è¡ŒIOæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœè¿˜æœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´çš„é€šçŸ¥ä½ ã€‚</p>
<p>ç¼ºç‚¹ï¼šç”±äºåªè¦è¿˜æœ‰æ•°æ®ï¼Œå†…æ ¸å°±ä¼šä¸åœçš„ä»å†…æ ¸ç©ºé—´è½¬åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæ‰€æœ‰å ç”¨äº†å¤§é‡å†…æ ¸èµ„æºï¼Œè¯•æƒ³ä¸€ä¸‹å½“æœ‰å¤§é‡æ•°æ®åˆ°æ¥çš„æ—¶å€™ï¼Œæ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±ä¼šä¸åœçš„è¿›è¡Œåˆ‡æ¢ã€‚å†…æ ¸èµ„æºçš„æµªè´¹ä¸¥é‡ã€‚æ•ˆç‡æ¥è®²ä¹Ÿæ˜¯å¾ˆä½çš„ã€‚</p>
<h1 id="LT"><a href="#LT" class="headerlink" title="LT"></a>LT</h1><p>Level Triggered (LT) æ°´å¹³è§¦å‘åªè¦æœ‰æ•°æ®éƒ½ä¼šè§¦å‘ã€‚</p>
<p>ET(edge-triggered)æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒno-block socketã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰ä½ ã€‚ç„¶åå®ƒä¼šå‡è®¾ä½ çŸ¥é“æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œå¹¶ä¸”ä¸ä¼šå†ä¸ºé‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦å‘é€æ›´å¤šçš„å°±ç»ªé€šçŸ¥ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä¸€ç›´ä¸å¯¹è¿™ä¸ªfdä½œIOæ“ä½œ(ä»è€Œå¯¼è‡´å®ƒå†æ¬¡å˜æˆæœªå°±ç»ª)ï¼Œå†…æ ¸ä¸ä¼šå‘é€æ›´å¤šçš„é€šçŸ¥(only once).</p>
<p>ä¼˜ç‚¹ï¼šæ¯æ¬¡å†…æ ¸åªä¼šé€šçŸ¥ä¸€æ¬¡ï¼Œå¤§å¤§å‡å°‘äº†å†…æ ¸èµ„æºçš„æµªè´¹ï¼Œæé«˜æ•ˆç‡ã€‚</p>
<p>ç¼ºç‚¹ï¼šä¸èƒ½ä¿è¯æ•°æ®çš„å®Œæ•´ã€‚ä¸èƒ½åŠæ—¶çš„å–å‡ºæ‰€æœ‰çš„æ•°æ®ã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼š å¤„ç†å¤§æ•°æ®ã€‚ä½¿ç”¨non-block(éé˜»å¡)æ¨¡å¼çš„socketã€‚</p>
<a id="more"></a>
<h1 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h1><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä»£ç ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡è¾“å‡º10ä¸ªå­—èŠ‚ï¼Œç„¶åä¼‘çœ 5ç§’ï¼ŒæœåŠ¡å™¨ä¼šåˆ†åˆ«ä½¿ç”¨LTå’ŒETæ¥å±•ç¤ºä»–ä»¬çš„ä¸åŒã€‚</p>
<p>å®¢æˆ·ç«¯ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE  10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PROT 8000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">seraddr</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="keyword">int</span> connfd, i;</span><br><span class="line">    <span class="keyword">char</span> ch = <span class="string">'a'</span>;</span><br><span class="line">    connfd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">    bzero(&amp;seraddr,<span class="keyword">sizeof</span>(seraddr));</span><br><span class="line">    seraddr.sin_family = AF_INET;</span><br><span class="line">    seraddr.sin_port = htons(SERV_PROT);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">s</span>;</span></span><br><span class="line">    inet_pton(AF_INET, <span class="string">"127.0.0.1"</span>, (<span class="keyword">void</span> *)&amp;s);</span><br><span class="line">    seraddr.sin_addr=s;</span><br><span class="line">    connect(connfd, (struct sockaddr *)&amp;seraddr, <span class="keyword">sizeof</span>(seraddr));</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i &lt; MAXLINE/<span class="number">2</span>;i++)&#123;</span><br><span class="line">            buf[i] = ch;</span><br><span class="line">        &#125;</span><br><span class="line">        buf[i<span class="number">-1</span>] = <span class="string">'\n'</span>;</span><br><span class="line">        ch++;</span><br><span class="line">        <span class="keyword">for</span>(;i&lt;MAXLINE;i++)</span><br><span class="line">            buf[i] = ch;</span><br><span class="line">        buf[i<span class="number">-1</span>] = <span class="string">'\n'</span>;</span><br><span class="line">        ch++;</span><br><span class="line">        write(connfd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(connfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡ç«¯ä»£ç ï¼ˆLTï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 8000</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>, <span class="title">cliaddr</span>;</span></span><br><span class="line"> <span class="keyword">socklen_t</span> cliaddr_len;</span><br><span class="line"> <span class="keyword">int</span> listenfd, connfd;</span><br><span class="line"> <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line"> <span class="keyword">char</span> str[INET_ADDRSTRLEN];</span><br><span class="line"> <span class="keyword">int</span> i, efd;</span><br><span class="line"> listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"> bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line"> servaddr.sin_family = AF_INET;</span><br><span class="line"> servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"> servaddr.sin_port = htons(SERV_PORT);</span><br><span class="line"> bind(listenfd, (struct sockaddr *)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line"> listen(listenfd, <span class="number">20</span>);</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">resevent</span>[10];</span></span><br><span class="line"> <span class="keyword">int</span> res, len;</span><br><span class="line"> efd = epoll_create(<span class="number">10</span>);</span><br><span class="line"> event.events = EPOLLIN;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"Accepting connections ...\n"</span>);</span><br><span class="line"> cliaddr_len = <span class="keyword">sizeof</span>(cliaddr);</span><br><span class="line"> connfd = accept(listenfd, (struct sockaddr *)&amp;cliaddr, &amp;cliaddr_len);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"received from %s at PORT %d\n"</span>,</span><br><span class="line"> inet_ntop(AF_INET, &amp;cliaddr.sin_addr, str, <span class="keyword">sizeof</span>(str)),</span><br><span class="line"> ntohs(cliaddr.sin_port));</span><br><span class="line"> event.data.fd = connfd;</span><br><span class="line"> epoll_ctl(efd, EPOLL_CTL_ADD, connfd, &amp;event);</span><br><span class="line"> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  res = epoll_wait(efd, resevent, <span class="number">10</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (resevent[<span class="number">0</span>].data.fd == connfd) &#123;</span><br><span class="line">  len = read(connfd, buf, MAXLINE/<span class="number">2</span>);</span><br><span class="line">  write(STDOUT_FILENO, buf, len);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./server</span><br><span class="line">Accepting connections ...</span><br><span class="line">received from 127.0.0.1 at PORT 40580</span><br><span class="line">aaaa</span><br><span class="line">bbbb</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">cccc</span><br><span class="line">dddd</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line"># ä»¥ä¸‹è¾“å‡ºçœç•¥</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¾“å‡ºç¬¦åˆé¢„æœŸ</p>
<p>æ¥ä¸‹é‡ŒæŠŠæœåŠ¡å™¨æ”¹æˆETæ¨¡å¼ä¼šæ€ä¹ˆæ ·å‘¢ï¼Œä¸‹é¢æ˜¯è¦ä¿®æ”¹çš„åœ°æ–¹</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">32c32</span><br><span class="line">&lt;  event.events = EPOLLIN;</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt; event.events = EPOLLIN|EPOLLET;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./server</span><br><span class="line">Accepting connections ...</span><br><span class="line">received from 127.0.0.1 at PORT 40580</span><br><span class="line">aaaa</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">bbbb</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">cccc</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">dddd</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line"># ä»¥ä¸‹è¾“å‡ºçœç•¥</span><br></pre></td></tr></table></figure>
<p>é—®é¢˜æ¥äº†ï¼Œè¾“å‡ºçš„ä¸œè¥¿æ¯”ETçš„æ—¶å€™æ…¢äº†åŠæ‹äº†ï¼ŒåŸå› åœ¨äºä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  res = epoll_wait(efd, resevent, <span class="number">10</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (resevent[<span class="number">0</span>].data.fd == connfd) &#123;</span><br><span class="line">  len = read(connfd, buf, MAXLINE/<span class="number">2</span>);</span><br><span class="line">  write(STDOUT_FILENO, buf, len);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><code>read</code>å‡½æ•°åªå–5ä¸ªå­—èŠ‚ï¼Œä¹‹åå°±æ²¡æœ‰è¾“å‡ºäº†ï¼Œç­‰å®¢æˆ·ç«¯ä¸‹æ¬¡æ¥æ•°æ®çš„æ—¶å€™å†æ¬¡è§¦å‘ä¸‹5ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯ETæ¨¡å¼çš„æ­£å¸¸è¡¨ç°å½¢å¼ï¼Œè€ŒLTä¼šåœ¨ä¸‹æ¬¡å¾ªç¯çš„æ—¶å€™ï¼Œä¼šå†æ¬¡è§¦å‘å¯è¯»ï¼Œç„¶å<code>epoll_wait</code>è¿”å›ï¼Œæ¥ä¸‹æ¥ç»§ç»­æŠŠå‰©ä¸‹5ä¸ªå­—èŠ‚è¯»å…¥ã€‚</p>
<p>é‚£æ¥ä¸‹æ¥ä¿®æ”¹ETæ¨¡å¼</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">9a10</span><br><span class="line">&gt; #include &lt;fcntl.h&gt;</span><br><span class="line">38a40,42</span><br><span class="line">&gt; int flag=fcntl(connfd,F_GETFL);</span><br><span class="line">&gt; flag|=O_NONBLOCK;</span><br><span class="line">&gt; fcntl(connfd,F_SETFL,flag);</span><br><span class="line">44,45c48,50</span><br><span class="line">&lt;   len = read(connfd, buf, MAXLINE/2);</span><br><span class="line">&lt;   write(STDOUT_FILENO, buf, len);</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt;   while ((len = read(connfd, buf, MAXLINE/2)) &gt;0 )</span><br><span class="line">&gt;         write(STDOUT_FILENO, buf, len);</span><br><span class="line">&gt;    &#125;</span><br><span class="line">47d51</span><br><span class="line">&lt; &#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./server</span><br><span class="line">Accepting connections ...</span><br><span class="line">received from 127.0.0.1 at PORT 40580</span><br><span class="line">aaaa</span><br><span class="line">bbbb</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">cccc</span><br><span class="line">dddd</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line"># ä»¥ä¸‹è¾“å‡ºçœç•¥</span><br></pre></td></tr></table></figure>
<p>æ­£å¸¸äº†ï¼Œä¸Šé¢ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p>
<ul>
<li>æŠŠå¥—æ¥å­—æè¿°ç¬¦æ”¹æˆéé˜»å¡</li>
<li>å¾ªç¯è¯»å‡ºæ‰€æœ‰æ•°æ®</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆETæ¨¡å¼åªèƒ½ç”¨åœ¨éé˜»å¡çš„å¥—æ¥å­—å‘¢ï¼Œé€šè¿‡ä¸Šé¢ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯é˜»å¡çš„è¯ï¼Œåœ¨è¯»å‡º10ä¸ªå­—èŠ‚ä¹‹åï¼Œå¾ªç¯è¿˜ä¼šç»§ç»­ï¼Œ<code>read</code>å‡½æ•°ä¼šé˜»å¡ç›´åˆ°ä¸‹æ¬¡æ•°æ®åˆ°æ¥ï¼Œè¿™æ ·çš„è¯ï¼Œå¦‚æœæ˜¯å¤šè¿æ¥çš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¿æ¥çš„æ•°æ®éƒ½ä¼šé˜»å¡åœ¨è¿™ä¸ªè¿æ¥çš„<code>read</code>å‡½æ•°é‡Œé¢äº†ï¼Œæ‰€ä»¥ETæ¨¡å¼åªæ”¯æŒéé˜»å¡æ˜¯æœ‰é“ç†çš„ã€‚</strong></p>
<h1 id="å®éªŒä»£ç "><a href="#å®éªŒä»£ç " class="headerlink" title="å®éªŒä»£ç "></a>å®éªŒä»£ç </h1><p>æ‰€æœ‰ä»£ç åœ¨è¿™ä¸ª<a href="https://github.com/ejunjsh/c-code/tree/master/epoll" target="_blank" rel="noopener">é“¾æ¥</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ET&quot;&gt;&lt;a href=&quot;#ET&quot; class=&quot;headerlink&quot; title=&quot;ET&quot;&gt;&lt;/a&gt;ET&lt;/h1&gt;&lt;p&gt;Edge Triggered (ET) è¾¹ç¼˜è§¦å‘åªæœ‰æ•°æ®åˆ°æ¥,æ‰è§¦å‘,ä¸ç®¡ç¼“å­˜åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;LT(level triggered)æ˜¯ç¼ºçœçš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒblock(é˜»å¡)å’Œno-block(éé˜»å¡) socket.åœ¨è¿™ç§åšæ³•ä¸­ï¼Œå†…æ ¸å‘Šè¯‰ä½ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªäº†ï¼Œç„¶åä½ å¯ä»¥å¯¹è¿™ä¸ªå°±ç»ªçš„fdè¿›è¡ŒIOæ“ä½œã€‚å¦‚æœä½ ä¸ä½œä»»ä½•æ“ä½œï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­é€šçŸ¥ä½ çš„ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ¨¡å¼ç¼–ç¨‹å‡ºé”™è¯¯å¯èƒ½æ€§è¦å°ä¸€ç‚¹ã€‚ä¼ ç»Ÿçš„select/polléƒ½æ˜¯è¿™ç§æ¨¡å‹çš„ä»£è¡¨ï¼&lt;/p&gt;
&lt;p&gt;ä¼˜ç‚¹ï¼šå½“è¿›è¡Œsocketé€šä¿¡çš„æ—¶å€™ï¼Œä¿è¯äº†æ•°æ®çš„å®Œæ•´è¾“å‡ºï¼Œè¿›è¡ŒIOæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœè¿˜æœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´çš„é€šçŸ¥ä½ ã€‚&lt;/p&gt;
&lt;p&gt;ç¼ºç‚¹ï¼šç”±äºåªè¦è¿˜æœ‰æ•°æ®ï¼Œå†…æ ¸å°±ä¼šä¸åœçš„ä»å†…æ ¸ç©ºé—´è½¬åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæ‰€æœ‰å ç”¨äº†å¤§é‡å†…æ ¸èµ„æºï¼Œè¯•æƒ³ä¸€ä¸‹å½“æœ‰å¤§é‡æ•°æ®åˆ°æ¥çš„æ—¶å€™ï¼Œæ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±ä¼šä¸åœçš„è¿›è¡Œåˆ‡æ¢ã€‚å†…æ ¸èµ„æºçš„æµªè´¹ä¸¥é‡ã€‚æ•ˆç‡æ¥è®²ä¹Ÿæ˜¯å¾ˆä½çš„ã€‚&lt;/p&gt;
&lt;h1 id=&quot;LT&quot;&gt;&lt;a href=&quot;#LT&quot; class=&quot;headerlink&quot; title=&quot;LT&quot;&gt;&lt;/a&gt;LT&lt;/h1&gt;&lt;p&gt;Level Triggered (LT) æ°´å¹³è§¦å‘åªè¦æœ‰æ•°æ®éƒ½ä¼šè§¦å‘ã€‚&lt;/p&gt;
&lt;p&gt;ET(edge-triggered)æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒno-block socketã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰ä½ ã€‚ç„¶åå®ƒä¼šå‡è®¾ä½ çŸ¥é“æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œå¹¶ä¸”ä¸ä¼šå†ä¸ºé‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦å‘é€æ›´å¤šçš„å°±ç»ªé€šçŸ¥ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä¸€ç›´ä¸å¯¹è¿™ä¸ªfdä½œIOæ“ä½œ(ä»è€Œå¯¼è‡´å®ƒå†æ¬¡å˜æˆæœªå°±ç»ª)ï¼Œå†…æ ¸ä¸ä¼šå‘é€æ›´å¤šçš„é€šçŸ¥(only once).&lt;/p&gt;
&lt;p&gt;ä¼˜ç‚¹ï¼šæ¯æ¬¡å†…æ ¸åªä¼šé€šçŸ¥ä¸€æ¬¡ï¼Œå¤§å¤§å‡å°‘äº†å†…æ ¸èµ„æºçš„æµªè´¹ï¼Œæé«˜æ•ˆç‡ã€‚&lt;/p&gt;
&lt;p&gt;ç¼ºç‚¹ï¼šä¸èƒ½ä¿è¯æ•°æ®çš„å®Œæ•´ã€‚ä¸èƒ½åŠæ—¶çš„å–å‡ºæ‰€æœ‰çš„æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;åº”ç”¨åœºæ™¯ï¼š å¤„ç†å¤§æ•°æ®ã€‚ä½¿ç”¨non-block(éé˜»å¡)æ¨¡å¼çš„socketã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="c" scheme="http://idiotsky.top/categories/c/"/>
    
    
      <category term="c" scheme="http://idiotsky.top/tags/c/"/>
    
      <category term="epoll" scheme="http://idiotsky.top/tags/epoll/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥goä¹‹goroutine</title>
    <link href="http://idiotsky.top/2018/08/12/go-goroutine/"/>
    <id>http://idiotsky.top/2018/08/12/go-goroutine/</id>
    <published>2018-08-12T11:56:31.000Z</published>
    <updated>2018-08-12T13:25:03.801Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>goroutineæ˜¯goçš„æ ¸å¿ƒï¼Œæ²¡æœ‰goroutineï¼Œgoå°±æ²¡ä»€ä¹ˆæ„æ€äº†ğŸ‘¿ã€‚goroutineç¦»ä¸å¼€åç¨‹ï¼Œçº¿ç¨‹å’Œå¹¶å‘ï¼Œæ‰€ä»¥ä¸‹é¢ä¼šè¯´è¯´ç›¸å…³çš„å†…å®¹ã€‚</p>
</blockquote>
<h1 id="åç¨‹"><a href="#åç¨‹" class="headerlink" title="åç¨‹"></a>åç¨‹</h1><p>åç¨‹(coroutine)å…¶å®å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ–¹æ³•æˆ–è€…ä¾‹ç¨‹ï¼ˆroutineï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹å‡½æ•°éƒ½æ˜¯åœ¨ç”¨æˆ·çº¿ç¨‹ä¸‹é¢æ‰§è¡Œçš„ï¼Œçº¿ç¨‹çš„è°ƒåº¦ç”±å†…æ ¸è§¦å‘ï¼Œæ‰€ä»¥å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹æ²¡åŠæ³•æ§åˆ¶å‡½æ•°çš„æ‰§è¡Œè°ƒåº¦ï¼Œåªèƒ½ä»»ç”±å†…æ ¸ä¸»å®°ã€‚åç¨‹å°±ä¸åŒï¼Œå®ƒå¯ä»¥ç”±ç”¨æˆ·çº¿ç¨‹æ§åˆ¶è°ƒåº¦ï¼Œåœ¨ä»»ä½•æ—¶å€™è°ƒåº¦åç¨‹çš„æ‰§è¡Œã€‚å‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œå†…æ ¸è°ƒåº¦ä¼šé™·å…¥å†…æ ¸å¹¶ä¿å­˜å½“å‰çº¿ç¨‹çš„æ ˆå’Œä¸Šä¸‹æ–‡ï¼Œç„¶åæ¢å¤ä¹‹å‰è¢«åœæ­¢çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œä»£ä»·æ¯”è¾ƒé«˜ã€‚è€Œåç¨‹çš„è°ƒåº¦ï¼Œä¸ç”¨é™·å…¥å†…æ ¸ï¼Œç”¨æˆ·çº¿ç¨‹åªæ˜¯ä¿å­˜å½“å‰åç¨‹çš„æ ˆå’Œä¸Šä¸‹æ–‡ï¼Œæ¢å¤ä¹‹å‰çš„è¢«åœæ­¢åç¨‹ç»§ç»­æ‰§è¡Œã€‚</p>
<p>è¿˜æœ‰ç§è¯´æ³•æ˜¯è¯´å‡½æ•°æ˜¯åç¨‹çš„ä¸€ç§ç‰¹ä¾‹ã€‚å› ä¸ºå‡½æ•°åªæœ‰åœ¨returnè¯­å¥æ‰ä¼šè¿”å›ï¼Œè€Œåç¨‹å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»è¿”å›ã€‚</p>
<p>åç¨‹å¾ˆæ—©å°±æå‡ºæ¥äº†ï¼Œå¯æ˜¯åœ¨ç°åœ¨æ‰ç«èµ·æ¥å§ï¼Œå¤§æ¦‚ç”±äºæŸç§è¯­è¨€ï¼ˆluaï¼‰çš„å¹¿æ³›ä½¿ç”¨å§ã€‚è€Œgoæ›´æ˜¯æŠŠåç¨‹ç”¨åˆ°åº•ï¼ŒåŸºæœ¬å¯ä»¥ç†è§£goçš„æ‰€æœ‰ä»£ç éƒ½è·‘åœ¨åç¨‹ä¸‹ï¼Œå¹¶ç”¨goroutineæ¥ä»£è¡¨å®ƒè‡ªå·±çš„åç¨‹ã€‚<br><a id="more"></a></p>
<h1 id="åç¨‹-vs-çº¿ç¨‹"><a href="#åç¨‹-vs-çº¿ç¨‹" class="headerlink" title="åç¨‹ vs çº¿ç¨‹"></a>åç¨‹ vs çº¿ç¨‹</h1><p>çº¿ç¨‹æ˜¯å¤„ç†å™¨è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œåœ¨CPUåˆ‡åˆ†æ—¶é—´ç‰‡çš„å‰æä¸‹ï¼Œæ“ä½œç³»ç»Ÿè¿›è¡ŒæŠ¢å å¼è°ƒåº¦ã€‚</p>
<p>åç¨‹ä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ç§æ›´å°çš„è°ƒåº¦åŸºæœ¬å•ä½ã€‚å®ƒç”±è¿è¡Œåœ¨ç”¨æˆ·çº¿ç¨‹çš„è°ƒåº¦å™¨æ¥è°ƒåº¦ã€‚</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>è°ƒåº¦</th>
<th>å†…å­˜æ¶ˆè€—</th>
<th>åˆ‡æ¢ä»£ä»·</th>
</tr>
</thead>
<tbody>
<tr>
<td>çº¿ç¨‹</td>
<td>å†…æ ¸è¿›è¡Œè°ƒåº¦</td>
<td>è¾ƒå¤§ï¼ˆ1MB~8MBï¼‰</td>
<td>é™·å…¥å†…æ ¸ï¼Œå„ç§å¯„å­˜å™¨çš„ä¿å­˜å’Œåˆ·æ–°</td>
</tr>
<tr>
<td>åç¨‹</td>
<td>ç”¨æˆ·çº¿ç¨‹è°ƒåº¦</td>
<td>è¾ƒå°ï¼ˆ2KB~5KBï¼‰</td>
<td>å„ç§å¯„å­˜å™¨çš„ä¿å­˜å’Œåˆ·æ–°</td>
</tr>
</tbody>
</table>
<p>ä»ä¸Šè¡¨å¯ä»¥å‘ç°ï¼Œçº¿ç¨‹æ¯”åç¨‹æ›´åŠ è€—è´¹å†…å­˜ï¼Œè€Œä¸”è¿˜ä¼šé€ æˆé™·å…¥å†…æ ¸ã€‚ä½†æ˜¯åç¨‹çš„åˆ‡æ¢å®Œå…¨äº¤ç»™ç”¨æˆ·çº¿ç¨‹æ¥è°ƒåº¦ï¼Œè¿™ä¸ªå¢åŠ äº†å®ç°çš„éš¾åº¦ã€‚è¿˜æœ‰å°±æ˜¯åç¨‹çš„è°ƒåº¦æ˜¯ç”±å•ä¸ªçº¿ç¨‹è°ƒåº¦ï¼Œå¦‚æœå¤„ç†å™¨æ˜¯å¤šæ ¸çš„è¯ï¼Œæ²¡åŠæ³•å……åˆ†åˆ©ç”¨ã€‚å¾ˆåº†å¹¸çš„æ˜¯ï¼Œgoå·²ç»å®ç°äº†å®ƒè‡ªå·±çš„åç¨‹è°ƒåº¦é€»è¾‘ï¼Œå¹¶ä¸”å……åˆ†åˆ©ç”¨å¤šçº¿ç¨‹æ¥è°ƒåº¦goroutineã€‚</p>
<h1 id="è¦åç¨‹ä½•ç”¨ï¼Ÿ"><a href="#è¦åç¨‹ä½•ç”¨ï¼Ÿ" class="headerlink" title="è¦åç¨‹ä½•ç”¨ï¼Ÿ"></a>è¦åç¨‹ä½•ç”¨ï¼Ÿ</h1><p>åç¨‹èƒ½ç«ä¹Ÿæ˜¯æœ‰å„ç§ç†ç”±çš„ã€‚</p>
<ul>
<li>é«˜å¹¶å‘å¤„ç†ã€‚åœ¨ç”¨æˆ·ç©ºé—´åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œä¸ç”¨é™·å…¥å†…æ ¸æ¥åšçº¿ç¨‹åˆ‡æ¢ï¼Œé¿å…ä¸å¿…è¦ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®æ‹·è´ã€‚</li>
<li>ç”¨åŒæ­¥çš„æ–¹å¼å»å†™å¼‚æ­¥ä»£ç ï¼Œé«˜æ•ˆç‡ä¸”ä¸å®¹æ˜“å‡ºé”™ (nodejsé‡Œé¢çš„asyn/awaitï¼Œå°±æ˜¯è¿™ç§)</li>
<li>éæŠ¢å å¼æ¨¡å‹ï¼Œèƒ½æ§åˆ¶ä¸­æ–­ä½ç½®ï¼Œä¸ä¼šå‘ç”Ÿç”±äºå¼ºè¡Œåˆ‡æ¢çº¿ç¨‹å¯¼è‡´çš„èµ„æºç«äº‰ã€‚(æç«¯æƒ…å†µä¸‹è¿˜æ˜¯ä¼šæ‰§è¡ŒæŠ¢å ï¼Œé˜²æ­¢åç¨‹é•¿æ—¶é—´å ç”¨CPUï¼Œä½†è¿™ä¸æ˜¯æ ‡å‡†æŠ¢å å¼æ¨¡å‹ï¼‰</li>
</ul>
<h1 id="å¹¶å‘-VS-å¹¶è¡Œ"><a href="#å¹¶å‘-VS-å¹¶è¡Œ" class="headerlink" title="å¹¶å‘ VS å¹¶è¡Œ"></a>å¹¶å‘ VS å¹¶è¡Œ</h1><p>å…ˆä¸Šå›¾ï¼š</p>
<p><a href="http://idiotsky.top/images2/go-goroutine.jpg"><img src="http://idiotsky.top/images2/go-goroutine.jpg" alt=""></a></p>
<ul>
<li>å¹¶å‘ï¼šå¤„ç†å™¨è¢«åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªæ—¶é—´åˆ†ç‰‡ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨å¤„ç†å™¨ä¸­äº¤æ›¿æ‰§è¡Œï¼ŒåŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«æ‰§è¡Œï¼ˆé€šç”¨åœ°æ¥è¯´ï¼Œæ”¯æŒå¹¶å‘æ˜¯ä¸€ç§ç³»ç»Ÿæ‹¥æœ‰äº¤æ›¿æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„èƒ½åŠ›çš„è¡¨ç°ï¼‰</li>
<li>å¹¶è¡Œï¼šå¤šä¸ªçº¿ç¨‹ï¼Œåœ¨å¤šä¸ªå¤„ç†å™¨ä¸ŠåŒæ—¶æ‰§è¡Œã€‚</li>
</ul>
<blockquote>
<p>ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼ŒåŒ»é™¢è¯Šå®¤çœ‹ç—…ã€‚æŠŠç—…äººå½“åšçº¿ç¨‹ï¼ŒåŒ»ç”Ÿå½“åšå¤„ç†å™¨ã€‚</p>
</blockquote>
<blockquote>
<p>å¹¶å‘ï¼šåªæœ‰ä¸€ä¸ªåŒ»ç”Ÿï¼Œç—…äººAçœ‹äº†ä¸€ä¼šå„¿ï¼ŒåŒ»ç”Ÿè®©ä»–ä¸‹æ¥¼æ‹Xå…‰ï¼Œç„¶åç—…äººBè¿›æ¥çœ‹è¯Šï¼Œä¹‹ååŒ»ç”Ÿè®©Bå»åšå½©è¶…ï¼Œç„¶åAæ­¤æ—¶å›æ¥äº†ï¼ŒåŒ»ç”Ÿç»§ç»­ç»™Açœ‹ç—…ã€‚ï¼ˆä»»æ„ç¬é—´ï¼ŒåŒ»ç”Ÿåªåœ¨ç»™å…¶ä¸­ä¸€ä¸ªäººçœ‹ç—…ï¼‰</p>
</blockquote>
<blockquote>
<p>å¹¶è¡Œï¼š æœ‰3ä¸ªåŒ»ç”Ÿï¼Œ3ä¸ªç—…äººï¼Œä¸€ä¸ªç—…äººå¯¹åº”ä¸€ä¸ªåŒ»ç”Ÿï¼ŒåŒæ—¶é—®è¯Šã€‚</p>
</blockquote>
<p>å¦‚æœå¹¶å‘äº¤æ›¿çš„é€Ÿåº¦å¤Ÿå¿«ï¼Œå°±èƒ½è¾¾åˆ°â€œé€»è¾‘å¹¶è¡Œâ€çš„æ•ˆæœï¼Œå¯¹å¤–çœ‹èµ·æ¥å°±å’Œå¹¶è¡Œä¸€æ ·ã€‚</p>
<p>å¹¶å‘æ‰§è¡Œå¤šçº¿ç¨‹å¹¶ä¸èƒ½çœŸçš„å……åˆ†åˆ©ç”¨CPUï¼Œè¾¾åˆ°å‡å°‘å•ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶é—´çš„æ•ˆæœï¼Œè¿™ç§äº¤æ›¿æŒ‚èµ·æ‰§è¡Œçš„æ–¹å¼å´èƒ½å¤Ÿç»™ç”¨æˆ·å¸¦æ¥æ¯ä¸ªçº¿ç¨‹éƒ½åœ¨â€åŒæ—¶æ‰§è¡Œâ€œçš„æ„Ÿè§‰ï¼Œä»è€Œå¢å¼ºäº†æœåŠ¡çš„å“åº”é€Ÿåº¦ã€‚å°±åƒä¸Šé¢ä¾‹å­ä¸­çš„ç—…äººBä¸ç”¨ä¸€ç›´æ’é˜Ÿç­‰å¾… Aæ‹å®ŒXå…‰å¹¶ä¸”åŒ»ç”Ÿç¡®å®šAçš„ç—…çœ‹å®Œäº† æ‰èƒ½å»çœ‹ç—…ã€‚</p>
<h1 id="è°ƒåº¦"><a href="#è°ƒåº¦" class="headerlink" title="è°ƒåº¦"></a>è°ƒåº¦</h1><p>goroutineçš„è°ƒåº¦å¯ä»¥ç†è§£ä¸ºå¤šçº¿ç¨‹è°ƒåº¦åç¨‹ï¼ˆgoroutineï¼‰ã€‚æ‰€ä»¥è¿™é‡Œè°ƒåº¦ä¼šæœ‰ä¸‰ä¸ªè§’è‰²ï¼šçº¿ç¨‹ï¼Œè°ƒåº¦å™¨ï¼Œåç¨‹ã€‚å®ƒä»¬åˆ†åˆ«ç”¨M,P,Gæ¥è¡¨ç¤ºå§ã€‚</p>
<p><a href="http://idiotsky.top/images2/go-goroutine-1.jpg"><img src="http://idiotsky.top/images2/go-goroutine-1.jpg" alt=""></a></p>
<ul>
<li>G: è¡¨ç¤ºgoroutineï¼Œå­˜å‚¨äº†goroutineçš„æ‰§è¡Œstackä¿¡æ¯ã€goroutineçŠ¶æ€ä»¥åŠgoroutineçš„ä»»åŠ¡å‡½æ•°ç­‰ï¼›å¦å¤–Gå¯¹è±¡æ˜¯å¯ä»¥é‡ç”¨çš„ã€‚</li>
<li>P: è¡¨ç¤ºé€»è¾‘processorï¼ŒPçš„æ•°é‡å†³å®šäº†ç³»ç»Ÿå†…æœ€å¤§å¯å¹¶è¡Œçš„Gçš„æ•°é‡ï¼ˆå‰æï¼šç³»ç»Ÿçš„ç‰©ç†cpuæ ¸æ•°&gt;=Pçš„æ•°é‡ï¼ŒGOMAXPROCSç¯å¢ƒå˜é‡ä»£è¡¨çš„ä¸ªæ•°æ˜¯Pçš„ä¸ªæ•°ï¼Œæ¨èå€¼ä¸ºCPUçš„æ ¸å¿ƒæ•°ï¼‰ï¼›Pçš„æœ€å¤§ä½œç”¨è¿˜æ˜¯å…¶æ‹¥æœ‰çš„å„ç§Gå¯¹è±¡é˜Ÿåˆ—ã€é“¾è¡¨ã€ä¸€äº›cacheå’ŒçŠ¶æ€ã€‚</li>
<li>M: Mä»£è¡¨ç€çœŸæ­£çš„æ‰§è¡Œè®¡ç®—èµ„æºã€‚åœ¨ç»‘å®šæœ‰æ•ˆçš„påï¼Œè¿›å…¥scheduleå¾ªç¯ï¼›è€Œscheduleå¾ªç¯çš„æœºåˆ¶å¤§è‡´æ˜¯ä»å„ç§é˜Ÿåˆ—ã€pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–Gï¼Œåˆ‡æ¢åˆ°Gçš„æ‰§è¡Œæ ˆä¸Šå¹¶æ‰§è¡ŒGçš„å‡½æ•°ï¼Œè°ƒç”¨goexitåšæ¸…ç†å·¥ä½œå¹¶å›åˆ°mï¼Œå¦‚æ­¤åå¤ã€‚Må¹¶ä¸ä¿ç•™GçŠ¶æ€ï¼Œè¿™æ˜¯Gå¯ä»¥è·¨Mè°ƒåº¦çš„åŸºç¡€ã€‚</li>
</ul>
<p><strong>ä¸‹é¢æ˜¯Gã€Pã€Må®šä¹‰çš„ä»£ç ç‰‡æ®µï¼š</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/runtime/runtime2.go</span></span><br><span class="line"><span class="keyword">type</span> g <span class="keyword">struct</span> &#123;</span><br><span class="line">        stack      stack   <span class="comment">// offset known to runtime/cgo</span></span><br><span class="line">        sched     gobuf</span><br><span class="line">        goid        <span class="keyword">int64</span></span><br><span class="line">        gopc       <span class="keyword">uintptr</span> <span class="comment">// pc of go statement that created this goroutine</span></span><br><span class="line">        startpc    <span class="keyword">uintptr</span> <span class="comment">// pc of goroutine function</span></span><br><span class="line">        ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> p <span class="keyword">struct</span> &#123;</span><br><span class="line">    lock mutex</span><br><span class="line"></span><br><span class="line">    id          <span class="keyword">int32</span></span><br><span class="line">    status      <span class="keyword">uint32</span> <span class="comment">// one of pidle/prunning/...</span></span><br><span class="line"></span><br><span class="line">    mcache      *mcache</span><br><span class="line">    racectx     <span class="keyword">uintptr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queue of runnable goroutines. Accessed without lock.</span></span><br><span class="line">    runqhead <span class="keyword">uint32</span></span><br><span class="line">    runqtail <span class="keyword">uint32</span></span><br><span class="line">    runq     [<span class="number">256</span>]guintptr</span><br><span class="line"></span><br><span class="line">    runnext guintptr</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Available G's (status == Gdead)</span></span><br><span class="line">    gfree    *g</span><br><span class="line">    gfreecnt <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> m <span class="keyword">struct</span> &#123;</span><br><span class="line">    g0      *g     <span class="comment">// goroutine with scheduling stack</span></span><br><span class="line">    mstartfn      <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="title">curg</span>          *<span class="title">g</span>       // <span class="title">current</span> <span class="title">running</span> <span class="title">goroutine</span></span></span><br><span class="line"><span class="function"> .... ..</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><a href="http://idiotsky.top/images2/go-goroutine-2.jpg"><img src="http://idiotsky.top/images2/go-goroutine-2.jpg" alt=""></a></p>
<p>ä¸Šå›¾æ˜¯2ä¸ªMï¼ˆçº¿ç¨‹ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªå¤„ç†å™¨ï¼ˆPï¼‰ï¼ŒMæ˜¯å¿…é¡»å…³è”Pæ‰èƒ½æ‰§è¡Œåç¨‹ï¼ˆGï¼‰çš„ã€‚å›¾ä¸­è“Gä»£è¡¨çš„æ˜¯è¿è¡Œä¸­çš„goroutineï¼Œç°Gè¡¨ç¤ºçš„å¾…æ‰§è¡Œçš„Goroutineï¼Œå¾…æ‰§è¡Œçš„Goroutineå­˜å‚¨åœ¨ P ä¸­çš„ä¸€ä¸ªå±€éƒ¨é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶Pæ‰§è¡ŒGoroutineä¼šè¿™ä¸ªé˜Ÿåˆ—ä¸­å–ï¼Œä¸ç”¨åŠ é”ï¼Œæé«˜äº†å¹¶å‘åº¦ã€‚ï¼ˆGo1.0ç‰ˆæœ¬ä¸­ï¼Œè°ƒåº¦å™¨å–Goroutineæ˜¯å»ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­å–ï¼Œéœ€è¦åŠ é”ï¼Œçº¿ç¨‹ä¼šç»å¸¸é˜»å¡ç­‰å¾…é”ï¼‰</p>
<p>ä¸‹é¢æ›´åŠ æ¸…æ™°è¯´æ˜æ•´ä¸ªç»“æ„</p>
<p><a href="http://idiotsky.top/images2/go-goroutine-5.png"><img src="http://idiotsky.top/images2/go-goroutine-5.png" alt=""></a></p>
<p><strong>å¦‚æœå…¶ä¸­ä¸€ä¸ªGæ‰§è¡Œçš„æ—¶å€™ï¼Œå‘ç”Ÿäº†ç³»ç»Ÿè°ƒç”¨ï¼Œé˜»å¡äº†æ€ä¹ˆåŠï¼Ÿ</strong></p>
<p><a href="http://idiotsky.top/images2/go-goroutine-3.jpg"><img src="http://idiotsky.top/images2/go-goroutine-3.jpg" alt=""></a></p>
<p>ä¸Šå›¾å·¦è¾¹ï¼ŒG0ä¸­é™·å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¼è‡´M0é˜»å¡ã€‚</p>
<p>æ­¤æ—¶ï¼ŒM0æ”¾å¼ƒäº†å®ƒçš„Pï¼Œè®©M1å»å¤„ç†Pä¸­å‰©ä¸‹çš„Goroutineã€‚è¿™é‡Œçš„M1å¯èƒ½æ˜¯åœ¨çº¿ç¨‹ç¼“å­˜ä¸­å–çš„ï¼Œæˆ–è€…è¿è¡Œä¸­ç”Ÿæˆçš„ã€‚</p>
<p>å½“M0ä»ç³»ç»Ÿè°ƒç”¨ä¸­æ¢å¤ï¼Œå®ƒä¼šå»åˆ«çš„Mä¸­æ‰¾Pæ¥æ‰§è¡ŒG0ï¼ˆæ¯”å¦‚è¯´åˆ«çš„Mé˜»å¡ä¸¢å‡ºäº†Pï¼‰ï¼Œå¦‚æœæ²¡æœ‰Pï¼Œé‚£ä¹ˆå®ƒä¼šæŠŠG0æ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠŠå®ƒè‡ªå·±æ”¾åˆ°çº¿ç¨‹ç¼“å­˜ä¸­ã€‚</p>
<p>å…¨å±€é˜Ÿåˆ—ä¿å­˜äº†Goroutineï¼Œå½“å„è‡ªPä¸­çš„å±€éƒ¨é˜Ÿåˆ—æ²¡æœ‰Goroutineæ—¶ï¼ŒPä¼šåˆ°å…¨å±€é˜Ÿåˆ—ä¸­å–Goroutineã€‚å¹¶ä¸”å³ä½¿Pä¸­å±€éƒ¨é˜Ÿåˆ—æœ‰Goroutineï¼Œä¹Ÿä¼šå‘¨æœŸæ€§åœ°ä»å…¨å±€é˜Ÿåˆ—ä¸­å–Goroutineï¼Œä¿æŒå…¨å±€é˜Ÿåˆ—ä¸­çš„Goroutineèƒ½å¤Ÿå°½å¿«è¢«æ‰§è¡Œã€‚</p>
<p>å¤„ç†ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿæ˜¯goç¨‹åºä¸ºä»€ä¹ˆè·‘åœ¨å¤šçº¿ç¨‹ä¸Šçš„ä¸€ä¸ªåŸå› ï¼Œå³ä½¿GOMAXPROCSæ˜¯1ï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰å¤šä¸ªå·¥ä½œçº¿ç¨‹ã€‚</p>
<p><strong>å½“På±€éƒ¨é˜Ÿåˆ—ä¸å‡è¡¡æ—¶æ€ä¹ˆå¤„ç†ï¼Ÿå¦‚æœæœ‰å¤šä¸ªPï¼Œå…¶ä¸­ä¸€ä¸ªPçš„å±€éƒ¨é˜Ÿåˆ—Goroutineæ‰§è¡Œå®Œäº†ã€‚</strong></p>
<p><a href="http://idiotsky.top/images2/go-goroutine-4.jpg"><img src="http://idiotsky.top/images2/go-goroutine-4.jpg" alt=""></a></p>
<p>å¦‚æœä¸€ä¸ªPå±€éƒ¨é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆå®ƒå°è¯•ä»å…¨å±€é˜Ÿåˆ—ä¸­å–Goroutineï¼Œå¦‚å…¨å±€é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šéšæœºä»å…¶å®ƒPçš„å±€éƒ¨é˜Ÿåˆ—ä¸­â€œæŒªâ€ä¸€åŠGoroutineåˆ°è‡ªå·±çš„é˜Ÿåˆ—å½“ä¸­ï¼Œ ä»¥ä¿è¯æ‰€æœ‰çš„Méƒ½æ˜¯æœ‰ä»»åŠ¡æ‰§è¡Œçš„ï¼Œé—´æ¥åšåˆ°è´Ÿè½½å‡è¡¡ï¼ˆå¯ä»¥å‚è€ƒgoæºç çš„findrunnable()å‡½æ•° ï¼‰</p>
<p><strong>channelé˜»å¡æ€ä¹ˆåŠ</strong></p>
<p>å¦‚æœGè¢«é˜»å¡åœ¨æŸä¸ªchannelæ“ä½œä¸Šæ—¶ï¼ŒGä¼šè¢«æ”¾ç½®åˆ°æŸä¸ªwaité˜Ÿåˆ—ä¸­ï¼Œè€ŒMä¼šå°è¯•è¿è¡Œä¸‹ä¸€ä¸ªrunnableçš„Gï¼›å¦‚æœæ­¤æ—¶æ²¡æœ‰runnableçš„Gä¾›mè¿è¡Œï¼Œé‚£ä¹ˆmå°†è§£ç»‘Pï¼Œå¹¶è¿›å…¥sleepçŠ¶æ€ã€‚å½“channelæ“ä½œå®Œæˆï¼Œåœ¨waité˜Ÿåˆ—ä¸­çš„Gä¼šè¢«å”¤é†’ï¼Œæ ‡è®°ä¸ºrunnableï¼Œæ”¾å…¥åˆ°æŸPçš„é˜Ÿåˆ—ä¸­ï¼Œç»‘å®šä¸€ä¸ªMç»§ç»­æ‰§è¡Œã€‚</p>
<p><strong>ç½‘ç»œI/Oå’Œæ–‡ä»¶I/Oæ€ä¹ˆåŠ</strong></p>
<p>Go runtimeå·²ç»å®ç°äº†<a href="http://morsmachine.dk/netpoller" target="_blank" rel="noopener">netpoller</a>ï¼Œè¿™ä½¿å¾—å³ä¾¿Gå‘èµ·ç½‘ç»œI/Oæ“ä½œä¹Ÿä¸ä¼šå¯¼è‡´Mè¢«é˜»å¡ï¼ˆä»…é˜»å¡Gï¼‰ï¼Œä»è€Œä¸ä¼šå¯¼è‡´å¤§é‡Mè¢«åˆ›å»ºå‡ºæ¥ã€‚ä½†æ˜¯å¯¹äºregular fileçš„I/Oæ“ä½œä¸€æ—¦é˜»å¡ï¼Œé‚£ä¹ˆMå°†è¿›å…¥sleepçŠ¶æ€ï¼Œç­‰å¾…I/Oè¿”å›åè¢«å”¤é†’ï¼›è¿™ç§æƒ…å†µä¸‹På°†ä¸sleepçš„Måˆ†ç¦»ï¼Œå†é€‰æ‹©ä¸€ä¸ªidleçš„Mã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰idleçš„Mï¼Œåˆ™ä¼šæ–°åˆ›å»ºä¸€ä¸ªMï¼Œè¿™å°±æ˜¯ä¸ºä½•å¤§é‡I/Oæ“ä½œå¯¼è‡´å¤§é‡Threadè¢«åˆ›å»ºçš„åŸå› ã€‚</p>
<p><strong>é‡åˆ°é”æ€ä¹ˆåŠ</strong></p>
<p>goçš„é”ä¸æ˜¯ç³»ç»Ÿçº§åˆ«çš„MUTEXé”ï¼Œè€Œæ˜¯è½»é‡çº§çš„CASé”ï¼Œæ‰€ä»¥æŠ¢é”å¤±è´¥ä¸ä¼šé˜»å¡Mï¼Œè€Œæ˜¯é˜»å¡G(é˜»å¡ä¹‹å‰è¿˜è‡ªæ—‹ä¸€ä¸‹çœ‹çœ‹èƒ½ä¸èƒ½å†æŠ¢åˆ°é”)ï¼Œç„¶åè¿™ä¸ªGå°±ä¼šè¢«æ­£å¸¸çš„è°ƒåº¦å‡ºå»ï¼Œåœ¨æŸä¸ªæ—¶åˆ»åˆè°ƒåº¦å›æ¥ç»§ç»­æŠ¢é”ã€‚</p>
<p><strong>å¦‚æœä¸€ä¸ªPè¿ç»­æ‰§è¡Œé•¿æ—¶é—´ï¼Œæ²¡æœ‰åˆ‡æ¢Gï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ</strong></p>
<p>å’Œæ“ä½œç³»ç»ŸæŒ‰æ—¶é—´ç‰‡è°ƒåº¦çº¿ç¨‹ä¸åŒï¼ŒGoå¹¶æ²¡æœ‰æ—¶é—´ç‰‡çš„æ¦‚å¿µã€‚å¦‚æœæŸä¸ªGæ²¡æœ‰è¿›è¡Œsystem callè°ƒç”¨ã€æ²¡æœ‰è¿›è¡ŒI/Oæ“ä½œã€æ²¡æœ‰é˜»å¡åœ¨ä¸€ä¸ªchannelæ“ä½œä¸Šï¼Œé‚£ä¹ˆmæ˜¯å¦‚ä½•è®©Gåœä¸‹æ¥å¹¶è°ƒåº¦ä¸‹ä¸€ä¸ªrunnable Gçš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š<strong>Gæ˜¯è¢«æŠ¢å è°ƒåº¦çš„</strong>ã€‚</p>
<p>é™¤éæç«¯çš„æ— é™å¾ªç¯æˆ–æ­»å¾ªç¯ï¼Œå¦åˆ™åªè¦Gè°ƒç”¨å‡½æ•°ï¼ŒGo runtimeå°±æœ‰æŠ¢å Gçš„æœºä¼šã€‚Goç¨‹åºå¯åŠ¨æ—¶ï¼Œruntimeä¼šå»å¯åŠ¨ä¸€ä¸ªåä¸ºsysmonçš„m(ä¸€èˆ¬ç§°ä¸ºç›‘æ§çº¿ç¨‹)ï¼Œè¯¥mæ— éœ€ç»‘å®špå³å¯è¿è¡Œï¼Œè¯¥måœ¨æ•´ä¸ªGoç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­è‡³å…³é‡è¦ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$GOROOT/src/runtime/proc.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The main goroutine.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">     ... ...</span><br><span class="line">    systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        newm(sysmon, <span class="literal">nil</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Always runs without a P, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sysmon</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// If a heap span goes unused for 5 minutes after a garbage collection,</span></span><br><span class="line">    <span class="comment">// we hand it back to the operating system.</span></span><br><span class="line">    scavengelimit := <span class="keyword">int64</span>(<span class="number">5</span> * <span class="number">60</span> * <span class="number">1e9</span>)</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>  .... &#123;</span><br><span class="line">        ... ...</span><br><span class="line">        <span class="comment">// retake P's blocked in syscalls</span></span><br><span class="line">        <span class="comment">// and preempt long running G's</span></span><br><span class="line">        <span class="keyword">if</span> retake(now) != <span class="number">0</span> &#123;</span><br><span class="line">            idle = <span class="number">0</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            idle++</span><br><span class="line">        &#125;</span><br><span class="line">       ... ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sysmonæ¯20us~10mså¯åŠ¨ä¸€æ¬¡ï¼ŒæŒ‰ç…§ã€ŠGoè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹ä¸­çš„æ€»ç»“ï¼Œsysmonä¸»è¦å®Œæˆå¦‚ä¸‹å·¥ä½œï¼š</p>
<ul>
<li>é‡Šæ”¾é—²ç½®è¶…è¿‡5åˆ†é’Ÿçš„spanç‰©ç†å†…å­˜ï¼›</li>
<li>å¦‚æœè¶…è¿‡2åˆ†é’Ÿæ²¡æœ‰åƒåœ¾å›æ”¶ï¼Œå¼ºåˆ¶æ‰§è¡Œï¼›</li>
<li>å°†é•¿æ—¶é—´æœªå¤„ç†çš„netpollç»“æœæ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼›</li>
<li>å‘é•¿æ—¶é—´è¿è¡Œçš„Gä»»åŠ¡å‘å‡ºæŠ¢å è°ƒåº¦ï¼›</li>
<li>æ”¶å›å› syscallé•¿æ—¶é—´é˜»å¡çš„Pï¼›</li>
</ul>
<p>æˆ‘ä»¬çœ‹åˆ°sysmonå°†â€œå‘é•¿æ—¶é—´è¿è¡Œçš„Gä»»åŠ¡å‘å‡ºæŠ¢å è°ƒåº¦â€ï¼Œè¿™ä¸ªäº‹æƒ…ç”±retakeå®æ–½ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// forcePreemptNS is the time slice given to a G before it is</span></span><br><span class="line"><span class="comment">// preempted.</span></span><br><span class="line"><span class="keyword">const</span> forcePreemptNS = <span class="number">10</span> * <span class="number">1000</span> * <span class="number">1000</span> <span class="comment">// 10ms</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">retake</span><span class="params">(now <span class="keyword">int64</span>)</span> <span class="title">uint32</span></span> &#123;</span><br><span class="line">          ... ...</span><br><span class="line">           <span class="comment">// Preempt G if it's running for too long.</span></span><br><span class="line">            t := <span class="keyword">int64</span>(_p_.schedtick)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">int64</span>(pd.schedtick) != t &#123;</span><br><span class="line">                pd.schedtick = <span class="keyword">uint32</span>(t)</span><br><span class="line">                pd.schedwhen = now</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> pd.schedwhen+forcePreemptNS &gt; now &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            preemptone(_p_)</span><br><span class="line">         ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸€ä¸ªGä»»åŠ¡è¿è¡Œ10msï¼Œsysmonå°±ä¼šè®¤ä¸ºå…¶è¿è¡Œæ—¶é—´å¤ªä¹…è€Œå‘å‡ºæŠ¢å å¼è°ƒåº¦çš„è¯·æ±‚ã€‚ä¸€æ—¦Gçš„æŠ¢å æ ‡å¿—ä½è¢«è®¾ä¸ºtrueï¼Œé‚£ä¹ˆå¾…è¿™ä¸ªGä¸‹ä¸€æ¬¡è°ƒç”¨å‡½æ•°æˆ–æ–¹æ³•æ—¶ï¼Œruntimeä¾¿å¯ä»¥å°†GæŠ¢å ï¼Œå¹¶ç§»å‡ºè¿è¡ŒçŠ¶æ€ï¼Œæ”¾å…¥Pä¸­å±€éƒ¨é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«è°ƒåº¦ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/32497435" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/32497435</a></p>
<p><a href="https://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/" target="_blank" rel="noopener">https://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;goroutineæ˜¯goçš„æ ¸å¿ƒï¼Œæ²¡æœ‰goroutineï¼Œgoå°±æ²¡ä»€ä¹ˆæ„æ€äº†ğŸ‘¿ã€‚goroutineç¦»ä¸å¼€åç¨‹ï¼Œçº¿ç¨‹å’Œå¹¶å‘ï¼Œæ‰€ä»¥ä¸‹é¢ä¼šè¯´è¯´ç›¸å…³çš„å†…å®¹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;åç¨‹&quot;&gt;&lt;a href=&quot;#åç¨‹&quot; class=&quot;headerlink&quot; title=&quot;åç¨‹&quot;&gt;&lt;/a&gt;åç¨‹&lt;/h1&gt;&lt;p&gt;åç¨‹(coroutine)å…¶å®å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ–¹æ³•æˆ–è€…ä¾‹ç¨‹ï¼ˆroutineï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹å‡½æ•°éƒ½æ˜¯åœ¨ç”¨æˆ·çº¿ç¨‹ä¸‹é¢æ‰§è¡Œçš„ï¼Œçº¿ç¨‹çš„è°ƒåº¦ç”±å†…æ ¸è§¦å‘ï¼Œæ‰€ä»¥å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹æ²¡åŠæ³•æ§åˆ¶å‡½æ•°çš„æ‰§è¡Œè°ƒåº¦ï¼Œåªèƒ½ä»»ç”±å†…æ ¸ä¸»å®°ã€‚åç¨‹å°±ä¸åŒï¼Œå®ƒå¯ä»¥ç”±ç”¨æˆ·çº¿ç¨‹æ§åˆ¶è°ƒåº¦ï¼Œåœ¨ä»»ä½•æ—¶å€™è°ƒåº¦åç¨‹çš„æ‰§è¡Œã€‚å‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œå†…æ ¸è°ƒåº¦ä¼šé™·å…¥å†…æ ¸å¹¶ä¿å­˜å½“å‰çº¿ç¨‹çš„æ ˆå’Œä¸Šä¸‹æ–‡ï¼Œç„¶åæ¢å¤ä¹‹å‰è¢«åœæ­¢çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œä»£ä»·æ¯”è¾ƒé«˜ã€‚è€Œåç¨‹çš„è°ƒåº¦ï¼Œä¸ç”¨é™·å…¥å†…æ ¸ï¼Œç”¨æˆ·çº¿ç¨‹åªæ˜¯ä¿å­˜å½“å‰åç¨‹çš„æ ˆå’Œä¸Šä¸‹æ–‡ï¼Œæ¢å¤ä¹‹å‰çš„è¢«åœæ­¢åç¨‹ç»§ç»­æ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;è¿˜æœ‰ç§è¯´æ³•æ˜¯è¯´å‡½æ•°æ˜¯åç¨‹çš„ä¸€ç§ç‰¹ä¾‹ã€‚å› ä¸ºå‡½æ•°åªæœ‰åœ¨returnè¯­å¥æ‰ä¼šè¿”å›ï¼Œè€Œåç¨‹å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»è¿”å›ã€‚&lt;/p&gt;
&lt;p&gt;åç¨‹å¾ˆæ—©å°±æå‡ºæ¥äº†ï¼Œå¯æ˜¯åœ¨ç°åœ¨æ‰ç«èµ·æ¥å§ï¼Œå¤§æ¦‚ç”±äºæŸç§è¯­è¨€ï¼ˆluaï¼‰çš„å¹¿æ³›ä½¿ç”¨å§ã€‚è€Œgoæ›´æ˜¯æŠŠåç¨‹ç”¨åˆ°åº•ï¼ŒåŸºæœ¬å¯ä»¥ç†è§£goçš„æ‰€æœ‰ä»£ç éƒ½è·‘åœ¨åç¨‹ä¸‹ï¼Œå¹¶ç”¨goroutineæ¥ä»£è¡¨å®ƒè‡ªå·±çš„åç¨‹ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.top/categories/go/"/>
    
    
      <category term="go" scheme="http://idiotsky.top/tags/go/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://idiotsky.top/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="goroutine" scheme="http://idiotsky.top/tags/goroutine/"/>
    
      <category term="åç¨‹" scheme="http://idiotsky.top/tags/%E5%8D%8F%E7%A8%8B/"/>
    
      <category term="å¹¶å‘" scheme="http://idiotsky.top/tags/%E5%B9%B6%E5%8F%91/"/>
    
      <category term="å¹¶è¡Œ" scheme="http://idiotsky.top/tags/%E5%B9%B6%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>mysql å¹»è¯»å®éªŒ</title>
    <link href="http://idiotsky.top/2018/08/08/mysql-dirty-read/"/>
    <id>http://idiotsky.top/2018/08/08/mysql-dirty-read/</id>
    <published>2018-08-08T12:24:11.000Z</published>
    <updated>2018-08-09T01:01:56.658Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¯åŠ¨ä¸€ä¸ªmysql"><a href="#å¯åŠ¨ä¸€ä¸ªmysql" class="headerlink" title="å¯åŠ¨ä¸€ä¸ªmysql"></a>å¯åŠ¨ä¸€ä¸ªmysql</h1><p>ç”¨dockerå¾ˆå®¹æ˜“å°±èµ·ä¸€ä¸ªmysqlçš„ç¯å¢ƒäº†ï¼Œæˆ‘çš„<a href="https://github.com/ejunjsh/docker-code" target="_blank" rel="noopener">github repo docker-code</a>,æœ‰ä¾‹å­</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mysql</span><br><span class="line">sudo docker-compose up</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="ç™»é™†mysql"><a href="#ç™»é™†mysql" class="headerlink" title="ç™»é™†mysql"></a>ç™»é™†mysql</h1><p>ç”¨ä¸‹é¢å‘½ä»¤å¯ä»¥ç¡®è®¤mysqlæ‰€åœ¨çš„å®¹å™¨ï¼Œåœ¨æˆ‘æœºå­æ˜¯<code>mysql_db_1</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps</span><br><span class="line">[sudo] password <span class="keyword">for</span> sky:</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">c7f451f632c0        adminer             <span class="string">"entrypoint.sh doc..."</span>   2 weeks ago         Up 2 minutes        0.0.0.0:8080-&gt;8080/tcp   mysql_adminer_1</span><br><span class="line">e2645139c23b        mysql               <span class="string">"docker-entrypoint..."</span>   2 weeks ago         Up 2 minutes        3306/tcp                 mysql_db_1</span><br></pre></td></tr></table></figure></p>
<p>è¿›å…¥å®¹å™¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker <span class="built_in">exec</span> -it mysql_db_1 bash</span><br><span class="line">mysql -p</span><br></pre></td></tr></table></figure>
<p>å¯†ç é»˜è®¤æ˜¯<code>example</code></p>
<h1 id="åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨"><a href="#åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨" class="headerlink" title="åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨"></a>åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database test;</span><br><span class="line">mysql&gt; use test;</span><br><span class="line">mysql&gt; DROP TABLE IF EXISTS `tx`;</span><br><span class="line">mysql&gt; CREATE TABLE `tx` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `num` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure>
<h1 id="å¼€å§‹å®éªŒ"><a href="#å¼€å§‹å®éªŒ" class="headerlink" title="å¼€å§‹å®éªŒ"></a>å¼€å§‹å®éªŒ</h1><p>mysqlçš„é»˜è®¤éš”ç¦»çº§åˆ«ä¸º<code>å¯é‡å¤è¯»</code>ï¼Œæ‰€ä»¥æ˜¯ä¼šå‡ºç°<code>å¹»è¯»</code>çš„æƒ…å†µçš„ã€‚</p>
<p>è¿˜æ˜¯éªŒè¯ä¸‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT @@transaction_isolation;</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>ä»¥å‰æ˜¯<code>SELECT @@tx_isolation;</code>,æ–°ç‰ˆæœ¬è¦ç”¨<code>SELECT @@transaction_isolation;</code></p>
<p>æ¥ä¸‹æ¥æ’å…¥ä¸€æ¡æ•°æ®<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into tx (num) values(100);</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åå¼€å¯äº‹åŠ¡<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction;</span><br></pre></td></tr></table></figure></p>
<p>æ›´æ–°è¿™æ¡è®°å½•</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set num=200 where num=100;</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure>
<p>ç•™æ„ä¸Šé¢çš„<code>matched</code>æ˜¯1çš„ã€‚</p>
<p>å…ˆä¸æäº¤è¿™ä¸ªäº‹åŠ¡ï¼Œå¼€å¦å¤–ä¸ªç»ˆç«¯æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•å†æ‰“å¼€ä¸ªmysql,ä¹‹åä¹Ÿå¼€ä¸€ä¸ªäº‹åŠ¡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use <span class="built_in">test</span>;</span><br><span class="line">mysql&gt; start transaction;</span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+----+-----+</span><br><span class="line">| id | num |</span><br><span class="line">+----+-----+</span><br><span class="line">|  1 | 100 |</span><br><span class="line">+----+-----+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>ç”±äºéš”ç¦»çº§åˆ«ï¼Œæ‰€ä»¥çœ‹ä¸åˆ°å¯¹æ–¹æ›´æ–°çš„</p>
<p>ç„¶åå›åˆ°ç¬¬ä¸€ä¸ªç»ˆç«¯,æäº¤äº‹åŠ¡</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; commit;</span><br></pre></td></tr></table></figure>
<p>å†å›åˆ°ç¬¬äºŒç»ˆç«¯ï¼Œ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">| id | num |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">|  1 | 100 |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯å› ä¸ºéš”ç¦»çº§åˆ«ï¼Œè¿˜æ˜¯çœ‹ä¸åˆ°å¯¹æ–¹æ›´æ–°çš„ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œé‡å¤´æˆæ¥äº†ï¼Œå°è¯•åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸Šæ‰§è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set num=300 where num=100;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 0  Changed: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">| id | num |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">|  1 | 100 |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>å±…ç„¶æ›´æ–°ä¸äº†ï¼Œç„¶åå°±<code>å¹»è¯»</code>äº†ã€‚è¿™ä¸ªå¾ˆå®¹æ˜“ç†è§£ï¼Œåœ¨ç¬¬äºŒä¸ªç»ˆç«¯çš„äº‹åŠ¡é‡Œï¼Œçœ‹åˆ°éƒ½æ˜¯å®ƒå¯åŠ¨äº‹åŠ¡é‚£ä¸€åˆ»çš„å¿«ç…§<code>snapshot</code>,æ‰€ä»¥çœ‹ä¸åˆ°å…¶ä»–äº‹åŠ¡çš„ä¸œè¥¿ï¼Œå¯æ˜¯ä¸€æ—¦æ›´æ–°çš„æ—¶å€™ï¼Œå°±ä¼šå› ä¸ºåˆ«äººäº‹åŠ¡æ”¹å˜äº†åŸæ¥çš„å€¼ï¼Œè‡ªå·±æ²¡åŠæ³•å†æ›´æ–°å®ƒä»¥ä¸ºçš„é‚£ä¸ªå€¼äº†ï¼Œæ‰€ä»¥è¿™ç§ä»¥ä¸ºå°±ç§°ä¸ºäº†<code>å¹»è§‰(phantom)</code>ï¼Œä¿—ç§°<code>å¹»è¯»</code>ã€‚</p>
<p>é‚£å‡å¦‚ä¸Šé¢æˆ‘ä¸æŒ‡å®šæ¡ä»¶å‘¢ </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set num=300;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure>
<p>æ˜¯å¯ä»¥æ›´æ–°çš„ï¼Œå› ä¸ºè¿™æ˜¯å…¨è¡¨æ›´æ–°ï¼Œæ‰€ä»¥æ²¡é—®é¢˜ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; commit;</span><br></pre></td></tr></table></figure>
<p>æäº¤ä¸‹ï¼Œæ–¹ä¾¿ä¸‹é¢ç»§ç»­åšå®éªŒ</p>
<p>è™½è¯´è¿™ä¸ª<code>å¹»è¯»</code>æ˜¯é—®é¢˜ï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯äººä»¬ç”¨æ¥åšæ•°æ®åº“<code>CAS</code>çš„ä¿è¯å§ã€‚</p>
<h1 id="æ•°æ®åº“CAS"><a href="#æ•°æ®åº“CAS" class="headerlink" title="æ•°æ®åº“CAS"></a>æ•°æ®åº“<code>CAS</code></h1><p>æˆ‘ä»¬åœ¨ä¸Šé¢çš„è¡¨åŸºç¡€ä¸Šå†åŠ ä¸€åˆ—<code>version</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table tx add column version int null;</span><br><span class="line">Query OK, 0 rows affected (0.16 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">| id | num | version |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">|  1 | 300 |    NULL |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®ä¸ªåˆå§‹å€¼</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set version =0;</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">| id | num | version |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">|  1 | 300 |       0 |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>ç„¶åç”¨javaè·‘ä¸ªå¹¶å‘æ‰£<code>num</code>çš„ç¨‹åº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.code.mysql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbCas</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JDBC é©±åŠ¨ååŠæ•°æ®åº“ URL</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String JDBC_DRIVER = <span class="string">"com.mysql.cj.jdbc.Driver"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String DB_URL = <span class="string">"jdbc:mysql://192.168.5.129:3306/test"</span>;<span class="comment">//è¿™é‡Œçš„ipæ˜¯ä½ dockerçš„hostçš„ip</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•°æ®åº“çš„ç”¨æˆ·åä¸å¯†ç ï¼Œéœ€è¦æ ¹æ®è‡ªå·±çš„è®¾ç½®</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String PASS = <span class="string">"example"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicInteger counter=<span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Connection conn = DriverManager.getConnection(DB_URL,USER,PASS);</span><br><span class="line">            conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            Statement statement=conn.createStatement();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">                String sql=<span class="string">"select version from tx where id=1 and num&lt;&gt;0"</span>;</span><br><span class="line">                ResultSet rs=statement.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">                    <span class="keyword">int</span> version = rs.getInt(<span class="string">"version"</span>);</span><br><span class="line"></span><br><span class="line">                    rs.close();</span><br><span class="line"></span><br><span class="line">                    sql=<span class="string">"update tx set num=num-1,version=version+1 where id=1 and version="</span> + version;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> record = statement.executeUpdate(sql);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (record == <span class="number">1</span>) &#123;</span><br><span class="line">                        counter.getAndIncrement();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    conn.commit();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            statement.close();</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(JDBC_DRIVER);</span><br><span class="line"></span><br><span class="line">            Thread[] threads=<span class="keyword">new</span> Thread[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                Thread thread=<span class="keyword">new</span> Thread(() -&gt; consumer());</span><br><span class="line">                thread.start();</span><br><span class="line">                threads[i]=thread;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    threads[i].join();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.printf(<span class="string">"finally update %d records"</span>,counter.get());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœä¸º</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finally update 300 records</span><br></pre></td></tr></table></figure>
<p>æ•°æ®åº“æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">| id | num | version |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">|  1 |   0 |     300 |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°ï¼Œåªæœ‰300ä¸ªæˆåŠŸæ›´æ–°çš„è®°å½•,æ•°æ®åº“çš„è®°å½•ä¹Ÿæ²¡æœ‰è¶…æ‰£ã€‚</p>
<p>æ‰€ä»¥åˆ©ç”¨è¿™ä¸ªï¼Œå¯ä»¥ä¸ç”¨<code>select for update</code>ç­‰é”çš„æ“ä½œã€‚</p>
<h1 id="å†è¯•ä¸‹é”"><a href="#å†è¯•ä¸‹é”" class="headerlink" title="å†è¯•ä¸‹é”"></a>å†è¯•ä¸‹é”</h1><p>æ¥ä¸‹æ¥è¯•è¯•é”å§</p>
<p>ç¬¬ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">| id | num | version |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">|  1 | 300 |       1 |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">update</span> tx <span class="keyword">set</span> <span class="keyword">num</span> =<span class="number">400</span> <span class="keyword">where</span> <span class="keyword">version</span>=<span class="number">1</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ²¡æœ‰æäº¤äº‹åŠ¡</p>
<p>ç„¶åç¬¬äºŒä¸ªç»ˆç«¯ï¼Œç›´æ¥è¿è¡Œä¸‹é¢å‘½ä»¤</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set num =400 where version=1;</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°å¡åœ¨é‚£é‡Œï¼Œè¿‡ä¸€ä¼šå°±ä¼šå“åº”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è¿™é‡Œä½ å°±çœ‹åˆ°æ˜¯æœ‰é”äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç¥å¥‡å‘¢ï¼Œå…¶å®éš”ç¦»çº§åˆ«å°±æ˜¯é é”æ¥å®ç°çš„</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸Šé¢åˆ—å­å’Œä»£ç å¯ä»¥å¾ˆå¥½çš„è¯´æ˜äº†ï¼Œæ•°æ®åº“ä¼šåœ¨é€‚å½“çš„æ—¶å€™åŠ é”ï¼Œä¿è¯æ•°æ®ä¸ä¼šæœ‰é—®é¢˜ï¼Œå½“ç„¶å‰ææ˜¯éš”ç¦»çº§åˆ«è®¾ç½®å¤Ÿé«˜ï¼Œmysqlé»˜è®¤æ˜¯å¯é‡å¤è¯»ï¼Œæ‰€ä»¥è¶³å¤Ÿä¿è¯äº†ï¼Œè¿˜æœ‰ä¸Šé¢ä¾‹å­å¯ä»¥ç”¨æ¥åšæ‰£åº“å­˜çš„ä»£ç å“¦ğŸ˜„ï¼Œjavaä»£ç å¯ä»¥åœ¨<a href="https://github.com/ejunjsh/java-code/blob/master/basic/src/main/java/com/sky/code/mysql/DbCas.java" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‹¿åˆ°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¯åŠ¨ä¸€ä¸ªmysql&quot;&gt;&lt;a href=&quot;#å¯åŠ¨ä¸€ä¸ªmysql&quot; class=&quot;headerlink&quot; title=&quot;å¯åŠ¨ä¸€ä¸ªmysql&quot;&gt;&lt;/a&gt;å¯åŠ¨ä¸€ä¸ªmysql&lt;/h1&gt;&lt;p&gt;ç”¨dockerå¾ˆå®¹æ˜“å°±èµ·ä¸€ä¸ªmysqlçš„ç¯å¢ƒäº†ï¼Œæˆ‘çš„&lt;a href=&quot;https://github.com/ejunjsh/docker-code&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;github repo docker-code&lt;/a&gt;,æœ‰ä¾‹å­&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; mysql&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo docker-compose up&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="mysql" scheme="http://idiotsky.top/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://idiotsky.top/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Java G1åƒåœ¾æ”¶é›†å™¨</title>
    <link href="http://idiotsky.top/2018/07/28/java-g1/"/>
    <id>http://idiotsky.top/2018/07/28/java-g1/</id>
    <published>2018-07-28T10:54:54.000Z</published>
    <updated>2018-08-14T13:25:49.481Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>æ­¤æ–‡ç« é™¤äº†è¯´g1,è¿˜é¡ºå¸¦æ€»ç»“äº†ä¸€äº›å…¶ä»–æ¦‚å¿µï¼Œmarkä¹‹ğŸ‘¿</p>
</blockquote>
<p>æœ¬æ–‡é¦–å…ˆç®€å•ä»‹ç»äº†åƒåœ¾æ”¶é›†çš„å¸¸è§æ–¹å¼ï¼Œç„¶åå†åˆ†æäº†G1æ”¶é›†å™¨çš„æ”¶é›†åŸç†ï¼Œç›¸æ¯”å…¶ä»–åƒåœ¾æ”¶é›†å™¨çš„ä¼˜åŠ¿ï¼Œæœ€åç»™å‡ºäº†ä¸€äº›è°ƒä¼˜å®è·µã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶"><a href="#ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶" class="headerlink" title="ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶"></a>ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶</h1><p>é¦–å…ˆï¼Œåœ¨äº†è§£G1ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¸…æ¥šçš„çŸ¥é“ï¼Œåƒåœ¾å›æ”¶æ˜¯ä»€ä¹ˆï¼Ÿç®€å•çš„è¯´åƒåœ¾å›æ”¶å°±æ˜¯å›æ”¶å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚</p>
<p>åƒåœ¾å›æ”¶çš„åŸºæœ¬æ­¥éª¤</p>
<p>å›æ”¶çš„æ­¥éª¤æœ‰2æ­¥ï¼š</p>
<ul>
<li>æŸ¥æ‰¾å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡</li>
<li>é‡Šæ”¾è¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜</li>
</ul>
<p><strong>æŸ¥æ‰¾å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡</strong><br><a id="more"></a><br>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•åˆ¤æ–­å“ªäº›å¯¹è±¡ä¸å†è¢«ä½¿ç”¨å‘¢ï¼Ÿæˆ‘ä»¬ä¹Ÿæœ‰2ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>å¼•ç”¨è®¡æ•°æ³•<br> å¼•ç”¨è®¡æ•°æ³•å°±æ˜¯å¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰è¢«ä»»ä½•å¼•ç”¨æŒ‡å‘ï¼Œåˆ™å¯è§†ä¹‹ä¸ºåƒåœ¾ã€‚è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹å°±æ˜¯ä¸èƒ½æ£€æµ‹åˆ°ç¯çš„å­˜åœ¨ã€‚</li>
<li>æ ¹æœç´¢ç®—æ³•<br> æ ¹æœç´¢ç®—æ³•çš„åŸºæœ¬æ€è·¯å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—åä¸ºâ€GC Rootsâ€çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾(Reference Chain)ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚</li>
</ol>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•æ‰¾å‡ºåƒåœ¾å¯¹è±¡äº†ï¼Œå¦‚ä½•æŠŠè¿™äº›å¯¹è±¡æ¸…ç†æ‰å‘¢ï¼Ÿ</p>
<p><strong>é‡Šæ”¾è¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜</strong></p>
<p>å¸¸è§çš„æ–¹å¼æœ‰å¤åˆ¶æˆ–è€…ç›´æ¥æ¸…ç†ï¼Œä½†æ˜¯ç›´æ¥æ¸…ç†ä¼šå­˜åœ¨å†…å­˜ç¢ç‰‡ï¼Œäºæ˜¯å°±ä¼šäº§ç”Ÿäº†æ¸…ç†å†å‹ç¼©çš„æ–¹å¼ã€‚</p>
<p>æ€»å¾—æ¥è¯´å°±äº§ç”Ÿäº†ä¸‰ç§ç±»å‹çš„å›æ”¶ç®—æ³•ã€‚</p>
<ol>
<li>æ ‡è®°-å¤åˆ¶<br> å®ƒå°†å¯ç”¨å†…å­˜å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—ç”¨å®Œä¹‹åï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šé¢ï¼Œç„¶ååœ¨æŠŠå·²ä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´ä¸€æ¬¡ç†æ‰ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œæ•ˆç‡é«˜ï¼Œä¸ä¼šå­˜åœ¨å†…å­˜ç¢ç‰‡ã€‚ç¼ºç‚¹å°±æ˜¯éœ€è¦2å€çš„å†…å­˜æ¥ç®¡ç†ã€‚</li>
<li>æ ‡è®°-æ¸…ç†<br> æ ‡è®°æ¸…é™¤ç®—æ³•åˆ†ä¸ºâ€œæ ‡è®°â€å’Œâ€œæ¸…é™¤â€ä¸¤ä¸ªé˜¶æ®µï¼šé¦–å…ˆæ ‡è®°å‡ºéœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œæ ‡è®°å®Œæˆä¹‹åç»Ÿä¸€æ¸…é™¤å¯¹è±¡ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯æ•ˆç‡é«˜ï¼Œç¼ºç‚¹æ˜¯å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</li>
<li>æ ‡è®°-æ•´ç†<br> æ ‡è®°æ“ä½œå’Œâ€œæ ‡è®°-æ¸…ç†â€ç®—æ³•ä¸€è‡´ï¼Œåç»­æ“ä½œä¸åªæ˜¯ç›´æ¥æ¸…ç†å¯¹è±¡ï¼Œè€Œæ˜¯åœ¨æ¸…ç†æ— ç”¨å¯¹è±¡å®Œæˆåè®©æ‰€æœ‰ å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨ï¼Œå¹¶æ›´æ–°å¼•ç”¨å…¶å¯¹è±¡çš„æŒ‡é’ˆã€‚å› ä¸ºè¦ç§»åŠ¨å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒçš„æ•ˆç‡è¦æ¯”â€œæ ‡è®°-æ¸…ç†â€æ•ˆç‡ä½ï¼Œä½†æ˜¯ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</li>
</ol>
<p><strong>åŸºäºåˆ†ä»£çš„å‡è®¾</strong></p>
<p>ç”±äºå¯¹è±¡çš„å­˜æ´»æ—¶é—´æœ‰é•¿æœ‰çŸ­ï¼Œæ‰€ä»¥å¯¹äºå­˜æ´»æ—¶é—´é•¿çš„å¯¹è±¡ï¼Œå‡å°‘è¢«gcçš„æ¬¡æ•°å¯ä»¥é¿å…ä¸å¿…è¦çš„å¼€é”€ã€‚è¿™æ ·æˆ‘ä»¬å°±æŠŠå†…å­˜åˆ†æˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæ–°ç”Ÿä»£å­˜æ”¾åˆšåˆ›å»ºçš„å’Œå­˜æ´»æ—¶é—´æ¯”è¾ƒçŸ­çš„å¯¹è±¡ï¼Œè€å¹´ä»£å­˜æ”¾å­˜æ´»æ—¶é—´æ¯”è¾ƒé•¿çš„å¯¹è±¡ã€‚è¿™æ ·æ¯æ¬¡ä»…ä»…æ¸…ç†å¹´è½»ä»£ï¼Œè€å¹´ä»£ä»…åœ¨å¿…è¦æ—¶æ—¶å†åšæ¸…ç†å¯ä»¥æå¤§çš„æé«˜GCæ•ˆç‡ï¼ŒèŠ‚çœGCæ—¶é—´ã€‚</p>
<p><strong>javaåƒåœ¾æ”¶é›†å™¨çš„å†å²</strong></p>
<p><strong>ç¬¬ä¸€é˜¶æ®µï¼ŒSerialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨</strong></p>
<p>åœ¨jdk1.3.1ä¹‹å‰ï¼Œjavaè™šæ‹Ÿæœºä»…ä»…èƒ½ä½¿ç”¨Serialæ”¶é›†å™¨ã€‚ Serialæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œä½†å®ƒçš„â€œå•çº¿ç¨‹â€çš„æ„ä¹‰å¹¶ä¸ä»…ä»…æ˜¯è¯´æ˜å®ƒåªä¼šä½¿ç”¨ä¸€ä¸ªCPUæˆ–ä¸€æ¡æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å®ƒè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚</p>
<p>PSï¼šå¼€å¯Serialæ”¶é›†å™¨çš„æ–¹å¼</p>
<blockquote>
<p>-XX:+UseSerialGC</p>
</blockquote>
<p><strong>ç¬¬äºŒé˜¶æ®µï¼ŒParallelï¼ˆå¹¶è¡Œï¼‰æ”¶é›†å™¨</strong></p>
<p>Parallelæ”¶é›†å™¨ä¹Ÿç§°ååé‡æ”¶é›†å™¨ï¼Œç›¸æ¯”Serialæ”¶é›†å™¨ï¼ŒParallelæœ€ä¸»è¦çš„ä¼˜åŠ¿åœ¨äºä½¿ç”¨å¤šçº¿ç¨‹å»å®Œæˆåƒåœ¾æ¸…ç†å·¥ä½œï¼Œè¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸çš„ç‰¹æ€§ï¼Œå¤§å¹…é™ä½gcæ—¶é—´ã€‚</p>
<p>PS:å¼€å¯Parallelæ”¶é›†å™¨çš„æ–¹å¼</p>
<blockquote>
<p>-XX:+UseParallelGC -XX:+UseParallelOldGC</p>
</blockquote>
<p><strong>ç¬¬ä¸‰é˜¶æ®µï¼ŒCMSï¼ˆå¹¶å‘ï¼‰æ”¶é›†å™¨</strong></p>
<p>CMSæ”¶é›†å™¨åœ¨Minor GCæ—¶ä¼šæš‚åœæ‰€æœ‰çš„åº”ç”¨çº¿ç¨‹ï¼Œå¹¶ä»¥å¤šçº¿ç¨‹çš„æ–¹å¼è¿›è¡Œåƒåœ¾å›æ”¶ã€‚åœ¨Full GCæ—¶ä¸å†æš‚åœåº”ç”¨çº¿ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨è‹¥å¹²ä¸ªåå°çº¿ç¨‹å®šæœŸçš„å¯¹è€å¹´ä»£ç©ºé—´è¿›è¡Œæ‰«æï¼ŒåŠæ—¶å›æ”¶å…¶ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚</p>
<p>PS:å¼€å¯CMSæ”¶é›†å™¨çš„æ–¹å¼</p>
<blockquote>
<p>-XX:+UseParNewGC -XX:+UseConcMarkSweepGC</p>
</blockquote>
<p><strong>ç¬¬å››é˜¶æ®µï¼ŒG1ï¼ˆå¹¶å‘ï¼‰æ”¶é›†å™¨</strong></p>
<p>G1æ”¶é›†å™¨ï¼ˆæˆ–è€…åƒåœ¾ä¼˜å…ˆæ”¶é›†å™¨ï¼‰çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†å°½é‡ç¼©çŸ­å¤„ç†è¶…å¤§å †ï¼ˆå¤§äº4GBï¼‰æ—¶äº§ç”Ÿçš„åœé¡¿ã€‚ç›¸å¯¹äºCMSçš„ä¼˜åŠ¿è€Œè¨€æ˜¯å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿç‡å¤§å¤§é™ä½ã€‚</p>
<p>PS:å¼€å¯G1æ”¶é›†å™¨çš„æ–¹å¼</p>
<blockquote>
<p>-XX:+UseG1GC</p>
</blockquote>
<h1 id="äº†è§£G1"><a href="#äº†è§£G1" class="headerlink" title="äº†è§£G1"></a>äº†è§£G1</h1><p>G1çš„ç¬¬ä¸€ç¯‡paperï¼ˆé™„å½•1ï¼‰å‘è¡¨äº2004å¹´ï¼Œåœ¨2012å¹´æ‰åœ¨jdk1.7u4ä¸­å¯ç”¨ã€‚oracleå®˜æ–¹è®¡åˆ’åœ¨jdk9ä¸­å°†G1å˜æˆé»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä»¥æ›¿ä»£CMSã€‚ä¸ºä½•oracleè¦æåŠ›æ¨èG1å‘¢ï¼ŒG1æœ‰å“ªäº›ä¼˜ç‚¹ï¼Ÿ</p>
<p>é¦–å…ˆï¼ŒG1çš„è®¾è®¡åŸåˆ™å°±æ˜¯ç®€å•å¯è¡Œçš„æ€§èƒ½è°ƒä¼˜</p>
<p>å¼€å‘äººå‘˜ä»…ä»…éœ€è¦å£°æ˜ä»¥ä¸‹å‚æ•°å³å¯ï¼š</p>
<blockquote>
<p>-XX:+UseG1GC -Xmx32g -XX:MaxGCPauseMillis=200</p>
</blockquote>
<p>å…¶ä¸­-XX:+UseG1GCä¸ºå¼€å¯G1åƒåœ¾æ”¶é›†å™¨ï¼Œ-Xmx32g è®¾è®¡å †å†…å­˜çš„æœ€å¤§å†…å­˜ä¸º32Gï¼Œ-XX:MaxGCPauseMillis=200è®¾ç½®GCçš„æœ€å¤§æš‚åœæ—¶é—´ä¸º200msã€‚å¦‚æœæˆ‘ä»¬éœ€è¦è°ƒä¼˜ï¼Œåœ¨å†…å­˜å¤§å°ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹æœ€å¤§æš‚åœæ—¶é—´å³å¯ã€‚</p>
<p>å…¶æ¬¡ï¼ŒG1å°†æ–°ç”Ÿä»£ï¼Œè€å¹´ä»£çš„ç‰©ç†ç©ºé—´åˆ’åˆ†å–æ¶ˆäº†ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å†ä¹Ÿä¸ç”¨å•ç‹¬çš„ç©ºé—´å¯¹æ¯ä¸ªä»£è¿›è¡Œè®¾ç½®äº†ï¼Œä¸ç”¨æ‹…å¿ƒæ¯ä¸ªä»£å†…å­˜æ˜¯å¦è¶³å¤Ÿã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-1.jpg"><img src="http://idiotsky.top/images3/G1-1.png" alt=""></a></p>
<p>å–è€Œä»£ä¹‹çš„æ˜¯ï¼ŒG1ç®—æ³•å°†å †åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼ˆRegionï¼‰ï¼Œå®ƒä»ç„¶å±äºåˆ†ä»£æ”¶é›†å™¨ã€‚ä¸è¿‡ï¼Œè¿™äº›åŒºåŸŸçš„ä¸€éƒ¨åˆ†åŒ…å«æ–°ç”Ÿä»£ï¼Œæ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†ä¾ç„¶é‡‡ç”¨æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹çš„æ–¹å¼ï¼Œå°†å­˜æ´»å¯¹è±¡æ‹·è´åˆ°è€å¹´ä»£æˆ–è€…Survivorç©ºé—´ã€‚è€å¹´ä»£ä¹Ÿåˆ†æˆå¾ˆå¤šåŒºåŸŸï¼ŒG1æ”¶é›†å™¨é€šè¿‡å°†å¯¹è±¡ä»ä¸€ä¸ªåŒºåŸŸå¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªåŒºåŸŸï¼Œå®Œæˆäº†æ¸…ç†å·¥ä½œã€‚è¿™å°±æ„å‘³ç€ï¼Œåœ¨æ­£å¸¸çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼ŒG1å®Œæˆäº†å †çš„å‹ç¼©ï¼ˆè‡³å°‘æ˜¯éƒ¨åˆ†å †çš„å‹ç¼©ï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±ä¸ä¼šæœ‰cmså†…å­˜ç¢ç‰‡é—®é¢˜çš„å­˜åœ¨äº†ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-2.png"><img src="http://idiotsky.top/images3/G1-2.png" alt=""></a></p>
<p>åœ¨G1ä¸­ï¼Œè¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„åŒºåŸŸï¼Œå«HumongousåŒºåŸŸã€‚ å¦‚æœä¸€ä¸ªå¯¹è±¡å ç”¨çš„ç©ºé—´è¶…è¿‡äº†åˆ†åŒºå®¹é‡50%ä»¥ä¸Šï¼ŒG1æ”¶é›†å™¨å°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå·¨å‹å¯¹è±¡ã€‚è¿™äº›å·¨å‹å¯¹è±¡ï¼Œé»˜è®¤ç›´æ¥ä¼šè¢«åˆ†é…åœ¨å¹´è€ä»£ï¼Œä½†æ˜¯å¦‚æœå®ƒæ˜¯ä¸€ä¸ªçŸ­æœŸå­˜åœ¨çš„å·¨å‹å¯¹è±¡ï¼Œå°±ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ æˆè´Ÿé¢å½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒG1åˆ’åˆ†äº†ä¸€ä¸ªHumongousåŒºï¼Œå®ƒç”¨æ¥ä¸“é—¨å­˜æ”¾å·¨å‹å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªHåŒºè£…ä¸ä¸‹ä¸€ä¸ªå·¨å‹å¯¹è±¡ï¼Œé‚£ä¹ˆG1ä¼šå¯»æ‰¾è¿ç»­çš„Håˆ†åŒºæ¥å­˜å‚¨ã€‚ä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨Full GCã€‚</p>
<p>PSï¼šåœ¨java 8ä¸­ï¼ŒæŒä¹…ä»£ä¹Ÿç§»åŠ¨åˆ°äº†æ™®é€šçš„å †å†…å­˜ç©ºé—´ä¸­ï¼Œæ”¹ä¸ºå…ƒç©ºé—´ã€‚</p>
<p><strong>å¯¹è±¡åˆ†é…ç­–ç•¥</strong></p>
<p>è¯´èµ·å¤§å¯¹è±¡çš„åˆ†é…ï¼Œæˆ‘ä»¬ä¸å¾—ä¸è°ˆè°ˆå¯¹è±¡çš„åˆ†é…ç­–ç•¥ã€‚å®ƒåˆ†ä¸º3ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>TLAB(Thread Local Allocation Buffer)çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒº</li>
<li>EdenåŒºä¸­åˆ†é…</li>
<li>HumongousåŒºåˆ†é…</li>
</ol>
<p>TLABä¸ºçº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒºï¼Œå®ƒçš„ç›®çš„ä¸ºäº†ä½¿å¯¹è±¡å°½å¯èƒ½å¿«çš„åˆ†é…å‡ºæ¥ã€‚å¦‚æœå¯¹è±¡åœ¨ä¸€ä¸ªå…±äº«çš„ç©ºé—´ä¸­åˆ†é…ï¼Œæˆ‘ä»¬éœ€è¦é‡‡ç”¨ä¸€äº›åŒæ­¥æœºåˆ¶æ¥ç®¡ç†è¿™äº›ç©ºé—´å†…çš„ç©ºé—²ç©ºé—´æŒ‡é’ˆã€‚åœ¨Edenç©ºé—´ä¸­ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„åˆ†åŒºç”¨äºåˆ†é…å¯¹è±¡ï¼Œå³ä¸€ä¸ªTLABã€‚åˆ†é…å¯¹è±¡æ—¶ï¼Œçº¿ç¨‹ä¹‹é—´ä¸å†éœ€è¦è¿›è¡Œä»»ä½•çš„åŒæ­¥ã€‚</p>
<p>å¯¹TLABç©ºé—´ä¸­æ— æ³•åˆ†é…çš„å¯¹è±¡ï¼ŒJVMä¼šå°è¯•åœ¨Edenç©ºé—´ä¸­è¿›è¡Œåˆ†é…ã€‚å¦‚æœEdenç©ºé—´æ— æ³•å®¹çº³è¯¥å¯¹è±¡ï¼Œå°±åªèƒ½åœ¨è€å¹´ä»£ä¸­è¿›è¡Œåˆ†é…ç©ºé—´ã€‚</p>
<p>æœ€åï¼ŒG1æä¾›äº†ä¸¤ç§GCæ¨¡å¼ï¼ŒYoung GCå’ŒMixed GCï¼Œä¸¤ç§éƒ½æ˜¯Stop The World(STW)çš„ã€‚ä¸‹é¢æˆ‘ä»¬å°†åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™2ç§æ¨¡å¼ã€‚</p>
<h1 id="G1-Young-GC"><a href="#G1-Young-GC" class="headerlink" title="G1 Young GC"></a>G1 Young GC</h1><p>Young GCä¸»è¦æ˜¯å¯¹EdenåŒºè¿›è¡ŒGCï¼Œå®ƒåœ¨Edenç©ºé—´è€—å°½æ—¶ä¼šè¢«è§¦å‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒEdenç©ºé—´çš„æ•°æ®ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¦‚æœSurvivorç©ºé—´ä¸å¤Ÿï¼ŒEdenç©ºé—´çš„éƒ¨åˆ†æ•°æ®ä¼šç›´æ¥æ™‹å‡åˆ°å¹´è€ä»£ç©ºé—´ã€‚SurvivoråŒºçš„æ•°æ®ç§»åŠ¨åˆ°æ–°çš„SurvivoråŒºä¸­ï¼Œä¹Ÿæœ‰éƒ¨åˆ†æ•°æ®æ™‹å‡åˆ°è€å¹´ä»£ç©ºé—´ä¸­ã€‚æœ€ç»ˆEdenç©ºé—´çš„æ•°æ®ä¸ºç©ºï¼ŒGCåœæ­¢å·¥ä½œï¼Œåº”ç”¨çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-3.png"><img src="http://idiotsky.top/images3/G1-3.png" alt=""></a></p>
<p><a href="http://idiotsky.top/images3/G1-4.png"><img src="http://idiotsky.top/images3/G1-4.png" alt=""></a></p>
<p>è¿™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä»…ä»…GC æ–°ç”Ÿä»£å¯¹è±¡ï¼Œæˆ‘ä»¬å¦‚ä½•æ‰¾åˆ°æ‰€æœ‰çš„æ ¹å¯¹è±¡å‘¢ï¼Ÿ è€å¹´ä»£çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯æ ¹ä¹ˆï¼Ÿé‚£è¿™æ ·æ‰«æä¸‹æ¥ä¼šè€—è´¹å¤§é‡çš„æ—¶é—´ã€‚äºæ˜¯ï¼ŒG1å¼•è¿›äº†RSetçš„æ¦‚å¿µã€‚å®ƒçš„å…¨ç§°æ˜¯Remembered Setï¼Œä½œç”¨æ˜¯è·Ÿè¸ªæŒ‡å‘æŸä¸ªheapåŒºå†…çš„å¯¹è±¡å¼•ç”¨ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-5.png"><img src="http://idiotsky.top/images3/G1-5.png" alt=""></a></p>
<p>åœ¨CMSä¸­ï¼Œä¹Ÿæœ‰RSetçš„æ¦‚å¿µï¼Œåœ¨è€å¹´ä»£ä¸­æœ‰ä¸€å—åŒºåŸŸç”¨æ¥è®°å½•æŒ‡å‘æ–°ç”Ÿä»£çš„å¼•ç”¨ã€‚è¿™æ˜¯ä¸€ç§point-outï¼Œåœ¨è¿›è¡ŒYoung GCæ—¶ï¼Œæ‰«ææ ¹æ—¶ï¼Œä»…ä»…éœ€è¦æ‰«æè¿™ä¸€å—åŒºåŸŸï¼Œè€Œä¸éœ€è¦æ‰«ææ•´ä¸ªè€å¹´ä»£ã€‚</p>
<p>ä½†åœ¨G1ä¸­ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨point-outï¼Œè¿™æ˜¯ç”±äºä¸€ä¸ªåˆ†åŒºå¤ªå°ï¼Œåˆ†åŒºæ•°é‡å¤ªå¤šï¼Œå¦‚æœæ˜¯ç”¨point-outçš„è¯ï¼Œä¼šé€ æˆå¤§é‡çš„æ‰«ææµªè´¹ï¼Œæœ‰äº›æ ¹æœ¬ä¸éœ€è¦GCçš„åˆ†åŒºå¼•ç”¨ä¹Ÿæ‰«æäº†ã€‚äºæ˜¯G1ä¸­ä½¿ç”¨point-inæ¥è§£å†³ã€‚point-inçš„æ„æ€æ˜¯å“ªäº›åˆ†åŒºå¼•ç”¨äº†å½“å‰åˆ†åŒºä¸­çš„å¯¹è±¡ã€‚è¿™æ ·ï¼Œä»…ä»…å°†è¿™äº›å¯¹è±¡å½“åšæ ¹æ¥æ‰«æå°±é¿å…äº†æ— æ•ˆçš„æ‰«æã€‚ç”±äºæ–°ç”Ÿä»£æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨æ–°ç”Ÿä»£ä¹‹é—´è®°å½•å¼•ç”¨å—ï¼Ÿè¿™æ˜¯ä¸å¿…è¦çš„ï¼ŒåŸå› åœ¨äºæ¯æ¬¡GCæ—¶ï¼Œæ‰€æœ‰æ–°ç”Ÿä»£éƒ½ä¼šè¢«æ‰«æï¼Œæ‰€ä»¥åªéœ€è¦è®°å½•è€å¹´ä»£åˆ°æ–°ç”Ÿä»£ä¹‹é—´çš„å¼•ç”¨å³å¯ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¼•ç”¨çš„å¯¹è±¡å¾ˆå¤šï¼Œèµ‹å€¼å™¨éœ€è¦å¯¹æ¯ä¸ªå¼•ç”¨åšå¤„ç†ï¼Œèµ‹å€¼å™¨å¼€é”€ä¼šå¾ˆå¤§ï¼Œä¸ºäº†è§£å†³èµ‹å€¼å™¨å¼€é”€è¿™ä¸ªé—®é¢˜ï¼Œåœ¨G1 ä¸­åˆå¼•å…¥äº†å¦å¤–ä¸€ä¸ªæ¦‚å¿µï¼Œå¡è¡¨ï¼ˆCard Tableï¼‰ã€‚ä¸€ä¸ªCard Tableå°†ä¸€ä¸ªåˆ†åŒºåœ¨é€»è¾‘ä¸Šåˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„è¿ç»­åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸç§°ä¹‹ä¸ºå¡ã€‚å¡é€šå¸¸è¾ƒå°ï¼Œä»‹äº128åˆ°512å­—èŠ‚ä¹‹é—´ã€‚Card Tableé€šå¸¸ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç”±Cardçš„ç´¢å¼•ï¼ˆå³æ•°ç»„ä¸‹æ ‡ï¼‰æ¥æ ‡è¯†æ¯ä¸ªåˆ†åŒºçš„ç©ºé—´åœ°å€ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå¡éƒ½æœªè¢«å¼•ç”¨ã€‚å½“ä¸€ä¸ªåœ°å€ç©ºé—´è¢«å¼•ç”¨æ—¶ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´å¯¹åº”çš„æ•°ç»„ç´¢å¼•çš„å€¼è¢«æ ‡è®°ä¸ºâ€0â€³ï¼Œå³æ ‡è®°ä¸ºè„è¢«å¼•ç”¨ï¼Œæ­¤å¤–RSetä¹Ÿå°†è¿™ä¸ªæ•°ç»„ä¸‹æ ‡è®°å½•ä¸‹æ¥ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ä¸ªRSetå…¶å®æ˜¯ä¸€ä¸ªHash Tableï¼ŒKeyæ˜¯åˆ«çš„Regionçš„èµ·å§‹åœ°å€ï¼ŒValueæ˜¯ä¸€ä¸ªé›†åˆï¼Œé‡Œé¢çš„å…ƒç´ æ˜¯Card Tableçš„Indexã€‚</p>
<p>Young GC é˜¶æ®µï¼š</p>
<ul>
<li>é˜¶æ®µ1ï¼šæ ¹æ‰«æ<br>  é™æ€å’Œæœ¬åœ°å¯¹è±¡è¢«æ‰«æ</li>
<li>é˜¶æ®µ2ï¼šæ›´æ–°RS<br>  å¤„ç†dirty cardé˜Ÿåˆ—æ›´æ–°RS</li>
<li>é˜¶æ®µ3ï¼šå¤„ç†RS<br>  æ£€æµ‹ä»å¹´è½»ä»£æŒ‡å‘å¹´è€ä»£çš„å¯¹è±¡</li>
<li>é˜¶æ®µ4ï¼šå¯¹è±¡æ‹·è´<br>  æ‹·è´å­˜æ´»çš„å¯¹è±¡åˆ°survivor/oldåŒºåŸŸ</li>
<li>é˜¶æ®µ5ï¼šå¤„ç†å¼•ç”¨é˜Ÿåˆ—<br>  è½¯å¼•ç”¨ï¼Œå¼±å¼•ç”¨ï¼Œè™šå¼•ç”¨å¤„ç†</li>
</ul>
<h1 id="G1-Mix-GC"><a href="#G1-Mix-GC" class="headerlink" title="G1 Mix GC"></a>G1 Mix GC</h1><p>Mix GCä¸ä»…è¿›è¡Œæ­£å¸¸çš„æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†ï¼ŒåŒæ—¶ä¹Ÿå›æ”¶éƒ¨åˆ†åå°æ‰«æçº¿ç¨‹æ ‡è®°çš„è€å¹´ä»£åˆ†åŒºã€‚</p>
<p>å®ƒçš„GCæ­¥éª¤åˆ†2æ­¥ï¼š</p>
<ol>
<li>å…¨å±€å¹¶å‘æ ‡è®°ï¼ˆglobal concurrent markingï¼‰</li>
<li>æ‹·è´å­˜æ´»å¯¹è±¡ï¼ˆevacuationï¼‰</li>
</ol>
<p>åœ¨è¿›è¡ŒMix GCä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡Œglobal concurrent markingï¼ˆå…¨å±€å¹¶å‘æ ‡è®°ï¼‰ã€‚ global concurrent markingçš„æ‰§è¡Œè¿‡ç¨‹æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</p>
<p>åœ¨G1 GCä¸­ï¼Œå®ƒä¸»è¦æ˜¯ä¸ºMixed GCæä¾›æ ‡è®°æœåŠ¡çš„ï¼Œå¹¶ä¸æ˜¯ä¸€æ¬¡GCè¿‡ç¨‹çš„ä¸€ä¸ªå¿…é¡»ç¯èŠ‚ã€‚global concurrent markingçš„æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>åˆå§‹æ ‡è®°ï¼ˆinitial markï¼ŒSTWï¼‰<br>  åœ¨æ­¤é˜¶æ®µï¼ŒG1 GC å¯¹æ ¹è¿›è¡Œæ ‡è®°ã€‚è¯¥é˜¶æ®µä¸å¸¸è§„çš„ (STW) å¹´è½»ä»£åƒåœ¾å›æ”¶å¯†åˆ‡ç›¸å…³ã€‚</li>
<li>æ ¹åŒºåŸŸæ‰«æï¼ˆroot region scanï¼‰<br>  G1 GC åœ¨åˆå§‹æ ‡è®°çš„å­˜æ´»åŒºæ‰«æå¯¹è€å¹´ä»£çš„å¼•ç”¨ï¼Œå¹¶æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚è¯¥é˜¶æ®µä¸åº”ç”¨ç¨‹åºï¼ˆé STWï¼‰åŒæ—¶è¿è¡Œï¼Œå¹¶ä¸”åªæœ‰å®Œæˆè¯¥é˜¶æ®µåï¼Œæ‰èƒ½å¼€å§‹ä¸‹ä¸€æ¬¡ STW å¹´è½»ä»£åƒåœ¾å›æ”¶ã€‚</li>
<li>å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰<br>  G1 GC åœ¨æ•´ä¸ªå †ä¸­æŸ¥æ‰¾å¯è®¿é—®çš„ï¼ˆå­˜æ´»çš„ï¼‰å¯¹è±¡ã€‚è¯¥é˜¶æ®µä¸åº”ç”¨ç¨‹åºåŒæ—¶è¿è¡Œï¼Œå¯ä»¥è¢« STW å¹´è½»ä»£åƒåœ¾å›æ”¶ä¸­æ–­</li>
<li>æœ€ç»ˆæ ‡è®°ï¼ˆRemarkï¼ŒSTWï¼‰<br>  è¯¥é˜¶æ®µæ˜¯ STW å›æ”¶ï¼Œå¸®åŠ©å®Œæˆæ ‡è®°å‘¨æœŸã€‚G1 GC æ¸…ç©º SATB ç¼“å†²åŒºï¼Œè·Ÿè¸ªæœªè¢«è®¿é—®çš„å­˜æ´»å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œå¼•ç”¨å¤„ç†ã€‚</li>
<li>æ¸…é™¤åƒåœ¾ï¼ˆCleanupï¼ŒSTWï¼‰<br>  åœ¨è¿™ä¸ªæœ€åé˜¶æ®µï¼ŒG1 GC æ‰§è¡Œç»Ÿè®¡å’Œ RSet å‡€åŒ–çš„ STW æ“ä½œã€‚åœ¨ç»Ÿè®¡æœŸé—´ï¼ŒG1 GC ä¼šè¯†åˆ«å®Œå…¨ç©ºé—²çš„åŒºåŸŸå’Œå¯ä¾›è¿›è¡Œæ··åˆåƒåœ¾å›æ”¶çš„åŒºåŸŸã€‚æ¸…ç†é˜¶æ®µåœ¨å°†ç©ºç™½åŒºåŸŸé‡ç½®å¹¶è¿”å›åˆ°ç©ºé—²åˆ—è¡¨æ—¶ä¸ºéƒ¨åˆ†å¹¶å‘ã€‚</li>
</ul>
<p><strong>ä¸‰è‰²æ ‡è®°ç®—æ³•</strong></p>
<p>æåˆ°å¹¶å‘æ ‡è®°ï¼Œæˆ‘ä»¬ä¸å¾—ä¸äº†è§£å¹¶å‘æ ‡è®°çš„ä¸‰è‰²æ ‡è®°ç®—æ³•ã€‚å®ƒæ˜¯æè¿°è¿½è¸ªå¼å›æ”¶å™¨çš„ä¸€ç§æœ‰ç”¨çš„æ–¹æ³•ï¼Œåˆ©ç”¨å®ƒå¯ä»¥æ¨æ¼”å›æ”¶å™¨çš„æ­£ç¡®æ€§ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å°†å¯¹è±¡åˆ†æˆä¸‰ç§ç±»å‹çš„ã€‚</p>
<ul>
<li>é»‘è‰²:æ ¹å¯¹è±¡ï¼Œæˆ–è€…è¯¥å¯¹è±¡ä¸å®ƒçš„å­å¯¹è±¡éƒ½è¢«æ‰«æ</li>
<li>ç°è‰²:å¯¹è±¡æœ¬èº«è¢«æ‰«æ,ä½†è¿˜æ²¡æ‰«æå®Œè¯¥å¯¹è±¡ä¸­çš„å­å¯¹è±¡</li>
<li>ç™½è‰²:æœªè¢«æ‰«æå¯¹è±¡ï¼Œæ‰«æå®Œæˆæ‰€æœ‰å¯¹è±¡ä¹‹åï¼Œæœ€ç»ˆä¸ºç™½è‰²çš„ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œå³åƒåœ¾å¯¹è±¡</li>
</ul>
<p>å½“GCå¼€å§‹æ‰«æå¯¹è±¡æ—¶ï¼ŒæŒ‰ç…§å¦‚ä¸‹å›¾æ­¥éª¤è¿›è¡Œå¯¹è±¡çš„æ‰«æï¼š</p>
<p>æ ¹å¯¹è±¡è¢«ç½®ä¸ºé»‘è‰²ï¼Œå­å¯¹è±¡è¢«ç½®ä¸ºç°è‰²ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-6.png"><img src="http://idiotsky.top/images3/G1-6.png" alt=""></a></p>
<p>ç»§ç»­ç”±ç°è‰²éå†,å°†å·²æ‰«æäº†å­å¯¹è±¡çš„å¯¹è±¡ç½®ä¸ºé»‘è‰²ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-7.png"><img src="http://idiotsky.top/images3/G1-7.png" alt=""></a></p>
<p>éå†äº†æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡åï¼Œæ‰€æœ‰å¯è¾¾çš„å¯¹è±¡éƒ½å˜æˆäº†é»‘è‰²ã€‚ä¸å¯è¾¾çš„å¯¹è±¡å³ä¸ºç™½è‰²ï¼Œéœ€è¦è¢«æ¸…ç†ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-8.png"><img src="http://idiotsky.top/images3/G1-8.png" alt=""></a></p>
<p>è¿™çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œä½†æ˜¯å¦‚æœåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¹Ÿåœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¯¹è±¡çš„æŒ‡é’ˆå°±æœ‰å¯èƒ½æ”¹å˜ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå¯¹è±¡ä¸¢å¤±é—®é¢˜</p>
<p>æˆ‘ä»¬çœ‹ä¸‹é¢ä¸€ç§æƒ…å†µï¼Œå½“åƒåœ¾æ”¶é›†å™¨æ‰«æåˆ°ä¸‹é¢æƒ…å†µæ—¶ï¼š</p>
<p><a href="http://idiotsky.top/images3/G1-9.png"><img src="http://idiotsky.top/images3/G1-9.png" alt=""></a></p>
<p>è¿™æ—¶å€™åº”ç”¨ç¨‹åºæ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š</p>
<blockquote>
<p>A.c=C<br>B.c=null</p>
</blockquote>
<p>è¿™æ ·ï¼Œå¯¹è±¡çš„çŠ¶æ€å›¾å˜æˆå¦‚ä¸‹æƒ…å½¢ï¼š</p>
<p><a href="http://idiotsky.top/images3/G1-10.png"><img src="http://idiotsky.top/images3/G1-10.png" alt=""></a></p>
<p>è¿™æ—¶å€™åƒåœ¾æ”¶é›†å™¨å†æ ‡è®°æ‰«æçš„æ—¶å€™å°±ä¼šä¸‹å›¾æˆè¿™æ ·ï¼š</p>
<p><a href="http://idiotsky.top/images3/G1-11.png"><img src="http://idiotsky.top/images3/G1-11.png" alt=""></a></p>
<p>å¾ˆæ˜¾ç„¶ï¼Œæ­¤æ—¶Cæ˜¯ç™½è‰²ï¼Œè¢«è®¤ä¸ºæ˜¯åƒåœ¾éœ€è¦æ¸…ç†æ‰ï¼Œæ˜¾ç„¶è¿™æ˜¯ä¸åˆç†çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¿è¯åº”ç”¨ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™ï¼ŒGCæ ‡è®°çš„å¯¹è±¡ä¸ä¸¢å¤±å‘¢ï¼Ÿæœ‰å¦‚ä¸‹2ä¸­å¯è¡Œçš„æ–¹å¼ï¼š</p>
<ol>
<li>åœ¨æ’å…¥çš„æ—¶å€™è®°å½•å¯¹è±¡</li>
<li>åœ¨åˆ é™¤çš„æ—¶å€™è®°å½•å¯¹è±¡</li>
</ol>
<p>åˆšå¥½è¿™å¯¹åº”CMSå’ŒG1çš„2ç§ä¸åŒå®ç°æ–¹å¼ï¼š</p>
<p>åœ¨CMSé‡‡ç”¨çš„æ˜¯å¢é‡æ›´æ–°ï¼ˆIncremental updateï¼‰ï¼Œåªè¦åœ¨å†™å±éšœï¼ˆwrite barrierï¼‰é‡Œå‘ç°è¦æœ‰ä¸€ä¸ªç™½å¯¹è±¡çš„å¼•ç”¨è¢«èµ‹å€¼åˆ°ä¸€ä¸ªé»‘å¯¹è±¡ çš„å­—æ®µé‡Œï¼Œé‚£å°±æŠŠè¿™ä¸ªç™½å¯¹è±¡å˜æˆç°è‰²çš„ã€‚å³æ’å…¥çš„æ—¶å€™è®°å½•ä¸‹æ¥ã€‚</p>
<p>åœ¨G1ä¸­ï¼Œä½¿ç”¨çš„æ˜¯STABï¼ˆsnapshot-at-the-beginningï¼‰çš„æ–¹å¼ï¼Œåˆ é™¤çš„æ—¶å€™è®°å½•æ‰€æœ‰çš„å¯¹è±¡ï¼Œå®ƒæœ‰3ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>åœ¨å¼€å§‹æ ‡è®°çš„æ—¶å€™ç”Ÿæˆä¸€ä¸ªå¿«ç…§å›¾æ ‡è®°å­˜æ´»å¯¹è±¡</li>
<li>åœ¨å¹¶å‘æ ‡è®°çš„æ—¶å€™æ‰€æœ‰è¢«æ”¹å˜çš„å¯¹è±¡å…¥é˜Ÿï¼ˆåœ¨write barrieré‡ŒæŠŠæ‰€æœ‰æ—§çš„å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡éƒ½å˜æˆéç™½çš„ï¼‰</li>
<li>å¯èƒ½å­˜åœ¨æ¸¸ç¦»çš„åƒåœ¾ï¼Œå°†åœ¨ä¸‹æ¬¡è¢«æ”¶é›†</li>
</ol>
<p>è¿™æ ·ï¼ŒG1åˆ°ç°åœ¨å¯ä»¥çŸ¥é“å“ªäº›è€çš„åˆ†åŒºå¯å›æ”¶åƒåœ¾æœ€å¤šã€‚ å½“å…¨å±€å¹¶å‘æ ‡è®°å®Œæˆåï¼Œåœ¨æŸä¸ªæ—¶åˆ»ï¼Œå°±å¼€å§‹äº†Mix GCã€‚è¿™äº›åƒåœ¾å›æ”¶è¢«ç§°ä½œâ€œæ··åˆå¼â€æ˜¯å› ä¸ºä»–ä»¬ä¸ä»…ä»…è¿›è¡Œæ­£å¸¸çš„æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†ï¼ŒåŒæ—¶ä¹Ÿå›æ”¶éƒ¨åˆ†åå°æ‰«æçº¿ç¨‹æ ‡è®°çš„åˆ†åŒºã€‚æ··åˆå¼åƒåœ¾æ”¶é›†å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images3/G1-12.png"><img src="http://idiotsky.top/images3/G1-12.png" alt=""></a></p>
<p>æ··åˆå¼GCä¹Ÿæ˜¯é‡‡ç”¨çš„å¤åˆ¶çš„æ¸…ç†ç­–ç•¥ï¼Œå½“GCå®Œæˆåï¼Œä¼šé‡æ–°é‡Šæ”¾ç©ºé—´ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-13.png"><img src="http://idiotsky.top/images3/G1-13.png" alt=""></a></p>
<p>è‡³æ­¤ï¼Œæ··åˆå¼GCå‘Šä¸€æ®µè½äº†ã€‚ä¸‹ä¸€å°èŠ‚æˆ‘ä»¬è®²è¿›å…¥è°ƒä¼˜å®è·µã€‚</p>
<h1 id="è°ƒä¼˜å®è·µ"><a href="#è°ƒä¼˜å®è·µ" class="headerlink" title="è°ƒä¼˜å®è·µ"></a>è°ƒä¼˜å®è·µ</h1><p><strong>MaxGCPauseMillisè°ƒä¼˜</strong></p>
<p>å‰é¢ä»‹ç»è¿‡ä½¿ç”¨GCçš„æœ€åŸºæœ¬çš„å‚æ•°ï¼š</p>
<blockquote>
<p>-XX:+UseG1GC -Xmx32g -XX:MaxGCPauseMillis=200</p>
</blockquote>
<p>å‰é¢2ä¸ªå‚æ•°éƒ½å¥½ç†è§£ï¼Œåé¢è¿™ä¸ªMaxGCPauseMilliså‚æ•°è¯¥æ€ä¹ˆé…ç½®å‘¢ï¼Ÿè¿™ä¸ªå‚æ•°ä»å­—é¢çš„æ„æ€ä¸Šçœ‹ï¼Œå°±æ˜¯å…è®¸çš„GCæœ€å¤§çš„æš‚åœæ—¶é—´ã€‚G1å°½é‡ç¡®ä¿æ¯æ¬¡GCæš‚åœçš„æ—¶é—´éƒ½åœ¨è®¾ç½®çš„MaxGCPauseMillisèŒƒå›´å†…ã€‚ é‚£G1æ˜¯å¦‚ä½•åšåˆ°æœ€å¤§æš‚åœæ—¶é—´çš„å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°å¦ä¸€ä¸ªæ¦‚å¿µï¼ŒCSet(collection set)ã€‚å®ƒçš„æ„æ€æ˜¯åœ¨ä¸€æ¬¡åƒåœ¾æ”¶é›†å™¨ä¸­è¢«æ”¶é›†çš„åŒºåŸŸé›†åˆã€‚</p>
<ul>
<li>Young GCï¼šé€‰å®šæ‰€æœ‰æ–°ç”Ÿä»£é‡Œçš„regionã€‚é€šè¿‡æ§åˆ¶æ–°ç”Ÿä»£çš„regionä¸ªæ•°æ¥æ§åˆ¶young GCçš„å¼€é”€ã€‚</li>
<li>Mixed GCï¼šé€‰å®šæ‰€æœ‰æ–°ç”Ÿä»£é‡Œçš„regionï¼Œå¤–åŠ æ ¹æ®global concurrent markingç»Ÿè®¡å¾—å‡ºæ”¶é›†æ”¶ç›Šé«˜çš„è‹¥å¹²è€å¹´ä»£regionã€‚åœ¨ç”¨æˆ·æŒ‡å®šçš„å¼€é”€ç›®æ ‡èŒƒå›´å†…å°½å¯èƒ½é€‰æ‹©æ”¶ç›Šé«˜çš„è€å¹´ä»£regionã€‚</li>
</ul>
<p>åœ¨ç†è§£äº†è¿™äº›åï¼Œæˆ‘ä»¬å†è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´å°±å¥½åŠäº†ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬èƒ½å®¹å¿çš„æœ€å¤§æš‚åœæ—¶é—´æ˜¯æœ‰ä¸€ä¸ªé™åº¦çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªé™åº¦èŒƒå›´å†…è®¾ç½®ã€‚ä½†æ˜¯åº”è¯¥è®¾ç½®çš„å€¼æ˜¯å¤šå°‘å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åœ¨ååé‡è·ŸMaxGCPauseMillisä¹‹é—´åšä¸€ä¸ªå¹³è¡¡ã€‚å¦‚æœMaxGCPauseMillisè®¾ç½®çš„è¿‡å°ï¼Œé‚£ä¹ˆGCå°±ä¼šé¢‘ç¹ï¼Œååé‡å°±ä¼šä¸‹é™ã€‚å¦‚æœMaxGCPauseMillisè®¾ç½®çš„è¿‡å¤§ï¼Œåº”ç”¨ç¨‹åºæš‚åœæ—¶é—´å°±ä¼šå˜é•¿ã€‚G1çš„é»˜è®¤æš‚åœæ—¶é—´æ˜¯200æ¯«ç§’ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå…¥æ‰‹ï¼Œè°ƒæ•´åˆé€‚çš„æ—¶é—´ã€‚</p>
<p><strong>å…¶ä»–è°ƒä¼˜å‚æ•°</strong></p>
<blockquote>
<p>-XX:G1HeapRegionSize=n</p>
</blockquote>
<p>è®¾ç½®çš„ G1 åŒºåŸŸçš„å¤§å°ã€‚å€¼æ˜¯ 2 çš„å¹‚ï¼ŒèŒƒå›´æ˜¯ 1 MB åˆ° 32 MB ä¹‹é—´ã€‚ç›®æ ‡æ˜¯æ ¹æ®æœ€å°çš„ Java å †å¤§å°åˆ’åˆ†å‡ºçº¦ 2048 ä¸ªåŒºåŸŸã€‚</p>
<blockquote>
<p>-XX:ParallelGCThreads=n</p>
</blockquote>
<p>è®¾ç½® STW å·¥ä½œçº¿ç¨‹æ•°çš„å€¼ã€‚å°† n çš„å€¼è®¾ç½®ä¸ºé€»è¾‘å¤„ç†å™¨çš„æ•°é‡ã€‚n çš„å€¼ä¸é€»è¾‘å¤„ç†å™¨çš„æ•°é‡ç›¸åŒï¼Œæœ€å¤šä¸º 8ã€‚</p>
<p>å¦‚æœé€»è¾‘å¤„ç†å™¨ä¸æ­¢å…«ä¸ªï¼Œåˆ™å°† n çš„å€¼è®¾ç½®ä¸ºé€»è¾‘å¤„ç†å™¨æ•°çš„ 5/8 å·¦å³ã€‚è¿™é€‚ç”¨äºå¤§å¤šæ•°æƒ…å†µï¼Œé™¤éæ˜¯è¾ƒå¤§çš„ SPARC ç³»ç»Ÿï¼Œå…¶ä¸­ n çš„å€¼å¯ä»¥æ˜¯é€»è¾‘å¤„ç†å™¨æ•°çš„ 5/16 å·¦å³ã€‚</p>
<blockquote>
<p>-XX:ConcGCThreads=n</p>
</blockquote>
<p>è®¾ç½®å¹¶è¡Œæ ‡è®°çš„çº¿ç¨‹æ•°ã€‚å°† n è®¾ç½®ä¸ºå¹¶è¡Œåƒåœ¾å›æ”¶çº¿ç¨‹æ•° (ParallelGCThreads) çš„ 1/4 å·¦å³ã€‚</p>
<blockquote>
<p>-XX:InitiatingHeapOccupancyPercent=45</p>
</blockquote>
<p>è®¾ç½®è§¦å‘æ ‡è®°å‘¨æœŸçš„ Java å †å ç”¨ç‡é˜ˆå€¼ã€‚é»˜è®¤å ç”¨ç‡æ˜¯æ•´ä¸ª Java å †çš„ 45%ã€‚</p>
<p>é¿å…ä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š</p>
<p>é¿å…ä½¿ç”¨ -Xmn é€‰é¡¹æˆ– -XX:NewRatio ç­‰å…¶ä»–ç›¸å…³é€‰é¡¹æ˜¾å¼è®¾ç½®å¹´è½»ä»£å¤§å°ã€‚å›ºå®šå¹´è½»ä»£çš„å¤§å°ä¼šè¦†ç›–æš‚åœæ—¶é—´ç›®æ ‡ã€‚</p>
<p><strong>è§¦å‘Full GC</strong></p>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒG1è§¦å‘äº†Full GCï¼Œè¿™æ—¶G1ä¼šé€€åŒ–ä½¿ç”¨Serialæ”¶é›†å™¨æ¥å®Œæˆåƒåœ¾çš„æ¸…ç†å·¥ä½œï¼Œå®ƒä»…ä»…ä½¿ç”¨å•çº¿ç¨‹æ¥å®ŒæˆGCå·¥ä½œï¼ŒGCæš‚åœæ—¶é—´å°†è¾¾åˆ°ç§’çº§åˆ«çš„ã€‚æ•´ä¸ªåº”ç”¨å¤„äºå‡æ­»çŠ¶æ€ï¼Œä¸èƒ½å¤„ç†ä»»ä½•è¯·æ±‚ï¼Œæˆ‘ä»¬çš„ç¨‹åºå½“ç„¶ä¸å¸Œæœ›çœ‹åˆ°è¿™äº›ã€‚é‚£ä¹ˆå‘ç”ŸFull GCçš„æƒ…å†µæœ‰å“ªäº›å‘¢ï¼Ÿ</p>
<ul>
<li>å¹¶å‘æ¨¡å¼å¤±è´¥<br>  G1å¯åŠ¨æ ‡è®°å‘¨æœŸï¼Œä½†åœ¨Mix GCä¹‹å‰ï¼Œè€å¹´ä»£å°±è¢«å¡«æ»¡ï¼Œè¿™æ—¶å€™G1ä¼šæ”¾å¼ƒæ ‡è®°å‘¨æœŸã€‚è¿™ç§æƒ…å½¢ä¸‹ï¼Œéœ€è¦å¢åŠ å †å¤§å°ï¼Œæˆ–è€…è°ƒæ•´å‘¨æœŸï¼ˆä¾‹å¦‚å¢åŠ çº¿ç¨‹æ•°-XX:ConcGCThreadsç­‰ï¼‰ã€‚</li>
<li>æ™‹å‡å¤±è´¥æˆ–è€…ç–æ•£å¤±è´¥<br>  G1åœ¨è¿›è¡ŒGCçš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ä¾›å­˜æ´»å¯¹è±¡æˆ–æ™‹å‡å¯¹è±¡ä½¿ç”¨ï¼Œç”±æ­¤è§¦å‘äº†Full GCã€‚å¯ä»¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°(to-space exhausted)æˆ–è€…ï¼ˆto-space overflowï¼‰ã€‚è§£å†³è¿™ç§é—®é¢˜çš„æ–¹å¼æ˜¯ï¼š<ol>
<li>å¢åŠ  -XX:G1ReservePercent é€‰é¡¹çš„å€¼ï¼ˆå¹¶ç›¸åº”å¢åŠ æ€»çš„å †å¤§å°ï¼‰ï¼Œä¸ºâ€œç›®æ ‡ç©ºé—´â€å¢åŠ é¢„ç•™å†…å­˜é‡ã€‚</li>
<li>é€šè¿‡å‡å°‘ -XX:InitiatingHeapOccupancyPercent æå‰å¯åŠ¨æ ‡è®°å‘¨æœŸã€‚</li>
<li>ä¹Ÿå¯ä»¥é€šè¿‡å¢åŠ  -XX:ConcGCThreads é€‰é¡¹çš„å€¼æ¥å¢åŠ å¹¶è¡Œæ ‡è®°çº¿ç¨‹çš„æ•°ç›®ã€‚</li>
</ol>
</li>
<li>å·¨å‹å¯¹è±¡åˆ†é…å¤±è´¥<br>  å½“å·¨å‹å¯¹è±¡æ‰¾ä¸åˆ°åˆé€‚çš„ç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œå°±ä¼šå¯åŠ¨Full GCï¼Œæ¥é‡Šæ”¾ç©ºé—´ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥é¿å…åˆ†é…å¤§é‡çš„å·¨å‹å¯¹è±¡ï¼Œå¢åŠ å†…å­˜æˆ–è€…å¢å¤§-XX:G1HeapRegionSizeï¼Œä½¿å·¨å‹å¯¹è±¡ä¸å†æ˜¯å·¨å‹å¯¹è±¡ã€‚</li>
</ul>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://blog.jobbole.com/109170/" target="_blank" rel="noopener">http://blog.jobbole.com/109170/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æ­¤æ–‡ç« é™¤äº†è¯´g1,è¿˜é¡ºå¸¦æ€»ç»“äº†ä¸€äº›å…¶ä»–æ¦‚å¿µï¼Œmarkä¹‹ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æœ¬æ–‡é¦–å…ˆç®€å•ä»‹ç»äº†åƒåœ¾æ”¶é›†çš„å¸¸è§æ–¹å¼ï¼Œç„¶åå†åˆ†æäº†G1æ”¶é›†å™¨çš„æ”¶é›†åŸç†ï¼Œç›¸æ¯”å…¶ä»–åƒåœ¾æ”¶é›†å™¨çš„ä¼˜åŠ¿ï¼Œæœ€åç»™å‡ºäº†ä¸€äº›è°ƒä¼˜å®è·µã€‚&lt;/p&gt;
&lt;h1 id=&quot;ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶&lt;/h1&gt;&lt;p&gt;é¦–å…ˆï¼Œåœ¨äº†è§£G1ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¸…æ¥šçš„çŸ¥é“ï¼Œåƒåœ¾å›æ”¶æ˜¯ä»€ä¹ˆï¼Ÿç®€å•çš„è¯´åƒåœ¾å›æ”¶å°±æ˜¯å›æ”¶å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚&lt;/p&gt;
&lt;p&gt;åƒåœ¾å›æ”¶çš„åŸºæœ¬æ­¥éª¤&lt;/p&gt;
&lt;p&gt;å›æ”¶çš„æ­¥éª¤æœ‰2æ­¥ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŸ¥æ‰¾å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡&lt;/li&gt;
&lt;li&gt;é‡Šæ”¾è¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥æ‰¾å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡&lt;/strong&gt;&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.top/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.top/tags/java/"/>
    
      <category term="G1" scheme="http://idiotsky.top/tags/G1/"/>
    
  </entry>
  
  <entry>
    <title>java ConcurrentHashMapè§£æ</title>
    <link href="http://idiotsky.top/2018/07/28/java-concurrenthashmap/"/>
    <id>http://idiotsky.top/2018/07/28/java-concurrenthashmap/</id>
    <published>2018-07-28T07:31:20.000Z</published>
    <updated>2018-09-13T12:06:17.276Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢</p>
</blockquote>
<h1 id="jdk6å’Œjdk7ä¸­çš„å®ç°"><a href="#jdk6å’Œjdk7ä¸­çš„å®ç°" class="headerlink" title="jdk6å’Œjdk7ä¸­çš„å®ç°"></a>jdk6å’Œjdk7ä¸­çš„å®ç°</h1><h2 id="è®¾è®¡æ€è·¯"><a href="#è®¾è®¡æ€è·¯" class="headerlink" title="è®¾è®¡æ€è·¯"></a>è®¾è®¡æ€è·¯</h2><p>ConcurrentHashMapé‡‡ç”¨äº†åˆ†æ®µé”çš„è®¾è®¡ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†æ®µå†…æ‰å­˜åœ¨ç«æ€å…³ç³»ï¼Œä¸åŒçš„åˆ†æ®µé”ä¹‹é—´æ²¡æœ‰é”ç«äº‰ã€‚ç›¸æ¯”äºå¯¹æ•´ä¸ªMapåŠ é”çš„è®¾è®¡ï¼Œåˆ†æ®µé”å¤§å¤§çš„æé«˜äº†é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å¤„ç†èƒ½åŠ›ã€‚ä½†åŒæ—¶ï¼Œç”±äºä¸æ˜¯å¯¹æ•´ä¸ªMapåŠ é”ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦æ‰«ææ•´ä¸ªMapçš„æ–¹æ³•ï¼ˆå¦‚size(), containsValue()ï¼‰éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„å®ç°ï¼Œå¦å¤–ä¸€äº›æ–¹æ³•ï¼ˆå¦‚clear()ï¼‰ç”šè‡³æ”¾å¼ƒäº†å¯¹ä¸€è‡´æ€§çš„è¦æ±‚ï¼ˆConcurrentHashMapæ˜¯å¼±ä¸€è‡´æ€§çš„ï¼‰ã€‚</p>
<p>ConcurrentHashMapä¸­çš„åˆ†æ®µé”ç§°ä¸ºSegmentï¼Œå®ƒå³ç±»ä¼¼äºHashMapçš„ç»“æ„ï¼Œå³å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªEntryæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼›åŒæ—¶åˆæ˜¯ä¸€ä¸ªReentrantLockï¼ˆSegmentç»§æ‰¿äº†ReentrantLockï¼‰ã€‚ConcurrentHashMapä¸­çš„HashEntryç›¸å¯¹äºHashMapä¸­çš„Entryæœ‰ä¸€å®šçš„å·®å¼‚æ€§ï¼šHashEntryä¸­çš„valueä»¥åŠnextéƒ½è¢«volatileä¿®é¥°ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹è¯»å†™è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒå®ƒä»¬çš„å¯è§æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HashEntry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        <span class="keyword">volatile</span> V value;</span><br><span class="line">        <span class="keyword">volatile</span> HashEntry&lt;K,V&gt; next;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="å¹¶å‘åº¦ï¼ˆConcurrency-Levelï¼‰"><a href="#å¹¶å‘åº¦ï¼ˆConcurrency-Levelï¼‰" class="headerlink" title="å¹¶å‘åº¦ï¼ˆConcurrency Levelï¼‰"></a>å¹¶å‘åº¦ï¼ˆConcurrency Levelï¼‰</h2><p>å¹¶å‘åº¦å¯ä»¥ç†è§£ä¸ºç¨‹åºè¿è¡Œæ—¶èƒ½å¤ŸåŒæ—¶æ›´æ–°ConccurentHashMapä¸”ä¸äº§ç”Ÿé”ç«äº‰çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯ConcurrentHashMapä¸­çš„åˆ†æ®µé”ä¸ªæ•°ï¼Œå³Segment[]çš„æ•°ç»„é•¿åº¦ã€‚ConcurrentHashMapé»˜è®¤çš„å¹¶å‘åº¦ä¸º16ï¼Œä½†ç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½®å¹¶å‘åº¦ã€‚å½“ç”¨æˆ·è®¾ç½®å¹¶å‘åº¦æ—¶ï¼ŒConcurrentHashMapä¼šä½¿ç”¨å¤§äºç­‰äºè¯¥å€¼çš„æœ€å°2å¹‚æŒ‡æ•°ä½œä¸ºå®é™…å¹¶å‘åº¦ï¼ˆå‡å¦‚ç”¨æˆ·è®¾ç½®å¹¶å‘åº¦ä¸º17ï¼Œå®é™…å¹¶å‘åº¦åˆ™ä¸º32ï¼‰ã€‚è¿è¡Œæ—¶é€šè¿‡å°†keyçš„é«˜nä½ï¼ˆ<code>n = 32 â€“ segmentShift</code>ï¼‰å’Œå¹¶å‘åº¦å‡1ï¼ˆsegmentMaskï¼‰åšä½ä¸è¿ç®—å®šä½åˆ°æ‰€åœ¨çš„Segmentã€‚segmentShiftä¸segmentMaskéƒ½æ˜¯åœ¨æ„é€ è¿‡ç¨‹ä¸­æ ¹æ®concurrency levelè¢«ç›¸åº”çš„è®¡ç®—å‡ºæ¥ã€‚</p>
<p>å¦‚æœå¹¶å‘åº¦è®¾ç½®çš„è¿‡å°ï¼Œä¼šå¸¦æ¥ä¸¥é‡çš„é”ç«äº‰é—®é¢˜ï¼›å¦‚æœå¹¶å‘åº¦è®¾ç½®çš„è¿‡å¤§ï¼ŒåŸæœ¬ä½äºåŒä¸€ä¸ªSegmentå†…çš„è®¿é—®ä¼šæ‰©æ•£åˆ°ä¸åŒçš„Segmentä¸­ï¼ŒCPU cacheå‘½ä¸­ç‡ä¼šä¸‹é™ï¼Œä»è€Œå¼•èµ·ç¨‹åºæ€§èƒ½ä¸‹é™ã€‚ï¼ˆæ–‡æ¡£çš„è¯´æ³•æ˜¯æ ¹æ®ä½ å¹¶å‘çš„çº¿ç¨‹æ•°é‡å†³å®šï¼Œå¤ªå¤šä¼šå¯¼æ€§èƒ½é™ä½ï¼‰</p>
<h2 id="åˆ›å»ºåˆ†æ®µé”"><a href="#åˆ›å»ºåˆ†æ®µé”" class="headerlink" title="åˆ›å»ºåˆ†æ®µé”"></a>åˆ›å»ºåˆ†æ®µé”</h2><p>å’ŒJDK6ä¸åŒï¼ŒJDK7ä¸­é™¤äº†ç¬¬ä¸€ä¸ªSegmentä¹‹å¤–ï¼Œå‰©ä½™çš„Segmentsé‡‡ç”¨çš„æ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„æœºåˆ¶ï¼šæ¯æ¬¡putä¹‹å‰éƒ½éœ€è¦æ£€æŸ¥keyå¯¹åº”çš„Segmentæ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ensureSegment()ä»¥ç¡®ä¿å¯¹åº”çš„Segmentè¢«åˆ›å»ºã€‚</p>
<p>ensureSegmentå¯èƒ½åœ¨å¹¶å‘ç¯å¢ƒä¸‹è¢«è°ƒç”¨ï¼Œä½†ä¸æƒ³è±¡ä¸­ä¸åŒï¼ŒensureSegmentå¹¶æœªä½¿ç”¨é”æ¥æ§åˆ¶ç«äº‰ï¼Œè€Œæ˜¯ä½¿ç”¨äº†Unsafeå¯¹è±¡çš„getObjectVolatile()æä¾›çš„åŸå­è¯»è¯­ä¹‰ç»“åˆCASæ¥ç¡®ä¿Segmentåˆ›å»ºçš„åŸå­æ€§ã€‚ä»£ç æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                == <span class="keyword">null</span>) &#123; <span class="comment">// recheck</span></span><br><span class="line">                Segment&lt;K,V&gt; s = <span class="keyword">new</span> Segment&lt;K,V&gt;(lf, threshold, tab);</span><br><span class="line">                <span class="keyword">while</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                       == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(ss, u, <span class="keyword">null</span>, seg = s))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="put-putIfAbsent-putAll"><a href="#put-putIfAbsent-putAll" class="headerlink" title="put/putIfAbsent/putAll"></a>put/putIfAbsent/putAll</h2><p>å’ŒJDK6ä¸€æ ·ï¼ŒConcurrentHashMapçš„putæ–¹æ³•è¢«ä»£ç†åˆ°äº†å¯¹åº”çš„Segmentï¼ˆå®šä½Segmentçš„åŸç†ä¹‹å‰å·²ç»æè¿°è¿‡ï¼‰ä¸­ã€‚ä¸JDK6ä¸åŒçš„æ˜¯ï¼ŒJDK7ç‰ˆæœ¬çš„ConcurrentHashMapåœ¨è·å¾—Segmenté”çš„è¿‡ç¨‹ä¸­ï¼Œåšäº†ä¸€å®šçš„ä¼˜åŒ– - åœ¨çœŸæ­£ç”³è¯·é”ä¹‹å‰ï¼Œputæ–¹æ³•ä¼šé€šè¿‡tryLock()æ–¹æ³•å°è¯•è·å¾—é”ï¼Œåœ¨å°è¯•è·å¾—é”çš„è¿‡ç¨‹ä¸­ä¼šå¯¹å¯¹åº”hashcodeçš„é“¾è¡¨è¿›è¡Œéå†ï¼Œå¦‚æœéå†å®Œæ¯•ä»ç„¶æ‰¾ä¸åˆ°ä¸keyç›¸åŒçš„HashEntryèŠ‚ç‚¹ï¼Œåˆ™ä¸ºåç»­çš„putæ“ä½œæå‰åˆ›å»ºä¸€ä¸ªHashEntryã€‚å½“tryLockä¸€å®šæ¬¡æ•°åä»æ— æ³•è·å¾—é”ï¼Œåˆ™é€šè¿‡lockç”³è¯·é”ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºåœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå…¶ä»–çº¿ç¨‹çš„putï¼Œrehashæˆ–è€…removeæ“ä½œå¯èƒ½ä¼šå¯¼è‡´é“¾è¡¨å¤´ç»“ç‚¹çš„å˜åŒ–ï¼Œå› æ­¤åœ¨è¿‡ç¨‹ä¸­éœ€è¦è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå¤´ç»“ç‚¹å‘ç”Ÿå˜åŒ–åˆ™é‡æ–°å¯¹è¡¨è¿›è¡Œéå†ã€‚è€Œå¦‚æœå…¶ä»–çº¿ç¨‹å¼•èµ·äº†é“¾è¡¨ä¸­çš„æŸä¸ªèŠ‚ç‚¹è¢«åˆ é™¤ï¼Œå³ä½¿è¯¥å˜åŒ–å› ä¸ºæ˜¯éåŸå­å†™æ“ä½œï¼ˆåˆ é™¤èŠ‚ç‚¹åé“¾æ¥åç»­èŠ‚ç‚¹è°ƒç”¨çš„æ˜¯Unsafe.putOrderedObject()ï¼Œè¯¥æ–¹æ³•ä¸æä¾›åŸå­å†™è¯­ä¹‰ï¼‰å¯èƒ½å¯¼è‡´å½“å‰çº¿ç¨‹æ— æ³•è§‚å¯Ÿåˆ°ï¼Œä½†å› ä¸ºä¸å½±å“éå†çš„æ­£ç¡®æ€§æ‰€ä»¥å¿½ç•¥ä¸è®¡ã€‚</p>
<p>ä¹‹æ‰€ä»¥åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­å¯¹æ•´ä¸ªé“¾è¡¨è¿›è¡Œéå†ï¼Œä¸»è¦ç›®çš„æ˜¯å¸Œæœ›éå†çš„é“¾è¡¨è¢«CPU cacheæ‰€ç¼“å­˜ï¼Œä¸ºåç»­å®é™…putè¿‡ç¨‹ä¸­çš„é“¾è¡¨éå†æ“ä½œæå‡æ€§èƒ½ã€‚</p>
<p>åœ¨è·å¾—é”ä¹‹åï¼ŒSegmentå¯¹é“¾è¡¨è¿›è¡Œéå†ï¼Œå¦‚æœæŸä¸ªHashEntryèŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„keyï¼Œåˆ™æ›´æ–°è¯¥HashEntryçš„valueå€¼ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ªHashEntryèŠ‚ç‚¹ï¼Œå°†å®ƒè®¾ç½®ä¸ºé“¾è¡¨çš„æ–°headèŠ‚ç‚¹å¹¶å°†åŸå¤´èŠ‚ç‚¹è®¾ä¸ºæ–°headçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚æ–°å»ºè¿‡ç¨‹ä¸­å¦‚æœèŠ‚ç‚¹æ€»æ•°ï¼ˆå«æ–°å»ºçš„HashEntryï¼‰è¶…è¿‡thresholdï¼Œåˆ™è°ƒç”¨rehash()æ–¹æ³•å¯¹Segmentè¿›è¡Œæ‰©å®¹ï¼Œæœ€åå°†æ–°å»ºHashEntryå†™å…¥åˆ°æ•°ç»„ä¸­ã€‚</p>
<p>putæ–¹æ³•ä¸­ï¼Œé“¾æ¥æ–°èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆHashEntry.setNext()ï¼‰ä»¥åŠå°†é“¾è¡¨å†™å…¥åˆ°æ•°ç»„ä¸­ï¼ˆsetEntryAt()ï¼‰éƒ½æ˜¯é€šè¿‡Unsafeçš„putOrderedObject()æ–¹æ³•æ¥å®ç°ï¼Œè¿™é‡Œå¹¶æœªä½¿ç”¨å…·æœ‰åŸå­å†™è¯­ä¹‰çš„putObjectVolatile()çš„åŸå› æ˜¯ï¼šJMMä¼šä¿è¯è·å¾—é”åˆ°é‡Šæ”¾é”ä¹‹é—´æ‰€æœ‰å¯¹è±¡çš„çŠ¶æ€æ›´æ–°éƒ½ä¼šåœ¨é”è¢«é‡Šæ”¾ä¹‹åæ›´æ–°åˆ°ä¸»å­˜ï¼Œä»è€Œä¿è¯è¿™äº›å˜æ›´å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚</p>
<h2 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h2><p>ç›¸å¯¹äºHashMapçš„resizeï¼ŒConcurrentHashMapçš„rehashåŸç†ç±»ä¼¼ï¼Œä½†æ˜¯Doug Leaä¸ºrehashåšäº†ä¸€å®šçš„ä¼˜åŒ–ï¼Œé¿å…è®©æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½è¿›è¡Œå¤åˆ¶æ“ä½œï¼šç”±äºæ‰©å®¹æ˜¯åŸºäº2çš„å¹‚æŒ‡æ¥æ“ä½œï¼Œå‡è®¾æ‰©å®¹å‰æŸHashEntryå¯¹åº”åˆ°Segmentä¸­æ•°ç»„çš„indexä¸ºiï¼Œæ•°ç»„çš„å®¹é‡ä¸ºcapacityï¼Œé‚£ä¹ˆæ‰©å®¹åè¯¥HashEntryå¯¹åº”åˆ°æ–°æ•°ç»„ä¸­çš„indexåªå¯èƒ½ä¸ºiæˆ–è€…i+capacityï¼Œå› æ­¤å¤§å¤šæ•°HashEntryèŠ‚ç‚¹åœ¨æ‰©å®¹å‰åindexå¯ä»¥ä¿æŒä¸å˜ã€‚åŸºäºæ­¤ï¼Œrehashæ–¹æ³•ä¸­ä¼šå®šä½ç¬¬ä¸€ä¸ªåç»­æ‰€æœ‰èŠ‚ç‚¹åœ¨æ‰©å®¹åindexéƒ½ä¿æŒä¸å˜çš„èŠ‚ç‚¹ï¼Œç„¶åå°†è¿™ä¸ªèŠ‚ç‚¹ä¹‹å‰çš„æ‰€æœ‰èŠ‚ç‚¹é‡æ’å³å¯ã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rehash</span><span class="params">(HashEntry&lt;K,V&gt; node)</span> </span>&#123;</span><br><span class="line">           HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">           <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">           <span class="keyword">int</span> newCapacity = oldCapacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">           threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor);</span><br><span class="line">           HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">               (HashEntry&lt;K,V&gt;[]) <span class="keyword">new</span> HashEntry[newCapacity];</span><br><span class="line">           <span class="keyword">int</span> sizeMask = newCapacity - <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">               HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">               <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">                   <span class="keyword">int</span> idx = e.hash &amp; sizeMask;</span><br><span class="line">                   <span class="keyword">if</span> (next == <span class="keyword">null</span>)   <span class="comment">//  Single node on list</span></span><br><span class="line">                       newTable[idx] = e;</span><br><span class="line">                   <span class="keyword">else</span> &#123; <span class="comment">// Reuse consecutive sequence at same slot</span></span><br><span class="line">                       HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                       <span class="keyword">int</span> lastIdx = idx;</span><br><span class="line">                       <span class="keyword">for</span> (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                            last != <span class="keyword">null</span>;</span><br><span class="line">                            last = last.next) &#123;</span><br><span class="line">                           <span class="keyword">int</span> k = last.hash &amp; sizeMask;</span><br><span class="line">                           <span class="keyword">if</span> (k != lastIdx) &#123;</span><br><span class="line">                               lastIdx = k;</span><br><span class="line">                               lastRun = last;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       newTable[lastIdx] = lastRun;</span><br><span class="line">                       <span class="comment">// Clone remaining nodes</span></span><br><span class="line">                       <span class="keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                           V v = p.value;</span><br><span class="line">                           <span class="keyword">int</span> h = p.hash;</span><br><span class="line">                           <span class="keyword">int</span> k = h &amp; sizeMask;</span><br><span class="line">                           HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                           newTable[k] = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">int</span> nodeIndex = node.hash &amp; sizeMask; <span class="comment">// add the new node</span></span><br><span class="line">           node.setNext(newTable[nodeIndex]);</span><br><span class="line">           newTable[nodeIndex] = node;</span><br><span class="line">           table = newTable;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><p>å’Œputç±»ä¼¼ï¼Œremoveåœ¨çœŸæ­£è·å¾—é”ä¹‹å‰ï¼Œä¹Ÿä¼šå¯¹é“¾è¡¨è¿›è¡Œéå†ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚</p>
<h2 id="getä¸containsKey"><a href="#getä¸containsKey" class="headerlink" title="getä¸containsKey"></a>getä¸containsKey</h2><p><code>get</code>ä¸<code>containsKey</code>ä¸¤ä¸ªæ–¹æ³•å‡ ä¹å®Œå…¨ä¸€è‡´ï¼šä»–ä»¬éƒ½æ²¡æœ‰ä½¿ç”¨é”ï¼Œè€Œæ˜¯é€šè¿‡Unsafeå¯¹è±¡çš„<code>getObjectVolatile()</code>æ–¹æ³•æä¾›çš„åŸå­è¯»è¯­ä¹‰ï¼Œæ¥è·å¾—Segmentä»¥åŠå¯¹åº”çš„é“¾è¡¨ï¼Œç„¶åå¯¹é“¾è¡¨éå†åˆ¤æ–­æ˜¯å¦å­˜åœ¨keyç›¸åŒçš„èŠ‚ç‚¹ä»¥åŠè·å¾—è¯¥èŠ‚ç‚¹çš„valueã€‚ä½†ç”±äºéå†è¿‡ç¨‹ä¸­å…¶ä»–çº¿ç¨‹å¯èƒ½å¯¹é“¾è¡¨ç»“æ„åšäº†è°ƒæ•´ï¼Œå› æ­¤<code>get</code>å’Œ<code>containsKey</code>è¿”å›çš„å¯èƒ½æ˜¯è¿‡æ—¶çš„æ•°æ®ï¼Œè¿™ä¸€ç‚¹æ˜¯ConcurrentHashMapåœ¨å¼±ä¸€è‡´æ€§ä¸Šçš„ä½“ç°ã€‚å¦‚æœè¦æ±‚å¼ºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆå¿…é¡»ä½¿ç”¨<code>Collections.synchronizedMap()</code>æ–¹æ³•ã€‚</p>
<h2 id="sizeã€containsValue"><a href="#sizeã€containsValue" class="headerlink" title="sizeã€containsValue"></a>sizeã€containsValue</h2><p>è¿™äº›æ–¹æ³•éƒ½æ˜¯åŸºäºæ•´ä¸ªConcurrentHashMapæ¥è¿›è¡Œæ“ä½œçš„ï¼Œä»–ä»¬çš„åŸç†ä¹ŸåŸºæœ¬ç±»ä¼¼ï¼šé¦–å…ˆä¸åŠ é”å¾ªç¯æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šå¾ªç¯æ‰€æœ‰çš„Segmentï¼ˆé€šè¿‡Unsafeçš„getObjectVolatile()ä»¥ä¿è¯åŸå­è¯»è¯­ä¹‰ï¼‰ï¼Œè·å¾—å¯¹åº”çš„å€¼ä»¥åŠæ‰€æœ‰Segmentçš„modcountä¹‹å’Œã€‚å¦‚æœè¿ç»­ä¸¤æ¬¡æ‰€æœ‰Segmentçš„modcountå’Œç›¸ç­‰ï¼Œåˆ™è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç”Ÿå…¶ä»–çº¿ç¨‹ä¿®æ”¹ConcurrentHashMapçš„æƒ…å†µï¼Œè¿”å›è·å¾—çš„å€¼ã€‚</p>
<p>å½“å¾ªç¯æ¬¡æ•°è¶…è¿‡é¢„å®šä¹‰çš„å€¼æ—¶ï¼Œè¿™æ—¶éœ€è¦å¯¹æ‰€æœ‰çš„Segmentä¾æ¬¡è¿›è¡ŒåŠ é”ï¼Œè·å–è¿”å›å€¼åå†ä¾æ¬¡è§£é”ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒåŠ é”è¿‡ç¨‹ä¸­è¦å¼ºåˆ¶åˆ›å»ºæ‰€æœ‰çš„Segmentï¼Œå¦åˆ™å®¹æ˜“å‡ºç°å…¶ä»–çº¿ç¨‹åˆ›å»ºSegmentå¹¶è¿›è¡Œputï¼Œremoveç­‰æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j =<span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line"></span><br><span class="line">ensureSegment(j).lock();<span class="comment">// force creation</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥é¿å…åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨sizeå’ŒcontainsValueæ–¹æ³•ã€‚</p>
<p>æ³¨1ï¼šmodcountåœ¨put, replace, removeä»¥åŠclearç­‰æ–¹æ³•ä¸­éƒ½ä¼šè¢«ä¿®æ”¹ã€‚</p>
<p>æ³¨2ï¼šå¯¹äºcontainsValueæ–¹æ³•æ¥è¯´ï¼Œå¦‚æœåœ¨å¾ªç¯è¿‡ç¨‹ä¸­å‘ç°åŒ¹é…valueçš„HashEntryï¼Œåˆ™ç›´æ¥è¿”å›trueã€‚</p>
<p>æœ€åï¼Œä¸HashMapä¸åŒçš„æ˜¯ï¼ŒConcurrentHashMapå¹¶ä¸å…è®¸keyæˆ–è€…valueä¸ºnullï¼ŒæŒ‰ç…§Doug Leaçš„è¯´æ³•ï¼Œè¿™ä¹ˆè®¾è®¡çš„åŸå› æ˜¯åœ¨ConcurrentHashMapä¸­ï¼Œä¸€æ—¦valueå‡ºç°nullï¼Œåˆ™ä»£è¡¨HashEntryçš„key/valueæ²¡æœ‰æ˜ å°„å®Œæˆå°±è¢«å…¶ä»–çº¿ç¨‹æ‰€è§ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚åœ¨JDK6ä¸­ï¼Œgetæ–¹æ³•çš„å®ç°ä¸­å°±æœ‰ä¸€æ®µå¯¹HashEntry.value == nullçš„é˜²å¾¡æ€§åˆ¤æ–­ã€‚ä½†Doug Leaä¹Ÿæ‰¿è®¤å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿™ç§æƒ…å†µä¼¼ä¹ä¸å¯èƒ½å‘ç”Ÿ</p>
<hr>
<h1 id="JDK8ä¸­çš„å®ç°"><a href="#JDK8ä¸­çš„å®ç°" class="headerlink" title="JDK8ä¸­çš„å®ç°"></a>JDK8ä¸­çš„å®ç°</h1><p>ConcurrentHashMapåœ¨JDK8ä¸­è¿›è¡Œäº†å·¨å¤§æ”¹åŠ¨ï¼Œå¾ˆéœ€è¦é€šè¿‡æºç æ¥å†æ¬¡å­¦ä¹ ä¸‹Doug Leaçš„å®ç°æ–¹æ³•ã€‚</p>
<p>å®ƒæ‘’å¼ƒäº†Segmentï¼ˆé”æ®µï¼‰çš„æ¦‚å¿µï¼Œè€Œæ˜¯å¯ç”¨äº†ä¸€ç§å…¨æ–°çš„æ–¹å¼å®ç°,åˆ©ç”¨CASç®—æ³•ã€‚å®ƒæ²¿ç”¨äº†ä¸å®ƒåŒæ—¶æœŸçš„HashMapç‰ˆæœ¬çš„æ€æƒ³ï¼Œåº•å±‚ä¾ç„¶ç”±â€œæ•°ç»„â€+é“¾è¡¨+çº¢é»‘æ ‘çš„æ–¹å¼æ€æƒ³ï¼Œä½†æ˜¯ä¸ºäº†åšåˆ°å¹¶å‘ï¼Œåˆå¢åŠ äº†å¾ˆå¤šè¾…åŠ©çš„ç±»ï¼Œä¾‹å¦‚TreeBinï¼ŒTraverserç­‰å¯¹è±¡å†…éƒ¨ç±»ã€‚</p>
<h2 id="é‡è¦çš„å±æ€§"><a href="#é‡è¦çš„å±æ€§" class="headerlink" title="é‡è¦çš„å±æ€§"></a>é‡è¦çš„å±æ€§</h2><p>é¦–å…ˆæ¥çœ‹å‡ ä¸ªé‡è¦çš„å±æ€§ï¼Œä¸HashMapç›¸åŒçš„å°±ä¸å†ä»‹ç»äº†ï¼Œè¿™é‡Œé‡ç‚¹è§£é‡Šä¸€ä¸‹sizeCtlè¿™ä¸ªå±æ€§ã€‚å¯ä»¥è¯´å®ƒæ˜¯ConcurrentHashMapä¸­å‡ºé•œç‡å¾ˆé«˜çš„ä¸€ä¸ªå±æ€§ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ§åˆ¶æ ‡è¯†ç¬¦ï¼Œåœ¨ä¸åŒçš„åœ°æ–¹æœ‰ä¸åŒç”¨é€”ï¼Œè€Œä¸”å®ƒçš„å–å€¼ä¸åŒï¼Œä¹Ÿä»£è¡¨ä¸åŒçš„å«ä¹‰ã€‚</p>
<ul>
<li>è´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹æ“ä½œ</li>
<li>-1ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–</li>
<li>-N è¡¨ç¤ºæœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</li>
<li>æ­£æ•°æˆ–0ä»£è¡¨hashè¡¨è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºåˆå§‹åŒ–æˆ–ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å°ï¼Œè¿™ä¸€ç‚¹ç±»ä¼¼äºæ‰©å®¹é˜ˆå€¼çš„æ¦‚å¿µã€‚è¿˜åé¢å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å€¼å§‹ç»ˆæ˜¯å½“å‰ConcurrentHashMapå®¹é‡çš„0.75å€ï¼Œè¿™ä¸loadfactoræ˜¯å¯¹åº”çš„ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç››è£…Nodeå…ƒç´ çš„æ•°ç»„ å®ƒçš„å¤§å°æ˜¯2çš„æ•´æ•°æ¬¡å¹‚</span></span><br><span class="line"><span class="comment">     * Size is always a power of two. Accessed directly by iterators.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table initialization and resizing control.  When negative, the</span></span><br><span class="line"><span class="comment">     * table is being initialized or resized: -1 for initialization,</span></span><br><span class="line"><span class="comment">     * else -(1 + the number of active resizing threads).  Otherwise,</span></span><br><span class="line"><span class="comment">     * when table is null, holds the initial table size to use upon</span></span><br><span class="line"><span class="comment">     * creation, or 0 for default. After initialization, holds the</span></span><br><span class="line"><span class="comment">     * next element count value upon which to resize the table.</span></span><br><span class="line"><span class="comment">     hashè¡¨åˆå§‹åŒ–æˆ–æ‰©å®¹æ—¶çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†é‡ã€‚</span></span><br><span class="line"><span class="comment">     è´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment">     -1ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     -N è¡¨ç¤ºæœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment">     æ­£æ•°æˆ–0ä»£è¡¨hashè¡¨è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºåˆå§‹åŒ–æˆ–ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å°</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl; </span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä¸¤ä¸ªæ˜¯ç”¨æ¥æ§åˆ¶æ‰©å®¹çš„æ—¶å€™ å•çº¿ç¨‹è¿›å…¥çš„å˜é‡</span></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of bits used for generation stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     * Must be at least 6 for 32bit arrays.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> RESIZE_STAMP_BITS = <span class="number">16</span>;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The bit shift for recording size stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESIZE_STAMP_SHIFT = <span class="number">32</span> - RESIZE_STAMP_BITS;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Encodings for Node hash fields. See above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hashå€¼æ˜¯-1ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªforwardNodeèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hashå€¼æ˜¯-2  è¡¨ç¤ºè¿™æ—¶ä¸€ä¸ªTreeBinèŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>
<h2 id="é‡è¦çš„ç±»"><a href="#é‡è¦çš„ç±»" class="headerlink" title="é‡è¦çš„ç±»"></a>é‡è¦çš„ç±»</h2><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>Nodeæ˜¯æœ€æ ¸å¿ƒçš„å†…éƒ¨ç±»ï¼Œå®ƒåŒ…è£…äº†key-valueé”®å€¼å¯¹ï¼Œæ‰€æœ‰æ’å…¥ConcurrentHashMapçš„æ•°æ®éƒ½åŒ…è£…åœ¨è¿™é‡Œé¢ã€‚å®ƒä¸HashMapä¸­çš„å®šä¹‰å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯ä½†æ˜¯æœ‰ä¸€äº›å·®åˆ«å®ƒå¯¹valueå’Œnextå±æ€§è®¾ç½®äº†volatileåŒæ­¥é”(ä¸JDK7çš„Segmentç›¸åŒ)ï¼Œå®ƒä¸å…è®¸è°ƒç”¨setValueæ–¹æ³•ç›´æ¥æ”¹å˜Nodeçš„valueåŸŸï¼Œå®ƒå¢åŠ äº†findæ–¹æ³•è¾…åŠ©map.get()æ–¹æ³•ã€‚</p>
<h3 id="TreeNode"><a href="#TreeNode" class="headerlink" title="TreeNode"></a>TreeNode</h3><p>æ ‘èŠ‚ç‚¹ç±»ï¼Œå¦å¤–ä¸€ä¸ªæ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚å½“é“¾è¡¨é•¿åº¦è¿‡é•¿çš„æ—¶å€™ï¼Œä¼šè½¬æ¢ä¸ºTreeNodeã€‚ä½†æ˜¯ä¸HashMapä¸ç›¸åŒçš„æ˜¯ï¼Œå®ƒå¹¶ä¸æ˜¯ç›´æ¥è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œè€Œæ˜¯æŠŠè¿™äº›ç»“ç‚¹åŒ…è£…æˆTreeNodeæ”¾åœ¨TreeBinå¯¹è±¡ä¸­ï¼Œç”±TreeBinå®Œæˆå¯¹çº¢é»‘æ ‘çš„åŒ…è£…ã€‚è€Œä¸”TreeNodeåœ¨ConcurrentHashMapé›†æˆè‡ªNodeç±»ï¼Œè€Œå¹¶éHashMapä¸­çš„é›†æˆè‡ªLinkedHashMap.Entry&lt;K,V&gt;ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´TreeNodeå¸¦æœ‰nextæŒ‡é’ˆï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯æ–¹ä¾¿åŸºäºTreeBinçš„è®¿é—®ã€‚</p>
<h3 id="TreeBin"><a href="#TreeBin" class="headerlink" title="TreeBin"></a>TreeBin</h3><p>è¿™ä¸ªç±»å¹¶ä¸è´Ÿè´£åŒ…è£…ç”¨æˆ·çš„keyã€valueä¿¡æ¯ï¼Œè€Œæ˜¯åŒ…è£…çš„å¾ˆå¤šTreeNodeèŠ‚ç‚¹ã€‚å®ƒä»£æ›¿äº†TreeNodeçš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å®é™…çš„ConcurrentHashMapâ€œæ•°ç»„â€ä¸­ï¼Œå­˜æ”¾çš„æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNodeå¯¹è±¡ï¼Œè¿™æ˜¯ä¸HashMapçš„åŒºåˆ«ã€‚å¦å¤–è¿™ä¸ªç±»è¿˜å¸¦æœ‰äº†è¯»å†™é”ã€‚</p>
<p>è¿™é‡Œä»…è´´å‡ºå®ƒçš„æ„é€ æ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°åœ¨æ„é€ TreeBinèŠ‚ç‚¹æ—¶ï¼Œä»…ä»…æŒ‡å®šäº†å®ƒçš„hashå€¼ä¸ºTREEBINå¸¸é‡ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ªæ ‡è¯†ä¸ºã€‚åŒæ—¶ä¹Ÿçœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„çº¢é»‘æ ‘æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates bin with initial set of nodes headed by b.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TreeBin(TreeNode&lt;K,V&gt; b) &#123;</span><br><span class="line">            <span class="keyword">super</span>(TREEBIN, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.first = b;</span><br><span class="line">            TreeNode&lt;K,V&gt; r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = b, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">                next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">                x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = <span class="keyword">null</span>;</span><br><span class="line">                    x.red = <span class="keyword">false</span>;</span><br><span class="line">                    r = x;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    K k = x.key;</span><br><span class="line">                    <span class="keyword">int</span> h = x.hash;</span><br><span class="line">                    Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = r;;) &#123;</span><br><span class="line">                        <span class="keyword">int</span> dir, ph;</span><br><span class="line">                        K pk = p.key;</span><br><span class="line">                        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                            dir = -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                            dir = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                  (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                                 (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                            dir = tieBreakOrder(k, pk);</span><br><span class="line">                            TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            x.parent = xp;</span><br><span class="line">                            <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                                xp.left = x;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                xp.right = x;</span><br><span class="line">                            r = balanceInsertion(r, x);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.root = r;</span><br><span class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ForwardingNode"><a href="#ForwardingNode" class="headerlink" title="ForwardingNode"></a>ForwardingNode</h3><p>ä¸€ä¸ªç”¨äºè¿æ¥ä¸¤ä¸ªtableçš„èŠ‚ç‚¹ç±»ã€‚å®ƒåŒ…å«ä¸€ä¸ªnextTableæŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘ä¸‹ä¸€å¼ è¡¨ã€‚è€Œä¸”è¿™ä¸ªèŠ‚ç‚¹çš„key value nextæŒ‡é’ˆå…¨éƒ¨ä¸ºnullï¼Œå®ƒçš„hashå€¼ä¸º-1. è¿™é‡Œé¢å®šä¹‰çš„findçš„æ–¹æ³•æ˜¯ä»nextTableé‡Œè¿›è¡ŒæŸ¥è¯¢èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯ä»¥è‡ªèº«ä¸ºå¤´èŠ‚ç‚¹è¿›è¡ŒæŸ¥æ‰¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A node inserted at head of bins during transfer operations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">        ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">            <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// loop to avoid arbitrarily deep recursion on forwarding nodes</span></span><br><span class="line">            outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;) &#123;</span><br><span class="line">                Node&lt;K,V&gt; e; <span class="keyword">int</span> n;</span><br><span class="line">                <span class="keyword">if</span> (k == <span class="keyword">null</span> || tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">                    (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    <span class="keyword">int</span> eh; K ek;</span><br><span class="line">                    <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp;</span><br><span class="line">                        ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                        <span class="keyword">return</span> e;</span><br><span class="line">                    <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                            tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                            <span class="keyword">continue</span> outer;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Unsafeä¸CAS"><a href="#Unsafeä¸CAS" class="headerlink" title="Unsafeä¸CAS"></a>Unsafeä¸CAS</h2><p>åœ¨ConcurrentHashMapä¸­ï¼Œéšå¤„å¯ä»¥çœ‹åˆ°<code>U</code>, å¤§é‡ä½¿ç”¨äº†<code>U.compareAndSwapXXX</code>çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åˆ©ç”¨ä¸€ä¸ªCASç®—æ³•å®ç°æ— é”åŒ–çš„ä¿®æ”¹å€¼çš„æ“ä½œï¼Œä»–å¯ä»¥å¤§å¤§é™ä½é”ä»£ç†çš„æ€§èƒ½æ¶ˆè€—ã€‚è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯ä¸æ–­åœ°å»æ¯”è¾ƒå½“å‰å†…å­˜ä¸­çš„å˜é‡å€¼ä¸ä½ æŒ‡å®šçš„ä¸€ä¸ªå˜é‡å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™æ¥å—ä½ æŒ‡å®šçš„ä¿®æ”¹çš„å€¼ï¼Œå¦åˆ™æ‹’ç»ä½ çš„æ“ä½œã€‚å› ä¸ºå½“å‰çº¿ç¨‹ä¸­çš„å€¼å·²ç»ä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œä½ çš„ä¿®æ”¹å¾ˆå¯èƒ½ä¼šè¦†ç›–æ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹çš„ç»“æœã€‚è¿™ä¸€ç‚¹ä¸ä¹è§‚é”ï¼ŒSVNçš„æ€æƒ³æ˜¯æ¯”è¾ƒç±»ä¼¼çš„ã€‚</p>
<h3 id="unsafeé™æ€å—"><a href="#unsafeé™æ€å—" class="headerlink" title="unsafeé™æ€å—"></a>unsafeé™æ€å—</h3><p>unsafeä»£ç å—æ§åˆ¶äº†ä¸€äº›å±æ€§çš„ä¿®æ”¹å·¥ä½œï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„SIZECTL ã€‚åœ¨è¿™ä¸€ç‰ˆæœ¬çš„concurrentHashMapä¸­ï¼Œå¤§é‡åº”ç”¨æ¥çš„CASæ–¹æ³•è¿›è¡Œå˜é‡ã€å±æ€§çš„ä¿®æ”¹å·¥ä½œã€‚åˆ©ç”¨CASè¿›è¡Œæ— é”æ“ä½œï¼Œå¯ä»¥å¤§å¤§æé«˜æ€§èƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SIZECTL;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TRANSFERINDEX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BASECOUNT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLSBUSY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLVALUE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ABASE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; k = ConcurrentHashMap.class;</span><br><span class="line">            SIZECTL = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"sizeCtl"</span>));</span><br><span class="line">            TRANSFERINDEX = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"transferIndex"</span>));</span><br><span class="line">            BASECOUNT = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"baseCount"</span>));</span><br><span class="line">            CELLSBUSY = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"cellsBusy"</span>));</span><br><span class="line">            Class&lt;?&gt; ck = CounterCell.class;</span><br><span class="line">            CELLVALUE = U.objectFieldOffset</span><br><span class="line">                (ck.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">            Class&lt;?&gt; ak = Node[].class;</span><br><span class="line">            ABASE = U.arrayBaseOffset(ak);</span><br><span class="line">            <span class="keyword">int</span> scale = U.arrayIndexScale(ak);</span><br><span class="line">            <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"data type scale not a power of two"</span>);</span><br><span class="line">            ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•"><a href="#ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•" class="headerlink" title="ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•"></a>ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•</h3><p>ConcurrentHashMapå®šä¹‰äº†ä¸‰ä¸ªåŸå­æ“ä½œï¼Œç”¨äºå¯¹æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚æ­£æ˜¯è¿™äº›åŸå­æ“ä½œä¿è¯äº†ConcurrentHashMapçš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å¾—åœ¨iä½ç½®ä¸Šçš„NodeèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//åˆ©ç”¨CASç®—æ³•è®¾ç½®iä½ç½®ä¸Šçš„NodeèŠ‚ç‚¹ã€‚ä¹‹æ‰€ä»¥èƒ½å®ç°å¹¶å‘æ˜¯å› ä¸ºä»–æŒ‡å®šäº†åŸæ¥è¿™ä¸ªèŠ‚ç‚¹çš„å€¼æ˜¯å¤šå°‘</span></span><br><span class="line">		<span class="comment">//åœ¨CASç®—æ³•ä¸­ï¼Œä¼šæ¯”è¾ƒå†…å­˜ä¸­çš„å€¼ä¸ä½ æŒ‡å®šçš„è¿™ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰æ‰æ¥å—ä½ çš„ä¿®æ”¹ï¼Œå¦åˆ™æ‹’ç»ä½ çš„ä¿®æ”¹</span></span><br><span class="line">		<span class="comment">//å› æ­¤å½“å‰çº¿ç¨‹ä¸­çš„å€¼å¹¶ä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œè¿™ç§ä¿®æ”¹å¯èƒ½ä¼šè¦†ç›–æ‰å…¶ä»–çº¿ç¨‹çš„ä¿®æ”¹ç»“æœ  æœ‰ç‚¹ç±»ä¼¼äºSVN</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//åˆ©ç”¨volatileæ–¹æ³•è®¾ç½®èŠ‚ç‚¹ä½ç½®çš„å€¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–æ–¹æ³•initTable"><a href="#åˆå§‹åŒ–æ–¹æ³•initTable" class="headerlink" title="åˆå§‹åŒ–æ–¹æ³•initTable"></a>åˆå§‹åŒ–æ–¹æ³•initTable</h3><p>å¯¹äºConcurrentHashMapæ¥è¯´ï¼Œè°ƒç”¨å®ƒçš„æ„é€ æ–¹æ³•ä»…ä»…æ˜¯è®¾ç½®äº†ä¸€äº›å‚æ•°è€Œå·²ã€‚è€Œæ•´ä¸ªtableçš„åˆå§‹åŒ–æ˜¯åœ¨å‘ConcurrentHashMapä¸­æ’å…¥å…ƒç´ çš„æ—¶å€™å‘ç”Ÿçš„ã€‚å¦‚è°ƒç”¨putã€computeIfAbsentã€computeã€mergeç­‰æ–¹æ³•çš„æ—¶å€™ï¼Œè°ƒç”¨æ—¶æœºæ˜¯æ£€æŸ¥table==nullã€‚</p>
<p>åˆå§‹åŒ–æ–¹æ³•ä¸»è¦åº”ç”¨äº†å…³é”®å±æ€§sizeCtl å¦‚æœè¿™ä¸ªå€¼ã€ˆ0ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–ï¼Œå°±æ”¾å¼ƒè¿™ä¸ªæ“ä½œã€‚åœ¨è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºConcurrentHashMapçš„åˆå§‹åŒ–åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆã€‚å¦‚æœè·å¾—äº†åˆå§‹åŒ–æƒé™ï¼Œå°±ç”¨CASæ–¹æ³•å°†sizeCtlç½®ä¸º-1ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹è¿›å…¥ã€‚åˆå§‹åŒ–æ•°ç»„åï¼Œå°†sizeCtlçš„å€¼æ”¹ä¸º0.75*nã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes table, using the size recorded in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        		<span class="comment">//sizeCtlè¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼ŒæŠŠçº¿ç¨‹æŒ‚èµ·ã€‚å¯¹äºtableçš„åˆå§‹åŒ–å·¥ä½œï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿›è¡Œã€‚</span></span><br><span class="line">            <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">                Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;<span class="comment">//åˆ©ç”¨CASæ–¹æ³•æŠŠsizectlçš„å€¼ç½®ä¸º-1 è¡¨ç¤ºæœ¬çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = tab = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);<span class="comment">//ç›¸å½“äº0.75*n è®¾ç½®ä¸€ä¸ªæ‰©å®¹çš„é˜ˆå€¼</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tab;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‰©å®¹æ–¹æ³•-transfer"><a href="#æ‰©å®¹æ–¹æ³•-transfer" class="headerlink" title="æ‰©å®¹æ–¹æ³• transfer"></a>æ‰©å®¹æ–¹æ³• transfer</h3><p>å½“ConcurrentHashMapå®¹é‡ä¸è¶³çš„æ—¶å€™ï¼Œéœ€è¦å¯¹tableè¿›è¡Œæ‰©å®¹ã€‚è¿™ä¸ªæ–¹æ³•çš„åŸºæœ¬æ€æƒ³è·ŸHashMapæ˜¯å¾ˆåƒçš„ï¼Œä½†æ˜¯ç”±äºå®ƒæ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œæ‰€ä»¥è¦å¤æ‚çš„å¤šã€‚åŸå› æ˜¯å®ƒæ”¯æŒå¤šçº¿ç¨‹è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè€Œå¹¶æ²¡æœ‰åŠ é”ã€‚æˆ‘æƒ³è¿™æ ·åšçš„ç›®çš„ä¸ä»…ä»…æ˜¯ä¸ºäº†æ»¡è¶³concurrentçš„è¦æ±‚ï¼Œè€Œæ˜¯å¸Œæœ›åˆ©ç”¨å¹¶å‘å¤„ç†å»å‡å°‘æ‰©å®¹å¸¦æ¥çš„æ—¶é—´å½±å“ã€‚å› ä¸ºåœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œæ€»æ˜¯ä¼šæ¶‰åŠåˆ°ä»ä¸€ä¸ªâ€œæ•°ç»„â€åˆ°å¦ä¸€ä¸ªâ€œæ•°ç»„â€æ‹·è´çš„æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ“ä½œèƒ½å¤Ÿå¹¶å‘è¿›è¡Œï¼Œé‚£çœŸçœŸæ˜¯æå¥½çš„äº†ã€‚</p>
<p>æ•´ä¸ªæ‰©å®¹æ“ä½œåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<ul>
<li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ„å»ºä¸€ä¸ªnextTable,å®ƒçš„å®¹é‡æ˜¯åŸæ¥çš„ä¸¤å€ï¼Œè¿™ä¸ªæ“ä½œæ˜¯å•çº¿ç¨‹å®Œæˆçš„ã€‚è¿™ä¸ªå•çº¿ç¨‹çš„ä¿è¯æ˜¯é€šè¿‡RESIZE_STAMP_SHIFTè¿™ä¸ªå¸¸é‡ç»è¿‡ä¸€æ¬¡è¿ç®—æ¥ä¿è¯çš„ï¼Œè¿™ä¸ªåœ°æ–¹åœ¨åé¢ä¼šæœ‰æåˆ°ï¼›</li>
<li>ç¬¬äºŒä¸ªéƒ¨åˆ†å°±æ˜¯å°†åŸæ¥tableä¸­çš„å…ƒç´ å¤åˆ¶åˆ°nextTableä¸­ï¼Œè¿™é‡Œå…è®¸å¤šçº¿ç¨‹è¿›è¡Œæ“ä½œã€‚</li>
</ul>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹å•çº¿ç¨‹æ˜¯å¦‚ä½•å®Œæˆçš„ï¼š</p>
<p>å®ƒçš„å¤§ä½“æ€æƒ³å°±æ˜¯éå†ã€å¤åˆ¶çš„è¿‡ç¨‹ã€‚é¦–å…ˆæ ¹æ®è¿ç®—å¾—åˆ°éœ€è¦éå†çš„æ¬¡æ•°iï¼Œç„¶ååˆ©ç”¨tabAtæ–¹æ³•è·å¾—iä½ç½®çš„å…ƒç´ ï¼š</p>
<ul>
<li>å¦‚æœè¿™ä¸ªä½ç½®ä¸ºç©ºï¼Œå°±åœ¨åŸtableä¸­çš„iä½ç½®æ”¾å…¥forwardNodeèŠ‚ç‚¹ï¼Œè¿™ä¸ªä¹Ÿæ˜¯è§¦å‘å¹¶å‘æ‰©å®¹çš„å…³é”®ç‚¹ï¼›</li>
<li>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯NodeèŠ‚ç‚¹ï¼ˆfh&gt;=0ï¼‰ï¼Œå¦‚æœå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œå°±æ„é€ ä¸€ä¸ªååºé“¾è¡¨ï¼ŒæŠŠä»–ä»¬åˆ†åˆ«æ”¾åœ¨nextTableçš„iå’Œi+nçš„ä½ç½®ä¸Š</li>
<li>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯TreeBinèŠ‚ç‚¹ï¼ˆfh&lt;0ï¼‰ï¼Œä¹Ÿåšä¸€ä¸ªååºå¤„ç†ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦untreefiï¼ŒæŠŠå¤„ç†çš„ç»“æœåˆ†åˆ«æ”¾åœ¨nextTableçš„iå’Œi+nçš„ä½ç½®ä¸Š</li>
<li>éå†è¿‡æ‰€æœ‰çš„èŠ‚ç‚¹ä»¥åå°±å®Œæˆäº†å¤åˆ¶å·¥ä½œï¼Œè¿™æ—¶è®©nextTableä½œä¸ºæ–°çš„tableï¼Œå¹¶ä¸”æ›´æ–°sizeCtlä¸ºæ–°å®¹é‡çš„0.75å€ ï¼Œå®Œæˆæ‰©å®¹ã€‚</li>
</ul>
<p>å†çœ‹ä¸€ä¸‹å¤šçº¿ç¨‹æ˜¯å¦‚ä½•å®Œæˆçš„ï¼š</p>
<p>åœ¨ä»£ç çš„69è¡Œæœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœéå†åˆ°çš„èŠ‚ç‚¹æ˜¯forwardèŠ‚ç‚¹ï¼Œå°±å‘åç»§ç»­éå†ï¼Œå†åŠ ä¸Šç»™èŠ‚ç‚¹ä¸Šé”çš„æœºåˆ¶ï¼Œå°±å®Œæˆäº†å¤šçº¿ç¨‹çš„æ§åˆ¶ã€‚å¤šçº¿ç¨‹éå†èŠ‚ç‚¹ï¼Œå¤„ç†äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æŠŠå¯¹åº”ç‚¹çš„å€¼setä¸ºforwardï¼Œå¦ä¸€ä¸ªçº¿ç¨‹çœ‹åˆ°forwardï¼Œå°±å‘åéå†ã€‚è¿™æ ·äº¤å‰å°±å®Œæˆäº†å¤åˆ¶å·¥ä½œã€‚è€Œä¸”è¿˜å¾ˆå¥½çš„è§£å†³äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚ è¿™ä¸ªæ–¹æ³•çš„è®¾è®¡å®åœ¨æ˜¯è®©æˆ‘è†œæ‹œã€‚</p>
<p><a href="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg" target="_blank" rel="noopener"><img src="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg" alt=""></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸€ä¸ªè¿‡æ¸¡çš„tableè¡¨  åªæœ‰åœ¨æ‰©å®¹çš„æ—¶å€™æ‰ä¼šä½¿ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Moves and/or copies the nodes in each bin to new table. See</span></span><br><span class="line"><span class="comment">     * above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">        <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">            stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">        <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];<span class="comment">//æ„é€ ä¸€ä¸ªnextTableå¯¹è±¡ å®ƒçš„å®¹é‡æ˜¯åŸæ¥çš„ä¸¤å€</span></span><br><span class="line">                nextTab = nt;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">                sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nextTable = nextTab;</span><br><span class="line">            transferIndex = n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">        ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);<span class="comment">//æ„é€ ä¸€ä¸ªè¿èŠ‚ç‚¹æŒ‡é’ˆ ç”¨äºæ ‡å¿—ä½</span></span><br><span class="line">        <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;<span class="comment">//å¹¶å‘æ‰©å®¹çš„å…³é”®å±æ€§ å¦‚æœç­‰äºtrue è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹å·²ç»å¤„ç†è¿‡</span></span><br><span class="line">        <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">            <span class="comment">//è¿™ä¸ªwhileå¾ªç¯ä½“çš„ä½œç”¨å°±æ˜¯åœ¨æ§åˆ¶i--  é€šè¿‡i--å¯ä»¥ä¾æ¬¡éå†åŸhashè¡¨ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">                <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    i = -<span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                         (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                          nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                       nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                    bound = nextBound;</span><br><span class="line">                    i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">                <span class="keyword">int</span> sc;</span><br><span class="line">                <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                	<span class="comment">//å¦‚æœæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å·²ç»å®Œæˆå¤åˆ¶å·¥ä½œ  å°±æŠŠnextTableèµ‹å€¼ç»™table æ¸…ç©ºä¸´æ—¶å¯¹è±¡nextTable</span></span><br><span class="line">                    nextTable = <span class="keyword">null</span>;</span><br><span class="line">                    table = nextTab;</span><br><span class="line">                    sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);<span class="comment">//æ‰©å®¹é˜ˆå€¼è®¾ç½®ä¸ºåŸæ¥å®¹é‡çš„1.5å€  ä¾ç„¶ç›¸å½“äºç°åœ¨å®¹é‡çš„0.75å€</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//åˆ©ç”¨CASæ–¹æ³•æ›´æ–°è¿™ä¸ªæ‰©å®¹é˜ˆå€¼ï¼Œåœ¨è¿™é‡Œé¢sizectlå€¼å‡ä¸€ï¼Œè¯´æ˜æ–°åŠ å…¥ä¸€ä¸ªçº¿ç¨‹å‚ä¸åˆ°æ‰©å®¹æ“ä½œ</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                    i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœéå†åˆ°çš„èŠ‚ç‚¹ä¸ºç©º åˆ™æ”¾å…¥ForwardingNodeæŒ‡é’ˆ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">                advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">            <span class="comment">//å¦‚æœéå†åˆ°ForwardingNodeèŠ‚ç‚¹  è¯´æ˜è¿™ä¸ªç‚¹å·²ç»è¢«å¤„ç†è¿‡äº† ç›´æ¥è·³è¿‡  è¿™é‡Œæ˜¯æ§åˆ¶å¹¶å‘æ‰©å®¹çš„æ ¸å¿ƒ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">            		<span class="comment">//èŠ‚ç‚¹ä¸Šé”</span></span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                        <span class="comment">//å¦‚æœfh&gt;=0 è¯æ˜è¿™æ˜¯ä¸€ä¸ªNodeèŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                            <span class="comment">//ä»¥ä¸‹çš„éƒ¨åˆ†åœ¨å®Œæˆçš„å·¥ä½œæ˜¯æ„é€ ä¸¤ä¸ªé“¾è¡¨  ä¸€ä¸ªæ˜¯åŸé“¾è¡¨  å¦ä¸€ä¸ªæ˜¯åŸé“¾è¡¨çš„ååºæ’åˆ—</span></span><br><span class="line">                            Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                                <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                    runBit = b;</span><br><span class="line">                                    lastRun = p;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                                ln = lastRun;</span><br><span class="line">                                hn = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                hn = lastRun;</span><br><span class="line">                                ln = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                                <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                    ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„iä½ç½®ä¸Šæ’å…¥ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„i+nçš„ä½ç½®ä¸Šæ’å…¥å¦ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                            <span class="comment">//åœ¨tableçš„iä½ç½®ä¸Šæ’å…¥forwardNodeèŠ‚ç‚¹  è¡¨ç¤ºå·²ç»å¤„ç†è¿‡è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            <span class="comment">//è®¾ç½®advanceä¸ºtrue è¿”å›åˆ°ä¸Šé¢çš„whileå¾ªç¯ä¸­ å°±å¯ä»¥æ‰§è¡Œi--æ“ä½œ</span></span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//å¯¹TreeBinå¯¹è±¡è¿›è¡Œå¤„ç†  ä¸ä¸Šé¢çš„è¿‡ç¨‹ç±»ä¼¼</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                            TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                            <span class="comment">//æ„é€ æ­£åºå’Œååºä¸¤ä¸ªé“¾è¡¨</span></span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                                TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                    (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        lo = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        loTail.next = p;</span><br><span class="line">                                    loTail = p;</span><br><span class="line">                                    ++lc;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        hi = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        hiTail.next = p;</span><br><span class="line">                                    hiTail = p;</span><br><span class="line">                                    ++hc;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//å¦‚æœæ‰©å®¹åå·²ç»ä¸å†éœ€è¦treeçš„ç»“æ„ åå‘è½¬æ¢ä¸ºé“¾è¡¨ç»“æ„</span></span><br><span class="line">                            ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                                (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                            hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                                (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                             <span class="comment">//åœ¨nextTableçš„iä½ç½®ä¸Šæ’å…¥ä¸€ä¸ªé“¾è¡¨    </span></span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„i+nçš„ä½ç½®ä¸Šæ’å…¥å¦ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                             <span class="comment">//åœ¨tableçš„iä½ç½®ä¸Šæ’å…¥forwardNodeèŠ‚ç‚¹  è¡¨ç¤ºå·²ç»å¤„ç†è¿‡è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            <span class="comment">//è®¾ç½®advanceä¸ºtrue è¿”å›åˆ°ä¸Šé¢çš„whileå¾ªç¯ä¸­ å°±å¯ä»¥æ‰§è¡Œi--æ“ä½œ</span></span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Putæ–¹æ³•"><a href="#Putæ–¹æ³•" class="headerlink" title="Putæ–¹æ³•"></a>Putæ–¹æ³•</h2><p>å‰é¢çš„æ‰€æœ‰çš„ä»‹ç»å…¶å®éƒ½ä¸ºè¿™ä¸ªæ–¹æ³•åšé“ºå«ã€‚ConcurrentHashMapæœ€å¸¸ç”¨çš„å°±æ˜¯putå’Œgetä¸¤ä¸ªæ–¹æ³•ã€‚ç°åœ¨æ¥ä»‹ç»putæ–¹æ³•ï¼Œè¿™ä¸ªputæ–¹æ³•ä¾ç„¶æ²¿ç”¨HashMapçš„putæ–¹æ³•çš„æ€æƒ³ï¼Œæ ¹æ®hashå€¼è®¡ç®—è¿™ä¸ªæ–°æ’å…¥çš„ç‚¹åœ¨tableä¸­çš„ä½ç½®iï¼Œå¦‚æœiä½ç½®æ˜¯ç©ºçš„ï¼Œç›´æ¥æ”¾è¿›å»ï¼Œå¦åˆ™è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœiä½ç½®æ˜¯æ ‘èŠ‚ç‚¹ï¼ŒæŒ‰ç…§æ ‘çš„æ–¹å¼æ’å…¥æ–°çš„èŠ‚ç‚¹ï¼Œå¦åˆ™æŠŠiæ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚ConcurrentHashMapä¸­ä¾ç„¶æ²¿ç”¨è¿™ä¸ªæ€æƒ³ï¼Œæœ‰ä¸€ä¸ªæœ€é‡è¦çš„ä¸åŒç‚¹å°±æ˜¯ConcurrentHashMapä¸å…è®¸keyæˆ–valueä¸ºnullå€¼ã€‚å¦å¤–ç”±äºæ¶‰åŠåˆ°å¤šçº¿ç¨‹ï¼Œputæ–¹æ³•å°±è¦å¤æ‚ä¸€ç‚¹ã€‚åœ¨å¤šçº¿ç¨‹ä¸­å¯èƒ½æœ‰ä»¥ä¸‹ä¸¤ä¸ªæƒ…å†µ</p>
<ol>
<li><p>å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ­£åœ¨å¯¹ConcurrentHashMapè¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå½“å‰çº¿ç¨‹ä¹Ÿè¦è¿›å…¥æ‰©å®¹çš„æ“ä½œä¸­ã€‚è¿™ä¸ªæ‰©å®¹çš„æ“ä½œä¹‹æ‰€ä»¥èƒ½è¢«æ£€æµ‹åˆ°ï¼Œæ˜¯å› ä¸ºtransferæ–¹æ³•ä¸­åœ¨ç©ºç»“ç‚¹ä¸Šæ’å…¥forwardèŠ‚ç‚¹ï¼Œå¦‚æœæ£€æµ‹åˆ°éœ€è¦æ’å…¥çš„ä½ç½®è¢«forwardèŠ‚ç‚¹å æœ‰ï¼Œå°±å¸®åŠ©è¿›è¡Œæ‰©å®¹ï¼›</p>
</li>
<li><p>å¦‚æœæ£€æµ‹åˆ°è¦æ’å…¥çš„èŠ‚ç‚¹æ˜¯éç©ºä¸”ä¸æ˜¯forwardèŠ‚ç‚¹ï¼Œå°±å¯¹è¿™ä¸ªèŠ‚ç‚¹åŠ é”ï¼Œè¿™æ ·å°±ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡è¿™ä¸ªæœ‰ä¸€äº›å½±å“æ•ˆç‡ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæ¯”hashTableçš„synchronizedè¦å¥½å¾—å¤šã€‚</p>
</li>
</ol>
<p>æ•´ä½“æµç¨‹å°±æ˜¯é¦–å…ˆå®šä¹‰ä¸å…è®¸keyæˆ–valueä¸ºnullçš„æƒ…å†µæ”¾å…¥  å¯¹äºæ¯ä¸€ä¸ªæ”¾å…¥çš„å€¼ï¼Œé¦–å…ˆåˆ©ç”¨spreadæ–¹æ³•å¯¹keyçš„hashcodeè¿›è¡Œä¸€æ¬¡hashè®¡ç®—ï¼Œç”±æ­¤æ¥ç¡®å®šè¿™ä¸ªå€¼åœ¨tableä¸­çš„ä½ç½®ã€‚</p>
<p>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç›´æ¥æ”¾å…¥ï¼Œè€Œä¸”ä¸éœ€è¦åŠ é”æ“ä½œã€‚</p>
<p> å¦‚æœè¿™ä¸ªä½ç½®å­˜åœ¨ç»“ç‚¹ï¼Œè¯´æ˜å‘ç”Ÿäº†hashç¢°æ’ï¼Œé¦–å…ˆåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ç±»å‹ã€‚å¦‚æœæ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼ˆfh&gt;0ï¼‰,åˆ™å¾—åˆ°çš„ç»“ç‚¹å°±æ˜¯hashå€¼ç›¸åŒçš„èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚éœ€è¦ä¾æ¬¡å‘åéå†ç¡®å®šè¿™ä¸ªæ–°åŠ å…¥çš„å€¼æ‰€åœ¨ä½ç½®ã€‚å¦‚æœé‡åˆ°hashå€¼ä¸keyå€¼éƒ½ä¸æ–°åŠ å…¥èŠ‚ç‚¹æ˜¯ä¸€è‡´çš„æƒ…å†µï¼Œåˆ™åªéœ€è¦æ›´æ–°valueå€¼å³å¯ã€‚å¦åˆ™ä¾æ¬¡å‘åéå†ï¼Œç›´åˆ°é“¾è¡¨å°¾æ’å…¥è¿™ä¸ªç»“ç‚¹ã€‚å¦‚æœåŠ å…¥è¿™ä¸ªèŠ‚ç‚¹ä»¥åé“¾è¡¨é•¿åº¦å¤§äº8ï¼Œå°±æŠŠè¿™ä¸ªé“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ã€‚å¦‚æœè¿™ä¸ªèŠ‚ç‚¹çš„ç±»å‹å·²ç»æ˜¯æ ‘èŠ‚ç‚¹çš„è¯ï¼Œç›´æ¥è°ƒç”¨æ ‘èŠ‚ç‚¹çš„æ’å…¥æ–¹æ³•è¿›è¡Œæ’å…¥æ–°çš„å€¼ã€‚</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** Implementation for put and putIfAbsent */</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">   		<span class="comment">//ä¸å…è®¸ keyæˆ–valueä¸ºnull</span></span><br><span class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">       <span class="comment">//è®¡ç®—hashå€¼</span></span><br><span class="line">       <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">       <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">//æ­»å¾ªç¯ ä½•æ—¶æ’å…¥æˆåŠŸ ä½•æ—¶è·³å‡º</span></span><br><span class="line">       <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">           Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">           <span class="comment">//å¦‚æœtableä¸ºç©ºçš„è¯ï¼Œåˆå§‹åŒ–table</span></span><br><span class="line">           <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">               tab = initTable();</span><br><span class="line">           <span class="comment">//æ ¹æ®hashå€¼è®¡ç®—å‡ºåœ¨tableé‡Œé¢çš„ä½ç½® </span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">           	<span class="comment">//å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰å€¼ ï¼Œç›´æ¥æ”¾è¿›å»ï¼Œä¸éœ€è¦åŠ é”</span></span><br><span class="line">               <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                   <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//å½“é‡åˆ°è¡¨è¿æ¥ç‚¹æ—¶ï¼Œéœ€è¦è¿›è¡Œæ•´åˆè¡¨çš„æ“ä½œ</span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">               tab = helpTransfer(tab, f);</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               V oldVal = <span class="keyword">null</span>;</span><br><span class="line">               <span class="comment">//ç»“ç‚¹ä¸Šé”  è¿™é‡Œçš„ç»“ç‚¹å¯ä»¥ç†è§£ä¸ºhashå€¼ç›¸åŒç»„æˆçš„é“¾è¡¨çš„å¤´ç»“ç‚¹</span></span><br><span class="line">               <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                       <span class="comment">//fhã€‰0 è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé“¾è¡¨çš„èŠ‚ç‚¹ ä¸æ˜¯æ ‘çš„èŠ‚ç‚¹</span></span><br><span class="line">                       <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                           binCount = <span class="number">1</span>;</span><br><span class="line">                           <span class="comment">//åœ¨è¿™é‡Œéå†é“¾è¡¨æ‰€æœ‰çš„ç»“ç‚¹</span></span><br><span class="line">                           <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                               K ek;</span><br><span class="line">                               <span class="comment">//å¦‚æœhashå€¼å’Œkeyå€¼ç›¸åŒ  åˆ™ä¿®æ”¹å¯¹åº”ç»“ç‚¹çš„valueå€¼</span></span><br><span class="line">                               <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                   ((ek = e.key) == key ||</span><br><span class="line">                                    (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                   oldVal = e.val;</span><br><span class="line">                                   <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                       e.val = value;</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                               Node&lt;K,V&gt; pred = e;</span><br><span class="line">                               <span class="comment">//å¦‚æœéå†åˆ°äº†æœ€åä¸€ä¸ªç»“ç‚¹ï¼Œé‚£ä¹ˆå°±è¯æ˜æ–°çš„èŠ‚ç‚¹éœ€è¦æ’å…¥ å°±æŠŠå®ƒæ’å…¥åœ¨é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">                               <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                   pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                             value, <span class="keyword">null</span>);</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">//å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ˜¯æ ‘èŠ‚ç‚¹ï¼Œå°±æŒ‰ç…§æ ‘çš„æ–¹å¼æ’å…¥å€¼</span></span><br><span class="line">                       <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                           Node&lt;K,V&gt; p;</span><br><span class="line">                           binCount = <span class="number">2</span>;</span><br><span class="line">                           <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                          value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               oldVal = p.val;</span><br><span class="line">                               <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                   p.val = value;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">               	<span class="comment">//å¦‚æœé“¾è¡¨é•¿åº¦å·²ç»è¾¾åˆ°ä¸´ç•Œå€¼8 å°±éœ€è¦æŠŠé“¾è¡¨è½¬æ¢ä¸ºæ ‘ç»“æ„</span></span><br><span class="line">                   <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                       treeifyBin(tab, i);</span><br><span class="line">                   <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                       <span class="keyword">return</span> oldVal;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//å°†å½“å‰ConcurrentHashMapçš„å…ƒç´ æ•°é‡+1</span></span><br><span class="line">       addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°JDK8ä¸­çš„å®ç°ä¹Ÿæ˜¯é”åˆ†ç¦»çš„æ€æƒ³ï¼Œåªæ˜¯é”ä½çš„æ˜¯ä¸€ä¸ªNodeï¼Œè€Œä¸æ˜¯JDK7ä¸­çš„Segmentï¼Œè€Œé”ä½Nodeä¹‹å‰çš„æ“ä½œæ˜¯æ— é”çš„å¹¶ä¸”ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå»ºç«‹åœ¨ä¹‹å‰æåˆ°çš„3ä¸ªåŸå­æ“ä½œä¸Šã€‚</p>
<h3 id="helpTransferæ–¹æ³•"><a href="#helpTransferæ–¹æ³•" class="headerlink" title="helpTransferæ–¹æ³•"></a>helpTransferæ–¹æ³•</h3><p>è¿™æ˜¯ä¸€ä¸ªååŠ©æ‰©å®¹çš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå½“å‰ConcurrentHashMapä¸€å®šå·²ç»æœ‰äº†nextTableå¯¹è±¡ï¼Œé¦–å…ˆæ‹¿åˆ°è¿™ä¸ªnextTableå¯¹è±¡ï¼Œè°ƒç”¨transferæ–¹æ³•ã€‚å›çœ‹ä¸Šé¢çš„transferæ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå½“æœ¬çº¿ç¨‹è¿›å…¥æ‰©å®¹æ–¹æ³•çš„æ—¶å€™ä¼šç›´æ¥è¿›å…¥å¤åˆ¶é˜¶æ®µã€‚</p>
<h3 id="treeifyBinæ–¹æ³•"><a href="#treeifyBinæ–¹æ³•" class="headerlink" title="treeifyBinæ–¹æ³•"></a>treeifyBinæ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•ç”¨äºå°†è¿‡é•¿çš„é“¾è¡¨è½¬æ¢ä¸ºTreeBinå¯¹è±¡ã€‚ä½†æ˜¯ä»–å¹¶ä¸æ˜¯ç›´æ¥è½¬æ¢ï¼Œè€Œæ˜¯è¿›è¡Œä¸€æ¬¡å®¹é‡åˆ¤æ–­ï¼Œå¦‚æœå®¹é‡æ²¡æœ‰è¾¾åˆ°è½¬æ¢çš„è¦æ±‚ï¼Œç›´æ¥è¿›è¡Œæ‰©å®¹æ“ä½œå¹¶è¿”å›ï¼›å¦‚æœæ»¡è¶³æ¡ä»¶æ‰é“¾è¡¨çš„ç»“æ„æŠ“æ¢ä¸ºTreeBin ï¼Œè¿™ä¸HashMapä¸åŒçš„æ˜¯ï¼Œå®ƒå¹¶æ²¡æœ‰æŠŠTreeNodeç›´æ¥æ”¾å…¥çº¢é»‘æ ‘ï¼Œè€Œæ˜¯åˆ©ç”¨äº†TreeBinè¿™ä¸ªå°å®¹å™¨æ¥å°è£…æ‰€æœ‰çš„TreeNode.</p>
<h2 id="getæ–¹æ³•"><a href="#getæ–¹æ³•" class="headerlink" title="getæ–¹æ³•"></a>getæ–¹æ³•</h2><p>getæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œç»™å®šä¸€ä¸ªkeyæ¥ç¡®å®švalueçš„æ—¶å€™ï¼Œå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶  keyç›¸åŒ  hashå€¼ç›¸åŒï¼Œå¯¹äºèŠ‚ç‚¹å¯èƒ½åœ¨é“¾è¡¨æˆ–æ ‘ä¸Šçš„æƒ…å†µï¼Œéœ€è¦åˆ†åˆ«å»æŸ¥æ‰¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">        <span class="comment">//è®¡ç®—hashå€¼</span></span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        <span class="comment">//æ ¹æ®hashå€¼ç¡®å®šèŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæœç´¢åˆ°çš„èŠ‚ç‚¹keyä¸ä¼ å…¥çš„keyç›¸åŒä¸”ä¸ä¸ºnull,ç›´æ¥è¿”å›è¿™ä¸ªèŠ‚ç‚¹	</span></span><br><span class="line">            <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœeh&lt;0 è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹åœ¨æ ‘ä¸Š ç›´æ¥å¯»æ‰¾</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">             <span class="comment">//å¦åˆ™éå†é“¾è¡¨ æ‰¾åˆ°å¯¹åº”çš„å€¼å¹¶è¿”å›</span></span><br><span class="line">            <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sizeç›¸å…³çš„æ–¹æ³•"><a href="#Sizeç›¸å…³çš„æ–¹æ³•" class="headerlink" title="Sizeç›¸å…³çš„æ–¹æ³•"></a>Sizeç›¸å…³çš„æ–¹æ³•</h2><p>å¯¹äºConcurrentHashMapæ¥è¯´ï¼Œè¿™ä¸ªtableé‡Œåˆ°åº•è£…äº†å¤šå°‘ä¸œè¥¿å…¶å®æ˜¯ä¸ªä¸ç¡®å®šçš„æ•°é‡ï¼Œå› ä¸ºä¸å¯èƒ½åœ¨è°ƒç”¨size()æ–¹æ³•çš„æ—¶å€™åƒGCçš„â€œstop the worldâ€ä¸€æ ·è®©å…¶ä»–çº¿ç¨‹éƒ½åœä¸‹æ¥è®©ä½ å»ç»Ÿè®¡ï¼Œå› æ­¤åªèƒ½è¯´è¿™ä¸ªæ•°é‡æ˜¯ä¸ªä¼°è®¡å€¼ã€‚å¯¹äºè¿™ä¸ªä¼°è®¡å€¼ï¼ŒConcurrentHashMapä¹Ÿæ˜¯å¤§è´¹å‘¨ç« æ‰è®¡ç®—å‡ºæ¥çš„ã€‚</p>
<h3 id="è¾…åŠ©å®šä¹‰"><a href="#è¾…åŠ©å®šä¹‰" class="headerlink" title="è¾…åŠ©å®šä¹‰"></a>è¾…åŠ©å®šä¹‰</h3><p>ä¸ºäº†ç»Ÿè®¡å…ƒç´ ä¸ªæ•°ï¼ŒConcurrentHashMapå®šä¹‰äº†ä¸€äº›å˜é‡å’Œä¸€ä¸ªå†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A padded cell for distributing counts.  Adapted from LongAdder</span></span><br><span class="line"><span class="comment">     * and Striped64.  See their internal docs for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">        CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/******************************************/</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®é™…ä¸Šä¿å­˜çš„æ˜¯hashmapä¸­çš„å…ƒç´ ä¸ªæ•°  åˆ©ç”¨CASé”è¿›è¡Œæ›´æ–°</span></span><br><span class="line"><span class="comment">     ä½†å®ƒå¹¶ä¸ç”¨è¿”å›å½“å‰hashmapçš„å…ƒç´ ä¸ªæ•° </span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spinlock (locked via CAS) used when resizing and/or creating CounterCells.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table of counter cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure>
<h3 id="mappingCountä¸Sizeæ–¹æ³•"><a href="#mappingCountä¸Sizeæ–¹æ³•" class="headerlink" title="mappingCountä¸Sizeæ–¹æ³•"></a>mappingCountä¸Sizeæ–¹æ³•</h3><p>mappingCountä¸sizeæ–¹æ³•çš„ç±»ä¼¼  ä»Javaå·¥ç¨‹å¸ˆç»™å‡ºçš„æ³¨é‡Šæ¥çœ‹ï¼Œåº”è¯¥ä½¿ç”¨mappingCountä»£æ›¿sizeæ–¹æ³• ä¸¤ä¸ªæ–¹æ³•éƒ½æ²¡æœ‰ç›´æ¥è¿”å›basecount è€Œæ˜¯ç»Ÿè®¡ä¸€æ¬¡è¿™ä¸ªå€¼ï¼Œè€Œè¿™ä¸ªå€¼å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå¤§æ¦‚çš„æ•°å€¼ï¼Œå› æ­¤å¯èƒ½åœ¨ç»Ÿè®¡çš„æ—¶å€™æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰§è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">                (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">                (<span class="keyword">int</span>)n);</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of mappings. This method should be used</span></span><br><span class="line"><span class="comment">     * instead of &#123;<span class="doctag">@link</span> #size&#125; because a ConcurrentHashMap may</span></span><br><span class="line"><span class="comment">     * contain more mappings than can be represented as an int. The</span></span><br><span class="line"><span class="comment">     * value returned is an estimate; the actual count may differ if</span></span><br><span class="line"><span class="comment">     * there are concurrent insertions or removals.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of mappings</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">mappingCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0L</span>) ? <span class="number">0L</span> : n; <span class="comment">// ignore transient negative values</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">        <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">        <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                    sum += a.value;<span class="comment">//æ‰€æœ‰counterçš„å€¼æ±‚å’Œ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="addCountæ–¹æ³•"><a href="#addCountæ–¹æ³•" class="headerlink" title="addCountæ–¹æ³•"></a>addCountæ–¹æ³•</h3><p>åœ¨putæ–¹æ³•ç»“å°¾å¤„è°ƒç”¨äº†addCountæ–¹æ³•ï¼ŒæŠŠå½“å‰ConcurrentHashMapçš„å…ƒç´ ä¸ªæ•°+1è¿™ä¸ªæ–¹æ³•ä¸€å…±åšäº†ä¸¤ä»¶äº‹,æ›´æ–°baseCountçš„å€¼ï¼Œæ£€æµ‹æ˜¯å¦è¿›è¡Œæ‰©å®¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">        CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">        <span class="comment">//åˆ©ç”¨CASæ–¹æ³•æ›´æ–°baseCountçš„å€¼ </span></span><br><span class="line">        <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">            !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">            CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">            <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">                (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">                !(uncontended =</span><br><span class="line">                  U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">                fullAddCount(x, uncontended);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœcheckå€¼å¤§äºç­‰äº0 åˆ™éœ€è¦æ£€éªŒæ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">            <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">                <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                        sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                        transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                     <span class="comment">//å¦‚æœå·²ç»æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                        transfer(tab, nt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å½“å‰çº¿ç¨‹æ˜¯å”¯ä¸€çš„æˆ–æ˜¯ç¬¬ä¸€ä¸ªå‘èµ·æ‰©å®¹çš„çº¿ç¨‹  æ­¤æ—¶nextTable=null</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                             (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                    transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">                s = sumCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>JDK6,7ä¸­çš„ConcurrentHashmapä¸»è¦ä½¿ç”¨Segmentæ¥å®ç°å‡å°é”ç²’åº¦ï¼ŒæŠŠHashMapåˆ†å‰²æˆè‹¥å¹²ä¸ªSegmentï¼Œåœ¨putçš„æ—¶å€™éœ€è¦é”ä½Segmentï¼Œgetæ—¶å€™ä¸åŠ é”ï¼Œä½¿ç”¨volatileæ¥ä¿è¯å¯è§æ€§ï¼Œå½“è¦ç»Ÿè®¡å…¨å±€æ—¶ï¼ˆæ¯”å¦‚sizeï¼‰ï¼Œé¦–å…ˆä¼šå°è¯•å¤šæ¬¡è®¡ç®—modcountæ¥ç¡®å®šï¼Œè¿™å‡ æ¬¡å°è¯•ä¸­ï¼Œæ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¿®æ”¹æ“ä½œï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›sizeã€‚å¦‚æœæœ‰ï¼Œåˆ™éœ€è¦ä¾æ¬¡é”ä½æ‰€æœ‰çš„Segmentæ¥è®¡ç®—ã€‚</p>
<p>jdk7ä¸­ConcurrentHashmapä¸­ï¼Œå½“é•¿åº¦è¿‡é•¿ç¢°æ’ä¼šå¾ˆé¢‘ç¹ï¼Œé“¾è¡¨çš„å¢æ”¹åˆ æŸ¥æ“ä½œéƒ½ä¼šæ¶ˆè€—å¾ˆé•¿çš„æ—¶é—´ï¼Œå½±å“æ€§èƒ½,æ‰€ä»¥jdk8 ä¸­å®Œå…¨é‡å†™äº†concurrentHashmap,ä»£ç é‡ä»åŸæ¥çš„1000å¤šè¡Œå˜æˆäº† 6000å¤š è¡Œï¼Œå®ç°ä¸Šä¹Ÿå’ŒåŸæ¥çš„åˆ†æ®µå¼å­˜å‚¨æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚</p>
<p>ä¸»è¦è®¾è®¡ä¸Šçš„å˜åŒ–æœ‰ä»¥ä¸‹å‡ ç‚¹: </p>
<ol>
<li>ä¸é‡‡ç”¨segmentè€Œé‡‡ç”¨nodeï¼Œé”ä½nodeæ¥å®ç°å‡å°é”ç²’åº¦ã€‚</li>
<li>è®¾è®¡äº†MOVEDçŠ¶æ€ å½“resizeçš„ä¸­è¿‡ç¨‹ä¸­ çº¿ç¨‹2è¿˜åœ¨putæ•°æ®ï¼Œçº¿ç¨‹2ä¼šå¸®åŠ©resizeã€‚<br>3, ä½¿ç”¨3ä¸ªCASæ“ä½œæ¥ç¡®ä¿nodeçš„ä¸€äº›æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ç§æ–¹å¼ä»£æ›¿äº†é”ã€‚</li>
<li>sizeCtlçš„ä¸åŒå€¼æ¥ä»£è¡¨ä¸åŒå«ä¹‰ï¼Œèµ·åˆ°äº†æ§åˆ¶çš„ä½œç”¨ã€‚</li>
</ol>
<p>è‡³äºä¸ºä»€ä¹ˆJDK8ä¸­ä½¿ç”¨synchronizedè€Œä¸æ˜¯ReentrantLockï¼Œæ˜¯å› ä¸ºJDK8ä¸­å¯¹synchronizedæœ‰äº†è¶³å¤Ÿçš„ä¼˜åŒ–å§ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.jianshu.com/p/4806633fcc55" target="_blank" rel="noopener">http://www.jianshu.com/p/4806633fcc55</a></p>
<p><a href="http://blog.csdn.net/u010723709/article/details/48007881" target="_blank" rel="noopener">http://blog.csdn.net/u010723709/article/details/48007881</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;jdk6å’Œjdk7ä¸­çš„å®ç°&quot;&gt;&lt;a href=&quot;#jdk6å’Œjdk7ä¸­çš„å®ç°&quot; class=&quot;headerlink&quot; title=&quot;jdk6å’Œjdk7ä¸­çš„å®ç°&quot;&gt;&lt;/a&gt;jdk6å’Œjdk7ä¸­çš„å®ç°&lt;/h1&gt;&lt;h2 id=&quot;è®¾è®¡æ€è·¯&quot;&gt;&lt;a href=&quot;#è®¾è®¡æ€è·¯&quot; class=&quot;headerlink&quot; title=&quot;è®¾è®¡æ€è·¯&quot;&gt;&lt;/a&gt;è®¾è®¡æ€è·¯&lt;/h2&gt;&lt;p&gt;ConcurrentHashMapé‡‡ç”¨äº†åˆ†æ®µé”çš„è®¾è®¡ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†æ®µå†…æ‰å­˜åœ¨ç«æ€å…³ç³»ï¼Œä¸åŒçš„åˆ†æ®µé”ä¹‹é—´æ²¡æœ‰é”ç«äº‰ã€‚ç›¸æ¯”äºå¯¹æ•´ä¸ªMapåŠ é”çš„è®¾è®¡ï¼Œåˆ†æ®µé”å¤§å¤§çš„æé«˜äº†é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å¤„ç†èƒ½åŠ›ã€‚ä½†åŒæ—¶ï¼Œç”±äºä¸æ˜¯å¯¹æ•´ä¸ªMapåŠ é”ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦æ‰«ææ•´ä¸ªMapçš„æ–¹æ³•ï¼ˆå¦‚size(), containsValue()ï¼‰éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„å®ç°ï¼Œå¦å¤–ä¸€äº›æ–¹æ³•ï¼ˆå¦‚clear()ï¼‰ç”šè‡³æ”¾å¼ƒäº†å¯¹ä¸€è‡´æ€§çš„è¦æ±‚ï¼ˆConcurrentHashMapæ˜¯å¼±ä¸€è‡´æ€§çš„ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;ConcurrentHashMapä¸­çš„åˆ†æ®µé”ç§°ä¸ºSegmentï¼Œå®ƒå³ç±»ä¼¼äºHashMapçš„ç»“æ„ï¼Œå³å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªEntryæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼›åŒæ—¶åˆæ˜¯ä¸€ä¸ªReentrantLockï¼ˆSegmentç»§æ‰¿äº†ReentrantLockï¼‰ã€‚ConcurrentHashMapä¸­çš„HashEntryç›¸å¯¹äºHashMapä¸­çš„Entryæœ‰ä¸€å®šçš„å·®å¼‚æ€§ï¼šHashEntryä¸­çš„valueä»¥åŠnextéƒ½è¢«volatileä¿®é¥°ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹è¯»å†™è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒå®ƒä»¬çš„å¯è§æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HashEntry&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;K&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;V&lt;/span&gt;&amp;gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; hash;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; K key;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;volatile&lt;/span&gt; V value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;volatile&lt;/span&gt; HashEntry&amp;lt;K,V&amp;gt; next;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.top/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.top/tags/java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://idiotsky.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="conccurenthashmap" scheme="http://idiotsky.top/tags/conccurenthashmap/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªå¾ˆå¥½ç†è§£raftçš„åŠ¨ç”»æ¼”ç¤º</title>
    <link href="http://idiotsky.top/2018/07/24/understanding-raft/"/>
    <id>http://idiotsky.top/2018/07/24/understanding-raft/</id>
    <published>2018-07-24T13:23:16.000Z</published>
    <updated>2018-09-17T15:38:54.995Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>å¾ˆå¥½ç†è§£çš„åŠ¨ç”»ï¼Œä¸€çœ‹å°±æ‡‚äº†ğŸ‘¿</p>
</blockquote>
<iframe src="http://idiotsky.top/raft/raft/index.html" style="width:100%;height:700px;border-width: 0px;"><br></iframe>

<a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å¾ˆå¥½ç†è§£çš„åŠ¨ç”»ï¼Œä¸€çœ‹å°±æ‡‚äº†ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;iframe src=&quot;http://idiotsky.top/raft/raft/index.html&quot; style=&quot;width:100%;height:700px;border-width: 0px;&quot;&gt;&lt;br&gt;&lt;/iframe&gt;
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://idiotsky.top/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="raft" scheme="http://idiotsky.top/tags/raft/"/>
    
  </entry>
  
  <entry>
    <title>Paxosç¤ºä¾‹</title>
    <link href="http://idiotsky.top/2018/07/24/paxos-example/"/>
    <id>http://idiotsky.top/2018/07/24/paxos-example/</id>
    <published>2018-07-24T12:11:55.000Z</published>
    <updated>2018-07-26T01:25:04.105Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« é€šè¿‡ä¸€ä¸ªæœ‰æ•ˆçš„ä¾‹å­æè¿°äº†ä¸€ä¸ªåä¸ºPaxos çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ã€‚</p>
<p>åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ç”¨äºä½¿ä¸€ç»„è®¡ç®—æœºèƒ½å¤Ÿå°±å•ä¸ªå€¼è¾¾æˆä¸€è‡´ï¼Œä¾‹å¦‚é€šå¸¸ä½¿ç”¨ä¸¤é˜¶æ®µæˆ–ä¸‰é˜¶æ®µæäº¤åšå‡ºçš„æäº¤æˆ–å›æ»šå†³ç­–ã€‚åªè¦é€‰æ‹©ä¸€ä¸ªå€¼ï¼Œç®—æ³•çš„å…¶ä»–å€¼å°±æ²¡æœ‰å…³ç³»äº†ã€‚</p>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿™å¾ˆéš¾ï¼Œå› ä¸ºæœºå™¨ä¹‹é—´çš„æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±æˆ–æ— é™æœŸå»¶è¿Ÿï¼Œæˆ–è€…æœºå™¨æœ¬èº«å¯èƒ½ä¼šå‘ç”Ÿæ•…éšœã€‚</p>
<p>Paxosä¿è¯èŠ‚ç‚¹åªä¼šé€‰æ‹©å•ä¸ªå€¼ï¼ˆæ„å‘³ç€å®ƒä¿è¯å®‰å…¨ï¼‰ï¼Œä½†ä¸ä¿è¯åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸å¯ç”¨æ—¶èƒ½ä¸èƒ½å»åˆ°å€¼</p>
<a id="more"></a>
<h1 id="ä¸€èˆ¬çš„åšæ³•"><a href="#ä¸€èˆ¬çš„åšæ³•" class="headerlink" title="ä¸€èˆ¬çš„åšæ³•"></a>ä¸€èˆ¬çš„åšæ³•</h1><p>ä¸€ä¸ªPaxosçš„èŠ‚ç‚¹å¯ä»¥é‡‡å–ä»»ä½•æˆ–æ‰€æœ‰ä¸‰ä¸ªè§’è‰²ï¼š<code>proposer</code>ï¼Œ<code>acceptor</code>å’Œ<code>learner</code>ã€‚</p>
<p>ä¸€ä¸ª<code>proposer</code>æè®®ä¸€ä¸ªå€¼æ˜¯éœ€è¦åŒæ„æ‰è¡Œçš„ï¼Œå®ƒå‘ä¸€ä¸ªåŒ…å«å€¼çš„æè®®ç»™æ‰€æœ‰çš„<code>acceptor</code>ï¼Œ<code>acceptor</code>å†³å®šæ˜¯å¦åŒæ„è¿™ä¸ªå€¼ã€‚</p>
<p>æ¯ä¸ª<code>acceptor</code>ç‹¬ç«‹é€‰æ‹©ä¸€ä¸ªå€¼â€“å®ƒå¯èƒ½æ”¶åˆ°å¤šä¸ªæ¥è‡ªä¸åŒ<code>proposer</code>çš„æè®®â€“å¹¶å°†å…¶å†³å®šå‘é€ç»™<code>learner</code>ï¼Œä»¥ç¡®å®šæ˜¯å¦å·²æ¥å—ä»»ä½•å€¼ã€‚</p>
<p>å¯¹äºPaxosæ¥å—çš„å€¼ï¼Œå¤§å¤šæ•°<code>acceptor</code>å¿…é¡»é€‰æ‹©ç›¸åŒçš„å€¼ã€‚å®é™…ä¸Šï¼Œå•ä¸ªèŠ‚ç‚¹å¯ä»¥æ‰¿æ‹…è®¸å¤šæˆ–æ‰€æœ‰è¿™äº›è§’è‰²ï¼Œä½†åœ¨æœ¬èŠ‚çš„ç¤ºä¾‹ä¸­ï¼Œæ¯ä¸ªè§’è‰²éƒ½åœ¨ä¸€ä¸ªå•ç‹¬çš„èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><a href="http://idiotsky.top/images3/paxos-example.png"><img src="http://idiotsky.top/images3/paxos-example.png" alt=""></a></p>
<center>å›¾1ï¼šåŸºæœ¬Paxosæ¶æ„ã€‚ä¸€äº›<code>proposer</code>å‘<code>acceptor</code>æå‡ºå»ºè®®ã€‚å½“<code>acceptor</code>æ¥å—ä¸€ä¸ªå€¼æ—¶ï¼Œå®ƒä¼šå°†ç»“æœå‘é€ç»™<code>learner</code>èŠ‚ç‚¹ã€‚<br></center>

<h1 id="Paxosç¤ºä¾‹"><a href="#Paxosç¤ºä¾‹" class="headerlink" title="Paxosç¤ºä¾‹"></a>Paxosç¤ºä¾‹</h1><p>åœ¨æ ‡å‡†çš„Paxosç®—æ³•ä¸­ï¼Œ<code>proposer</code>å‘<code>acceptor</code>å‘é€ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯ï¼š<strong>å‡†å¤‡</strong>å’Œ<strong>æ¥å—</strong>è¯·æ±‚ã€‚</p>
<p>åœ¨è¯¥ç®—æ³•çš„ç¬¬ä¸€é˜¶æ®µï¼Œ<code>proposer</code>å‘æ¯ä¸ª<code>acceptor</code>å‘é€åŒ…å«å»ºè®®å€¼vå’Œæè®®å·nçš„å‡†å¤‡è¯·æ±‚ã€‚</p>
<p>å¯¹äºå…¶ä»–<code>proposer</code>çš„ææ¡ˆå·ï¼Œæ¯ä¸ª<code>proposer</code>çš„æè®®å·å¿…é¡»æ˜¯æ­£æ•°çš„ï¼Œå•è°ƒé€’å¢çš„ï¼Œå”¯ä¸€çš„ï¼Œè‡ªç„¶çš„æ•°å­—ã€‚</p>
<p>åœ¨ä¸‹é¢è¯´æ˜çš„ç¤ºä¾‹ä¸­ï¼Œæœ‰ä¸¤ä¸ª<code>proposer</code>ï¼Œä¸¤ä¸ªéƒ½æå‡ºå‡†å¤‡è¯·æ±‚ã€‚æ¥è‡ª<code>proposer A</code>çš„è¯·æ±‚å’Œæ¥è‡ª<code>proposer B</code>çš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾<code>acceptor X</code>å’Œ<code>acceptor Y</code>ï¼Œè€Œæ¥è‡ª<code>proposer B</code>çš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾<code>acceptor Z</code>ã€‚</p>
<p><a href="http://idiotsky.top/images3/paxos-example-1.png"><img src="http://idiotsky.top/images3/paxos-example-1.png" alt=""></a></p>
<center>å›¾2ï¼šproposer Aå’ŒBå„è‡ªå‘æ¯ä¸ªæ¥å—è€…å‘é€å‡†å¤‡è¯·æ±‚ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œproposer Açš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾æ¥acceptor Xå’ŒYï¼Œè€Œproposer Bçš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾acceptor Z.</center>

<p>å¦‚æœæ¥æ”¶å‡†å¤‡è¯·æ±‚çš„<code>acceptor</code>æ²¡æœ‰çœ‹åˆ°å¦ä¸€ä¸ªæè®®ï¼Œåˆ™<code>acceptor</code>ä»¥å‡†å¤‡å“åº”ä½œå‡ºå“åº”ï¼Œè¯¥å‡†å¤‡å“åº”æ‰¿è¯ºæ°¸è¿œä¸æ¥å—å…·æœ‰è¾ƒä½æè®®ç¼–å·çš„å¦ä¸€æè®®ã€‚</p>
<p>è¿™åœ¨ä¸‹é¢çš„å›¾3ä¸­è¯´æ˜ï¼Œå…¶æ˜¾ç¤ºäº†æ¯ä¸ªæ¥å—è€…å¯¹ä»–ä»¬æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªå‡†å¤‡è¯·æ±‚çš„å“åº”ã€‚</p>
<p><a href="http://idiotsky.top/images3/paxos-example-2.png"><img src="http://idiotsky.top/images3/paxos-example-2.png" alt=""></a></p>
<center>å›¾3ï¼šæ¯ä¸ª<code>acceptor</code>å“åº”å®ƒæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªå‡†å¤‡è¯·æ±‚æ¶ˆæ¯ã€‚</center>

<p>æœ€ç»ˆï¼Œ<code>acceptor Z</code>æ¥æ”¶<code>proposer A</code>çš„è¯·æ±‚ï¼Œ<code>acceptor X</code>å’Œ<code>acceptor Y</code>æ¥æ”¶<code>proposer B</code>çš„è¯·æ±‚ã€‚</p>
<p>å¦‚æœ<code>acceptor</code>å·²ç»çœ‹åˆ°å…·æœ‰æ›´é«˜æè®®å·çš„è¯·æ±‚ï¼Œåˆ™å¿½ç•¥å‡†å¤‡è¯·æ±‚ï¼Œ<code>proposer A</code>å¯¹<code>acceptor Z</code>çš„è¯·æ±‚å°±æ˜¯è¿™ç§æƒ…å†µã€‚</p>
<p>å¦‚æœ<code>acceptor</code>æ²¡æœ‰çœ‹åˆ°æ›´é«˜ç¼–å·çš„è¯·æ±‚ï¼Œå®ƒå†æ¬¡æ‰¿è¯ºå¿½ç•¥å…·æœ‰è¾ƒä½æè®®ç¼–å·çš„ä»»ä½•è¯·æ±‚ï¼Œå¹¶å‘å›å…¶å·²æ¥å—çš„ç¼–å·æœ€é«˜çš„æè®®ä»¥åŠè¯¥æè®®çš„å€¼ã€‚</p>
<p><code>proposer B</code>å¯¹<code>acceptor X</code>å’Œ<code>acceptor Y</code>çš„è¯·æ±‚å°±æ˜¯è¿™ç§æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="http://idiotsky.top/images3/paxos-example-3.png"><img src="http://idiotsky.top/images3/paxos-example-3.png" alt=""></a></p>
<center>å›¾4ï¼šacceptor Zå¿½ç•¥äº†proposer Açš„è¯·æ±‚ï¼Œå› ä¸ºå®ƒå·²ç»çœ‹åˆ°äº†æ›´é«˜ç¼–å·çš„æè®®ï¼ˆ4&gt; 2ï¼‰ã€‚acceptor Xå’ŒYç”¨ä»–ä»¬å…ˆå‰ç¡®è®¤çš„æœ€é«˜è¯·æ±‚æ¥å“åº”proposer Bçš„è¯·æ±‚ï¼Œå¹¶æ‰¿è¯ºå¿½ç•¥ä»»ä½•ç¼–å·è¾ƒä½çš„æè®®ã€‚</center>

<p>ä¸€æ—¦<code>proposer</code>æ”¶åˆ°å¤§å¤šæ•°<code>acceptor</code>çš„å‡†å¤‡å“åº”ï¼Œå®ƒå°±å¯ä»¥å‘å‡ºæ¥å—è¯·æ±‚ã€‚</p>
<p>ç”±äº<code>proposer A</code>ä»…æ”¶åˆ°è¡¨æ˜æ²¡æœ‰å…ˆå‰ææ¡ˆ<code>[no previous]</code>çš„å“åº”ï¼Œå› æ­¤å®ƒå‘<code>acceptor</code>å‘é€ä¸åˆå§‹ææ¡ˆç›¸åŒçš„æè®®ç¼–å·å’Œå€¼çš„æ¥å—è¯·æ±‚ï¼ˆn = 2ï¼Œv = 8ï¼‰ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™äº›è¯·æ±‚è¢«æ¯ä¸€ä¸ª<code>acceptor</code>å¿½ç•¥ï¼Œå› ä¸º<code>acceptor</code>éƒ½æ‰¿è¯ºä¸æ¥å—çš„æè®®å·ä½äºè¯·æ±‚4ï¼ˆå“åº”å‡†å¤‡è¯·æ±‚ç»™<code>proposer B</code>ï¼‰ã€‚</p>
<p><code>proposer B</code>å‘æ¯ä¸ª<code>acceptor</code>å‘é€åŒ…å«å…¶å…ˆå‰ä½¿ç”¨çš„æè®®å·ï¼ˆn = 4ï¼‰çš„æ¥å—è¯·æ±‚ï¼Œå¹¶ä¸”è¿™ä¸ªæ¥å—è¯·æ±‚è¿˜åŒ…å«äº†åœ¨å…¶æ”¶åˆ°çš„å‡†å¤‡å“åº”æ¶ˆæ¯ä¸­ä¸æœ€é«˜æè®®å·ç›¸å…³è”çš„å€¼ï¼ˆv = 8ï¼‰ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œè¿™ä¸æ˜¯<code>proposer B</code>æœ€åˆæå‡ºçš„å€¼ï¼Œè€Œæ˜¯å®ƒçœ‹åˆ°çš„å‡†å¤‡å“åº”æ¶ˆæ¯ä¸­çš„æœ€é«˜å€¼ã€‚</p>
<p><a href="http://idiotsky.top/images3/paxos-example-4.png"><img src="http://idiotsky.top/images3/paxos-example-4.png" alt=""></a></p>
<center>å›¾5ï¼Œ<code>proposer B</code>å‘é€ä¸€ä¸ªæ¥å—è¯·æ±‚ç»™æ¯ä¸ª<code>acceptor</code>,è¿™ä¸ªè¯·æ±‚åŒ…å«äº†å®ƒä¹‹å‰çš„æè®®å·(4)å’Œå®ƒä»[n=2,v=8]ä¸­çœ‹åˆ°çš„å€¼ï¼ˆ8ï¼‰</center>

<p>å¦‚æœ<code>acceptor</code>æ”¶åˆ°çš„æ¥å—è¯·æ±‚çš„æè®®å·å¤§äºæˆ–ç­‰äºä¹‹å‰å®ƒä¿è¯çš„ï¼Œé‚£ä¹ˆå®ƒæ¥å—å¹¶å‘æ¯ä¸ª<code>learner</code>èŠ‚ç‚¹å‘é€é€šçŸ¥ã€‚</p>
<p>å½“<code>learner</code>å‘ç°å¤§å¤šæ•°`acceptorå·²æ¥å—æŸä¸ªå€¼æ—¶ï¼ŒPaxosç®—æ³•ä¼šé€‰æ‹©è¿™ä¸ªå€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><a href="http://idiotsky.top/images3/paxos-example-5.png"><img src="http://idiotsky.top/images3/paxos-example-5.png" alt=""></a></p>
<p>ä¸€æ—¦Paxosé€‰æ‹©äº†ä¸€ä¸ªå€¼ï¼Œä¸å…¶ä»–<code>proposer</code>çš„è¿›ä¸€æ­¥æ²Ÿé€šå°±æ— æ³•æ”¹å˜è¿™ä¸ªå€¼ã€‚</p>
<p>å¦‚æœå¦ä¸€ä¸ª<code>proposer</code>ï¼ˆ<code>proposer C</code>ï¼‰å‘é€çš„æè®®å·æ¯”ä¹‹å‰çœ‹åˆ°çš„æè®®å·æ›´é«˜ï¼Œå¹¶ä¸”å…·æœ‰ä¸åŒçš„å€¼ï¼ˆä¾‹å¦‚ï¼Œn = 6ï¼Œv = 7ï¼‰ï¼Œåˆ™æ¯ä¸ª<code>acceptor</code>éƒ½ä¼šä½¿ç”¨ä¹‹å‰çš„æœ€é«˜æè®®å·è¿›è¡Œå“åº”ï¼ˆn = 4ï¼Œv = 8ï¼‰ã€‚</p>
<p>è¿™è¦æ±‚<code>proposer C</code>å‘é€åŒ…å«[n = 6ï¼Œv = 8] çš„æ¥å—è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä»…ç¡®è®¤å·²ç»é€‰æ‹©çš„å€¼ã€‚æ­¤å¤–ï¼Œå¦‚æœä¸€äº›å°‘<code>acceptor</code>è¿˜æ²¡æœ‰é€‰æ‹©ä¸€ä¸ªä»·å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç¡®ä¿ä»–ä»¬æœ€ç»ˆå°±åŒä¸€ä»·å€¼è¾¾æˆå…±è¯†ã€‚</p>
<p>Lamportå’ŒBakerç­‰äººåœ¨è®ºæ–‡ä¸­è®¨è®ºäº†å¯¹æ ‡å‡†Paxosç®—æ³•çš„å„ç§æ•ˆç‡æ”¹è¿›ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ<code>proposer</code>çŸ¥é“å®ƒæ˜¯ç¬¬ä¸€ä¸ªå»ºè®®å€¼çš„è¯ï¼Œåˆ™å‡†å¤‡è¯·æ±‚ä¸å†æ˜¯å¿…é¡»çš„äº†ã€‚</p>
<p>å› ä¸ºè¿™ç§è¯·æ±‚çš„æè®®ç¼–å·ä¸º0ï¼Œå¦‚æœæ”¶åˆ°ä»»ä½•æ›´é«˜ç¼–å·çš„è¯·æ±‚çš„è¯ï¼Œè¿™ç§è¯·æ±‚å°±ä¼šè¢«å¿½ç•¥çš„ã€‚</p>
<p>ç¿»è¯‘ <a href="https://angus.nyc/2012/paxos-by-example/" target="_blank" rel="noopener">https://angus.nyc/2012/paxos-by-example/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡æ–‡ç« é€šè¿‡ä¸€ä¸ªæœ‰æ•ˆçš„ä¾‹å­æè¿°äº†ä¸€ä¸ªåä¸ºPaxos çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ã€‚&lt;/p&gt;
&lt;p&gt;åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ç”¨äºä½¿ä¸€ç»„è®¡ç®—æœºèƒ½å¤Ÿå°±å•ä¸ªå€¼è¾¾æˆä¸€è‡´ï¼Œä¾‹å¦‚é€šå¸¸ä½¿ç”¨ä¸¤é˜¶æ®µæˆ–ä¸‰é˜¶æ®µæäº¤åšå‡ºçš„æäº¤æˆ–å›æ»šå†³ç­–ã€‚åªè¦é€‰æ‹©ä¸€ä¸ªå€¼ï¼Œç®—æ³•çš„å…¶ä»–å€¼å°±æ²¡æœ‰å…³ç³»äº†ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿™å¾ˆéš¾ï¼Œå› ä¸ºæœºå™¨ä¹‹é—´çš„æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±æˆ–æ— é™æœŸå»¶è¿Ÿï¼Œæˆ–è€…æœºå™¨æœ¬èº«å¯èƒ½ä¼šå‘ç”Ÿæ•…éšœã€‚&lt;/p&gt;
&lt;p&gt;Paxosä¿è¯èŠ‚ç‚¹åªä¼šé€‰æ‹©å•ä¸ªå€¼ï¼ˆæ„å‘³ç€å®ƒä¿è¯å®‰å…¨ï¼‰ï¼Œä½†ä¸ä¿è¯åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸å¯ç”¨æ—¶èƒ½ä¸èƒ½å»åˆ°å€¼&lt;/p&gt;
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://idiotsky.top/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Paxos" scheme="http://idiotsky.top/tags/Paxos/"/>
    
  </entry>
  
  <entry>
    <title>kafkaæ€»ç»“</title>
    <link href="http://idiotsky.top/2018/07/22/kafka-summary/"/>
    <id>http://idiotsky.top/2018/07/22/kafka-summary/</id>
    <published>2018-07-22T13:38:51.000Z</published>
    <updated>2018-07-22T07:50:29.168Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ç©äº†å¾ˆä¹…çš„kafkaï¼Œç°åœ¨æ€»ç»“ä¸‹å§ï¼Œå½“ç„¶é€šè¿‡åˆ«äººçš„æ–‡ç« æ¥æ€»ç»“è¿˜æ˜¯äº‹åŠåŠŸå€çš„ğŸ‘¿</p>
</blockquote>
<h1 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h1><p><a href="http://idiotsky.top/images3/kafka-1.jpg"><img src="http://idiotsky.top/images3/kafka-1.jpg" alt=""></a></p>
<p>å¦‚ä¸Šå›¾ï¼Œä¸€ä¸ªkafkaæ¶æ„åŒ…æ‹¬è‹¥å¹²ä¸ªProducerï¼ˆæœåŠ¡å™¨æ—¥å¿—ã€ä¸šåŠ¡æ•°æ®ã€webå‰ç«¯äº§ç”Ÿçš„page viewç­‰ï¼‰ï¼Œè‹¥å¹²ä¸ªBrokerï¼ˆkafkaæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œä¸€èˆ¬brokeræ•°é‡è¶Šå¤šé›†ç¾¤çš„ååé‡è¶Šå¤§ï¼‰ï¼Œè‹¥å¹²ä¸ªconsumer groupï¼Œä¸€ä¸ªZookeeperé›†ç¾¤ï¼ˆkafkaé€šè¿‡Zookeeperç®¡ç†é›†ç¾¤é…ç½®ã€é€‰ä¸¾leaderã€consumer groupå‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œrebalanceï¼‰ã€‚</p>
<a id="more"></a>
<h1 id="åç§°è§£é‡Š"><a href="#åç§°è§£é‡Š" class="headerlink" title="åç§°è§£é‡Š"></a>åç§°è§£é‡Š</h1><ul>
<li>Broker: æ¶ˆæ¯ä¸­é—´ä»¶å¤„ç†èŠ‚ç‚¹ï¼ˆæœåŠ¡å™¨ï¼‰ï¼Œä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªbrokerï¼Œä¸€ä¸ªKafkaé›†ç¾¤ç”±ä¸€ä¸ªæˆ–å¤šä¸ªbrokerç»„æˆ</li>
<li>Topic: Kafkaå¯¹æ¶ˆæ¯è¿›è¡Œå½’ç±»ï¼Œå‘é€åˆ°é›†ç¾¤çš„æ¯ä¸€æ¡æ¶ˆæ¯éƒ½è¦æŒ‡å®šä¸€ä¸ªtopic</li>
<li>Partition: ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ªtopicåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªpartitionï¼Œä¸€ä¸ªpartitionå¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹å­˜å‚¨partitionçš„æ•°æ®å’Œç´¢å¼•æ–‡ä»¶ï¼Œæ¯ä¸ªpartitionå†…éƒ¨æ˜¯æœ‰åºçš„</li>
<li>Producer: ç”Ÿäº§è€…ï¼Œè´Ÿè´£å‘å¸ƒæ¶ˆæ¯åˆ°broker</li>
<li>Consumer: æ¶ˆè´¹è€…ï¼Œä»brokerè¯»å–æ¶ˆæ¯</li>
<li>ConsumerGroup: æ¯ä¸ªconsumerå±äºä¸€ä¸ªç‰¹å®šçš„consumer groupï¼Œå¯ä¸ºæ¯ä¸ªconsumeræŒ‡å®šgroup nameï¼Œè‹¥ä¸æŒ‡å®šï¼Œåˆ™å±äºé»˜è®¤çš„groupï¼Œä¸€æ¡æ¶ˆæ¯å¯ä»¥å‘é€åˆ°ä¸åŒçš„consumer groupï¼Œä½†ä¸€ä¸ªconsumer groupä¸­åªèƒ½æœ‰ä¸€ä¸ªconsumerèƒ½æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯</li>
</ul>
<h1 id="å…³ç³»è§£é‡Š"><a href="#å…³ç³»è§£é‡Š" class="headerlink" title="å…³ç³»è§£é‡Š"></a>å…³ç³»è§£é‡Š</h1><h2 id="Topic-amp-Partition"><a href="#Topic-amp-Partition" class="headerlink" title="Topic &amp; Partition"></a>Topic &amp; Partition</h2><p>ä¸€ä¸ªtopicä¸ºä¸€ç±»æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»æŒ‡å®šä¸€ä¸ªtopicã€‚ç‰©ç†ä¸Šï¼Œä¸€ä¸ªtopicåˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªpartitionï¼Œæ¯ä¸ªpartitionæœ‰å¤šä¸ªå‰¯æœ¬åˆ†å¸ƒåœ¨ä¸åŒçš„brokerä¸­ï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p><a href="http://idiotsky.top/images3/kafka-2.jpg"><img src="http://idiotsky.top/images3/kafka-2.jpg" alt=""></a></p>
<p>æ¯ä¸ªpartitionåœ¨å­˜å‚¨å±‚é¢æ˜¯ä¸€ä¸ªappend logæ–‡ä»¶ï¼Œå‘å¸ƒåˆ°æ­¤partitionçš„æ¶ˆæ¯ä¼šè¿½åŠ åˆ°logæ–‡ä»¶çš„å°¾éƒ¨ï¼Œä¸ºé¡ºåºå†™äººç£ç›˜ï¼ˆé¡ºåºå†™ç£ç›˜æ¯”éšæœºå†™å†…å­˜çš„æ•ˆç‡è¿˜è¦é«˜ï¼‰ã€‚æ¯æ¡æ¶ˆæ¯åœ¨logæ–‡ä»¶ä¸­çš„ä½ç½®æˆä¸ºoffsetï¼ˆåç§»é‡ï¼‰ï¼Œoffsetä¸ºä¸€ä¸ªlongå‹æ•°å­—ï¼Œå”¯ä¸€æ ‡è®°ä¸€æ¡æ¶ˆæ¯ã€‚å¦‚ä¸‹å›¾</p>
<p><a href="http://idiotsky.top/images3/kafka-3.png"><img src="http://idiotsky.top/images3/kafka-3.png" alt=""></a></p>
<p>æ¯ä¸ªæ¶ˆè´¹è€…å”¯ä¸€ä¿å­˜çš„å…ƒæ•°æ®æ˜¯offsetå€¼ï¼Œè¿™ä¸ªä½ç½®å®Œå…¨ä¸ºæ¶ˆè´¹è€…æ§åˆ¶ï¼Œå› æ­¤æ¶ˆè´¹è€…å¯ä»¥é‡‡ç”¨ä»»ä½•é¡ºåºæ¥æ¶ˆè´¹è®°å½•ï¼Œå¦‚ä¸‹å›¾</p>
<p><a href="http://idiotsky.top/images3/kafka-4.png"><img src="http://idiotsky.top/images3/kafka-4.png" alt=""></a></p>
<p>kafkaä¸­åªèƒ½ä¿è¯partitionä¸­è®°å½•æ˜¯æœ‰åºçš„ï¼Œè€Œä¸ä¿è¯topicä¸­ä¸åŒpartitionçš„é¡ºåº</p>
<h2 id="Consumer-group-amp-consumer"><a href="#Consumer-group-amp-consumer" class="headerlink" title="Consumer group &amp; consumer"></a>Consumer group &amp; consumer</h2><p>ä¸€ä¸ªæ¶ˆè´¹ç»„ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹ç»„æˆï¼Œä¾¿äºæ‰©å®¹ä¸å®¹é”™ã€‚</p>
<p>kafkaæ˜¯å‘å¸ƒä¸è®¢é˜…æ¨¡å¼ï¼Œè¿™ä¸ªè®¢é˜…è€…æ˜¯æ¶ˆè´¹ç»„ï¼Œè€Œä¸æ˜¯æ¶ˆè´¹è€…å®ä¾‹ã€‚æ¯ä¸€æ¡æ¶ˆæ¯åªä¼šè¢«åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œçš„ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹æ¶ˆè´¹ï¼Œä¸åŒçš„æ¶ˆè´¹ç»„å¯ä»¥åŒæ—¶æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾</p>
<p><a href="http://idiotsky.top/images3/kafka-5.png"><img src="http://idiotsky.top/images3/kafka-5.png" alt=""></a></p>
<p>ä¸ºäº†å®ç°ä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡çš„è¯­ä¹‰ï¼Œkafkaä¿è¯åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ä¼šæ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯ï¼Œkafkaè¿˜å…è®¸ä¸åŒçš„æ¶ˆè´¹ç»„åŒæ—¶æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™ä¸€ç‰¹æ€§å¯ä»¥ä¸ºæ¶ˆæ¯çš„å¤šå…ƒåŒ–å¤„ç†æä¾›äº†æ”¯æŒï¼Œkafkaçš„è®¾è®¡ç†å¿µä¹‹ä¸€å°±æ˜¯åŒæ—¶æä¾›ç¦»çº¿å¤„ç†å’Œå®æ—¶å¤„ç†ï¼Œå› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨Stormè¿™ç§å®æ—¶æµå¤„ç†ç³»ç»Ÿå¯¹æ¶ˆæ¯è¿›è¡Œå®æ—¶åœ¨çº¿å¤„ç†ï¼ŒåŒæ—¶ä½¿ç”¨Hadoopè¿™ç§æ‰¹å¤„ç†ç³»ç»Ÿè¿›è¡Œç¦»çº¿å¤„ç†ï¼Œè¿˜å¯ä»¥åŒæ—¶å°†æ•°æ®å®æ—¶å¤‡ä»½åˆ°å¦ä¸€ä¸ªæ•°æ®ä¸­å¿ƒï¼Œåªéœ€è¦ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œçš„æ¶ˆè´¹è€…å®ä¾‹åœ¨ä¸åŒconsumer group å³å¯</p>
<h2 id="Consumer-Rebalance"><a href="#Consumer-Rebalance" class="headerlink" title="Consumer Rebalance"></a>Consumer Rebalance</h2><p>kafkaä¿è¯äº†åŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹ä¼šæ¶ˆè´¹æŸæ¡æ¶ˆæ¯ï¼Œå®é™…ä¸Šï¼Œkafkaä¿è¯çš„æ˜¯ç¨³å®šçŠ¶æ€ä¸‹æ¯ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹åªä¼šæ¶ˆè´¹ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®špartitionæ•°æ®ï¼Œè€ŒæŸä¸ªpartitionçš„æ•°æ®åªä¼šè¢«æŸä¸€ç‰¹å®šçš„consumerå®ä¾‹æ¶ˆè´¹ï¼Œè¿™æ ·è®¾è®¡çš„åŠ£åŠ¿æ˜¯æ— æ³•è®©åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œçš„consumerå‡åŒ€æ¶ˆè´¹ï¼Œä¼˜åŠ¿æ˜¯æ¯ä¸ªconsumerä¸ç”¨è·Ÿå¤§é‡çš„brokeré€šä¿¡ï¼Œå‡å°‘é€šä¿¡å¼€é”€ï¼Œä¹Ÿé™ä½äº†åˆ†é…éš¾åº¦ã€‚è€Œä¸”ï¼ŒåŒä¸€ä¸ªpartitionæ•°æ®æ˜¯æœ‰åºçš„ï¼Œä¿è¯äº†æœ‰åºè¢«æ¶ˆè´¹ã€‚æ ¹æ®consumer groupä¸­çš„consumeræ•°é‡å’Œpartitionæ•°é‡ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹3ç§æƒ…å†µï¼š</p>
<ul>
<li>è‹¥consumer groupä¸­çš„consumeræ•°é‡å°‘äºpartitionæ•°é‡ï¼Œåˆ™è‡³å°‘æœ‰1ä¸ªconsumerä¼šæ¶ˆè´¹å¤šä¸ªpartitionæ•°æ®</li>
<li>è‹¥consumer groupä¸­çš„consumeræ•°é‡å¤šäºpartitionæ•°é‡ï¼Œåˆ™ä¼šæœ‰éƒ¨åˆ†consumeræ— æ³•æ¶ˆè´¹è¯¥topicä¸­ä»»ä½•ä¸€æ¡æ¶ˆæ¯</li>
<li>è‹¥consumer groupä¸­çš„consumeræ•°é‡ç­‰äºpartitionæ•°é‡ï¼Œåˆ™æ­£å¥½ä¸€ä¸ªconsumeræ¶ˆè´¹ä¸€ä¸ªpartitionæ•°æ®</li>
</ul>
<h1 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h1><p>ä»¥ä¸€ä¸ªå®ä¾‹ç»“æŸè¿™ç¯‡æ–‡ç« </p>
<p>åˆ›å»ºä¸€ä¸ª<code>kafka-topic</code>,å®ƒæœ‰4ä¸ªåˆ†ç‰‡ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --create --zookeeper zk:2181 --replication-factor 1 --partitions 4 --topic kafka-topic</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™ä¸€ä¸ª<a href="https://github.com/ejunjsh/java-code/blob/master/src/main/java/com/sky/code/kafka/CustomPartitionProducer.java" target="_blank" rel="noopener">ç”Ÿäº§è€…</a></p>
<p>è¾“å‡º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Sun Jul 22 07:17:11 UTC 2018,kafka.apache.org,192.168.14.203</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  0</span><br><span class="line">Sun Jul 22 07:17:14 UTC 2018,kafka.apache.org,192.168.14.134</span><br><span class="line">publish to partition 0</span><br><span class="line">offset  0</span><br><span class="line">Sun Jul 22 07:17:16 UTC 2018,kafka.apache.org,192.168.14.150</span><br><span class="line">publish to partition 0</span><br><span class="line">offset  1</span><br><span class="line">Sun Jul 22 07:17:18 UTC 2018,kafka.apache.org,192.168.14.49</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  1</span><br><span class="line">Sun Jul 22 07:17:20 UTC 2018,kafka.apache.org,192.168.14.55</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  2</span><br><span class="line">Sun Jul 22 07:17:22 UTC 2018,kafka.apache.org,192.168.14.172</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  3</span><br><span class="line">Sun Jul 22 07:17:24 UTC 2018,kafka.apache.org,192.168.14.122</span><br><span class="line">publish to partition 1</span><br><span class="line">offset  0</span><br><span class="line">Sun Jul 22 07:17:26 UTC 2018,kafka.apache.org,192.168.14.237</span><br><span class="line">publish to partition 3</span><br><span class="line">offset  0</span><br><span class="line">Sun Jul 22 07:17:28 UTC 2018,kafka.apache.org,192.168.14.95</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  4</span><br></pre></td></tr></table></figure></p>
<p>åŸºæœ¬éƒ½å‡åŒ€å†™åˆ°ä¸åŒçš„åˆ†ç‰‡ä¸Š</p>
<p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ª<a href="https://github.com/ejunjsh/java-code/blob/master/src/main/java/com/sky/code/kafka/CustomPartitionConsumer.java" target="_blank" rel="noopener">æ¶ˆè´¹è€…</a>ï¼Œå®ƒå¯åŠ¨ä¸‰ä¸ªçº¿ç¨‹ä»£è¡¨ä¸‰ä¸ªæ¶ˆè´¹è€…å»æ¶ˆè´¹</p>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0: &#123;partition=1, offset=20, value=Sun Jul 22 07:20:12 UTC 2018,kafka.apache.org,192.168.14.141&#125;</span><br><span class="line">0: &#123;partition=0, offset=20, value=Sun Jul 22 07:20:14 UTC 2018,kafka.apache.org,192.168.14.113&#125;</span><br><span class="line">2: &#123;partition=3, offset=24, value=Sun Jul 22 07:20:16 UTC 2018,kafka.apache.org,192.168.14.173&#125;</span><br><span class="line">0: &#123;partition=0, offset=21, value=Sun Jul 22 07:20:18 UTC 2018,kafka.apache.org,192.168.14.38&#125;</span><br><span class="line">2: &#123;partition=3, offset=25, value=Sun Jul 22 07:20:20 UTC 2018,kafka.apache.org,192.168.14.222&#125;</span><br><span class="line">1: &#123;partition=2, offset=26, value=Sun Jul 22 07:20:22 UTC 2018,kafka.apache.org,192.168.14.19&#125;</span><br><span class="line">2: &#123;partition=3, offset=26, value=Sun Jul 22 07:20:24 UTC 2018,kafka.apache.org,192.168.14.227&#125;</span><br><span class="line">0: &#123;partition=1, offset=21, value=Sun Jul 22 07:20:26 UTC 2018,kafka.apache.org,192.168.14.72&#125;</span><br><span class="line">0: &#123;partition=1, offset=22, value=Sun Jul 22 07:20:28 UTC 2018,kafka.apache.org,192.168.14.68&#125;</span><br><span class="line">1: &#123;partition=2, offset=27, value=Sun Jul 22 07:20:31 UTC 2018,kafka.apache.org,192.168.14.172&#125;</span><br><span class="line">2: &#123;partition=3, offset=27, value=Sun Jul 22 07:20:33 UTC 2018,kafka.apache.org,192.168.14.45&#125;</span><br><span class="line">0: &#123;partition=1, offset=23, value=Sun Jul 22 07:20:35 UTC 2018,kafka.apache.org,192.168.14.87&#125;</span><br><span class="line">2: &#123;partition=3, offset=28, value=Sun Jul 22 07:20:37 UTC 2018,kafka.apache.org,192.168.14.160&#125;</span><br><span class="line">2: &#123;partition=3, offset=29, value=Sun Jul 22 07:20:39 UTC 2018,kafka.apache.org,192.168.14.54&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸€è¡Œå¼€å¤´çš„åºå·ä»£è¡¨çš„æ˜¯æ¶ˆè´¹è€…çš„åºå·ï¼Œå¾ˆæ˜æ˜¾0å·æ¶ˆè´¹è€…æ¶ˆè´¹äº†0å’Œ1åˆ†ç‰‡ï¼Œ1å·æ¶ˆè´¹è€…æ¶ˆè´¹2å·åˆ†ç‰‡ï¼Œ2å·æ¶ˆè´¹è€…æ¶ˆè´¹3å·åˆ†ç‰‡</p>
<p>æ¥ä¸‹æ¥è¯•ä¸‹åŠ å¤§æ¶ˆè´¹è€…ç­‰äºåˆ†ç‰‡æ•°å³4ä¸ªæ¶ˆè´¹è€…çœ‹çœ‹</p>
<p>è¾“å‡º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0: &#123;partition=0, offset=66, value=Sun Jul 22 07:27:06 UTC 2018,kafka.apache.org,192.168.14.99&#125;</span><br><span class="line">3: &#123;partition=3, offset=90, value=Sun Jul 22 07:27:08 UTC 2018,kafka.apache.org,192.168.14.222&#125;</span><br><span class="line">0: &#123;partition=0, offset=67, value=Sun Jul 22 07:27:10 UTC 2018,kafka.apache.org,192.168.14.106&#125;</span><br><span class="line">2: &#123;partition=2, offset=70, value=Sun Jul 22 07:27:12 UTC 2018,kafka.apache.org,192.168.14.175&#125;</span><br><span class="line">0: &#123;partition=0, offset=68, value=Sun Jul 22 07:27:14 UTC 2018,kafka.apache.org,192.168.14.163&#125;</span><br><span class="line">1: &#123;partition=1, offset=70, value=Sun Jul 22 07:27:16 UTC 2018,kafka.apache.org,192.168.14.176&#125;</span><br><span class="line">3: &#123;partition=3, offset=91, value=Sun Jul 22 07:27:18 UTC 2018,kafka.apache.org,192.168.14.228&#125;</span><br><span class="line">2: &#123;partition=2, offset=71, value=Sun Jul 22 07:27:20 UTC 2018,kafka.apache.org,192.168.14.55&#125;</span><br><span class="line">1: &#123;partition=1, offset=71, value=Sun Jul 22 07:27:22 UTC 2018,kafka.apache.org,192.168.14.40&#125;</span><br><span class="line">1: &#123;partition=1, offset=72, value=Sun Jul 22 07:27:24 UTC 2018,kafka.apache.org,192.168.14.135&#125;</span><br><span class="line">0: &#123;partition=0, offset=69, value=Sun Jul 22 07:27:26 UTC 2018,kafka.apache.org,192.168.14.249&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¾ˆæ˜æ˜¾ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…è·Ÿæ¯ä¸ªåˆ†ç‰‡æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚</p>
<p>å†çœ‹çœ‹æ¶ˆè´¹è€…å¤šä½™åˆ†ç‰‡çš„æƒ…å†µ,è¿™æ¬¡æŠŠæ¶ˆè´¹è€…åŠ å¤§åˆ°6ä¸ª</p>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">2: &#123;partition=2, offset=90, value=Sun Jul 22 07:29:44 UTC 2018,kafka.apache.org,192.168.14.148&#125;</span><br><span class="line">0: &#123;partition=0, offset=87, value=Sun Jul 22 07:29:46 UTC 2018,kafka.apache.org,192.168.14.18&#125;</span><br><span class="line">1: &#123;partition=1, offset=86, value=Sun Jul 22 07:29:48 UTC 2018,kafka.apache.org,192.168.14.77&#125;</span><br><span class="line">0: &#123;partition=0, offset=88, value=Sun Jul 22 07:29:50 UTC 2018,kafka.apache.org,192.168.14.21&#125;</span><br><span class="line">2: &#123;partition=2, offset=91, value=Sun Jul 22 07:29:52 UTC 2018,kafka.apache.org,192.168.14.116&#125;</span><br><span class="line">2: &#123;partition=2, offset=92, value=Sun Jul 22 07:29:54 UTC 2018,kafka.apache.org,192.168.14.92&#125;</span><br><span class="line">0: &#123;partition=0, offset=89, value=Sun Jul 22 07:29:56 UTC 2018,kafka.apache.org,192.168.14.241&#125;</span><br><span class="line">1: &#123;partition=1, offset=87, value=Sun Jul 22 07:29:58 UTC 2018,kafka.apache.org,192.168.14.207&#125;</span><br><span class="line">3: &#123;partition=3, offset=112, value=Sun Jul 22 07:30:00 UTC 2018,kafka.apache.org,192.168.14.100&#125;</span><br><span class="line">1: &#123;partition=1, offset=88, value=Sun Jul 22 07:30:02 UTC 2018,kafka.apache.org,192.168.14.77&#125;</span><br><span class="line">1: &#123;partition=1, offset=89, value=Sun Jul 22 07:30:04 UTC 2018,kafka.apache.org,192.168.14.141&#125;</span><br><span class="line">3: &#123;partition=3, offset=113, value=Sun Jul 22 07:30:06 UTC 2018,kafka.apache.org,192.168.14.36&#125;</span><br><span class="line">2: &#123;partition=2, offset=93, value=Sun Jul 22 07:30:08 UTC 2018,kafka.apache.org,192.168.14.216&#125;</span><br><span class="line">3: &#123;partition=3, offset=114, value=Sun Jul 22 07:30:10 UTC 2018,kafka.apache.org,192.168.14.205&#125;</span><br><span class="line">2: &#123;partition=2, offset=94, value=Sun Jul 22 07:30:12 UTC 2018,kafka.apache.org,192.168.14.238&#125;</span><br><span class="line">3: &#123;partition=3, offset=115, value=Sun Jul 22 07:30:14 UTC 2018,kafka.apache.org,192.168.14.118&#125;</span><br><span class="line">2: &#123;partition=2, offset=95, value=Sun Jul 22 07:30:16 UTC 2018,kafka.apache.org,192.168.14.97&#125;</span><br><span class="line">0: &#123;partition=0, offset=90, value=Sun Jul 22 07:30:18 UTC 2018,kafka.apache.org,192.168.14.169&#125;</span><br><span class="line">2: &#123;partition=2, offset=96, value=Sun Jul 22 07:30:20 UTC 2018,kafka.apache.org,192.168.14.226&#125;</span><br><span class="line">3: &#123;partition=3, offset=116, value=Sun Jul 22 07:30:22 UTC 2018,kafka.apache.org,192.168.14.34&#125;</span><br><span class="line">3: &#123;partition=3, offset=117, value=Sun Jul 22 07:30:24 UTC 2018,kafka.apache.org,192.168.14.184&#125;</span><br><span class="line">1: &#123;partition=1, offset=90, value=Sun Jul 22 07:30:26 UTC 2018,kafka.apache.org,192.168.14.207&#125;</span><br><span class="line">2: &#123;partition=2, offset=97, value=Sun Jul 22 07:30:28 UTC 2018,kafka.apache.org,192.168.14.121&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶ï¼Œåªæ˜¯çœ‹åˆ°å››ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹å››ä¸ªåˆ†ç‰‡ï¼Œå…¶ä½™æ¶ˆè´¹è€…æ²¡æœ‰å‚ä¸åˆ°æ¶ˆè´¹ä¸­å»ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>kafkaæ˜¯ä¸€ä¸ªé«˜å¯ç”¨é«˜ååçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç»„ä»¶ï¼Œå¤šåˆ†ç‰‡å¯ä»¥æä¾›å¤šæ¶ˆè´¹è€…å¤šäº§ç”Ÿè€…çš„ååï¼Œå¤šä¸ªåˆ†ç»„å¯ä»¥æ»¡è¶³å¤šä¸ªåº”ç”¨å¯¹åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨è¦æ±‚è€Œäº’ä¸å¹²æ‰°ï¼ŒåŒä¸€åˆ†ç»„æ¶ˆè´¹è€…è¿˜èƒ½åŸºæœ¬ä¿è¯æ¶ˆæ¯åªæ¶ˆè´¹ä¸€æ¬¡ã€‚</p>
<p>å‚è€ƒ <a href="https://zhuanlan.zhihu.com/p/38269875" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/38269875</a></p>
<p>ä½¿ç”¨çš„å®ä¾‹å¯åˆ°è¿™ä¸ª<a href="https://github.com/ejunjsh/java-code" target="_blank" rel="noopener">é“¾æ¥</a>è·å–ï¼Œè¿˜æä¾›<code>docker</code>è¿è¡Œç¯å¢ƒå“¦ </p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç©äº†å¾ˆä¹…çš„kafkaï¼Œç°åœ¨æ€»ç»“ä¸‹å§ï¼Œå½“ç„¶é€šè¿‡åˆ«äººçš„æ–‡ç« æ¥æ€»ç»“è¿˜æ˜¯äº‹åŠåŠŸå€çš„ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ¶æ„å›¾&quot;&gt;&lt;a href=&quot;#æ¶æ„å›¾&quot; class=&quot;headerlink&quot; title=&quot;æ¶æ„å›¾&quot;&gt;&lt;/a&gt;æ¶æ„å›¾&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;http://idiotsky.top/images3/kafka-1.jpg&quot;&gt;&lt;img src=&quot;http://idiotsky.top/images3/kafka-1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å¦‚ä¸Šå›¾ï¼Œä¸€ä¸ªkafkaæ¶æ„åŒ…æ‹¬è‹¥å¹²ä¸ªProducerï¼ˆæœåŠ¡å™¨æ—¥å¿—ã€ä¸šåŠ¡æ•°æ®ã€webå‰ç«¯äº§ç”Ÿçš„page viewç­‰ï¼‰ï¼Œè‹¥å¹²ä¸ªBrokerï¼ˆkafkaæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œä¸€èˆ¬brokeræ•°é‡è¶Šå¤šé›†ç¾¤çš„ååé‡è¶Šå¤§ï¼‰ï¼Œè‹¥å¹²ä¸ªconsumer groupï¼Œä¸€ä¸ªZookeeperé›†ç¾¤ï¼ˆkafkaé€šè¿‡Zookeeperç®¡ç†é›†ç¾¤é…ç½®ã€é€‰ä¸¾leaderã€consumer groupå‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œrebalanceï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.top/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.top/tags/java/"/>
    
      <category term="kafka" scheme="http://idiotsky.top/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨javapçœ‹ä¸€ä¸‹finalæ˜¯ä»€ä¹ˆ</title>
    <link href="http://idiotsky.top/2018/07/17/java-javap-final/"/>
    <id>http://idiotsky.top/2018/07/17/java-javap-final/</id>
    <published>2018-07-17T14:23:29.000Z</published>
    <updated>2018-07-22T05:12:32.952Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ä¸€ç›´å¾ˆå¥½å¥‡<code>final</code>çš„ç±»å­—æ®µåœ¨classæ–‡ä»¶æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„ï¼Œæ‰€ä»¥ç”¨javapçœ‹çœ‹æ€ä¹ˆå›äº‹,ä¹Ÿé¡ºä¾¿å¤ä¹ ä¸‹å­—èŠ‚ç æŒ‡ä»¤ğŸ‘¿</p>
</blockquote>
<h1 id="æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ"><a href="#æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ" class="headerlink" title="æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ"></a>æ²¡æœ‰<code>final</code>ä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ</h1><p>å®šä¹‰ä¸€ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> String str=<span class="string">"ä¸¥"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>ç¼–è¯‘æŸ¥çœ‹classæ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">javac test.java</span><br><span class="line">javap -verbose test.class</span><br><span class="line"></span><br><span class="line">//çœç•¥å¸¸é‡æ± </span><br><span class="line">&#123;</span><br><span class="line">  public static java.lang.String str;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: getstatic     #3                  // Field str:Ljava/lang/String;</span><br><span class="line">         6: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 9</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=0, args_size=0</span><br><span class="line">         0: ldc           #5                  // String ä¸¥</span><br><span class="line">         2: putstatic     #3                  // Field str:Ljava/lang/String;</span><br><span class="line">         5: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 2: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°<code>public static String str=&quot;ä¸¥&quot;;</code>ç›´æ¥ç¿»è¯‘æˆä¸€ä¸ªé™æ€å—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static &#123;&#125;;</span><br><span class="line">  flags: ACC_STATIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=1, locals=0, args_size=0</span><br><span class="line">       0: ldc           #5                  // String ä¸¥</span><br><span class="line">       2: putstatic     #3                  // Field str:Ljava/lang/String;</span><br><span class="line">       5: return</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line 2: 0</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢<code>ldc</code>çš„æŒ‡ä»¤å°±æ˜¯æŠŠå¸¸é‡ä»å¸¸é‡æ± è¯»åˆ°æ“ä½œæ•°æ ˆï¼Œ<code>putstatic</code>æŒ‡ä»¤ä»æ ˆé¡¶èµ‹å€¼ç»™ç±»çš„é™æ€å­—æ®µ<code>str</code>,è¿™ä¸ªå­—æ®µä¹‹ååœ¨<code>main</code>å‡½æ•°ä¼šè¯»å‡ºæ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">  flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=2, locals=1, args_size=1</span><br><span class="line">       0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">       3: getstatic     #3                  // Field str:Ljava/lang/String;</span><br><span class="line">       6: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">       9: return</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line 5: 0</span><br><span class="line">      line 6: 9</span><br></pre></td></tr></table></figure>
<p><code>getstatic</code>æ˜¯ç”¨æ¥è¯»å–ç±»çš„é™æ€å­—æ®µçš„ï¼Œè¿™é‡Œè¯»å‡ºæ¥æ”¾å…¥æ“ä½œæ•°æ ˆã€‚</p>
<h1 id="æœ‰finalä¿®é¥°çš„ç±»é™æ€å­—æ®µ"><a href="#æœ‰finalä¿®é¥°çš„ç±»é™æ€å­—æ®µ" class="headerlink" title="æœ‰finalä¿®é¥°çš„ç±»é™æ€å­—æ®µ"></a>æœ‰<code>final</code>ä¿®é¥°çš„ç±»é™æ€å­—æ®µ</h1><p>æ”¹ä¸€ä¸‹è¿™ä¸ªç±»ï¼ŒåŠ <code>final</code>ä¿®é¥°ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String str=<span class="string">"ä¸¥"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘æŸ¥çœ‹classæ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">javac test.java</span><br><span class="line">javap -verbose test.class</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> çœç•¥å¸¸é‡æ± </span></span><br><span class="line">&#123;</span><br><span class="line">  public static final java.lang.String str;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line">    ConstantValue: String ä¸¥</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: ldc           #3                  // String ä¸¥</span><br><span class="line">         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">         8: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 8</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°classæ–‡ä»¶æ²¡æœ‰ä¹‹å‰çš„é™æ€å—äº†ï¼Œè€Œä¸”ä¹Ÿä¸å†ç”¨<code>getstatic</code>æŒ‡ä»¤è·å–å­—æ®µçš„å€¼ï¼Œè€Œæ˜¯ç›´æ¥<code>ldc</code>æŒ‡ä»¤å–å¸¸é‡æ± çš„å€¼ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹å®ä¾‹å­—æ®µåœ¨åŠ <code>final</code>æˆ–ä¸åŠ ä¼šä¸ä¼šæœ‰ä»€ä¹ˆä¸åŒå‘¢</p>
<h1 id="ä¸åŠ finalçš„å®ä¾‹å­—æ®µ"><a href="#ä¸åŠ finalçš„å®ä¾‹å­—æ®µ" class="headerlink" title="ä¸åŠ finalçš„å®ä¾‹å­—æ®µ"></a>ä¸åŠ finalçš„å®ä¾‹å­—æ®µ</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span>  String str=<span class="string">"ä¸¥"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        test t=<span class="keyword">new</span> test();</span><br><span class="line">        System.out.println(t.str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//çœç•¥æ²¡ç”¨çš„äº†ã€‚ã€‚ã€‚</span><br><span class="line">&#123;</span><br><span class="line">  public java.lang.String str;</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: ldc           #2                  // String ä¸¥</span><br><span class="line">         7: putfield      #3                  // Field str:Ljava/lang/String;</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line">        line 2: 4</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=2, args_size=1</span><br><span class="line">         0: new           #4                  // class test</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #5                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         7: astore_1</span><br><span class="line">         8: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        11: aload_1</span><br><span class="line">        12: getfield      #3                  // Field str:Ljava/lang/String;</span><br><span class="line">        15: invokevirtual #7                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">        18: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 8</span><br><span class="line">        line 7: 18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ å‡½æ•°é‡Œé¢ç”¨<code>ldc</code>åˆå§‹åŒ–äº†å®ä¾‹å­—æ®µ<code>str</code>çš„å€¼,ç„¶ååœ¨mainå‡½æ•°é‡Œé¢ç”¨<code>getfield</code>æŒ‡ä»¤ï¼Œè·å–<code>t</code>å®ä¾‹çš„<code>str</code>çš„å€¼ã€‚</p>
<h1 id="åŠ finalçš„å®ä¾‹å­—æ®µ"><a href="#åŠ finalçš„å®ä¾‹å­—æ®µ" class="headerlink" title="åŠ finalçš„å®ä¾‹å­—æ®µ"></a>åŠ <code>final</code>çš„å®ä¾‹å­—æ®µ</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> String str=<span class="string">"ä¸¥"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        test t=<span class="keyword">new</span> test();</span><br><span class="line">        System.out.println(t.str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">//çœç•¥æ²¡ç”¨çš„äº†ã€‚ã€‚ã€‚</span><br><span class="line">&#123;</span><br><span class="line">  public final java.lang.String str;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_FINAL</span><br><span class="line">    ConstantValue: String ä¸¥</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: ldc           #2                  // String ä¸¥</span><br><span class="line">         7: putfield      #3                  // Field str:Ljava/lang/String;</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line">        line 2: 4</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=2, args_size=1</span><br><span class="line">         0: new           #4                  // class test</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #5                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         7: astore_1</span><br><span class="line">         8: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        11: aload_1</span><br><span class="line">        12: invokevirtual #7                  // Method java/lang/Object.getClass:()Ljava/lang/Class;</span><br><span class="line">        15: pop</span><br><span class="line">        16: ldc           #2                  // String ä¸¥</span><br><span class="line">        18: invokevirtual #8                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">        21: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 8</span><br><span class="line">        line 7: 21</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getfield</code>æŒ‡ä»¤å˜æˆäº†ç†Ÿæ‚‰çš„<code>ldc</code>,å¾ˆæ˜æ˜¾äº†ï¼ŒåŠ äº†<code>final</code>ä¹‹åå°±å»å¸¸é‡æ± å»æ‰¾ï¼Œå°±ä¸éœ€è¦ç”¨<code>getfield</code>æŒ‡ä»¤ã€‚</p>
<p>ä¸Šé¢çš„å­—æ®µæ˜¯å­—ç¬¦ä¸²ï¼Œé‚£æ¥ä¸‹æ¥çœ‹çœ‹æ•°å­—çš„å­—æ®µä¼šæ€ä¹ˆæ ·å‘¢</p>
<h1 id="æ•°å­—çš„éfinalé™æ€å­—æ®µ"><a href="#æ•°å­—çš„éfinalé™æ€å­—æ®µ" class="headerlink" title="æ•°å­—çš„éfinalé™æ€å­—æ®µ"></a>æ•°å­—çš„é<code>final</code>é™æ€å­—æ®µ</h1><p>ä¸Šä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> i=<span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>javapç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//çœç•¥å¸¸é‡æ± </span><br><span class="line">&#123;</span><br><span class="line">  public static int i;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: getstatic     #3                  // Field i:I</span><br><span class="line">         6: invokevirtual #4                  // Method java/io/PrintStream.println:(I)V</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 6: 0</span><br><span class="line">        line 7: 9</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=0, args_size=0</span><br><span class="line">         0: bipush        100</span><br><span class="line">         2: putstatic     #3                  // Field i:I</span><br><span class="line">         5: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 3: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸºæœ¬å·®ä¸å¤šï¼Œåªæ˜¯<code>ldc</code>æ¢æˆäº†<code>bipush</code>ã€‚<code>bipush</code>å°±æ˜¯æŠŠåé¢çš„æ“ä½œæ•°ï¼ˆ100ï¼‰å‹å…¥æ ˆã€‚å¦‚æœå‹å…¥çš„ä¸æ˜¯100ï¼Œè€Œæ˜¯æ›´å¤§æˆ–æ›´å°ï¼Œé‚£ä¹ˆç”¨çš„æŒ‡ä»¤å°±ä¼šä¸åŒçš„äº†ï¼Œä¾‹å¦‚<code>iconst_1</code>æŒ‡ä»¤ï¼Œå°±æ˜¯å‹å…¥1åˆ°æ ˆã€‚è‡³äºmainå‡½æ•°é‡Œé¢ï¼Œè¿˜æ˜¯ç”¨<code>getstatic</code>æŒ‡ä»¤è·å–å­—æ®µçš„å€¼ã€‚</p>
<h1 id="æ•°å­—çš„finalé™æ€å­—æ®µ"><a href="#æ•°å­—çš„finalé™æ€å­—æ®µ" class="headerlink" title="æ•°å­—çš„finalé™æ€å­—æ®µ"></a>æ•°å­—çš„<code>final</code>é™æ€å­—æ®µ</h1><p>ä¸Šä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> i=<span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>javapç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  public static final int i;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line">    ConstantValue: int 100</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: bipush        100</span><br><span class="line">         5: invokevirtual #3                  // Method java/io/PrintStream.println:(I)V</span><br><span class="line">         8: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 6: 0</span><br><span class="line">        line 7: 8</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ²¡å•¥æƒŠå–œçš„ï¼Œå°±æ˜¯é™æ€å—å»æ‰ï¼Œéœ€è¦è·å–å­—æ®µçš„å€¼çš„åœ°æ–¹ä»<code>getstatic</code>å˜æˆäº†<code>bipush</code>ã€‚</p>
<p>è‡³äºå®ä¾‹å­—æ®µæ˜¯æ€ä¹ˆæ ·çš„ï¼Œåº”è¯¥éƒ½å·®ä¸å¤šäº†ï¼Œå°±ä¸åˆ—ä¸¾äº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å­—æ®µç±»å‹æ˜¯å¼•ç”¨çš„æ˜¯æ€ä¹ˆæ ·å‘¢ã€‚</p>
<h1 id="åŠ finalçš„å¼•ç”¨ç±»å‹å­—æ®µ"><a href="#åŠ finalçš„å¼•ç”¨ç±»å‹å­—æ®µ" class="headerlink" title="åŠ finalçš„å¼•ç”¨ç±»å‹å­—æ®µ"></a>åŠ <code>final</code>çš„å¼•ç”¨ç±»å‹å­—æ®µ</h1><p>ä¸Šä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Object o=<span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(o);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>javapç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  public static final java.lang.Object o;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: getstatic     #3                  // Field o:Ljava/lang/Object;</span><br><span class="line">         6: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/Object;)V</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 6: 0</span><br><span class="line">        line 7: 9</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=0, args_size=0</span><br><span class="line">         0: new           #5                  // class java/lang/Object</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         7: putstatic     #3                  // Field o:Ljava/lang/Object;</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 3: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç›´æ¥ä¸Š<code>final</code>çš„ç‰ˆæœ¬ï¼Œæ˜¯å› ä¸ºåŠ ä¸åŠ <code>final</code>ï¼Œå…¶å®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯æœ‰é™æ€å—ï¼Œå¼•ç”¨çš„æ—¶å€™ä¸å†æœ‰ä»€ä¹ˆå…¶ä»–æŒ‡ä»¤äº†ï¼Œè€è€å®å®çš„ç”¨<code>getstatic</code>ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¯¹äºå­—ç¬¦ä¸²æˆ–è€…æ•°å­—ç±»å‹ï¼Œä»–ä»¬éƒ½æ˜¯å±äºå­—é¢é‡ï¼Œç¼–è¯‘æ—¶å·²ç»çŸ¥é“ï¼Œä»–ä»¬è¦ä¹ˆå­˜åœ¨å¸¸é‡æ± é‡Œé¢ï¼Œè¦ä¹ˆå­˜åœ¨æŒ‡ä»¤çš„æ“ä½œæ•°é‡Œé¢ï¼Œæ‰€ä»¥åŠ <code>final</code>æ ‡è¯†çš„æƒ…å†µä¸‹ï¼Œè·å–å€¼æ—¶ä¸ç”¨å†åˆ°å…³è”çš„å¯¹è±¡åº•ä¸‹å»è·å–äº†ï¼Œå› ä¸º<code>final</code>å°±æ˜¯ä¸å˜ï¼Œç›´æ¥è°ƒç”¨ç›¸å…³æŒ‡ä»¤å»å¸¸é‡æ± ï¼Œæˆ–è€…ç›´æ¥æ“ä½œæ•°å–å°±å¥½ã€‚</p>
<p>å¯¹äºå¼•ç”¨ç±»å‹ï¼Œè¿™ä¸ªåŸºæœ¬è¦åˆ°è¿è¡Œæ—¶æ‰èƒ½ç¡®è®¤ä»–ä»¬çš„å¼•ç”¨åœ°å€ï¼Œæ‰€ä»¥åŠ ä¸åŠ <code>final</code>éƒ½æ˜¯ä¸€æ ·ã€‚</p>
<p>çœ‹æ¥å­—èŠ‚ç æ‰æ˜¯æœ€èƒ½ç¡®å®šjavaæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œæ‰€ä»¥ä¸å…¶æ‰¾ç½‘ä¸Šçš„è¯´æ³•ä¸å¦‚<code>javap</code>ä¸€ä¸‹çœ‹çœ‹ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸€ç›´å¾ˆå¥½å¥‡&lt;code&gt;final&lt;/code&gt;çš„ç±»å­—æ®µåœ¨classæ–‡ä»¶æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„ï¼Œæ‰€ä»¥ç”¨javapçœ‹çœ‹æ€ä¹ˆå›äº‹,ä¹Ÿé¡ºä¾¿å¤ä¹ ä¸‹å­—èŠ‚ç æŒ‡ä»¤ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ&quot;&gt;&lt;a href=&quot;#æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ&quot; class=&quot;headerlink&quot; title=&quot;æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ&quot;&gt;&lt;/a&gt;æ²¡æœ‰&lt;code&gt;final&lt;/code&gt;ä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ&lt;/h1&gt;&lt;p&gt;å®šä¹‰ä¸€ä¸ªç±»&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String str=&lt;span class=&quot;string&quot;&gt;&quot;ä¸¥&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        System.out.println(str);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.top/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.top/tags/java/"/>
    
      <category term="javap" scheme="http://idiotsky.top/tags/javap/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°</title>
    <link href="http://idiotsky.top/2018/06/27/distributed-transaction/"/>
    <id>http://idiotsky.top/2018/06/27/distributed-transaction/</id>
    <published>2018-06-27T12:53:24.000Z</published>
    <updated>2018-07-26T01:29:54.426Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ğŸ‘¿markä¹‹</p>
</blockquote>
<p>åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¼ä¸šé›†æˆä¸­çš„ä¸€ä¸ªæŠ€æœ¯éš¾ç‚¹ï¼Œä¹Ÿæ˜¯æ¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸­éƒ½ä¼šæ¶‰åŠåˆ°çš„ä¸€ä¸ªä¸œè¥¿ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿™å‡ å¹´è¶Šæ¥è¶Šç«çš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå‡ ä¹å¯ä»¥è¯´æ˜¯æ— æ³•é¿å…ï¼Œæœ¬æ–‡å°±å›´ç»•åˆ†å¸ƒå¼äº‹åŠ¡å„æ–¹é¢ä¸å¤§å®¶è¿›è¡Œä»‹ç»ã€‚</p>
<h1 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h1><h2 id="ä»€ä¹ˆæ˜¯äº‹åŠ¡"><a href="#ä»€ä¹ˆæ˜¯äº‹åŠ¡" class="headerlink" title="ä»€ä¹ˆæ˜¯äº‹åŠ¡"></a>ä»€ä¹ˆæ˜¯äº‹åŠ¡</h2><p>æ•°æ®åº“äº‹åŠ¡ï¼ˆç®€ç§°ï¼šäº‹åŠ¡ï¼ŒTransactionï¼‰æ˜¯æŒ‡æ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œç”±ä¸€ä¸ªæœ‰é™çš„æ•°æ®åº“æ“ä½œåºåˆ—æ„æˆã€‚</p>
<p>äº‹åŠ¡æ‹¥æœ‰ä»¥ä¸‹å››ä¸ªç‰¹æ€§ï¼Œä¹ æƒ¯ä¸Šè¢«ç§°ä¸ºACIDç‰¹æ€§ï¼š</p>
<ol>
<li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«æ‰§è¡Œï¼ŒåŒ…å«åœ¨å…¶ä¸­çš„å¯¹æ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚</li>
<li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡åº”ç¡®ä¿æ•°æ®åº“çš„çŠ¶æ€ä»ä¸€ä¸ªä¸€è‡´çŠ¶æ€è½¬å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚ä¸€è‡´çŠ¶æ€æ˜¯æŒ‡æ•°æ®åº“ä¸­çš„æ•°æ®åº”æ»¡è¶³å®Œæ•´æ€§çº¦æŸã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸€è‡´æ€§è¿˜æœ‰å¦å¤–ä¸€å±‚è¯­ä¹‰ï¼Œå°±æ˜¯äº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ä¸èƒ½è¢«è§‚å¯Ÿåˆ°ï¼ˆè¿™å±‚è¯­ä¹‰ä¹Ÿæœ‰è¯´åº”è¯¥å±äºåŸå­æ€§ï¼‰ã€‚</li>
<li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”å½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œï¼Œå¦‚åŒåªæœ‰è¿™ä¸€ä¸ªæ“ä½œåœ¨è¢«æ•°æ®åº“æ‰€æ‰§è¡Œä¸€æ ·ã€‚</li>
<li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šå·²è¢«æäº¤çš„äº‹åŠ¡å¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚åœ¨äº‹åŠ¡ç»“æŸæ—¶ï¼Œæ­¤æ“ä½œå°†ä¸å¯é€†è½¬ã€‚</li>
</ol>
<a id="more"></a>
<h2 id="æœ¬åœ°äº‹åŠ¡"><a href="#æœ¬åœ°äº‹åŠ¡" class="headerlink" title="æœ¬åœ°äº‹åŠ¡"></a>æœ¬åœ°äº‹åŠ¡</h2><p>èµ·åˆï¼Œäº‹åŠ¡ä»…é™äºå¯¹å•ä¸€æ•°æ®åº“èµ„æºçš„è®¿é—®æ§åˆ¶ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-1.jpg"><img src="http://idiotsky.top/images3/dt-1.jpg" alt=""></a></p>
<p>æ¶æ„æœåŠ¡åŒ–ä»¥åï¼Œäº‹åŠ¡çš„æ¦‚å¿µå»¶ä¼¸åˆ°äº†æœåŠ¡ä¸­ã€‚å€˜è‹¥å°†ä¸€ä¸ªå•ä¸€çš„æœåŠ¡æ“ä½œä½œä¸ºä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆæ•´ä¸ªæœåŠ¡æ“ä½œåªèƒ½æ¶‰åŠä¸€ä¸ªå•ä¸€çš„æ•°æ®åº“èµ„æºï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-2.jpg"><img src="http://idiotsky.top/images3/dt-2.jpg" alt=""></a></p>
<p>è¿™ç±»åŸºäºå•ä¸ªæœåŠ¡å•ä¸€æ•°æ®åº“èµ„æºè®¿é—®çš„äº‹åŠ¡ï¼Œè¢«ç§°ä¸ºæœ¬åœ°äº‹åŠ¡ï¼ˆLocal Transactionï¼‰ã€‚</p>
<h1 id="åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„"></a>åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„</h1><p>æœ¬åœ°äº‹åŠ¡ä¸»è¦é™åˆ¶åœ¨å•ä¸ªä¼šè¯å†…ï¼Œä¸æ¶‰åŠå¤šä¸ªæ•°æ®åº“èµ„æºã€‚ä½†æ˜¯åœ¨åŸºäºSOAï¼ˆService-Oriented Architectureï¼Œé¢å‘æœåŠ¡æ¶æ„ï¼‰çš„åˆ†å¸ƒå¼åº”ç”¨ç¯å¢ƒä¸‹ï¼Œè¶Šæ¥è¶Šå¤šçš„åº”ç”¨è¦æ±‚å¯¹å¤šä¸ªæ•°æ®åº“èµ„æºï¼Œå¤šä¸ªæœåŠ¡çš„è®¿é—®éƒ½èƒ½çº³å…¥åˆ°åŒä¸€ä¸ªäº‹åŠ¡å½“ä¸­ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡åº”è¿è€Œç”Ÿã€‚</p>
<p>æœ€æ—©çš„åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„å¾ˆç®€å•ï¼Œä¸æ¶‰åŠæœåŠ¡é—´çš„è®¿é—®è°ƒç”¨ï¼Œä»…ä»…æ˜¯æœåŠ¡å†…æ“ä½œæ¶‰åŠåˆ°å¯¹å¤šä¸ªæ•°æ®åº“èµ„æºçš„è®¿é—®ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-3.jpg"><img src="http://idiotsky.top/images3/dt-3.jpg" alt=""></a></p>
<p>å½“ä¸€ä¸ªæœåŠ¡æ“ä½œè®¿é—®ä¸åŒçš„æ•°æ®åº“èµ„æºï¼Œåˆå¸Œæœ›å¯¹å®ƒä»¬çš„è®¿é—®å…·æœ‰äº‹åŠ¡ç‰¹æ€§æ—¶ï¼Œå°±éœ€è¦é‡‡ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ¥åè°ƒæ‰€æœ‰çš„äº‹åŠ¡å‚ä¸è€…ã€‚</p>
<p>å¯¹äºä¸Šé¢ä»‹ç»çš„åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„ï¼Œå°½ç®¡ä¸€ä¸ªæœåŠ¡æ“ä½œä¼šè®¿é—®å¤šä¸ªæ•°æ®åº“èµ„æºï¼Œä½†æ˜¯æ¯•ç«Ÿæ•´ä¸ªäº‹åŠ¡è¿˜æ˜¯æ§åˆ¶åœ¨å•ä¸€æœåŠ¡çš„å†…éƒ¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡æ“ä½œéœ€è¦è°ƒç”¨å¦å¤–ä¸€ä¸ªæœåŠ¡ï¼Œè¿™æ—¶çš„äº‹åŠ¡å°±éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œèµ·å§‹äºæŸä¸ªæœåŠ¡çš„äº‹åŠ¡åœ¨è°ƒç”¨å¦å¤–ä¸€ä¸ªæœåŠ¡çš„æ—¶å€™ï¼Œéœ€è¦ä»¥æŸç§æœºåˆ¶æµè½¬åˆ°å¦å¤–ä¸€ä¸ªæœåŠ¡ï¼Œä»è€Œä½¿è¢«è°ƒç”¨çš„æœåŠ¡è®¿é—®çš„èµ„æºä¹Ÿè‡ªåŠ¨åŠ å…¥åˆ°è¯¥äº‹åŠ¡å½“ä¸­æ¥ã€‚ä¸‹å›¾åæ˜ äº†è¿™æ ·ä¸€ä¸ªè·¨è¶Šå¤šä¸ªæœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-4.jpg"><img src="http://idiotsky.top/images3/dt-4.jpg" alt=""></a></p>
<p>å¦‚æœå°†ä¸Šé¢è¿™ä¸¤ç§åœºæ™¯ï¼ˆä¸€ä¸ªæœåŠ¡å¯ä»¥è°ƒç”¨å¤šä¸ªæ•°æ®åº“èµ„æºï¼Œä¹Ÿå¯ä»¥è°ƒç”¨å…¶ä»–æœåŠ¡ï¼‰ç»“åˆåœ¨ä¸€èµ·ï¼Œå¯¹æ­¤è¿›è¡Œå»¶ä¼¸ï¼Œæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„å‚ä¸è€…å°†ä¼šç»„æˆå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ ‘å½¢æ‹“æ‰‘ç»“æ„ã€‚åœ¨ä¸€ä¸ªè·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œäº‹åŠ¡çš„å‘èµ·è€…å’Œæäº¤å‡ç³»åŒä¸€ä¸ªï¼Œå®ƒå¯ä»¥æ˜¯æ•´ä¸ªè°ƒç”¨çš„å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯å®¢æˆ·ç«¯æœ€å…ˆè°ƒç”¨çš„é‚£ä¸ªæœåŠ¡ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-5.jpg"><img src="http://idiotsky.top/images3/dt-5.jpg" alt=""></a></p>
<p>è¾ƒä¹‹åŸºäºå•ä¸€æ•°æ®åº“èµ„æºè®¿é—®çš„æœ¬åœ°äº‹åŠ¡ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„åº”ç”¨æ¶æ„æ›´ä¸ºå¤æ‚ã€‚åœ¨ä¸åŒçš„åˆ†å¸ƒå¼åº”ç”¨æ¶æ„ä¸‹ï¼Œå®ç°ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡è¦è€ƒè™‘çš„é—®é¢˜å¹¶ä¸å®Œå…¨ä¸€æ ·ï¼Œæ¯”å¦‚å¯¹å¤šèµ„æºçš„åè°ƒã€äº‹åŠ¡çš„è·¨æœåŠ¡ä¼ æ’­ç­‰ï¼Œå®ç°æœºåˆ¶ä¹Ÿæ˜¯å¤æ‚å¤šå˜ã€‚å°½ç®¡æœ‰è¿™ä¹ˆå¤šå·¥ç¨‹ç»†èŠ‚éœ€è¦è€ƒè™‘ï¼Œä½†åˆ†å¸ƒå¼äº‹åŠ¡æœ€æ ¸å¿ƒçš„è¿˜æ˜¯å…¶ ACID ç‰¹æ€§ã€‚å› æ­¤ï¼Œæƒ³è¦äº†è§£ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå°±å…ˆä»äº†è§£å®ƒæ˜¯æ€ä¹ˆå®ç°äº‹åŠ¡ ACID ç‰¹æ€§å¼€å§‹ã€‚</p>
<p>ä¸‹æ–‡å°†ä»ä¸¤ä¸ªæœ€å¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹å…¥æ‰‹ï¼Œç€é‡åˆ†æåˆ†å¸ƒå¼äº‹åŠ¡çš„åŸºç¡€å…±é€šç‚¹ï¼Œå³å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ ACID ç‰¹æ€§ã€‚</p>
<h1 id="å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹-ACID-å®ç°åˆ†æ"><a href="#å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹-ACID-å®ç°åˆ†æ" class="headerlink" title="å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ ACID å®ç°åˆ†æ"></a>å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ ACID å®ç°åˆ†æ</h1><h2 id="X-Open-XA-åè®®"><a href="#X-Open-XA-åè®®" class="headerlink" title="X/Open XA åè®®"></a>X/Open XA åè®®</h2><p>æœ€æ—©çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹æ˜¯ X/Open å›½é™…è”ç›Ÿæå‡ºçš„ X/Open Distributed Transaction Processingï¼ˆDTPï¼‰æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶å¸¸è¯´çš„ X/Open XA åè®®ï¼Œç®€ç§°XA åè®®ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-6.jpg"><img src="http://idiotsky.top/images3/dt-6.jpg" alt=""></a></p>
<p>DTP æ¨¡å‹ä¸­åŒ…å«ä¸€ä¸ªå…¨å±€äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTMï¼ŒTransaction Managerï¼‰å’Œå¤šä¸ªèµ„æºç®¡ç†å™¨ï¼ˆRMï¼ŒResource Managerï¼‰ã€‚å…¨å±€äº‹åŠ¡ç®¡ç†å™¨è´Ÿè´£ç®¡ç†å…¨å±€äº‹åŠ¡çŠ¶æ€ä¸å‚ä¸çš„èµ„æºï¼ŒååŒèµ„æºä¸€èµ·æäº¤æˆ–å›æ»šï¼›èµ„æºç®¡ç†å™¨åˆ™è´Ÿè´£å…·ä½“çš„èµ„æºæ“ä½œã€‚</p>
<p>XA åè®®æè¿°äº† TM ä¸ RM ä¹‹é—´çš„æ¥å£ï¼Œå…è®¸å¤šä¸ªèµ„æºåœ¨åŒä¸€åˆ†å¸ƒå¼äº‹åŠ¡ä¸­è®¿é—®ã€‚</p>
<p>åŸºäº DTP æ¨¡å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-7.jpg"><img src="http://idiotsky.top/images3/dt-7.jpg" alt=""></a></p>
<ol>
<li>åº”ç”¨ç¨‹åºï¼ˆAPï¼ŒApplicationï¼‰å‘ TM ç”³è¯·å¼€å§‹ä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚</li>
<li>é’ˆå¯¹è¦æ“ä½œçš„ RMï¼ŒAP ä¼šå…ˆå‘ TM æ³¨å†Œï¼ˆTM è´Ÿè´£è®°å½• AP æ“ä½œè¿‡å“ªäº› RMï¼Œå³åˆ†æ”¯äº‹åŠ¡ï¼‰ï¼ŒTM é€šè¿‡ XA æ¥å£å‡½æ•°é€šçŸ¥ç›¸åº” RM å¼€å¯åˆ†å¸ƒå¼äº‹åŠ¡çš„å­äº‹åŠ¡ï¼Œæ¥ç€ AP å°±å¯ä»¥å¯¹è¯¥ RM ç®¡ç†çš„èµ„æºè¿›è¡Œæ“ä½œã€‚</li>
<li>å½“ AP å¯¹æ‰€æœ‰ RM æ“ä½œå®Œæ¯•åï¼ŒAP æ ¹æ®æ‰§è¡Œæƒ…å†µé€šçŸ¥ TM æäº¤æˆ–å›æ»šè¯¥å…¨å±€äº‹åŠ¡ï¼ŒTM é€šè¿‡ XA æ¥å£å‡½æ•°é€šçŸ¥å„ RM å®Œæˆæ“ä½œã€‚TM ä¼šå…ˆè¦æ±‚å„ä¸ª RM åšé¢„æäº¤ï¼Œæ‰€æœ‰ RM è¿”å›æˆåŠŸåï¼Œå†è¦æ±‚å„ RM åšæ­£å¼æäº¤ï¼ŒXA åè®®è¦æ±‚ï¼Œä¸€æ—¦ RM é¢„æäº¤æˆåŠŸï¼Œåˆ™åç»­çš„æ­£å¼æäº¤ä¹Ÿå¿…é¡»èƒ½æˆåŠŸï¼›å¦‚æœä»»æ„ä¸€ä¸ª RM é¢„æäº¤å¤±è´¥ï¼Œåˆ™ TM é€šçŸ¥å„ RM å›æ»šã€‚</li>
<li>æ‰€æœ‰ RM æäº¤æˆ–å›æ»šå®Œæˆåï¼Œå…¨å±€äº‹åŠ¡ç»“æŸã€‚</li>
</ol>
<h3 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h3><p>XA åè®®ä½¿ç”¨ 2PCï¼ˆTwo Phase Commitï¼Œä¸¤é˜¶æ®µæäº¤ï¼‰åŸå­æäº¤åè®®æ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡åŸå­æ€§ã€‚</p>
<p>ä¸¤é˜¶æ®µæäº¤æ˜¯æŒ‡å°†æäº¤è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå³å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰å’Œæäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-8.jpg"><img src="http://idiotsky.top/images3/dt-8.jpg" alt=""></a></p>
<p>å‡†å¤‡é˜¶æ®µï¼š</p>
<p>TM å‘æ¯ä¸ª RM å‘é€å‡†å¤‡æ¶ˆæ¯ã€‚å¦‚æœ RM çš„æœ¬åœ°äº‹åŠ¡æ“ä½œæ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›æˆåŠŸï¼›å¦‚æœ RM çš„æœ¬åœ°äº‹åŠ¡æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œåˆ™è¿”å›å¤±è´¥ã€‚</p>
<p>æäº¤é˜¶æ®µ</p>
<p>å¦‚æœ TM æ”¶åˆ°äº†æ‰€æœ‰ RM å›å¤çš„æˆåŠŸæ¶ˆæ¯ï¼Œåˆ™å‘æ¯ä¸ª RM å‘é€æäº¤æ¶ˆæ¯ï¼›å¦åˆ™å‘é€å›æ»šæ¶ˆæ¯ï¼›RM æ ¹æ® TM çš„æŒ‡ä»¤æ‰§è¡Œæäº¤æˆ–è€…å›æ»šæœ¬åœ°äº‹åŠ¡æ“ä½œï¼Œé‡Šæ”¾æ‰€æœ‰äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨çš„é”èµ„æºã€‚</p>
<h3 id="éš”ç¦»æ€§"><a href="#éš”ç¦»æ€§" class="headerlink" title="éš”ç¦»æ€§"></a>éš”ç¦»æ€§</h3><p>XA åè®®ä¸­æ²¡æœ‰æè¿°å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œä½†æ˜¯ XA åè®®è¦æ±‚DTP æ¨¡å‹ä¸­çš„æ¯ä¸ª RM éƒ½è¦å®ç°æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŸºäº XA åè®®å®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯ç”±æ¯ä¸ª RM æœ¬åœ°äº‹åŠ¡çš„éš”ç¦»æ€§æ¥ä¿è¯çš„ï¼Œå½“ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰€æœ‰å­äº‹åŠ¡éƒ½æ˜¯éš”ç¦»çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å¤©ç„¶çš„å°±å®ç°äº†éš”ç¦»æ€§ã€‚</p>
<p>ä»¥ MySQL æ¥ä¸¾ä¾‹ï¼ŒMySQL ä½¿ç”¨ 2PLï¼ˆTwo-Phase Lockingï¼Œä¸¤é˜¶æ®µé”ï¼‰æœºåˆ¶æ¥æ§åˆ¶æœ¬åœ°äº‹åŠ¡çš„å¹¶å‘ï¼Œä¿è¯éš”ç¦»æ€§ã€‚2PL ä¸ 2PC ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å°†é”æ“ä½œåˆ†ä¸ºåŠ é”å’Œè§£é”ä¸¤ä¸ªé˜¶æ®µï¼Œå¹¶ä¸”ä¿è¯ä¸¤ä¸ªé˜¶æ®µå®Œå…¨ä¸ç›¸äº¤ã€‚åŠ é”é˜¶æ®µï¼ŒåªåŠ é”ï¼Œä¸æ”¾é”ã€‚è§£é”é˜¶æ®µï¼Œåªæ”¾é”ï¼Œä¸åŠ é”ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-9.jpg"><img src="http://idiotsky.top/images3/dt-9.jpg" alt=""></a></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ï¼Œæ¯æ‰§è¡Œä¸€æ¡æ›´æ–°æ“ä½œä¹‹å‰ï¼Œéƒ½ä¼šå…ˆè·å–å¯¹åº”çš„é”èµ„æºï¼Œåªæœ‰è·å–é”èµ„æºæˆåŠŸæ‰ä¼šæ‰§è¡Œè¯¥æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦è·å–äº†é”èµ„æºå°±ä¼šæŒæœ‰è¯¥é”èµ„æºç›´åˆ°æœ¬äº‹åŠ¡æ‰§è¡Œç»“æŸã€‚</p>
<p>MySQL é€šè¿‡è¿™ç§ 2PL æœºåˆ¶ï¼Œå¯ä»¥ä¿è¯åœ¨æœ¬åœ°äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½æ“ä½œç›¸åŒèµ„æºï¼Œä»è€Œå®ç°äº†äº‹åŠ¡éš”ç¦»ã€‚</p>
<h3 id="ä¸€è‡´æ€§"><a href="#ä¸€è‡´æ€§" class="headerlink" title="ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h3><p>å‰é¢æåˆ°ä¸€è‡´æ€§æœ‰ä¸¤å±‚è¯­ä¹‰ï¼Œä¸€å±‚æ˜¯ç¡®ä¿äº‹åŠ¡æ‰§è¡Œç»“æŸåï¼Œæ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´çŠ¶æ€è½¬å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚å¦ä¸€å±‚è¯­ä¹‰æ˜¯äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€ä¸èƒ½è¢«è§‚å¯Ÿåˆ°ã€‚</p>
<p>å‰ä¸€å±‚è¯­ä¹‰çš„å®ç°å¾ˆç®€å•ï¼Œé€šè¿‡åŸå­æ€§ã€éš”ç¦»æ€§ä»¥åŠ RM è‡ªèº«ä¸€è‡´æ€§çš„å®ç°å°±å¯ä»¥ä¿è¯ã€‚è‡³äºåä¸€å±‚è¯­ä¹‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å•ä¸ª RM ä¸Šçš„æœ¬åœ°äº‹åŠ¡æ˜¯æ€ä¹ˆå®ç°çš„ã€‚è¿˜æ˜¯ä»¥ MySQL ä¸¾ä¾‹ï¼ŒMySQL é€šè¿‡ MVCCï¼ˆMulti Version Concurrency Controlï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æœºåˆ¶ï¼Œä¸ºæ¯ä¸ªä¸€è‡´æ€§çŠ¶æ€ç”Ÿæˆå¿«ç…§ï¼ˆSnapshotï¼‰ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½æ˜¯å„Snapshotå¯¹åº”çš„ä¸€è‡´æ€§çŠ¶æ€ï¼Œä»è€Œä¹Ÿå°±ä¿è¯äº†æœ¬åœ°äº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ä¸ä¼šè¢«è§‚å¯Ÿåˆ°ã€‚</p>
<p>è™½ç„¶å•ä¸ª RM ä¸Šå®ç°äº†Snapshotï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼åº”ç”¨æ¶æ„ä¸‹ï¼Œä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<p><a href="http://idiotsky.top/images3/dt-10.jpg"><img src="http://idiotsky.top/images3/dt-10.jpg" alt=""></a></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ RM1 çš„æœ¬åœ°å­äº‹åŠ¡æäº¤å®Œæ¯•åˆ° RM2 çš„æœ¬åœ°å­äº‹åŠ¡æäº¤å®Œæ¯•ä¹‹é—´ï¼Œåªèƒ½è¯»åˆ° RM1 ä¸Šå­äº‹åŠ¡æ‰§è¡Œçš„å†…å®¹ï¼Œè¯»ä¸åˆ° RM2 ä¸Šçš„å­äº‹åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶åœ¨å•ä¸ª RM ä¸Šçš„æœ¬åœ°äº‹åŠ¡æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯ä»å…¨å±€æ¥çœ‹ï¼Œä¸€ä¸ªå…¨å±€äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹çš„ä¸­é—´çŠ¶æ€è¢«è§‚å¯Ÿåˆ°äº†ï¼Œå…¨å±€ä¸€è‡´æ€§å°±è¢«ç ´åäº†ã€‚</p>
<p>XA åè®®å¹¶æ²¡æœ‰å®šä¹‰æ€ä¹ˆå®ç°å…¨å±€çš„ Snapshotï¼Œåƒ MySQL å®˜æ–¹æ–‡æ¡£é‡Œå°±å»ºè®®ä½¿ç”¨ä¸²è¡ŒåŒ–çš„éš”ç¦»çº§åˆ«æ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ï¼š â€œAs with nondistributed transactions, SERIALIZABLE may be preferred if your applications are sensitive to read phenomena. REPEATABLE READ may not be sufficient for distributed transactions.â€ï¼ˆå¯¹äºåˆ†å¸ƒå¼äº‹åŠ¡æ¥è¯´ï¼Œå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸è¶³ä»¥ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ï¼Œå¦‚æœä½ çš„ç¨‹åºæœ‰å…¨å±€ä¸€è‡´æ€§è¯»è¦æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«.ï¼‰</p>
<p>å½“ç„¶ï¼Œç”±äºä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«çš„æ€§èƒ½è¾ƒå·®ï¼Œæ‰€ä»¥å¾ˆå¤šåˆ†å¸ƒå¼æ•°æ®åº“éƒ½è‡ªå·±å®ç°äº†åˆ†å¸ƒå¼ MVCC æœºåˆ¶æ¥æä¾›å…¨å±€çš„ä¸€è‡´æ€§è¯»ã€‚ä¸€ä¸ªåŸºæœ¬æ€è·¯æ˜¯ç”¨ä¸€ä¸ªé›†ä¸­å¼æˆ–è€…é€»è¾‘ä¸Šå•è°ƒé€’å¢çš„ä¸œè¥¿æ¥æ§åˆ¶ç”Ÿæˆå…¨å±€ Snapshotï¼Œæ¯ä¸ªäº‹åŠ¡æˆ–è€…æ¯æ¡ SQL æ‰§è¡Œæ—¶éƒ½å»è·å–ä¸€æ¬¡ï¼Œä»è€Œå®ç°ä¸åŒéš”ç¦»çº§åˆ«ä¸‹çš„ä¸€è‡´æ€§ã€‚æ¯”å¦‚ Google çš„ Spanner å°±æ˜¯ç”¨ TrueTime æ¥æ§åˆ¶è®¿é—®å…¨å±€ Snapshotã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>XA åè®®é€šå¸¸å®ç°åœ¨æ•°æ®åº“èµ„æºå±‚ï¼Œç›´æ¥ä½œç”¨äºèµ„æºç®¡ç†å™¨ä¸Šã€‚å› æ­¤ï¼ŒåŸºäº XA åè®®å®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡äº§å“ï¼Œæ— è®ºæ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œå¯¹ä¸šåŠ¡å‡ ä¹éƒ½æ²¡æœ‰ä¾µå…¥ï¼Œå°±åƒä½¿ç”¨æ™®é€šæ•°æ®åº“ä¸€æ ·ã€‚</p>
<p>XA åè®®ä¸¥æ ¼ä¿éšœäº‹åŠ¡ ACID ç‰¹æ€§ï¼Œèƒ½å¤Ÿæ»¡è¶³æ‰€æœ‰ä¸šåŠ¡é¢†åŸŸçš„åŠŸèƒ½éœ€æ±‚ï¼Œä½†æ˜¯ï¼Œè¿™åŒæ ·æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚</p>
<p>ç”±äºéš”ç¦»æ€§çš„äº’æ–¥è¦æ±‚ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰çš„èµ„æºéƒ½è¢«é”å®šï¼Œåªé€‚ç”¨äºæ‰§è¡Œæ—¶é—´ç¡®å®šçš„çŸ­äº‹åŠ¡ã€‚åŒæ—¶ï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´éƒ½æ˜¯ç‹¬å æ•°æ®ï¼Œå¯¹äºçƒ­ç‚¹æ•°æ®çš„å¹¶å‘æ€§èƒ½å¯èƒ½ä¼šå¾ˆä½ï¼Œå®ç°äº†åˆ†å¸ƒå¼ MVCC æˆ–ä¹è§‚é”ï¼ˆoptimistic lockingï¼‰ä»¥åï¼Œæ€§èƒ½å¯èƒ½ä¼šæœ‰æ‰€æå‡ã€‚</p>
<p>åŒæ—¶ï¼Œä¸ºäº†ä¿éšœä¸€è‡´æ€§ï¼Œè¦æ±‚æ‰€æœ‰ RM åŒç­‰å¯ä¿¡ã€å¯é ï¼Œè¦æ±‚æ•…éšœæ¢å¤æœºåˆ¶å¯é ã€å¿«é€Ÿï¼Œåœ¨ç½‘ç»œæ•…éšœéš”ç¦»çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡åŸºæœ¬ä¸å¯ç”¨ã€‚</p>
<h2 id="TCC-æ¨¡å‹"><a href="#TCC-æ¨¡å‹" class="headerlink" title="TCC æ¨¡å‹"></a>TCC æ¨¡å‹</h2><p>TCCï¼ˆTry-Confirm-Cancelï¼‰åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ç›¸å¯¹äº XA ç­‰ä¼ ç»Ÿæ¨¡å‹ï¼Œå…¶ç‰¹å¾åœ¨äºå®ƒä¸ä¾èµ–èµ„æºç®¡ç†å™¨ï¼ˆRMï¼‰å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æ”¯æŒï¼Œè€Œæ˜¯é€šè¿‡å¯¹ä¸šåŠ¡é€»è¾‘çš„åˆ†è§£æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<p>TCC æ¨¡å‹è®¤ä¸ºå¯¹äºä¸šåŠ¡ç³»ç»Ÿä¸­ä¸€ä¸ªç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘ï¼Œå…¶å¯¹å¤–æä¾›æœåŠ¡æ—¶ï¼Œå¿…é¡»æ¥å—ä¸€äº›ä¸ç¡®å®šæ€§ï¼Œå³å¯¹ä¸šåŠ¡é€»è¾‘åˆæ­¥æ“ä½œçš„è°ƒç”¨ä»…æ˜¯ä¸€ä¸ªä¸´æ—¶æ€§æ“ä½œï¼Œè°ƒç”¨å®ƒçš„ä¸»ä¸šåŠ¡æœåŠ¡ä¿ç•™äº†åç»­çš„å–æ¶ˆæƒã€‚å¦‚æœä¸»ä¸šåŠ¡æœåŠ¡è®¤ä¸ºå…¨å±€äº‹åŠ¡åº”è¯¥å›æ»šï¼Œå®ƒä¼šè¦æ±‚å–æ¶ˆä¹‹å‰çš„ä¸´æ—¶æ€§æ“ä½œï¼Œè¿™å°±å¯¹åº”ä»ä¸šåŠ¡æœåŠ¡çš„å–æ¶ˆæ“ä½œã€‚è€Œå½“ä¸»ä¸šåŠ¡æœåŠ¡è®¤ä¸ºå…¨å±€äº‹åŠ¡åº”è¯¥æäº¤æ—¶ï¼Œå®ƒä¼šæ”¾å¼ƒä¹‹å‰ä¸´æ—¶æ€§æ“ä½œçš„å–æ¶ˆæƒï¼Œè¿™å¯¹åº”ä»ä¸šåŠ¡æœåŠ¡çš„ç¡®è®¤æ“ä½œã€‚æ¯ä¸€ä¸ªåˆæ­¥æ“ä½œï¼Œæœ€ç»ˆéƒ½ä¼šè¢«ç¡®è®¤æˆ–å–æ¶ˆã€‚</p>
<p>å› æ­¤ï¼Œé’ˆå¯¹ä¸€ä¸ªå…·ä½“çš„ä¸šåŠ¡æœåŠ¡ï¼ŒTCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹éœ€è¦ä¸šåŠ¡ç³»ç»Ÿæä¾›ä¸‰æ®µä¸šåŠ¡é€»è¾‘ï¼š</p>
<ol>
<li>åˆæ­¥æ“ä½œ Tryï¼šå®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼Œé¢„ç•™å¿…é¡»çš„ä¸šåŠ¡èµ„æºã€‚</li>
<li>ç¡®è®¤æ“ä½œ Confirmï¼šçœŸæ­£æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸ä½œä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼Œåªä½¿ç”¨ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚å› æ­¤ï¼Œåªè¦ Try æ“ä½œæˆåŠŸï¼ŒConfirm å¿…é¡»èƒ½æˆåŠŸã€‚å¦å¤–ï¼ŒConfirm æ“ä½œéœ€æ»¡è¶³å¹‚ç­‰æ€§ï¼Œä¿è¯ä¸€ç¬”åˆ†å¸ƒå¼äº‹åŠ¡æœ‰ä¸”åªèƒ½æˆåŠŸä¸€æ¬¡ã€‚</li>
<li>å–æ¶ˆæ“ä½œ Cancelï¼šé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚åŒæ ·çš„ï¼ŒCancel æ“ä½œä¹Ÿéœ€è¦æ»¡è¶³å¹‚ç­‰æ€§ã€‚</li>
</ol>
<p><a href="http://idiotsky.top/images3/dt-11.jpg"><img src="http://idiotsky.top/images3/dt-11.jpg" alt=""></a></p>
<p>TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>ä¸»ä¸šåŠ¡æœåŠ¡ï¼šä¸»ä¸šåŠ¡æœåŠ¡ä¸ºæ•´ä¸ªä¸šåŠ¡æ´»åŠ¨çš„å‘èµ·æ–¹ï¼ŒæœåŠ¡çš„ç¼–æ’è€…ï¼Œè´Ÿè´£å‘èµ·å¹¶å®Œæˆæ•´ä¸ªä¸šåŠ¡æ´»åŠ¨ã€‚</li>
<li>ä»ä¸šåŠ¡æœåŠ¡ï¼šä»ä¸šåŠ¡æœåŠ¡æ˜¯æ•´ä¸ªä¸šåŠ¡æ´»åŠ¨çš„å‚ä¸æ–¹ï¼Œè´Ÿè´£æä¾› TCC ä¸šåŠ¡æ“ä½œï¼Œå®ç°åˆæ­¥æ“ä½œï¼ˆTryï¼‰ã€ç¡®è®¤æ“ä½œï¼ˆConfirmï¼‰ã€å–æ¶ˆæ“ä½œï¼ˆCancelï¼‰ä¸‰ä¸ªæ¥å£ï¼Œä¾›ä¸»ä¸šåŠ¡æœåŠ¡è°ƒç”¨ã€‚</li>
<li>ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ï¼šä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ç®¡ç†æ§åˆ¶æ•´ä¸ªä¸šåŠ¡æ´»åŠ¨ï¼ŒåŒ…æ‹¬è®°å½•ç»´æŠ¤ TCC å…¨å±€äº‹åŠ¡çš„äº‹åŠ¡çŠ¶æ€å’Œæ¯ä¸ªä»ä¸šåŠ¡æœåŠ¡çš„å­äº‹åŠ¡çŠ¶æ€ï¼Œå¹¶åœ¨ä¸šåŠ¡æ´»åŠ¨æäº¤æ—¶è°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Confirm æ“ä½œï¼Œåœ¨ä¸šåŠ¡æ´»åŠ¨å–æ¶ˆæ—¶è°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Cancel æ“ä½œã€‚</li>
</ol>
<p>ä¸€ä¸ªå®Œæ•´çš„ TCC åˆ†å¸ƒå¼äº‹åŠ¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä¸»ä¸šåŠ¡æœåŠ¡é¦–å…ˆå¼€å¯æœ¬åœ°äº‹åŠ¡ï¼›</li>
<li>ä¸»ä¸šåŠ¡æœåŠ¡å‘ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ç”³è¯·å¯åŠ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸»ä¸šåŠ¡æ´»åŠ¨ï¼›</li>
<li>ç„¶åé’ˆå¯¹è¦è°ƒç”¨çš„ä»ä¸šåŠ¡æœåŠ¡ï¼Œä¸»ä¸šåŠ¡æ´»åŠ¨å…ˆå‘ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨æ³¨å†Œä»ä¸šåŠ¡æ´»åŠ¨ï¼Œç„¶åè°ƒç”¨ä»ä¸šåŠ¡æœåŠ¡çš„ Try æ¥å£ï¼›</li>
<li>å½“æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Try æ¥å£è°ƒç”¨æˆåŠŸï¼Œä¸»ä¸šåŠ¡æœåŠ¡æäº¤æœ¬åœ°äº‹åŠ¡ï¼›è‹¥è°ƒç”¨å¤±è´¥ï¼Œä¸»ä¸šåŠ¡æœåŠ¡å›æ»šæœ¬åœ°äº‹åŠ¡ï¼›</li>
<li>è‹¥ä¸»ä¸šåŠ¡æœåŠ¡æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œåˆ™ TCC æ¨¡å‹åˆ†åˆ«è°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Confirm æ¥å£ï¼›è‹¥ä¸»ä¸šåŠ¡æœåŠ¡å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œåˆ™åˆ†åˆ«è°ƒç”¨ Cancel æ¥å£ï¼›</li>
<li>æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Confirm æˆ– Cancel æ“ä½œå®Œæˆåï¼Œå…¨å±€äº‹åŠ¡ç»“æŸã€‚</li>
</ol>
<h3 id="åŸå­æ€§-1"><a href="#åŸå­æ€§-1" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h3><p>TCC æ¨¡å‹ä¹Ÿä½¿ç”¨ 2PC åŸå­æäº¤åè®®æ¥ä¿è¯äº‹åŠ¡åŸå­æ€§ã€‚Try æ“ä½œå¯¹åº”2PC çš„ä¸€é˜¶æ®µå‡†å¤‡ï¼ˆPrepareï¼‰ï¼›Confirm å¯¹åº” 2PC çš„äºŒé˜¶æ®µæäº¤ï¼ˆCommitï¼‰ï¼ŒCancel å¯¹åº” 2PC çš„äºŒé˜¶æ®µå›æ»šï¼ˆRollbackï¼‰ï¼Œå¯ä»¥è¯´ TCC å°±æ˜¯åº”ç”¨å±‚çš„ 2PCã€‚</p>
<h3 id="éš”ç¦»æ€§-1"><a href="#éš”ç¦»æ€§-1" class="headerlink" title="éš”ç¦»æ€§"></a>éš”ç¦»æ€§</h3><p>TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ä»…æä¾›ä¸¤é˜¶æ®µåŸå­æäº¤åè®®ï¼Œä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡åŸå­æ€§ã€‚äº‹åŠ¡çš„éš”ç¦»äº¤ç»™ä¸šåŠ¡é€»è¾‘æ¥å®ç°ã€‚</p>
<p>éš”ç¦»çš„æœ¬è´¨æ˜¯æ§åˆ¶å¹¶å‘ï¼Œé˜²æ­¢å¹¶å‘äº‹åŠ¡æ“ä½œç›¸åŒèµ„æºè€Œå¼•èµ·çš„ç»“æœé”™ä¹±ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚é‡‘èè¡Œä¸šé‡Œç®¡ç†ç”¨æˆ·èµ„é‡‘ï¼Œå½“ç”¨æˆ·å‘èµ·äº¤æ˜“æ—¶ï¼Œä¸€èˆ¬ä¼šå…ˆæ£€æŸ¥ç”¨æˆ·èµ„é‡‘ï¼Œå¦‚æœèµ„é‡‘å……è¶³ï¼Œåˆ™æ‰£é™¤ç›¸åº”äº¤æ˜“é‡‘é¢ï¼Œå¢åŠ å–å®¶èµ„é‡‘ï¼Œå®Œæˆäº¤æ˜“ã€‚å¦‚æœæ²¡æœ‰äº‹åŠ¡éš”ç¦»ï¼Œç”¨æˆ·åŒæ—¶å‘èµ·ä¸¤ç¬”äº¤æ˜“ï¼Œä¸¤ç¬”äº¤æ˜“çš„æ£€æŸ¥éƒ½è®¤ä¸ºèµ„é‡‘å……è¶³ï¼Œå®é™…ä¸Šå´åªå¤Ÿæ”¯ä»˜ä¸€ç¬”äº¤æ˜“ï¼Œç»“æœä¸¤ç¬”äº¤æ˜“éƒ½æ”¯ä»˜æˆåŠŸï¼Œå¯¼è‡´èµ„æŸã€‚</p>
<p>å¯ä»¥å‘ç°ï¼Œå¹¶å‘æ§åˆ¶æ˜¯ä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ­£ç¡®çš„ä¿è¯ï¼Œä½†æ˜¯åƒä¸¤é˜¶æ®µé”è¿™æ ·çš„å¹¶å‘è®¿é—®æ§åˆ¶æŠ€æœ¯è¦æ±‚ä¸€ç›´æŒæœ‰æ•°æ®åº“èµ„æºé”ç›´åˆ°æ•´ä¸ªäº‹åŠ¡æ‰§è¡Œç»“æŸï¼Œç‰¹åˆ«æ˜¯åœ¨åˆ†å¸ƒå¼äº‹åŠ¡æ¶æ„ä¸‹ï¼Œè¦æ±‚æŒæœ‰é”åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ç¬¬äºŒé˜¶æ®µæ‰§è¡Œç»“æŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¼šåŠ é•¿èµ„æºé”çš„æŒæœ‰æ—¶é—´ï¼Œå¯¼è‡´å¹¶å‘æ€§èƒ½è¿›ä¸€æ­¥ä¸‹é™ã€‚</p>
<p>å› æ­¤ï¼ŒTCC æ¨¡å‹çš„éš”ç¦»æ€§æ€æƒ³å°±æ˜¯é€šè¿‡ä¸šåŠ¡çš„æ”¹é€ ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µç»“æŸä¹‹åï¼Œä»åº•å±‚æ•°æ®åº“èµ„æºå±‚é¢çš„åŠ é”è¿‡æ¸¡ä¸ºä¸Šå±‚ä¸šåŠ¡å±‚é¢çš„åŠ é”ï¼Œä»è€Œé‡Šæ”¾åº•å±‚æ•°æ®åº“é”èµ„æºï¼Œæ”¾å®½åˆ†å¸ƒå¼äº‹åŠ¡é”åè®®ï¼Œæé«˜ä¸šåŠ¡å¹¶å‘æ€§èƒ½ã€‚</p>
<p>è¿˜æ˜¯ä»¥ä¸Šé¢çš„ä¾‹å­ä¸¾ä¾‹ï¼š</p>
<ol>
<li>ç¬¬ä¸€é˜¶æ®µï¼šæ£€æŸ¥ç”¨æˆ·èµ„é‡‘ï¼Œå¦‚æœèµ„é‡‘å……è¶³ï¼Œå†»ç»“ç”¨æˆ·æœ¬æ¬¡äº¤æ˜“èµ„é‡‘ï¼Œè¿™ç¬”èµ„é‡‘è¢«ä¸šåŠ¡éš”ç¦»ï¼Œä¸å…è®¸é™¤æœ¬äº‹åŠ¡ä¹‹å¤–çš„å…¶å®ƒå¹¶å‘äº‹åŠ¡åŠ¨ç”¨ã€‚</li>
<li>ç¬¬äºŒé˜¶æ®µï¼šæ‰£é™¤ç¬¬ä¸€é˜¶æ®µé¢„å†»ç»“çš„ç”¨æˆ·èµ„é‡‘ï¼Œå¢åŠ å–å®¶èµ„é‡‘ï¼Œå®Œæˆäº¤æ˜“ã€‚ é‡‡ç”¨ä¸šåŠ¡åŠ é”çš„æ–¹å¼ï¼Œéš”ç¦»ç”¨æˆ·å†»ç»“èµ„é‡‘ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µç»“æŸåç›´æ¥é‡Šæ”¾åº•å±‚èµ„æºé”ï¼Œè¯¥ç”¨æˆ·å’Œå–å®¶çš„å…¶ä»–äº¤æ˜“éƒ½å¯ä»¥ç«‹åˆ»å¹¶å‘æ‰§è¡Œï¼Œè€Œä¸ç”¨ç­‰åˆ°æ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ç»“æŸï¼Œå¯ä»¥è·å¾—æ›´é«˜çš„å¹¶å‘äº¤æ˜“èƒ½åŠ›ã€‚</li>
</ol>
<h3 id="ä¸€è‡´æ€§-1"><a href="#ä¸€è‡´æ€§-1" class="headerlink" title="ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h3><p>å†æ¥çœ‹çœ‹ TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ä¸‹çš„ä¸€è‡´æ€§å®ç°ã€‚ä¸ XA åè®®å®ç°ä¸€è‡´æ€§ç¬¬ä¸€å±‚è¯­ä¹‰ç±»ä¼¼ï¼Œé€šè¿‡åŸå­æ€§ä¿è¯äº‹åŠ¡çš„åŸå­æäº¤ã€ä¸šåŠ¡éš”ç¦»æ€§æ§åˆ¶äº‹åŠ¡çš„å¹¶å‘è®¿é—®ï¼Œå®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§çŠ¶æ€è½¬å˜ã€‚</p>
<p>è‡³äºç¬¬äºŒå±‚è¯­ä¹‰ï¼šäº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ä¸èƒ½è¢«è§‚å¯Ÿåˆ°ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œåœ¨ SOAåˆ†å¸ƒå¼åº”ç”¨ç¯å¢ƒä¸‹æ˜¯å¦æ˜¯å¿…é¡»çš„ã€‚</p>
<p>è¿˜æ˜¯ä»¥è´¦åŠ¡æœåŠ¡ä¸¾ä¾‹ã€‚è½¬è´¦ä¸šåŠ¡ï¼ˆç”¨æˆ· A ïƒ  ç”¨æˆ· Bï¼‰ï¼Œç”±äº¤æ˜“æœåŠ¡å’Œè´¦åŠ¡æœåŠ¡ç»„æˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œäº¤æ˜“æœåŠ¡ä½œä¸ºä¸»ä¸šåŠ¡æœåŠ¡ï¼Œè´¦åŠ¡æœåŠ¡ä½œä¸ºä»ä¸šåŠ¡æœåŠ¡ï¼Œè´¦åŠ¡æœåŠ¡çš„ Try æ“ä½œé¢„å†»ç»“ç”¨æˆ· A çš„èµ„é‡‘ï¼›Commit æ“ä½œæ‰£é™¤ç”¨æˆ· A çš„é¢„å†»ç»“èµ„é‡‘ï¼Œå¢åŠ ç”¨æˆ· B çš„å¯ç”¨èµ„é‡‘ï¼›Cancel æ“ä½œè§£å†»ç”¨æˆ· A çš„é¢„å†»ç»“èµ„é‡‘ã€‚</p>
<p>å½“è´¦åŠ¡æœåŠ¡æ‰§è¡Œå®Œ Try é˜¶æ®µåï¼Œäº¤æ˜“ä¸»ä¸šåŠ¡å°±å¯ä»¥ Commit äº†ï¼Œç„¶åç”±TCC æ¡†æ¶è°ƒç”¨è´¦åŠ¡çš„ Commit é˜¶æ®µã€‚åœ¨è´¦åŠ¡ Commit é˜¶æ®µè¿˜æ²¡æ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œç”¨æˆ· A å¯ä»¥æŸ¥è¯¢åˆ°è‡ªå·±çš„ä½™é¢å·²æ‰£é™¤ï¼Œä½†æ˜¯ï¼Œæ­¤æ—¶ç”¨æˆ· B çš„å¯ç”¨èµ„é‡‘è¿˜æ²¡å¢åŠ ã€‚</p>
<p>ä»ç³»ç»Ÿçš„è§’åº¦æ¥çœ‹ï¼Œç¡®å®æœ‰é—®é¢˜ä¸ä¸ç¡®å®šæ€§ã€‚åœ¨ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œç»“æŸåˆ°ç¬¬äºŒé˜¶æ®µæ‰§è¡Œç»“æŸä¹‹é—´ï¼Œæœ‰ä¸€æ®µæ—¶é—´çš„å»¶æ—¶ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œçœ‹ä¼¼ä»»ä½•ç”¨æˆ·éƒ½ä¸äº«æœ‰è¿™ç¬”èµ„äº§ã€‚</p>
<p>ä½†æ˜¯ï¼Œä»ç”¨æˆ·çš„è§’åº¦æ¥è€ƒè™‘è¿™ä¸ªé—®é¢˜çš„è¯ï¼Œè¿™ä¸ªæ—¶é—´é—´éš”å¯èƒ½å°±æ— æ‰€è°“æˆ–è€…æ ¹æœ¬å°±ä¸å­˜åœ¨ã€‚ç‰¹åˆ«æ˜¯å½“è¿™ä¸ªæ—¶é—´é—´éš”ä»…ä»…æ˜¯å‡ ç§’é’Ÿï¼Œå¯¹äºå…·ä½“æ²Ÿé€šèµ„äº§è½¬ç§»çš„ç”¨æˆ·æ¥è®²ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯éšè”½çš„æˆ–ç¡®å®å¯ä»¥æ¥å—çš„ï¼Œä¸”ä¿è¯äº†ç»“æœçš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<p>å½“ç„¶ï¼Œå¯¹äºè¿™æ ·çš„ç³»ç»Ÿï¼Œå¦‚æœç¡®å®éœ€è¦æŸ¥çœ‹ç³»ç»Ÿçš„æŸä¸ªä¸€è‡´æ€§çŠ¶æ€ï¼Œå¯ä»¥é‡‡ç”¨é¢å¤–çš„æ–¹æ³•å®ç°ã€‚</p>
<p>ä¸€èˆ¬æ¥è®²ï¼ŒæœåŠ¡ä¹‹é—´çš„ä¸€è‡´æ€§æ¯”æœåŠ¡å†…éƒ¨çš„ä¸€è‡´æ€§è¦æ›´åŠ å®¹æ˜“å¼±åŒ–ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ XA ç­‰ç›´æ¥åœ¨èµ„æºå±‚é¢ä¸Šå®ç°é€šç”¨åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¨¡å‹ä¼šæ³¨é‡ä¸€è‡´æ€§çš„ä¿è¯ï¼Œè€Œå½“ä¸Šå‡åˆ°æœåŠ¡å±‚é¢ï¼ŒæœåŠ¡ä¸æœåŠ¡ä¹‹é—´å·²ç»å®ç°äº†åŠŸèƒ½çš„åˆ’åˆ†ï¼Œé€»è¾‘çš„è§£è€¦ï¼Œä¹Ÿå°±æ›´å®¹æ˜“å¼±åŒ–ä¸€è‡´æ€§ï¼Œè¿™å°±æ˜¯ SOA æ¶æ„ä¸‹ BASE ç†è®ºçš„æœ€ç»ˆä¸€è‡´æ€§æ€æƒ³ã€‚</p>
<p>BASE ç†è®ºæ˜¯æŒ‡ BAï¼ˆBasic Availabilityï¼ŒåŸºæœ¬ä¸šåŠ¡å¯ç”¨æ€§ï¼‰ï¼›Sï¼ˆSoft stateï¼ŒæŸ”æ€§çŠ¶æ€ï¼‰ï¼›Eï¼ˆEventual consistencyï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€‚è¯¥ç†è®ºè®¤ä¸ºä¸ºäº†å¯ç”¨æ€§ã€æ€§èƒ½ä¸é™çº§æœåŠ¡çš„éœ€è¦ï¼Œå¯ä»¥é€‚å½“é™ä½ä¸€ç‚¹ä¸€è‡´æ€§çš„è¦æ±‚ï¼Œå³â€œåŸºæœ¬å¯ç”¨ï¼Œæœ€ç»ˆä¸€è‡´â€ã€‚</p>
<p>ä¸šå†…é€šå¸¸æŠŠä¸¥æ ¼éµå¾ª ACID çš„äº‹åŠ¡ç§°ä¸ºåˆšæ€§äº‹åŠ¡ï¼›è€ŒåŸºäº BASE æ€æƒ³å®ç°çš„äº‹åŠ¡ç§°ä¸ºæŸ”æ€§äº‹åŠ¡ã€‚æŸ”æ€§äº‹åŠ¡å¹¶ä¸æ˜¯å®Œå…¨æ”¾å¼ƒäº† ACIDï¼Œä»…ä»…æ˜¯æ”¾å®½äº†ä¸€è‡´æ€§è¦æ±‚ï¼šäº‹åŠ¡å®Œæˆåçš„ä¸€è‡´æ€§ä¸¥æ ¼éµå¾ªï¼Œäº‹åŠ¡ä¸­çš„ä¸€è‡´æ€§å¯é€‚å½“æ”¾å®½ï¼›</p>
<h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹çš„ä¸šåŠ¡å®ç°ç‰¹æ€§å†³å®šäº†å…¶å¯ä»¥è·¨ DBã€è·¨æœåŠ¡å®ç°èµ„æºç®¡ç†ï¼Œå°†å¯¹ä¸åŒçš„ DB è®¿é—®ã€ä¸åŒçš„ä¸šåŠ¡æ“ä½œé€šè¿‡ TCC æ¨¡å‹åè°ƒä¸ºä¸€ä¸ªåŸå­æ“ä½œï¼Œè§£å†³äº†åˆ†å¸ƒå¼åº”ç”¨æ¶æ„åœºæ™¯ä¸‹çš„äº‹åŠ¡é—®é¢˜ã€‚</p>
<p>TCC æ¨¡å‹é€šè¿‡ 2PC åŸå­æäº¤åè®®ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„çš„åŸå­æ€§ï¼ŒæŠŠèµ„æºå±‚çš„éš”ç¦»æ€§ä¸Šå‡åˆ°ä¸šåŠ¡å±‚ï¼Œäº¤ç»™ä¸šåŠ¡é€»è¾‘æ¥å®ç°ã€‚TCC çš„æ¯ä¸ªæ“ä½œå¯¹äºèµ„æºå±‚æ¥è¯´ï¼Œå°±æ˜¯å•ä¸ªæœ¬åœ°äº‹åŠ¡çš„ä½¿ç”¨ï¼Œæ“ä½œç»“æŸåˆ™æœ¬åœ°äº‹åŠ¡ç»“æŸï¼Œè§„é¿äº†èµ„æºå±‚åœ¨ 2PC å’Œ 2PL ä¸‹å¯¹èµ„æºå ç”¨å¯¼è‡´çš„æ€§èƒ½ä½ä¸‹é—®é¢˜ã€‚</p>
<p>åŒæ—¶ï¼ŒTCC æ¨¡å‹ä¹Ÿå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œåšä¸€äº›å®šåˆ¶åŒ–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚äº¤æ˜“å¼‚æ­¥åŒ–å®ç°å‰Šå³°å¡«è°·ç­‰ã€‚</p>
<p>ä½†æ˜¯ï¼Œä¸šåŠ¡æ¥å…¥ TCC æ¨¡å‹éœ€è¦æ‹†åˆ†ä¸šåŠ¡é€»è¾‘æˆä¸¤ä¸ªé˜¶æ®µï¼Œå¹¶å®ç° Tryã€Confirmã€Cancel ä¸‰ä¸ªæ¥å£ï¼Œå®šåˆ¶åŒ–ç¨‹åº¦é«˜ï¼Œå¼€å‘æˆæœ¬é«˜ã€‚</p>
<h1 id="å…¶ä»–è§£å†³æ–¹æ¡ˆ"><a href="#å…¶ä»–è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…¶ä»–è§£å†³æ–¹æ¡ˆ"></a>å…¶ä»–è§£å†³æ–¹æ¡ˆ</h1><h2 id="æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå¼‚æ­¥ç¡®ä¿ï¼‰"><a href="#æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå¼‚æ­¥ç¡®ä¿ï¼‰" class="headerlink" title="æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå¼‚æ­¥ç¡®ä¿ï¼‰"></a>æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå¼‚æ­¥ç¡®ä¿ï¼‰</h2><p>æœ¬åœ°æ¶ˆæ¯è¡¨è¿™ç§å®ç°æ–¹å¼åº”è¯¥æ˜¯ä¸šç•Œä½¿ç”¨æœ€å¤šçš„ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†æˆæœ¬åœ°äº‹åŠ¡è¿›è¡Œå¤„ç†ï¼Œè¿™ç§æ€è·¯æ˜¯æ¥æºäºebayã€‚æˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢çš„æµç¨‹å›¾ä¸­çœ‹å‡ºå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-12.png"><img src="http://idiotsky.top/images3/dt-12.png" alt=""></a></p>
<p>åŸºæœ¬æ€è·¯å°±æ˜¯ï¼š</p>
<p>æ¶ˆæ¯ç”Ÿäº§æ–¹ï¼Œéœ€è¦é¢å¤–å»ºä¸€ä¸ªæ¶ˆæ¯è¡¨ï¼Œå¹¶è®°å½•æ¶ˆæ¯å‘é€çŠ¶æ€ã€‚æ¶ˆæ¯è¡¨å’Œä¸šåŠ¡æ•°æ®è¦åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œæäº¤ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬è¦åœ¨ä¸€ä¸ªæ•°æ®åº“é‡Œé¢ã€‚ç„¶åæ¶ˆæ¯ä¼šç»è¿‡MQå‘é€åˆ°æ¶ˆæ¯çš„æ¶ˆè´¹æ–¹ã€‚å¦‚æœæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œä¼šè¿›è¡Œé‡è¯•å‘é€ã€‚</p>
<p>æ¶ˆæ¯æ¶ˆè´¹æ–¹ï¼Œéœ€è¦å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œå¹¶å®Œæˆè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚æ­¤æ—¶å¦‚æœæœ¬åœ°äº‹åŠ¡å¤„ç†æˆåŠŸï¼Œè¡¨æ˜å·²ç»å¤„ç†æˆåŠŸäº†ï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šé‡è¯•æ‰§è¡Œã€‚å¦‚æœæ˜¯ä¸šåŠ¡ä¸Šé¢çš„å¤±è´¥ï¼Œå¯ä»¥ç»™ç”Ÿäº§æ–¹å‘é€ä¸€ä¸ªä¸šåŠ¡è¡¥å¿æ¶ˆæ¯ï¼Œé€šçŸ¥ç”Ÿäº§æ–¹è¿›è¡Œå›æ»šç­‰æ“ä½œã€‚</p>
<p>ç”Ÿäº§æ–¹å’Œæ¶ˆè´¹æ–¹å®šæ—¶æ‰«ææœ¬åœ°æ¶ˆæ¯è¡¨ï¼ŒæŠŠè¿˜æ²¡å¤„ç†å®Œæˆçš„æ¶ˆæ¯æˆ–è€…å¤±è´¥çš„æ¶ˆæ¯å†å‘é€ä¸€éã€‚å¦‚æœæœ‰é è°±çš„è‡ªåŠ¨å¯¹è´¦è¡¥è´¦é€»è¾‘ï¼Œè¿™ç§æ–¹æ¡ˆè¿˜æ˜¯éå¸¸å®ç”¨çš„ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆéµå¾ªBASEç†è®ºï¼Œé‡‡ç”¨çš„æ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œç¬”è€…è®¤ä¸ºæ˜¯è¿™å‡ ç§æ–¹æ¡ˆé‡Œé¢æ¯”è¾ƒé€‚åˆå®é™…ä¸šåŠ¡åœºæ™¯çš„ï¼Œå³ä¸ä¼šå‡ºç°åƒ2PCé‚£æ ·å¤æ‚çš„å®ç°(å½“è°ƒç”¨é“¾å¾ˆé•¿çš„æ—¶å€™ï¼Œ2PCçš„å¯ç”¨æ€§æ˜¯éå¸¸ä½çš„)ï¼Œä¹Ÿä¸ä¼šåƒTCCé‚£æ ·å¯èƒ½å‡ºç°ç¡®è®¤æˆ–è€…å›æ»šä¸äº†çš„æƒ…å†µã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼š ä¸€ç§éå¸¸ç»å…¸çš„å®ç°ï¼Œé¿å…äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå®ç°äº†æœ€ç»ˆä¸€è‡´æ€§ã€‚</li>
<li>ç¼ºç‚¹ï¼š æ¶ˆæ¯è¡¨ä¼šè€¦åˆåˆ°ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œå¦‚æœæ²¡æœ‰å°è£…å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä¼šæœ‰å¾ˆå¤šæ‚æ´»éœ€è¦å¤„ç†ã€‚</li>
</ul>
<h2 id="MQ-äº‹åŠ¡æ¶ˆæ¯"><a href="#MQ-äº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="MQ äº‹åŠ¡æ¶ˆæ¯"></a>MQ äº‹åŠ¡æ¶ˆæ¯</h2><p>æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„MQæ˜¯æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„ï¼Œæ¯”å¦‚RocketMQï¼Œä»–ä»¬æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼äºé‡‡ç”¨çš„äºŒé˜¶æ®µæäº¤ï¼Œä½†æ˜¯å¸‚é¢ä¸Šä¸€äº›ä¸»æµçš„MQéƒ½æ˜¯ä¸æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„ï¼Œæ¯”å¦‚ RabbitMQ å’Œ Kafka éƒ½ä¸æ”¯æŒã€‚</p>
<p>ä»¥é˜¿é‡Œçš„ RocketMQ ä¸­é—´ä»¶ä¸ºä¾‹ï¼Œå…¶æ€è·¯å¤§è‡´ä¸ºï¼š</p>
<p>ç¬¬ä¸€é˜¶æ®µPreparedæ¶ˆæ¯ï¼Œä¼šæ‹¿åˆ°æ¶ˆæ¯çš„åœ°å€ã€‚<br>ç¬¬äºŒé˜¶æ®µæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œç¬¬ä¸‰é˜¶æ®µé€šè¿‡ç¬¬ä¸€é˜¶æ®µæ‹¿åˆ°çš„åœ°å€å»è®¿é—®æ¶ˆæ¯ï¼Œå¹¶ä¿®æ”¹çŠ¶æ€ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸šåŠ¡æ–¹æ³•å†…è¦å‘æ¶ˆæ¯é˜Ÿåˆ—æäº¤ä¸¤æ¬¡è¯·æ±‚ï¼Œä¸€æ¬¡å‘é€æ¶ˆæ¯å’Œä¸€æ¬¡ç¡®è®¤æ¶ˆæ¯ã€‚å¦‚æœç¡®è®¤æ¶ˆæ¯å‘é€å¤±è´¥äº†RocketMQä¼šå®šæœŸæ‰«ææ¶ˆæ¯é›†ç¾¤ä¸­çš„äº‹åŠ¡æ¶ˆæ¯ï¼Œè¿™æ—¶å€™å‘ç°äº†Preparedæ¶ˆæ¯ï¼Œå®ƒä¼šå‘æ¶ˆæ¯å‘é€è€…ç¡®è®¤ï¼Œæ‰€ä»¥ç”Ÿäº§æ–¹éœ€è¦å®ç°ä¸€ä¸ªcheckæ¥å£ï¼ŒRocketMQä¼šæ ¹æ®å‘é€ç«¯è®¾ç½®çš„ç­–ç•¥æ¥å†³å®šæ˜¯å›æ»šè¿˜æ˜¯ç»§ç»­å‘é€ç¡®è®¤æ¶ˆæ¯ã€‚è¿™æ ·å°±ä¿è¯äº†æ¶ˆæ¯å‘é€ä¸æœ¬åœ°äº‹åŠ¡åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-13.png"><img src="http://idiotsky.top/images3/dt-13.png" alt=""></a></p>
<ul>
<li>ä¼˜ç‚¹ï¼š å®ç°äº†æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸éœ€è¦ä¾èµ–æœ¬åœ°æ•°æ®åº“äº‹åŠ¡ã€‚</li>
<li>ç¼ºç‚¹ï¼š å®ç°éš¾åº¦å¤§ï¼Œä¸»æµMQä¸æ”¯æŒï¼ŒRocketMQäº‹åŠ¡æ¶ˆæ¯éƒ¨åˆ†ä»£ç ä¹Ÿæœªå¼€æºã€‚</li>
</ul>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡é¦–å…ˆä»‹ç»äº†å…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¶æ„åœºæ™¯ã€‚åˆ†å¸ƒå¼äº‹åŠ¡åˆšå¼€å§‹æ˜¯ä¸ºè§£å†³å•æœåŠ¡å¤šæ•°æ®åº“èµ„æºçš„åœºæ™¯è€Œè¯ç”Ÿçš„ã€‚éšç€æŠ€æœ¯çš„å‘å±•ï¼Œç‰¹åˆ«æ˜¯ SOA åˆ†å¸ƒå¼åº”ç”¨æ¶æ„ä»¥åŠå¾®æœåŠ¡æ—¶ä»£çš„åˆ°æ¥ï¼ŒæœåŠ¡å˜æˆäº†åŸºæœ¬ä¸šåŠ¡å•å…ƒã€‚å› æ­¤ï¼Œåˆäº§ç”Ÿäº†è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡éœ€æ±‚ã€‚ç„¶åä» XA å’Œ TCC ä¸¤ç§å¸¸ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹å…¥æ‰‹ï¼Œä»‹ç»äº†å…¶å®ç°æœºåˆ¶ï¼Œç€é‡åˆ†æäº†å„æ¨¡å‹æ˜¯å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ ACID ç‰¹æ€§çš„ã€‚è¿˜è®²è§£äº†ç°å®ä¸­å¸¸ç”¨çš„ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆï¼šæœ¬åœ°æ¶ˆæ¯è¡¨å’ŒMQ äº‹åŠ¡æ¶ˆæ¯</p>
<p>å‚è€ƒ</p>
<p><a href="https://zhuanlan.zhihu.com/p/38388143" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/38388143</a><br><a href="https://www.cnblogs.com/savorboard/p/distributed-system-transaction-consistency.html" target="_blank" rel="noopener">https://www.cnblogs.com/savorboard/p/distributed-system-transaction-consistency.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ğŸ‘¿markä¹‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¼ä¸šé›†æˆä¸­çš„ä¸€ä¸ªæŠ€æœ¯éš¾ç‚¹ï¼Œä¹Ÿæ˜¯æ¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸­éƒ½ä¼šæ¶‰åŠåˆ°çš„ä¸€ä¸ªä¸œè¥¿ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿™å‡ å¹´è¶Šæ¥è¶Šç«çš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå‡ ä¹å¯ä»¥è¯´æ˜¯æ— æ³•é¿å…ï¼Œæœ¬æ–‡å°±å›´ç»•åˆ†å¸ƒå¼äº‹åŠ¡å„æ–¹é¢ä¸å¤§å®¶è¿›è¡Œä»‹ç»ã€‚&lt;/p&gt;
&lt;h1 id=&quot;äº‹åŠ¡&quot;&gt;&lt;a href=&quot;#äº‹åŠ¡&quot; class=&quot;headerlink&quot; title=&quot;äº‹åŠ¡&quot;&gt;&lt;/a&gt;äº‹åŠ¡&lt;/h1&gt;&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯äº‹åŠ¡&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯äº‹åŠ¡&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯äº‹åŠ¡&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯äº‹åŠ¡&lt;/h2&gt;&lt;p&gt;æ•°æ®åº“äº‹åŠ¡ï¼ˆç®€ç§°ï¼šäº‹åŠ¡ï¼ŒTransactionï¼‰æ˜¯æŒ‡æ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œç”±ä¸€ä¸ªæœ‰é™çš„æ•°æ®åº“æ“ä½œåºåˆ—æ„æˆã€‚&lt;/p&gt;
&lt;p&gt;äº‹åŠ¡æ‹¥æœ‰ä»¥ä¸‹å››ä¸ªç‰¹æ€§ï¼Œä¹ æƒ¯ä¸Šè¢«ç§°ä¸ºACIDç‰¹æ€§ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«æ‰§è¡Œï¼ŒåŒ…å«åœ¨å…¶ä¸­çš„å¯¹æ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚&lt;/li&gt;
&lt;li&gt;ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡åº”ç¡®ä¿æ•°æ®åº“çš„çŠ¶æ€ä»ä¸€ä¸ªä¸€è‡´çŠ¶æ€è½¬å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚ä¸€è‡´çŠ¶æ€æ˜¯æŒ‡æ•°æ®åº“ä¸­çš„æ•°æ®åº”æ»¡è¶³å®Œæ•´æ€§çº¦æŸã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸€è‡´æ€§è¿˜æœ‰å¦å¤–ä¸€å±‚è¯­ä¹‰ï¼Œå°±æ˜¯äº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ä¸èƒ½è¢«è§‚å¯Ÿåˆ°ï¼ˆè¿™å±‚è¯­ä¹‰ä¹Ÿæœ‰è¯´åº”è¯¥å±äºåŸå­æ€§ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”å½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œï¼Œå¦‚åŒåªæœ‰è¿™ä¸€ä¸ªæ“ä½œåœ¨è¢«æ•°æ®åº“æ‰€æ‰§è¡Œä¸€æ ·ã€‚&lt;/li&gt;
&lt;li&gt;æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šå·²è¢«æäº¤çš„äº‹åŠ¡å¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚åœ¨äº‹åŠ¡ç»“æŸæ—¶ï¼Œæ­¤æ“ä½œå°†ä¸å¯é€†è½¬ã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://idiotsky.top/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="http://idiotsky.top/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
</feed>
