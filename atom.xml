<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>IdiotSky</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://idiotsky.me/"/>
  <updated>2018-01-10T14:02:38.116Z</updated>
  <id>http://idiotsky.me/</id>
  
  <author>
    <name>ejunjsh</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ç”¨goå°è¯•websocket</title>
    <link href="http://idiotsky.me/2018/01/10/go-websocket/"/>
    <id>http://idiotsky.me/2018/01/10/go-websocket/</id>
    <published>2018-01-10T07:44:21.000Z</published>
    <updated>2018-01-10T14:02:38.116Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯websocket"><a href="#ä»€ä¹ˆæ˜¯websocket" class="headerlink" title="ä»€ä¹ˆæ˜¯websocket"></a>ä»€ä¹ˆæ˜¯websocket</h1><p>åˆæ¬¡æ¥è§¦ WebSocket çš„äººï¼Œéƒ½ä¼šé—®åŒæ ·çš„é—®é¢˜ï¼šæˆ‘ä»¬å·²ç»æœ‰äº† HTTP åè®®ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å¦ä¸€ä¸ªåè®®ï¼Ÿå®ƒèƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ<br>ç­”æ¡ˆå¾ˆç®€å•ï¼Œå› ä¸º HTTP åè®®æœ‰ä¸€ä¸ªç¼ºé™·ï¼šé€šä¿¡åªèƒ½ç”±å®¢æˆ·ç«¯å‘èµ·ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬æƒ³äº†è§£ä»Šå¤©çš„å¤©æ°”ï¼Œåªèƒ½æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›æŸ¥è¯¢ç»“æœã€‚HTTP åè®®åšä¸åˆ°æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ã€‚<br>è¿™ç§å•å‘è¯·æ±‚çš„ç‰¹ç‚¹ï¼Œæ³¨å®šäº†å¦‚æœæœåŠ¡å™¨æœ‰è¿ç»­çš„çŠ¶æ€å˜åŒ–ï¼Œå®¢æˆ·ç«¯è¦è·çŸ¥å°±éå¸¸éº»çƒ¦ã€‚æˆ‘ä»¬åªèƒ½ä½¿ç”¨â€è½®è¯¢â€ï¼šæ¯éš”ä¸€æ®µæ—¶å€™ï¼Œå°±å‘å‡ºä¸€ä¸ªè¯¢é—®ï¼Œäº†è§£æœåŠ¡å™¨æœ‰æ²¡æœ‰æ–°çš„ä¿¡æ¯ã€‚æœ€å…¸å‹çš„åœºæ™¯å°±æ˜¯èŠå¤©å®¤ã€‚</p>
<p>è½®è¯¢çš„æ•ˆç‡ä½ï¼Œéå¸¸æµªè´¹èµ„æºï¼ˆå› ä¸ºå¿…é¡»ä¸åœè¿æ¥ï¼Œæˆ–è€… HTTP è¿æ¥å§‹ç»ˆæ‰“å¼€ï¼‰ã€‚å› æ­¤ï¼Œå·¥ç¨‹å¸ˆä»¬ä¸€ç›´åœ¨æ€è€ƒï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•ã€‚WebSocket å°±æ˜¯è¿™æ ·å‘æ˜çš„ã€‚</p>
<p>WebSocket åè®®åœ¨2008å¹´è¯ç”Ÿï¼Œ2011å¹´æˆä¸ºå›½é™…æ ‡å‡†ã€‚æ‰€æœ‰æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒäº†ã€‚</p>
<p>å®ƒçš„æœ€å¤§ç‰¹ç‚¹å°±æ˜¯ï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘æœåŠ¡å™¨å‘é€ä¿¡æ¯ï¼Œæ˜¯çœŸæ­£çš„åŒå‘å¹³ç­‰å¯¹è¯ï¼Œå±äº<a href="https://en.wikipedia.org/wiki/Push_technology" target="_blank" rel="external">æœåŠ¡å™¨æ¨é€</a>æŠ€æœ¯çš„ä¸€ç§ã€‚<br><a href="http://idiotsky.me/images2/go-websocket-1.png"><img src="http://idiotsky.me/images2/go-websocket-1.png" alt=""></a></p>
<a id="more"></a>
<p>å…¶ä»–ç‰¹ç‚¹åŒ…æ‹¬ï¼š</p>
<ol>
<li>å»ºç«‹åœ¨ TCP åè®®ä¹‹ä¸Šï¼ŒæœåŠ¡å™¨ç«¯çš„å®ç°æ¯”è¾ƒå®¹æ˜“ã€‚</li>
<li>ä¸ HTTP åè®®æœ‰ç€è‰¯å¥½çš„å…¼å®¹æ€§ã€‚é»˜è®¤ç«¯å£ä¹Ÿæ˜¯80å’Œ443ï¼Œå¹¶ä¸”æ¡æ‰‹é˜¶æ®µé‡‡ç”¨ HTTP åè®®ï¼Œå› æ­¤æ¡æ‰‹æ—¶ä¸å®¹æ˜“å±è”½ï¼Œèƒ½é€šè¿‡å„ç§ HTTP ä»£ç†æœåŠ¡å™¨ã€‚</li>
<li>æ•°æ®æ ¼å¼æ¯”è¾ƒè½»é‡ï¼Œæ€§èƒ½å¼€é”€å°ï¼Œé€šä¿¡é«˜æ•ˆã€‚</li>
<li>å¯ä»¥å‘é€æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥å‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚</li>
<li>æ²¡æœ‰åŒæºé™åˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä¸ä»»æ„æœåŠ¡å™¨é€šä¿¡ã€‚</li>
<li>åè®®æ ‡è¯†ç¬¦æ˜¯wsï¼ˆå¦‚æœåŠ å¯†ï¼Œåˆ™ä¸ºwssï¼‰ï¼ŒæœåŠ¡å™¨ç½‘å€å°±æ˜¯ URLã€‚<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ws://example.com:80/some/path</div></pre></td></tr></table></figure>
</li>
</ol>
<p><a href="http://idiotsky.me/images2/go-websocket-2.jpg"><img src="http://idiotsky.me/images2/go-websocket-2.jpg" alt=""></a></p>
<h1 id="å°è¯•"><a href="#å°è¯•" class="headerlink" title="å°è¯•"></a>å°è¯•</h1><p>ç”¨ä¸€ä¸ªechoçš„ä¾‹å­æ¥è¯•ä¸€ä¸‹websocket</p>
<h2 id="å®¢æˆ·ç«¯å®ç°"><a href="#å®¢æˆ·ç«¯å®ç°" class="headerlink" title="å®¢æˆ·ç«¯å®ç°"></a>å®¢æˆ·ç«¯å®ç°</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></div><div class="line">        var ws;</div><div class="line">        function connect() &#123;</div><div class="line">            ws= new WebSocket("ws://localhost:8080/echo");</div><div class="line">            ws.onopen = function()</div><div class="line">            &#123;</div><div class="line">                alert("connection is successful");</div><div class="line">            &#125;;</div><div class="line">            ws.onmessage = function (e)</div><div class="line">            &#123;</div><div class="line">                var msg = e.data;</div><div class="line">                var li=document.createElement("li");</div><div class="line">                li.innerText=msg;</div><div class="line">                document.getElementsByTagName("ul")[0].appendChild(li);</div><div class="line">            &#125;;</div><div class="line">            ws.onclose = function()</div><div class="line">            &#123;</div><div class="line">                // websocket is closed.</div><div class="line">                alert("Connection is closed...");</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        function send() &#123;</div><div class="line">            if(ws)&#123;</div><div class="line">                var msg=document.getElementById("txt").value;</div><div class="line">                ws.send(msg);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">            alert("connect first!!!");</div><div class="line">        &#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:connect()"</span>&gt;</span>connect<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"txt"</span> <span class="attr">style</span>=<span class="string">"width: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"sendBtn"</span> <span class="attr">onclick</span>=<span class="string">"send()"</span>&gt;</span>send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯ç”¨<code>new WebSocket(&quot;ws://localhost:8080/echo&quot;)</code>åˆå§‹åŒ–websocketï¼Œç„¶åæ³¨å†Œç›¸å…³äº‹ä»¶ï¼Œå°±å¯ä»¥å®Œæˆä¸€ä¸ªç®€å•websocketå®¢æˆ·ç«¯äº†ã€‚</p>
<h2 id="æœåŠ¡ç«¯å®ç°"><a href="#æœåŠ¡ç«¯å®ç°" class="headerlink" title="æœåŠ¡ç«¯å®ç°"></a>æœåŠ¡ç«¯å®ç°</h2><p>goçš„æ ‡å‡†åº“æ²¡æœ‰å®ç°websocketçš„åŠŸèƒ½ï¼Œæ‰€ä»¥è¦ç”¨<code>github.com/gorilla/websocket</code>è¿™ä¸ªåº“æ¥å®ç°æœåŠ¡ç«¯<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line"></div><div class="line">	<span class="string">"github.com/gorilla/websocket"</span></div><div class="line"></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> upgrader = websocket.Upgrader&#123;</div><div class="line">	ReadBufferSize:  <span class="number">1024</span>,</div><div class="line">	WriteBufferSize: <span class="number">1024</span>,</div><div class="line">	CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span> <span class="title">bool</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;,</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	static := http.FileServer(http.Dir(<span class="string">"./static"</span>))</div><div class="line">	http.Handle(<span class="string">"/"</span>, static)</div><div class="line"></div><div class="line">	http.HandleFunc(<span class="string">"/echo"</span>, echo)</div><div class="line"></div><div class="line">	log.Printf(<span class="string">"Service started on %d \n"</span>, <span class="number">8080</span>)</div><div class="line">	log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">echo</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">	conn, err := upgrader.Upgrade(w, r, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"upgrade error:"</span>, err.Error())</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	log.Println(<span class="string">"Connected..."</span>)</div><div class="line">	<span class="keyword">defer</span> conn.Close()</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		messageType, p, err := conn.ReadMessage()</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			log.Println(<span class="string">"read message error:"</span>, err.Error())</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> err := conn.WriteMessage(messageType, p); err != <span class="literal">nil</span> &#123;</div><div class="line">			log.Println(<span class="string">"write message error:"</span>, err.Error())</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	log.Println(<span class="string">"Disconnect."</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªhttpæœåŠ¡ï¼Œç„¶åæŠŠä¸Šé¢çš„htmlä½œä¸ºé™æ€èµ„æºï¼ŒåŒæ—¶å®šä¹‰ä¸€ä¸ª<code>echo</code>çš„å¤„ç†å‡½æ•°ã€‚å‡½æ•°é‡Œé¢å¯¹è¯·æ±‚è¿›è¡Œ<code>upgrade</code>ï¼Œè¡¨ç¤ºä»æ™®é€šçš„è¯·æ±‚å˜æˆwebsocketï¼ˆå‰ææ˜¯è¯·æ±‚å¤´é‡Œé¢è¦åŒ…å«<code>upgrade</code>æ ‡è®°ï¼‰ï¼Œä¹‹åå°±è·å–äº†connectionï¼Œæ¥ä¸‹æ¥å°±è·Ÿå¹³å¸¸tcpçš„è¿æ¥é‚£æ ·è¯»å†™æ•°æ®äº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç”¨goå®ç°çš„websocketç®€ç›´æ˜¯ç®€å•åˆ°çˆ†äº†ï¼ŒåŸºæœ¬ç¬¬ä¸‰æ–¹åº“å·²ç»å°è£…å¥½äº†ğŸ‘¿</p>
<p>æ‰€æœ‰ä»£ç åœ¨ <a href="https://github.com/ejunjsh/go-code/tree/master/websocket" target="_blank" rel="external">https://github.com/ejunjsh/go-code/tree/master/websocket</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ä»€ä¹ˆæ˜¯websocket&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯websocket&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯websocket&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯websocket&lt;/h1&gt;&lt;p&gt;åˆæ¬¡æ¥è§¦ WebSocket çš„äººï¼Œéƒ½ä¼šé—®åŒæ ·çš„é—®é¢˜ï¼šæˆ‘ä»¬å·²ç»æœ‰äº† HTTP åè®®ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å¦ä¸€ä¸ªåè®®ï¼Ÿå®ƒèƒ½å¸¦æ¥ä»€ä¹ˆå¥½å¤„ï¼Ÿ&lt;br&gt;ç­”æ¡ˆå¾ˆç®€å•ï¼Œå› ä¸º HTTP åè®®æœ‰ä¸€ä¸ªç¼ºé™·ï¼šé€šä¿¡åªèƒ½ç”±å®¢æˆ·ç«¯å‘èµ·ã€‚&lt;/p&gt;
&lt;p&gt;ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬æƒ³äº†è§£ä»Šå¤©çš„å¤©æ°”ï¼Œåªèƒ½æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›æŸ¥è¯¢ç»“æœã€‚HTTP åè®®åšä¸åˆ°æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ã€‚&lt;br&gt;è¿™ç§å•å‘è¯·æ±‚çš„ç‰¹ç‚¹ï¼Œæ³¨å®šäº†å¦‚æœæœåŠ¡å™¨æœ‰è¿ç»­çš„çŠ¶æ€å˜åŒ–ï¼Œå®¢æˆ·ç«¯è¦è·çŸ¥å°±éå¸¸éº»çƒ¦ã€‚æˆ‘ä»¬åªèƒ½ä½¿ç”¨â€è½®è¯¢â€ï¼šæ¯éš”ä¸€æ®µæ—¶å€™ï¼Œå°±å‘å‡ºä¸€ä¸ªè¯¢é—®ï¼Œäº†è§£æœåŠ¡å™¨æœ‰æ²¡æœ‰æ–°çš„ä¿¡æ¯ã€‚æœ€å…¸å‹çš„åœºæ™¯å°±æ˜¯èŠå¤©å®¤ã€‚&lt;/p&gt;
&lt;p&gt;è½®è¯¢çš„æ•ˆç‡ä½ï¼Œéå¸¸æµªè´¹èµ„æºï¼ˆå› ä¸ºå¿…é¡»ä¸åœè¿æ¥ï¼Œæˆ–è€… HTTP è¿æ¥å§‹ç»ˆæ‰“å¼€ï¼‰ã€‚å› æ­¤ï¼Œå·¥ç¨‹å¸ˆä»¬ä¸€ç›´åœ¨æ€è€ƒï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ³•ã€‚WebSocket å°±æ˜¯è¿™æ ·å‘æ˜çš„ã€‚&lt;/p&gt;
&lt;p&gt;WebSocket åè®®åœ¨2008å¹´è¯ç”Ÿï¼Œ2011å¹´æˆä¸ºå›½é™…æ ‡å‡†ã€‚æ‰€æœ‰æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒäº†ã€‚&lt;/p&gt;
&lt;p&gt;å®ƒçš„æœ€å¤§ç‰¹ç‚¹å°±æ˜¯ï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘æœåŠ¡å™¨å‘é€ä¿¡æ¯ï¼Œæ˜¯çœŸæ­£çš„åŒå‘å¹³ç­‰å¯¹è¯ï¼Œå±äº&lt;a href=&quot;https://en.wikipedia.org/wiki/Push_technology&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;æœåŠ¡å™¨æ¨é€&lt;/a&gt;æŠ€æœ¯çš„ä¸€ç§ã€‚&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images2/go-websocket-1.png&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images2/go-websocket-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.me/categories/go/"/>
    
    
      <category term="go" scheme="http://idiotsky.me/tags/go/"/>
    
      <category term="websocket" scheme="http://idiotsky.me/tags/websocket/"/>
    
  </entry>
  
  <entry>
    <title>goåŸºç¡€-nil</title>
    <link href="http://idiotsky.me/2018/01/03/go-nil/"/>
    <id>http://idiotsky.me/2018/01/03/go-nil/</id>
    <published>2018-01-03T15:48:13.000Z</published>
    <updated>2018-01-06T06:43:45.350Z</updated>
    
    <content type="html"><![CDATA[<h1 id="nilæ˜¯ä»€ä¹ˆ"><a href="#nilæ˜¯ä»€ä¹ˆ" class="headerlink" title="nilæ˜¯ä»€ä¹ˆ"></a>nilæ˜¯ä»€ä¹ˆ</h1><blockquote>
<p>The â€œnilâ€ identifier can be used as the â€œzero valueâ€ for interfaces, functions, pointers, maps, slices, and channels</p>
</blockquote>
<p>è¿™æ˜¯å¯¹nilçš„å®˜æ–¹è§£é‡Šï¼Œæ„æ€å°±æ˜¯è¯´nilæ˜¯æ¥å£ï¼Œå‡½æ•°ï¼ŒæŒ‡é’ˆï¼Œmapï¼Œsliceå’Œç®¡é“çš„é›¶å€¼ã€‚é›¶å€¼ï¼Œzero valueï¼Œåœ¨Goè¯­è¨€ä¸­ï¼Œå¦‚æœä½ å£°æ˜äº†ä¸€ä¸ªå˜é‡ä½†æ˜¯æ²¡æœ‰å¯¹å®ƒè¿›è¡Œèµ‹å€¼æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±ä¼šæœ‰ä¸€ä¸ªç±»å‹çš„é»˜è®¤é›¶å€¼ã€‚è¿™æ˜¯æ¯ç§ç±»å‹å¯¹åº”çš„é›¶å€¼ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span>      -&gt; <span class="literal">false</span>                              </div><div class="line">numbers -&gt; <span class="number">0</span>                                 </div><div class="line"><span class="keyword">string</span>    -&gt; <span class="string">""</span>      </div><div class="line"></div><div class="line">pointers -&gt; <span class="literal">nil</span></div><div class="line">slices -&gt; <span class="literal">nil</span></div><div class="line">maps -&gt; <span class="literal">nil</span></div><div class="line">channels -&gt; <span class="literal">nil</span></div><div class="line">functions -&gt; <span class="literal">nil</span></div><div class="line">interfaces -&gt; <span class="literal">nil</span></div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå½“ä½ å®šä¹‰äº†ä¸€ä¸ªstructï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">  AgeYears <span class="keyword">int</span></div><div class="line">  Name <span class="keyword">string</span></div><div class="line">  Friends []Person</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> p Person <span class="comment">// Person&#123;0, "", nil&#125;</span></div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢å®˜æ–¹è§£é‡Šè¿˜æœ‰ä¸€å¥<code>The &quot;nil&quot; identifier</code>,æ„æ€å°±æ˜¯è¯´nilæ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼ˆå˜é‡ï¼‰ï¼Œè¿goçš„å…³é”®å­—éƒ½ä¸ç®—ï¼Œæ˜¯ä¸€ä¸ªé¢„å®šä¹‰çš„å˜é‡è€Œå·²ï¼Œä½ ç”šè‡³å¯ä»¥æ”¹å˜å®ƒ<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="literal">nil</span> = errors.New(<span class="string">"hi"</span>)</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·æ˜¯å®Œå…¨å¯ä»¥ç¼–è¯‘å¾—è¿‡çš„ï¼Œä½†æ˜¯æœ€å¥½ä¸è¦è¿™æ ·å­å»åšã€‚</p>
<h1 id="nilæœ‰ä»€ä¹ˆç”¨"><a href="#nilæœ‰ä»€ä¹ˆç”¨" class="headerlink" title="nilæœ‰ä»€ä¹ˆç”¨"></a>nilæœ‰ä»€ä¹ˆç”¨</h1><p>åœ¨äº†è§£äº†ä»€ä¹ˆæ˜¯nilä¹‹åï¼Œå†æ¥è¯´è¯´nilæœ‰ä»€ä¹ˆç”¨ã€‚</p>
<h2 id="pointers"><a href="#pointers" class="headerlink" title="pointers"></a>pointers</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p *<span class="keyword">int</span></div><div class="line">p == <span class="literal">nil</span>    <span class="comment">// true</span></div><div class="line">*p          <span class="comment">// panic: invalid memory address or nil pointer dereference</span></div></pre></td></tr></table></figure>
<p>æŒ‡é’ˆè¡¨ç¤ºæŒ‡å‘å†…å­˜çš„åœ°å€ï¼Œå¦‚æœå¯¹ä¸ºnilçš„æŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨çš„è¯å°±ä¼šå¯¼è‡´panicã€‚é‚£ä¹ˆä¸ºnilçš„æŒ‡é’ˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå…ˆæ¥çœ‹ä¸€ä¸ªè®¡ç®—äºŒå‰æ ‘å’Œçš„ä¾‹å­ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> tree <span class="keyword">struct</span> &#123;</div><div class="line">  v <span class="keyword">int</span></div><div class="line">  l *tree</div><div class="line">  r *tree</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// first solution</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *tree)</span> <span class="title">Sum</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">  sum := t.v</div><div class="line">  <span class="keyword">if</span> t.l != <span class="literal">nil</span> &#123;</div><div class="line">    sum += t.l.Sum()</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> t.r != <span class="literal">nil</span> &#123;</div><div class="line">    sum += t.r.Sum()</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> sum</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„ä»£ç æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯ä»£ç é‡å¤ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> t.l != <span class="literal">nil</span> &#123;</div><div class="line">  <span class="comment">//....</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> t.r != <span class="literal">nil</span> &#123;</div><div class="line">  <span class="comment">//....</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¦ä¸€ä¸ªæ˜¯å½“tæ˜¯nilçš„æ—¶å€™ä¼španicï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> t *tree</div><div class="line">sum := t.Sum()   <span class="comment">// panic: invalid memory address or nil pointer dereference</span></div></pre></td></tr></table></figure></p>
<p>æ€ä¹ˆè§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸€ä¸ªæŒ‡é’ˆæ¥æ”¶å™¨çš„ä¾‹å­ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> person <span class="keyword">struct</span> &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHi</span><span class="params">(p *person)</span></span> &#123; fmt.Println(<span class="string">"hi"</span>) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *person)</span> <span class="title">sayHi</span><span class="params">()</span></span> &#123; fmt.Println(<span class="string">"hi"</span>) &#125;</div><div class="line"><span class="keyword">var</span> p *person</div><div class="line">p.sayHi() <span class="comment">// hi</span></div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œå°±æœ‰ç‚¹ç–‘é—®ï¼Œä¸ºä»€ä¹ˆ<code>t.sum()</code>ä¼šæŠ¥é”™ï¼Œè€Œ<code>p.sayHi()</code>ä¸æŠ¥é”™ï¼Œå…¶å®æ˜¯å› ä¸º<code>t.sum()</code>å‡½æ•°é‡Œé¢<code>sum := t.v</code>è¿™å¥ï¼Œå…¶å®å®ƒç›¸å½“äº<code>sum := (*t).v</code>,æ‰€ä»¥ï¼Œå¯¹äºæŒ‡é’ˆå¯¹è±¡çš„æ–¹æ³•æ¥è¯´ï¼Œå°±ç®—æŒ‡é’ˆçš„å€¼ä¸ºnilä¹Ÿæ˜¯å¯ä»¥è°ƒç”¨å®ƒä»¬çš„æ–¹æ³•,è‡³äºæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¼šä¸ä¼šæŠ¥é”™å°±è¦åšå¤„ç†äº†ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åˆšåˆšè®¡ç®—äºŒå‰æ ‘å’Œçš„ä¾‹å­è¿›è¡Œä¸€ä¸‹æ”¹é€ ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span><span class="params">(t *tree)</span> <span class="title">Sum</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">  <span class="keyword">if</span> t == <span class="literal">nil</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> t.v + t.l.Sum() + t.r.Sum()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è·Ÿåˆšæ‰çš„ä»£ç ä¸€å¯¹æ¯”æ˜¯ä¸æ˜¯ç®€æ´äº†å¾ˆå¤šï¼Ÿå¯¹äºnilæŒ‡é’ˆï¼Œåªéœ€è¦åœ¨æ–¹æ³•å‰é¢åˆ¤æ–­ä¸€ä¸‹å°±okäº†ï¼Œæ— éœ€é‡å¤åˆ¤æ–­ã€‚æ¢æˆæ‰“å°äºŒå‰æ ‘çš„å€¼æˆ–è€…æŸ¥æ‰¾äºŒå‰æ ‘çš„æŸä¸ªå€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span><span class="params">(t *tree)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">  <span class="keyword">if</span> t == <span class="literal">nil</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">""</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> fmt.Sprint(t.l, t.v, t.r)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// nil receivers are useful: Find</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *tree)</span> <span class="title">Find</span><span class="params">(v <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">  <span class="keyword">if</span> t == <span class="literal">nil</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> t.v == v || t.l.Find(v) || t.r.Find(v)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥å¦‚æœä¸æ˜¯å¾ˆéœ€è¦çš„è¯ï¼Œä¸è¦ç”¨NewX()å»åˆå§‹åŒ–å€¼ï¼Œè€Œæ˜¯ä½¿ç”¨å®ƒä»¬çš„é»˜è®¤å€¼ã€‚</p>
<h2 id="slices"><a href="#slices" class="headerlink" title="slices"></a>slices</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// nil slices</span></div><div class="line"><span class="keyword">var</span> s []slice</div><div class="line"><span class="built_in">len</span>(s)  <span class="comment">// 0</span></div><div class="line"><span class="built_in">cap</span>(s)  <span class="comment">// 0</span></div><div class="line"><span class="keyword">for</span> <span class="keyword">range</span> s  <span class="comment">// iterates zero times</span></div><div class="line">s[i]  <span class="comment">// panic: index out of range</span></div></pre></td></tr></table></figure>
<p>ä¸€ä¸ªä¸ºnilçš„sliceï¼Œé™¤äº†ä¸èƒ½ç´¢å¼•å¤–ï¼Œå…¶ä»–çš„æ“ä½œéƒ½æ˜¯å¯ä»¥çš„ï¼Œå½“ä½ éœ€è¦å¡«å……å€¼çš„æ—¶å€™å¯ä»¥ä½¿ç”¨appendå‡½æ•°ï¼Œsliceä¼šè‡ªåŠ¨è¿›è¡Œæ‰©å……ã€‚é‚£ä¹ˆä¸ºnilçš„sliceçš„åº•å±‚ç»“æ„æ˜¯æ€æ ·çš„å‘¢ï¼Ÿæ ¹æ®å®˜æ–¹çš„æ–‡æ¡£ï¼Œsliceæœ‰ä¸‰ä¸ªå…ƒç´ ï¼Œåˆ†åˆ«æ˜¯é•¿åº¦ã€å®¹é‡ã€æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼š<br><a href="http://idiotsky.me/images2/go-nil.png"><img src="http://idiotsky.me/images2/go-nil.png" alt=""></a></p>
<p>å½“æœ‰å…ƒç´ çš„æ—¶å€™ï¼š<br><a href="http://idiotsky.me/images2/go-nil-1.png"><img src="http://idiotsky.me/images2/go-nil-1.png" alt=""></a></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¹¶ä¸éœ€è¦æ‹…å¿ƒsliceçš„å¤§å°ï¼Œä½¿ç”¨appendçš„è¯sliceä¼šè‡ªåŠ¨æ‰©å®¹ã€‚</p>
<h2 id="map"><a href="#map" class="headerlink" title="map"></a>map</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// nil maps</span></div><div class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[t]u</div><div class="line"><span class="built_in">len</span>(m)  <span class="comment">// 0</span></div><div class="line"><span class="keyword">for</span> <span class="keyword">range</span> m <span class="comment">// iterates zero times</span></div><div class="line">v, ok := m[i] <span class="comment">// zero(u), false</span></div><div class="line">m[i] = x <span class="comment">// panic: assignment to entry in nil map</span></div></pre></td></tr></table></figure>
<p>å¯¹äºnilçš„mapï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æŠŠå®ƒçœ‹æˆæ˜¯ä¸€ä¸ªåªè¯»çš„mapï¼Œä¸èƒ½è¿›è¡Œå†™æ“ä½œï¼Œå¦åˆ™å°±ä¼španicã€‚é‚£ä¹ˆnilçš„mapæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿçœ‹ä¸€ä¸‹è¿™ä¸ªä¾‹å­ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGet</span><span class="params">(url <span class="keyword">string</span>, headers <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span> <span class="params">(*http.Request, error)</span></span> &#123;</div><div class="line">  req, err := http.NewRequest(http.MethodGet, url, <span class="literal">nil</span>)</div><div class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> k, v := <span class="keyword">range</span> headers &#123;</div><div class="line">    req.Header.Set(k, v)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> req, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯¹äºNewGetæ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸€ä¸ªç±»å‹ä¸ºmapçš„å‚æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°åªæ˜¯å¯¹è¿™ä¸ªå‚æ•°è¿›è¡Œè¯»å–ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªéç©ºçš„å€¼ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NewGet(<span class="string">"http://google.com"</span>, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</div><div class="line">  <span class="string">"USER_AGENT"</span>: <span class="string">"golang/gopher"</span>,</div><div class="line">&#125;,)</div></pre></td></tr></table></figure></p>
<p>æˆ–è€…è¿™æ ·ä¼ ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NewGet(<span class="string">"http://google.com"</span>, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;&#125;)</div></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯å‰é¢ä¹Ÿè¯´äº†ï¼Œmapçš„é›¶å€¼æ˜¯nilï¼Œæ‰€ä»¥å½“headerä¸ºç©ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä¼ å…¥ä¸€ä¸ªnilï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NewGet(<span class="string">"http://google.com"</span>, <span class="literal">nil</span>)</div></pre></td></tr></table></figure></p>
<p>æ˜¯ä¸æ˜¯ç®€æ´å¾ˆå¤šï¼Ÿæ‰€ä»¥ï¼ŒæŠŠnil mapä½œä¸ºä¸€ä¸ªåªè¯»çš„ç©ºçš„mapè¿›è¡Œè¯»å–å§ã€‚</p>
<h2 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// nil channels</span></div><div class="line"><span class="keyword">var</span> c <span class="keyword">chan</span> t</div><div class="line">&lt;- c      <span class="comment">// blocks forever</span></div><div class="line">c &lt;- x    <span class="comment">// blocks forever</span></div><div class="line"><span class="built_in">close</span>(c)  <span class="comment">// panic: close of nil channel</span></div></pre></td></tr></table></figure>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ç°åœ¨æœ‰ä¸¤ä¸ªchannelè´Ÿè´£è¾“å…¥ï¼Œä¸€ä¸ªchannelè´Ÿè´£æ±‡æ€»ï¼Œç®€å•çš„å®ç°ä»£ç ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(out <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>, a, b &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">  <span class="keyword">for</span> &#123;</div><div class="line">    <span class="keyword">select</span> &#123;</div><div class="line">      <span class="keyword">case</span> v := &lt;-a:</div><div class="line">        out &lt;- v</div><div class="line">      <span class="keyword">case</span> v := &lt;- b:</div><div class="line">        out &lt;- v</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¦‚æœåœ¨å¤–éƒ¨è°ƒç”¨ä¸­å…³é—­äº†aæˆ–è€…bï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­åœ°ä»aæˆ–è€…bä¸­è¯»å‡º0ï¼Œè¿™å’Œæˆ‘ä»¬æƒ³è¦çš„ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬æƒ³å…³é—­aå’Œbåå°±åœæ­¢æ±‡æ€»äº†ï¼Œä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">merge</span><span class="params">(out <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>, a, b &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">  <span class="keyword">for</span> a != <span class="literal">nil</span> || b != <span class="literal">nil</span> &#123;</div><div class="line">    <span class="keyword">select</span> &#123;</div><div class="line">      <span class="keyword">case</span> v, ok := &lt;-a:</div><div class="line">          <span class="keyword">if</span> !ok &#123;</div><div class="line">            a = <span class="literal">nil</span></div><div class="line">            fmt.Println(<span class="string">"a is nil"</span>)</div><div class="line">            <span class="keyword">continue</span></div><div class="line">          &#125;</div><div class="line">          out &lt;- v</div><div class="line">      <span class="keyword">case</span> v, ok := &lt;-b:</div><div class="line">          <span class="keyword">if</span> !ok &#123;</div><div class="line">            b = <span class="literal">nil</span></div><div class="line">            fmt.Println(<span class="string">"b is nil"</span>)</div><div class="line">            <span class="keyword">continue</span></div><div class="line">          &#125;</div><div class="line">          out &lt;- v</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  fmt.Println(<span class="string">"close out"</span>)</div><div class="line">  <span class="built_in">close</span>(out)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨çŸ¥é“channelå…³é—­åï¼Œå°†channelçš„å€¼è®¾ä¸ºnilï¼Œè¿™æ ·å­å°±ç›¸å½“äºå°†è¿™ä¸ªselect caseå­å¥åœç”¨äº†ï¼Œå› ä¸ºnilçš„channelæ˜¯æ°¸è¿œé˜»å¡çš„ã€‚</p>
<h2 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h2><p>interfaceå¹¶ä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒçš„åº•å±‚å®ç°ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯ç±»å‹ï¼Œä¸€ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯ç±»ä¼¼äºï¼š(Type, Value)ã€‚åªæœ‰å½“ç±»å‹å’Œå€¼éƒ½æ˜¯nilçš„æ—¶å€™ï¼Œæ‰ç­‰äºnilã€‚çœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> doError <span class="keyword">struct</span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *doError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">""</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">do</span><span class="params">()</span> <span class="title">error</span></span> &#123;   <span class="comment">// error(*doError, nil)</span></div><div class="line">	<span class="keyword">var</span> err *doError</div><div class="line">	<span class="keyword">return</span> err  <span class="comment">// nil of type *doError</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	err := do()</div><div class="line">	fmt.Println(err == <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœæ˜¯falseã€‚doå‡½æ•°å£°æ˜äº†ä¸€ä¸ª*doErroçš„å˜é‡errï¼Œç„¶åè¿”å›ï¼Œè¿”å›å€¼æ˜¯erroræ¥å£ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™çš„Typeå·²ç»å˜æˆäº†ï¼šï¼ˆ*doErrorï¼Œnilï¼‰ï¼Œæ‰€ä»¥å’Œnilè‚¯å®šæ˜¯ä¸ä¼šç›¸ç­‰çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨å†™å‡½æ•°çš„æ—¶å€™ï¼Œä¸è¦å£°æ˜å…·ä½“çš„errorå˜é‡ï¼Œè€Œæ˜¯åº”è¯¥ç›´æ¥è¿”å›nilï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">do</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å†æ¥çœ‹çœ‹è¿™ä¸ªä¾‹å­ï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">do</span><span class="params">()</span> *<span class="title">doError</span></span> &#123;  <span class="comment">// nil of type *doError</span></div><div class="line">  <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">wrapDo</span><span class="params">()</span> <span class="title">error</span></span> &#123; <span class="comment">// error (*doError, nil)</span></div><div class="line">  <span class="keyword">return</span> do()       <span class="comment">// nil of type *doError</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  err := wrapDo()   <span class="comment">// error  (*doError, nil)</span></div><div class="line">  fmt.Println(err == <span class="literal">nil</span>) <span class="comment">// false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œæœ€ç»ˆçš„è¾“å‡ºç»“æœä¹Ÿæ˜¯falseã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå°½ç®¡wrapDoå‡½æ•°è¿”å›çš„æ˜¯errorç±»å‹ï¼Œä½†æ˜¯doè¿”å›çš„å´æ˜¯*doErrorç±»å‹ï¼Œä¹Ÿå°±æ˜¯å˜æˆäº†ï¼ˆ*doErrorï¼Œnilï¼‰ï¼Œè‡ªç„¶ä¹Ÿå°±å’Œnilä¸ç›¸ç­‰äº†ã€‚å› æ­¤ï¼Œä¸è¦è¿”å›å…·ä½“çš„é”™è¯¯ç±»å‹ã€‚éµä»è¿™ä¸¤æ¡å»ºè®®ï¼Œæ‰å¯ä»¥æ”¾å¿ƒåœ°ä½¿ç”¨<code>if x != nil</code>ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>nilæŒ‡é’ˆå¯ä»¥æ‰§è¡Œæ–¹æ³•ï¼Œnilçš„mapå’Œsliceåªæ˜¯å¯è¯»ï¼Œnilçš„chanå¯ä»¥ç”¨æ¥åšä¸ºselectçš„åœæ­¢æ ‡è®°ï¼Œè€Œnilçš„interfaceå¯èƒ½å°±æ˜¯ä¸ªå‘ğŸ‘¿</p>
<p>å‚è€ƒ <a href="https://www.jianshu.com/p/dd80f6be7969" target="_blank" rel="external">https://www.jianshu.com/p/dd80f6be7969</a><br>éƒ¨åˆ†ä»£ç  <a href="https://github.com/ejunjsh/go-code/tree/master/nil" target="_blank" rel="external">https://github.com/ejunjsh/go-code/tree/master/nil</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;nilæ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#nilæ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; title=&quot;nilæ˜¯ä»€ä¹ˆ&quot;&gt;&lt;/a&gt;nilæ˜¯ä»€ä¹ˆ&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;The â€œnilâ€ identifier can be used as the â€œzero valueâ€ for interfaces, functions, pointers, maps, slices, and channels&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™æ˜¯å¯¹nilçš„å®˜æ–¹è§£é‡Šï¼Œæ„æ€å°±æ˜¯è¯´nilæ˜¯æ¥å£ï¼Œå‡½æ•°ï¼ŒæŒ‡é’ˆï¼Œmapï¼Œsliceå’Œç®¡é“çš„é›¶å€¼ã€‚é›¶å€¼ï¼Œzero valueï¼Œåœ¨Goè¯­è¨€ä¸­ï¼Œå¦‚æœä½ å£°æ˜äº†ä¸€ä¸ªå˜é‡ä½†æ˜¯æ²¡æœ‰å¯¹å®ƒè¿›è¡Œèµ‹å€¼æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±ä¼šæœ‰ä¸€ä¸ªç±»å‹çš„é»˜è®¤é›¶å€¼ã€‚è¿™æ˜¯æ¯ç§ç±»å‹å¯¹åº”çš„é›¶å€¼ï¼š&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;      -&amp;gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;                              &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;numbers -&amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;                                 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;string&lt;/span&gt;    -&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;      &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;pointers -&amp;gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;slices -&amp;gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;maps -&amp;gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;channels -&amp;gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;functions -&amp;gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;interfaces -&amp;gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.me/categories/go/"/>
    
    
      <category term="go" scheme="http://idiotsky.me/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>jvm full gc è§£æƒ‘</title>
    <link href="http://idiotsky.me/2017/11/06/java-fullgc/"/>
    <id>http://idiotsky.me/2017/11/06/java-fullgc/</id>
    <published>2017-11-06T10:03:15.000Z</published>
    <updated>2017-11-07T14:09:00.804Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ä¸€ç›´ä»¥æ¥ï¼Œéƒ½è§‰å¾—full gcå°±æ˜¯å¯¹oldåŒºçš„gcï¼Œç„¶åå°±æ‰“è„¸äº†ã€‚ã€‚ã€‚ã€‚</p>
</blockquote>
<p>ä¸‹é¢å…ˆå¼•ç”¨Rå¤§çš„åŸæ–‡ï¼š</p>
<blockquote>
<p>é’ˆå¯¹HotSpot VMçš„å®ç°ï¼Œå®ƒé‡Œé¢çš„GCå…¶å®å‡†ç¡®åˆ†ç±»åªæœ‰ä¸¤å¤§ç§ï¼š</p>
<ul>
<li>Partial GCï¼šå¹¶ä¸æ”¶é›†æ•´ä¸ªGCå †çš„æ¨¡å¼<ul>
<li>Young GCï¼šåªæ”¶é›†young gençš„GC</li>
<li>Old GCï¼šåªæ”¶é›†old gençš„GCã€‚åªæœ‰CMSçš„concurrent collectionæ˜¯è¿™ä¸ªæ¨¡å¼</li>
<li>Mixed GCï¼šæ”¶é›†æ•´ä¸ªyoung genä»¥åŠéƒ¨åˆ†old gençš„GCã€‚åªæœ‰G1æœ‰è¿™ä¸ªæ¨¡å¼</li>
</ul>
</li>
<li>Full GCï¼šæ”¶é›†æ•´ä¸ªå †ï¼ŒåŒ…æ‹¬young genã€old genã€perm genï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ç­‰æ‰€æœ‰éƒ¨åˆ†çš„æ¨¡å¼ã€‚</li>
</ul>
</blockquote>
<a id="more"></a>
<blockquote>
<p>Major GCé€šå¸¸æ˜¯è·Ÿfull GCæ˜¯ç­‰ä»·çš„ï¼Œæ”¶é›†æ•´ä¸ªGCå †ã€‚ä½†å› ä¸ºHotSpot VMå‘å±•äº†è¿™ä¹ˆå¤šå¹´ï¼Œå¤–ç•Œå¯¹å„ç§åè¯çš„è§£è¯»å·²ç»å®Œå…¨æ··ä¹±äº†ï¼Œå½“æœ‰äººè¯´â€œmajor GCâ€çš„æ—¶å€™ä¸€å®šè¦é—®æ¸…æ¥šä»–æƒ³è¦æŒ‡çš„æ˜¯ä¸Šé¢çš„full GCè¿˜æ˜¯old GCã€‚</p>
<p>æœ€ç®€å•çš„åˆ†ä»£å¼GCç­–ç•¥ï¼ŒæŒ‰HotSpot VMçš„serial GCçš„å®ç°æ¥çœ‹ï¼Œè§¦å‘æ¡ä»¶æ˜¯ï¼š</p>
<ul>
<li>young GCï¼šå½“young genä¸­çš„edenåŒºåˆ†é…æ»¡çš„æ—¶å€™è§¦å‘ã€‚æ³¨æ„young GCä¸­æœ‰éƒ¨åˆ†å­˜æ´»å¯¹è±¡ä¼šæ™‹å‡åˆ°old genï¼Œæ‰€ä»¥young GCåold gençš„å ç”¨é‡é€šå¸¸ä¼šæœ‰æ‰€å‡é«˜ã€‚</li>
<li>full GCï¼šå½“å‡†å¤‡è¦è§¦å‘ä¸€æ¬¡young GCæ—¶ï¼Œå¦‚æœå‘ç°ç»Ÿè®¡æ•°æ®è¯´ä¹‹å‰young GCçš„å¹³å‡æ™‹å‡å¤§å°æ¯”ç›®å‰old genå‰©ä½™çš„ç©ºé—´å¤§ï¼Œåˆ™ä¸ä¼šè§¦å‘young GCè€Œæ˜¯è½¬ä¸ºè§¦å‘full GCï¼ˆå› ä¸ºHotSpot VMçš„GCé‡Œï¼Œé™¤äº†CMSçš„concurrent collectionä¹‹å¤–ï¼Œå…¶å®ƒèƒ½æ”¶é›†old gençš„GCéƒ½ä¼šåŒæ—¶æ”¶é›†æ•´ä¸ªGCå †ï¼ŒåŒ…æ‹¬young genï¼Œæ‰€ä»¥ä¸éœ€è¦äº‹å…ˆè§¦å‘ä¸€æ¬¡å•ç‹¬çš„young GCï¼‰ï¼›æˆ–è€…ï¼Œå¦‚æœæœ‰perm gençš„è¯ï¼Œè¦åœ¨perm genåˆ†é…ç©ºé—´ä½†å·²ç»æ²¡æœ‰è¶³å¤Ÿç©ºé—´æ—¶ï¼Œä¹Ÿè¦è§¦å‘ä¸€æ¬¡full GCï¼›æˆ–è€…System.gc()ã€heap dumpå¸¦GCï¼Œé»˜è®¤ä¹Ÿæ˜¯è§¦å‘full GCã€‚</li>
</ul>
<p>HotSpot VMé‡Œå…¶å®ƒéå¹¶å‘GCçš„è§¦å‘æ¡ä»¶å¤æ‚ä¸€äº›ï¼Œä¸è¿‡å¤§è‡´çš„åŸç†ä¸ä¸Šé¢è¯´çš„å…¶å®ä¸€æ ·ã€‚å½“ç„¶ä¹Ÿæ€»æœ‰ä¾‹å¤–ã€‚Parallel Scavengeï¼ˆ-XX:+UseParallelGCï¼‰æ¡†æ¶ä¸‹ï¼Œé»˜è®¤æ˜¯åœ¨è¦è§¦å‘full GCå‰å…ˆæ‰§è¡Œä¸€æ¬¡young GCï¼Œå¹¶ä¸”ä¸¤æ¬¡GCä¹‹é—´èƒ½è®©åº”ç”¨ç¨‹åºç¨å¾®è¿è¡Œä¸€å°ä¸‹ï¼Œä»¥æœŸé™ä½full GCçš„æš‚åœæ—¶é—´ï¼ˆå› ä¸ºyoung GCä¼šå°½é‡æ¸…ç†äº†young gençš„æ­»å¯¹è±¡ï¼Œå‡å°‘äº†full GCçš„å·¥ä½œé‡ï¼‰ã€‚æ§åˆ¶è¿™ä¸ªè¡Œä¸ºçš„VMå‚æ•°æ˜¯-XX:+ScavengeBeforeFullGCã€‚è¿™æ˜¯HotSpot VMé‡Œçš„å¥‡è‘©å—¯ã€‚</p>
<p>å¹¶å‘GCçš„è§¦å‘æ¡ä»¶å°±ä¸å¤ªä¸€æ ·ã€‚ä»¥CMS GCä¸ºä¾‹ï¼Œå®ƒä¸»è¦æ˜¯å®šæ—¶å»æ£€æŸ¥old gençš„ä½¿ç”¨é‡ï¼Œå½“ä½¿ç”¨é‡è¶…è¿‡äº†è§¦å‘æ¯”ä¾‹å°±ä¼šå¯åŠ¨ä¸€æ¬¡CMS GCï¼Œå¯¹old genåšå¹¶å‘æ”¶é›†ã€‚</p>
</blockquote>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ol>
<li>full gc æ˜¯å…¨åŒºå›æ”¶(æ‰“è„¸)</li>
<li>full gc ä¹‹å‰ä¸ä¼šè§¦å‘young gcï¼ˆä¸€èˆ¬æƒ…å†µï¼‰</li>
</ol>
<p>å†å¼•ç”¨ä¸‹åˆ«çš„å¤§ç‰›çš„è¯ï¼š</p>
<blockquote>
<p>å…ˆçœ‹ä¸€ä¸‹HotSpot VMçš„GCå®¶æ—çš„ç»„åˆç¤ºæ„å›¾ï¼š<br><a href="http://idiotsky.me/images1/java-fullgc-1.jpg"><img src="http://idiotsky.me/images1/java-fullgc-1.jpg" alt=""></a><br>ä¸åŒçš„GCç»„åˆå¥—è£…ä¹‹ä¸­ï¼Œå…·å¤‡Full GCèƒ½åŠ›çš„å¤§æ¦‚æœ‰ä¸‰ç§ï¼š</p>
<ol>
<li>ParallelOld(PSMarkSweep)</li>
<li>Serial Old(MarkSweep)</li>
<li>â€œ?â€æ‰€ä»£è¡¨çš„G1</li>
</ol>
<p>æš‚ä¸è€ƒè™‘G1ï¼Œé™¤äº†CMSå…·å¤‡åœ¨å¹´è€ä»£è¿›è¡ŒMajor GCä¹‹å¤–ï¼Œå…¶ä»–æƒ…å†µä¸‹å¹´è€ä»£çš„GCéƒ½æ˜¯ç”±Full GCè§¦å‘çš„ã€‚Full GCçš„æ”¶é›†èŒƒå›´åŒ…å«æ•´ä¸ªHeapåŒºåŸŸ( Eden + S1 + S2 + Tenured)ï¼Œå®ƒå‘ç”Ÿæ—¶Mutatoråœæ­¢å·¥ä½œâ€”â€”Stop The Worldã€‚å¯¹äºSerial Collectorï¼Œå®ƒé‡‡ç”¨MSC(Mark-Sweep-Compact)çš„ç®—æ³•å¯¹å…¨å †è¿›è¡ŒFull GCï¼Œåœ¨HotSpot VMçš„å®ç°ä¸­ï¼Œä¸»è¦ç”¨MarkSweepè¿™ä¸ªç±»æ¥å®ç°ï¼›å¯¹äºParallel Collectorè€Œè¨€ï¼ŒPSMarkSweepæ˜¯å¤šçº¿ç¨‹çš„MarkSweepï¼Œåä¸å‰¯å®ï¼Œè¿™ç©æ„å„¿å…¶å®æ˜¯ä¸ªå®ç°äº†Lisp2çš„Mark-Compact GCç®—æ³•ã€‚PSMarkSweepæœ‰ä¸ªç‰¹æ®Šçš„åœ°æ–¹æ˜¯å¦‚æœé…ç½®äº†<strong>ScavengeBeforeFullGC</strong> è¿™ä¸ªflagï¼Œåˆ™ä¼šåœ¨Full GCä¹‹å‰å¯¹å¹´è½»ä»£è¿›è¡Œä¸€æ¬¡Minor GCï¼›å…¶ä»–æƒ…å†µæ ¹æœ¬ä¸éœ€è¦Full GCä¹‹å‰å…ˆæ‰§è¡ŒMinor GCï¼ŒFull GCä¼šå¯¹å¹´è½»ä»£å‘èµ·GCã€‚Full GCå‰åHeapçš„å¯¹æ¯”ç¤ºæ„å‚è§ï¼š<br><a href="http://idiotsky.me/images1/java-fullgc-2.jpg"><img src="http://idiotsky.me/images1/java-fullgc-2.jpg" alt=""></a></p>
<p>å¯è§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¹´è½»ä»£çš„å­˜æ´»å¯¹è±¡éƒ½è¢«Compactåˆ°äº†å¹´è€ä»£ï¼Œæ‰€ä»¥ï¼Œä½ çœ‹åˆ°å¹´è½»ä»£éƒ½è¢«æ¸…ç©ºäº†ï¼›åªæœ‰å½“å¹´è€ä»£æ»¡äº†çš„æ—¶å€™ï¼Œæ‰ä¼šCompactåˆ°EdenåŒºåŸŸã€‚</p>
<p>å¯¹äºConcurrent Collectorï¼ŒCMSåœ¨Remark Phaseï¼Œå¯ä»¥é€šè¿‡è®¾ç½® <strong>CMSScavengeBeforeRemark</strong> åœ¨remarkä¹‹å‰å…ˆè¡ŒYGCï¼Œè¿™ç»™äº†CMSåœ¨Major GCæ—¶è§¦å‘Minor GCçš„æœºä¼šï¼Œä½†è¿™ä¸ªFlagé»˜è®¤æ˜¯falseï¼›å½“CMSå‘ç”Ÿ <strong>Concurrent Mode Failure</strong> æ—¶ï¼ŒCMSä¼šé€€åŒ–ä¸ºSerial Old GCï¼Œä»è€Œé‡‡ç”¨ä¸Serial Collectorç›¸åŒçš„ç®—æ³•è¿›è¡ŒFull GCã€‚CMSå‘ç”Ÿ <strong>Concurrent Mode Failure</strong> çš„åŸå› ï¼š1. å› ä¸ºæ˜¯å¹¶å‘æ”¶é›†ï¼Œæ‰€ä»¥Mutatorä»å¯èƒ½åœ¨ä¸æ–­å ç”¨å¹´è€ä»£çš„ç©ºé—´ï¼Œå½“ç„¶è¿˜åŒ…æ‹¬è¿™ä¸€è¶Ÿæ— æ³•æ”¶é›†çš„Float Garbageä¼šå ç”¨å†…å­˜ç©ºé—´ï¼Œå¦‚æœå¹´è€ä»£ç©ºé—´è¢«å æ»¡ä½†å¹¶å‘æ”¶é›†è¿˜æœªç»“æŸï¼Œå°±ä¼šå‘ç”Ÿå¹¶å‘æ¨¡å¼å¤±è´¥ï¼›2. å› ä¸ºCMSé‡‡ç”¨çš„æ˜¯Mark Sweepç®—æ³•ï¼Œæœ¬èº«å†…å­˜ç¢ç‰‡åŒ–æ— æ³•è§£å†³ï¼Œå¾ˆå¯èƒ½å‘ç”Ÿå¤§å¯¹è±¡åˆ†é…æ—¶æ²¡æœ‰è¿ç»­ç©ºé—´ï¼Œæˆ–è€…æœ¬èº«å‰©ä½™ç©ºé—´ä¸å¤Ÿå¤§å¯¹è±¡åˆ†é…æ—¶ï¼Œä¹Ÿä¼šå‘ç”Ÿå¹¶å‘æ¨¡å¼å¤±è´¥ã€‚</p>
</blockquote>
<p>å†æ€»ç»“ä¸‹:</p>
<ol>
<li>Serial Old åšfull gc æ—¶å€™ä¸ä¼šæ‰§è¡Œyoung gcï¼Œè€Œ ParallelOld ä¼šæ ¹æ® <strong>ScavengeBeforeFullGC</strong> æ¥å†³å®šæ˜¯å¦åœ¨full gcå‰æ‰§è¡Œä¸€æ¬¡young gc</li>
<li>CMS æœ‰è‡ªå·±çš„major gcï¼Œå•ç‹¬æ‰§è¡ŒoldåŒºçš„gcï¼Œä½†æ˜¯å¦‚æœ <strong>Concurrent Mode Failure</strong> çš„è¯ï¼Œå°±è¿˜æ˜¯è€è€å®å®åšSerial Oldçš„full gcå§ã€‚</li>
<li>CMS çš„ <strong>CMSScavengeBeforeRemark</strong> æ ‡è®°å†³å®šäº†æ˜¯å¦åœ¨remarké˜¶æ®µä¹‹å‰æ‰§è¡Œä¸€æ¬¡young gcï¼ˆç½‘ä¸Šè¯´è¿™ä¸ªæ ‡è®°è¿˜èƒ½è§£å†³è·¨ä»£å¼•ç”¨é—®é¢˜ï¼‰ï¼Œ</li>
</ol>
<p>å‚è€ƒ <a href="https://www.zhihu.com/question/62604570" target="_blank" rel="external">https://www.zhihu.com/question/62604570</a><br>å‚è€ƒ <a href="https://www.zhihu.com/question/41922036" target="_blank" rel="external">https://www.zhihu.com/question/41922036</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸€ç›´ä»¥æ¥ï¼Œéƒ½è§‰å¾—full gcå°±æ˜¯å¯¹oldåŒºçš„gcï¼Œç„¶åå°±æ‰“è„¸äº†ã€‚ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸‹é¢å…ˆå¼•ç”¨Rå¤§çš„åŸæ–‡ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;é’ˆå¯¹HotSpot VMçš„å®ç°ï¼Œå®ƒé‡Œé¢çš„GCå…¶å®å‡†ç¡®åˆ†ç±»åªæœ‰ä¸¤å¤§ç§ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Partial GCï¼šå¹¶ä¸æ”¶é›†æ•´ä¸ªGCå †çš„æ¨¡å¼&lt;ul&gt;
&lt;li&gt;Young GCï¼šåªæ”¶é›†young gençš„GC&lt;/li&gt;
&lt;li&gt;Old GCï¼šåªæ”¶é›†old gençš„GCã€‚åªæœ‰CMSçš„concurrent collectionæ˜¯è¿™ä¸ªæ¨¡å¼&lt;/li&gt;
&lt;li&gt;Mixed GCï¼šæ”¶é›†æ•´ä¸ªyoung genä»¥åŠéƒ¨åˆ†old gençš„GCã€‚åªæœ‰G1æœ‰è¿™ä¸ªæ¨¡å¼&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Full GCï¼šæ”¶é›†æ•´ä¸ªå †ï¼ŒåŒ…æ‹¬young genã€old genã€perm genï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ç­‰æ‰€æœ‰éƒ¨åˆ†çš„æ¨¡å¼ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="jvm" scheme="http://idiotsky.me/tags/jvm/"/>
    
      <category term="gc" scheme="http://idiotsky.me/tags/gc/"/>
    
  </entry>
  
  <entry>
    <title>Gitå…ˆç”Ÿçš„æ•…äº‹</title>
    <link href="http://idiotsky.me/2017/11/05/git-story/"/>
    <id>http://idiotsky.me/2017/11/05/git-story/</id>
    <published>2017-11-05T14:44:05.000Z</published>
    <updated>2017-11-07T14:52:01.852Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>å¾ˆæœ‰æ„æ€çš„é€šä¿—çš„æ€»ç»“äº†gitã€‚ğŸ‘¿</p>
</blockquote>
<p>Gitå…ˆç”Ÿæ˜¯ä¸€ä½å¾ˆå‡ºåçš„æ‘„å½±ä¸“å®¶ï¼Œä»–çš„ä¸»è¦èŒè´£æ˜¯ç”¨å®ƒå¼ºå¤§çš„æ‹æ‘„æŠ€æœ¯å¸®æˆ‘ä»¬å…±äº«æˆæœï¼Œå…±åˆ›æœªæ¥ã€‚ä¸ºæ­¤å®ƒå‡†å¤‡äº†è®¸è®¸å¤šå¤šçš„å·¥å…·æ¥å®ç°è¿™æ ·çš„ç›®æ ‡ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹Gitå…ˆç”Ÿçš„å·¥ä½œåœºæ‰€ï¼Œå’Œä»–ä¸ºæˆ‘ä»¬çš„ä¸€äº›ç—›ç‚¹å¸¦æ¥äº†å“ªäº›è§£å†³æ–¹æ¡ˆå§ã€‚</p>
<h1 id="åˆæ¬¡è§é¢"><a href="#åˆæ¬¡è§é¢" class="headerlink" title="åˆæ¬¡è§é¢"></a>åˆæ¬¡è§é¢</h1><p>è€æ¿ï¼ˆç”¨æˆ·è‡ªå·±ï¼‰æ–°ä¹°äº†ä¸€å—åœ°çš®ï¼ˆåˆ›å»ºäº†ä¸€ä¸ªç›®å½•ï¼‰ï¼Œæƒ³è˜è¯·Gitå…ˆç”Ÿåˆ°æ­¤å¼€è®¾ä¸€ä¸ªå·¥ä½œå®¤æ¥åŠ å¿«è¿™ä¸ªåœ°çš®çš„å»ºè®¾å·¥ä½œã€‚è€æ¿ç”¨<code>git init</code> æ‹›æ¥äº†Gitå…ˆç”Ÿï¼ŒGitå…ˆç”Ÿåœ¨è¯¥ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª.gitç›®å½•ï¼Œç”¨æ¥ä½œä¸ºè‡ªå·±çš„åŠå…¬å®¤ï¼ŒåŠå…¬å®¤ç”¨æ¥è®°å½•è‡ªå·±çš„å·¥ä½œæ—¥å¿—å’Œæˆæœã€‚</p>
<p>è®©æˆ‘ä»¬æ¥ä»ç©ºä¸­ä¿¯ç°ä¸‹è¿™å—æ–°çš„åœ°çš®ï¼Œå’ŒGitå…ˆç”Ÿä¸ºå®ƒæ‰€è®¾è®¡çš„è“å›¾å§ã€‚<br><a href="http://idiotsky.me/images1/git-story-1.jpg"><img src="http://idiotsky.me/images1/git-story-1.jpg" alt=""></a></p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥è§£é‡Šä¸‹ï¼Œè¿™å‡ ä¸ªåŒºåŸŸçš„ä½œç”¨ï¼š<br>Working Directoryï¼šGitå…ˆç”Ÿçš„è€æ¿æ‰€ä¹°ä¸‹çš„åœ°çš®ï¼Œè¿™ä¸ªæ˜¯å®å®åœ¨åœ¨ç‰©ç†å±‚é¢çš„åœ°çš®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢ç§äº›èŠ±èŠ±è‰è‰ï¼Œå»ºç‚¹é«˜æ¥¼å¤§å¦å•¥çš„ã€‚</p>
<p>Staging Areaï¼šGitå…ˆç”Ÿæ‘„å½±æ£šæ‰€åœ¨åœ°ï¼Œä½ç½®ä½äºGitå…ˆç”Ÿçš„åŠå…¬å®¤ã€‚æ¯å½“è€æ¿å®Œæˆäº†æŸä»¶åå‚é’å²çš„ä¼Ÿäº‹ï¼Œä»–å°±ä¼šå‘½ä»¤Gitå…ˆç”ŸæŠŠè‡ªå·±è¿™ä¸ªé˜¶æ®µæ‰€å¹²çš„äº‹æƒ…ä¸€äº”ä¸€åçš„æ¬åˆ°æ‘„å½±æ£šæ‹ç…§è®°å½•ä¸‹æ¥ã€‚<code>git add</code> å°±æ˜¯æŠŠä¿®æ”¹æ¬åˆ°æ‘„å½±æ£šï¼Œ<code>git commit</code>å°±æ˜¯å‘½ä»¤Gitå…ˆç”Ÿæ‹ç…§ï¼Œè€Œæ‹å®Œç…§åï¼Œæ‘„å½±æ£šé©¬ä¸Šä¼šè¢«æ‰“æ‰«å¹²å‡€ã€‚</p>
<p>Repositoryï¼šGitå…ˆç”ŸåŠå…¬å®¤çš„æŸä¸ªåŒºåŸŸï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨ç…§ç‰‡ç”¨çš„ã€‚</p>
<p>Remoteï¼šè¿™æ˜¯ä¸€å—äº‘ç«¯åŒºåŸŸï¼ŒGitå…ˆç”Ÿä¼šåœ¨å·¥ä½œå®Œä¸€æ®µæ—¶é—´åï¼Œå°±æŠŠè‡ªå·±çš„ä½œå“ä¸Šä¼ ä¸Šå»ã€‚è¿™æ ·åšï¼Œä¸€æ–¹é¢æ˜¯ç”¨æ¥ä¿å­˜è‡ªå·±çš„ä½œå“ï¼Œä»¥å¤‡æ„å¤–å‘ç”Ÿï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯æä¾›ç»™å…¶ä»–æœ‰å…´è¶£çš„è€æ¿ä»¬ä¸€èµ·åšè¿™ä¸ªé¡¹ç›®ã€‚<br><a id="more"></a></p>
<h1 id="Go-to-work"><a href="#Go-to-work" class="headerlink" title="Go to work"></a>Go to work</h1><p>ä¸€åˆ‡å‡†å¤‡å¦¥å½“åï¼ŒGitå…ˆç”Ÿé©¬ä¸Šå°±æŠ•å…¥åˆ°äº†ç´§å¼ çš„å·¥ä½œå½“ä¸­ã€‚è€æ¿é¦–å…ˆå°±è¿«ä¸åŠå¾…çš„åœ¨åœ°çš®ä¸Šä¸Šç§äº†ä¸€æœµèŠ±ï¼Œç„¶åé©¬ä¸Šå‘½ä»¤Gitæ¥æ‹ç…§ç•™å¿µã€‚<br><a href="http://idiotsky.me/images1/git-story-2.jpg"><img src="http://idiotsky.me/images1/git-story-2.jpg" alt=""></a><br>å½“ç„¶ç»“æœæ˜¯å¤±è´¥çš„ï¼ŒGitä¹Ÿå¾ˆè‹¦æ¼ï¼Œè‡ªå·±å·²ç»æŠŠæ‰€æœ‰æµç¨‹å’Œè€æ¿è¯´è¿‡ä¸€éäº†ï¼Œä½†è€æ¿è¿˜æ˜¯ä¼šé²è½è¡Œäº‹ã€‚ç„¶åGitå…ˆç”Ÿåˆå‘è€æ¿è€å¿ƒçš„è§£é‡Šäº†ä¸€ä¸‹é’ˆå¯¹Gitç›®å½•ä¸‹æŸä¸ªä¿®æ”¹çš„4ç§çŠ¶æ€ã€‚</p>
<blockquote>
<p>Untracked/Tracked<br>Not Staged/Staged<br>æ¯”å¦‚ä½ æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒçš„çŠ¶æ€å°±æ˜¯ Untracked çš„ï¼Œä½ ä¸èƒ½å¯¹ Untracked çš„æ–‡ä»¶è¿›è¡Œä»»ä½•Gitæ“ä½œï¼Œé™¤äº†å…ˆä½¿ç”¨<code>git add</code> è®©å®ƒå…ˆå˜ä¸ºTracked çŠ¶æ€ã€‚ä¸€ä¸ªæ–‡ä»¶è¢«Trackåï¼Œä»¥åçš„ä¿®æ”¹å¦‚æœæœªç”¨<code>git add</code>ï¼Œé‚£è¿™ä¸ªä¿®æ”¹å°±å«Not Stagedï¼Œéœ€è¦addåï¼Œè®©å®ƒå˜ä¸ºStagedæ‰èƒ½è¿›è¡ŒCommitã€‚</p>
</blockquote>
<p>è€æ¿æŒ‰ç…§Gitå…ˆç”Ÿçš„è¯´æ³•åˆæ‰§è¡Œäº†ä¸€éï¼Œè¿™æ¬¡ä»–æˆåŠŸäº†ã€‚Gitåˆå‘è€æ¿è¯´ï¼Œä½ å¯ä»¥ç”¨<code>git log</code>æ¥æŸ¥çœ‹æˆ‘å·²ç»æ‹è¿‡çš„ç…§ç‰‡ã€‚</p>
<p>è€æ¿å­¦ä¼šè¿™æ‹›åï¼Œåˆç»™è¿™å—åœ°çš®åˆ›å»ºäº†æ ‘ã€è‰ï¼Œå¹¶ä¸”ä¹Ÿéƒ½åˆ†åˆ«è®©Gitå…ˆç”Ÿæ‹äº†ç…§ç‰‡ä¿å­˜ã€‚</p>
<p><code>git log</code>åæˆ‘ä»¬çœ‹åˆ°äº†è¿™ä¸‰å¼ ç…§ç‰‡ï¼Œå¦‚æœè¦æŸ¥çœ‹è¯¦æƒ…è¿˜å¯ä»¥ä½¿ç”¨<code>git log -p</code>ã€‚<br><a href="http://idiotsky.me/images1/git-story-3.jpg"><img src="http://idiotsky.me/images1/git-story-3.jpg" alt=""></a></p>
<blockquote>
<p>å¯¼æ¼”æ³¨ï¼šCommitçš„idä¸ºå¯¹å½“å‰æ–‡ä»¶å¤¹å†…å®¹åšSHA-1å¾—æ¥ã€‚</p>
</blockquote>
<h1 id="ä¸Šç‚¹å„¿è‰²å§"><a href="#ä¸Šç‚¹å„¿è‰²å§" class="headerlink" title="ä¸Šç‚¹å„¿è‰²å§"></a>ä¸Šç‚¹å„¿è‰²å§</h1><p>è€æ¿æƒ³æŠŠæ ‘æ¶‚æˆçº¢è‰²çš„ï¼Œå†ç»™æ ‘å–ä¸ªåå­—å«big treeã€‚ä»–è®°å¾—Gitå…ˆç”Ÿå‘Šè¯‰è¿‡ä»–å¯ä»¥ç”¨<code>git diff</code>æ¥æŸ¥çœ‹è‡ªå·±æ‰€åšçš„æ”¹åŠ¨<br><a href="http://idiotsky.me/images1/git-story-4.jpg"><img src="http://idiotsky.me/images1/git-story-4.jpg" alt=""></a><br>çœ‹åˆ°äº†è‡ªå·±çš„ä¿®æ”¹åï¼Œè€æ¿æ»¡æ„çš„ç‚¹ç‚¹å¤´ï¼Œç„¶åç”¨<code>git add .</code>æŠŠå®ƒä»¬éƒ½ä¸¢è¿›äº†æ‘„å½±æ£šã€‚è¿‡åå°±å‡ºå»å¿™å…¶ä»–äº‹æƒ…äº†ï¼Œå›æ¥åä»–å‘ç°è‡ªå·±å¿˜è®°ç¦»å¼€å‰åšäº†å•¥äº‹æƒ…äº†ã€‚æ­¤æ—¶ä»–å†ç”¨<code>git diff</code>æŸ¥çœ‹ï¼Œå‘ç°é‡Œé¢ç©ºç©ºå¦‚ä¹Ÿã€‚è€æ¿æ„¤æ€’çš„å«æ¥äº†Gitå…ˆç”Ÿé—®ä»–æ˜¯å’‹å›äº‹ã€‚Gitå…ˆç”Ÿå‹å–„çš„è§£é‡Šäº†åŸå› ã€‚</p>
<p>â€œ<code>git diff</code>æ˜¾ç¤ºäº†æ‚¨å½“å‰ä¿®æ”¹å’Œæˆ‘åŠå…¬å®¤ä¸­æ‰€è®°å½•çš„æœ€æ–°ä¸€å¼ ç…§ç‰‡ä¹‹é—´çš„å·®å¼‚ï¼Œä½†æ˜¯æ‚¨å·²ç»æŠŠè¿™äº›æ”¹åŠ¨éƒ½æŒªåˆ°æˆ‘çš„æ‘„å½±æ£šé‡Œäº†ï¼Œgit diffå°±æ²¡æ³•æŸ¥çœ‹äº†ï¼Œå¦‚æœæ‚¨æƒ³çœ‹æˆ‘æ‘„å½±æ£šé‡Œæ‘†äº†å“ªäº›ä¸œè¥¿ã€‚ä½ å¯ä»¥ä½¿ç”¨<code>git diff --staged/cached</code>å“¦â€</p>
<p>è€æ¿æŒ‰ç…§Gitå…ˆç”Ÿæ‰€è¯´ï¼Œæœç„¶çœ‹åˆ°äº†ä»–ä»¥å‰çš„ä¿®æ”¹è®°å½•ã€‚</p>
<blockquote>
<p>å¯¼æ¼”æ³¨ï¼šstageç›¸å…³çš„å‘½ä»¤ä¸€èˆ¬éƒ½ä¸Staging Areaç›¸å…³ï¼Œgit add ä¹Ÿå¯ä»¥å†™æˆ git stageï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤æ˜¯ä¸€æ ·çš„ã€‚</p>
</blockquote>
<p>ä¸è¿‡å½“è€æ¿çœ‹åˆ°ä»–æŠŠæ ‘è®¾æˆäº†çº¢è‰²ï¼Œè§‰å¾—ä¸åˆç†ï¼Œæƒ³æ”¾å¼ƒè¿™æ¬¡ä¿®æ”¹ã€‚ä»–è¦å¦‚ä½•å»åšå‘¢ï¼Ÿ</p>
<p><code>git reset &lt;file&gt;</code> æŠŠè¿™ä¸ªæ–‡ä»¶çš„ä¿®æ”¹ä»Staging Areaä¸­å»é™¤<br><code>git checkout -- &lt;file&gt;</code> æ”¾å¼ƒå·¥ä½œåŒºæ–‡ä»¶çš„ä¿®æ”¹</p>
<blockquote>
<p>å¯¼æ¼”æ³¨ï¼šè¿™é‡Œä½¿ç”¨ <code>git checkout &lt;file&gt;</code> ä¹Ÿè¡Œï¼Œä¹‹æ‰€ä»¥ä½¿ç”¨â€“ï¼Œå› ä¸ºè¯¥å‘½ä»¤ä¸åˆ‡æ¢åˆ†æ”¯çš„å‘½ä»¤ä¸€æ ·ï¼Œä¸‡ä¸€è¿™ä¸ªæ–‡ä»¶åå’ŒæŸä¸ªåˆ†æ”¯åé‡åï¼Œåˆ™<code>git checkout &lt;file&gt;</code>å°±å˜æˆåˆ‡æ¢åˆ†æ”¯äº†ã€‚</p>
</blockquote>
<p>è€æ¿ä¸ç¦æ„Ÿå¹ï¼Œå¹¸å¥½è‡ªå·±æ²¡æœ‰è¿›è¡Œcommitã€‚Gitå…ˆç”Ÿå‘Šè¯‰è€æ¿è¯´ï¼Œå³ä½¿ä½ commitäº†ï¼Œä¹Ÿä¸ç”¨æ€•ï¼Œæˆ‘ä¹Ÿæœ‰å‡ ç§è§£å†³æ–¹æ¡ˆã€‚<br>ä¸€ï¼Œæ”¾å¼ƒæ•´å¼ ç…§ç‰‡<br><code>git reset HEAD~1</code> HEADè¡¨ç¤ºæŒ‡å‘æœ€æ–°é‚£å¼ ç…§ç‰‡çš„æŒ‡é’ˆï¼Œï½1è¡¨ç¤ºè¦æƒ³èµ·å›é€€ä¸€å¼ ï¼Œæ­¤æ—¶æˆ‘ä»¬æœ‰ä¸‰ç§å›é€€æ–¹å¼å¯é€‰<code>--soft</code>è¡¨ç¤ºåªåˆ é™¤ç…§ç‰‡ï¼Œç…§ç‰‡çš„ä¿®æ”¹æ¢å¤åˆ°Staging Areaä¸­,<code>--mixed</code>ä¸ä½†åˆ é™¤ç…§ç‰‡ï¼Œä¹Ÿä¸æ¢å¤Staging Areaä¸­çš„çŠ¶æ€ï¼ˆä¸åŠ é€‰é¡¹æ—¶å°±ä¸ºæ­¤ä¸­æ–¹æ³•ï¼‰,<code>--hard</code>ä¸ä½†åˆ é™¤ç…§ç‰‡ï¼Œè€Œä¸”è¿å·¥ä½œåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿè¢«å›é€€æ‰</p>
<p>äºŒï¼Œæˆ‘ä»¬å†äº§ç”Ÿä¸€å¼ æƒ³æ”¾å¼ƒçš„ç…§ç‰‡çš„åä¿®æ”¹çš„ç…§ç‰‡<br><code>git revert &lt;commit-id&gt;</code> äº§ç”Ÿæ­¤commitçš„åä¿®æ”¹ï¼Œå¹¶æäº¤æ­¤å¤„commit-idä¸å¿…æ˜¯æœ€æ–°ä¸€æ¬¡ï¼Œå¯ä»¥æ˜¯ä»»æ„å¤„çš„ã€‚<br>ç¬¬ä¸€ç§æ–¹æ¡ˆé€‚ç”¨äºï¼Œä½ çš„commitè¿˜æœªpushåˆ°äº‘ç«¯çš„åœºæ™¯ï¼Œç¬¬äºŒç§ï¼Œå¦‚æœä½ çš„ä¿®æ”¹å·²ç»pushåˆ°äº‘ç«¯ï¼Œé‚£ä¹ˆä¸ºäº†å°Šé‡å†å²è®°å½•ï¼Œæœ€å¥½å°±æ˜¯ç”Ÿæˆä¸€ä¸ªæ–¹å‘ä¿®æ”¹æ¥å›é€€é”™è¯¯éƒ¨åˆ†ï¼Œè®©å…¶ä»–äººçŸ¥é“å†å²ã€‚</p>
<blockquote>
<p>å¯¼æ¼”æ³¨ï¼šHEADæŒ‡é’ˆè®°å½•äº†æ­£åœ¨æ“ä½œçš„èŠ‚ç‚¹çš„commit idï¼Œæ¯ä¸ªåˆ†æ”¯éƒ½æœ‰å±äºè‡ªå·±çš„HEADæŒ‡é’ˆï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ª</p>
</blockquote>
<h1 id="æ‹¨å¼„ä½ çš„æŒ‡é’ˆ"><a href="#æ‹¨å¼„ä½ çš„æŒ‡é’ˆ" class="headerlink" title="æ‹¨å¼„ä½ çš„æŒ‡é’ˆ"></a>æ‹¨å¼„ä½ çš„æŒ‡é’ˆ</h1><p>è€æ¿ç»è¿‡ä¸Šæ¬¡çš„äº‹ä»¶ï¼Œå‘ç°è‡ªå·±å¯èƒ½ä¼šå› ä¸ºä¸€æ—¶å†²åŠ¨åšå‡ºä¸€äº›é”™è¯¯çš„å†³å®šã€‚å°±é—®Gitå…ˆç”Ÿæ˜¯å¦æœ‰åŠæ³•æŠŠè‡ªå·±æ‰€æœ‰æ“ä½œè¡Œä¸ºéƒ½è®°å½•ä¸‹æ¥ï¼Œè€Œä¸”è¿˜å…è®¸è‡ªå·±æ’¤é”€ä»»ä½•ä¸€ç§é”™è¯¯çš„æ“ä½œã€‚Gitå…ˆç”Ÿå‘è€æ¿è§£é‡Šè¯´ï¼šæ‰€æœ‰å¯¹HEADæŒ‡é’ˆçš„æ“ä½œéƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ã€‚</p>
<p>å¯ä»¥ç”¨<code>git reflog</code>æŸ¥çœ‹åˆ°è€æ¿çš„æ‰€æœ‰HEADæ“ä½œ<br><a href="http://idiotsky.me/images1/git-story-5.jpg"><img src="http://idiotsky.me/images1/git-story-5.jpg" alt=""></a><br>æœ€ä¸Šé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯è€æ¿å½»åº•å›é€€äº†ç»™æ ‘æ·»åŠ åå­—å’Œé¢œè‰²ä¿®æ”¹ï¼Œæ‰§è¡Œäº†<code>git reset --hard HEAD~1</code>ï¼Œè€Œå¦‚æœè€æ¿çªç„¶åˆåæ‚”äº†ï¼Œæƒ³æ¢å¤æ·»åŠ åå­—å’Œé¢œè‰²çš„ä¿®æ”¹ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ‰§è¡Œ<code>git reset --hard HEAD@{1}</code>æ¥æŠŠæ“ä½œå›é€€åˆ°<code>HEAD@{1}</code>æ—¶ï¼Œä¹Ÿå°±æ˜¯åŠ å…¥åå­—å’Œé¢œè‰²é‚£æ¬¡commitã€‚</p>
<blockquote>
<p>è¿™é‡Œçš„resetä¹Ÿæœ‰ä¸‰ä¸ªé€‰é¡¹ï¼Œ<code>--soft</code>ï¼Œ<code>--mixed</code>ï¼Œ<code>--hard</code>ï¼Œå› ä¸ºè¿™é‡Œæ‰§è¡Œçš„æ˜¯æ¢å¤æ“ä½œï¼Œæ‰€ä»¥è¿™ä¸‰ä¸ªé€‰é¡¹åœ¨è¿™é‡Œçš„ä½œç”¨ä¹Ÿéœ€è¦åè¿‡æ¥ç†è§£ï¼Œhardè‡ªä¸ç”¨è¯´ï¼Œå°±æ˜¯å®Œå…¨æ¢å¤åˆ°æŸä¸ªæ“ä½œæ—¶çš„çŠ¶æ€ï¼Œè€Œsoftè¡¨ç¤ºï¼Œè™½ç„¶æŠŠHEADæŒ‡é’ˆæ‹¨åˆ°äº†æŸä¸ªæ“ä½œæ—¶çš„çŠ¶æ€ï¼Œä½†åœ¨staging areaä¸­ä¼šäº§ç”Ÿå¯ä»¥è®©æ¢å¤åçš„çŠ¶æ€é‡æ–°ä¿®æ”¹å›æ¥çš„ä¿®æ”¹ï¼Œå°±åƒç‰©è´¨ä¸åç‰©è´¨é‚£æ ·ã€‚mixedåŒç†ã€‚</p>
</blockquote>
<p>ä»¥ä¸Šå¯èƒ½éš¾ä»¥ç†è§£ï¼Œè¿™é‡Œæˆ‘ä»¬å†ä¸¾ä¸ªåº”ç”¨åœºæ™¯æ¥è¯´æ˜ä¸‹ï¼š<br>æˆ‘ä»¬çŸ¥é“<code>git revert</code>æ¯æ¬¡åªèƒ½å›é€€æŸä¸ªcommitï¼Œé‚£æˆ‘ä»¬å¦‚ä½•åŒæ—¶revertæ‰å¤šä¸ªcommitå‘¢ã€‚é’ˆå¯¹è¿™ç§åœºæ™¯æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//æ‹¨åŠ¨HEADæŒ‡é’ˆåˆ°5add0e9</div><div class="line">git reset --hard 5add0e9 </div><div class="line">//æ¢å¤åˆ°ä»¥å‰çš„commitå¤„ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨staging areaç”Ÿæˆäº†ä¸­åä¿®æ”¹</div><div class="line">git reset --soft HEAD@&#123;1&#125; </div><div class="line">// æ³¨æ„æ­¤å¤„ç”¨äº†--soft</div><div class="line">git commit -m &apos;revert to 5add0e9&apos;</div></pre></td></tr></table></figure></p>
<h1 id="å¤šå¹²ç‚¹äº‹"><a href="#å¤šå¹²ç‚¹äº‹" class="headerlink" title="å¤šå¹²ç‚¹äº‹"></a>å¤šå¹²ç‚¹äº‹</h1><p>è€æ¿ï¼šåœ°çš®å‡†å¤‡å¥½äº†ï¼Œ æˆ‘ä»¬æ—¢è¦ç§èŠ±ï¼Œç§è‰ï¼Œè¿˜è¦ç›–ä¸ªæ¥¼æˆ¿å•¥çš„ï¼Œç§èŠ±è¦èŠ±å‡ å¤©åŠŸå¤«ï¼Œç§è‰å¥½åˆå¾—èŠ±å‡ å¤©ã€‚è¿™å‡ æ ·äº‹å’±èƒ½ä¸èƒ½ä¸€èµ·å¹²å‘¢ï¼Ÿå¹²å®Œäº†ï¼Œåˆ†åˆ«æ‹ä¸ªç…§ç‰‡å†åˆä¸€å—å²‚ä¸ç¾å“‰ã€‚</p>
<p>Gitå…ˆç”Ÿï¼šè€æ¿è‹±æ˜ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µæˆ‘ä¹Ÿæ—©æœ‰å‡†å¤‡ã€‚</p>
<p><code>git branch &lt;branch-name&gt;</code> åˆ›å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œä¸åŠ <code>&lt;branch-name&gt;</code>åˆ™ä¸ºåˆ—å‡ºå½“å‰æ‰€æœ‰åˆ†æ”¯<code>git branch -d &lt;branch-name&gt;</code>åˆ é™¤åˆ†æ”¯ -D ä¸ºå¼ºåˆ¶åˆ é™¤åˆ†æ”¯<code>git checkout &lt;branch-name&gt;</code> åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯ä¸‹<code>git merge &lt;branch-name&gt;</code> åˆå¹¶<code>&lt;branch-name&gt;</code>åˆ†æ”¯å†…å®¹åˆ°æœ¬åˆ†æ”¯ä¸‹</p>
<blockquote>
<p>é’ˆå¯¹è€æ¿è¯´çš„è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºå¦‚ä¸‹åˆ†æ”¯ã€‚ç„¶ååˆ†åˆ«åœ¨floweré‡Œç§èŠ±ï¼Œgrassä¸­ç§è‰ï¼Œbuildingä¸­ç›–æ¥¼ï¼Œæœ€ååœ¨masteråˆ†æ”¯ä¸­æŠŠå®Œæˆçš„ç…§ç‰‡mergeè¿‡æ¥å°±è¡Œã€‚<br>âœ GitTestRepo git:(master) git branch flower<br>âœ GitTestRepo git:(master) git branch grass<br>âœ GitTestRepo git:(master) git branch building<br>âœ GitTestRepo git:(master) git branch<br>building<br>flower<br>grass<br>* master</p>
<p>å¯¼æ¼”æ³¨ï¼šåˆ†æ”¯å‰åŠ *å·çš„ä¸ºå½“å‰å·¥ä½œåˆ†æ”¯</p>
</blockquote>
<h1 id="åˆä½œå…±èµ¢"><a href="#åˆä½œå…±èµ¢" class="headerlink" title="åˆä½œå…±èµ¢"></a>åˆä½œå…±èµ¢</h1><p>Gitå…ˆç”Ÿï¼šæŠ¥å‘Šè€æ¿ï¼Œæ‚¨è¿™å—åœ°çš®å¾ˆå¤§ï¼Œè¦æ˜¯åªæœ‰æˆ‘ä»¬å¼€å‘ï¼Œé‚£å¾—èŠ±ä¸Šå¾ˆä¹…æ—¶é—´ï¼Œä½•ä¸æŠŠå®ƒå¼€æ”¾å‡ºå»ï¼Œè®©å…¶ä»–è€æ¿ä»¬ä¸€èµ·è¿›æ¥æŠŠè¿™å—è›‹ç³•åšå¤§å‘¢ã€‚</p>
<p>è€æ¿ï¼šå¥½ä¸»æ„ï¼Œæˆ‘ä»¬è¦æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>Gitå…ˆç”Ÿï¼šä¸€åˆ‡äº¤ç»™æˆ‘ï¼Œä¸è¿‡å› ä¸ºåœ°çš®å¼€æ”¾å‡ºå»åï¼Œæ¶‰åŠåˆ°å¤šæ–¹å…±åŒå¼€å‘ã€‚æœ‰äº›æ³¨æ„äº‹é¡¹è¿˜å¸Œæœ›è€æ¿èƒ½å¬æˆ‘è¯´é“è¯´é“ï¼Œå¦åˆ™å±å®³ç”šå¤§ã€‚</p>
<p>è€æ¿ï¼šè¯·è®²è¯·è®²ï¼</p>
<p>å¦‚æˆ‘ä»¬ç¬¬ä¸€å¼ å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨git pushæ¥æŠŠè‡ªå·±æ‰€æœ‰çš„ç…§ç‰‡ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œè®©å…¶ä»–äººä¹Ÿå¯ä»¥å‚ä¸è¿›æ¥å¼€å‘ã€‚æ—¢ç„¶æ˜¯äº‘ç«¯ï¼Œé‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬å°±éœ€è¦æŒ‡æ˜ä¸‹è¿™ä¸ªäº‘ç«¯åœ°çš®çš„åœ°å€æ˜¯å“ªé‡Œã€‚</p>
<p><code>git remote add origin https://github.com/CPPAlien/GitTestRepo.git</code>//è¿™é‡Œä¸€èˆ¬ç”¨originï¼Œå½“ç„¶ä½ å¯ä»¥æ¢æˆå…¶ä»–ä»»ä½•åï¼Œä½ ä¹Ÿå¯ä»¥æ·»åŠ å¤šä¸ªremoteåœ°å€git remote -v å¯ä»¥ç”¨æ¥æŸ¥çœ‹æ‰€æœ‰äº‘ç«¯åœ°å€ä¿¡æ¯<br><code>git push -u &lt;remote&gt; &lt;branch&gt; git push --set-upstream &lt;remote&gt; &lt;branch&gt;</code>ç”¨è¿™ä¸¤ä¸ªå‘½ä»¤æ¥æŒ‡æ˜æŸä¸ªåˆ†æ”¯æ‰€å¯¹åº”åˆ°çš„remoteåœ°å€ã€‚å¦‚æœä¸æŒ‡å®šï¼Œä½ åœ¨æ‰§è¡Œgit pushæ—¶éœ€è¦æ˜ç¡®å†™å‡ºremoteå’Œbranchã€‚<br><a href="http://idiotsky.me/images1/git-story-6.jpg"><img src="http://idiotsky.me/images1/git-story-6.jpg" alt=""></a></p>
<p>å› ä¸ºæ˜¯å¤šäººåˆä½œï¼Œæ‰€ä»¥å°±æœ‰å¯èƒ½åˆ«äººåœ¨äº‘ç«¯å…ˆä¸ä½ æäº¤äº†ä¸€äº›ä¿®æ”¹ï¼Œè€Œæ­¤æ—¶å°±éœ€è¦è¿›è¡Œgit pullæ“ä½œï¼ŒæŠŠåˆ«äººçš„ä¿®æ”¹æ‹‰å–ä¸‹æ¥åˆå¹¶åˆ°æœ¬åœ°ã€‚ä½†ç›´æ¥git pullè¡Œä¸ºæ˜¯ä¸å¤ªå®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä¼šç›´æ¥äº§ç”Ÿmergeè¡Œä¸ºï¼Œå¯èƒ½ä¼šå¯¼è‡´ä½ æœ¬åœ°æ•°æ®é”™ä¹±ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ç”¨git fetchï¼Œæ­£ç¡®æµç¨‹å¦‚ä¸‹</p>
<p><code>git fetch origin master</code>//è·å–originä¸Šçš„masteråˆ†æ”¯ï¼Œä¼šåœ¨æœ¬åœ°è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªçš„origin/masterçš„ä¸´æ—¶åˆ†æ”¯ã€‚<br><code>git log -p master..origin/master</code>//æ¯”è¾ƒæœ¬åœ°çš„masteråˆ†æ”¯å’Œè¿œç«¯çš„masteråˆ†æ”¯ï¼Œçœ‹ä¸‹å·®åˆ«ã€‚<br><code>git merge origin/master</code> æˆ– <code>git rebase origin/master</code> //å¦‚æœå·®åˆ«æ˜¯åœ¨è‡ªå·±çš„è®¤çŸ¥èŒƒå›´ï¼Œé‚£ä¹ˆå°±è¿›è¡Œåˆå¹¶æ“ä½œï¼Œè¿™æ ·æœ¬åœ°çš„masteråˆ†æ”¯å°±ä¸äº‘ç«¯ä¿æŒä¸€è‡´äº†ã€‚å¦‚æœæœ¬åœ°æœ‰æœªpushçš„commitï¼Œåˆ™ä¼šäº§ç”ŸMergeçš„commitè¡Œä¸ºã€‚Mergeçš„è¿‡ç¨‹ä¸­æœ‰å¯èƒ½å› ä¸ºå¤šäººå¯¹åŒä¸€ä¸ªæ–‡ä»¶çš„ä¿®æ”¹è€Œé€ æˆå†²çªã€‚<br><code>git mergetool</code>//æ‰“å¼€mergeå·¥å…·ï¼Œmergeå®Œåä¿å­˜ï¼Œç„¶åæ‰‹åŠ¨æäº¤mergeåçš„ç»“æœã€‚å®Œæˆä¸Šè¿°æ“ä½œåï¼Œå°±å¯ä»¥æŠŠè‡ªå·±æœ¬åœ°çš„commitæäº¤åˆ°äº‘ç«¯äº†ã€‚</p>
<blockquote>
<p>å¯¼æ¼”æ³¨ï¼šgit merge å’Œ git rebaseçš„åŒºåˆ«ï¼Œrebaseæ˜¯æ‰¾åˆ°ä¸¤è€…å…±åŒçš„commitå¤„ï¼ŒæŠŠå®ƒè€…çš„ä¿®æ”¹æ¥ä¸Šå»ï¼Œç„¶åå†æŠŠè‡ªå·±çš„ä¿®æ”¹æ¥åœ¨å®ƒè€…çš„ä¿®æ”¹åé¢ï¼Œä¸ä¼šäº§ç”Ÿmergeè¡Œä¸ºã€‚çœ‹å†å²å›¾æ—¶ä¹Ÿä¸ä¼šåƒmergeé‚£æ ·æœ‰åˆ†å‰ã€‚</p>
</blockquote>
<p>ä»ä»¥ä¸‹æ‰§è¡Œrebaseåçš„æç¤ºï¼Œä¹Ÿå¯çŸ¥äºŒä¸‰</p>
<blockquote>
<p>âœ GitTest git:(master) git rebase origin/masterFirst<br>rewinding head to replay your work on top of itâ€¦Fast-forwarded master to origin/master.</p>
</blockquote>
<h1 id="å…¶ä»–å°æŠ€å·§"><a href="#å…¶ä»–å°æŠ€å·§" class="headerlink" title="å…¶ä»–å°æŠ€å·§"></a>å…¶ä»–å°æŠ€å·§</h1><p><code>git cherry-pick &lt;commit-id&gt;</code><br>è€æ¿å¦‚æœæƒ³æŠŠå…¶ä»–åˆ†æ”¯ä¸Šçš„ä¸€äº›ç…§ç‰‡æ‹£è¿‡æ¥ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å‘½ä»¤ã€‚å¦‚æœè¯¥ç…§ç‰‡ä¸æœ¬åˆ†æ”¯æ— å†²çªï¼Œåˆ™ç›´æ¥ä¼šåœ¨æœ¬åˆ†æ”¯ä¸ŠåŠ ä¸Šä¸€æ¡commitï¼Œå¦‚æœæœ‰å†²çªï¼Œåˆ™éœ€è¦è§£å†³å†²çªåé‡æ–°æäº¤ã€‚<br><code>git stash/ git stash pop</code><br>å¦‚æœè€æ¿å½“å‰æœ‰äº›å·¥ä½œæ²¡æœ‰commitã€‚ä½†æœ‰äº›äº‘ç«¯çš„commitæˆ–è€…å…¶ä»–åˆ†æ”¯çš„commitæ˜¯è‡ªå·±åç»­å¼€å‘æ‰€è¦ä¾èµ–çš„ï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨git stashæŠŠå½“å‰æœªæäº¤çš„ä¿®æ”¹æ”¾å…¥åˆ°ç¼“å­˜æ ˆï¼Œç­‰åˆå¹¶æ“ä½œå®Œæˆåï¼Œå†ç”¨git stash popï¼ŒæŠŠä¿®æ”¹å†åŠ å›æ¥ï¼Œä½ å¯ä»¥ç”¨git stash listæŸ¥çœ‹å½“å‰çš„ç¼“å­˜æ ˆã€‚</p>
<h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>Gitå’ŒMercurial éƒ½æ˜¯åœ¨2005å¹´æ—¶å‡ºç°ï¼Œåˆ†åˆ«ç”±Linuså’ŒMattä¸»å¯¼å¼€å‘ã€‚è€Œä¸¤è€…çš„å‡ºç°ä¹Ÿæºäºä¸€ä¸ªå…±åŒçš„äº‹ä»¶ï¼Œ2005å¹´åˆBitKeeperå®£å¸ƒå‘å¼€æºç¤¾åŒºæ”¶è´¹ã€‚Mercurialåœ¨è‹±è¯­ä¸­æœ‰åå¤æ— å¸¸çš„æ„æ€ï¼Œè€ŒGitä¹Ÿå¯ä»¥ç¿»è¯‘æˆæ— ç”¨ä¹‹äººï¼ŒMattç›´æ¥è¯´ä»–å–åMercurialçš„ç”¨æ„å°±æ˜¯è®½åˆºBitKeeperçš„å¼€å‘è€…ã€‚</p>
<p>from <a href="https://www.toutiao.com/i6484504341452440077/" target="_blank" rel="external">https://www.toutiao.com/i6484504341452440077/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å¾ˆæœ‰æ„æ€çš„é€šä¿—çš„æ€»ç»“äº†gitã€‚ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Gitå…ˆç”Ÿæ˜¯ä¸€ä½å¾ˆå‡ºåçš„æ‘„å½±ä¸“å®¶ï¼Œä»–çš„ä¸»è¦èŒè´£æ˜¯ç”¨å®ƒå¼ºå¤§çš„æ‹æ‘„æŠ€æœ¯å¸®æˆ‘ä»¬å…±äº«æˆæœï¼Œå…±åˆ›æœªæ¥ã€‚ä¸ºæ­¤å®ƒå‡†å¤‡äº†è®¸è®¸å¤šå¤šçš„å·¥å…·æ¥å®ç°è¿™æ ·çš„ç›®æ ‡ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹Gitå…ˆç”Ÿçš„å·¥ä½œåœºæ‰€ï¼Œå’Œä»–ä¸ºæˆ‘ä»¬çš„ä¸€äº›ç—›ç‚¹å¸¦æ¥äº†å“ªäº›è§£å†³æ–¹æ¡ˆå§ã€‚&lt;/p&gt;
&lt;h1 id=&quot;åˆæ¬¡è§é¢&quot;&gt;&lt;a href=&quot;#åˆæ¬¡è§é¢&quot; class=&quot;headerlink&quot; title=&quot;åˆæ¬¡è§é¢&quot;&gt;&lt;/a&gt;åˆæ¬¡è§é¢&lt;/h1&gt;&lt;p&gt;è€æ¿ï¼ˆç”¨æˆ·è‡ªå·±ï¼‰æ–°ä¹°äº†ä¸€å—åœ°çš®ï¼ˆåˆ›å»ºäº†ä¸€ä¸ªç›®å½•ï¼‰ï¼Œæƒ³è˜è¯·Gitå…ˆç”Ÿåˆ°æ­¤å¼€è®¾ä¸€ä¸ªå·¥ä½œå®¤æ¥åŠ å¿«è¿™ä¸ªåœ°çš®çš„å»ºè®¾å·¥ä½œã€‚è€æ¿ç”¨&lt;code&gt;git init&lt;/code&gt; æ‹›æ¥äº†Gitå…ˆç”Ÿï¼ŒGitå…ˆç”Ÿåœ¨è¯¥ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª.gitç›®å½•ï¼Œç”¨æ¥ä½œä¸ºè‡ªå·±çš„åŠå…¬å®¤ï¼ŒåŠå…¬å®¤ç”¨æ¥è®°å½•è‡ªå·±çš„å·¥ä½œæ—¥å¿—å’Œæˆæœã€‚&lt;/p&gt;
&lt;p&gt;è®©æˆ‘ä»¬æ¥ä»ç©ºä¸­ä¿¯ç°ä¸‹è¿™å—æ–°çš„åœ°çš®ï¼Œå’ŒGitå…ˆç”Ÿä¸ºå®ƒæ‰€è®¾è®¡çš„è“å›¾å§ã€‚&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images1/git-story-1.jpg&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images1/git-story-1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ä»¬æ¥è§£é‡Šä¸‹ï¼Œè¿™å‡ ä¸ªåŒºåŸŸçš„ä½œç”¨ï¼š&lt;br&gt;Working Directoryï¼šGitå…ˆç”Ÿçš„è€æ¿æ‰€ä¹°ä¸‹çš„åœ°çš®ï¼Œè¿™ä¸ªæ˜¯å®å®åœ¨åœ¨ç‰©ç†å±‚é¢çš„åœ°çš®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢ç§äº›èŠ±èŠ±è‰è‰ï¼Œå»ºç‚¹é«˜æ¥¼å¤§å¦å•¥çš„ã€‚&lt;/p&gt;
&lt;p&gt;Staging Areaï¼šGitå…ˆç”Ÿæ‘„å½±æ£šæ‰€åœ¨åœ°ï¼Œä½ç½®ä½äºGitå…ˆç”Ÿçš„åŠå…¬å®¤ã€‚æ¯å½“è€æ¿å®Œæˆäº†æŸä»¶åå‚é’å²çš„ä¼Ÿäº‹ï¼Œä»–å°±ä¼šå‘½ä»¤Gitå…ˆç”ŸæŠŠè‡ªå·±è¿™ä¸ªé˜¶æ®µæ‰€å¹²çš„äº‹æƒ…ä¸€äº”ä¸€åçš„æ¬åˆ°æ‘„å½±æ£šæ‹ç…§è®°å½•ä¸‹æ¥ã€‚&lt;code&gt;git add&lt;/code&gt; å°±æ˜¯æŠŠä¿®æ”¹æ¬åˆ°æ‘„å½±æ£šï¼Œ&lt;code&gt;git commit&lt;/code&gt;å°±æ˜¯å‘½ä»¤Gitå…ˆç”Ÿæ‹ç…§ï¼Œè€Œæ‹å®Œç…§åï¼Œæ‘„å½±æ£šé©¬ä¸Šä¼šè¢«æ‰“æ‰«å¹²å‡€ã€‚&lt;/p&gt;
&lt;p&gt;Repositoryï¼šGitå…ˆç”ŸåŠå…¬å®¤çš„æŸä¸ªåŒºåŸŸï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨ç…§ç‰‡ç”¨çš„ã€‚&lt;/p&gt;
&lt;p&gt;Remoteï¼šè¿™æ˜¯ä¸€å—äº‘ç«¯åŒºåŸŸï¼ŒGitå…ˆç”Ÿä¼šåœ¨å·¥ä½œå®Œä¸€æ®µæ—¶é—´åï¼Œå°±æŠŠè‡ªå·±çš„ä½œå“ä¸Šä¼ ä¸Šå»ã€‚è¿™æ ·åšï¼Œä¸€æ–¹é¢æ˜¯ç”¨æ¥ä¿å­˜è‡ªå·±çš„ä½œå“ï¼Œä»¥å¤‡æ„å¤–å‘ç”Ÿï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯æä¾›ç»™å…¶ä»–æœ‰å…´è¶£çš„è€æ¿ä»¬ä¸€èµ·åšè¿™ä¸ªé¡¹ç›®ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="git" scheme="http://idiotsky.me/categories/git/"/>
    
    
      <category term="git" scheme="http://idiotsky.me/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>TCP çš„é‚£äº›äº‹å„¿</title>
    <link href="http://idiotsky.me/2017/11/01/tcp-something/"/>
    <id>http://idiotsky.me/2017/11/01/tcp-something/</id>
    <published>2017-11-01T14:56:41.000Z</published>
    <updated>2017-11-11T07:14:37.652Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>tcpçœ‹äº†å¾ˆå¤šçš„æ–‡ç« ï¼Œè¿™ç¯‡æ€»ç»“çš„å¾ˆå¥½ã€‚æ­¤æ–‡æœ‰ç‚¹é•¿ğŸ‘¿</p>
</blockquote>
<p>tcpåœ¨ç½‘ç»œOSIçš„ä¸ƒå±‚æ¨¡å‹ä¸­çš„ç¬¬å››å±‚â€”â€”Transport(ä¼ è¾“)å±‚ï¼ŒIPåœ¨ç¬¬ä¸‰å±‚â€”â€”Network(ç½‘ç»œ)å±‚ï¼ŒARPåœ¨ç¬¬äºŒå±‚â€”â€”Data Link(æ•°æ®é“¾è·¯)å±‚ï¼Œåœ¨ç¬¬äºŒå±‚ä¸Šçš„æ•°æ®ï¼Œæˆ‘ä»¬å«Frameï¼Œåœ¨ç¬¬ä¸‰å±‚ä¸Šçš„æ•°æ®å«Packetï¼Œç¬¬å››å±‚çš„æ•°æ®å«Segmentã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œæˆ‘ä»¬ç¨‹åºçš„æ•°æ®é¦–å…ˆä¼šæ‰“åˆ°TCPçš„Segmentä¸­ï¼Œç„¶åTCPçš„Segmentä¼šæ‰“åˆ°IPçš„Packetä¸­ï¼Œç„¶åå†æ‰“åˆ°ä»¥å¤ªç½‘Ethernetçš„Frameä¸­ï¼Œä¼ åˆ°å¯¹ç«¯åï¼Œå„ä¸ªå±‚è§£æè‡ªå·±çš„åè®®ï¼Œç„¶åæŠŠæ•°æ®äº¤ç»™æ›´é«˜å±‚çš„åè®®å¤„ç†ã€‚</p>
<h1 id="TCPå¤´æ ¼å¼"><a href="#TCPå¤´æ ¼å¼" class="headerlink" title="TCPå¤´æ ¼å¼"></a>TCPå¤´æ ¼å¼</h1><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹TCPå¤´çš„æ ¼å¼<br><a href="http://idiotsky.me/images1/tcp-something-1.jpg"><img src="http://idiotsky.me/images1/tcp-something-1.jpg" alt=""></a><br>ä½ éœ€è¦æ³¨æ„è¿™ä¹ˆå‡ ç‚¹ï¼š</p>
<ul>
<li>TCPçš„åŒ…æ˜¯æ²¡æœ‰IPåœ°å€çš„ï¼Œé‚£æ˜¯IPå±‚ä¸Šçš„äº‹ã€‚ä½†æ˜¯æœ‰æºç«¯å£å’Œç›®æ ‡ç«¯å£ã€‚</li>
<li>ä¸€ä¸ªTCPè¿æ¥éœ€è¦å››ä¸ªå…ƒç»„æ¥è¡¨ç¤ºæ˜¯åŒä¸€ä¸ªè¿æ¥ï¼ˆsrc_ip, src_port, dst_ip, dst_portï¼‰å‡†ç¡®è¯´æ˜¯äº”å…ƒç»„ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯åè®®ã€‚ä½†å› ä¸ºè¿™é‡Œåªæ˜¯è¯´TCPåè®®ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘åªè¯´å››å…ƒç»„ã€‚</li>
<li>æ³¨æ„ä¸Šå›¾ä¸­çš„å››ä¸ªéå¸¸é‡è¦çš„ä¸œè¥¿ï¼š<ul>
<li>Sequence Numberæ˜¯åŒ…çš„åºå·ï¼Œç”¨æ¥è§£å†³ç½‘ç»œåŒ…ä¹±åºï¼ˆreorderingï¼‰é—®é¢˜ã€‚</li>
<li>Acknowledgement Numberå°±æ˜¯ACKâ€”â€”ç”¨äºç¡®è®¤æ”¶åˆ°ï¼Œç”¨æ¥è§£å†³ä¸ä¸¢åŒ…çš„é—®é¢˜ã€‚</li>
<li>Windowåˆå«Advertised-Windowï¼Œä¹Ÿå°±æ˜¯è‘—åçš„æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰ï¼Œç”¨äºè§£å†³æµæ§çš„ã€‚</li>
<li>TCP Flag ï¼Œä¹Ÿå°±æ˜¯åŒ…çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ç”¨äºæ“æ§TCPçš„çŠ¶æ€æœºçš„ã€‚</li>
</ul>
</li>
</ul>
<a id="more"></a>
<p>å…³äºå…¶å®ƒçš„ä¸œè¥¿ï¼Œå¯ä»¥å‚çœ‹ä¸‹é¢çš„å›¾ç¤º<br><a href="http://idiotsky.me/images1/tcp-something-2.jpg"><img src="http://idiotsky.me/images1/tcp-something-2.jpg" alt=""></a></p>
<h1 id="TCPçš„çŠ¶æ€æœº"><a href="#TCPçš„çŠ¶æ€æœº" class="headerlink" title="TCPçš„çŠ¶æ€æœº"></a>TCPçš„çŠ¶æ€æœº</h1><p>å…¶å®ï¼Œç½‘ç»œä¸Šçš„ä¼ è¾“æ˜¯æ²¡æœ‰è¿æ¥çš„ï¼ŒåŒ…æ‹¬TCPä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚è€ŒTCPæ‰€è°“çš„â€œè¿æ¥â€ï¼Œå…¶å®åªä¸è¿‡æ˜¯åœ¨é€šè®¯çš„åŒæ–¹ç»´æŠ¤ä¸€ä¸ªâ€œè¿æ¥çŠ¶æ€â€ï¼Œè®©å®ƒçœ‹ä¸Šå»å¥½åƒæœ‰è¿æ¥ä¸€æ ·ã€‚æ‰€ä»¥ï¼ŒTCPçš„çŠ¶æ€å˜æ¢æ˜¯éå¸¸é‡è¦çš„ã€‚</p>
<p>ä¸‹é¢æ˜¯ï¼šâ€œTCPåè®®çš„çŠ¶æ€æœºâ€  å’Œ â€œTCPå»ºé“¾æ¥â€ã€â€œTCPæ–­é“¾æ¥â€ã€â€œä¼ æ•°æ®â€ çš„å¯¹ç…§å›¾ï¼Œæˆ‘æŠŠä¸¤ä¸ªå›¾å¹¶æ’æ”¾åœ¨ä¸€èµ·ï¼Œè¿™æ ·æ–¹ä¾¿åœ¨ä½ å¯¹ç…§ç€çœ‹ã€‚å¦å¤–ï¼Œä¸‹é¢è¿™ä¸¤ä¸ªå›¾éå¸¸éå¸¸çš„é‡è¦ï¼Œä½ ä¸€å®šè¦è®°ç‰¢ã€‚<br><a href="http://idiotsky.me/images1/tcp-something-3.png"><img src="http://idiotsky.me/images1/tcp-something-3.png" alt=""></a><br><a href="http://idiotsky.me/images1/tcp-something-4.jpg"><img src="http://idiotsky.me/images1/tcp-something-4.jpg" alt=""></a><br>å¾ˆå¤šäººä¼šé—®ï¼Œä¸ºä»€ä¹ˆå»ºé“¾æ¥è¦3æ¬¡æ¡æ‰‹ï¼Œæ–­é“¾æ¥éœ€è¦4æ¬¡æŒ¥æ‰‹ï¼Ÿ</p>
<ul>
<li><strong>å¯¹äºå»ºé“¾æ¥çš„3æ¬¡æ¡æ‰‹</strong>ï¼Œä¸»è¦æ˜¯è¦åˆå§‹åŒ–Sequence Number çš„åˆå§‹å€¼ã€‚é€šä¿¡çš„åŒæ–¹è¦äº’ç›¸é€šçŸ¥å¯¹æ–¹è‡ªå·±çš„åˆå§‹åŒ–çš„Sequence Numberï¼ˆç¼©å†™ä¸ºISNï¼šInital Sequence Numberï¼‰â€”â€”æ‰€ä»¥å«SYNï¼Œå…¨ç§°Synchronize Sequence Numbersã€‚ä¹Ÿå°±ä¸Šå›¾ä¸­çš„ x å’Œ yã€‚è¿™ä¸ªå·è¦ä½œä¸ºä»¥åçš„æ•°æ®é€šä¿¡çš„åºå·ï¼Œä»¥ä¿è¯åº”ç”¨å±‚æ¥æ”¶åˆ°çš„æ•°æ®ä¸ä¼šå› ä¸ºç½‘ç»œä¸Šçš„ä¼ è¾“çš„é—®é¢˜è€Œä¹±åºï¼ˆTCPä¼šç”¨è¿™ä¸ªåºå·æ¥æ‹¼æ¥æ•°æ®ï¼‰ã€‚</li>
<li><strong>å¯¹äº4æ¬¡æŒ¥æ‰‹</strong>ï¼Œå…¶å®ä½ ä»”ç»†çœ‹æ˜¯2æ¬¡ï¼Œå› ä¸ºTCPæ˜¯å…¨åŒå·¥çš„ï¼Œæ‰€ä»¥ï¼Œå‘é€æ–¹å’Œæ¥æ”¶æ–¹éƒ½éœ€è¦Finå’ŒAckã€‚åªä¸è¿‡ï¼Œæœ‰ä¸€æ–¹æ˜¯è¢«åŠ¨çš„ï¼Œæ‰€ä»¥çœ‹ä¸Šå»å°±æˆäº†æ‰€è°“çš„4æ¬¡æŒ¥æ‰‹ã€‚å¦‚æœä¸¤è¾¹åŒæ—¶æ–­è¿æ¥ï¼Œé‚£å°±ä¼šå°±è¿›å…¥åˆ°CLOSINGçŠ¶æ€ï¼Œç„¶ååˆ°è¾¾TIME_WAITçŠ¶æ€ã€‚ä¸‹å›¾æ˜¯åŒæ–¹åŒæ—¶æ–­è¿æ¥çš„ç¤ºæ„å›¾ï¼ˆä½ åŒæ ·å¯ä»¥å¯¹ç…§ç€TCPçŠ¶æ€æœºçœ‹ï¼‰ï¼š</li>
</ul>
<p><a href="http://idiotsky.me/images1/tcp-something-5.png"><img src="http://idiotsky.me/images1/tcp-something-5.png" alt=""></a><br>å¦å¤–ï¼Œæœ‰å‡ ä¸ªäº‹æƒ…éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p>
<ul>
<li><strong>å…³äºå»ºè¿æ¥æ—¶SYNè¶…æ—¶</strong>ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœserverç«¯æ¥åˆ°äº†clienå‘çš„SYNåå›äº†SYN-ACKåclientæ‰çº¿äº†ï¼Œserverç«¯æ²¡æœ‰æ”¶åˆ°clientå›æ¥çš„ACKï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªè¿æ¥å¤„äºä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œå³æ²¡æˆåŠŸï¼Œä¹Ÿæ²¡å¤±è´¥ã€‚äºæ˜¯ï¼Œserverç«¯å¦‚æœåœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°çš„TCPä¼šé‡å‘SYN-ACKã€‚åœ¨Linuxä¸‹ï¼Œé»˜è®¤é‡è¯•æ¬¡æ•°ä¸º5æ¬¡ï¼Œé‡è¯•çš„é—´éš”æ—¶é—´ä»1så¼€å§‹æ¯æ¬¡éƒ½ç¿»å”®ï¼Œ5æ¬¡çš„é‡è¯•æ—¶é—´é—´éš”ä¸º1s, 2s, 4s, 8s, 16sï¼Œæ€»å…±31sï¼Œç¬¬5æ¬¡å‘å‡ºåè¿˜è¦ç­‰32séƒ½çŸ¥é“ç¬¬5æ¬¡ä¹Ÿè¶…æ—¶äº†ï¼Œæ‰€ä»¥ï¼Œæ€»å…±éœ€è¦ 1s + 2s + 4s+ 8s+ 16s + 32s = 2^6 -1 = 63sï¼ŒTCPæ‰ä¼šæŠŠæ–­å¼€è¿™ä¸ªè¿æ¥ã€‚</li>
<li><strong>å…³äºSYN Floodæ”»å‡»</strong>ã€‚ä¸€äº›æ¶æ„çš„äººå°±ä¸ºæ­¤åˆ¶é€ äº†SYN Floodæ”»å‡»â€”â€”ç»™æœåŠ¡å™¨å‘äº†ä¸€ä¸ªSYNåï¼Œå°±ä¸‹çº¿äº†ï¼Œäºæ˜¯æœåŠ¡å™¨éœ€è¦é»˜è®¤ç­‰63sæ‰ä¼šæ–­å¼€è¿æ¥ï¼Œè¿™æ ·ï¼Œæ”»å‡»è€…å°±å¯ä»¥æŠŠæœåŠ¡å™¨çš„synè¿æ¥çš„é˜Ÿåˆ—è€—å°½ï¼Œè®©æ­£å¸¸çš„è¿æ¥è¯·æ±‚ä¸èƒ½å¤„ç†ã€‚äºæ˜¯ï¼ŒLinuxä¸‹ç»™äº†ä¸€ä¸ªå«tcp_syncookiesçš„å‚æ•°æ¥åº”å¯¹è¿™ä¸ªäº‹â€”â€”å½“SYNé˜Ÿåˆ—æ»¡äº†åï¼ŒTCPä¼šé€šè¿‡æºåœ°å€ç«¯å£ã€ç›®æ ‡åœ°å€ç«¯å£å’Œæ—¶é—´æˆ³æ‰“é€ å‡ºä¸€ä¸ªç‰¹åˆ«çš„Sequence Numberå‘å›å»ï¼ˆåˆå«cookieï¼‰ï¼Œå¦‚æœæ˜¯æ”»å‡»è€…åˆ™ä¸ä¼šæœ‰å“åº”ï¼Œå¦‚æœæ˜¯æ­£å¸¸è¿æ¥ï¼Œåˆ™ä¼šæŠŠè¿™ä¸ª SYN Cookieå‘å›æ¥ï¼Œç„¶åæœåŠ¡ç«¯å¯ä»¥é€šè¿‡cookieå»ºè¿æ¥ï¼ˆå³ä½¿ä½ ä¸åœ¨SYNé˜Ÿåˆ—ä¸­ï¼‰ã€‚è¯·æ³¨æ„ï¼Œè¯·å…ˆåƒä¸‡åˆ«ç”¨tcp_syncookiesæ¥å¤„ç†æ­£å¸¸çš„å¤§è´Ÿè½½çš„è¿æ¥çš„æƒ…å†µã€‚å› ä¸ºï¼Œsynccookiesæ˜¯å¦¥åç‰ˆçš„TCPåè®®ï¼Œå¹¶ä¸ä¸¥è°¨ã€‚å¯¹äºæ­£å¸¸çš„è¯·æ±‚ï¼Œä½ åº”è¯¥è°ƒæ•´ä¸‰ä¸ªTCPå‚æ•°å¯ä¾›ä½ é€‰æ‹©ï¼Œç¬¬ä¸€ä¸ªæ˜¯ï¼štcp_synack_retries å¯ä»¥ç”¨ä»–æ¥å‡å°‘é‡è¯•æ¬¡æ•°ï¼›ç¬¬äºŒä¸ªæ˜¯ï¼štcp_max_syn_backlogï¼Œå¯ä»¥å¢å¤§SYNè¿æ¥æ•°ï¼›ç¬¬ä¸‰ä¸ªæ˜¯ï¼štcp_abort_on_overflow å¤„ç†ä¸è¿‡æ¥å¹²è„†å°±ç›´æ¥æ‹’ç»è¿æ¥äº†ã€‚</li>
<li><strong>å…³äºISNçš„åˆå§‹åŒ–</strong>ã€‚ISNæ˜¯ä¸èƒ½hard codeçš„ï¼Œä¸ç„¶ä¼šå‡ºé—®é¢˜çš„â€”â€”æ¯”å¦‚ï¼šå¦‚æœè¿æ¥å»ºå¥½åå§‹ç»ˆç”¨1æ¥åšISNï¼Œå¦‚æœclientå‘äº†30ä¸ªsegmentè¿‡å»ï¼Œä½†æ˜¯ç½‘ç»œæ–­äº†ï¼Œäºæ˜¯ clienté‡è¿ï¼Œåˆç”¨äº†1åšISNï¼Œä½†æ˜¯ä¹‹å‰è¿æ¥çš„é‚£äº›åŒ…åˆ°äº†ï¼Œäºæ˜¯å°±è¢«å½“æˆäº†æ–°è¿æ¥çš„åŒ…ï¼Œæ­¤æ—¶ï¼Œclientçš„Sequence Number å¯èƒ½æ˜¯3ï¼Œè€ŒServerç«¯è®¤ä¸ºclientç«¯çš„è¿™ä¸ªå·æ˜¯30äº†ã€‚å…¨ä¹±äº†ã€‚<a href="http://tools.ietf.org/html/rfc793" target="_blank" rel="external">RFC793</a>ä¸­è¯´ï¼ŒISNä¼šå’Œä¸€ä¸ªå‡çš„æ—¶é’Ÿç»‘åœ¨ä¸€èµ·ï¼Œè¿™ä¸ªæ—¶é’Ÿä¼šåœ¨æ¯4å¾®ç§’å¯¹ISNåšåŠ ä¸€æ“ä½œï¼Œç›´åˆ°è¶…è¿‡2^32ï¼Œåˆä»0å¼€å§‹ã€‚è¿™æ ·ï¼Œä¸€ä¸ªISNçš„å‘¨æœŸå¤§çº¦æ˜¯4.55ä¸ªå°æ—¶ã€‚å› ä¸ºï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬çš„TCP Segmentåœ¨ç½‘ç»œä¸Šçš„å­˜æ´»æ—¶é—´ä¸ä¼šè¶…è¿‡Maximum Segment Lifetimeï¼ˆç¼©å†™ä¸ºMSL â€“ <a href="http://en.wikipedia.org/wiki/Maximum_Segment_Lifetime" target="_blank" rel="external">Wikipediaè¯­æ¡</a>ï¼‰ï¼Œæ‰€ä»¥ï¼Œåªè¦MSLçš„å€¼å°äº4.55å°æ—¶ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±ä¸ä¼šé‡ç”¨åˆ°ISNã€‚</li>
<li><strong>å…³äº MSL å’Œ TIME_WAIT</strong>ã€‚é€šè¿‡ä¸Šé¢çš„ISNçš„æè¿°ï¼Œç›¸ä¿¡ä½ ä¹ŸçŸ¥é“MSLæ˜¯æ€ä¹ˆæ¥çš„äº†ã€‚æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œåœ¨TCPçš„çŠ¶æ€å›¾ä¸­ï¼Œä»TIME_WAITçŠ¶æ€åˆ°CLOSEDçŠ¶æ€ï¼Œæœ‰ä¸€ä¸ªè¶…æ—¶è®¾ç½®ï¼Œè¿™ä¸ªè¶…æ—¶è®¾ç½®æ˜¯ 2*MSLï¼ˆRFC793å®šä¹‰äº†MSLä¸º2åˆ†é’Ÿï¼ŒLinuxè®¾ç½®æˆäº†30sï¼‰ä¸ºä»€ä¹ˆè¦è¿™æœ‰TIME_WAITï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥ç»™è½¬æˆCLOSEDçŠ¶æ€å‘¢ï¼Ÿä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š1ï¼‰TIME_WAITç¡®ä¿æœ‰è¶³å¤Ÿçš„æ—¶é—´è®©å¯¹ç«¯æ”¶åˆ°äº†ACKï¼Œå¦‚æœè¢«åŠ¨å…³é—­çš„é‚£æ–¹æ²¡æœ‰æ”¶åˆ°Ackï¼Œå°±ä¼šè§¦å‘è¢«åŠ¨ç«¯é‡å‘Finï¼Œä¸€æ¥ä¸€å»æ­£å¥½2ä¸ªMSLï¼Œ2ï¼‰æœ‰è¶³å¤Ÿçš„æ—¶é—´è®©è¿™ä¸ªè¿æ¥ä¸ä¼šè·Ÿåé¢çš„è¿æ¥æ··åœ¨ä¸€èµ·ï¼ˆä½ è¦çŸ¥é“ï¼Œæœ‰äº›è‡ªåšä¸»å¼ çš„è·¯ç”±å™¨ä¼šç¼“å­˜IPæ•°æ®åŒ…ï¼Œå¦‚æœè¿æ¥è¢«é‡ç”¨äº†ï¼Œé‚£ä¹ˆè¿™äº›å»¶è¿Ÿæ”¶åˆ°çš„åŒ…å°±æœ‰å¯èƒ½ä¼šè·Ÿæ–°è¿æ¥æ··åœ¨ä¸€èµ·ï¼‰ã€‚ä½ å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ã€Š<a href="http://www.serverframework.com/asynchronousevents/2011/01/time-wait-and-its-design-implications-for-protocols-and-scalable-servers.html" target="_blank" rel="external">TIME_WAIT and its design implications for protocols and scalable client server systems</a>ã€‹</li>
<li><strong>å…³äºTIME_WAITæ•°é‡å¤ªå¤š</strong>ã€‚ä»ä¸Šé¢çš„æè¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒTIME_WAITæ˜¯ä¸ªå¾ˆé‡è¦çš„çŠ¶æ€ï¼Œä½†æ˜¯å¦‚æœåœ¨å¤§å¹¶å‘çš„çŸ­é“¾æ¥ä¸‹ï¼ŒTIME_WAIT å°±ä¼šå¤ªå¤šï¼Œè¿™ä¹Ÿä¼šæ¶ˆè€—å¾ˆå¤šç³»ç»Ÿèµ„æºã€‚åªè¦æœä¸€ä¸‹ï¼Œä½ å°±ä¼šå‘ç°ï¼Œåæœ‰å…«ä¹çš„å¤„ç†æ–¹å¼éƒ½æ˜¯æ•™ä½ è®¾ç½®ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªå«tcp_tw_reuseï¼Œå¦ä¸€ä¸ªå«tcp_tw_recycleçš„å‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°é»˜è®¤å€¼éƒ½æ˜¯è¢«å…³é—­çš„ï¼Œåè€…recyleæ¯”å‰è€…resueæ›´ä¸ºæ¿€è¿›ï¼Œresueè¦æ¸©æŸ”ä¸€äº›ã€‚å¦å¤–ï¼Œå¦‚æœä½¿ç”¨tcp_tw_reuseï¼Œå¿…éœ€è®¾ç½®tcp_timestamps=1ï¼Œå¦åˆ™æ— æ•ˆã€‚è¿™é‡Œï¼Œä½ ä¸€å®šè¦æ³¨æ„ï¼Œæ‰“å¼€è¿™ä¸¤ä¸ªå‚æ•°ä¼šæœ‰æ¯”è¾ƒå¤§çš„å‘â€”â€”å¯èƒ½ä¼šè®©TCPè¿æ¥å‡ºä¸€äº›è¯¡å¼‚çš„é—®é¢˜ï¼ˆå› ä¸ºå¦‚ä¸Šè¿°ä¸€æ ·ï¼Œå¦‚æœä¸ç­‰å¾…è¶…æ—¶é‡ç”¨è¿æ¥çš„è¯ï¼Œæ–°çš„è¿æ¥å¯èƒ½ä¼šå»ºä¸ä¸Šã€‚æ­£å¦‚å®˜æ–¹æ–‡æ¡£ä¸Šè¯´çš„ä¸€æ ·â€œ<strong>It should not be changed without advice/request of technical experts</strong>â€ï¼‰ã€‚<ul>
<li><strong>å…³äºtcp_tw_reuse</strong>ã€‚å®˜æ–¹æ–‡æ¡£ä¸Šè¯´tcp_tw_reuse åŠ ä¸Štcp_timestampsï¼ˆåˆå«PAWS, for Protection Against Wrapped Sequence Numbersï¼‰å¯ä»¥ä¿è¯åè®®çš„è§’åº¦ä¸Šçš„å®‰å…¨ï¼Œä½†æ˜¯ä½ éœ€è¦tcp_timestampsåœ¨ä¸¤è¾¹éƒ½è¢«æ‰“å¼€ï¼ˆä½ å¯ä»¥è¯»ä¸€ä¸‹<a href="http://lxr.free-electrons.com/ident?i=tcp_twsk_unique" target="_blank" rel="external">tcp_twsk_unique</a>çš„æºç  ï¼‰ã€‚æˆ‘ä¸ªäººä¼°è®¡è¿˜æ˜¯æœ‰ä¸€äº›åœºæ™¯ä¼šæœ‰é—®é¢˜ã€‚</li>
<li><strong>å…³äºtcp_tw_recycle</strong>ã€‚å¦‚æœæ˜¯tcp_tw_recycleè¢«æ‰“å¼€äº†è¯ï¼Œä¼šå‡è®¾å¯¹ç«¯å¼€å¯äº†tcp_timestampsï¼Œç„¶åä¼šå»æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œå¦‚æœæ—¶é—´æˆ³å˜å¤§äº†ï¼Œå°±å¯ä»¥é‡ç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¯¹ç«¯æ˜¯ä¸€ä¸ªNATç½‘ç»œçš„è¯ï¼ˆå¦‚ï¼šä¸€ä¸ªå…¬å¸åªç”¨ä¸€ä¸ªIPå‡ºå…¬ç½‘ï¼‰æˆ–æ˜¯å¯¹ç«¯çš„IPè¢«å¦ä¸€å°é‡ç”¨äº†ï¼Œè¿™ä¸ªäº‹å°±å¤æ‚äº†ã€‚å»ºé“¾æ¥çš„SYNå¯èƒ½å°±è¢«ç›´æ¥ä¸¢æ‰äº†ï¼ˆä½ å¯èƒ½ä¼šçœ‹åˆ°connection time outçš„é”™è¯¯ï¼‰ï¼ˆå¦‚æœä½ æƒ³è§‚æ‘©ä¸€ä¸‹Linuxçš„å†…æ ¸ä»£ç ï¼Œè¯·å‚çœ‹æºç  <a href="http://lxr.free-electrons.com/ident?i=tcp_timewait_state_process" target="_blank" rel="external">tcp_timewait_state_process</a>ï¼‰ã€‚</li>
<li><strong>å…³äºtcp_max_tw_buckets</strong>ã€‚è¿™ä¸ªæ˜¯æ§åˆ¶å¹¶å‘çš„TIME_WAITçš„æ•°é‡ï¼Œé»˜è®¤å€¼æ˜¯180000ï¼Œå¦‚æœè¶…é™ï¼Œé‚£ä¹ˆï¼Œç³»ç»Ÿä¼šæŠŠå¤šçš„ç»™destoryæ‰ï¼Œç„¶ååœ¨æ—¥å¿—é‡Œæ‰“ä¸€ä¸ªè­¦å‘Šï¼ˆå¦‚ï¼štime wait bucket table overflowï¼‰ï¼Œå®˜ç½‘æ–‡æ¡£è¯´è¿™ä¸ªå‚æ•°æ˜¯ç”¨æ¥å¯¹æŠ—DDoSæ”»å‡»çš„ã€‚ä¹Ÿè¯´çš„é»˜è®¤å€¼180000å¹¶ä¸å°ã€‚è¿™ä¸ªè¿˜æ˜¯éœ€è¦æ ¹æ®å®é™…æƒ…å†µè€ƒè™‘ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>Againï¼Œä½¿ç”¨tcp_tw_reuseå’Œtcp_tw_recycleæ¥è§£å†³TIME_WAITçš„é—®é¢˜æ˜¯éå¸¸éå¸¸å±é™©çš„ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå‚æ•°è¿åäº†TCPåè®®ï¼ˆ<a href="http://tools.ietf.org/html/rfc1122" target="_blank" rel="external">RFC 1122</a>ï¼‰</p>
</blockquote>
<p>å…¶å®ï¼ŒTIME_WAITè¡¨ç¤ºçš„æ˜¯ä½ ä¸»åŠ¨æ–­è¿æ¥ï¼Œæ‰€ä»¥ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œä¸ä½œæ­»ä¸ä¼šæ­»â€ã€‚è¯•æƒ³ï¼Œå¦‚æœè®©å¯¹ç«¯æ–­è¿æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªç ´é—®é¢˜å°±æ˜¯å¯¹æ–¹çš„äº†ï¼Œå‘µå‘µã€‚å¦å¤–ï¼Œå¦‚æœä½ çš„æœåŠ¡å™¨æ˜¯äºHTTPæœåŠ¡å™¨ï¼Œé‚£ä¹ˆè®¾ç½®ä¸€ä¸ª<a href="http://en.wikipedia.org/wiki/HTTP_persistent_connection" target="_blank" rel="external">HTTPçš„KeepAlive</a>æœ‰å¤šé‡è¦ï¼ˆæµè§ˆå™¨ä¼šé‡ç”¨ä¸€ä¸ªTCPè¿æ¥æ¥å¤„ç†å¤šä¸ªHTTPè¯·æ±‚ï¼‰ï¼Œç„¶åè®©å®¢æˆ·ç«¯å»æ–­é“¾æ¥ï¼ˆä½ è¦å°å¿ƒï¼Œæµè§ˆå™¨å¯èƒ½ä¼šéå¸¸è´ªå©ªï¼Œä»–ä»¬ä¸åˆ°ä¸‡ä¸å¾—å·²ä¸ä¼šä¸»åŠ¨æ–­è¿æ¥ï¼‰ã€‚</p>
<h1 id="æ•°æ®ä¼ è¾“ä¸­çš„Sequence-Number"><a href="#æ•°æ®ä¼ è¾“ä¸­çš„Sequence-Number" class="headerlink" title="æ•°æ®ä¼ è¾“ä¸­çš„Sequence Number"></a>æ•°æ®ä¼ è¾“ä¸­çš„Sequence Number</h1><p>ä¸‹å›¾æ˜¯æˆ‘ä»Wiresharkä¸­æˆªäº†ä¸ªæˆ‘åœ¨è®¿é—®coolshell.cnæ—¶çš„æœ‰æ•°æ®ä¼ è¾“çš„å›¾ç»™ä½ çœ‹ä¸€ä¸‹ï¼ŒSeqNumæ˜¯æ€ä¹ˆå˜çš„ã€‚ï¼ˆä½¿ç”¨Wiresharkèœå•ä¸­çš„Statistics -&gt;Flow Graphâ€¦ ï¼‰<br><a href="http://idiotsky.me/images1/tcp-something-6.jpg"><img src="http://idiotsky.me/images1/tcp-something-6.jpg" alt=""></a><br>ä½ å¯ä»¥çœ‹åˆ°ï¼Œ<strong>SeqNumçš„å¢åŠ æ˜¯å’Œä¼ è¾“çš„å­—èŠ‚æ•°ç›¸å…³çš„</strong>ã€‚ä¸Šå›¾ä¸­ï¼Œä¸‰æ¬¡æ¡æ‰‹åï¼Œæ¥äº†ä¸¤ä¸ªLen:1440çš„åŒ…ï¼Œè€Œç¬¬äºŒä¸ªåŒ…çš„SeqNumå°±æˆäº†1441ã€‚ç„¶åç¬¬ä¸€ä¸ªACKå›çš„æ˜¯1441ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ª1440æ”¶åˆ°äº†ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœä½ ç”¨WiresharkæŠ“åŒ…ç¨‹åºçœ‹3æ¬¡æ¡æ‰‹ï¼Œä½ ä¼šå‘ç°SeqNumæ€»æ˜¯ä¸º0ï¼Œä¸æ˜¯è¿™æ ·çš„ï¼ŒWiresharkä¸ºäº†æ˜¾ç¤ºæ›´å‹å¥½ï¼Œä½¿ç”¨äº†Relative SeqNumâ€”â€”ç›¸å¯¹åºå·ï¼Œä½ åªè¦åœ¨å³é”®èœå•ä¸­çš„protocol preference ä¸­å–æ¶ˆæ‰å°±å¯ä»¥çœ‹åˆ°â€œAbsolute SeqNumâ€äº†</p>
<h1 id="TCPé‡ä¼ æœºåˆ¶"><a href="#TCPé‡ä¼ æœºåˆ¶" class="headerlink" title="TCPé‡ä¼ æœºåˆ¶"></a>TCPé‡ä¼ æœºåˆ¶</h1><p>TCPè¦ä¿è¯æ‰€æœ‰çš„æ•°æ®åŒ…éƒ½å¯ä»¥åˆ°è¾¾ï¼Œæ‰€ä»¥ï¼Œå¿…éœ€è¦æœ‰é‡ä¼ æœºåˆ¶ã€‚</p>
<p>æ³¨æ„ï¼Œæ¥æ”¶ç«¯ç»™å‘é€ç«¯çš„Ackç¡®è®¤åªä¼šç¡®è®¤æœ€åä¸€ä¸ªè¿ç»­çš„åŒ…ï¼Œæ¯”å¦‚ï¼Œå‘é€ç«¯å‘äº†1,2,3,4,5ä¸€å…±äº”ä»½æ•°æ®ï¼Œæ¥æ”¶ç«¯æ”¶åˆ°äº†1ï¼Œ2ï¼Œäºæ˜¯å›ack 3ï¼Œç„¶åæ”¶åˆ°äº†4ï¼ˆæ³¨æ„æ­¤æ—¶3æ²¡æ”¶åˆ°ï¼‰ï¼Œæ­¤æ—¶çš„TCPä¼šæ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬è¦çŸ¥é“ï¼Œå› ä¸ºæ­£å¦‚å‰é¢æ‰€è¯´çš„ï¼ŒSeqNumå’ŒAckæ˜¯ä»¥å­—èŠ‚æ•°ä¸ºå•ä½ï¼Œæ‰€ä»¥ackçš„æ—¶å€™ï¼Œä¸èƒ½è·³ç€ç¡®è®¤ï¼Œåªèƒ½ç¡®è®¤æœ€å¤§çš„è¿ç»­æ”¶åˆ°çš„åŒ…ï¼Œä¸ç„¶ï¼Œå‘é€ç«¯å°±ä»¥ä¸ºä¹‹å‰çš„éƒ½æ”¶åˆ°äº†ã€‚</p>
<h2 id="è¶…æ—¶é‡ä¼ æœºåˆ¶"><a href="#è¶…æ—¶é‡ä¼ æœºåˆ¶" class="headerlink" title="è¶…æ—¶é‡ä¼ æœºåˆ¶"></a>è¶…æ—¶é‡ä¼ æœºåˆ¶</h2><p>ä¸€ç§æ˜¯ä¸å›ackï¼Œæ­»ç­‰3ï¼Œå½“å‘é€æ–¹å‘ç°æ”¶ä¸åˆ°3çš„ackè¶…æ—¶åï¼Œä¼šé‡ä¼ 3ã€‚ä¸€æ—¦æ¥æ”¶æ–¹æ”¶åˆ°3åï¼Œä¼šack å› 4â€”â€”æ„å‘³ç€3å’Œ4éƒ½æ”¶åˆ°äº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼ä¼šæœ‰æ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯å› ä¸ºè¦æ­»ç­‰3ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´4å’Œ5å³ä¾¿å·²ç»æ”¶åˆ°äº†ï¼Œè€Œå‘é€æ–¹ä¹Ÿå®Œå…¨ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Œå› ä¸ºæ²¡æœ‰æ”¶åˆ°Ackï¼Œæ‰€ä»¥ï¼Œå‘é€æ–¹å¯èƒ½ä¼šæ‚²è§‚åœ°è®¤ä¸ºä¹Ÿä¸¢äº†ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¹Ÿä¼šå¯¼è‡´4å’Œ5çš„é‡ä¼ ã€‚</p>
<p>å¯¹æ­¤æœ‰ä¸¤ç§é€‰æ‹©ï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯ä»…é‡ä¼ timeoutçš„åŒ…ã€‚ä¹Ÿå°±æ˜¯ç¬¬3ä»½æ•°æ®ã€‚</li>
<li>å¦ä¸€ç§æ˜¯é‡ä¼ timeoutåæ‰€æœ‰çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ç¬¬3ï¼Œ4ï¼Œ5è¿™ä¸‰ä»½æ•°æ®ã€‚</li>
</ul>
<p>è¿™ä¸¤ç§æ–¹å¼æœ‰å¥½ä¹Ÿæœ‰ä¸å¥½ã€‚ç¬¬ä¸€ç§ä¼šèŠ‚çœå¸¦å®½ï¼Œä½†æ˜¯æ…¢ï¼Œç¬¬äºŒç§ä¼šå¿«ä¸€ç‚¹ï¼Œä½†æ˜¯ä¼šæµªè´¹å¸¦å®½ï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰æ— ç”¨åŠŸã€‚ä½†æ€»ä½“æ¥è¯´éƒ½ä¸å¥½ã€‚å› ä¸ºéƒ½åœ¨ç­‰timeoutï¼Œtimeoutå¯èƒ½ä¼šå¾ˆé•¿ï¼ˆåœ¨ä¸‹ç¯‡ä¼šè¯´TCPæ˜¯æ€ä¹ˆåŠ¨æ€åœ°è®¡ç®—å‡ºtimeoutçš„ï¼‰</p>
<h2 id="å¿«é€Ÿé‡ä¼ æœºåˆ¶"><a href="#å¿«é€Ÿé‡ä¼ æœºåˆ¶" class="headerlink" title="å¿«é€Ÿé‡ä¼ æœºåˆ¶"></a>å¿«é€Ÿé‡ä¼ æœºåˆ¶</h2><p>äºæ˜¯ï¼ŒTCPå¼•å…¥äº†ä¸€ç§å«Fast Retransmit çš„ç®—æ³•ï¼Œä¸ä»¥æ—¶é—´é©±åŠ¨ï¼Œè€Œä»¥æ•°æ®é©±åŠ¨é‡ä¼ ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœï¼ŒåŒ…æ²¡æœ‰è¿ç»­åˆ°è¾¾ï¼Œå°±ackæœ€åé‚£ä¸ªå¯èƒ½è¢«ä¸¢äº†çš„åŒ…ï¼Œå¦‚æœå‘é€æ–¹è¿ç»­æ”¶åˆ°3æ¬¡ç›¸åŒçš„ackï¼Œå°±é‡ä¼ ã€‚Fast Retransmitçš„å¥½å¤„æ˜¯ä¸ç”¨ç­‰timeoutäº†å†é‡ä¼ ã€‚</p>
<p>æ¯”å¦‚ï¼šå¦‚æœå‘é€æ–¹å‘å‡ºäº†1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ä»½æ•°æ®ï¼Œç¬¬ä¸€ä»½å…ˆåˆ°é€äº†ï¼Œäºæ˜¯å°±ackå›2ï¼Œç»“æœ2å› ä¸ºæŸäº›åŸå› æ²¡æ”¶åˆ°ï¼Œ3åˆ°è¾¾äº†ï¼Œäºæ˜¯è¿˜æ˜¯ackå›2ï¼Œåé¢çš„4å’Œ5éƒ½åˆ°äº†ï¼Œä½†æ˜¯è¿˜æ˜¯ackå›2ï¼Œå› ä¸º2è¿˜æ˜¯æ²¡æœ‰æ”¶åˆ°ï¼Œäºæ˜¯å‘é€ç«¯æ”¶åˆ°äº†ä¸‰ä¸ªack=2çš„ç¡®è®¤ï¼ŒçŸ¥é“äº†2è¿˜æ²¡æœ‰åˆ°ï¼Œäºæ˜¯å°±é©¬ä¸Šé‡è½¬2ã€‚ç„¶åï¼Œæ¥æ”¶ç«¯æ”¶åˆ°äº†2ï¼Œæ­¤æ—¶å› ä¸º3ï¼Œ4ï¼Œ5éƒ½æ”¶åˆ°äº†ï¼Œäºæ˜¯ackå›6ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><a href="http://idiotsky.me/images1/tcp-something-7.png"><img src="http://idiotsky.me/images1/tcp-something-7.png" alt=""></a><br>Fast Retransmitåªè§£å†³äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯timeoutçš„é—®é¢˜ï¼Œå®ƒä¾ç„¶é¢ä¸´ä¸€ä¸ªè‰°éš¾çš„é€‰æ‹©ï¼Œå°±æ˜¯ï¼Œæ˜¯é‡ä¼ ä¹‹å‰çš„ä¸€ä¸ªè¿˜æ˜¯é‡ä¼ æ‰€æœ‰çš„é—®é¢˜ã€‚å¯¹äºä¸Šé¢çš„ç¤ºä¾‹æ¥è¯´ï¼Œæ˜¯é‡ä¼ #2å‘¢è¿˜æ˜¯é‡ä¼ #2ï¼Œ#3ï¼Œ#4ï¼Œ#5å‘¢ï¼Ÿå› ä¸ºå‘é€ç«¯å¹¶ä¸æ¸…æ¥šè¿™è¿ç»­çš„3ä¸ªack(2)æ˜¯è°ä¼ å›æ¥çš„ï¼Ÿä¹Ÿè®¸å‘é€ç«¯å‘äº†20ä»½æ•°æ®ï¼Œæ˜¯#6ï¼Œ#10ï¼Œ#20ä¼ æ¥çš„å‘¢ã€‚è¿™æ ·ï¼Œå‘é€ç«¯å¾ˆæœ‰å¯èƒ½è¦é‡ä¼ ä»2åˆ°20çš„è¿™å †æ•°æ®ï¼ˆè¿™å°±æ˜¯æŸäº›TCPçš„å®é™…çš„å®ç°ï¼‰ã€‚å¯è§ï¼Œè¿™æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚</p>
<h2 id="SACK-æ–¹æ³•"><a href="#SACK-æ–¹æ³•" class="headerlink" title="SACK æ–¹æ³•"></a>SACK æ–¹æ³•</h2><p>å¦å¤–ä¸€ç§æ›´å¥½çš„æ–¹å¼å«ï¼šSelective Acknowledgment (SACK)ï¼ˆå‚çœ‹<a href="http://tools.ietf.org/html/rfc2018" target="_blank" rel="external">RFC 2018</a>ï¼‰ï¼Œè¿™ç§æ–¹å¼éœ€è¦åœ¨TCPå¤´é‡ŒåŠ ä¸€ä¸ªSACKçš„ä¸œè¥¿ï¼ŒACKè¿˜æ˜¯Fast Retransmitçš„ACKï¼ŒSACKåˆ™æ˜¯æ±‡æŠ¥æ”¶åˆ°çš„æ•°æ®ç¢ç‰ˆã€‚å‚çœ‹ä¸‹å›¾ï¼š<br><a href="http://idiotsky.me/images1/tcp-something-8.jpg"><img src="http://idiotsky.me/images1/tcp-something-8.jpg" alt=""></a></p>
<p>è¿™æ ·ï¼Œåœ¨å‘é€ç«¯å°±å¯ä»¥æ ¹æ®å›ä¼ çš„SACKæ¥çŸ¥é“å“ªäº›æ•°æ®åˆ°äº†ï¼Œå“ªäº›æ²¡æœ‰åˆ°ã€‚äºæ˜¯å°±ä¼˜åŒ–äº†Fast Retransmitçš„ç®—æ³•ã€‚å½“ç„¶ï¼Œè¿™ä¸ªåè®®éœ€è¦ä¸¤è¾¹éƒ½æ”¯æŒã€‚åœ¨ Linuxä¸‹ï¼Œå¯ä»¥é€šè¿‡tcp_sackå‚æ•°æ‰“å¼€è¿™ä¸ªåŠŸèƒ½ï¼ˆLinux 2.4åé»˜è®¤æ‰“å¼€ï¼‰ã€‚</p>
<p>è¿™é‡Œè¿˜éœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜â€”â€”æ¥æ”¶æ–¹Renegingï¼Œæ‰€è°“Renegingçš„æ„æ€å°±æ˜¯æ¥æ”¶æ–¹æœ‰æƒæŠŠå·²ç»æŠ¥ç»™å‘é€ç«¯SACKé‡Œçš„æ•°æ®ç»™ä¸¢äº†ã€‚è¿™æ ·å¹²æ˜¯ä¸è¢«é¼“åŠ±çš„ï¼Œå› ä¸ºè¿™ä¸ªäº‹ä¼šæŠŠé—®é¢˜å¤æ‚åŒ–äº†ï¼Œä½†æ˜¯ï¼Œæ¥æ”¶æ–¹è¿™ä¹ˆåšå¯èƒ½ä¼šæœ‰äº›æç«¯æƒ…å†µï¼Œæ¯”å¦‚è¦æŠŠå†…å­˜ç»™åˆ«çš„æ›´é‡è¦çš„ä¸œè¥¿ã€‚æ‰€ä»¥ï¼Œå‘é€æ–¹ä¹Ÿä¸èƒ½å®Œå…¨ä¾èµ–SACKï¼Œè¿˜æ˜¯è¦ä¾èµ–ACKï¼Œå¹¶ç»´æŠ¤Time-Outï¼Œå¦‚æœåç»­çš„ACKæ²¡æœ‰å¢é•¿ï¼Œé‚£ä¹ˆè¿˜æ˜¯è¦æŠŠSACKçš„ä¸œè¥¿é‡ä¼ ï¼Œå¦å¤–ï¼Œæ¥æ”¶ç«¯è¿™è¾¹æ°¸è¿œä¸èƒ½æŠŠSACKçš„åŒ…æ ‡è®°ä¸ºAckã€‚</p>
<p>æ³¨æ„ï¼šSACKä¼šæ¶ˆè´¹å‘é€æ–¹çš„èµ„æºï¼Œè¯•æƒ³ï¼Œå¦‚æœä¸€ä¸ªæ”»å‡»è€…ç»™æ•°æ®å‘é€æ–¹å‘ä¸€å †SACKçš„é€‰é¡¹ï¼Œè¿™ä¼šå¯¼è‡´å‘é€æ–¹å¼€å§‹è¦é‡ä¼ ç”šè‡³éå†å·²ç»å‘å‡ºçš„æ•°æ®ï¼Œè¿™ä¼šæ¶ˆè€—å¾ˆå¤šå‘é€ç«¯çš„èµ„æºã€‚è¯¦ç»†çš„ä¸œè¥¿è¯·å‚çœ‹ã€Š<a href="http://www.ibm.com/developerworks/cn/linux/l-tcp-sack/" target="_blank" rel="external">TCP SACKçš„æ€§èƒ½æƒè¡¡</a>ã€‹</p>
<h2 id="Duplicate-SACK-â€“-é‡å¤æ”¶åˆ°æ•°æ®çš„é—®é¢˜"><a href="#Duplicate-SACK-â€“-é‡å¤æ”¶åˆ°æ•°æ®çš„é—®é¢˜" class="headerlink" title="Duplicate SACK â€“ é‡å¤æ”¶åˆ°æ•°æ®çš„é—®é¢˜"></a>Duplicate SACK â€“ é‡å¤æ”¶åˆ°æ•°æ®çš„é—®é¢˜</h2><p>Duplicate SACKåˆç§°D-SACKï¼Œå…¶ä¸»è¦ä½¿ç”¨äº†SACKæ¥å‘Šè¯‰å‘é€æ–¹æœ‰å“ªäº›æ•°æ®è¢«é‡å¤æ¥æ”¶äº†ã€‚<a href="http://www.ietf.org/rfc/rfc2883.txt" target="_blank" rel="external">RFC-2883</a> é‡Œæœ‰è¯¦ç»†æè¿°å’Œç¤ºä¾‹ã€‚ä¸‹é¢ä¸¾å‡ ä¸ªä¾‹å­ï¼ˆæ¥æºäº<a href="http://www.ietf.org/rfc/rfc2883.txt" target="_blank" rel="external">RFC-2883</a>ï¼‰</p>
<p>D-SACKä½¿ç”¨äº†SACKçš„ç¬¬ä¸€ä¸ªæ®µæ¥åšæ ‡å¿—ï¼Œ</p>
<ul>
<li>å¦‚æœSACKçš„ç¬¬ä¸€ä¸ªæ®µçš„èŒƒå›´è¢«ACKæ‰€è¦†ç›–ï¼Œé‚£ä¹ˆå°±æ˜¯D-SACK</li>
<li>å¦‚æœSACKçš„ç¬¬ä¸€ä¸ªæ®µçš„èŒƒå›´è¢«SACKçš„ç¬¬äºŒä¸ªæ®µè¦†ç›–ï¼Œé‚£ä¹ˆå°±æ˜¯D-SACK</li>
</ul>
<h3 id="ç¤ºä¾‹ä¸€ï¼šACKä¸¢åŒ…"><a href="#ç¤ºä¾‹ä¸€ï¼šACKä¸¢åŒ…" class="headerlink" title="ç¤ºä¾‹ä¸€ï¼šACKä¸¢åŒ…"></a>ç¤ºä¾‹ä¸€ï¼šACKä¸¢åŒ…</h3><p>ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸¢äº†ä¸¤ä¸ªACKï¼Œæ‰€ä»¥ï¼Œå‘é€ç«¯é‡ä¼ äº†ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ï¼ˆ3000-3499ï¼‰ï¼Œäºæ˜¯æ¥æ”¶ç«¯å‘ç°é‡å¤æ”¶åˆ°ï¼Œäºæ˜¯å›äº†ä¸€ä¸ªSACK=3000-3500ï¼Œå› ä¸ºACKéƒ½åˆ°äº†4000æ„å‘³ç€æ”¶åˆ°äº†4000ä¹‹å‰çš„æ‰€æœ‰æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªSACKå°±æ˜¯D-SACKâ€”â€”æ—¨åœ¨å‘Šè¯‰å‘é€ç«¯æˆ‘æ”¶åˆ°äº†é‡å¤çš„æ•°æ®ï¼Œè€Œä¸”æˆ‘ä»¬çš„å‘é€ç«¯è¿˜çŸ¥é“ï¼Œæ•°æ®åŒ…æ²¡æœ‰ä¸¢ï¼Œä¸¢çš„æ˜¯ACKåŒ…ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Transmitted  Received    ACK Sent</div><div class="line">Segment      Segment     (Including SACK Blocks)</div><div class="line"> </div><div class="line">3000-3499    3000-3499   3500 (ACK dropped)</div><div class="line">3500-3999    3500-3999   4000 (ACK dropped)</div><div class="line">3000-3499    3000-3499   4000, SACK=3000-3500</div><div class="line">                                    ---------</div></pre></td></tr></table></figure></p>
<h3 id="ç¤ºä¾‹äºŒï¼Œç½‘ç»œå»¶è¯¯"><a href="#ç¤ºä¾‹äºŒï¼Œç½‘ç»œå»¶è¯¯" class="headerlink" title="ç¤ºä¾‹äºŒï¼Œç½‘ç»œå»¶è¯¯"></a>ç¤ºä¾‹äºŒï¼Œç½‘ç»œå»¶è¯¯</h3><p>ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œç½‘ç»œåŒ…ï¼ˆ1000-1499ï¼‰è¢«ç½‘ç»œç»™å»¶è¯¯äº†ï¼Œå¯¼è‡´å‘é€æ–¹æ²¡æœ‰æ”¶åˆ°ACKï¼Œè€Œåé¢åˆ°è¾¾çš„ä¸‰ä¸ªåŒ…è§¦å‘äº†â€œFast Retransmitç®—æ³•â€ï¼Œæ‰€ä»¥é‡ä¼ ï¼Œä½†é‡ä¼ æ—¶ï¼Œè¢«å»¶è¯¯çš„åŒ…åˆåˆ°äº†ï¼Œæ‰€ä»¥ï¼Œå›äº†ä¸€ä¸ªSACK=1000-1500ï¼Œå› ä¸ºACKå·²åˆ°äº†3000ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªSACKæ˜¯D-SACKâ€”â€”æ ‡è¯†æ”¶åˆ°äº†é‡å¤çš„åŒ…ã€‚</p>
<p>è¿™ä¸ªæ¡ˆä¾‹ä¸‹ï¼Œå‘é€ç«¯çŸ¥é“ä¹‹å‰å› ä¸ºâ€œFast Retransmitç®—æ³•â€è§¦å‘çš„é‡ä¼ ä¸æ˜¯å› ä¸ºå‘å‡ºå»çš„åŒ…ä¸¢äº†ï¼Œä¹Ÿä¸æ˜¯å› ä¸ºå›åº”çš„ACKåŒ…ä¸¢äº†ï¼Œè€Œæ˜¯å› ä¸ºç½‘ç»œå»¶æ—¶äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Transmitted    Received    ACK Sent</div><div class="line">Segment        Segment     (Including SACK Blocks)</div><div class="line"> </div><div class="line">500-999        500-999     1000</div><div class="line">1000-1499      (delayed)</div><div class="line">1500-1999      1500-1999   1000, SACK=1500-2000</div><div class="line">2000-2499      2000-2499   1000, SACK=1500-2500</div><div class="line">2500-2999      2500-2999   1000, SACK=1500-3000</div><div class="line">1000-1499      1000-1499   3000</div><div class="line">               1000-1499   3000, SACK=1000-1500</div><div class="line">                                      ---------</div></pre></td></tr></table></figure></p>
<p>å¯è§ï¼Œå¼•å…¥äº†D-SACKï¼Œæœ‰è¿™ä¹ˆå‡ ä¸ªå¥½å¤„ï¼š</p>
<ol>
<li>å¯ä»¥è®©å‘é€æ–¹çŸ¥é“ï¼Œæ˜¯å‘å‡ºå»çš„åŒ…ä¸¢äº†ï¼Œè¿˜æ˜¯å›æ¥çš„ACKåŒ…ä¸¢äº†ã€‚</li>
<li>æ˜¯ä¸æ˜¯è‡ªå·±çš„timeoutå¤ªå°äº†ï¼Œå¯¼è‡´é‡ä¼ ã€‚</li>
<li>ç½‘ç»œä¸Šå‡ºç°äº†å…ˆå‘çš„åŒ…ååˆ°çš„æƒ…å†µï¼ˆåˆç§°reorderingï¼‰</li>
<li>ç½‘ç»œä¸Šæ˜¯ä¸æ˜¯æŠŠæˆ‘çš„æ•°æ®åŒ…ç»™å¤åˆ¶äº†ã€‚</li>
</ol>
<p>çŸ¥é“è¿™äº›ä¸œè¥¿å¯ä»¥å¾ˆå¥½å¾—å¸®åŠ©TCPäº†è§£ç½‘ç»œæƒ…å†µï¼Œä»è€Œå¯ä»¥æ›´å¥½çš„åšç½‘ç»œä¸Šçš„æµæ§ã€‚<br>Linuxä¸‹çš„tcp_dsackå‚æ•°ç”¨äºå¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼ˆLinux 2.4åé»˜è®¤æ‰“å¼€ï¼‰</p>
<h1 id="TCPçš„RTTç®—æ³•"><a href="#TCPçš„RTTç®—æ³•" class="headerlink" title="TCPçš„RTTç®—æ³•"></a>TCPçš„RTTç®—æ³•</h1><p>ä»å‰é¢çš„TCPé‡ä¼ æœºåˆ¶æˆ‘ä»¬çŸ¥é“Timeoutçš„è®¾ç½®å¯¹äºé‡ä¼ éå¸¸é‡è¦ã€‚</p>
<ul>
<li>è®¾é•¿äº†ï¼Œé‡å‘å°±æ…¢ï¼Œä¸¢äº†è€åŠå¤©æ‰é‡å‘ï¼Œæ²¡æœ‰æ•ˆç‡ï¼Œæ€§èƒ½å·®ï¼›</li>
<li>è®¾çŸ­äº†ï¼Œä¼šå¯¼è‡´å¯èƒ½å¹¶æ²¡æœ‰ä¸¢å°±é‡å‘ã€‚äºæ˜¯é‡å‘çš„å°±å¿«ï¼Œä¼šå¢åŠ ç½‘ç»œæ‹¥å¡ï¼Œå¯¼è‡´æ›´å¤šçš„è¶…æ—¶ï¼Œæ›´å¤šçš„è¶…æ—¶å¯¼è‡´æ›´å¤šçš„é‡å‘ã€‚</li>
</ul>
<p>è€Œä¸”ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´åœ¨ä¸åŒçš„ç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œæ ¹æœ¬æ²¡æœ‰åŠæ³•è®¾ç½®ä¸€ä¸ªæ­»çš„å€¼ã€‚åªèƒ½åŠ¨æ€åœ°è®¾ç½®ã€‚ ä¸ºäº†åŠ¨æ€åœ°è®¾ç½®ï¼ŒTCPå¼•å…¥äº†RTTâ€”â€”Round Trip Timeï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ•°æ®åŒ…ä»å‘å‡ºå»åˆ°å›æ¥çš„æ—¶é—´ã€‚è¿™æ ·å‘é€ç«¯å°±å¤§çº¦çŸ¥é“éœ€è¦å¤šå°‘çš„æ—¶é—´ï¼Œä»è€Œå¯ä»¥æ–¹ä¾¿åœ°è®¾ç½®Timeoutâ€”â€”RTOï¼ˆRetransmission TimeOutï¼‰ï¼Œä»¥è®©æˆ‘ä»¬çš„é‡ä¼ æœºåˆ¶æ›´é«˜æ•ˆã€‚ å¬èµ·æ¥ä¼¼ä¹å¾ˆç®€å•ï¼Œå¥½åƒå°±æ˜¯åœ¨å‘é€ç«¯å‘åŒ…æ—¶è®°ä¸‹t0ï¼Œç„¶åæ¥æ”¶ç«¯å†æŠŠè¿™ä¸ªackå›æ¥æ—¶å†è®°ä¸€ä¸ªt1ï¼Œäºæ˜¯RTT = t1 â€“ t0ã€‚æ²¡é‚£ä¹ˆç®€å•ï¼Œè¿™åªæ˜¯ä¸€ä¸ªé‡‡æ ·ï¼Œä¸èƒ½ä»£è¡¨æ™®éæƒ…å†µã€‚</p>
<h2 id="ç»å…¸ç®—æ³•"><a href="#ç»å…¸ç®—æ³•" class="headerlink" title="ç»å…¸ç®—æ³•"></a>ç»å…¸ç®—æ³•</h2><p><a href="http://tools.ietf.org/html/rfc793" target="_blank" rel="external">RFC793</a>ä¸­å®šä¹‰çš„ç»å…¸ç®—æ³•æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>é¦–å…ˆï¼Œå…ˆé‡‡æ ·RTTï¼Œè®°ä¸‹æœ€è¿‘å¥½å‡ æ¬¡çš„RTTå€¼ã€‚</li>
<li>ç„¶ååšå¹³æ»‘è®¡ç®—SRTTï¼ˆ Smoothed RTTï¼‰ã€‚å…¬å¼ä¸ºï¼šï¼ˆå…¶ä¸­çš„ Î± å–å€¼åœ¨0.8 åˆ° 0.9ä¹‹é—´ï¼Œè¿™ä¸ªç®—æ³•è‹±æ–‡å«Exponential weighted moving averageï¼Œä¸­æ–‡å«ï¼šåŠ æƒç§»åŠ¨å¹³å‡ï¼‰<br>SRTT = ( Î± <em> SRTT ) + ((1- Î±) </em> RTT)</li>
<li>å¼€å§‹è®¡ç®—RTOã€‚å…¬å¼å¦‚ä¸‹ï¼š<br>RTO = min [ UBOUND,  max [ LBOUND,   (Î² * SRTT) ]  ]</li>
</ol>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>UBOUNDæ˜¯æœ€å¤§çš„timeoutæ—¶é—´ï¼Œä¸Šé™å€¼</li>
<li>LBOUNDæ˜¯æœ€å°çš„timeoutæ—¶é—´ï¼Œä¸‹é™å€¼</li>
<li>Î² å€¼ä¸€èˆ¬åœ¨1.3åˆ°2.0ä¹‹é—´ã€‚</li>
</ul>
<h2 id="Karn-Partridge-ç®—æ³•"><a href="#Karn-Partridge-ç®—æ³•" class="headerlink" title="Karn / Partridge ç®—æ³•"></a>Karn / Partridge ç®—æ³•</h2><p>ä½†æ˜¯ä¸Šé¢çš„è¿™ä¸ªç®—æ³•åœ¨é‡ä¼ çš„æ—¶å€™ä¼šå‡ºæœ‰ä¸€ä¸ªç»ˆæé—®é¢˜â€”â€”ä½ æ˜¯ç”¨ç¬¬ä¸€æ¬¡å‘æ•°æ®çš„æ—¶é—´å’Œackå›æ¥çš„æ—¶é—´åšRTTæ ·æœ¬å€¼ï¼Œè¿˜æ˜¯ç”¨é‡ä¼ çš„æ—¶é—´å’ŒACKå›æ¥çš„æ—¶é—´åšRTTæ ·æœ¬å€¼ï¼Ÿ</p>
<p>è¿™ä¸ªé—®é¢˜æ— è®ºä½ é€‰é‚£å¤´éƒ½æ˜¯æŒ‰ä¸‹è‘«èŠ¦èµ·äº†ç“¢ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<ul>
<li>æƒ…å†µï¼ˆaï¼‰æ˜¯ackæ²¡å›æ¥ï¼Œæ‰€ä»¥é‡ä¼ ã€‚å¦‚æœä½ è®¡ç®—ç¬¬ä¸€æ¬¡å‘é€å’ŒACKçš„æ—¶é—´ï¼Œé‚£ä¹ˆï¼Œæ˜æ˜¾ç®—å¤§äº†ã€‚</li>
<li>æƒ…å†µï¼ˆbï¼‰æ˜¯ackå›æ¥æ…¢äº†ï¼Œä½†æ˜¯å¯¼è‡´äº†é‡ä¼ ï¼Œä½†åˆšé‡ä¼ ä¸ä¸€ä¼šå„¿ï¼Œä¹‹å‰ACKå°±å›æ¥äº†ã€‚å¦‚æœä½ æ˜¯ç®—é‡ä¼ çš„æ—¶é—´å’ŒACKå›æ¥çš„æ—¶é—´çš„å·®ï¼Œå°±ä¼šç®—çŸ­äº†ã€‚<br><a href="http://idiotsky.me/images1/tcp-something-9.jpg"><img src="http://idiotsky.me/images1/tcp-something-9.jpg" alt=""></a></li>
</ul>
<p>æ‰€ä»¥1987å¹´çš„æ—¶å€™ï¼Œæäº†ä¸€ä¸ªå«<a href="http://en.wikipedia.org/wiki/Karn&#39;s_Algorithm" target="_blank" rel="external">Karn / Partridge Algorithm</a>ï¼Œè¿™ä¸ªç®—æ³•çš„æœ€å¤§ç‰¹ç‚¹æ˜¯â€”â€”<strong>å¿½ç•¥é‡ä¼ ï¼Œä¸æŠŠé‡ä¼ çš„RTTåšé‡‡æ ·</strong>ï¼ˆä½ çœ‹ï¼Œä½ ä¸éœ€è¦å»è§£å†³ä¸å­˜åœ¨çš„é—®é¢˜ï¼‰ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåˆä¼šå¼•å‘ä¸€ä¸ªå¤§BUGâ€”â€”<strong>å¦‚æœåœ¨æŸä¸€æ—¶é—´ï¼Œç½‘ç»œé—ªåŠ¨ï¼Œçªç„¶å˜æ…¢äº†ï¼Œäº§ç”Ÿäº†æ¯”è¾ƒå¤§çš„å»¶æ—¶ï¼Œè¿™ä¸ªå»¶æ—¶å¯¼è‡´è¦é‡è½¬æ‰€æœ‰çš„åŒ…ï¼ˆå› ä¸ºä¹‹å‰çš„RTOå¾ˆå°ï¼‰ï¼Œäºæ˜¯ï¼Œå› ä¸ºé‡è½¬çš„ä¸ç®—ï¼Œæ‰€ä»¥ï¼ŒRTOå°±ä¸ä¼šè¢«æ›´æ–°ï¼Œè¿™æ˜¯ä¸€ä¸ªç¾éš¾</strong>ã€‚ äºæ˜¯Karnç®—æ³•ç”¨äº†ä¸€ä¸ªå–å·§çš„æ–¹å¼â€”â€”åªè¦ä¸€å‘ç”Ÿé‡ä¼ ï¼Œå°±å¯¹ç°æœ‰çš„RTOå€¼ç¿»å€ï¼ˆè¿™å°±æ˜¯æ‰€è°“çš„ Exponential backoffï¼‰ï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™ç§æ­»è§„çŸ©å¯¹äºä¸€ä¸ªéœ€è¦ä¼°è®¡æ¯”è¾ƒå‡†ç¡®çš„RTTä¹Ÿä¸é è°±ã€‚</p>
<h2 id="Jacobson-Karels-ç®—æ³•"><a href="#Jacobson-Karels-ç®—æ³•" class="headerlink" title="Jacobson / Karels ç®—æ³•"></a>Jacobson / Karels ç®—æ³•</h2><p>å‰é¢ä¸¤ç§ç®—æ³•ç”¨çš„éƒ½æ˜¯â€œåŠ æƒç§»åŠ¨å¹³å‡â€ï¼Œè¿™ç§æ–¹æ³•æœ€å¤§çš„æ¯›ç—…å°±æ˜¯å¦‚æœRTTæœ‰ä¸€ä¸ªå¤§çš„æ³¢åŠ¨çš„è¯ï¼Œå¾ˆéš¾è¢«å‘ç°ï¼Œå› ä¸ºè¢«å¹³æ»‘æ‰äº†ã€‚æ‰€ä»¥ï¼Œ1988å¹´ï¼Œåˆæœ‰äººæ¨å‡ºæ¥äº†ä¸€ä¸ªæ–°çš„ç®—æ³•ï¼Œè¿™ä¸ªç®—æ³•å«Jacobson / Karels Algorithmï¼ˆå‚çœ‹<a href="http://tools.ietf.org/html/rfc6298" target="_blank" rel="external">RFC6289</a>ï¼‰ã€‚è¿™ä¸ªç®—æ³•å¼•å…¥äº†æœ€æ–°çš„RTTçš„é‡‡æ ·å’Œå¹³æ»‘è¿‡çš„SRTTçš„å·®è·åšå› å­æ¥è®¡ç®—ã€‚ å…¬å¼å¦‚ä¸‹ï¼šï¼ˆå…¶ä¸­çš„DevRTTæ˜¯Deviation RTTçš„æ„æ€ï¼‰<br>SRTT = SRTT + Î± (RTT â€“ SRTT)  â€”â€” è®¡ç®—å¹³æ»‘RTT</p>
<p>DevRTT = (1-Î²)*DevRTT + Î²*(|RTT-SRTT|) â€”â€”è®¡ç®—å¹³æ»‘RTTå’ŒçœŸå®çš„å·®è·ï¼ˆåŠ æƒç§»åŠ¨å¹³å‡ï¼‰</p>
<p>RTO= Âµ <em> SRTT + âˆ‚ </em>DevRTT â€”â€” ç¥ä¸€æ ·çš„å…¬å¼</p>
<p>ï¼ˆå…¶ä¸­ï¼šåœ¨Linuxä¸‹ï¼ŒÎ± = 0.125ï¼ŒÎ² = 0.25ï¼Œ Î¼ = 1ï¼Œâˆ‚ = 4 â€”â€”è¿™å°±æ˜¯ç®—æ³•ä¸­çš„â€œè°ƒå¾—ä¸€æ‰‹å¥½å‚æ•°â€ï¼Œnobody knows why, it just worksâ€¦ï¼‰ æœ€åçš„è¿™ä¸ªç®—æ³•åœ¨è¢«ç”¨åœ¨ä»Šå¤©çš„TCPåè®®ä¸­ï¼ˆLinuxçš„æºä»£ç åœ¨ï¼štcp_rtt_estimatorï¼‰ã€‚</p>
<h1 id="TCPæ»‘åŠ¨çª—å£"><a href="#TCPæ»‘åŠ¨çª—å£" class="headerlink" title="TCPæ»‘åŠ¨çª—å£"></a>TCPæ»‘åŠ¨çª—å£</h1><p>éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œå¦‚æœä½ ä¸äº†è§£TCPçš„æ»‘åŠ¨çª—å£è¿™ä¸ªäº‹ï¼Œä½ ç­‰äºä¸äº†è§£TCPåè®®ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ<strong>TCPå¿…éœ€è¦è§£å†³çš„å¯é ä¼ è¾“ä»¥åŠåŒ…ä¹±åºï¼ˆreorderingï¼‰çš„é—®é¢˜</strong>ï¼Œæ‰€ä»¥ï¼ŒTCPå¿…éœ€è¦çŸ¥é“ç½‘ç»œå®é™…çš„æ•°æ®å¤„ç†å¸¦å®½æˆ–æ˜¯æ•°æ®å¤„ç†é€Ÿåº¦ï¼Œè¿™æ ·æ‰ä¸ä¼šå¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œå¯¼è‡´ä¸¢åŒ…ã€‚</p>
<p>æ‰€ä»¥ï¼ŒTCPå¼•å…¥äº†ä¸€äº›æŠ€æœ¯å’Œè®¾è®¡æ¥åšç½‘ç»œæµæ§ï¼ŒSliding Windowæ˜¯å…¶ä¸­ä¸€ä¸ªæŠ€æœ¯ã€‚ å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼ŒTCPå¤´é‡Œæœ‰ä¸€ä¸ªå­—æ®µå«Windowï¼Œåˆå«Advertised-Windowï¼Œè¿™ä¸ªå­—æ®µæ˜¯æ¥æ”¶ç«¯å‘Šè¯‰å‘é€ç«¯è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥æ¥æ”¶æ•°æ®ã€‚äºæ˜¯å‘é€ç«¯å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›æ¥å‘é€æ•°æ®ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¥æ”¶ç«¯å¤„ç†ä¸è¿‡æ¥ã€‚ ä¸ºäº†è¯´æ˜æ»‘åŠ¨çª—å£ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸€ä¸‹TCPç¼“å†²åŒºçš„ä¸€äº›æ•°æ®ç»“æ„ï¼š<br><a href="http://idiotsky.me/images1/tcp-something-10.jpg"><img src="http://idiotsky.me/images1/tcp-something-10.jpg" alt=""></a></p>
<p>ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>æ¥æ”¶ç«¯LastByteReadæŒ‡å‘äº†TCPç¼“å†²åŒºä¸­è¯»åˆ°çš„ä½ç½®ï¼ŒNextByteExpectedæŒ‡å‘çš„åœ°æ–¹æ˜¯æ”¶åˆ°çš„è¿ç»­åŒ…çš„æœ€åä¸€ä¸ªä½ç½®ï¼ŒLastByteRcvedæŒ‡å‘çš„æ˜¯æ”¶åˆ°çš„åŒ…çš„æœ€åä¸€ä¸ªä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸­é—´æœ‰äº›æ•°æ®è¿˜æ²¡æœ‰åˆ°è¾¾ï¼Œæ‰€ä»¥æœ‰æ•°æ®ç©ºç™½åŒºã€‚</li>
<li>å‘é€ç«¯çš„LastByteAckedæŒ‡å‘äº†è¢«æ¥æ”¶ç«¯Ackè¿‡çš„ä½ç½®ï¼ˆè¡¨ç¤ºæˆåŠŸå‘é€ç¡®è®¤ï¼‰ï¼ŒLastByteSentè¡¨ç¤ºå‘å‡ºå»äº†ï¼Œä½†è¿˜æ²¡æœ‰æ”¶åˆ°æˆåŠŸç¡®è®¤çš„Ackï¼ŒLastByteWrittenæŒ‡å‘çš„æ˜¯ä¸Šå±‚åº”ç”¨æ­£åœ¨å†™çš„åœ°æ–¹ã€‚</li>
</ul>
<p>äºæ˜¯ï¼š</p>
<ul>
<li>æ¥æ”¶ç«¯åœ¨ç»™å‘é€ç«¯å›ACKä¸­ä¼šæ±‡æŠ¥è‡ªå·±çš„AdvertisedWindow = MaxRcvBuffer â€“ LastByteRcvd â€“ 1;</li>
<li>è€Œå‘é€æ–¹ä¼šæ ¹æ®è¿™ä¸ªçª—å£æ¥æ§åˆ¶å‘é€æ•°æ®çš„å¤§å°ï¼Œä»¥ä¿è¯æ¥æ”¶æ–¹å¯ä»¥å¤„ç†ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‘é€æ–¹çš„æ»‘åŠ¨çª—å£ç¤ºæ„å›¾ï¼š<br><a href="http://idiotsky.me/images1/tcp-something-11.png"><img src="http://idiotsky.me/images1/tcp-something-11.png" alt=""></a></p>
<p>ä¸Šå›¾ä¸­åˆ†æˆäº†å››ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ï¼šï¼ˆå…¶ä¸­é‚£ä¸ªé»‘æ¨¡å‹å°±æ˜¯æ»‘åŠ¨çª—å£ï¼‰</p>
<ul>
<li>#1å·²æ”¶åˆ°ackç¡®è®¤çš„æ•°æ®ã€‚</li>
<li>#2å‘è¿˜æ²¡æ”¶åˆ°ackçš„ã€‚</li>
<li>#3åœ¨çª—å£ä¸­è¿˜æ²¡æœ‰å‘å‡ºçš„ï¼ˆæ¥æ”¶æ–¹è¿˜æœ‰ç©ºé—´ï¼‰ã€‚</li>
<li>#4çª—å£ä»¥å¤–çš„æ•°æ®ï¼ˆæ¥æ”¶æ–¹æ²¡ç©ºé—´ï¼‰</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸ªæ»‘åŠ¨åçš„ç¤ºæ„å›¾ï¼ˆæ”¶åˆ°36çš„ackï¼Œå¹¶å‘å‡ºäº†46-51çš„å­—èŠ‚ï¼‰ï¼š<br><a href="http://idiotsky.me/images1/tcp-something-12.png"><img src="http://idiotsky.me/images1/tcp-something-12.png" alt=""></a></p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¥å—ç«¯æ§åˆ¶å‘é€ç«¯çš„å›¾ç¤ºï¼š<br><a href="http://idiotsky.me/images1/tcp-something-13.png"><img src="http://idiotsky.me/images1/tcp-something-13.png" alt=""></a></p>
<h2 id="Zero-Window"><a href="#Zero-Window" class="headerlink" title="Zero Window"></a>Zero Window</h2><p>ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¤„ç†ç¼“æ…¢çš„Serverï¼ˆæ¥æ”¶ç«¯ï¼‰æ˜¯æ€ä¹ˆæŠŠClientï¼ˆå‘é€ç«¯ï¼‰çš„TCP Sliding Windowç»™é™æˆ0çš„ã€‚æ­¤æ—¶ï¼Œä½ ä¸€å®šä¼šé—®ï¼Œå¦‚æœWindowå˜æˆ0äº†ï¼ŒTCPä¼šæ€ä¹ˆæ ·ï¼Ÿæ˜¯ä¸æ˜¯å‘é€ç«¯å°±ä¸å‘æ•°æ®äº†ï¼Ÿæ˜¯çš„ï¼Œå‘é€ç«¯å°±ä¸å‘æ•°æ®äº†ï¼Œä½ å¯ä»¥æƒ³åƒæˆâ€œWindow Closedâ€ï¼Œé‚£ä½ ä¸€å®šè¿˜ä¼šé—®ï¼Œå¦‚æœå‘é€ç«¯ä¸å‘æ•°æ®äº†ï¼Œæ¥æ”¶æ–¹ä¸€ä¼šå„¿Window size å¯ç”¨äº†ï¼Œæ€ä¹ˆé€šçŸ¥å‘é€ç«¯å‘¢ï¼Ÿ</p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTCPä½¿ç”¨äº†Zero Window ProbeæŠ€æœ¯ï¼Œç¼©å†™ä¸ºZWPï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€ç«¯åœ¨çª—å£å˜æˆ0åï¼Œä¼šå‘ZWPçš„åŒ…ç»™æ¥æ”¶æ–¹ï¼Œè®©æ¥æ”¶æ–¹æ¥ackä»–çš„Windowå°ºå¯¸ï¼Œä¸€èˆ¬è¿™ä¸ªå€¼ä¼šè®¾ç½®æˆ3æ¬¡ï¼Œç¬¬æ¬¡å¤§çº¦30-60ç§’ï¼ˆä¸åŒçš„å®ç°å¯èƒ½ä¼šä¸ä¸€æ ·ï¼‰ã€‚å¦‚æœ3æ¬¡è¿‡åè¿˜æ˜¯0çš„è¯ï¼Œæœ‰çš„TCPå®ç°å°±ä¼šå‘RSTæŠŠé“¾æ¥æ–­äº†ã€‚</p>
<p><strong>æ³¨æ„</strong>ï¼šåªè¦æœ‰ç­‰å¾…çš„åœ°æ–¹éƒ½å¯èƒ½å‡ºç°DDoSæ”»å‡»ï¼ŒZero Windowä¹Ÿä¸ä¾‹å¤–ï¼Œä¸€äº›æ”»å‡»è€…ä¼šåœ¨å’ŒHTTPå»ºå¥½é“¾å‘å®ŒGETè¯·æ±‚åï¼Œå°±æŠŠWindowè®¾ç½®ä¸º0ï¼Œç„¶åæœåŠ¡ç«¯å°±åªèƒ½ç­‰å¾…è¿›è¡ŒZWPï¼Œäºæ˜¯æ”»å‡»è€…ä¼šå¹¶å‘å¤§é‡çš„è¿™æ ·çš„è¯·æ±‚ï¼ŒæŠŠæœåŠ¡å™¨ç«¯çš„èµ„æºè€—å°½ã€‚ï¼ˆå…³äºè¿™æ–¹é¢çš„æ”»å‡»ï¼Œå¤§å®¶å¯ä»¥ç§»æ­¥çœ‹ä¸€ä¸‹<a href="http://en.wikipedia.org/wiki/Sockstress" target="_blank" rel="external">Wikipediaçš„SockStressè¯æ¡</a>ï¼‰</p>
<p>å¦å¤–ï¼ŒWiresharkä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨tcp.analysis.zero_windowæ¥è¿‡æ»¤åŒ…ï¼Œç„¶åä½¿ç”¨å³é”®èœå•é‡Œçš„follow TCP streamï¼Œä½ å¯ä»¥çœ‹åˆ°ZeroWindowProbeåŠZeroWindowProbeAckçš„åŒ…ã€‚</p>
<h2 id="Silly-Window-Syndrome"><a href="#Silly-Window-Syndrome" class="headerlink" title="Silly Window Syndrome"></a>Silly Window Syndrome</h2><p>Silly Window Syndromeç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯â€œç³Šæ¶‚çª—å£ç»¼åˆç—‡â€ã€‚æ­£å¦‚ä½ ä¸Šé¢çœ‹åˆ°çš„ä¸€æ ·ï¼Œå¦‚æœæˆ‘ä»¬çš„æ¥æ”¶æ–¹å¤ªå¿™äº†ï¼Œæ¥ä¸åŠå–èµ°Receive Windowsé‡Œçš„æ•°æ®ï¼Œé‚£ä¹ˆï¼Œå°±ä¼šå¯¼è‡´å‘é€æ–¹è¶Šæ¥è¶Šå°ã€‚åˆ°æœ€åï¼Œå¦‚æœæ¥æ”¶æ–¹è…¾å‡ºå‡ ä¸ªå­—èŠ‚å¹¶å‘Šè¯‰å‘é€æ–¹ç°åœ¨æœ‰å‡ ä¸ªå­—èŠ‚çš„windowï¼Œè€Œæˆ‘ä»¬çš„å‘é€æ–¹ä¼šä¹‰æ— åé¡¾åœ°å‘é€è¿™å‡ ä¸ªå­—èŠ‚ã€‚</p>
<p>è¦çŸ¥é“ï¼Œæˆ‘ä»¬çš„TCP+IPå¤´æœ‰40ä¸ªå­—èŠ‚ï¼Œä¸ºäº†å‡ ä¸ªå­—èŠ‚ï¼Œè¦è¾¾ä¸Šè¿™ä¹ˆå¤§çš„å¼€é”€ï¼Œè¿™å¤ªä¸ç»æµäº†ã€‚</p>
<p>å¦å¤–ï¼Œä½ éœ€è¦çŸ¥é“ç½‘ç»œä¸Šæœ‰ä¸ªMTUï¼Œå¯¹äºä»¥å¤ªç½‘æ¥è¯´ï¼ŒMTUæ˜¯1500å­—èŠ‚ï¼Œé™¤å»TCP+IPå¤´çš„40ä¸ªå­—èŠ‚ï¼ŒçœŸæ­£çš„æ•°æ®ä¼ è¾“å¯ä»¥æœ‰1460ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„MSSï¼ˆMax Segment Sizeï¼‰æ³¨æ„ï¼ŒTCPçš„RFCå®šä¹‰è¿™ä¸ªMSSçš„é»˜è®¤å€¼æ˜¯536ï¼Œè¿™æ˜¯å› ä¸º RFC 791é‡Œè¯´äº†ä»»ä½•ä¸€ä¸ªIPè®¾å¤‡éƒ½å¾—æœ€å°‘æ¥æ”¶576å°ºå¯¸çš„å¤§å°ï¼ˆå®é™…ä¸Šæ¥è¯´576æ˜¯æ‹¨å·çš„ç½‘ç»œçš„MTUï¼Œè€Œ576å‡å»IPå¤´çš„20ä¸ªå­—èŠ‚å°±æ˜¯536ï¼‰ã€‚</p>
<p><strong>å¦‚æœä½ çš„ç½‘ç»œåŒ…å¯ä»¥å¡æ»¡MTUï¼Œé‚£ä¹ˆä½ å¯ä»¥ç”¨æ»¡æ•´ä¸ªå¸¦å®½ï¼Œå¦‚æœä¸èƒ½ï¼Œé‚£ä¹ˆä½ å°±ä¼šæµªè´¹å¸¦å®½</strong>ã€‚ï¼ˆå¤§äºMTUçš„åŒ…æœ‰ä¸¤ç§ç»“å±€ï¼Œä¸€ç§æ˜¯ç›´æ¥è¢«ä¸¢äº†ï¼Œå¦ä¸€ç§æ˜¯ä¼šè¢«é‡æ–°åˆ†å—æ‰“åŒ…å‘é€ï¼‰ ä½ å¯ä»¥æƒ³åƒæˆä¸€ä¸ªMTUå°±ç›¸å½“äºä¸€ä¸ªé£æœºçš„æœ€å¤šå¯ä»¥è£…çš„äººï¼Œå¦‚æœè¿™é£æœºé‡Œæ»¡è½½çš„è¯ï¼Œå¸¦å®½æœ€é«˜ï¼Œå¦‚æœä¸€ä¸ªé£æœºåªè¿ä¸€ä¸ªäººçš„è¯ï¼Œæ— ç–‘æˆæœ¬å¢åŠ äº†ï¼Œä¹Ÿè€Œç›¸å½“äºŒã€‚</p>
<p>æ‰€ä»¥ï¼Œ<strong>Silly Windows Syndromeè¿™ä¸ªç°åƒå°±åƒæ˜¯ä½ æœ¬æ¥å¯ä»¥å200äººçš„é£æœºé‡Œåªåšäº†ä¸€ä¸¤ä¸ªäºº</strong>ã€‚ è¦è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿä¸éš¾ï¼Œå°±æ˜¯é¿å…å¯¹å°çš„window sizeåšå‡ºå“åº”ï¼Œç›´åˆ°æœ‰è¶³å¤Ÿå¤§çš„window sizeå†å“åº”ï¼Œè¿™ä¸ªæ€è·¯å¯ä»¥åŒæ—¶å®ç°åœ¨senderå’Œreceiverä¸¤ç«¯ã€‚</p>
<ul>
<li>å¦‚æœè¿™ä¸ªé—®é¢˜æ˜¯ç”±Receiverç«¯å¼•èµ·çš„ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨ David D Clarkâ€™s æ–¹æ¡ˆã€‚åœ¨receiverç«¯ï¼Œå¦‚æœæ”¶åˆ°çš„æ•°æ®å¯¼è‡´window sizeå°äºæŸä¸ªå€¼ï¼Œå¯ä»¥ç›´æ¥ack(0)å›senderï¼Œè¿™æ ·å°±æŠŠwindowç»™å…³é—­äº†ï¼Œä¹Ÿé˜»æ­¢äº†senderå†å‘æ•°æ®è¿‡æ¥ï¼Œç­‰åˆ°receiverç«¯å¤„ç†äº†ä¸€äº›æ•°æ®åwindows size å¤§äºç­‰äºäº†MSSï¼Œæˆ–è€…ï¼Œreceiver bufferæœ‰ä¸€åŠä¸ºç©ºï¼Œå°±å¯ä»¥æŠŠwindowæ‰“å¼€è®©send å‘é€æ•°æ®è¿‡æ¥ã€‚</li>
<li>å¦‚æœè¿™ä¸ªé—®é¢˜æ˜¯ç”±Senderç«¯å¼•èµ·çš„ï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨è‘—åçš„ Nagleâ€™s algorithmã€‚è¿™ä¸ªç®—æ³•çš„æ€è·¯ä¹Ÿæ˜¯å»¶æ—¶å¤„ç†ï¼Œä»–æœ‰ä¸¤ä¸ªä¸»è¦çš„æ¡ä»¶ï¼š1ï¼‰è¦ç­‰åˆ° Window Size&gt;=MSS æˆ–æ˜¯ Data Size &gt;=MSSï¼Œ2ï¼‰æ”¶åˆ°ä¹‹å‰å‘é€æ•°æ®çš„ackå›åŒ…ï¼Œä»–æ‰ä¼šå‘æ•°æ®ï¼Œå¦åˆ™å°±æ˜¯åœ¨æ”’æ•°æ®ã€‚</li>
</ul>
<p>å¦å¤–ï¼ŒNagleç®—æ³•é»˜è®¤æ˜¯æ‰“å¼€çš„ï¼Œæ‰€ä»¥ï¼Œå¯¹äºä¸€äº›éœ€è¦å°åŒ…åœºæ™¯çš„ç¨‹åºâ€”â€”æ¯”å¦‚åƒtelnetæˆ–sshè¿™æ ·çš„äº¤äº’æ€§æ¯”è¾ƒå¼ºçš„ç¨‹åºï¼Œä½ éœ€è¦å…³é—­è¿™ä¸ªç®—æ³•ã€‚ä½ å¯ä»¥åœ¨Socketè®¾ç½®TCP_NODELAYé€‰é¡¹æ¥å…³é—­è¿™ä¸ªç®—æ³•ï¼ˆå…³é—­Nagleç®—æ³•æ²¡æœ‰å…¨å±€å‚æ•°ï¼Œéœ€è¦æ ¹æ®æ¯ä¸ªåº”ç”¨è‡ªå·±çš„ç‰¹ç‚¹æ¥å…³é—­ï¼‰<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">setsockopt(sock_fd, IPPROTO_TCP, TCP_NODELAY, (<span class="keyword">char</span> *)&amp;value,<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</div></pre></td></tr></table></figure></p>
<p>å¦å¤–ï¼Œç½‘ä¸Šæœ‰äº›æ–‡ç« è¯´TCP_CORKçš„socket optionæ˜¯ä¹Ÿå…³é—­Nagleç®—æ³•ï¼Œè¿™ä¸å¯¹ã€‚<strong>TCP_CORKå…¶å®æ˜¯æ›´æ–°æ¿€è¿›çš„Nagleç®—æ±‰ï¼Œå®Œå…¨ç¦æ­¢å°åŒ…å‘é€ï¼Œè€ŒNagleç®—æ³•æ²¡æœ‰ç¦æ­¢å°åŒ…å‘é€ï¼Œåªæ˜¯ç¦æ­¢äº†å¤§é‡çš„å°åŒ…å‘é€</strong>ã€‚æœ€å¥½ä¸è¦ä¸¤ä¸ªé€‰é¡¹éƒ½è®¾ç½®ã€‚</p>
<h1 id="TCPçš„æ‹¥å¡å¤„ç†-â€“-Congestion-Handling"><a href="#TCPçš„æ‹¥å¡å¤„ç†-â€“-Congestion-Handling" class="headerlink" title="TCPçš„æ‹¥å¡å¤„ç† â€“ Congestion Handling"></a>TCPçš„æ‹¥å¡å¤„ç† â€“ Congestion Handling</h1><p>ä¸Šé¢æˆ‘ä»¬çŸ¥é“äº†ï¼ŒTCPé€šè¿‡Sliding Windowæ¥åšæµæ§ï¼ˆFlow Controlï¼‰ï¼Œä½†æ˜¯TCPè§‰å¾—è¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸ºSliding Windowéœ€è¦ä¾èµ–äºè¿æ¥çš„å‘é€ç«¯å’Œæ¥æ”¶ç«¯ï¼Œå…¶å¹¶ä¸çŸ¥é“ç½‘ç»œä¸­é—´å‘ç”Ÿäº†ä»€ä¹ˆã€‚TCPçš„è®¾è®¡è€…è§‰å¾—ï¼Œä¸€ä¸ªä¼Ÿå¤§è€Œç‰›é€¼çš„åè®®ä»…ä»…åšåˆ°æµæ§å¹¶ä¸å¤Ÿï¼Œå› ä¸ºæµæ§åªæ˜¯ç½‘ç»œæ¨¡å‹4å±‚ä»¥ä¸Šçš„äº‹ï¼ŒTCPçš„è¿˜åº”è¯¥æ›´èªæ˜åœ°çŸ¥é“æ•´ä¸ªç½‘ç»œä¸Šçš„äº‹ã€‚</p>
<p>å…·ä½“ä¸€ç‚¹ï¼Œæˆ‘ä»¬çŸ¥é“TCPé€šè¿‡ä¸€ä¸ªtimeré‡‡æ ·äº†RTTå¹¶è®¡ç®—RTOï¼Œä½†æ˜¯ï¼Œ<strong>å¦‚æœç½‘ç»œä¸Šçš„å»¶æ—¶çªç„¶å¢åŠ ï¼Œé‚£ä¹ˆï¼ŒTCPå¯¹è¿™ä¸ªäº‹åšå‡ºçš„åº”å¯¹åªæœ‰é‡ä¼ æ•°æ®ï¼Œä½†æ˜¯ï¼Œé‡ä¼ ä¼šå¯¼è‡´ç½‘ç»œçš„è´Ÿæ‹…æ›´é‡ï¼Œäºæ˜¯ä¼šå¯¼è‡´æ›´å¤§çš„å»¶è¿Ÿä»¥åŠæ›´å¤šçš„ä¸¢åŒ…ï¼Œäºæ˜¯ï¼Œè¿™ä¸ªæƒ…å†µå°±ä¼šè¿›å…¥æ¶æ€§å¾ªç¯è¢«ä¸æ–­åœ°æ”¾å¤§ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªç½‘ç»œå†…æœ‰æˆåƒä¸Šä¸‡çš„TCPè¿æ¥éƒ½è¿™ä¹ˆè¡Œäº‹ï¼Œé‚£ä¹ˆé©¬ä¸Šå°±ä¼šå½¢æˆâ€œç½‘ç»œé£æš´â€ï¼ŒTCPè¿™ä¸ªåè®®å°±ä¼šæ‹–å®æ•´ä¸ªç½‘ç»œ</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªç¾éš¾ã€‚</p>
<p>æ‰€ä»¥ï¼ŒTCPä¸èƒ½å¿½ç•¥ç½‘ç»œä¸Šå‘ç”Ÿçš„äº‹æƒ…ï¼Œè€Œæ— è„‘åœ°ä¸€ä¸ªåŠ²åœ°é‡å‘æ•°æ®ï¼Œå¯¹ç½‘ç»œé€ æˆæ›´å¤§çš„ä¼¤å®³ã€‚å¯¹æ­¤TCPçš„è®¾è®¡ç†å¿µæ˜¯ï¼š<strong>TCPä¸æ˜¯ä¸€ä¸ªè‡ªç§çš„åè®®ï¼Œå½“æ‹¥å¡å‘ç”Ÿçš„æ—¶å€™ï¼Œè¦åšè‡ªæˆ‘ç‰ºç‰²ã€‚å°±åƒäº¤é€šé˜»å¡ä¸€æ ·ï¼Œæ¯ä¸ªè½¦éƒ½åº”è¯¥æŠŠè·¯è®©å‡ºæ¥ï¼Œè€Œä¸è¦å†å»æŠ¢è·¯äº†</strong>ã€‚</p>
<p>å…³äºæ‹¥å¡æ§åˆ¶çš„è®ºæ–‡è¯·å‚çœ‹ã€Š<a href="http://ee.lbl.gov/papers/congavoid.pdf" target="_blank" rel="external">Congestion Avoidance and Control</a> ã€‹(PDF)</p>
<p>æ‹¥å¡æ§åˆ¶ä¸»è¦æ˜¯å››ä¸ªç®—æ³•ï¼š<strong>1ï¼‰æ…¢å¯åŠ¨ï¼Œ2ï¼‰æ‹¥å¡é¿å…ï¼Œ3ï¼‰æ‹¥å¡å‘ç”Ÿï¼Œ4ï¼‰å¿«é€Ÿæ¢å¤</strong>ã€‚è¿™å››ä¸ªç®—æ³•ä¸æ˜¯ä¸€å¤©éƒ½æå‡ºæ¥çš„ï¼Œè¿™ä¸ªå››ç®—æ³•çš„å‘å±•ç»å†äº†å¾ˆå¤šæ—¶é—´ï¼Œåˆ°ä»Šå¤©éƒ½è¿˜åœ¨ä¼˜åŒ–ä¸­ã€‚ å¤‡æ³¨:</p>
<ul>
<li>1988å¹´ï¼ŒTCP-Tahoe æå‡ºäº†1ï¼‰æ…¢å¯åŠ¨ï¼Œ2ï¼‰æ‹¥å¡é¿å…ï¼Œ3ï¼‰æ‹¥å¡å‘ç”Ÿæ—¶çš„å¿«é€Ÿé‡ä¼ </li>
<li>1990å¹´ï¼ŒTCP Reno åœ¨Tahoeçš„åŸºç¡€ä¸Šå¢åŠ äº†4ï¼‰å¿«é€Ÿæ¢å¤</li>
</ul>
<h2 id="æ…¢çƒ­å¯åŠ¨ç®—æ³•-â€“-Slow-Start"><a href="#æ…¢çƒ­å¯åŠ¨ç®—æ³•-â€“-Slow-Start" class="headerlink" title="æ…¢çƒ­å¯åŠ¨ç®—æ³• â€“ Slow Start"></a>æ…¢çƒ­å¯åŠ¨ç®—æ³• â€“ Slow Start</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹TCPçš„æ…¢çƒ­å¯åŠ¨ã€‚æ…¢å¯åŠ¨çš„æ„æ€æ˜¯ï¼ŒåˆšåˆšåŠ å…¥ç½‘ç»œçš„è¿æ¥ï¼Œä¸€ç‚¹ä¸€ç‚¹åœ°æé€Ÿï¼Œä¸è¦ä¸€ä¸Šæ¥å°±åƒé‚£äº›ç‰¹æƒè½¦ä¸€æ ·éœ¸é“åœ°æŠŠè·¯å æ»¡ã€‚æ–°åŒå­¦ä¸Šé«˜é€Ÿè¿˜æ˜¯è¦æ…¢ä¸€ç‚¹ï¼Œä¸è¦æŠŠå·²ç»åœ¨é«˜é€Ÿä¸Šçš„ç§©åºç»™æä¹±äº†ã€‚</p>
<p>æ…¢å¯åŠ¨çš„ç®—æ³•å¦‚ä¸‹(cwndå…¨ç§°Congestion Window)ï¼š</p>
<ol>
<li>è¿æ¥å»ºå¥½çš„å¼€å§‹å…ˆåˆå§‹åŒ–cwnd = 1ï¼Œè¡¨æ˜å¯ä»¥ä¼ ä¸€ä¸ªMSSå¤§å°çš„æ•°æ®ã€‚</li>
<li>æ¯å½“æ”¶åˆ°ä¸€ä¸ªACKï¼Œcwnd++; å‘ˆçº¿æ€§ä¸Šå‡</li>
<li>æ¯å½“è¿‡äº†ä¸€ä¸ªRTTï¼Œcwnd = cwnd*2; å‘ˆæŒ‡æ•°è®©å‡</li>
<li>è¿˜æœ‰ä¸€ä¸ªssthreshï¼ˆslow start thresholdï¼‰ï¼Œæ˜¯ä¸€ä¸ªä¸Šé™ï¼Œå½“cwnd &gt;= ssthreshæ—¶ï¼Œå°±ä¼šè¿›å…¥â€œæ‹¥å¡é¿å…ç®—æ³•â€ï¼ˆåé¢ä¼šè¯´è¿™ä¸ªç®—æ³•ï¼‰</li>
</ol>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœç½‘é€Ÿå¾ˆå¿«çš„è¯ï¼ŒACKä¹Ÿä¼šè¿”å›å¾—å¿«ï¼ŒRTTä¹Ÿä¼šçŸ­ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªæ…¢å¯åŠ¨å°±ä¸€ç‚¹ä¹Ÿä¸æ…¢ã€‚ä¸‹å›¾è¯´æ˜äº†è¿™ä¸ªè¿‡ç¨‹ã€‚<br><a href="http://idiotsky.me/images1/tcp-something-14.jpg"><img src="http://idiotsky.me/images1/tcp-something-14.jpg" alt=""></a></p>
<p>è¿™é‡Œï¼Œæˆ‘éœ€è¦æä¸€ä¸‹çš„æ˜¯ä¸€ç¯‡Googleçš„è®ºæ–‡ã€Š<a href="http://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36640.pdf" target="_blank" rel="external">An Argument for Increasing TCPâ€™s Initial Congestion Window</a>ã€‹Linux 3.0åé‡‡ç”¨äº†è¿™ç¯‡è®ºæ–‡çš„å»ºè®®â€”â€”æŠŠcwnd åˆå§‹åŒ–æˆäº† 10ä¸ªMSSã€‚ è€ŒLinux 3.0ä»¥å‰ï¼Œæ¯”å¦‚2.6ï¼ŒLinuxé‡‡ç”¨äº†<a href="http://www.rfc-editor.org/rfc/rfc3390.txt" target="_blank" rel="external">RFC3390</a>ï¼Œcwndæ˜¯è·ŸMSSçš„å€¼æ¥å˜çš„ï¼Œå¦‚æœMSS&lt; 1095ï¼Œåˆ™cwnd = 4ï¼›å¦‚æœMSS&gt;2190ï¼Œåˆ™cwnd=2ï¼›å…¶å®ƒæƒ…å†µä¸‹ï¼Œåˆ™æ˜¯3ã€‚</p>
<h2 id="æ‹¥å¡é¿å…ç®—æ³•-â€“-Congestion-Avoidance"><a href="#æ‹¥å¡é¿å…ç®—æ³•-â€“-Congestion-Avoidance" class="headerlink" title="æ‹¥å¡é¿å…ç®—æ³• â€“ Congestion Avoidance"></a>æ‹¥å¡é¿å…ç®—æ³• â€“ Congestion Avoidance</h2><p>å‰é¢è¯´è¿‡ï¼Œè¿˜æœ‰ä¸€ä¸ªssthreshï¼ˆslow start thresholdï¼‰ï¼Œæ˜¯ä¸€ä¸ªä¸Šé™ï¼Œå½“cwnd &gt;= ssthreshæ—¶ï¼Œå°±ä¼šè¿›å…¥â€œæ‹¥å¡é¿å…ç®—æ³•â€ã€‚ä¸€èˆ¬æ¥è¯´ssthreshçš„å€¼æ˜¯65535ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼Œå½“cwndè¾¾åˆ°è¿™ä¸ªå€¼æ—¶åï¼Œç®—æ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ”¶åˆ°ä¸€ä¸ªACKæ—¶ï¼Œcwnd = cwnd + 1/cwnd</li>
<li>å½“æ¯è¿‡ä¸€ä¸ªRTTæ—¶ï¼Œcwnd = cwnd + 1</li>
</ol>
<p>è¿™æ ·å°±å¯ä»¥é¿å…å¢é•¿è¿‡å¿«å¯¼è‡´ç½‘ç»œæ‹¥å¡ï¼Œæ…¢æ…¢çš„å¢åŠ è°ƒæ•´åˆ°ç½‘ç»œçš„æœ€ä½³å€¼ã€‚å¾ˆæ˜æ˜¾ï¼Œæ˜¯ä¸€ä¸ªçº¿æ€§ä¸Šå‡çš„ç®—æ³•ã€‚</p>
<h2 id="æ‹¥å¡çŠ¶æ€æ—¶çš„ç®—æ³•"><a href="#æ‹¥å¡çŠ¶æ€æ—¶çš„ç®—æ³•" class="headerlink" title="æ‹¥å¡çŠ¶æ€æ—¶çš„ç®—æ³•"></a>æ‹¥å¡çŠ¶æ€æ—¶çš„ç®—æ³•</h2><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œå½“ä¸¢åŒ…çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>ç­‰åˆ°RTOè¶…æ—¶ï¼Œé‡ä¼ æ•°æ®åŒ…ã€‚TCPè®¤ä¸ºè¿™ç§æƒ…å†µå¤ªç³Ÿç³•ï¼Œååº”ä¹Ÿå¾ˆå¼ºçƒˆã€‚<ul>
<li>sshthresh =  cwnd /2</li>
<li>cwnd é‡ç½®ä¸º 1</li>
<li>è¿›å…¥æ…¢å¯åŠ¨è¿‡ç¨‹</li>
</ul>
</li>
<li>Fast Retransmitç®—æ³•ï¼Œä¹Ÿå°±æ˜¯åœ¨æ”¶åˆ°3ä¸ªduplicate ACKæ—¶å°±å¼€å¯é‡ä¼ ï¼Œè€Œä¸ç”¨ç­‰åˆ°RTOè¶…æ—¶<ul>
<li>TCP Tahoeçš„å®ç°å’ŒRTOè¶…æ—¶ä¸€æ ·ã€‚</li>
<li>TCP Renoçš„å®ç°æ˜¯ï¼š<ul>
<li>cwnd = cwnd /2</li>
<li>sshthresh = cwnd</li>
<li>è¿›å…¥å¿«é€Ÿæ¢å¤ç®—æ³•â€”â€”Fast Recovery</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°RTOè¶…æ—¶åï¼Œsshthreshä¼šå˜æˆcwndçš„ä¸€åŠï¼Œè¿™æ„å‘³ç€ï¼Œå¦‚æœcwnd&lt;=sshthreshæ—¶å‡ºç°çš„ä¸¢åŒ…ï¼Œé‚£ä¹ˆTCPçš„sshthreshå°±ä¼šå‡äº†ä¸€åŠï¼Œç„¶åç­‰cwndåˆå¾ˆå¿«åœ°ä»¥æŒ‡æ•°çº§å¢æ¶¨çˆ¬åˆ°è¿™ä¸ªåœ°æ–¹æ—¶ï¼Œå°±ä¼šæˆæ…¢æ…¢çš„çº¿æ€§å¢æ¶¨ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTCPæ˜¯æ€ä¹ˆé€šè¿‡è¿™ç§å¼ºçƒˆåœ°éœ‡è¡å¿«é€Ÿè€Œå°å¿ƒå¾—æ‰¾åˆ°ç½‘ç«™æµé‡çš„å¹³è¡¡ç‚¹çš„ã€‚</p>
<h2 id="å¿«é€Ÿæ¢å¤ç®—æ³•-â€“-Fast-Recovery"><a href="#å¿«é€Ÿæ¢å¤ç®—æ³•-â€“-Fast-Recovery" class="headerlink" title="å¿«é€Ÿæ¢å¤ç®—æ³• â€“ Fast Recovery"></a>å¿«é€Ÿæ¢å¤ç®—æ³• â€“ Fast Recovery</h2><h3 id="TCP-Reno"><a href="#TCP-Reno" class="headerlink" title="TCP Reno"></a>TCP Reno</h3><p>è¿™ä¸ªç®—æ³•å®šä¹‰åœ¨<a href="http://tools.ietf.org/html/rfc5681" target="_blank" rel="external">RFC5681</a>ã€‚å¿«é€Ÿé‡ä¼ å’Œå¿«é€Ÿæ¢å¤ç®—æ³•ä¸€èˆ¬åŒæ—¶ä½¿ç”¨ã€‚å¿«é€Ÿæ¢å¤ç®—æ³•æ˜¯è®¤ä¸ºï¼Œä½ è¿˜æœ‰3ä¸ªDuplicated Acksè¯´æ˜ç½‘ç»œä¹Ÿä¸é‚£ä¹ˆç³Ÿç³•ï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦åƒRTOè¶…æ—¶é‚£ä¹ˆå¼ºçƒˆã€‚ æ³¨æ„ï¼Œæ­£å¦‚å‰é¢æ‰€è¯´ï¼Œè¿›å…¥Fast Recoveryä¹‹å‰ï¼Œcwnd å’Œ sshthreshå·²è¢«æ›´æ–°ï¼š</p>
<ul>
<li>cwnd = cwnd /2</li>
<li>sshthresh = cwnd</li>
</ul>
<p>ç„¶åï¼ŒçœŸæ­£çš„Fast Recoveryç®—æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>cwnd = sshthresh  + 3 * MSS ï¼ˆ3çš„æ„æ€æ˜¯ç¡®è®¤æœ‰3ä¸ªæ•°æ®åŒ…è¢«æ”¶åˆ°äº†ï¼‰</li>
<li>é‡ä¼ Duplicated ACKsæŒ‡å®šçš„æ•°æ®åŒ…</li>
<li>å¦‚æœå†æ”¶åˆ° duplicated Acksï¼Œé‚£ä¹ˆcwnd = cwnd +1</li>
<li>å¦‚æœæ”¶åˆ°äº†æ–°çš„Ackï¼Œé‚£ä¹ˆï¼Œcwnd = sshthresh ï¼Œç„¶åå°±è¿›å…¥äº†æ‹¥å¡é¿å…çš„ç®—æ³•äº†ã€‚</li>
</ul>
<p>å¦‚æœä½ ä»”ç»†æ€è€ƒä¸€ä¸‹ä¸Šé¢çš„è¿™ä¸ªç®—æ³•ï¼Œä½ å°±ä¼šçŸ¥é“ï¼Œ<strong>ä¸Šé¢è¿™ä¸ªç®—æ³•ä¹Ÿæœ‰é—®é¢˜ï¼Œé‚£å°±æ˜¯â€”â€”å®ƒä¾èµ–äº3ä¸ªé‡å¤çš„Acks</strong>ã€‚æ³¨æ„ï¼Œ3ä¸ªé‡å¤çš„Ackså¹¶ä¸ä»£è¡¨åªä¸¢äº†ä¸€ä¸ªæ•°æ®åŒ…ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯ä¸¢äº†å¥½å¤šåŒ…ã€‚ä½†è¿™ä¸ªç®—æ³•åªä¼šé‡ä¼ ä¸€ä¸ªï¼Œè€Œå‰©ä¸‹çš„é‚£äº›åŒ…åªèƒ½ç­‰åˆ°RTOè¶…æ—¶ï¼Œäºæ˜¯ï¼Œè¿›å…¥äº†æ¶æ¢¦æ¨¡å¼â€”â€”è¶…æ—¶ä¸€ä¸ªçª—å£å°±å‡åŠä¸€ä¸‹ï¼Œå¤šä¸ªè¶…æ—¶ä¼šè¶…æˆTCPçš„ä¼ è¾“é€Ÿåº¦å‘ˆçº§æ•°ä¸‹é™ï¼Œè€Œä¸”ä¹Ÿä¸ä¼šè§¦å‘Fast Recoveryç®—æ³•äº†ã€‚</p>
<p>é€šå¸¸æ¥è¯´ï¼Œæ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è¯´çš„ï¼ŒSACKæˆ–D-SACKçš„æ–¹æ³•å¯ä»¥è®©Fast Recoveryæˆ–Senderåœ¨åšå†³å®šæ—¶æ›´èªæ˜ä¸€äº›ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„TCPçš„å®ç°éƒ½æ”¯æŒSACKï¼ˆSACKéœ€è¦ä¸¤ç«¯éƒ½æ”¯æŒï¼‰ï¼Œæ‰€ä»¥ï¼Œéœ€è¦ä¸€ä¸ªæ²¡æœ‰SACKçš„è§£å†³æ–¹æ¡ˆã€‚è€Œé€šè¿‡SACKè¿›è¡Œæ‹¥å¡æ§åˆ¶çš„ç®—æ³•æ˜¯FACKï¼ˆåé¢ä¼šè®²ï¼‰</p>
<h3 id="TCP-New-Reno"><a href="#TCP-New-Reno" class="headerlink" title="TCP New Reno"></a>TCP New Reno</h3><p>äºæ˜¯ï¼Œ1995å¹´ï¼ŒTCP New Renoï¼ˆå‚è§ <a href="http://tools.ietf.org/html/rfc6582" target="_blank" rel="external">RFC 6582</a> ï¼‰ç®—æ³•æå‡ºæ¥ï¼Œä¸»è¦å°±æ˜¯åœ¨æ²¡æœ‰SACKçš„æ”¯æŒä¸‹æ”¹è¿›Fast Recoveryç®—æ³•çš„â€”â€”</p>
<ul>
<li>å½“senderè¿™è¾¹æ”¶åˆ°äº†3ä¸ªDuplicated Acksï¼Œè¿›å…¥Fast Retransimitæ¨¡å¼ï¼Œå¼€å‘é‡ä¼ é‡å¤AcksæŒ‡ç¤ºçš„é‚£ä¸ªåŒ…ã€‚å¦‚æœåªæœ‰è¿™ä¸€ä¸ªåŒ…ä¸¢äº†ï¼Œé‚£ä¹ˆï¼Œé‡ä¼ è¿™ä¸ªåŒ…åå›æ¥çš„Ackä¼šæŠŠæ•´ä¸ªå·²ç»è¢«senderä¼ è¾“å‡ºå»çš„æ•°æ®ackå›æ¥ã€‚å¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¯´æ˜æœ‰å¤šä¸ªåŒ…ä¸¢äº†ã€‚æˆ‘ä»¬å«è¿™ä¸ªACKä¸ºPartial ACKã€‚</li>
<li>ä¸€æ—¦Senderè¿™è¾¹å‘ç°äº†Partial ACKå‡ºç°ï¼Œé‚£ä¹ˆï¼Œsenderå°±å¯ä»¥æ¨ç†å‡ºæ¥æœ‰å¤šä¸ªåŒ…è¢«ä¸¢äº†ï¼Œäºæ˜¯ä¹ç»§ç»­é‡ä¼ sliding windowé‡Œæœªè¢«ackçš„ç¬¬ä¸€ä¸ªåŒ…ã€‚ç›´åˆ°å†ä¹Ÿæ”¶ä¸åˆ°äº†Partial Ackï¼Œæ‰çœŸæ­£ç»“æŸFast Recoveryè¿™ä¸ªè¿‡ç¨‹</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªâ€œFast Recoveryçš„å˜æ›´â€æ˜¯ä¸€ä¸ªéå¸¸æ¿€è¿›çš„ç©æ³•ï¼Œä»–åŒæ—¶å»¶é•¿äº†Fast Retransmitå’ŒFast Recoveryçš„è¿‡ç¨‹ã€‚</p>
<h2 id="ç®—æ³•ç¤ºæ„å›¾"><a href="#ç®—æ³•ç¤ºæ„å›¾" class="headerlink" title="ç®—æ³•ç¤ºæ„å›¾"></a>ç®—æ³•ç¤ºæ„å›¾</h2><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„å›¾ç¤ºä»¥åŒæ—¶çœ‹ä¸€ä¸‹ä¸Šé¢çš„å„ç§ç®—æ³•çš„æ ·å­ï¼š<br><a href="http://idiotsky.me/images1/tcp-something-15.jpg"><img src="http://idiotsky.me/images1/tcp-something-15.jpg" alt=""></a></p>
<h2 id="FACKç®—æ³•"><a href="#FACKç®—æ³•" class="headerlink" title="FACKç®—æ³•"></a>FACKç®—æ³•</h2><p>FACKå…¨ç§°Forward Acknowledgment ç®—æ³•ï¼Œè®ºæ–‡åœ°å€åœ¨è¿™é‡Œï¼ˆPDFï¼‰<a href="http://conferences.sigcomm.org/sigcomm/1996/papers/mathis.pdf" target="_blank" rel="external">Forward Acknowledgement: Refining TCP Congestion Control</a> è¿™ä¸ªç®—æ³•æ˜¯å…¶äºSACKçš„ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡SACKæ˜¯ä½¿ç”¨äº†TCPæ‰©å±•å­—æ®µAckäº†æœ‰å“ªäº›æ•°æ®æ”¶åˆ°ï¼Œå“ªäº›æ•°æ®æ²¡æœ‰æ”¶åˆ°ï¼Œä»–æ¯”Fast Retransmitçš„3 ä¸ªduplicated ackså¥½å¤„åœ¨äºï¼Œå‰è€…åªçŸ¥é“æœ‰åŒ…ä¸¢äº†ï¼Œä¸çŸ¥é“æ˜¯ä¸€ä¸ªè¿˜æ˜¯å¤šä¸ªï¼Œè€ŒSACKå¯ä»¥å‡†ç¡®çš„çŸ¥é“æœ‰å“ªäº›åŒ…ä¸¢äº†ã€‚ æ‰€ä»¥ï¼ŒSACKå¯ä»¥è®©å‘é€ç«¯è¿™è¾¹åœ¨é‡ä¼ è¿‡ç¨‹ä¸­ï¼ŒæŠŠé‚£äº›ä¸¢æ‰çš„åŒ…é‡ä¼ ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ä¼ ï¼Œä½†è¿™æ ·çš„ä¸€æ¥ï¼Œå¦‚æœé‡ä¼ çš„åŒ…æ•°æ®æ¯”è¾ƒå¤šçš„è¯ï¼Œåˆä¼šå¯¼è‡´æœ¬æ¥å°±å¾ˆå¿™çš„ç½‘ç»œå°±æ›´å¿™äº†ã€‚æ‰€ä»¥ï¼ŒFACKç”¨æ¥åšé‡ä¼ è¿‡ç¨‹ä¸­çš„æ‹¥å¡æµæ§ã€‚</p>
<ul>
<li>è¿™ä¸ªç®—æ³•ä¼šæŠŠSACKä¸­æœ€å¤§çš„Sequence Number ä¿å­˜åœ¨snd.fackè¿™ä¸ªå˜é‡ä¸­ï¼Œsnd.fackçš„æ›´æ–°ç”±ackå¸¦ç§‹ï¼Œå¦‚æœç½‘ç»œä¸€åˆ‡å®‰å¥½åˆ™å’Œsnd.unaä¸€æ ·ï¼ˆsnd.unaå°±æ˜¯è¿˜æ²¡æœ‰æ”¶åˆ°ackçš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯å‰é¢sliding windowé‡Œçš„category #2çš„ç¬¬ä¸€ä¸ªåœ°æ–¹ï¼‰</li>
<li>ç„¶åå®šä¹‰ä¸€ä¸ªawnd = snd.nxt â€“ snd.fackï¼ˆsnd.nxtæŒ‡å‘å‘é€ç«¯sliding windowä¸­æ­£åœ¨è¦è¢«å‘é€çš„åœ°æ–¹â€”â€”å‰é¢sliding windowså›¾ç¤ºçš„category#3ç¬¬ä¸€ä¸ªä½ç½®ï¼‰ï¼Œè¿™æ ·awndçš„æ„æ€å°±æ˜¯åœ¨ç½‘ç»œä¸Šçš„æ•°æ®ã€‚ï¼ˆæ‰€è°“awndæ„ä¸ºï¼šactual quantity of data outstanding in the networkï¼‰</li>
<li>å¦‚æœéœ€è¦é‡ä¼ æ•°æ®ï¼Œé‚£ä¹ˆï¼Œawnd = snd.nxt â€“ snd.fack + retran_dataï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œawndæ˜¯ä¼ å‡ºå»çš„æ•°æ® + é‡ä¼ çš„æ•°æ®ã€‚</li>
<li>ç„¶åè§¦å‘Fast Recovery çš„æ¡ä»¶æ˜¯ï¼š ( ( snd.fack â€“ snd.una ) &gt; (3*MSS) ) || (dupacks == 3) ) ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±ä¸éœ€è¦ç­‰åˆ°3ä¸ªduplicated acksæ‰é‡ä¼ ï¼Œè€Œæ˜¯åªè¦sackä¸­çš„æœ€å¤§çš„ä¸€ä¸ªæ•°æ®å’Œackçš„æ•°æ®æ¯”è¾ƒé•¿äº†ï¼ˆ3ä¸ªMSSï¼‰ï¼Œé‚£å°±è§¦å‘é‡ä¼ ã€‚åœ¨æ•´ä¸ªé‡ä¼ è¿‡ç¨‹ä¸­cwndä¸å˜ã€‚ç›´åˆ°å½“ç¬¬ä¸€æ¬¡ä¸¢åŒ…çš„snd.nxt&lt;=snd.unaï¼ˆä¹Ÿå°±æ˜¯é‡ä¼ çš„æ•°æ®éƒ½è¢«ç¡®è®¤äº†ï¼‰ï¼Œç„¶åè¿›æ¥æ‹¥å¡é¿å…æœºåˆ¶â€”â€”cwndçº¿æ€§ä¸Šæ¶¨ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœæ²¡æœ‰FACKåœ¨ï¼Œé‚£ä¹ˆåœ¨ä¸¢åŒ…æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼ŒåŸæ¥ä¿å®ˆçš„ç®—æ³•ä¼šä½ä¼°äº†éœ€è¦ä½¿ç”¨çš„windowçš„å¤§å°ï¼Œè€Œéœ€è¦å‡ ä¸ªRTTçš„æ—¶é—´æ‰ä¼šå®Œæˆæ¢å¤ï¼Œè€ŒFACKä¼šæ¯”è¾ƒæ¿€è¿›åœ°æ¥å¹²è¿™äº‹ã€‚ ä½†æ˜¯ï¼ŒFACKå¦‚æœåœ¨ä¸€ä¸ªç½‘ç»œåŒ…ä¼šè¢« reorderingçš„ç½‘ç»œé‡Œä¼šæœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚</p>
<h1 id="å…¶å®ƒæ‹¥å¡æ§åˆ¶ç®—æ³•ç®€ä»‹"><a href="#å…¶å®ƒæ‹¥å¡æ§åˆ¶ç®—æ³•ç®€ä»‹" class="headerlink" title="å…¶å®ƒæ‹¥å¡æ§åˆ¶ç®—æ³•ç®€ä»‹"></a>å…¶å®ƒæ‹¥å¡æ§åˆ¶ç®—æ³•ç®€ä»‹</h1><h2 id="TCP-Vegas-æ‹¥å¡æ§åˆ¶ç®—æ³•"><a href="#TCP-Vegas-æ‹¥å¡æ§åˆ¶ç®—æ³•" class="headerlink" title="TCP Vegas æ‹¥å¡æ§åˆ¶ç®—æ³•"></a>TCP Vegas æ‹¥å¡æ§åˆ¶ç®—æ³•</h2><p>è¿™ä¸ªç®—æ³•1994å¹´è¢«æå‡ºï¼Œå®ƒä¸»è¦å¯¹TCP Reno åšäº†äº›ä¿®æ”¹ã€‚è¿™ä¸ªç®—æ³•é€šè¿‡å¯¹RTTçš„éå¸¸é‡çš„ç›‘æ§æ¥è®¡ç®—ä¸€ä¸ªåŸºå‡†RTTã€‚ç„¶åé€šè¿‡è¿™ä¸ªåŸºå‡†RTTæ¥ä¼°è®¡å½“å‰çš„ç½‘ç»œå®é™…å¸¦å®½ï¼Œå¦‚æœå®é™…å¸¦å®½æ¯”æˆ‘ä»¬çš„æœŸæœ›çš„å¸¦å®½è¦å°æˆ–æ˜¯è¦å¤šçš„æ´»ï¼Œé‚£ä¹ˆå°±å¼€å§‹çº¿æ€§åœ°å‡å°‘æˆ–å¢åŠ cwndçš„å¤§å°ã€‚å¦‚æœè¿™ä¸ªè®¡ç®—å‡ºæ¥çš„RTTå¤§äºäº†Timeoutåï¼Œé‚£ä¹ˆï¼Œä¸ç­‰ackè¶…æ—¶å°±ç›´æ¥é‡ä¼ ã€‚ï¼ˆVegas çš„æ ¸å¿ƒæ€æƒ³æ˜¯ç”¨RTTçš„å€¼æ¥å½±å“æ‹¥å¡çª—å£ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¸¢åŒ…ï¼‰ è¿™ä¸ªç®—æ³•çš„è®ºæ–‡æ˜¯ã€ŠTCP Vegas: End to End Congestion Avoidance on a Global Internetã€‹è¿™ç¯‡è®ºæ–‡ç»™äº†Vegaså’Œ New Renoçš„å¯¹æ¯”ï¼š<br><a href="http://idiotsky.me/images1/tcp-something-16.jpg"><img src="http://idiotsky.me/images1/tcp-something-16.jpg" alt=""></a></p>
<p>å…³äºè¿™ä¸ªç®—æ³•å®ç°ï¼Œä½ å¯ä»¥å‚çœ‹Linuxæºç ï¼š<a href="http://lxr.free-electrons.com/source/net/ipv4/tcp_vegas.h" target="_blank" rel="external">/net/ipv4/tcp_vegas.h</a>ï¼Œ <a href="http://lxr.free-electrons.com/source/net/ipv4/tcp_vegas.c" target="_blank" rel="external">/net/ipv4/tcp_vegas.c</a></p>
<h2 id="HSTCP-High-Speed-TCP-ç®—æ³•"><a href="#HSTCP-High-Speed-TCP-ç®—æ³•" class="headerlink" title="HSTCP(High Speed TCP) ç®—æ³•"></a>HSTCP(High Speed TCP) ç®—æ³•</h2><p>è¿™ä¸ªç®—æ³•æ¥è‡ª<a href="http://tools.ietf.org/html/rfc3649" target="_blank" rel="external">RFC 3649</a>ï¼ˆ<a href="http://en.wikipedia.org/wiki/HSTCP" target="_blank" rel="external">Wikipediaè¯æ¡</a>ï¼‰ã€‚å…¶å¯¹æœ€åŸºç¡€çš„ç®—æ³•è¿›è¡Œäº†æ›´æ”¹ï¼Œä»–ä½¿å¾—Congestion Windowæ¶¨å¾—å¿«ï¼Œå‡å¾—æ…¢ã€‚å…¶ä¸­ï¼š</p>
<ul>
<li>æ‹¥å¡é¿å…æ—¶çš„çª—å£å¢é•¿æ–¹å¼ï¼š cwnd = cwnd + Î±(cwnd) / cwnd</li>
<li>ä¸¢åŒ…åçª—å£ä¸‹é™æ–¹å¼ï¼šcwnd = (1- Î²(cwnd))*cwnd</li>
</ul>
<p>æ³¨ï¼šÎ±(cwnd)å’ŒÎ²(cwnd)éƒ½æ˜¯å‡½æ•°ï¼Œå¦‚æœä½ è¦è®©ä»–ä»¬å’Œæ ‡å‡†çš„TCPä¸€æ ·ï¼Œé‚£ä¹ˆè®©Î±(cwnd)=1ï¼ŒÎ²(cwnd)=0.5å°±å¯ä»¥äº†ã€‚ å¯¹äºÎ±(cwnd)å’ŒÎ²(cwnd)çš„å€¼æ˜¯ä¸ªåŠ¨æ€çš„å˜æ¢çš„ä¸œè¥¿ã€‚ å…³äºè¿™ä¸ªç®—æ³•çš„å®ç°ï¼Œä½ å¯ä»¥å‚çœ‹Linuxæºç ï¼š<a href="http://lxr.free-electrons.com/source/net/ipv4/tcp_highspeed.c" target="_blank" rel="external">/net/ipv4/tcp_highspeed.c</a></p>
<h2 id="TCP-BIC-ç®—æ³•"><a href="#TCP-BIC-ç®—æ³•" class="headerlink" title="TCP BIC ç®—æ³•"></a>TCP BIC ç®—æ³•</h2><p>2004å¹´ï¼Œäº§å†…å‡ºBICç®—æ³•ã€‚ç°åœ¨ä½ è¿˜å¯ä»¥æŸ¥å¾—åˆ°ç›¸å…³çš„æ–°é—»ã€ŠGoogleï¼š<a href="https://www.google.com/search?lr=lang_zh-CN%7Clang_zh-TW&amp;newwindow=1&amp;biw=1366&amp;bih=597&amp;tbs=lr%3Alang_1zh-CN%7Clang_1zh-TW&amp;q=ç¾ç§‘å­¦å®¶ç ”å‘BIC-TCPåè®®+é€Ÿåº¦æ˜¯DSLå…­åƒå€&amp;oq=ç¾ç§‘å­¦å®¶ç ”å‘BIC-TCPåè®®+é€Ÿåº¦æ˜¯DSLå…­åƒå€" target="_blank" rel="external">ç¾ç§‘å­¦å®¶ç ”å‘BIC-TCPåè®® é€Ÿåº¦æ˜¯DSLå…­åƒå€</a>ã€‹ BICå…¨ç§°<a href="http://research.csc.ncsu.edu/netsrv/?q=content/bic-and-cubic" target="_blank" rel="external">Binary Increase Congestion control</a>ï¼Œåœ¨Linux 2.6.8ä¸­æ˜¯é»˜è®¤æ‹¥å¡æ§åˆ¶ç®—æ³•ã€‚BICçš„å‘æ˜è€…å‘è¿™ä¹ˆå¤šçš„æ‹¥å¡æ§åˆ¶ç®—æ³•éƒ½åœ¨åŠªåŠ›æ‰¾ä¸€ä¸ªåˆé€‚çš„cwnd â€“ Congestion Windowï¼Œè€Œä¸”BIC-TCPçš„æå‡ºè€…ä»¬çœ‹ç©¿äº†äº‹æƒ…çš„æœ¬è´¨ï¼Œå…¶å®è¿™å°±æ˜¯ä¸€ä¸ªæœç´¢çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥BICè¿™ä¸ªç®—æ³•ä¸»è¦ç”¨çš„æ˜¯Binary Searchâ€”â€”äºŒåˆ†æŸ¥æ‰¾æ¥å¹²è¿™ä¸ªäº‹ã€‚ å…³äºè¿™ä¸ªç®—æ³•å®ç°ï¼Œä½ å¯ä»¥å‚çœ‹Linuxæºç ï¼š<a href="http://research.csc.ncsu.edu/netsrv/?q=content/bic-and-cubic" target="_blank" rel="external">/net/ipv4/tcp_bic.c</a></p>
<h2 id="TCP-WestWoodç®—æ³•"><a href="#TCP-WestWoodç®—æ³•" class="headerlink" title="TCP WestWoodç®—æ³•"></a>TCP WestWoodç®—æ³•</h2><p>westwoodé‡‡ç”¨å’ŒRenoç›¸åŒçš„æ…¢å¯åŠ¨ç®—æ³•ã€æ‹¥å¡é¿å…ç®—æ³•ã€‚westwoodçš„ä¸»è¦æ”¹è¿›æ–¹é¢ï¼šåœ¨å‘é€ç«¯åšå¸¦å®½ä¼°è®¡ï¼Œå½“æ¢æµ‹åˆ°ä¸¢åŒ…æ—¶ï¼Œæ ¹æ®å¸¦å®½å€¼æ¥è®¾ç½®æ‹¥å¡çª—å£ã€æ…¢å¯åŠ¨é˜ˆå€¼ã€‚ é‚£ä¹ˆï¼Œè¿™ä¸ªç®—æ³•æ˜¯æ€ä¹ˆæµ‹é‡å¸¦å®½çš„ï¼Ÿæ¯ä¸ªRTTæ—¶é—´ï¼Œä¼šæµ‹é‡ä¸€æ¬¡å¸¦å®½ï¼Œæµ‹é‡å¸¦å®½çš„å…¬å¼å¾ˆç®€å•ï¼Œå°±æ˜¯è¿™æ®µRTTå†…æˆåŠŸè¢«ackäº†å¤šå°‘å­—èŠ‚ã€‚å› ä¸ºï¼Œè¿™ä¸ªå¸¦å®½å’Œç”¨RTTè®¡ç®—RTOä¸€æ ·ï¼Œä¹Ÿæ˜¯éœ€è¦ä»æ¯ä¸ªæ ·æœ¬æ¥å¹³æ»‘åˆ°ä¸€ä¸ªå€¼çš„â€”â€”ä¹Ÿæ˜¯ç”¨ä¸€ä¸ªåŠ æƒç§»å¹³å‡çš„å…¬å¼ã€‚ å¦å¤–ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœä¸€ä¸ªç½‘ç»œçš„å¸¦å®½æ˜¯æ¯ç§’å¯ä»¥å‘é€Xä¸ªå­—èŠ‚ï¼Œè€ŒRTTæ˜¯ä¸€ä¸ªæ•°æ®å‘å‡ºå»åç¡®è®¤éœ€è¦çš„æ—¶å€™ï¼Œæ‰€ä»¥ï¼ŒX <em> RTTåº”è¯¥æ˜¯æˆ‘ä»¬ç¼“å†²åŒºå¤§å°ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªç®—æ³•ä¸­ï¼Œssthreshçš„å€¼å°±æ˜¯est_BD </em> min-RTT(æœ€å°çš„RTTå€¼)ï¼Œå¦‚æœä¸¢åŒ…æ˜¯Duplicated ACKså¼•èµ·çš„ï¼Œé‚£ä¹ˆå¦‚æœcwnd &gt; ssthreshï¼Œåˆ™ cwin = ssthreshã€‚å¦‚æœæ˜¯RTOå¼•èµ·çš„ï¼Œcwnd = 1ï¼Œè¿›å…¥æ…¢å¯åŠ¨ã€‚   å…³äºè¿™ä¸ªç®—æ³•å®ç°ï¼Œä½ å¯ä»¥å‚çœ‹Linuxæºç ï¼š <a href="http://lxr.free-electrons.com/source/net/ipv4/tcp_westwood.c" target="_blank" rel="external">/net/ipv4/tcp_westwood.c</a></p>
<h2 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h2><p>æ›´å¤šçš„ç®—æ³•ï¼Œä½ å¯ä»¥ä»Wikipediaçš„ <a href="http://en.wikipedia.org/wiki/TCP_congestion-avoidance_algorithm" target="_blank" rel="external">TCP Congestion Avoidance Algorithm</a>è¯æ¡ä¸­æ‰¾åˆ°ç›¸å…³çš„çº¿ç´¢</p>
<h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œæˆ‘æƒ³å¯ä»¥ç»“æŸäº†ï¼ŒTCPå‘å±•åˆ°ä»Šå¤©ï¼Œé‡Œé¢çš„ä¸œè¥¿å¯ä»¥å†™ä¸Šå¥½å‡ æœ¬ä¹¦ã€‚æœ¬æ–‡ä¸»è¦ç›®çš„ï¼Œè¿˜æ˜¯æŠŠä½ å¸¦å…¥è¿™äº›å¤å…¸çš„åŸºç¡€æŠ€æœ¯å’ŒçŸ¥è¯†ä¸­ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ äº†è§£TCPï¼Œæ›´å¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ å¼€å§‹æœ‰å­¦ä¹ è¿™äº›åŸºç¡€æˆ–åº•å±‚çŸ¥è¯†çš„å…´è¶£å’Œä¿¡å¿ƒã€‚</p>
<p>å½“ç„¶ï¼ŒTCPä¸œè¥¿å¤ªå¤šäº†ï¼Œä¸åŒçš„äººå¯èƒ½æœ‰ä¸åŒçš„ç†è§£ï¼Œè€Œä¸”æœ¬æ–‡å¯èƒ½ä¹Ÿä¼šæœ‰ä¸€äº›è’è°¬ä¹‹è¨€ç”šè‡³é”™è¯¯ï¼Œè¿˜å¸Œæœ›å¾—åˆ°æ‚¨çš„åé¦ˆå’Œæ‰¹è¯„ã€‚</p>
<p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>
<blockquote>
<p>å¥½é•¿çš„æ–‡ç« </p>
</blockquote>
<p>from <a href="https://coolshell.cn" target="_blank" rel="external">é…·å£³</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;tcpçœ‹äº†å¾ˆå¤šçš„æ–‡ç« ï¼Œè¿™ç¯‡æ€»ç»“çš„å¾ˆå¥½ã€‚æ­¤æ–‡æœ‰ç‚¹é•¿ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;tcpåœ¨ç½‘ç»œOSIçš„ä¸ƒå±‚æ¨¡å‹ä¸­çš„ç¬¬å››å±‚â€”â€”Transport(ä¼ è¾“)å±‚ï¼ŒIPåœ¨ç¬¬ä¸‰å±‚â€”â€”Network(ç½‘ç»œ)å±‚ï¼ŒARPåœ¨ç¬¬äºŒå±‚â€”â€”Data Link(æ•°æ®é“¾è·¯)å±‚ï¼Œåœ¨ç¬¬äºŒå±‚ä¸Šçš„æ•°æ®ï¼Œæˆ‘ä»¬å«Frameï¼Œåœ¨ç¬¬ä¸‰å±‚ä¸Šçš„æ•°æ®å«Packetï¼Œç¬¬å››å±‚çš„æ•°æ®å«Segmentã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œæˆ‘ä»¬ç¨‹åºçš„æ•°æ®é¦–å…ˆä¼šæ‰“åˆ°TCPçš„Segmentä¸­ï¼Œç„¶åTCPçš„Segmentä¼šæ‰“åˆ°IPçš„Packetä¸­ï¼Œç„¶åå†æ‰“åˆ°ä»¥å¤ªç½‘Ethernetçš„Frameä¸­ï¼Œä¼ åˆ°å¯¹ç«¯åï¼Œå„ä¸ªå±‚è§£æè‡ªå·±çš„åè®®ï¼Œç„¶åæŠŠæ•°æ®äº¤ç»™æ›´é«˜å±‚çš„åè®®å¤„ç†ã€‚&lt;/p&gt;
&lt;h1 id=&quot;TCPå¤´æ ¼å¼&quot;&gt;&lt;a href=&quot;#TCPå¤´æ ¼å¼&quot; class=&quot;headerlink&quot; title=&quot;TCPå¤´æ ¼å¼&quot;&gt;&lt;/a&gt;TCPå¤´æ ¼å¼&lt;/h1&gt;&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹TCPå¤´çš„æ ¼å¼&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images1/tcp-something-1.jpg&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images1/tcp-something-1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;ä½ éœ€è¦æ³¨æ„è¿™ä¹ˆå‡ ç‚¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;TCPçš„åŒ…æ˜¯æ²¡æœ‰IPåœ°å€çš„ï¼Œé‚£æ˜¯IPå±‚ä¸Šçš„äº‹ã€‚ä½†æ˜¯æœ‰æºç«¯å£å’Œç›®æ ‡ç«¯å£ã€‚&lt;/li&gt;
&lt;li&gt;ä¸€ä¸ªTCPè¿æ¥éœ€è¦å››ä¸ªå…ƒç»„æ¥è¡¨ç¤ºæ˜¯åŒä¸€ä¸ªè¿æ¥ï¼ˆsrc_ip, src_port, dst_ip, dst_portï¼‰å‡†ç¡®è¯´æ˜¯äº”å…ƒç»„ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯åè®®ã€‚ä½†å› ä¸ºè¿™é‡Œåªæ˜¯è¯´TCPåè®®ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘åªè¯´å››å…ƒç»„ã€‚&lt;/li&gt;
&lt;li&gt;æ³¨æ„ä¸Šå›¾ä¸­çš„å››ä¸ªéå¸¸é‡è¦çš„ä¸œè¥¿ï¼š&lt;ul&gt;
&lt;li&gt;Sequence Numberæ˜¯åŒ…çš„åºå·ï¼Œç”¨æ¥è§£å†³ç½‘ç»œåŒ…ä¹±åºï¼ˆreorderingï¼‰é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;Acknowledgement Numberå°±æ˜¯ACKâ€”â€”ç”¨äºç¡®è®¤æ”¶åˆ°ï¼Œç”¨æ¥è§£å†³ä¸ä¸¢åŒ…çš„é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;Windowåˆå«Advertised-Windowï¼Œä¹Ÿå°±æ˜¯è‘—åçš„æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰ï¼Œç”¨äºè§£å†³æµæ§çš„ã€‚&lt;/li&gt;
&lt;li&gt;TCP Flag ï¼Œä¹Ÿå°±æ˜¯åŒ…çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ç”¨äºæ“æ§TCPçš„çŠ¶æ€æœºçš„ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="tcp" scheme="http://idiotsky.me/categories/tcp/"/>
    
    
      <category term="tcp" scheme="http://idiotsky.me/tags/tcp/"/>
    
  </entry>
  
  <entry>
    <title>æ­£å‘ä»£ç†å’Œåå‘ä»£ç†</title>
    <link href="http://idiotsky.me/2017/10/19/proxy-reverse-proxy/"/>
    <id>http://idiotsky.me/2017/10/19/proxy-reverse-proxy/</id>
    <published>2017-10-18T16:29:53.000Z</published>
    <updated>2017-10-18T16:48:30.729Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ä¸€ç›´ç”¨åå‘ä»£ç†ï¼Œå¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆå«åå‘ï¼Œè¿˜æœ‰ä½•ä¸ºæ­£å‘ä»£ç†</p>
</blockquote>
<h1 id="æ­£å‘ä»£ç†"><a href="#æ­£å‘ä»£ç†" class="headerlink" title="æ­£å‘ä»£ç†"></a>æ­£å‘ä»£ç†</h1><p>æˆ‘ä»¬å¸¸è¯´çš„ä»£ç†ä¹Ÿå°±æ˜¯åªæ­£å‘ä»£ç†ï¼Œæ­£å‘ä»£ç†çš„è¿‡ç¨‹ï¼Œå®ƒéšè—äº†çœŸå®çš„è¯·æ±‚å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ä¸çŸ¥é“çœŸå®çš„å®¢æˆ·ç«¯æ˜¯è°ï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„æœåŠ¡éƒ½è¢«ä»£ç†æœåŠ¡å™¨ä»£æ›¿æ¥è¯·æ±‚ï¼ŒæŸäº›ç§‘å­¦ä¸Šç½‘å·¥å…·æ‰®æ¼”çš„å°±æ˜¯å…¸å‹çš„æ­£å‘ä»£ç†è§’è‰²ã€‚ç”¨æµè§ˆå™¨è®¿é—® <a href="http://www.google.com" target="_blank" rel="external">http://www.google.com</a> æ—¶ï¼Œè¢«æ®‹å¿çš„blockï¼Œäºæ˜¯ä½ å¯ä»¥åœ¨å›½å¤–æ­å»ºä¸€å°ä»£ç†æœåŠ¡å™¨ï¼Œè®©ä»£ç†å¸®æˆ‘å»è¯·æ±‚google.comï¼Œä»£ç†æŠŠè¯·æ±‚è¿”å›çš„ç›¸åº”ç»“æœå†è¿”å›ç»™æˆ‘ã€‚æ‰€ä»¥è¯´ï¼Œå¾ˆå¤šç¿»å¢™å·¥å…·ç”¨åˆ°çš„æœåŠ¡å™¨åŸºæœ¬éƒ½æ˜¯æ­£å‘ä»£ç†æœåŠ¡å™¨<br><a href="http://idiotsky.me/images1/proxy-reverse-proxy-1.jpg"><img src="http://idiotsky.me/images1/proxy-reverse-proxy-1.jpg" alt=""></a><br><a id="more"></a></p>
<h1 id="åå‘ä»£ç†"><a href="#åå‘ä»£ç†" class="headerlink" title="åå‘ä»£ç†"></a>åå‘ä»£ç†</h1><p>åå‘ä»£ç†éšè—äº†çœŸå®çš„æœåŠ¡ç«¯ï¼Œwww.baidu.com çš„æ—¶å€™ï¼ŒèƒŒåå¯èƒ½æœ‰æˆåƒä¸Šä¸‡å°æœåŠ¡å™¨ä¸ºæˆ‘ä»¬æœåŠ¡ï¼Œä½†å…·ä½“æ˜¯å“ªä¸€å°ï¼Œä½ ä¸çŸ¥é“ï¼Œä¹Ÿä¸éœ€è¦çŸ¥é“ï¼Œä½ åªéœ€è¦çŸ¥é“åå‘ä»£ç†æœåŠ¡å™¨æ˜¯è°å°±å¥½äº†ï¼Œwww.baidu.com å°±æ˜¯æˆ‘ä»¬çš„åå‘ä»£ç†æœåŠ¡å™¨ï¼Œåå‘ä»£ç†æœåŠ¡å™¨ä¼šå¸®æˆ‘ä»¬æŠŠè¯·æ±‚è½¬å‘åˆ°çœŸå®çš„æœåŠ¡å™¨é‚£é‡Œå»ã€‚Nginxå°±æ˜¯æ€§èƒ½éå¸¸å¥½çš„åå‘ä»£ç†æœåŠ¡å™¨ï¼Œç”¨æ¥åšè´Ÿè½½å‡è¡¡ã€‚<br><a href="http://idiotsky.me/images1/proxy-reverse-proxy-2.jpg"><img src="http://idiotsky.me/images1/proxy-reverse-proxy-2.jpg" alt=""></a></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸¤è€…çš„åŒºåˆ«åœ¨äºä»£ç†çš„å¯¹è±¡ä¸ä¸€æ ·ï¼š<strong>æ­£å‘ä»£ç†</strong>ä»£ç†çš„å¯¹è±¡æ˜¯å®¢æˆ·ç«¯ï¼Œ<strong>åå‘ä»£ç†</strong>ä»£ç†çš„å¯¹è±¡æ˜¯æœåŠ¡ç«¯</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸€ç›´ç”¨åå‘ä»£ç†ï¼Œå¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆå«åå‘ï¼Œè¿˜æœ‰ä½•ä¸ºæ­£å‘ä»£ç†&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ­£å‘ä»£ç†&quot;&gt;&lt;a href=&quot;#æ­£å‘ä»£ç†&quot; class=&quot;headerlink&quot; title=&quot;æ­£å‘ä»£ç†&quot;&gt;&lt;/a&gt;æ­£å‘ä»£ç†&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬å¸¸è¯´çš„ä»£ç†ä¹Ÿå°±æ˜¯åªæ­£å‘ä»£ç†ï¼Œæ­£å‘ä»£ç†çš„è¿‡ç¨‹ï¼Œå®ƒéšè—äº†çœŸå®çš„è¯·æ±‚å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ä¸çŸ¥é“çœŸå®çš„å®¢æˆ·ç«¯æ˜¯è°ï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„æœåŠ¡éƒ½è¢«ä»£ç†æœåŠ¡å™¨ä»£æ›¿æ¥è¯·æ±‚ï¼ŒæŸäº›ç§‘å­¦ä¸Šç½‘å·¥å…·æ‰®æ¼”çš„å°±æ˜¯å…¸å‹çš„æ­£å‘ä»£ç†è§’è‰²ã€‚ç”¨æµè§ˆå™¨è®¿é—® &lt;a href=&quot;http://www.google.com&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.google.com&lt;/a&gt; æ—¶ï¼Œè¢«æ®‹å¿çš„blockï¼Œäºæ˜¯ä½ å¯ä»¥åœ¨å›½å¤–æ­å»ºä¸€å°ä»£ç†æœåŠ¡å™¨ï¼Œè®©ä»£ç†å¸®æˆ‘å»è¯·æ±‚google.comï¼Œä»£ç†æŠŠè¯·æ±‚è¿”å›çš„ç›¸åº”ç»“æœå†è¿”å›ç»™æˆ‘ã€‚æ‰€ä»¥è¯´ï¼Œå¾ˆå¤šç¿»å¢™å·¥å…·ç”¨åˆ°çš„æœåŠ¡å™¨åŸºæœ¬éƒ½æ˜¯æ­£å‘ä»£ç†æœåŠ¡å™¨&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images1/proxy-reverse-proxy-1.jpg&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images1/proxy-reverse-proxy-1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="proxy" scheme="http://idiotsky.me/categories/proxy/"/>
    
    
      <category term="proxy" scheme="http://idiotsky.me/tags/proxy/"/>
    
      <category term="æ­£å‘ä»£ç†" scheme="http://idiotsky.me/tags/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86/"/>
    
      <category term="åå‘ä»£ç†" scheme="http://idiotsky.me/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>JavaScriptæ˜¯å¦‚ä½•å·¥ä½œçš„(ä¸‰)</title>
    <link href="http://idiotsky.me/2017/10/05/javascript-how-work-3/"/>
    <id>http://idiotsky.me/2017/10/05/javascript-how-work-3/</id>
    <published>2017-10-05T12:01:15.000Z</published>
    <updated>2017-10-07T13:22:50.983Z</updated>
    
    <content type="html"><![CDATA[<p>å‡ ä¸ªç¤¼æ‹œä¹‹å‰æˆ‘ä»¬å¼€å§‹ä¸€ç³»åˆ—å¯¹äºJavaScriptä»¥åŠå…¶æœ¬è´¨å·¥ä½œåŸç†çš„æ·±å…¥æŒ–æ˜ï¼šæˆ‘ä»¬è®¤ä¸ºé€šè¿‡äº†è§£JavaScriptçš„æ„å»ºæ–¹å¼ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•å…±åŒåˆä½œçš„ï¼Œä½ å°±èƒ½å¤Ÿå†™å‡ºæ›´å¥½çš„ä»£ç ä»¥åŠåº”ç”¨ã€‚</p>
<p>è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€ç¯‡åšå®¢ä¸“æ³¨äºä»‹ç»<a href="http://idiotsky.me/2017/08/26/javascript-how-work/">å¯¹äºå¼•æ“ï¼Œè¿è¡Œæ—¶ä»¥åŠè°ƒç”¨æ ˆçš„æ¦‚è¿°</a>ã€‚<a href="http://idiotsky.me/2017/08/26/javascript-how-work-2/">ç¬¬äºŒç¯‡åšå®¢è¿‘è·ç¦»åœ°æ£€æµ‹äº†Google V8 å¼•æ“çš„å†…éƒ¨</a>å¹¶ä¸”æä¾›äº†ä¸€äº›å¦‚ä½•å†™å‡ºæ›´å¥½çš„JavaScriptä»£ç çš„å»ºè®®ã€‚</p>
<p>åœ¨ç¬¬ä¸‰ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šè®¨è®ºå¦å¤–ä¸€ä¸ªå…³é”®çš„è¯é¢˜ã€‚è¿™ä¸ªè¯é¢˜ç”±äºéšç€ç¼–ç¨‹è¯­è¨€çš„é€æ¸æˆç†Ÿå’Œå¤æ‚åŒ–ï¼Œè¶Šæ¥è¶Šè¢«å¼€å‘è€…æ‰€å¿½è§†ï¼Œè¿™ä¸ªè¯é¢˜å°±æ˜¯åœ¨æ—¥å¸¸å·¥ä½œä¸­ä½¿ç”¨åˆ°çš„â€”â€”å†…å­˜ç®¡ç†ã€‚</p>
<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>è¯­è¨€ï¼Œæ¯”å¦‚Cï¼Œå…·æœ‰ä½å±‚æ¬¡çš„å†…å­˜ç®¡ç†æ–¹æ³•ï¼Œæ¯”å¦‚<code>malloc()</code>ä»¥åŠ<code>free()</code>ã€‚å¼€å‘è€…åˆ©ç”¨è¿™äº›æ–¹æ³•ç²¾ç¡®åœ°ä¸ºæ“ä½œç³»ç»Ÿåˆ†é…ä»¥åŠé‡Šæ”¾å†…å­˜ã€‚</p>
<p>åŒæ—¶ï¼ŒJavaScriptä¼šåœ¨åˆ›å»ºä¸€äº›å˜é‡ï¼ˆå¯¹è±¡ï¼Œå­—ç¬¦ä¸²ç­‰ç­‰ï¼‰çš„æ—¶å€™åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”ä¼šåœ¨è¿™äº›ä¸è¢«ä½¿ç”¨ä¹‹åâ€œè‡ªåŠ¨åœ°â€é‡Šæ”¾è¿™äº›å†…å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º<em>åƒåœ¾æ”¶é›†</em>ã€‚è¿™ä¸ªçœ‹èµ·æ¥â€œè‡ªåŠ¨åŒ–çš„â€ç‰¹æ€§å…¶å®å°±æ˜¯äº§ç”Ÿè¯¯è§£çš„åŸå› ï¼Œå¹¶ä¸”ç»™JavaScriptï¼ˆä»¥åŠå…¶ä»–é«˜å±‚æ¬¡è¯­è¨€ï¼‰å¼€å‘è€…ä¸€ä¸ªå‡è±¡ï¼Œä»–ä»¬ä¸éœ€è¦å…³å¿ƒå†…å­˜ç®¡ç†ã€‚<strong>å¤§é”™ç‰¹é”™ã€‚</strong></p>
<p>å³ä½¿æ˜¯ä½¿ç”¨é«˜å±‚æ¬¡è¯­è¨€ï¼Œå¼€å‘è€…åº”è¯¥å¯¹äºå†…å­˜ç®¡ç†æœ‰ä¸€å®šçš„ç†è§£ï¼ˆæˆ–è€…æœ€åŸºæœ¬çš„ç†è§£ï¼‰ã€‚æœ‰æ—¶å€™è‡ªåŠ¨çš„å†…å­˜ç®¡ç†ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼ˆæ¯”å¦‚ä¸€äº›bugæˆ–è€…åƒåœ¾æ”¶é›†å™¨çš„ä¸€äº›é™åˆ¶ç­‰ç­‰ï¼‰ï¼Œå¯¹äºè¿™äº›å¼€å‘è€…å¿…é¡»èƒ½å¤Ÿç†è§£ä»è€Œèƒ½å¤Ÿåˆé€‚åœ°å¤„ç†ï¼ˆæˆ–è€…ä½¿ç”¨æœ€å°çš„ä»£ä»·ä»¥åŠä»£ç å€ºåŠ¡å»ç»•è¿‡è¿™ä¸ªé—®é¢˜ï¼‰ã€‚<br><a id="more"></a></p>
<h1 id="å†…å­˜ç”Ÿå‘½å‘¨æœŸ"><a href="#å†…å­˜ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å†…å­˜ç”Ÿå‘½å‘¨æœŸ"></a>å†…å­˜ç”Ÿå‘½å‘¨æœŸ</h1><p>ä¸ç®¡ä½ åœ¨ä½¿ç”¨ä»€ä¹ˆç¼–ç¨‹è¯­è¨€ï¼Œå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸåŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ï¼š</p>
<p><a href="http://idiotsky.me/images1/javascript-how-work-3-1.png"><img src="http://idiotsky.me/images1/javascript-how-work-3-1.png" alt=""></a></p>
<p>ä¸‹é¢æ˜¯å¯¹äºå‘¨æœŸä¸­æ¯ä¸€æ­¥æ‰€å‘ç”Ÿçš„æƒ…å†µçš„æ¦‚è¿°ï¼š</p>
<ul>
<li><strong>åˆ†é…å†…å­˜</strong>â€”â€”æ“ä½œç³»ç»Ÿä¸ºä½ çš„ç¨‹åºåˆ†é…å†…å­˜å¹¶ä¸”å…è®¸å…¶ä½¿ç”¨ã€‚åœ¨ä½å±‚æ¬¡è¯­è¨€ä¸­ï¼ˆæ¯”å¦‚Cï¼‰ï¼Œè¿™æ­£æ˜¯å¼€å‘è€…åº”è¯¥å¤„ç†çš„æ“ä½œã€‚åœ¨é«˜å±‚æ¬¡çš„è¯­è¨€ï¼Œç„¶è€Œï¼Œå°±ç”±è¯­è¨€å¸®ä½ å®ç°äº†ã€‚</li>
<li><strong>ä½¿ç”¨å†…å­˜</strong>â€”â€”å½“ä½ çš„ç¨‹åºç¡®å®åœ¨ä½¿ç”¨ä¹‹å‰åˆ†é…çš„å†…å­˜çš„é˜¶æ®µã€‚å½“ä½ åœ¨ä½¿ç”¨ä½ ä»£ç é‡Œé¢åˆ†é…çš„å˜é‡çš„æ—¶å€™ä¼šå‘ç”Ÿ<strong>è¯»</strong>ä»¥åŠ<strong>å†™</strong>æ“ä½œã€‚</li>
<li><strong>é‡Šæ”¾å†…å­˜</strong>â€”â€”è¿™ä¸ªé˜¶æ®µå°±æ˜¯é‡Šæ”¾ä½ ä¸å†éœ€è¦çš„å†…å­˜ï¼Œä»è€Œè¿™äº›å†…å­˜è¢«é‡Šæ”¾å¹¶ä¸”èƒ½å¤Ÿå†æ¬¡è¢«ä½¿ç”¨ã€‚å’Œ<strong>åˆ†é…å†…å­˜</strong>æ“ä½œä¸€æ ·ï¼Œè¿™åœ¨ä½å±‚æ¬¡çš„è¯­è¨€ä¹Ÿæ˜¯å¼€å‘è€…éœ€è¦æ˜ç¡®çš„æ“ä½œã€‚</li>
</ul>
<p>å¯¹äºè°ƒç”¨æ ˆä»¥åŠå†…å­˜å †æœ‰ä¸€ä¸ªå¿«é€Ÿçš„æ¦‚å¿µè®¤è¯†ï¼Œä½ å¯ä»¥é˜…è¯»æˆ‘ä»¬<a href="http://idiotsky.me/2017/08/26/javascript-how-work/">å…³äºè¿™ä¸ªè¯é¢˜çš„ç¬¬ä¸€ç¯‡åšå®¢</a>ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯å†…å­˜ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å†…å­˜ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å†…å­˜ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å†…å­˜ï¼Ÿ</h2><p>åœ¨æˆ‘ä»¬è®²è¿°JavaScriptå†…å­˜ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ç®€è¦åœ°è®¨è®ºä¸€ä¸‹å†…å­˜æ˜¯ä»€ä¹ˆä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•åœ¨ nutshell ä¸­å·¥ä½œçš„ã€‚</p>
<p>åœ¨ç¡¬ä»¶å±‚æ¬¡ä¸Šï¼Œè®¡ç®—æœºå†…å­˜ç”±å¤§é‡çš„ <a href="https://en.wikipedia.org/wiki/Flip-flop_%28electronics%29" target="_blank" rel="external">å¯„å­˜å™¨</a> ç»„æˆã€‚æ¯ä¸€ä¸ªå¯„å­˜å™¨éƒ½åŒ…å«ä¸€äº›æ™¶ä½“ç®¡å¹¶ä¸”èƒ½å¤Ÿå­˜å‚¨ä¸€æ¯”ç‰¹ã€‚å•ç‹¬çš„å¯„å­˜å™¨å¯ä»¥é€šè¿‡<strong>ç‹¬ç‰¹çš„æ ‡è¯†ç¬¦</strong>å»è®¿é—®ï¼Œå› æ­¤æˆ‘ä»¬èƒ½å¤Ÿè¯»å–ä»¥åŠé‡å†™å®ƒä»¬ã€‚å› æ­¤ï¼Œä»æ¦‚å¿µä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæˆ‘ä»¬çš„æ•´ä¸ªè®¡ç®—æœºå†…å­˜å°±æ˜¯ä¸€ä¸ªæˆ‘ä»¬èƒ½å¤Ÿè¯»å†™çš„å¤§å‹æ¯”ç‰¹æ•°ç»„ã€‚</p>
<p>å› ä¸ºä½œä¸ºäººç±»ï¼Œæˆ‘ä»¬ä¸æ“…é•¿ç›´æ¥åŸºäºæ¯”ç‰¹è¿›è¡Œæ€è€ƒä»¥åŠç®—æœ¯ï¼Œæˆ‘ä»¬å°†å®ƒä»¬ç»„ç»‡æˆå¤§è§„æ¨¡ç¾¤ç»„ï¼Œå®ƒä»¬åœ¨ä¸€èµ·å¯ä»¥ä»£è¡¨ä¸€ä¸ªæ•°å­—ã€‚8ä¸ªæ¯”ç‰¹ç§°ä¸ºä¸€ä¸ªå­—èŠ‚ã€‚é™¤äº†å­—èŠ‚ï¼Œè¿˜æœ‰è¯ï¼ˆæœ‰æ—¶å€™æ˜¯16æ¯”ç‰¹ï¼Œæœ‰æ—¶å€™æ˜¯32æ¯”ç‰¹ï¼‰ã€‚</p>
<p>å†…å­˜ä¸­å­˜å‚¨äº†å¾ˆå¤šä¸œè¥¿ï¼š</p>
<ol>
<li>æ‰€æœ‰ç¨‹åºä½¿ç”¨çš„å˜é‡å’Œå…¶ä»–æ•°æ®</li>
<li>ç¨‹åºçš„ä»£ç ï¼ŒåŒ…æ‹¬æ“ä½œç³»ç»Ÿçš„ä»£ç ã€‚</li>
</ol>
<p>ç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿå…±åŒåˆä½œä¸ºä½ å¤„ç†å¤§éƒ¨åˆ†çš„å†…å­˜ç®¡ç†ï¼Œä½†æ˜¯æˆ‘ä»¬å»ºè®®ä½ åº”è¯¥äº†è§£å…¶å†…éƒ¨çš„è¿è¡ŒåŸç†ã€‚</p>
<p>å½“ä½ ç¼–è¯‘ä½ çš„ä»£ç çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å°†ä¼šæ£€æŸ¥åŸå§‹æ•°æ®ç±»å‹å¹¶ä¸”æå‰è®¡ç®—å¥½å®ƒä»¬éœ€è¦å¤šå°‘å†…å­˜ã€‚éœ€è¦çš„å†…å­˜è¢«åˆ†é…ç»™ç¨‹åºï¼Œè¿™è¢«ç§°ä¸º<strong>æ ˆç©ºé—´</strong>ã€‚è¿™äº›è¢«åˆ†é…ç»™å˜é‡çš„ç©ºé—´è¢«ç§°ä¸ºæ ˆç©ºé—´ï¼Œå› ä¸ºä¸€æ—¦å‡½æ•°è¢«è°ƒç”¨ï¼Œå®ƒä»¬çš„å†…å­˜å°±ä¼šå¢åŠ åˆ°ç°æœ‰å†…å­˜çš„ä¸Šé¢ã€‚å½“å®ƒä»¬ç»ˆæ­¢çš„æ—¶å€™ï¼Œå®ƒä»¬å°±ä¼šä»¥åè¿›å…ˆå‡º(LIFO)çš„é¡ºåºç§»é™¤ã€‚æ¯”å¦‚ï¼Œè€ƒè™‘ä¸‹é¢çš„å£°æ˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> n; <span class="comment">// 4 bytes</span></div><div class="line"><span class="keyword">int</span> x[<span class="number">4</span>]; <span class="comment">// array of 4 elements, each 4 bytes</span></div><div class="line"><span class="keyword">double</span> m; <span class="comment">// 8 bytes</span></div></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨èƒ½å¤Ÿç«‹å³è®¡ç®—å‡ºä»£ç éœ€è¦</p>
<p>4 + 4 Ã— 4 + 8 = 28 å­—èŠ‚</p>
<blockquote>
<p>é‚£å°±æ˜¯å®ƒå¦‚ä½•å¯¹äºç°æœ‰çš„æ•´å½¢ä»¥åŠåŒæµ®ç‚¹å‹å·¥ä½œã€‚å¤§çº¦20å¹´å‰ï¼Œæ•´å½¢å…¸å‹éƒ½æ˜¯2ä¸ªå­—èŠ‚ï¼ŒåŒæµ®ç‚¹å‹æ˜¯4ä¸ªå­—èŠ‚ã€‚ä½ çš„ä»£ç ä¸åº”è¯¥å–å†³äºå½“ä¸‹åŸºæœ¬æ•°æ®ç±»å‹çš„å¤§å°ã€‚</p>
</blockquote>
<p>ç¼–è¯‘å™¨å°†ä¼šæ’å…¥èƒ½å¤Ÿä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„ä»£ç ï¼Œä»è€Œåœ¨æ ˆä¸Šè·å–ä½ éœ€è¦å­˜å‚¨å˜é‡éœ€è¦çš„å­—èŠ‚æ•°ã€‚</p>
<p>åœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­ï¼Œç¼–è¯‘å™¨çŸ¥é“æ¯ä¸€ä¸ªå˜é‡çš„å‡†ç¡®çš„å†…å­˜åœ°å€ã€‚äº‹å®ä¸Šï¼Œæ— è®ºæˆ‘ä»¬ä½•æ—¶å†™å˜é‡ n ï¼Œè¿™éƒ½ä¼šåœ¨å†…éƒ¨è½¬åŒ–ä¸ºç±»ä¼¼äºâ€œå†…å­˜åœ°å€ 4127963â€çš„ä¸œè¥¿ã€‚</p>
<p>æ³¨æ„å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨è¿™è®¿é—® x[4] æˆ‘ä»¬å°†ä¼šéœ€è¦è®¿é—®å’Œ m ç›¸å…³è”çš„æ•°æ®ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨è®¿é—®æ•°ç»„é‡Œé¢å¹¶ä¸å­˜åœ¨çš„å…ƒç´ â€”â€”å®ƒæ¯”æ•°ç»„å®é™…åˆ†é…çš„æœ€åä¸€ä¸ªå…ƒç´  x[3] è¦å¤š4ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”æœ€åå¯èƒ½æ˜¯é˜…è¯»ï¼ˆæˆ–è€…é‡å†™ï¼‰ä¸€äº› m çš„æ¯”ç‰¹ã€‚è¿™å°†å¾ˆå¯èƒ½ç»™ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†å¸¦æ¥ä¸€äº›ä¸è‰¯çš„åæœã€‚<br><a href="http://idiotsky.me/images1/javascript-how-work-3-2.png"><img src="http://idiotsky.me/images1/javascript-how-work-3-2.png" alt=""></a></p>
<p>å½“å‡½æ•°è°ƒç”¨å…¶å®ƒå‡½æ•°çš„æ—¶å€™ï¼Œå½“å®ƒè¢«è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šè·å–å®ƒè‡ªå·±çš„å †æ ˆå—ã€‚å®ƒåœ¨é‚£ä¿å­˜äº†å®ƒæ‰€æœ‰çš„å±€éƒ¨å˜é‡ï¼Œä½†æ˜¯è¿˜ä¼šæœ‰ä¸€ä¸ªç¨‹åºè®¡æ•°å™¨è®°å½•å®ƒæ‰§è¡Œçš„ä½ç½®ã€‚å½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œå®ƒçš„å†…å­˜å—å°±å¯ä»¥å†æ¬¡ç”¨äºå…¶ä»–ç›®çš„ã€‚</p>
<h2 id="åŠ¨æ€åˆ†é…"><a href="#åŠ¨æ€åˆ†é…" class="headerlink" title="åŠ¨æ€åˆ†é…"></a>åŠ¨æ€åˆ†é…</h2><p>ä¸å¹¸çš„æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨ç¼–è¯‘çš„æ—¶å€™ä¸çŸ¥é“å˜é‡éœ€è¦å¤šå°‘å†…å­˜çš„è¯äº‹æƒ…å¯èƒ½å°±ä¸é‚£ä¹ˆç®€å•ã€‚å‡è®¾æˆ‘ä»¬æƒ³åšä¸‹é¢çš„äº‹æƒ…ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">int</span> n = readInput(); <span class="comment">// reads input from the user</span></div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">// create an array with "n" elements</span></div></pre></td></tr></table></figure></p>
<p>åœ¨æ­¤ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µä¸­ï¼Œç¼–è¯‘å™¨å°±æ²¡æœ‰åŠæ³•çŸ¥é“æ•°ç»„éœ€è¦å¤šå°‘å†…å­˜ï¼Œå› ä¸ºå®ƒå–å†³äºç”¨æˆ·çš„è¾“å…¥ã€‚</p>
<p>å› æ­¤ï¼Œå®ƒå°±ä¸èƒ½å¤Ÿä¸ºæ ˆä¸Šçš„å˜é‡åˆ†é…ç©ºé—´ã€‚ç›¸åï¼Œæˆ‘ä»¬çš„ç¨‹åºéœ€è¦æ˜ç¡®åœ°è¯¢é—®æ“ä½œè¿è¡Œæ—¶éœ€è¦çš„ç©ºé—´æ•°é‡ã€‚è¿™ä¸ªå†…å­˜æ˜¯ä»<strong>å †ç©ºé—´</strong>ä¸­åˆ†é…å‡ºæ¥çš„ã€‚åŠ¨æ€å†…å­˜å’Œé™æ€å†…å­˜åˆ†é…çš„åŒºåˆ«æ€»ç»“å¦‚ä¸‹è¡¨æ ¼ï¼š<br><a href="http://idiotsky.me/images1/javascript-how-work-3-3.png"><img src="http://idiotsky.me/images1/javascript-how-work-3-3.png" alt=""></a></p>
<p>ä¸ºäº†æ·±å…¥åœ°ç†è§£åŠ¨æ€å†…å­˜åˆ†é…æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæˆ‘ä»¬éœ€è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´åœ¨<strong>æŒ‡é’ˆ</strong>ï¼Œè¿™ä¸ªå¯èƒ½æœ‰ç‚¹åç¦»è¿™ç¯‡åšå®¢çš„è¯é¢˜ã€‚å¦‚æœä½ æ„Ÿå…´è¶£äº†è§£æ›´å¤šï¼Œåœ¨è¯„è®ºé‡Œé¢å‘Šè¯‰æˆ‘ï¼Œæˆ‘å°†ä¼šåœ¨åç»­çš„åšå®¢ä¸­æŒ–æ˜æ›´å¤šçš„ç»†èŠ‚ã€‚</p>
<h2 id="JavaScriptä¸­çš„åˆ†é…"><a href="#JavaScriptä¸­çš„åˆ†é…" class="headerlink" title="JavaScriptä¸­çš„åˆ†é…"></a>JavaScriptä¸­çš„åˆ†é…</h2><p>ç°åœ¨æˆ‘ä»¬å°†è§£é‡ŠJavaScriptä¸­çš„ç¬¬ä¸€æ­¥ï¼ˆåˆ†é…å†…å­˜ï¼‰ã€‚</p>
<p>JavaScript å°†å¼€å‘è€…ä»å†…å­˜åˆ†é…çš„å¤„ç†ä¸­è§£æ”¾å‡ºæ¥â€”â€”JavaScriptè‡ªèº«å¯ä»¥åˆ©ç”¨å£°æ˜å˜é‡æ¥å®Œæˆè¿™äº›ä»»åŠ¡ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> n = <span class="number">374</span>; <span class="comment">// allocates memory for a number</span></div><div class="line"><span class="keyword">var</span> s = <span class="string">'sessionstack'</span>; <span class="comment">// allocates memory for a string </span></div><div class="line"></div><div class="line"><span class="keyword">var</span> o = &#123;</div><div class="line">  <span class="attr">a</span>: <span class="number">1</span>,</div><div class="line">  <span class="attr">b</span>: <span class="literal">null</span></div><div class="line">&#125;; <span class="comment">// allocates memory for an object and its contained values</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> a = [<span class="number">1</span>, <span class="literal">null</span>, <span class="string">'str'</span>];  <span class="comment">// (like object) allocates memory for the</span></div><div class="line">                           <span class="comment">// array and its contained values</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">a</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> a + <span class="number">3</span>;</div><div class="line">&#125; <span class="comment">// allocates a function (which is a callable object)</span></div><div class="line"></div><div class="line"><span class="comment">// function expressions also allocate an object</span></div><div class="line">someElement.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  someElement.style.backgroundColor = <span class="string">'blue'</span>;</div><div class="line">&#125;, <span class="literal">false</span>);</div></pre></td></tr></table></figure>
<p>ä¸€äº›å‡½æ•°è°ƒç”¨ä¹Ÿä¼šå¯¼è‡´ä¸€äº›å¯¹è±¡çš„åˆ†é…ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(); <span class="comment">// allocates a Date object</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> e = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>); <span class="comment">// allocates a DOM element</span></div></pre></td></tr></table></figure>
<p>èƒ½å¤Ÿåˆ†é…æ–°çš„å€¼æˆ–è€…å¯¹è±¡çš„æ–¹æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> s1 = <span class="string">'sessionstack'</span>;</div><div class="line"><span class="keyword">var</span> s2 = s1.substr(<span class="number">0</span>, <span class="number">3</span>); <span class="comment">// s2 is a new string</span></div><div class="line"><span class="comment">// Since strings are immutable, </span></div><div class="line"><span class="comment">// JavaScript may decide to not allocate memory, </span></div><div class="line"><span class="comment">// but just store the [0, 3] range.</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> a1 = [<span class="string">'str1'</span>, <span class="string">'str2'</span>];</div><div class="line"><span class="keyword">var</span> a2 = [<span class="string">'str3'</span>, <span class="string">'str4'</span>];</div><div class="line"><span class="keyword">var</span> a3 = a1.concat(a2); </div><div class="line"><span class="comment">// new array with 4 elements being</span></div><div class="line"><span class="comment">// the concatenation of a1 and a2 elements</span></div></pre></td></tr></table></figure>
<h2 id="åœ¨JavaScriptä¸­ä½¿ç”¨å†…å­˜"><a href="#åœ¨JavaScriptä¸­ä½¿ç”¨å†…å­˜" class="headerlink" title="åœ¨JavaScriptä¸­ä½¿ç”¨å†…å­˜"></a>åœ¨JavaScriptä¸­ä½¿ç”¨å†…å­˜</h2><p>åŸºæœ¬ä¸Šåœ¨JavaScriptä¸­åˆ†é…å†…å­˜ï¼Œå°±æ„å‘³ç€åœ¨å…¶ä¸­è¯»å†™ã€‚</p>
<p>è¿™å¯ä»¥é€šè¿‡å¯¹ä¸€ä¸ªå˜é‡æˆ–è€…ä¸€ä¸ªå¯¹è±¡çš„å±æ€§ç”šè‡³æ˜¯å‘å‡½æ•°ä¼ é€’ä¸€ä¸ªå‚æ•°æ¥å®Œæˆã€‚</p>
<h2 id="å½“å†…å­˜ä¸å†éœ€è¦çš„æ—¶å€™é‡Šæ”¾å®ƒ"><a href="#å½“å†…å­˜ä¸å†éœ€è¦çš„æ—¶å€™é‡Šæ”¾å®ƒ" class="headerlink" title="å½“å†…å­˜ä¸å†éœ€è¦çš„æ—¶å€™é‡Šæ”¾å®ƒ"></a>å½“å†…å­˜ä¸å†éœ€è¦çš„æ—¶å€™é‡Šæ”¾å®ƒ</h2><p>å¤§å¤šæ•°çš„å†…å­˜ç®¡ç†çš„é—®é¢˜å°±æ¥è‡ªäºè¿™ä¸ªé˜¶æ®µã€‚</p>
<p>æœ€å›°éš¾çš„ä»»åŠ¡å°±æ˜¯å¦‚ä½•çŸ¥é“ä½•æ—¶è¢«åˆ†é…çš„ä¸å†éœ€è¦äº†ã€‚å®ƒç»å¸¸éœ€è¦å¼€å‘è€…å†³å®šåœ¨ç¨‹åºçš„ä»€ä¹ˆåœ°æ–¹æŸæ®µå†…å­˜ä¸å†éœ€è¦äº†å¹¶ä¸”å¯¹å…¶è¿›è¡Œé‡Šæ”¾ã€‚</p>
<p>é«˜å±‚æ¬¡è¯­è¨€å†…åµŒäº†ä¸€ä¸ªç§°ä¸º<strong>åƒåœ¾æ”¶é›†å™¨</strong>çš„è½¯ä»¶ï¼Œä»–çš„ä»»åŠ¡å°±æ˜¯è·Ÿè¸ªå†…å­˜åˆ†é…å¹¶ä¸”ç”¨äºéœ€æ‰¾ä¸å†éœ€è¦çš„åˆ†é…è¿‡çš„å†…å­˜ï¼Œå¹¶ä¸”è‡ªåŠ¨åœ°å¯¹å…¶è¿›è¡Œé‡Šæ”¾ã€‚</p>
<p>ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªè¿‘ä¼¼ï¼Œå› ä¸ºçŸ¥é“æ˜¯å¦æŸå—å†…å­˜æ˜¯éœ€è¦çš„é—®é¢˜æ˜¯<a href="http://en.wikipedia.org/wiki/Decidability_%28logic%29" target="_blank" rel="external">ä¸å¯å†³å®šçš„</a>ï¼ˆæ— æ³•é€šè¿‡ç®—æ³•è§£å†³ï¼‰</p>
<p>å¤§å¤šæ•°çš„åƒåœ¾æ”¶é›†å™¨é€šè¿‡æ”¶é›†å†ä¹Ÿæ— æ³•è®¿é—®çš„å†…å­˜å·¥ä½œï¼Œæ¯”å¦‚ï¼šæŒ‡å‘å®ƒçš„æ‰€æœ‰å˜é‡éƒ½è¶…å‡ºäº†ä½œç”¨åŸŸã€‚ç„¶è€Œï¼Œè¿™ä¾ç„¶æ˜¯å¯¹äºå¯ä»¥æ”¶é›†çš„å†…å­˜ç©ºé—´çš„é¢„ä¼°ï¼Œå› ä¸ºåœ¨ä»»ä½•ä½ç½®ä»å¯èƒ½ä¸€äº›å˜é‡åœ¨ä½œç”¨åŸŸå†…æŒ‡å‘è¿™ä¸ªå†…å­˜ï¼Œç„¶è€Œå®ƒå†ä¹Ÿä¸èƒ½è¢«è®¿é—®äº†ã€‚</p>
<h1 id="åƒåœ¾æ”¶é›†å™¨"><a href="#åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨"></a>åƒåœ¾æ”¶é›†å™¨</h1><p>ç”±äºæ‰¾åˆ°ä¸€äº›æ˜¯â€œä¸å†éœ€è¦çš„â€æ˜¯ä¸å¯å†³å®šçš„äº‹å®ï¼Œåƒåœ¾æ”¶é›†å®ç°äº†å¯¹ä¸€èˆ¬é—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„é™åˆ¶ã€‚è¿™ä¸€èŠ‚å°†ä¼šè§£é‡Šç†è§£ä¸»è¦çš„åƒåœ¾æ”¶é›†ç®—æ³•ä»¥åŠå®ƒä»¬çš„é™åˆ¶çš„éœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚</p>
<h2 id="å†…å­˜å¼•ç”¨"><a href="#å†…å­˜å¼•ç”¨" class="headerlink" title="å†…å­˜å¼•ç”¨"></a>å†…å­˜å¼•ç”¨</h2><p>åƒåœ¾æ”¶é›†ç®—æ³•ä¾èµ–çš„ä¸»è¦æ¦‚å¿µä¹‹ä¸€å°±æ˜¯<strong>å¼•ç”¨</strong>ã€‚</p>
<p>åœ¨å†…å­˜ç®¡ç†çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡è¢«ç§°ä¸ºæ˜¯å¯¹äºå¦å¤–ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œå¦‚æœå‰è€…å¯ä»¥è®¿é—®åè€…ï¼ˆéšå«æˆ–æ˜ç¡®çš„ï¼‰ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªJavaScriptå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘å…¶<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Inheritance_and_the_prototype_chain" target="_blank" rel="external">åŸå‹</a>çš„å¼•ç”¨ï¼ˆ<strong>éšå«çš„å¼•ç”¨</strong>ï¼‰</p>
<p>åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œå¯¹è±¡â€çš„æ¦‚å¿µæ‰©å±•åˆ°æ¯”æ™®é€šçš„JavaScriptå¯¹è±¡è¦å¹¿å¹¶ä¸”åŒ…æ‹¬å‡½æ•°ä½œç”¨åŸŸï¼ˆæˆ–è€…å…¨å±€<strong>è¯æ³•ä½œç”¨åŸŸ</strong>ï¼‰ã€‚</p>
<blockquote>
<p> è¯æ³•ä½œç”¨åŸŸå®šä¹‰äº†å˜é‡åç§°æ˜¯å¦‚ä½•åœ¨åµŒå¥—å‡½æ•°ä¸­è§£æçš„ï¼šå†…éƒ¨å‡½æ•°åŒ…å«äº†çˆ¶å‡½æ•°çš„ä½œç”¨åŸŸå³ä½¿çˆ¶å‡½æ•°å·²ç»è¿”å›äº†ã€‚</p>
</blockquote>
<h2 id="åŸºäºå¼•ç”¨è®¡æ•°çš„åƒåœ¾æ”¶é›†å™¨"><a href="#åŸºäºå¼•ç”¨è®¡æ•°çš„åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="åŸºäºå¼•ç”¨è®¡æ•°çš„åƒåœ¾æ”¶é›†å™¨"></a>åŸºäºå¼•ç”¨è®¡æ•°çš„åƒåœ¾æ”¶é›†å™¨</h2><p>è¿™æ˜¯æœ€ç®€å•çš„åƒåœ¾æ”¶é›†å™¨ç®—æ³•ã€‚å¦‚æœæ²¡æœ‰å¼•ç”¨æŒ‡å‘è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œè¿™ä¸ªå¯¹è±¡å°±è¢«è®¤ä¸ºæ˜¯â€œå¯ä»¥ä½œä¸ºåƒåœ¾æ”¶é›†â€ã€‚</p>
<p>è¯·çœ‹å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> o1 = &#123;</div><div class="line">  <span class="attr">o2</span>: &#123;</div><div class="line">    <span class="attr">x</span>: <span class="number">1</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 2 objects are created. </span></div><div class="line"><span class="comment">// 'o2' is referenced by 'o1' object as one of its properties.</span></div><div class="line"><span class="comment">// None can be garbage-collected</span></div><div class="line"><span class="keyword">var</span> o3 = o1; <span class="comment">// the 'o3' variable is the second thing that </span></div><div class="line">            <span class="comment">// has a reference to the object pointed by 'o1'. </span></div><div class="line">o1 = <span class="number">1</span>;      <span class="comment">// now, the object that was originally in 'o1' has a         </span></div><div class="line">            <span class="comment">// single reference, embodied by the 'o3' variable</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> o4 = o3.o2; <span class="comment">// reference to 'o2' property of the object.</span></div><div class="line">                <span class="comment">// This object has now 2 references: one as</span></div><div class="line">                <span class="comment">// a property. </span></div><div class="line">                <span class="comment">// The other as the 'o4' variable</span></div><div class="line"></div><div class="line">o3 = <span class="string">'374'</span>; <span class="comment">// The object that was originally in 'o1' has now zero</span></div><div class="line">            <span class="comment">// references to it. </span></div><div class="line">            <span class="comment">// It can be garbage-collected.</span></div><div class="line">            <span class="comment">// However, what was its 'o2' property is still</span></div><div class="line">            <span class="comment">// referenced by the 'o4' variable, so it cannot be</span></div><div class="line">            <span class="comment">// freed.</span></div><div class="line"></div><div class="line">o4 = <span class="literal">null</span>; <span class="comment">// what was the 'o2' property of the object originally in</span></div><div class="line">           <span class="comment">// 'o1' has zero references to it. </span></div><div class="line">           <span class="comment">// It can be garbage collected.</span></div></pre></td></tr></table></figure>
<h2 id="å¾ªç¯åœ¨äº§ç”Ÿé—®é¢˜"><a href="#å¾ªç¯åœ¨äº§ç”Ÿé—®é¢˜" class="headerlink" title="å¾ªç¯åœ¨äº§ç”Ÿé—®é¢˜"></a>å¾ªç¯åœ¨äº§ç”Ÿé—®é¢˜</h2><p>å½“é‡åˆ°å¾ªç¯çš„æ—¶å€™å°±ä¼šæœ‰ä¸€ä¸ªé™åˆ¶ã€‚åœ¨ä¸‹é¢çš„å®ä¾‹ä¹‹ä¸­ï¼Œåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”äº’ç›¸å¼•ç”¨ï¼Œå› æ­¤å°±ä¼šäº§ç”Ÿä¸€ä¸ªå¾ªç¯ã€‚å½“å‡½æ•°è°ƒç”¨ç»“æŸä¹‹åå®ƒä»¬ä¼šèµ°å‡ºä½œç”¨åŸŸä¹‹å¤–ï¼Œå› æ­¤å®ƒä»¬å°±æ²¡ä»€ä¹ˆç”¨å¹¶ä¸”å¯ä»¥è¢«é‡Šæ”¾ã€‚ä½†æ˜¯ï¼ŒåŸºäºå¼•ç”¨è®¡æ•°çš„ç®—æ³•è®¤ä¸ºè¿™ä¸¤ä¸ªå¯¹è±¡éƒ½ä¼šè¢«è‡³å°‘å¼•ç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥å®ƒä¿©éƒ½ä¸ä¼šè¢«åƒåœ¾æ”¶é›†å™¨æ”¶é›†ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> o1 = &#123;&#125;;</div><div class="line">  <span class="keyword">var</span> o2 = &#123;&#125;;</div><div class="line">  o1.p = o2; <span class="comment">// o1 references o2</span></div><div class="line">  o2.p = o1; <span class="comment">// o2 references o1. This creates a cycle.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">f();</div></pre></td></tr></table></figure>
<p><a href="http://idiotsky.me/images1/javascript-how-work-3-4.png"><img src="http://idiotsky.me/images1/javascript-how-work-3-4.png" alt=""></a></p>
<h2 id="æ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#æ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="æ ‡è®°-æ¸…é™¤ç®—æ³•"></a>æ ‡è®°-æ¸…é™¤ç®—æ³•</h2><p>ä¸ºäº†å†³å®šå“ªä¸ªå¯¹è±¡æ˜¯éœ€è¦çš„ï¼Œç®—æ³•ä¼šå†³å®šæ˜¯å¦è¿™ä¸ªå¯¹è±¡æ˜¯å¯è®¿é—®çš„ã€‚</p>
<p>è¿™ä¸ªç®—æ³•ç”±ä»¥ä¸‹æ­¥éª¤ç»„æˆï¼š</p>
<ol>
<li>è¿™ä¸ªåƒåœ¾æ”¶é›†å™¨æ„å»ºä¸€ä¸ªâ€œrootsâ€åˆ—è¡¨ã€‚Rootæ˜¯å…¨å±€å˜é‡ï¼Œè¢«ä»£ç ä¸­çš„å¼•ç”¨æ‰€ä¿å­˜ã€‚åœ¨ JavaScriptä¸­ï¼Œâ€œwindowâ€å°±æ˜¯è¿™æ ·çš„ä½œä¸ºrootçš„å…¨å±€å˜é‡çš„ä¾‹å­ã€‚</li>
<li>æ‰€æœ‰çš„rootéƒ½ä¼šè¢«ç›‘æµ‹å¹¶ä¸”è¢«æ ‡å¿—æˆæ´»è·ƒçš„ï¼ˆæ¯”å¦‚ä¸æ˜¯åƒåœ¾ï¼‰ã€‚æ‰€æœ‰çš„å­ä»£ä¹Ÿä¼šé€’å½’åœ°è¢«ç›‘æµ‹ã€‚æ‰€æœ‰èƒ½å¤Ÿç”±rootè®¿é—®çš„ä¸€åˆ‡éƒ½ä¸ä¼šè¢«è®¤ä¸ºæ˜¯åƒåœ¾ã€‚</li>
<li>æ‰€æœ‰ä¸å†è¢«æ ‡å¿—æˆæ´»è·ƒçš„å†…å­˜å—éƒ½è¢«è®¤ä¸ºæ˜¯åƒåœ¾ã€‚è¿™ä¸ªæ”¶é›†å™¨ç°åœ¨å°±å¯ä»¥é‡Šæ”¾è¿™äº›å†…å­˜å¹¶å°†å®ƒä»¬è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</li>
</ol>
<p><a href="http://idiotsky.me/images1/javascript-how-work-3-5.gif"><img src="http://idiotsky.me/images1/javascript-how-work-3-5.gif" alt=""></a></p>
<p>è¿™ä¸ªç®—æ³•è¦ä¼˜äºä¹‹å‰çš„å› ä¸ºâ€œä¸€ä¸ªå…·æœ‰0å¼•ç”¨çš„å¯¹è±¡â€å¯ä»¥è®©ä¸€ä¸ªå¯¹è±¡ä¸èƒ½å¤Ÿå†è¢«è®¿é—®ã€‚ä½†æ˜¯ç›¸åçš„å´ä¸ä¸€å®šæˆç«‹ï¼Œæ¯”å¦‚æˆ‘ä»¬é‡åˆ°å¾ªç¯çš„æ—¶å€™ã€‚</p>
<p>åœ¨2012å¹´ï¼Œæ‰€æœ‰çš„ç°ä»£æµè§ˆå™¨éƒ½ä½¿ç”¨æ ‡è®°-æ¸…é™¤åƒåœ¾æ”¶é›†å™¨ã€‚è¿‡å»å‡ å¹´ï¼ŒJavaScriptåƒåœ¾æ”¶é›†ï¼ˆä»£æ•°/å¢é‡/å¹¶è¡Œ/å¹¶è¡Œåƒåœ¾æ”¶é›†ï¼‰é¢†åŸŸçš„æ‰€æœ‰æ”¹è¿›éƒ½æ˜¯å¯¹è¯¥ç®—æ³•ï¼ˆæ ‡è®°å’Œæ‰«æï¼‰çš„å®ç°è¿›è¡Œäº†æ”¹è¿›ï¼Œä½†å¹¶æ²¡æœ‰å¯¹åƒåœ¾æ”¶é›†ç®—æ³•æœ¬èº«çš„æ”¹è¿›ï¼Œ å…¶ç›®æ ‡æ˜¯ç¡®å®šä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯è¾¾ã€‚</p>
<p><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection" target="_blank" rel="external">åœ¨è¿™ç¯‡æ–‡ç« ä¸­</a>ï¼Œä½ å¯ä»¥å¾—åˆ°æ›´å¤šå…³äºåƒåœ¾æ”¶é›†è¿½è¸ªå¹¶ä¸”ä¹Ÿè¦†ç›–åˆ°äº†å…³äºæ ‡è®°-æ¸…é™¤ç®—æ³•çš„ä¼˜åŒ–ã€‚</p>
<h2 id="å¾ªç¯ä¸å†æ˜¯ä¸€ä¸ªé—®é¢˜"><a href="#å¾ªç¯ä¸å†æ˜¯ä¸€ä¸ªé—®é¢˜" class="headerlink" title="å¾ªç¯ä¸å†æ˜¯ä¸€ä¸ªé—®é¢˜"></a>å¾ªç¯ä¸å†æ˜¯ä¸€ä¸ªé—®é¢˜</h2><p>åœ¨ä¸Šè¿°çš„ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œåœ¨å‡½æ•°è°ƒç”¨è¿”å›ä¹‹åï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¸èƒ½å¤Ÿè¢«å…¨å±€å¯¹è±¡æ‰€è®¿é—®ã€‚å› æ­¤ï¼Œåƒåœ¾æ”¶é›†å™¨å°±ä¼šå‘ç°å®ƒä»¬ä¸èƒ½å¤Ÿè¢«è®¿é—®äº†ã€‚</p>
<p><a href="http://idiotsky.me/images1/javascript-how-work-3-6.png"><img src="http://idiotsky.me/images1/javascript-how-work-3-6.png" alt=""></a></p>
<p>å³ä½¿åœ¨è¿™ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å­˜åœ¨ç€å¼•ç”¨ï¼Œå®ƒä»¬å†ä¹Ÿä¸èƒ½ä»rootè®¿é—®äº†ã€‚</p>
<h2 id="åˆ—ä¸¾åƒåœ¾æ”¶é›†å™¨çš„ç›´è§‚è¡Œä¸º"><a href="#åˆ—ä¸¾åƒåœ¾æ”¶é›†å™¨çš„ç›´è§‚è¡Œä¸º" class="headerlink" title="åˆ—ä¸¾åƒåœ¾æ”¶é›†å™¨çš„ç›´è§‚è¡Œä¸º"></a>åˆ—ä¸¾åƒåœ¾æ”¶é›†å™¨çš„ç›´è§‚è¡Œä¸º</h2><p>è™½ç„¶åƒåœ¾æ”¶é›†å™¨å¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒä»¬è‡ªå·±ä¹Ÿæœ‰è‡ªå·±çš„ä»£ä»·ã€‚ å…¶ä¸­ä¸€ä¸ªæ˜¯éç¡®å®šè®ºã€‚ æ¢å¥è¯è¯´ï¼ŒGCæ˜¯ä¸å¯é¢„æµ‹çš„ã€‚ ä½ ä¸èƒ½çœŸæ­£åœ°å‘Šè¯‰ä½ ä»€ä¹ˆæ—¶å€™ä¼šæ”¶é›†ã€‚ è¿™æ„å‘³ç€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºä¼šä½¿ç”¨å®é™…éœ€è¦çš„æ›´å¤šå†…å­˜ã€‚ åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ•æ„Ÿçš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šå¼•èµ·çŸ­æš‚æš‚åœã€‚ è™½ç„¶éç¡®å®šæ€§æ„å‘³ç€åœ¨æ‰§è¡Œé›†åˆæ—¶æ— æ³•ç¡®å®šï¼Œä½†å¤§å¤šæ•°GCå®ç°å…±äº«åœ¨åˆ†é…æœŸé—´æ‰§è¡Œæ”¶é›†éå†çš„å¸¸è§æ¨¡å¼ã€‚ å¦‚æœæ²¡æœ‰æ‰§è¡Œåˆ†é…ï¼Œå¤§å¤šæ•°GCä¿æŒç©ºé—²çŠ¶æ€ã€‚ è€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼š</p>
<ol>
<li>æ‰§è¡Œç›¸å½“å¤§çš„ä¸€ç»„åˆ†é…ã€‚</li>
<li>è¿™äº›å…ƒç´ ä¸­çš„å¤§å¤šæ•°ï¼ˆæˆ–å…¨éƒ¨ï¼‰è¢«æ ‡è®°ä¸ºä¸å¯è®¿é—®ï¼ˆå‡è®¾æˆ‘ä»¬å°†æŒ‡å‘æˆ‘ä»¬ä¸å†éœ€è¦çš„ç¼“å­˜çš„å¼•ç”¨ç½®ç©ºï¼‰ã€‚</li>
<li>ä¸å†æ‰§è¡Œåˆ†é…ã€‚</li>
</ol>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•°GCä¸ä¼šå†è¿è¡Œæ”¶é›†å¤„ç†ã€‚æ¢å¥è¯è¯´ï¼Œå³ä½¿å­˜åœ¨å¯¹äºæ”¶é›†å™¨æ¥è¯´ä¸å¯è®¿é—®çš„å¼•ç”¨ï¼Œå®ƒä»¬ä¹Ÿä¸ä¼šè¢«æ”¶é›†å™¨æ‰€è®¤é¢†ã€‚ä¸¥æ ¼æ„ä¹‰æ¥è¯´è¿™å¹¶ä¸æ˜¯æ³„éœ²ï¼Œä½†æ˜¯ä¾ç„¶ä¼šå¯¼è‡´æ¯”å¹³å¸¸æ›´å¤šçš„å†…å­˜ä½¿ç”¨ã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Ÿ</h1><p>å®è´¨ä¸Šï¼Œå†…å­˜æ³„æ¼å¯ä»¥è¢«å®šä¹‰ä¸ºåº”ç”¨ç¨‹åºä¸å†éœ€è¦çš„å†…å­˜ï¼Œä½†æ˜¯ç”±äºæŸäº›åŸå› ä¸ä¼šè¿”å›åˆ°æ“ä½œç³»ç»Ÿæˆ–å¯ç”¨å†…å­˜æ± ã€‚</p>
<p><a href="http://idiotsky.me/images1/javascript-how-work-3-7.jpg"><img src="http://idiotsky.me/images1/javascript-how-work-3-7.jpg" alt=""></a></p>
<p>ç¼–ç¨‹è¯­è¨€æœ‰æ”¯æŒç®¡ç†å†…å­˜çš„ä¸åŒæ–¹æ³•ã€‚ ç„¶è€Œï¼ŒæŸå—å†…å­˜æ˜¯å¦è¢«ä½¿ç”¨å®é™…ä¸Šæ˜¯ä¸€ä¸ª<a href="ttps://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management#Release_when_the_memory_is_not_needed_anymore" target="_blank" rel="external">ä¸å¯åˆ¤å®šçš„é—®é¢˜</a>ã€‚ æ¢å¥è¯è¯´ï¼Œåªæœ‰å¼€å‘äººå‘˜å¯ä»¥æ¸…æ¥šä¸€ä¸ªå†…å­˜æ˜¯å¦å¯ä»¥è¿”å›åˆ°æ“ä½œç³»ç»Ÿã€‚</p>
<p>æŸäº›ç¼–ç¨‹è¯­è¨€æä¾›äº†å¸®åŠ©å¼€å‘è€…æ‰§è¡Œæ­¤æ“ä½œçš„åŠŸèƒ½ã€‚å…¶ä»–çš„åˆ™æœŸæœ›å¼€å‘äººå‘˜èƒ½å¤Ÿå®Œå…¨æ˜ç¡®ä½•æ—¶ä½¿ç”¨ä¸€å—å†…å­˜ã€‚ ç»´åŸºç™¾ç§‘æœ‰å…³äº<a href="https://en.wikipedia.org/wiki/Manual_memory_management" target="_blank" rel="external">æ‰‹åŠ¨</a>å’Œ<a href="https://en.wikipedia.org/wiki/Manual_memory_management" target="_blank" rel="external">è‡ªåŠ¨</a>å†…å­˜ç®¡ç†çš„å¥½æ–‡ç« ã€‚</p>
<h2 id="å››ç§å¸¸è§çš„JavaScriptæ³„éœ²"><a href="#å››ç§å¸¸è§çš„JavaScriptæ³„éœ²" class="headerlink" title="å››ç§å¸¸è§çš„JavaScriptæ³„éœ²"></a>å››ç§å¸¸è§çš„JavaScriptæ³„éœ²</h2><h3 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h3><p>JavaScript ä½¿ç”¨ä¸€ç§æœ‰è¶£çš„æ–¹å¼å¤„ç†æœªå£°æ˜çš„å˜é‡ï¼šä¸€ä¸ªæœªå£°æ˜å˜é‡çš„å¼•ç”¨ä¼šåœ¨<em>å…¨å±€</em>å¯¹è±¡å†…éƒ¨äº§ç”Ÿä¸€ä¸ªæ–°çš„å˜é‡ã€‚åœ¨æµè§ˆå™¨çš„æƒ…å†µï¼Œè¿™ä¸ªå…¨å±€å˜é‡å°±ä¼šæ˜¯windowã€‚æ¢å¥è¯è¯´ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">arg</span>) </span>&#123;</div><div class="line">    bar = <span class="string">"some text"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç­‰åŒäºï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">arg</span>) </span>&#123;</div><div class="line">    <span class="built_in">window</span>.bar = <span class="string">"some text"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœbarè¢«æœŸæœ›ä»…ä»…åœ¨fooå‡½æ•°ä½œç”¨åŸŸå†…ä¿æŒå¯¹å˜é‡çš„å¼•ç”¨ï¼Œå¹¶ä¸”ä½ å¿˜è®°ä½¿ç”¨varå»å£°æ˜å®ƒï¼Œä¸€ä¸ªæ„æƒ³ä¸åˆ°çš„å…¨å±€å˜é‡å°±äº§ç”Ÿäº†ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ³„éœ²å°±ä»…ä»…æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¹¶ä¸ä¼šå¸¦æ¥å¤ªå¤šå±å®³ï¼Œä½†æ˜¯å®ƒå¯èƒ½ä¼šå˜å¾—æ›´ç³Ÿã€‚</p>
<p>å¦å¤–ä¸€ç§å¯èƒ½äº§ç”Ÿæ„å¤–çš„å…¨å±€å˜é‡çš„æ–¹å¼æ˜¯ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.var1 = <span class="string">"potential accidental global"</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Foo called on its own, this points to the global object (window)</span></div><div class="line"><span class="comment">// rather than being undefined.</span></div><div class="line">foo();</div></pre></td></tr></table></figure>
<blockquote>
<p> ä¸ºäº†é˜»æ­¢è¿™äº›é”™è¯¯çš„å‘ç”Ÿï¼Œå¯ä»¥åœ¨jsæ–‡ä»¶å¤´éƒ¨æ·»åŠ â€™use strictâ€™ã€‚è¿™å°†ä¼šä½¿ç”¨ä¸¥æ ¼æ¨¡å¼æ¥è§£æ JavaScript ä»è€Œé˜»æ­¢æ„å¤–çš„å…¨å±€å˜é‡ã€‚<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode" target="_blank" rel="external">äº†è§£æ›´å¤š</a>å…³äºJavaScriptæ‰§è¡Œçš„æ¨¡å¼ã€‚</p>
</blockquote>
<p>å³ä½¿æˆ‘ä»¬è®¨è®ºäº†æœªé¢„æœŸçš„å…¨å±€å˜é‡ï¼Œä½†ä»ç„¶æœ‰å¾ˆå¤šä»£ç ç”¨æ˜¾å¼çš„å…¨å±€å˜é‡å¡«å……ã€‚ è¿™äº›å®šä¹‰æ˜¯ä¸å¯æ”¶é›†çš„ï¼ˆé™¤éåˆ†é…ä¸ºnullæˆ–é‡æ–°åˆ†é…ï¼‰ã€‚ ç‰¹åˆ«æ˜¯ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨å’Œå¤„ç†å¤§é‡ä¿¡æ¯çš„å…¨å±€å˜é‡å€¼å¾—å…³æ³¨ã€‚ å¦‚æœä½ å¿…é¡»ä½¿ç”¨å…¨å±€å˜é‡æ¥å­˜å‚¨å¤§é‡æ•°æ®ï¼Œè¯·ç¡®ä¿åœ¨å®Œæˆä¹‹å<strong>å°†å…¶åˆ†é…ä¸ºnullæˆ–é‡æ–°åˆ†é…</strong>ã€‚</p>
<h3 id="è¢«é—å¿˜çš„è®¡æ—¶å™¨å’Œå›è°ƒ"><a href="#è¢«é—å¿˜çš„è®¡æ—¶å™¨å’Œå›è°ƒ" class="headerlink" title="è¢«é—å¿˜çš„è®¡æ—¶å™¨å’Œå›è°ƒ"></a>è¢«é—å¿˜çš„è®¡æ—¶å™¨å’Œå›è°ƒ</h3><p><code>setInterval</code> åœ¨ JavaScript ä¸­æ˜¯ç»å¸¸è¢«ä½¿ç”¨çš„ã€‚</p>
<p>å¤§å¤šæ•°æä¾›è§‚å¯Ÿè€…å’Œå…¶ä»–æ¨¡å¼çš„å›è°ƒå‡½æ•°åº“éƒ½ä¼šåœ¨è°ƒç”¨è‡ªå·±çš„å®ä¾‹å˜å¾—æ— æ³•è®¿é—®ä¹‹åå¯¹å…¶ä»»ä½•å¼•ç”¨ä¹Ÿè®¾ç½®ä¸ºä¸å¯è®¿é—®ã€‚ ä½†æ˜¯åœ¨<code>setInterval</code>çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„ä»£ç å¾ˆå¸¸è§ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> serverData = loadData();</div><div class="line">setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> renderer = <span class="built_in">document</span>.getElementById(<span class="string">'renderer'</span>);</div><div class="line">    <span class="keyword">if</span>(renderer) &#123;</div><div class="line">        renderer.innerHTML = <span class="built_in">JSON</span>.stringify(serverData);</div><div class="line">    &#125;</div><div class="line">&#125;, <span class="number">5000</span>); <span class="comment">//This will be executed every ~5 seconds.</span></div></pre></td></tr></table></figure>
<p>è¿™ä¸ªä¾‹å­è¯´æ˜äº†è®¡æ—¶å™¨å¯èƒ½å‘ç”Ÿçš„æƒ…å†µï¼šè®¡æ—¶å™¨å¯èƒ½ä¼šäº§ç”Ÿå†ä¹Ÿä¸è¢«éœ€è¦çš„èŠ‚ç‚¹æˆ–è€…æ•°æ®çš„å¼•ç”¨ã€‚</p>
<p><code>renderer</code>æ‰€ä»£è¡¨çš„å¯¹è±¡åœ¨æœªæ¥å¯èƒ½è¢«ç§»é™¤ï¼Œè®©éƒ¨åˆ†interval å¤„ç†å™¨ä¸­ä»£ç å˜å¾—ä¸å†è¢«éœ€è¦ã€‚ç„¶è€Œï¼Œè¿™ä¸ªå¤„ç†å™¨ä¸èƒ½å¤Ÿè¢«æ”¶é›†å› ä¸ºintervalä¾ç„¶æ´»è·ƒçš„ï¼ˆè¿™ä¸ªintervaléœ€è¦è¢«åœæ­¢ä»è€Œè¡¨é¢è¿™ç§æƒ…å†µï¼‰ã€‚å¦‚æœè¿™ä¸ªintervalå¤„ç†å™¨ä¸èƒ½å¤Ÿè¢«æ”¶é›†ï¼Œé‚£ä¹ˆå®ƒçš„ä¾èµ–ä¹Ÿä¸èƒ½å¤Ÿè¢«æ”¶é›†ã€‚è¿™æ„å‘³è¿™å­˜å‚¨å¤§é‡æ•°æ®çš„<code>severData</code>ä¹Ÿä¸èƒ½å¤Ÿè¢«æ”¶é›†ã€‚</p>
<p>åœ¨è¿™ç§è§‚å¯Ÿè€…çš„æƒ…å†µä¸‹ï¼Œåšå‡ºå‡†ç¡®çš„è°ƒç”¨ä»è€Œåœ¨ä¸éœ€è¦å®ƒä»¬çš„æ—¶å€™ç«‹å³å°†å…¶ç§»é™¤æ˜¯éå¸¸é‡è¦çš„ï¼ˆæˆ–è€…ç›¸å…³çš„å¯¹è±¡è¢«ç½®ä¸ºä¸å¯è®¿é—®çš„ï¼‰ã€‚</p>
<p>è¿‡å»ï¼Œä»¥å‰ç‰¹åˆ«é‡è¦çš„æ˜¯æŸäº›æµè§ˆå™¨ï¼ˆå¥½çš„è€IE 6ï¼‰æ— æ³•ç®¡ç†å¥½å¾ªç¯å¼•ç”¨ï¼ˆæœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹æ–‡ï¼‰ã€‚ å¦‚ä»Šï¼Œå¤§å¤šæ•°æµè§ˆå™¨ä¸€æ—¦è§‚å¯Ÿåˆ°çš„å¯¹è±¡å˜å¾—æ— æ³•è®¿é—®ï¼Œå°±èƒ½æ”¶é›†è§‚å¯Ÿè€…å¤„ç†å™¨ï¼Œå³ä½¿ä¾¦å¬å™¨æ²¡æœ‰è¢«æ˜ç¡®åˆ é™¤ã€‚ ä½†æ˜¯ï¼Œåœ¨å¤„ç†å¯¹è±¡ä¹‹å‰ï¼Œæ˜ç¡®åˆ é™¤è¿™äº›è§‚å¯Ÿè€…ä»ç„¶æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åšæ³•ã€‚ ä¾‹å¦‚ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> element = <span class="built_in">document</span>.getElementById(<span class="string">'launch-button'</span>);</div><div class="line"><span class="keyword">var</span> counter = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onClick</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">   counter++;</div><div class="line">   element.innerHtml = <span class="string">'text '</span> + counter;</div><div class="line">&#125;</div><div class="line"></div><div class="line">element.addEventListener(<span class="string">'click'</span>, onClick);</div><div class="line"></div><div class="line"><span class="comment">// Do stuff</span></div><div class="line"></div><div class="line">element.removeEventListener(<span class="string">'click'</span>, onClick);</div><div class="line">element.parentNode.removeChild(element);</div><div class="line"></div><div class="line"><span class="comment">// Now when element goes out of scope,</span></div><div class="line"><span class="comment">// both element and onClick will be collected even in old browsers // that don't handle cycles well.</span></div></pre></td></tr></table></figure>
<p>å½“ä»Šï¼Œç°åœ¨æµè§ˆå™¨ï¼ˆæŠ¥é”™IEå’ŒEdgeï¼‰éƒ½ä½¿ç”¨äº†ç°ä»£çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œå…¶èƒ½å¤Ÿæ£€æµ‹åˆ°è¿™äº›å¾ªç¯å¹¶ä¸”è¿›è¡Œé€‚å®œçš„å¤„ç†ã€‚æ¢å¥è¯è¯´ï¼Œå†ä¹Ÿä¸æ˜¯ä¸¥æ ¼éœ€è¦åœ¨å°†èŠ‚ç‚¹ç½®ä¸ºä¸å¯è®¿é—®ä¹‹å‰è°ƒç”¨removeEventListener ã€‚</p>
<p>æ¡†æ¶å’Œåº“ï¼ˆå¦‚jQueryï¼‰åœ¨å¤„ç†èŠ‚ç‚¹ä¹‹å‰ï¼ˆåœ¨ä¸ºå…¶ä½¿ç”¨ç‰¹å®šçš„APIæ—¶ï¼‰ä¼šåˆ é™¤ä¾¦å¬å™¨ã€‚ è¿™æ˜¯ç”±åº“å†…éƒ¨å¤„ç†çš„ï¼Œè¿™ä¹Ÿç¡®ä¿æ²¡æœ‰æ³„æ¼ï¼Œå³ä½¿åœ¨æœ‰é—®é¢˜çš„æµè§ˆå™¨ä¸‹è¿è¡Œï¼Œå¦‚â€¦æ˜¯çš„ï¼ŒIE 6ã€‚</p>
<h3 id="é—­åŒ…"><a href="#é—­åŒ…" class="headerlink" title="é—­åŒ…"></a>é—­åŒ…</h3><p>JavaScript å¼€å‘çš„ä¸€ä¸ªå…³é”®æ–¹é¢æ˜¯é—­åŒ…ï¼šä¸€ä¸ªå¯ä»¥è®¿é—®å¤–éƒ¨ï¼ˆå°é—­ï¼‰å‡½æ•°å˜é‡çš„å†…éƒ¨å‡½æ•°ã€‚ ç”±äºJavaScriptè¿è¡Œæ—¶çš„å®ç°ç»†èŠ‚ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ³„æ¼å†…å­˜ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">var</span> theThing = <span class="literal">null</span>;</div><div class="line"> <span class="keyword">var</span> replaceThing = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> 	<span class="keyword">var</span> originalThing = theThing;</div><div class="line"> 	<span class="keyword">var</span> unused = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    	<span class="keyword">if</span> (originalThing) <span class="comment">// a reference to 'originalThing'</span></div><div class="line">      		<span class="built_in">console</span>.log(<span class="string">"hi"</span>);</div><div class="line">  	&#125;;</div><div class="line"></div><div class="line">  	theThing = &#123;</div><div class="line">    	<span class="attr">longStr</span>: <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1000000</span>).join(<span class="string">'*'</span>),</div><div class="line">    	<span class="attr">someMethod</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      		<span class="built_in">console</span>.log(<span class="string">"message"</span>);</div><div class="line">    	&#125;</div><div class="line">  &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">setInterval(replaceThing, <span class="number">1000</span>);</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªä»£ç æ®µä¼šåšä¸€ä»¶äº‹æƒ…ï¼šæ¯æ¬¡ <code>replaceThing</code> è¢«è°ƒç”¨æ—¶ï¼Œ<code>theThing</code> éƒ½ä¼šè·å–ä¸€ä¸ªä¸€ä¸ªåŒ…å«ä¸€ä¸ªå¤§æ•°ç»„çš„ä»¥åŠä¸€ä¸ªæ–°çš„é—­åŒ…ï¼ˆ<code>someMethod</code>ï¼‰ã€‚åŒæ—¶ï¼Œ<code>unused</code> ä¼šä¿æŒä¸€ä¸ªæŒ‡å‘<code>originalThing</code>å¼•ç”¨çš„é—­åŒ…ï¼ˆä»ä¸Šä¸€ä¸ªè°ƒç”¨çš„<code>theThing</code>åˆ°<code>replaceThing</code>ï¼‰ã€‚å¯èƒ½å·²ç»å¾ˆè¿·æƒ‘äº†ï¼Œæ˜¯ä¸æ˜¯ï¼Ÿé‡è¦çš„äº‹æƒ…æ˜¯<strong>ä¸€æ—¦åœ¨ç›¸åŒçš„çˆ¶çº§ä½œç”¨åŸŸä¸ºé—­åŒ…äº§ç”Ÿä½œç”¨åŸŸï¼Œè¿™ä¸ªä½œç”¨åŸŸå°±ä¼šè¢«å…±äº«</strong>ã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸º<code>someMethod</code>é—­åŒ…äº§ç”Ÿçš„ä½œç”¨åŸŸå°±ä¼šè¢«<code>unused</code> æ‰€å…±äº«ã€‚<code>unused</code> å…·æœ‰å¯¹äº<code>originaThing</code>çš„å¼•ç”¨ã€‚å³ä½¿ <code>unused</code>  ä¸å†è¢«ä½¿ç”¨ï¼Œ<code>someMethod</code>ä¾ç„¶å¯ä»¥é€šè¿‡<code>replaceThing</code>ä½œç”¨åŸŸä¹‹å¤–çš„<code>theThing</code>æ¥ä½¿ç”¨ã€‚å¹¶ä¸”ç”±äº<code>somethod</code>å’Œ<code>unused</code> å…±äº«é—­åŒ…ä½œç”¨åŸŸï¼ŒunusedæŒ‡å‘originalThingçš„å¼•ç”¨å¼ºè¿«å…¶ä¿æŒæ´»è·ƒï¼ˆä¸¤ä¸ªé—­åŒ…ä¹‹é—´çš„æ•´ä¸ªå…±äº«ä½œç”¨åŸŸï¼‰ã€‚è¿™å°†ä¼šé˜»æ­¢åƒåœ¾æ‰‹æœºã€‚</p>
<p>å½“è¿™ä¸ªä»£ç æ®µé‡å¤è¿è¡Œæ—¶ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°å†…å­˜ä½¿ç”¨é‡çš„ç¨³å®šå¢é•¿ã€‚ å½“GCè¿è¡Œæ—¶ï¼Œè¿™ä¸ä¼šå˜å°ã€‚ å®è´¨ä¸Šï¼Œåˆ›å»ºäº†ä¸€ä¸ªå…³é—­çš„é“¾æ¥åˆ—è¡¨ï¼ˆå…¶rootä»¥TheThingå˜é‡çš„å½¢å¼ï¼‰ï¼Œå¹¶ä¸”è¿™äº›é—­åŒ…çš„èŒƒå›´ä¸­çš„æ¯ä¸€ä¸ªéƒ½å¯¹å¤§æ•°ç»„è¿›è¡Œé—´æ¥å¼•ç”¨ï¼Œå¯¼è‡´ç›¸å½“å¤§çš„æ³„æ¼ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜ç”±Meteorå›¢é˜Ÿå‘ç°ï¼Œä»–ä»¬æœ‰<a href="https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156" target="_blank" rel="external">ä¸€ç¯‡å¾ˆå¥½çš„æ–‡ç« </a>ï¼Œè¯¦ç»†æè¿°äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<h3 id="DOM-ä¹‹å¤–çš„å¼•ç”¨"><a href="#DOM-ä¹‹å¤–çš„å¼•ç”¨" class="headerlink" title="DOM ä¹‹å¤–çš„å¼•ç”¨"></a>DOM ä¹‹å¤–çš„å¼•ç”¨</h3><p>æœ‰æ—¶å°†DOMèŠ‚ç‚¹å­˜å‚¨åœ¨æ•°æ®ç»“æ„ä¸­å¯èƒ½æ˜¯æœ‰ç”¨çš„ã€‚ å‡è®¾è¦å¿«é€Ÿæ›´æ–°è¡¨ä¸­çš„å‡ è¡Œå†…å®¹ã€‚ å­˜å‚¨å¯¹å­—å…¸æˆ–æ•°ç»„ä¸­æ¯ä¸ªDOMè¡Œçš„å¼•ç”¨å¯èƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚ å½“å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œä¼šä¿ç•™å¯¹åŒä¸€DOMå…ƒç´ çš„ä¸¤ä¸ªå¼•ç”¨ï¼šä¸€ä¸ªåœ¨DOMæ ‘ä¸­ï¼Œå¦ä¸€ä¸ªåœ¨å­—å…¸ä¸­ã€‚ å¦‚æœå°†æ¥æŸä¸ªæ—¶å€™æ‚¨å†³å®šåˆ é™¤è¿™äº›è¡Œï¼Œåˆ™éœ€è¦ä½¿ä¸¤ä¸ªå¼•ç”¨ç½®ä¸ºä¸å¯è®¿é—®ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> elements = &#123;</div><div class="line">    <span class="attr">button</span>: <span class="built_in">document</span>.getElementById(<span class="string">'button'</span>),</div><div class="line">    <span class="attr">image</span>: <span class="built_in">document</span>.getElementById(<span class="string">'image'</span>)</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">doStuff</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    image.src = <span class="string">'http://example.com/image_name.png'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeImage</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// The image is a direct child of the body element.</span></div><div class="line">    <span class="built_in">document</span>.body.removeChild(<span class="built_in">document</span>.getElementById(<span class="string">'image'</span>));</div><div class="line"></div><div class="line">    <span class="comment">// At this point, we still have a reference to #button in the</span></div><div class="line">    <span class="comment">//global elements object. In other words, the button element is</span></div><div class="line">    <span class="comment">//still in memory and cannot be collected by the GC.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„è€ƒè™‘ï¼Œå½“æ¶‰åŠå¯¹DOMæ ‘å†…éƒ¨çš„å†…éƒ¨æˆ–å¶èŠ‚ç‚¹çš„å¼•ç”¨æ—¶ï¼Œå¿…é¡»è€ƒè™‘è¿™ä¸€ç‚¹ã€‚ å‡è®¾ä½ åœ¨JavaScriptä»£ç ä¸­ä¿ç•™å¯¹è¡¨æ ¼ç‰¹å®šå•å…ƒæ ¼ï¼ˆ<code>&lt;td&gt;</code>æ ‡è®°ï¼‰çš„å¼•ç”¨ã€‚ æœ‰ä¸€å¤©ï¼Œä½ å†³å®šä»DOMä¸­åˆ é™¤è¯¥è¡¨ï¼Œä½†ä¿ç•™å¯¹è¯¥å•å…ƒæ ¼çš„å¼•ç”¨ã€‚ ç›´è§‚åœ°ï¼Œå¯ä»¥å‡è®¾GCå°†æ”¶é›†é™¤äº†è¯¥å•å…ƒæ ¼ä¹‹å¤–çš„æ‰€æœ‰å†…å®¹ã€‚ å®é™…ä¸Šï¼Œè¿™ä¸ä¼šå‘ç”Ÿï¼šè¯¥å•å…ƒæ ¼æ˜¯è¯¥è¡¨çš„å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”å­©å­ä»¬ä¿æŒå¯¹çˆ¶ä»£çš„å¼•ç”¨ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä»JavaScriptä»£ç å¼•ç”¨è¡¨æ ¼å•å…ƒä¼šå¯¼è‡´æ•´ä¸ªè¡¨ä¿ç•™åœ¨å†…å­˜ä¸­ã€‚ ä¿æŒå¯¹DOMå…ƒç´ çš„å¼•ç”¨æ—¶éœ€è¦ä»”ç»†è€ƒè™‘ã€‚</p>
<p>å‚è€ƒ <a href="https://segmentfault.com/a/1190000011229300" target="_blank" rel="external">https://segmentfault.com/a/1190000011229300</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‡ ä¸ªç¤¼æ‹œä¹‹å‰æˆ‘ä»¬å¼€å§‹ä¸€ç³»åˆ—å¯¹äºJavaScriptä»¥åŠå…¶æœ¬è´¨å·¥ä½œåŸç†çš„æ·±å…¥æŒ–æ˜ï¼šæˆ‘ä»¬è®¤ä¸ºé€šè¿‡äº†è§£JavaScriptçš„æ„å»ºæ–¹å¼ä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•å…±åŒåˆä½œçš„ï¼Œä½ å°±èƒ½å¤Ÿå†™å‡ºæ›´å¥½çš„ä»£ç ä»¥åŠåº”ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€ç¯‡åšå®¢ä¸“æ³¨äºä»‹ç»&lt;a href=&quot;http://idiotsky.me/2017/08/26/javascript-how-work/&quot;&gt;å¯¹äºå¼•æ“ï¼Œè¿è¡Œæ—¶ä»¥åŠè°ƒç”¨æ ˆçš„æ¦‚è¿°&lt;/a&gt;ã€‚&lt;a href=&quot;http://idiotsky.me/2017/08/26/javascript-how-work-2/&quot;&gt;ç¬¬äºŒç¯‡åšå®¢è¿‘è·ç¦»åœ°æ£€æµ‹äº†Google V8 å¼•æ“çš„å†…éƒ¨&lt;/a&gt;å¹¶ä¸”æä¾›äº†ä¸€äº›å¦‚ä½•å†™å‡ºæ›´å¥½çš„JavaScriptä»£ç çš„å»ºè®®ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ç¬¬ä¸‰ç¯‡åšå®¢ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šè®¨è®ºå¦å¤–ä¸€ä¸ªå…³é”®çš„è¯é¢˜ã€‚è¿™ä¸ªè¯é¢˜ç”±äºéšç€ç¼–ç¨‹è¯­è¨€çš„é€æ¸æˆç†Ÿå’Œå¤æ‚åŒ–ï¼Œè¶Šæ¥è¶Šè¢«å¼€å‘è€…æ‰€å¿½è§†ï¼Œè¿™ä¸ªè¯é¢˜å°±æ˜¯åœ¨æ—¥å¸¸å·¥ä½œä¸­ä½¿ç”¨åˆ°çš„â€”â€”å†…å­˜ç®¡ç†ã€‚&lt;/p&gt;
&lt;h1 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;è¯­è¨€ï¼Œæ¯”å¦‚Cï¼Œå…·æœ‰ä½å±‚æ¬¡çš„å†…å­˜ç®¡ç†æ–¹æ³•ï¼Œæ¯”å¦‚&lt;code&gt;malloc()&lt;/code&gt;ä»¥åŠ&lt;code&gt;free()&lt;/code&gt;ã€‚å¼€å‘è€…åˆ©ç”¨è¿™äº›æ–¹æ³•ç²¾ç¡®åœ°ä¸ºæ“ä½œç³»ç»Ÿåˆ†é…ä»¥åŠé‡Šæ”¾å†…å­˜ã€‚&lt;/p&gt;
&lt;p&gt;åŒæ—¶ï¼ŒJavaScriptä¼šåœ¨åˆ›å»ºä¸€äº›å˜é‡ï¼ˆå¯¹è±¡ï¼Œå­—ç¬¦ä¸²ç­‰ç­‰ï¼‰çš„æ—¶å€™åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”ä¼šåœ¨è¿™äº›ä¸è¢«ä½¿ç”¨ä¹‹åâ€œè‡ªåŠ¨åœ°â€é‡Šæ”¾è¿™äº›å†…å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º&lt;em&gt;åƒåœ¾æ”¶é›†&lt;/em&gt;ã€‚è¿™ä¸ªçœ‹èµ·æ¥â€œè‡ªåŠ¨åŒ–çš„â€ç‰¹æ€§å…¶å®å°±æ˜¯äº§ç”Ÿè¯¯è§£çš„åŸå› ï¼Œå¹¶ä¸”ç»™JavaScriptï¼ˆä»¥åŠå…¶ä»–é«˜å±‚æ¬¡è¯­è¨€ï¼‰å¼€å‘è€…ä¸€ä¸ªå‡è±¡ï¼Œä»–ä»¬ä¸éœ€è¦å…³å¿ƒå†…å­˜ç®¡ç†ã€‚&lt;strong&gt;å¤§é”™ç‰¹é”™ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å³ä½¿æ˜¯ä½¿ç”¨é«˜å±‚æ¬¡è¯­è¨€ï¼Œå¼€å‘è€…åº”è¯¥å¯¹äºå†…å­˜ç®¡ç†æœ‰ä¸€å®šçš„ç†è§£ï¼ˆæˆ–è€…æœ€åŸºæœ¬çš„ç†è§£ï¼‰ã€‚æœ‰æ—¶å€™è‡ªåŠ¨çš„å†…å­˜ç®¡ç†ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼ˆæ¯”å¦‚ä¸€äº›bugæˆ–è€…åƒåœ¾æ”¶é›†å™¨çš„ä¸€äº›é™åˆ¶ç­‰ç­‰ï¼‰ï¼Œå¯¹äºè¿™äº›å¼€å‘è€…å¿…é¡»èƒ½å¤Ÿç†è§£ä»è€Œèƒ½å¤Ÿåˆé€‚åœ°å¤„ç†ï¼ˆæˆ–è€…ä½¿ç”¨æœ€å°çš„ä»£ä»·ä»¥åŠä»£ç å€ºåŠ¡å»ç»•è¿‡è¿™ä¸ªé—®é¢˜ï¼‰ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="javascript" scheme="http://idiotsky.me/categories/javascript/"/>
    
    
      <category term="javascript" scheme="http://idiotsky.me/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>MySQLä¼˜åŒ–åŸç†</title>
    <link href="http://idiotsky.me/2017/09/29/mysql-optimization-mechanism/"/>
    <id>http://idiotsky.me/2017/09/29/mysql-optimization-mechanism/</id>
    <published>2017-09-29T15:20:35.000Z</published>
    <updated>2017-10-02T08:03:13.579Z</updated>
    
    <content type="html"><![CDATA[<p>è¯´èµ·MySQLçš„æŸ¥è¯¢ä¼˜åŒ–ï¼Œç›¸ä¿¡å¤§å®¶æ”¶è—äº†ä¸€å †å¥‡æŠ€æ·«å·§ï¼šä¸èƒ½ä½¿ç”¨SELECT *ã€ä¸ä½¿ç”¨NULLå­—æ®µã€åˆç†åˆ›å»ºç´¢å¼•ã€ä¸ºå­—æ®µé€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹â€¦.. ä½ æ˜¯å¦çœŸçš„ç†è§£è¿™äº›ä¼˜åŒ–æŠ€å·§ï¼Ÿæ˜¯å¦ç†è§£å…¶èƒŒåçš„å·¥ä½œåŸç†ï¼Ÿåœ¨å®é™…åœºæ™¯ä¸‹æ€§èƒ½çœŸæœ‰æå‡å—ï¼Ÿæˆ‘æƒ³æœªå¿…ã€‚å› è€Œç†è§£è¿™äº›ä¼˜åŒ–å»ºè®®èƒŒåçš„åŸç†å°±å°¤ä¸ºé‡è¦ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ é‡æ–°å®¡è§†è¿™äº›ä¼˜åŒ–å»ºè®®ï¼Œå¹¶åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸‹åˆç†çš„è¿ç”¨ã€‚</p>
<h1 id="MySQLé€»è¾‘æ¶æ„"><a href="#MySQLé€»è¾‘æ¶æ„" class="headerlink" title="MySQLé€»è¾‘æ¶æ„"></a>MySQLé€»è¾‘æ¶æ„</h1><p>å¦‚æœèƒ½åœ¨å¤´è„‘ä¸­æ„å»ºä¸€å¹…MySQLå„ç»„ä»¶ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œçš„æ¶æ„å›¾ï¼Œæœ‰åŠ©äºæ·±å…¥ç†è§£MySQLæœåŠ¡å™¨ã€‚ä¸‹å›¾å±•ç¤ºäº†MySQLçš„é€»è¾‘æ¶æ„å›¾ã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-1.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-1.jpg" alt=""></a><br><a id="more"></a><br>MySQLé€»è¾‘æ¶æ„æ•´ä½“åˆ†ä¸ºä¸‰å±‚ï¼Œæœ€ä¸Šå±‚ä¸ºå®¢æˆ·ç«¯å±‚ï¼Œå¹¶éMySQLæ‰€ç‹¬æœ‰ï¼Œè¯¸å¦‚ï¼šè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€å®‰å…¨ç­‰åŠŸèƒ½å‡åœ¨è¿™ä¸€å±‚å¤„ç†ã€‚</p>
<p>MySQLå¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡å‡åœ¨ä¸­é—´è¿™ä¸€å±‚ï¼ŒåŒ…æ‹¬æŸ¥è¯¢è§£æã€åˆ†æã€ä¼˜åŒ–ã€ç¼“å­˜ã€å†…ç½®å‡½æ•°(æ¯”å¦‚ï¼šæ—¶é—´ã€æ•°å­¦ã€åŠ å¯†ç­‰å‡½æ•°)ã€‚æ‰€æœ‰çš„è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼šå­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚</p>
<p>æœ€ä¸‹å±‚ä¸ºå­˜å‚¨å¼•æ“ï¼Œå…¶è´Ÿè´£MySQLä¸­çš„æ•°æ®å­˜å‚¨å’Œæå–ã€‚å’ŒLinuxä¸‹çš„æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œæ¯ç§å­˜å‚¨å¼•æ“éƒ½æœ‰å…¶ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚ä¸­é—´çš„æœåŠ¡å±‚é€šè¿‡APIä¸å­˜å‚¨å¼•æ“é€šä¿¡ï¼Œè¿™äº›APIæ¥å£å±è”½äº†ä¸åŒå­˜å‚¨å¼•æ“é—´çš„å·®å¼‚ã€‚</p>
<h1 id="MySQLæŸ¥è¯¢è¿‡ç¨‹"><a href="#MySQLæŸ¥è¯¢è¿‡ç¨‹" class="headerlink" title="MySQLæŸ¥è¯¢è¿‡ç¨‹"></a>MySQLæŸ¥è¯¢è¿‡ç¨‹</h1><p>æˆ‘ä»¬æ€»æ˜¯å¸Œæœ›MySQLèƒ½å¤Ÿè·å¾—æ›´é«˜çš„æŸ¥è¯¢æ€§èƒ½ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å¼„æ¸…æ¥šMySQLæ˜¯å¦‚ä½•ä¼˜åŒ–å’Œæ‰§è¡ŒæŸ¥è¯¢çš„ã€‚ä¸€æ—¦ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œå°±ä¼šå‘ç°ï¼šå¾ˆå¤šçš„æŸ¥è¯¢ä¼˜åŒ–å·¥ä½œå®é™…ä¸Šå°±æ˜¯éµå¾ªä¸€äº›åŸåˆ™è®©MySQLçš„ä¼˜åŒ–å™¨èƒ½å¤ŸæŒ‰ç…§é¢„æƒ³çš„åˆç†æ–¹å¼è¿è¡Œè€Œå·²ã€‚</p>
<p>å½“å‘MySQLå‘é€ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒMySQLåˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-2.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-2.jpg" alt=""></a></p>
<h2 id="å®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡åè®®"><a href="#å®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡åè®®" class="headerlink" title="å®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®®"></a>å®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®®</h2><p>MySQLå®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®®æ˜¯â€œåŠåŒå·¥â€çš„ï¼šåœ¨ä»»ä¸€æ—¶åˆ»ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚ä¸€æ—¦ä¸€ç«¯å¼€å§‹å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€ç«¯è¦æ¥æ”¶å®Œæ•´ä¸ªæ¶ˆæ¯æ‰èƒ½å“åº”å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä¹Ÿæ— é¡»å°†ä¸€ä¸ªæ¶ˆæ¯åˆ‡æˆå°å—ç‹¬ç«‹å‘é€ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•è¿›è¡Œæµé‡æ§åˆ¶ã€‚</p>
<p>å®¢æˆ·ç«¯ç”¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åŒ…å°†æŸ¥è¯¢è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¯­å¥å¾ˆé•¿çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®max_allowed_packetå‚æ•°ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢å®åœ¨æ˜¯å¤ªå¤§ï¼ŒæœåŠ¡ç«¯ä¼šæ‹’ç»æ¥æ”¶æ›´å¤šæ•°æ®å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>ä¸ä¹‹ç›¸åçš„æ˜¯ï¼ŒæœåŠ¡å™¨å“åº”ç»™ç”¨æˆ·çš„æ•°æ®é€šå¸¸ä¼šå¾ˆå¤šï¼Œç”±å¤šä¸ªæ•°æ®åŒ…ç»„æˆã€‚ä½†æ˜¯å½“æœåŠ¡å™¨å“åº”å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯å¿…é¡»å®Œæ•´çš„æ¥æ”¶æ•´ä¸ªè¿”å›ç»“æœï¼Œè€Œä¸èƒ½ç®€å•çš„åªå–å‰é¢å‡ æ¡ç»“æœï¼Œç„¶åè®©æœåŠ¡å™¨åœæ­¢å‘é€ã€‚å› è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå°½é‡ä¿æŒæŸ¥è¯¢ç®€å•ä¸”åªè¿”å›å¿…éœ€çš„æ•°æ®ï¼Œå‡å°é€šä¿¡é—´æ•°æ®åŒ…çš„å¤§å°å’Œæ•°é‡æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ï¼Œè¿™ä¹Ÿæ˜¯æŸ¥è¯¢ä¸­å°½é‡é¿å…ä½¿ç”¨SELECT *ä»¥åŠåŠ ä¸ŠLIMITé™åˆ¶çš„åŸå› ä¹‹ä¸€ã€‚</p>
<h2 id="æŸ¥è¯¢ç¼“å­˜"><a href="#æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="æŸ¥è¯¢ç¼“å­˜"></a>æŸ¥è¯¢ç¼“å­˜</h2><p>åœ¨è§£æä¸€ä¸ªæŸ¥è¯¢è¯­å¥å‰ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆMySQLä¼šæ£€æŸ¥è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ä¸­çš„æ•°æ®ã€‚å¦‚æœå½“å‰æŸ¥è¯¢æ°å¥½å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œåœ¨æ£€æŸ¥ä¸€æ¬¡ç”¨æˆ·æƒé™åç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„ç»“æœã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¸ä¼šè¢«è§£æï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ›´ä¸ä¼šæ‰§è¡Œã€‚</p>
<p>MySQLå°†ç¼“å­˜å­˜æ”¾åœ¨ä¸€ä¸ªå¼•ç”¨è¡¨ï¼ˆä¸è¦ç†è§£æˆtableï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç±»ä¼¼äºHashMapçš„æ•°æ®ç»“æ„ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªå“ˆå¸Œå€¼ç´¢å¼•ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼é€šè¿‡æŸ¥è¯¢æœ¬èº«ã€å½“å‰è¦æŸ¥è¯¢çš„æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®ç‰ˆæœ¬å·ç­‰ä¸€äº›å¯èƒ½å½±å“ç»“æœçš„ä¿¡æ¯è®¡ç®—å¾—æ¥ã€‚æ‰€ä»¥ä¸¤ä¸ªæŸ¥è¯¢åœ¨ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒï¼ˆä¾‹å¦‚ï¼šç©ºæ ¼ã€æ³¨é‡Šï¼‰ï¼Œéƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸ä¼šå‘½ä¸­ã€‚</p>
<p>å¦‚æœæŸ¥è¯¢ä¸­åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨å‡½æ•°ã€ç”¨æˆ·å˜é‡ã€ä¸´æ—¶è¡¨ã€MySQLåº“ä¸­çš„ç³»ç»Ÿè¡¨ï¼Œå…¶æŸ¥è¯¢ç»“æœéƒ½ä¸ä¼šè¢«ç¼“å­˜ã€‚æ¯”å¦‚å‡½æ•°NOW()æˆ–è€…CURRENT_DATE()ä¼šå› ä¸ºä¸åŒçš„æŸ¥è¯¢æ—¶é—´ï¼Œè¿”å›ä¸åŒçš„æŸ¥è¯¢ç»“æœï¼Œå†æ¯”å¦‚åŒ…å«CURRENT_USERæˆ–è€…CONNECION_ID()çš„æŸ¥è¯¢è¯­å¥ä¼šå› ä¸ºä¸åŒçš„ç”¨æˆ·è€Œè¿”å›ä¸åŒçš„ç»“æœï¼Œå°†è¿™æ ·çš„æŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥æ²¡æœ‰ä»»ä½•çš„æ„ä¹‰ã€‚</p>
<p>æ—¢ç„¶æ˜¯ç¼“å­˜ï¼Œå°±ä¼šå¤±æ•ˆï¼Œé‚£æŸ¥è¯¢ç¼“å­˜ä½•æ—¶å¤±æ•ˆå‘¢ï¼ŸMySQLçš„æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢ä¸­æ¶‰åŠçš„æ¯ä¸ªè¡¨ï¼Œå¦‚æœè¿™äº›è¡¨ï¼ˆæ•°æ®æˆ–ç»“æ„ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå’Œè¿™å¼ è¡¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜æ•°æ®éƒ½å°†å¤±æ•ˆã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ä»»ä½•çš„å†™æ“ä½œæ—¶ï¼ŒMySQLå¿…é¡»å°†å¯¹åº”è¡¨çš„æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®ä¸ºå¤±æ•ˆã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜éå¸¸å¤§æˆ–è€…ç¢ç‰‡å¾ˆå¤šï¼Œè¿™ä¸ªæ“ä½œå°±å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„ç³»ç»Ÿæ¶ˆè€—ï¼Œç”šè‡³å¯¼è‡´ç³»ç»Ÿåƒµæ­»ä¸€ä¼šå„¿ã€‚è€Œä¸”æŸ¥è¯¢ç¼“å­˜å¯¹ç³»ç»Ÿçš„é¢å¤–æ¶ˆè€—ä¹Ÿä¸ä»…ä»…åœ¨å†™æ“ä½œï¼Œè¯»æ“ä½œä¹Ÿä¸ä¾‹å¤–ï¼š</p>
<ol>
<li>ä»»ä½•çš„æŸ¥è¯¢è¯­å¥åœ¨å¼€å§‹ä¹‹å‰éƒ½å¿…é¡»ç»è¿‡æ£€æŸ¥ï¼Œå³ä½¿è¿™æ¡SQLè¯­å¥æ°¸è¿œä¸ä¼šå‘½ä¸­ç¼“å­˜</li>
<li>å¦‚æœæŸ¥è¯¢ç»“æœå¯ä»¥è¢«ç¼“å­˜ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œæˆåï¼Œä¼šå°†ç»“æœå­˜å…¥ç¼“å­˜ï¼Œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿæ¶ˆè€—</li>
</ol>
<p>åŸºäºæ­¤ï¼Œæˆ‘ä»¬è¦çŸ¥é“å¹¶ä¸æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šæé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œç¼“å­˜å’Œå¤±æ•ˆéƒ½ä¼šå¸¦æ¥é¢å¤–æ¶ˆè€—ï¼Œåªæœ‰å½“ç¼“å­˜å¸¦æ¥çš„èµ„æºèŠ‚çº¦å¤§äºå…¶æœ¬èº«æ¶ˆè€—çš„èµ„æºæ—¶ï¼Œæ‰ä¼šç»™ç³»ç»Ÿå¸¦æ¥æ€§èƒ½æå‡ã€‚ä½†è¦å¦‚ä½•è¯„ä¼°æ‰“å¼€ç¼“å­˜æ˜¯å¦èƒ½å¤Ÿå¸¦æ¥æ€§èƒ½æå‡æ˜¯ä¸€ä»¶éå¸¸å›°éš¾çš„äº‹æƒ…ï¼Œä¹Ÿä¸åœ¨æœ¬æ–‡è®¨è®ºçš„èŒƒç•´å†…ã€‚å¦‚æœç³»ç»Ÿç¡®å®å­˜åœ¨ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶åœ¨æ•°æ®åº“è®¾è®¡ä¸Šåšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>ç”¨å¤šä¸ªå°è¡¨ä»£æ›¿ä¸€ä¸ªå¤§è¡¨ï¼Œæ³¨æ„ä¸è¦è¿‡åº¦è®¾è®¡</li>
<li>æ‰¹é‡æ’å…¥ä»£æ›¿å¾ªç¯å•æ¡æ’å…¥</li>
<li>åˆç†æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å…¶å¤§å°è®¾ç½®ä¸ºå‡ åå…†æ¯”è¾ƒåˆé€‚</li>
<li>å¯ä»¥é€šè¿‡SQL_CACHEå’ŒSQL_NO_CACHEæ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦è¿›è¡Œç¼“å­˜</li>
</ol>
<p>æœ€åçš„å¿ å‘Šæ˜¯ä¸è¦è½»æ˜“æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œç‰¹åˆ«æ˜¯å†™å¯†é›†å‹åº”ç”¨ã€‚å¦‚æœä½ å®åœ¨æ˜¯å¿ä¸ä½ï¼Œå¯ä»¥å°†query_cache_typeè®¾ç½®ä¸ºDEMANDï¼Œè¿™æ—¶åªæœ‰åŠ å…¥SQL_CACHEçš„æŸ¥è¯¢æ‰ä¼šèµ°ç¼“å­˜ï¼Œå…¶ä»–æŸ¥è¯¢åˆ™ä¸ä¼šï¼Œè¿™æ ·å¯ä»¥éå¸¸è‡ªç”±åœ°æ§åˆ¶å“ªäº›æŸ¥è¯¢éœ€è¦è¢«ç¼“å­˜ã€‚</p>
<p>å½“ç„¶æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿæœ¬èº«æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™é‡Œè®¨è®ºçš„ä¹Ÿåªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä»–æ›´æ·±å…¥çš„è¯é¢˜ï¼Œæ¯”å¦‚ï¼šç¼“å­˜æ˜¯å¦‚ä½•ä½¿ç”¨å†…å­˜çš„ï¼Ÿå¦‚ä½•æ§åˆ¶å†…å­˜çš„ç¢ç‰‡åŒ–ï¼Ÿäº‹åŠ¡å¯¹æŸ¥è¯¢ç¼“å­˜æœ‰ä½•å½±å“ç­‰ç­‰ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œæƒå½“æŠ›ç –å¼•ç‰å§ã€‚</p>
<h2 id="è¯­æ³•è§£æå’Œé¢„å¤„ç†"><a href="#è¯­æ³•è§£æå’Œé¢„å¤„ç†" class="headerlink" title="è¯­æ³•è§£æå’Œé¢„å¤„ç†"></a>è¯­æ³•è§£æå’Œé¢„å¤„ç†</h2><p>MySQLé€šè¿‡å…³é”®å­—å°†SQLè¯­å¥è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸€é¢—å¯¹åº”çš„è§£ææ ‘ã€‚è¿™ä¸ªè¿‡ç¨‹è§£æå™¨ä¸»è¦é€šè¿‡è¯­æ³•è§„åˆ™æ¥éªŒè¯å’Œè§£æã€‚æ¯”å¦‚SQLä¸­æ˜¯å¦ä½¿ç”¨äº†é”™è¯¯çš„å…³é”®å­—æˆ–è€…å…³é”®å­—çš„é¡ºåºæ˜¯å¦æ­£ç¡®ç­‰ç­‰ã€‚é¢„å¤„ç†åˆ™ä¼šæ ¹æ®MySQLè§„åˆ™è¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘æ˜¯å¦åˆæ³•ã€‚æ¯”å¦‚æ£€æŸ¥è¦æŸ¥è¯¢çš„æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨ç­‰ã€‚</p>
<h2 id="æŸ¥è¯¢ä¼˜åŒ–"><a href="#æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–"></a>æŸ¥è¯¢ä¼˜åŒ–</h2><p>ç»è¿‡å‰é¢çš„æ­¥éª¤ç”Ÿæˆçš„è¯­æ³•æ ‘è¢«è®¤ä¸ºæ˜¯åˆæ³•çš„äº†ï¼Œå¹¶ä¸”ç”±ä¼˜åŒ–å™¨å°†å…¶è½¬åŒ–æˆæŸ¥è¯¢è®¡åˆ’ã€‚å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸€æ¡æŸ¥è¯¢å¯ä»¥æœ‰å¾ˆå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œæœ€åéƒ½è¿”å›ç›¸åº”çš„ç»“æœã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°è¿™å…¶ä¸­æœ€å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚</p>
<p>MySQLä½¿ç”¨åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ï¼Œå®ƒå°è¯•é¢„æµ‹ä¸€ä¸ªæŸ¥è¯¢ä½¿ç”¨æŸç§æ‰§è¡Œè®¡åˆ’æ—¶çš„æˆæœ¬ï¼Œå¹¶é€‰æ‹©å…¶ä¸­æˆæœ¬æœ€å°çš„ä¸€ä¸ªã€‚åœ¨MySQLå¯ä»¥é€šè¿‡æŸ¥è¯¢å½“å‰ä¼šè¯çš„last_query_costçš„å€¼æ¥å¾—åˆ°å…¶è®¡ç®—å½“å‰æŸ¥è¯¢çš„æˆæœ¬ã€‚<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from t_message limit 10;</div><div class="line">...çœç•¥ç»“æœé›†</div></pre></td></tr></table></figure></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show status like 'last_query_cost';</div><div class="line">+-----------------+-------------+</div><div class="line">| Variable_name   | Value       |</div><div class="line">+-----------------+-------------+</div><div class="line">| Last_query_cost | 6391.799000 |</div><div class="line">+-----------------+-------------+</div></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ä¸­çš„ç»“æœè¡¨ç¤ºä¼˜åŒ–å™¨è®¤ä¸ºå¤§æ¦‚éœ€è¦åš6391ä¸ªæ•°æ®é¡µçš„éšæœºæŸ¥æ‰¾æ‰èƒ½å®Œæˆä¸Šé¢çš„æŸ¥è¯¢ã€‚è¿™ä¸ªç»“æœæ˜¯æ ¹æ®ä¸€äº›åˆ—çš„ç»Ÿè®¡ä¿¡æ¯è®¡ç®—å¾—æ¥çš„ï¼Œè¿™äº›ç»Ÿè®¡ä¿¡æ¯åŒ…æ‹¬ï¼šæ¯å¼ è¡¨æˆ–è€…ç´¢å¼•çš„é¡µé¢ä¸ªæ•°ã€ç´¢å¼•çš„åŸºæ•°ã€ç´¢å¼•å’Œæ•°æ®è¡Œçš„é•¿åº¦ã€ç´¢å¼•çš„åˆ†å¸ƒæƒ…å†µç­‰ç­‰ã€‚</p>
<p>æœ‰éå¸¸å¤šçš„åŸå› ä¼šå¯¼è‡´MySQLé€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ¯”å¦‚ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ã€ä¸ä¼šè€ƒè™‘ä¸å—å…¶æ§åˆ¶çš„æ“ä½œæˆæœ¬ï¼ˆç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹ï¼‰ã€MySQLè®¤ä¸ºçš„æœ€ä¼˜è·Ÿæˆ‘ä»¬æƒ³çš„ä¸ä¸€æ ·ï¼ˆæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œæ—¶é—´å°½å¯èƒ½çŸ­ï¼Œä½†MySQLå€¼é€‰æ‹©å®ƒè®¤ä¸ºæˆæœ¬å°çš„ï¼Œä½†æˆæœ¬å°å¹¶ä¸æ„å‘³ç€æ‰§è¡Œæ—¶é—´çŸ­ï¼‰ç­‰ç­‰ã€‚</p>
<p>MySQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„éƒ¨ä»¶ï¼Œå®ƒä½¿ç”¨äº†éå¸¸å¤šçš„ä¼˜åŒ–ç­–ç•¥æ¥ç”Ÿæˆä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ï¼š</p>
<ul>
<li>é‡æ–°å®šä¹‰è¡¨çš„å…³è”é¡ºåºï¼ˆå¤šå¼ è¡¨å…³è”æŸ¥è¯¢æ—¶ï¼Œå¹¶ä¸ä¸€å®šæŒ‰ç…§SQLä¸­æŒ‡å®šçš„é¡ºåºè¿›è¡Œï¼Œä½†æœ‰ä¸€äº›æŠ€å·§å¯ä»¥æŒ‡å®šå…³è”é¡ºåºï¼‰</li>
<li>ä¼˜åŒ–MIN()å’ŒMAX()å‡½æ•°ï¼ˆæ‰¾æŸåˆ—çš„æœ€å°å€¼ï¼Œå¦‚æœè¯¥åˆ—æœ‰ç´¢å¼•ï¼Œåªéœ€è¦æŸ¥æ‰¾B+Treeç´¢å¼•æœ€å·¦ç«¯ï¼Œåä¹‹åˆ™å¯ä»¥æ‰¾åˆ°æœ€å¤§å€¼ï¼Œå…·ä½“åŸç†è§ä¸‹æ–‡ï¼‰</li>
<li>æå‰ç»ˆæ­¢æŸ¥è¯¢ï¼ˆæ¯”å¦‚ï¼šä½¿ç”¨Limitæ—¶ï¼ŒæŸ¥æ‰¾åˆ°æ»¡è¶³æ•°é‡çš„ç»“æœé›†åä¼šç«‹å³ç»ˆæ­¢æŸ¥è¯¢ï¼‰</li>
<li>ä¼˜åŒ–æ’åºï¼ˆåœ¨è€ç‰ˆæœ¬MySQLä¼šä½¿ç”¨ä¸¤æ¬¡ä¼ è¾“æ’åºï¼Œå³å…ˆè¯»å–è¡ŒæŒ‡é’ˆå’Œéœ€è¦æ’åºçš„å­—æ®µåœ¨å†…å­˜ä¸­å¯¹å…¶æ’åºï¼Œç„¶åå†æ ¹æ®æ’åºç»“æœå»è¯»å–æ•°æ®è¡Œï¼Œè€Œæ–°ç‰ˆæœ¬é‡‡ç”¨çš„æ˜¯å•æ¬¡ä¼ è¾“æ’åºï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡è¯»å–æ‰€æœ‰çš„æ•°æ®è¡Œï¼Œç„¶åæ ¹æ®ç»™å®šçš„åˆ—æ’åºã€‚å¯¹äºI/Oå¯†é›†å‹åº”ç”¨ï¼Œæ•ˆç‡ä¼šé«˜å¾ˆå¤šï¼‰</li>
</ul>
<p>éšç€MySQLçš„ä¸æ–­å‘å±•ï¼Œä¼˜åŒ–å™¨ä½¿ç”¨çš„ä¼˜åŒ–ç­–ç•¥ä¹Ÿåœ¨ä¸æ–­çš„è¿›åŒ–ï¼Œè¿™é‡Œä»…ä»…ä»‹ç»å‡ ä¸ªéå¸¸å¸¸ç”¨ä¸”å®¹æ˜“ç†è§£çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå…¶ä»–çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå¤§å®¶è‡ªè¡ŒæŸ¥é˜…å§ã€‚</p>
<h2 id="æŸ¥è¯¢æ‰§è¡Œå¼•æ“"><a href="#æŸ¥è¯¢æ‰§è¡Œå¼•æ“" class="headerlink" title="æŸ¥è¯¢æ‰§è¡Œå¼•æ“"></a>æŸ¥è¯¢æ‰§è¡Œå¼•æ“</h2><p>åœ¨å®Œæˆè§£æå’Œä¼˜åŒ–é˜¶æ®µä»¥åï¼ŒMySQLä¼šç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥è¯¢æ‰§è¡Œå¼•æ“æ ¹æ®æ‰§è¡Œè®¡åˆ’ç»™å‡ºçš„æŒ‡ä»¤é€æ­¥æ‰§è¡Œå¾—å‡ºç»“æœã€‚æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„å¤§éƒ¨åˆ†æ“ä½œå‡æ˜¯é€šè¿‡è°ƒç”¨å­˜å‚¨å¼•æ“å®ç°çš„æ¥å£æ¥å®Œæˆï¼Œè¿™äº›æ¥å£è¢«ç§°ä¸ºhandler APIã€‚æŸ¥è¯¢è¿‡ç¨‹ä¸­çš„æ¯ä¸€å¼ è¡¨ç”±ä¸€ä¸ªhandlerå®ä¾‹è¡¨ç¤ºã€‚å®é™…ä¸Šï¼ŒMySQLåœ¨æŸ¥è¯¢ä¼˜åŒ–é˜¶æ®µå°±ä¸ºæ¯ä¸€å¼ è¡¨åˆ›å»ºäº†ä¸€ä¸ªhandlerå®ä¾‹ï¼Œä¼˜åŒ–å™¨å¯ä»¥æ ¹æ®è¿™äº›å®ä¾‹çš„æ¥å£æ¥è·å–è¡¨çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨çš„æ‰€æœ‰åˆ—åã€ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚å­˜å‚¨å¼•æ“æ¥å£æä¾›äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ï¼Œä½†å…¶åº•å±‚ä»…æœ‰å‡ åä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£åƒæ­ç§¯æœ¨ä¸€æ ·å®Œæˆäº†ä¸€æ¬¡æŸ¥è¯¢çš„å¤§éƒ¨åˆ†æ“ä½œã€‚</p>
<h2 id="è¿”å›ç»“æœç»™å®¢æˆ·ç«¯"><a href="#è¿”å›ç»“æœç»™å®¢æˆ·ç«¯" class="headerlink" title="è¿”å›ç»“æœç»™å®¢æˆ·ç«¯"></a>è¿”å›ç»“æœç»™å®¢æˆ·ç«¯</h2><p>æŸ¥è¯¢æ‰§è¡Œçš„æœ€åä¸€ä¸ªé˜¶æ®µå°±æ˜¯å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å³ä½¿æŸ¥è¯¢ä¸åˆ°æ•°æ®ï¼ŒMySQLä»ç„¶ä¼šè¿”å›è¿™ä¸ªæŸ¥è¯¢çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚è¯¥æŸ¥è¯¢å½±å“åˆ°çš„è¡Œæ•°ä»¥åŠæ‰§è¡Œæ—¶é—´ç­‰ã€‚</p>
<p>å¦‚æœæŸ¥è¯¢ç¼“å­˜è¢«æ‰“å¼€ä¸”è¿™ä¸ªæŸ¥è¯¢å¯ä»¥è¢«ç¼“å­˜ï¼ŒMySQLä¹Ÿä¼šå°†ç»“æœå­˜æ”¾åˆ°ç¼“å­˜ä¸­ã€‚</p>
<p>ç»“æœé›†è¿”å›å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªå¢é‡ä¸”é€æ­¥è¿”å›çš„è¿‡ç¨‹ã€‚æœ‰å¯èƒ½MySQLåœ¨ç”Ÿæˆç¬¬ä¸€æ¡ç»“æœæ—¶ï¼Œå°±å¼€å§‹å‘å®¢æˆ·ç«¯é€æ­¥è¿”å›ç»“æœé›†äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±æ— é¡»å­˜å‚¨å¤ªå¤šç»“æœè€Œæ¶ˆè€—è¿‡å¤šå†…å­˜ï¼Œä¹Ÿå¯ä»¥è®©å®¢æˆ·ç«¯ç¬¬ä¸€æ—¶é—´è·å¾—è¿”å›ç»“æœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œéƒ½ä¼šä»¥ä¸€ä¸ªæ»¡è¶³â‘ ä¸­æ‰€æè¿°çš„é€šä¿¡åè®®çš„æ•°æ®åŒ…å‘é€ï¼Œå†é€šè¿‡TCPåè®®è¿›è¡Œä¼ è¾“ï¼Œåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¯¹MySQLçš„æ•°æ®åŒ…è¿›è¡Œç¼“å­˜ç„¶åæ‰¹é‡å‘é€ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å›å¤´æ€»ç»“ä¸€ä¸‹MySQLæ•´ä¸ªæŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ï¼Œæ€»çš„æ¥è¯´åˆ†ä¸º6ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯å‘MySQLæœåŠ¡å™¨å‘é€ä¸€æ¡æŸ¥è¯¢è¯·æ±‚</li>
<li>æœåŠ¡å™¨é¦–å…ˆæ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç«‹åˆ»è¿”å›å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„ç»“æœã€‚å¦åˆ™è¿›å…¥ä¸‹ä¸€é˜¶æ®µ</li>
<li>æœåŠ¡å™¨è¿›è¡ŒSQLè§£æã€é¢„å¤„ç†ã€å†ç”±ä¼˜åŒ–å™¨ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’</li>
<li>MySQLæ ¹æ®æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“çš„APIæ¥æ‰§è¡ŒæŸ¥è¯¢</li>
<li>å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ç¼“å­˜æŸ¥è¯¢ç»“æœ</li>
</ul>
<h1 id="æ€§èƒ½ä¼˜åŒ–å»ºè®®"><a href="#æ€§èƒ½ä¼˜åŒ–å»ºè®®" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–å»ºè®®"></a>æ€§èƒ½ä¼˜åŒ–å»ºè®®</h1><p>çœ‹äº†è¿™ä¹ˆå¤šï¼Œä½ å¯èƒ½ä¼šæœŸå¾…ç»™å‡ºä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼Œæ˜¯çš„ï¼Œä¸‹é¢ä¼šä»3ä¸ªä¸åŒæ–¹é¢ç»™å‡ºä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚ä½†è¯·ç­‰ç­‰ï¼Œè¿˜æœ‰ä¸€å¥å¿ å‘Šè¦å…ˆé€ç»™ä½ ï¼šä¸è¦å¬ä¿¡ä½ çœ‹åˆ°çš„å…³äºä¼˜åŒ–çš„â€œç»å¯¹çœŸç†â€ï¼ŒåŒ…æ‹¬æœ¬æ–‡æ‰€è®¨è®ºçš„å†…å®¹ï¼Œè€Œåº”è¯¥æ˜¯åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸‹é€šè¿‡æµ‹è¯•æ¥éªŒè¯ä½ å…³äºæ‰§è¡Œè®¡åˆ’ä»¥åŠå“åº”æ—¶é—´çš„å‡è®¾ã€‚</p>
<h2 id="Schemeè®¾è®¡ä¸æ•°æ®ç±»å‹ä¼˜åŒ–"><a href="#Schemeè®¾è®¡ä¸æ•°æ®ç±»å‹ä¼˜åŒ–" class="headerlink" title="Schemeè®¾è®¡ä¸æ•°æ®ç±»å‹ä¼˜åŒ–"></a>Schemeè®¾è®¡ä¸æ•°æ®ç±»å‹ä¼˜åŒ–</h2><p>é€‰æ‹©æ•°æ®ç±»å‹åªè¦éµå¾ªå°è€Œç®€å•çš„åŸåˆ™å°±å¥½ï¼Œè¶Šå°çš„æ•°æ®ç±»å‹é€šå¸¸ä¼šæ›´å¿«ï¼Œå ç”¨æ›´å°‘çš„ç£ç›˜ã€å†…å­˜ï¼Œå¤„ç†æ—¶éœ€è¦çš„CPUå‘¨æœŸä¹Ÿæ›´å°‘ã€‚è¶Šç®€å•çš„æ•°æ®ç±»å‹åœ¨è®¡ç®—æ—¶éœ€è¦æ›´å°‘çš„CPUå‘¨æœŸï¼Œæ¯”å¦‚ï¼Œæ•´å‹å°±æ¯”å­—ç¬¦æ“ä½œä»£ä»·ä½ï¼Œå› è€Œä¼šä½¿ç”¨æ•´å‹æ¥å­˜å‚¨ipåœ°å€ï¼Œä½¿ç”¨DATETIMEæ¥å­˜å‚¨æ—¶é—´ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ã€‚</p>
<p>è¿™é‡Œæ€»ç»“å‡ ä¸ªå¯èƒ½å®¹æ˜“ç†è§£é”™è¯¯çš„æŠ€å·§ï¼š</p>
<ol>
<li>é€šå¸¸æ¥è¯´æŠŠå¯ä¸ºNULLçš„åˆ—æ”¹ä¸ºNOT NULLä¸ä¼šå¯¹æ€§èƒ½æå‡æœ‰å¤šå°‘å¸®åŠ©ï¼Œåªæ˜¯å¦‚æœè®¡åˆ’åœ¨åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œå°±åº”è¯¥å°†è¯¥åˆ—è®¾ç½®ä¸ºNOT NULLã€‚</li>
<li>å¯¹æ•´æ•°ç±»å‹æŒ‡å®šå®½åº¦ï¼Œæ¯”å¦‚INT(11)ï¼Œæ²¡æœ‰ä»»ä½•åµç”¨ã€‚INTä½¿ç”¨32ä½ï¼ˆ4ä¸ªå­—èŠ‚ï¼‰å­˜å‚¨ç©ºé—´ï¼Œé‚£ä¹ˆå®ƒçš„è¡¨ç¤ºèŒƒå›´å·²ç»ç¡®å®šï¼Œæ‰€ä»¥INT(1)å’ŒINT(20)å¯¹äºå­˜å‚¨å’Œè®¡ç®—æ˜¯ç›¸åŒçš„ã€‚</li>
<li>UNSIGNEDè¡¨ç¤ºä¸å…è®¸è´Ÿå€¼ï¼Œå¤§è‡´å¯ä»¥ä½¿æ­£æ•°çš„ä¸Šé™æé«˜ä¸€å€ã€‚æ¯”å¦‚TINYINTå­˜å‚¨èŒƒå›´æ˜¯-128 ~ 127ï¼Œè€ŒUNSIGNED TINYINTå­˜å‚¨çš„èŒƒå›´å´æ˜¯0 - 255ã€‚</li>
<li>é€šå¸¸æ¥è®²ï¼Œæ²¡æœ‰å¤ªå¤§çš„å¿…è¦ä½¿ç”¨DECIMALæ•°æ®ç±»å‹ã€‚å³ä½¿æ˜¯åœ¨éœ€è¦å­˜å‚¨è´¢åŠ¡æ•°æ®æ—¶ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨BIGINTã€‚æ¯”å¦‚éœ€è¦ç²¾ç¡®åˆ°ä¸‡åˆ†ä¹‹ä¸€ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ•°æ®ä¹˜ä»¥ä¸€ç™¾ä¸‡ç„¶åä½¿ç”¨BIGINTå­˜å‚¨ã€‚è¿™æ ·å¯ä»¥é¿å…æµ®ç‚¹æ•°è®¡ç®—ä¸å‡†ç¡®å’ŒDECIMALç²¾ç¡®è®¡ç®—ä»£ä»·é«˜çš„é—®é¢˜ã€‚</li>
<li>TIMESTAMPä½¿ç”¨4ä¸ªå­—èŠ‚å­˜å‚¨ç©ºé—´ï¼ŒDATETIMEä½¿ç”¨8ä¸ªå­—èŠ‚å­˜å‚¨ç©ºé—´ã€‚å› è€Œï¼ŒTIMESTAMPåªèƒ½è¡¨ç¤º1970 - 2038å¹´ï¼Œæ¯”DATETIMEè¡¨ç¤ºçš„èŒƒå›´å°å¾—å¤šï¼Œè€Œä¸”TIMESTAMPçš„å€¼å› æ—¶åŒºä¸åŒè€Œä¸åŒã€‚</li>
<li>å¤§å¤šæ•°æƒ…å†µä¸‹æ²¡æœ‰ä½¿ç”¨æšä¸¾ç±»å‹çš„å¿…è¦ï¼Œå…¶ä¸­ä¸€ä¸ªç¼ºç‚¹æ˜¯æšä¸¾çš„å­—ç¬¦ä¸²åˆ—è¡¨æ˜¯å›ºå®šçš„ï¼Œæ·»åŠ å’Œåˆ é™¤å­—ç¬¦ä¸²ï¼ˆæšä¸¾é€‰é¡¹ï¼‰å¿…é¡»ä½¿ç”¨ALTER TABLEï¼ˆå¦‚æœåªåªæ˜¯åœ¨åˆ—è¡¨æœ«å°¾è¿½åŠ å…ƒç´ ï¼Œä¸éœ€è¦é‡å»ºè¡¨ï¼‰ã€‚</li>
<li>schemaçš„åˆ—ä¸è¦å¤ªå¤šã€‚åŸå› æ˜¯å­˜å‚¨å¼•æ“çš„APIå·¥ä½œæ—¶éœ€è¦åœ¨æœåŠ¡å™¨å±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¹‹é—´é€šè¿‡è¡Œç¼“å†²æ ¼å¼æ‹·è´æ•°æ®ï¼Œç„¶ååœ¨æœåŠ¡å™¨å±‚å°†ç¼“å†²å†…å®¹è§£ç æˆå„ä¸ªåˆ—ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹çš„ä»£ä»·æ˜¯éå¸¸é«˜çš„ã€‚å¦‚æœåˆ—å¤ªå¤šè€Œå®é™…ä½¿ç”¨çš„åˆ—åˆå¾ˆå°‘çš„è¯ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´CPUå ç”¨è¿‡é«˜ã€‚</li>
<li>å¤§è¡¨ALTER TABLEéå¸¸è€—æ—¶ï¼ŒMySQLæ‰§è¡Œå¤§éƒ¨åˆ†ä¿®æ”¹è¡¨ç»“æœæ“ä½œçš„æ–¹æ³•æ˜¯ç”¨æ–°çš„ç»“æ„åˆ›å»ºä¸€ä¸ªå¼ ç©ºè¡¨ï¼Œä»æ—§è¡¨ä¸­æŸ¥å‡ºæ‰€æœ‰çš„æ•°æ®æ’å…¥æ–°è¡¨ï¼Œç„¶åå†åˆ é™¤æ—§è¡¨ã€‚å°¤å…¶å½“å†…å­˜ä¸è¶³è€Œè¡¨åˆå¾ˆå¤§ï¼Œè€Œä¸”è¿˜æœ‰å¾ˆå¤§ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œè€—æ—¶æ›´ä¹…ã€‚å½“ç„¶æœ‰ä¸€äº›å¥‡æŠ€æ·«å·§å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰å…´è¶£å¯è‡ªè¡ŒæŸ¥é˜…ã€‚</li>
</ol>
<h2 id="åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•"><a href="#åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•" class="headerlink" title="åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•"></a>åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•</h2><p>ç´¢å¼•æ˜¯æé«˜MySQLæŸ¥è¯¢æ€§èƒ½çš„ä¸€ä¸ªé‡è¦é€”å¾„ï¼Œä½†è¿‡å¤šçš„ç´¢å¼•å¯èƒ½ä¼šå¯¼è‡´è¿‡é«˜çš„ç£ç›˜ä½¿ç”¨ç‡ä»¥åŠè¿‡é«˜çš„å†…å­˜å ç”¨ï¼Œä»è€Œå½±å“åº”ç”¨ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚åº”å½“å°½é‡é¿å…äº‹åæ‰æƒ³èµ·æ·»åŠ ç´¢å¼•ï¼Œå› ä¸ºäº‹åå¯èƒ½éœ€è¦ç›‘æ§å¤§é‡çš„SQLæ‰èƒ½å®šä½åˆ°é—®é¢˜æ‰€åœ¨ï¼Œè€Œä¸”æ·»åŠ ç´¢å¼•çš„æ—¶é—´è‚¯å®šæ˜¯è¿œå¤§äºåˆå§‹æ·»åŠ ç´¢å¼•æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå¯è§ç´¢å¼•çš„æ·»åŠ ä¹Ÿæ˜¯éå¸¸æœ‰æŠ€æœ¯å«é‡çš„ã€‚</p>
<p>æ¥ä¸‹æ¥å°†å‘ä½ å±•ç¤ºä¸€ç³»åˆ—åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•çš„ç­–ç•¥ï¼Œä»¥åŠæ¯æ¡ç­–ç•¥å…¶èƒŒåçš„å·¥ä½œåŸç†ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸ç´¢å¼•ç›¸å…³çš„ä¸€äº›ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œå°†æœ‰åŠ©äºæ›´å¥½çš„ç†è§£åæ–‡çš„å†…å®¹ã€‚</p>
<h3 id="ç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„å’Œç®—æ³•"><a href="#ç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„å’Œç®—æ³•" class="headerlink" title="ç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„å’Œç®—æ³•"></a>ç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„å’Œç®—æ³•</h3><p>é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„ç´¢å¼•æ˜¯æŒ‡B-Treeç´¢å¼•ï¼Œå®ƒæ˜¯ç›®å‰å…³ç³»å‹æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®æœ€ä¸ºå¸¸ç”¨å’Œæœ‰æ•ˆçš„ç´¢å¼•ï¼Œå¤§å¤šæ•°å­˜å‚¨å¼•æ“éƒ½æ”¯æŒè¿™ç§ç´¢å¼•ã€‚ä½¿ç”¨B-Treeè¿™ä¸ªæœ¯è¯­ï¼Œæ˜¯å› ä¸ºMySQLåœ¨CREATE TABLEæˆ–å…¶å®ƒè¯­å¥ä¸­ä½¿ç”¨äº†è¿™ä¸ªå…³é”®å­—ï¼Œä½†å®é™…ä¸Šä¸åŒçš„å­˜å‚¨å¼•æ“å¯èƒ½ä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚InnoDBå°±æ˜¯ä½¿ç”¨çš„B+Treeã€‚</p>
<p>B+Treeä¸­çš„Bæ˜¯æŒ‡balanceï¼Œæ„ä¸ºå¹³è¡¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒB+æ ‘ç´¢å¼•å¹¶ä¸èƒ½æ‰¾åˆ°ä¸€ä¸ªç»™å®šé”®å€¼çš„å…·ä½“è¡Œï¼Œå®ƒæ‰¾åˆ°çš„åªæ˜¯è¢«æŸ¥æ‰¾æ•°æ®è¡Œæ‰€åœ¨çš„é¡µï¼Œæ¥ç€æ•°æ®åº“ä¼šæŠŠé¡µè¯»å…¥åˆ°å†…å­˜ï¼Œå†åœ¨å†…å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œæœ€åå¾—åˆ°è¦æŸ¥æ‰¾çš„æ•°æ®ã€‚</p>
<p>åœ¨ä»‹ç»B+Treeå‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œå®ƒæ˜¯ä¸€ç§ç»å…¸çš„æ•°æ®ç»“æ„ï¼Œå…¶å·¦å­æ ‘çš„å€¼æ€»æ˜¯å°äºæ ¹çš„å€¼ï¼Œå³å­æ ‘çš„å€¼æ€»æ˜¯å¤§äºæ ¹çš„å€¼ï¼Œå¦‚ä¸‹å›¾â‘ ã€‚å¦‚æœè¦åœ¨è¿™è¯¾æ ‘ä¸­æŸ¥æ‰¾å€¼ä¸º5çš„è®°å½•ï¼Œå…¶å¤§è‡´æµç¨‹ï¼šå…ˆæ‰¾åˆ°æ ¹ï¼Œå…¶å€¼ä¸º6ï¼Œå¤§äº5ï¼Œæ‰€ä»¥æŸ¥æ‰¾å·¦å­æ ‘ï¼Œæ‰¾åˆ°3ï¼Œè€Œ5å¤§äº3ï¼Œæ¥ç€æ‰¾3çš„å³å­æ ‘ï¼Œæ€»å…±æ‰¾äº†3æ¬¡ã€‚åŒæ ·çš„æ–¹æ³•ï¼Œå¦‚æœæŸ¥æ‰¾å€¼ä¸º8çš„è®°å½•ï¼Œä¹Ÿéœ€è¦æŸ¥æ‰¾3æ¬¡ã€‚æ‰€ä»¥äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ä¸º(3 + 3 + 3 + 2 + 2 + 1) / 6 = 2.3æ¬¡ï¼Œè€Œé¡ºåºæŸ¥æ‰¾çš„è¯ï¼ŒæŸ¥æ‰¾å€¼ä¸º2çš„è®°å½•ï¼Œä»…éœ€è¦1æ¬¡ï¼Œä½†æŸ¥æ‰¾å€¼ä¸º8çš„è®°å½•åˆ™éœ€è¦6æ¬¡ï¼Œæ‰€ä»¥é¡ºåºæŸ¥æ‰¾çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ä¸ºï¼š(1 + 2 + 3 + 4 + 5 + 6) / 6 = 3.3æ¬¡ï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³å‡æŸ¥æ‰¾é€Ÿåº¦æ¯”é¡ºåºæŸ¥æ‰¾è¦å¿«ã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-3.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-3.jpg" alt=""></a></p>
<p>ç”±äºäºŒå‰æŸ¥æ‰¾æ ‘å¯ä»¥ä»»æ„æ„é€ ï¼ŒåŒæ ·çš„å€¼ï¼Œå¯ä»¥æ„é€ å‡ºå¦‚å›¾â‘¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¾ç„¶è¿™æ£µäºŒå‰æ ‘çš„æŸ¥è¯¢æ•ˆç‡å’Œé¡ºåºæŸ¥æ‰¾å·®ä¸å¤šã€‚è‹¥æƒ³äºŒå‰æŸ¥æ‰¾æ•°çš„æŸ¥è¯¢æ€§èƒ½æœ€é«˜ï¼Œéœ€è¦è¿™æ£µäºŒå‰æŸ¥æ‰¾æ ‘æ˜¯å¹³è¡¡çš„ï¼Œä¹Ÿå³å¹³è¡¡äºŒå‰æ ‘ï¼ˆAVLæ ‘ï¼‰ã€‚</p>
<p>å¹³è¡¡äºŒå‰æ ‘é¦–å…ˆéœ€è¦ç¬¦åˆäºŒå‰æŸ¥æ‰¾æ ‘çš„å®šä¹‰ï¼Œå…¶æ¬¡å¿…é¡»æ»¡è¶³ä»»ä½•èŠ‚ç‚¹çš„ä¸¤ä¸ªå­æ ‘çš„é«˜åº¦å·®ä¸èƒ½å¤§äº1ã€‚æ˜¾ç„¶å›¾â‘¡ä¸æ»¡è¶³å¹³è¡¡äºŒå‰æ ‘çš„å®šä¹‰ï¼Œè€Œå›¾â‘ æ˜¯ä¸€è¯¾å¹³è¡¡äºŒå‰æ ‘ã€‚å¹³è¡¡äºŒå‰æ ‘çš„æŸ¥æ‰¾æ€§èƒ½æ˜¯æ¯”è¾ƒé«˜çš„ï¼ˆæ€§èƒ½æœ€å¥½çš„æ˜¯æœ€ä¼˜äºŒå‰æ ‘ï¼‰ï¼ŒæŸ¥è¯¢æ€§èƒ½è¶Šå¥½ï¼Œç»´æŠ¤çš„æˆæœ¬å°±è¶Šå¤§ã€‚æ¯”å¦‚å›¾â‘ çš„å¹³è¡¡äºŒå‰æ ‘ï¼Œå½“ç”¨æˆ·éœ€è¦æ’å…¥ä¸€ä¸ªæ–°çš„å€¼9çš„èŠ‚ç‚¹æ—¶ï¼Œå°±éœ€è¦åšå‡ºå¦‚ä¸‹å˜åŠ¨ã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-4.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-4.jpg" alt=""></a></p>
<p>é€šè¿‡ä¸€æ¬¡å·¦æ—‹æ“ä½œå°±å°†æ’å…¥åçš„æ ‘é‡æ–°å˜ä¸ºå¹³è¡¡äºŒå‰æ ‘æ˜¯æœ€ç®€å•çš„æƒ…å†µäº†ï¼Œå®é™…åº”ç”¨åœºæ™¯ä¸­å¯èƒ½éœ€è¦æ—‹è½¬å¤šæ¬¡ã€‚è‡³æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¹³è¡¡äºŒå‰æ ‘çš„æŸ¥æ‰¾æ•ˆç‡è¿˜ä¸é”™ï¼Œå®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œç›¸åº”çš„ç»´æŠ¤æˆæœ¬è¿˜èƒ½æ¥å—ï¼Œä¸ºä»€ä¹ˆMySQLç´¢å¼•ä¸ç›´æ¥ä½¿ç”¨å¹³è¡¡äºŒå‰æ ‘ï¼Ÿ</p>
<p>éšç€æ•°æ®åº“ä¸­æ•°æ®çš„å¢åŠ ï¼Œç´¢å¼•æœ¬èº«å¤§å°éšä¹‹å¢åŠ ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ç£ç›˜ä¸Šã€‚è¿™æ ·çš„è¯ï¼Œç´¢å¼•æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¦äº§ç”Ÿç£ç›˜I/Oæ¶ˆè€—ï¼Œç›¸å¯¹äºå†…å­˜å­˜å–ï¼ŒI/Oå­˜å–çš„æ¶ˆè€—è¦é«˜å‡ ä¸ªæ•°é‡çº§ã€‚å¯ä»¥æƒ³è±¡ä¸€ä¸‹ä¸€æ£µå‡ ç™¾ä¸‡èŠ‚ç‚¹çš„äºŒå‰æ ‘çš„æ·±åº¦æ˜¯å¤šå°‘ï¼Ÿå¦‚æœå°†è¿™ä¹ˆå¤§æ·±åº¦çš„ä¸€é¢—äºŒå‰æ ‘æ”¾ç£ç›˜ä¸Šï¼Œæ¯è¯»å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦ä¸€æ¬¡ç£ç›˜çš„I/Oè¯»å–ï¼Œæ•´ä¸ªæŸ¥æ‰¾çš„è€—æ—¶æ˜¾ç„¶æ˜¯ä¸èƒ½å¤Ÿæ¥å—çš„ã€‚é‚£ä¹ˆå¦‚ä½•å‡å°‘æŸ¥æ‰¾è¿‡ç¨‹ä¸­çš„I/Oå­˜å–æ¬¡æ•°ï¼Ÿ</p>
<p>ä¸€ç§è¡Œä¹‹æœ‰æ•ˆçš„è§£å†³æ–¹æ³•æ˜¯å‡å°‘æ ‘çš„æ·±åº¦ï¼Œå°†äºŒå‰æ ‘å˜ä¸ºmå‰æ ‘ï¼ˆå¤šè·¯æœç´¢æ ‘ï¼‰ï¼Œè€ŒB+Treeå°±æ˜¯ä¸€ç§å¤šè·¯æœç´¢æ ‘ã€‚ç†è§£B+Treeæ—¶ï¼Œåªéœ€è¦ç†è§£å…¶æœ€é‡è¦çš„ä¸¤ä¸ªç‰¹å¾å³å¯ï¼šç¬¬ä¸€ï¼Œæ‰€æœ‰çš„å…³é”®å­—ï¼ˆå¯ä»¥ç†è§£ä¸ºæ•°æ®ï¼‰éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼ˆLeaf Pageï¼‰ï¼Œéå¶å­èŠ‚ç‚¹ï¼ˆIndex Pageï¼‰å¹¶ä¸å­˜å‚¨çœŸæ­£çš„æ•°æ®ï¼Œæ‰€æœ‰è®°å½•èŠ‚ç‚¹éƒ½æ˜¯æŒ‰é”®å€¼å¤§å°é¡ºåºå­˜æ”¾åœ¨åŒä¸€å±‚å¶å­èŠ‚ç‚¹ä¸Šã€‚å…¶æ¬¡ï¼Œæ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ç”±æŒ‡é’ˆè¿æ¥ã€‚å¦‚ä¸‹å›¾ä¸ºé«˜åº¦ä¸º2çš„ç®€åŒ–äº†çš„B+Treeã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-5.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-5.jpg" alt=""></a></p>
<p>æ€ä¹ˆç†è§£è¿™ä¸¤ä¸ªç‰¹å¾ï¼ŸMySQLå°†æ¯ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ç½®ä¸ºä¸€ä¸ªé¡µçš„æ•´æ•°å€ï¼ˆåŸå› ä¸‹æ–‡ä¼šä»‹ç»ï¼‰ï¼Œä¹Ÿå°±æ˜¯åœ¨èŠ‚ç‚¹ç©ºé—´å¤§å°ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨æ›´å¤šçš„å†…ç»“ç‚¹ï¼Œè¿™æ ·æ¯ä¸ªç»“ç‚¹èƒ½ç´¢å¼•çš„èŒƒå›´æ›´å¤§æ›´ç²¾ç¡®ã€‚æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ä½¿ç”¨æŒ‡é’ˆé“¾æ¥çš„å¥½å¤„æ˜¯å¯ä»¥è¿›è¡ŒåŒºé—´è®¿é—®ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­ï¼Œå¦‚æœæŸ¥æ‰¾å¤§äº20è€Œå°äº30çš„è®°å½•ï¼Œåªéœ€è¦æ‰¾åˆ°èŠ‚ç‚¹20ï¼Œå°±å¯ä»¥éå†æŒ‡é’ˆä¾æ¬¡æ‰¾åˆ°25ã€30ã€‚å¦‚æœæ²¡æœ‰é“¾æ¥æŒ‡é’ˆçš„è¯ï¼Œå°±æ— æ³•è¿›è¡ŒåŒºé—´æŸ¥æ‰¾ã€‚è¿™ä¹Ÿæ˜¯MySQLä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•å­˜å‚¨ç»“æ„çš„é‡è¦åŸå› ã€‚</p>
<p>MySQLä¸ºä½•å°†èŠ‚ç‚¹å¤§å°è®¾ç½®ä¸ºé¡µçš„æ•´æ•°å€ï¼Œè¿™å°±éœ€è¦ç†è§£ç£ç›˜çš„å­˜å‚¨åŸç†ã€‚ç£ç›˜æœ¬èº«å­˜å–å°±æ¯”ä¸»å­˜æ…¢å¾ˆå¤šï¼Œåœ¨åŠ ä¸Šæœºæ¢°è¿åŠ¨æŸè€—ï¼ˆç‰¹åˆ«æ˜¯æ™®é€šçš„æœºæ¢°ç¡¬ç›˜ï¼‰ï¼Œç£ç›˜çš„å­˜å–é€Ÿåº¦å¾€å¾€æ˜¯ä¸»å­˜çš„å‡ ç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼Œä¸ºäº†å°½é‡å‡å°‘ç£ç›˜I/Oï¼Œç£ç›˜å¾€å¾€ä¸æ˜¯ä¸¥æ ¼æŒ‰éœ€è¯»å–ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šé¢„è¯»ï¼Œå³ä½¿åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œç£ç›˜ä¹Ÿä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹ï¼Œé¡ºåºå‘åè¯»å–ä¸€å®šé•¿åº¦çš„æ•°æ®æ”¾å…¥å†…å­˜ï¼Œé¢„è¯»çš„é•¿åº¦ä¸€èˆ¬ä¸ºé¡µçš„æ•´æ•°å€ã€‚</p>
<p>â€œé¡µæ˜¯è®¡ç®—æœºç®¡ç†å­˜å‚¨å™¨çš„é€»è¾‘å—ï¼Œç¡¬ä»¶åŠOSå¾€å¾€å°†ä¸»å­˜å’Œç£ç›˜å­˜å‚¨åŒºåˆ†å‰²ä¸ºè¿ç»­çš„å¤§å°ç›¸ç­‰çš„å—ï¼Œæ¯ä¸ªå­˜å‚¨å—ç§°ä¸ºä¸€é¡µï¼ˆè®¸å¤šOSä¸­ï¼Œé¡µçš„å¤§å°é€šå¸¸ä¸º4Kï¼‰ã€‚ä¸»å­˜å’Œç£ç›˜ä»¥é¡µä¸ºå•ä½äº¤æ¢æ•°æ®ã€‚å½“ç¨‹åºè¦è¯»å–çš„æ•°æ®ä¸åœ¨ä¸»å­˜ä¸­æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šå‘ç£ç›˜å‘å‡ºè¯»ç›˜ä¿¡å·ï¼Œç£ç›˜ä¼šæ‰¾åˆ°æ•°æ®çš„èµ·å§‹ä½ç½®å¹¶å‘åè¿ç»­è¯»å–ä¸€é¡µæˆ–å‡ é¡µè½½å…¥å†…å­˜ä¸­ï¼Œç„¶åä¸€èµ·è¿”å›ï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚â€</p>
<p>MySQLå·§å¦™åˆ©ç”¨äº†ç£ç›˜é¢„è¯»åŸç†ï¼Œå°†ä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ä¸ºç­‰äºä¸€ä¸ªé¡µï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦ä¸€æ¬¡I/Oå°±å¯ä»¥å®Œå…¨è½½å…¥ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæ¯æ¬¡æ–°å»ºèŠ‚ç‚¹æ—¶ï¼Œç›´æ¥ç”³è¯·ä¸€ä¸ªé¡µçš„ç©ºé—´ï¼Œè¿™æ ·å°±ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ç‰©ç†ä¸Šä¹Ÿå­˜å‚¨åœ¨ä¸€ä¸ªé¡µé‡Œï¼ŒåŠ ä¹‹è®¡ç®—æœºå­˜å‚¨åˆ†é…éƒ½æ˜¯æŒ‰é¡µå¯¹é½çš„ï¼Œå°±å®ç°äº†è¯»å–ä¸€ä¸ªèŠ‚ç‚¹åªéœ€ä¸€æ¬¡I/Oã€‚å‡è®¾B+Treeçš„é«˜åº¦ä¸ºhï¼Œä¸€æ¬¡æ£€ç´¢æœ€å¤šéœ€è¦h-1I/Oï¼ˆæ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜ï¼‰ï¼Œå¤æ‚åº¦$O(h) = O(log_{M}N)$ã€‚å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼ŒMé€šå¸¸è¾ƒå¤§ï¼Œå¸¸å¸¸è¶…è¿‡100ï¼Œå› æ­¤æ ‘çš„é«˜åº¦ä¸€èˆ¬éƒ½æ¯”è¾ƒå°ï¼Œé€šå¸¸ä¸è¶…è¿‡3ã€‚</p>
<p>æœ€åç®€å•äº†è§£ä¸‹B+TreeèŠ‚ç‚¹çš„æ“ä½œï¼Œåœ¨æ•´ä½“ä¸Šå¯¹ç´¢å¼•çš„ç»´æŠ¤æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œè™½ç„¶ç´¢å¼•å¯ä»¥å¤§å¤§æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œä½†ç»´æŠ¤ç´¢å¼•ä»è¦èŠ±è´¹å¾ˆå¤§çš„ä»£ä»·ï¼Œå› æ­¤åˆç†çš„åˆ›å»ºç´¢å¼•ä¹Ÿå°±å°¤ä¸ºé‡è¦ã€‚</p>
<p>ä»ä»¥ä¸Šé¢çš„æ ‘ä¸ºä¾‹ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨4ä¸ªå†…èŠ‚ç‚¹ã€‚é¦–å…ˆè¦æ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹28ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-6.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-6.jpg" alt=""></a><br>æ¥ç€æ’å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹70ï¼Œåœ¨Index Pageä¸­æŸ¥è¯¢åå¾—çŸ¥åº”è¯¥æ’å…¥åˆ°50 - 70ä¹‹é—´çš„å¶å­èŠ‚ç‚¹ï¼Œä½†å¶å­èŠ‚ç‚¹å·²æ»¡ï¼Œè¿™æ—¶å€™å°±éœ€è¦è¿›è¡Œä¹Ÿåˆ†è£‚çš„æ“ä½œï¼Œå½“å‰çš„å¶å­èŠ‚ç‚¹èµ·ç‚¹ä¸º50ï¼Œæ‰€ä»¥æ ¹æ®ä¸­é—´å€¼æ¥æ‹†åˆ†å¶å­èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-7.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-7.jpg" alt=""></a><br>æœ€åæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹95ï¼Œè¿™æ—¶å€™Index Pageå’ŒLeaf Pageéƒ½æ»¡äº†ï¼Œå°±éœ€è¦åšä¸¤æ¬¡æ‹†åˆ†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-8.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-8.jpg" alt=""></a><br>æ‹†åˆ†åæœ€ç»ˆå½¢æˆäº†è¿™æ ·ä¸€é¢—æ ‘ã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-9.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-9.jpg" alt=""></a><br>B+Treeä¸ºäº†ä¿æŒå¹³è¡¡ï¼Œå¯¹äºæ–°æ’å…¥çš„å€¼éœ€è¦åšå¤§é‡çš„æ‹†åˆ†é¡µæ“ä½œï¼Œè€Œé¡µçš„æ‹†åˆ†éœ€è¦I/Oæ“ä½œï¼Œä¸ºäº†å°½å¯èƒ½çš„å‡å°‘é¡µçš„æ‹†åˆ†æ“ä½œï¼ŒB+Treeä¹Ÿæä¾›äº†ç±»ä¼¼äºå¹³è¡¡äºŒå‰æ ‘çš„æ—‹è½¬åŠŸèƒ½ã€‚å½“Leaf Pageå·²æ»¡ä½†å…¶å·¦å³å…„å¼ŸèŠ‚ç‚¹æ²¡æœ‰æ»¡çš„æƒ…å†µä¸‹ï¼ŒB+Treeå¹¶ä¸æ€¥äºå»åšæ‹†åˆ†æ“ä½œï¼Œè€Œæ˜¯å°†è®°å½•ç§»åˆ°å½“å‰æ‰€åœ¨é¡µçš„å…„å¼ŸèŠ‚ç‚¹ä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå·¦å…„å¼Ÿä¼šè¢«å…ˆæ£€æŸ¥ç”¨æ¥åšæ—‹è½¬æ“ä½œã€‚å°±æ¯”å¦‚ä¸Šé¢ç¬¬äºŒä¸ªç¤ºä¾‹ï¼Œå½“æ’å…¥70çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šå»åšé¡µæ‹†åˆ†ï¼Œè€Œæ˜¯å·¦æ—‹æ“ä½œã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-10.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-10.jpg" alt=""></a></p>
<p>é€šè¿‡æ—‹è½¬æ“ä½œå¯ä»¥æœ€å¤§é™åº¦çš„å‡å°‘é¡µåˆ†è£‚ï¼Œä»è€Œå‡å°‘ç´¢å¼•ç»´æŠ¤è¿‡ç¨‹ä¸­çš„ç£ç›˜çš„I/Oæ“ä½œï¼Œä¹Ÿæé«˜ç´¢å¼•ç»´æŠ¤æ•ˆç‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ é™¤èŠ‚ç‚¹è·Ÿæ’å…¥èŠ‚ç‚¹ç±»ä¼¼ï¼Œä»ç„¶éœ€è¦æ—‹è½¬å’Œæ‹†åˆ†æ“ä½œï¼Œè¿™é‡Œå°±ä¸å†è¯´æ˜ã€‚</p>
<h3 id="é«˜æ€§èƒ½ç­–ç•¥"><a href="#é«˜æ€§èƒ½ç­–ç•¥" class="headerlink" title="é«˜æ€§èƒ½ç­–ç•¥"></a>é«˜æ€§èƒ½ç­–ç•¥</h3><p>é€šè¿‡ä¸Šæ–‡ï¼Œç›¸ä¿¡ä½ å¯¹B+Treeçš„æ•°æ®ç»“æ„å·²ç»æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œä½†MySQLä¸­ç´¢å¼•æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®çš„å­˜å‚¨å‘¢ï¼Ÿä»¥ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œå‡å¦‚æœ‰å¦‚ä¸‹æ•°æ®è¡¨ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> People(</div><div class="line">last_name <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line">first_name <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line">dob <span class="built_in">date</span> <span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line">gender enum(<span class="string">`m`</span>,<span class="string">`f`</span>) <span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line"><span class="keyword">key</span>(last_name,first_name,dob)</div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>å¯¹äºè¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®ï¼Œç´¢å¼•ä¸­åŒ…å«äº†last_nameã€first_nameã€dobåˆ—çš„å€¼ï¼Œä¸‹å›¾å±•ç¤ºäº†ç´¢å¼•æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨çš„ã€‚<br><a href="http://idiotsky.me/images1/mysql-optimization-mechanism-11.jpg"><img src="http://idiotsky.me/images1/mysql-optimization-mechanism-11.jpg" alt=""></a></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•é¦–å…ˆæ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ¥æ’åˆ—é¡ºåºï¼Œå½“åå­—ç›¸åŒæ—¶ï¼Œåˆ™æ ¹æ®ç¬¬ä¸‰ä¸ªå­—æ®µï¼Œå³å‡ºç”Ÿæ—¥æœŸæ¥æ’åºï¼Œæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæ‰æœ‰äº†ç´¢å¼•çš„â€œæœ€å·¦åŸåˆ™â€ã€‚</p>
<h4 id="MySQLä¸ä¼šä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼šéç‹¬ç«‹çš„åˆ—"><a href="#MySQLä¸ä¼šä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼šéç‹¬ç«‹çš„åˆ—" class="headerlink" title="MySQLä¸ä¼šä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼šéç‹¬ç«‹çš„åˆ—"></a>MySQLä¸ä¼šä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼šéç‹¬ç«‹çš„åˆ—</h4><p>â€œç‹¬ç«‹çš„åˆ—â€æ˜¯æŒ‡ç´¢å¼•åˆ—ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸èƒ½æ˜¯å‡½æ•°çš„å‚æ•°ã€‚æ¯”å¦‚ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">where</span> <span class="keyword">id</span> + <span class="number">1</span> = <span class="number">5</span></div></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºå…¶ç­‰ä»·äº id = 4ï¼Œä½†æ˜¯MySQLæ— æ³•è‡ªåŠ¨è§£æè¿™ä¸ªè¡¨è¾¾å¼ï¼Œä½¿ç”¨å‡½æ•°æ˜¯åŒæ ·çš„é“ç†ã€‚</p>
<h4 id="å‰ç¼€ç´¢å¼•"><a href="#å‰ç¼€ç´¢å¼•" class="headerlink" title="å‰ç¼€ç´¢å¼•"></a>å‰ç¼€ç´¢å¼•</h4><p>å¦‚æœåˆ—å¾ˆé•¿ï¼Œé€šå¸¸å¯ä»¥ç´¢å¼•å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆèŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œä»è€Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚</p>
<h4 id="å¤šåˆ—ç´¢å¼•å’Œç´¢å¼•é¡ºåº"><a href="#å¤šåˆ—ç´¢å¼•å’Œç´¢å¼•é¡ºåº" class="headerlink" title="å¤šåˆ—ç´¢å¼•å’Œç´¢å¼•é¡ºåº"></a>å¤šåˆ—ç´¢å¼•å’Œç´¢å¼•é¡ºåº</h4><p>åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨å¤šä¸ªåˆ—ä¸Šå»ºç«‹ç‹¬ç«‹çš„ç´¢å¼•å¹¶ä¸èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚ç†ç”±éå¸¸ç®€å•ï¼ŒMySQLä¸çŸ¥é“é€‰æ‹©å“ªä¸ªç´¢å¼•çš„æŸ¥è¯¢æ•ˆç‡æ›´å¥½ï¼Œæ‰€ä»¥åœ¨è€ç‰ˆæœ¬ï¼Œæ¯”å¦‚MySQL5.0ä¹‹å‰å°±ä¼šéšä¾¿é€‰æ‹©ä¸€ä¸ªåˆ—çš„ç´¢å¼•ï¼Œè€Œæ–°çš„ç‰ˆæœ¬ä¼šé‡‡ç”¨åˆå¹¶ç´¢å¼•çš„ç­–ç•¥ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸€å¼ ç”µå½±æ¼”å‘˜è¡¨ä¸­ï¼Œåœ¨actor_idå’Œfilm_idä¸¤ä¸ªåˆ—ä¸Šéƒ½å»ºç«‹äº†ç‹¬ç«‹çš„ç´¢å¼•ï¼Œç„¶åæœ‰å¦‚ä¸‹æŸ¥è¯¢ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> film_id,actor_id <span class="keyword">from</span> film_actor <span class="keyword">where</span> actor_id = <span class="number">1</span> <span class="keyword">or</span> film_id = <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>è€ç‰ˆæœ¬çš„MySQLä¼šéšæœºé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼Œä½†æ–°ç‰ˆæœ¬åšå¦‚ä¸‹çš„ä¼˜åŒ–ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> film_id,actor_id <span class="keyword">from</span> film_actor <span class="keyword">where</span> actor_id = <span class="number">1</span></div><div class="line"><span class="keyword">union</span> all</div><div class="line"><span class="keyword">select</span> film_id,actor_id <span class="keyword">from</span> film_actor <span class="keyword">where</span> film_id = <span class="number">1</span> <span class="keyword">and</span> actor_id &lt;&gt; <span class="number">1</span></div></pre></td></tr></table></figure></p>
<ul>
<li>å½“å‡ºç°å¤šä¸ªç´¢å¼•åšç›¸äº¤æ“ä½œæ—¶ï¼ˆå¤šä¸ªANDæ¡ä»¶ï¼‰ï¼Œé€šå¸¸æ¥è¯´ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³åˆ—çš„ç´¢å¼•è¦ä¼˜äºå¤šä¸ªç‹¬ç«‹ç´¢å¼•ã€‚</li>
<li>å½“å‡ºç°å¤šä¸ªç´¢å¼•åšè”åˆæ“ä½œæ—¶ï¼ˆå¤šä¸ªORæ¡ä»¶ï¼‰ï¼Œå¯¹ç»“æœé›†çš„åˆå¹¶ã€æ’åºç­‰æ“ä½œéœ€è¦è€—è´¹å¤§é‡çš„CPUå’Œå†…å­˜èµ„æºï¼Œç‰¹åˆ«æ˜¯å½“å…¶ä¸­çš„æŸäº›ç´¢å¼•çš„é€‰æ‹©æ€§ä¸é«˜ï¼Œéœ€è¦è¿”å›åˆå¹¶å¤§é‡æ•°æ®æ—¶ï¼ŒæŸ¥è¯¢æˆæœ¬æ›´é«˜ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¿˜ä¸å¦‚èµ°å…¨è¡¨æ‰«æã€‚</li>
</ul>
<p>å› æ­¤explainæ—¶å¦‚æœå‘ç°æœ‰ç´¢å¼•åˆå¹¶ï¼ˆExtraå­—æ®µå‡ºç°Using unionï¼‰ï¼Œåº”è¯¥å¥½å¥½æ£€æŸ¥ä¸€ä¸‹æŸ¥è¯¢å’Œè¡¨ç»“æ„æ˜¯ä¸æ˜¯å·²ç»æ˜¯æœ€ä¼˜çš„ï¼Œå¦‚æœæŸ¥è¯¢å’Œè¡¨éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé‚£åªèƒ½è¯´æ˜ç´¢å¼•å»ºçš„éå¸¸ç³Ÿç³•ï¼Œåº”å½“æ…é‡è€ƒè™‘ç´¢å¼•æ˜¯å¦åˆé€‚ï¼Œæœ‰å¯èƒ½ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³åˆ—çš„å¤šåˆ—ç´¢å¼•æ›´é€‚åˆã€‚</p>
<p>å‰é¢æˆ‘ä»¬æåˆ°è¿‡ç´¢å¼•å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨çš„ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°å¤šåˆ—ç´¢å¼•æ—¶ï¼Œç´¢å¼•çš„é¡ºåºå¯¹äºæŸ¥è¯¢æ˜¯è‡³å…³é‡è¦çš„ï¼Œå¾ˆæ˜æ˜¾åº”è¯¥æŠŠé€‰æ‹©æ€§æ›´é«˜çš„å­—æ®µæ”¾åˆ°ç´¢å¼•çš„å‰é¢ï¼Œè¿™æ ·é€šè¿‡ç¬¬ä¸€ä¸ªå­—æ®µå°±å¯ä»¥è¿‡æ»¤æ‰å¤§å¤šæ•°ä¸ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚</p>
<p>ç´¢å¼•é€‰æ‹©æ€§æ˜¯æŒ‡ä¸é‡å¤çš„ç´¢å¼•å€¼å’Œæ•°æ®è¡¨çš„æ€»è®°å½•æ•°çš„æ¯”å€¼ï¼Œé€‰æ‹©æ€§è¶Šé«˜æŸ¥è¯¢æ•ˆç‡è¶Šé«˜ï¼Œå› ä¸ºé€‰æ‹©æ€§è¶Šé«˜çš„ç´¢å¼•å¯ä»¥è®©MySQLåœ¨æŸ¥è¯¢æ—¶è¿‡æ»¤æ‰æ›´å¤šçš„è¡Œã€‚å”¯ä¸€ç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯1ï¼Œè¿™æ—¶æœ€å¥½çš„ç´¢å¼•é€‰æ‹©æ€§ï¼Œæ€§èƒ½ä¹Ÿæ˜¯æœ€å¥½çš„ã€‚</p>
<p>ç†è§£ç´¢å¼•é€‰æ‹©æ€§çš„æ¦‚å¿µåï¼Œå°±ä¸éš¾ç¡®å®šå“ªä¸ªå­—æ®µçš„é€‰æ‹©æ€§è¾ƒé«˜äº†ï¼ŒæŸ¥ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œæ¯”å¦‚ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> payment <span class="keyword">where</span> staff_id = <span class="number">2</span> <span class="keyword">and</span> customer_id = <span class="number">584</span></div></pre></td></tr></table></figure></p>
<p>æ˜¯åº”è¯¥åˆ›å»º(staff_id,customer_id)çš„ç´¢å¼•è¿˜æ˜¯åº”è¯¥é¢ å€’ä¸€ä¸‹é¡ºåºï¼Ÿæ‰§è¡Œä¸‹é¢çš„æŸ¥è¯¢ï¼Œå“ªä¸ªå­—æ®µçš„é€‰æ‹©æ€§æ›´æ¥è¿‘1å°±æŠŠå“ªä¸ªå­—æ®µç´¢å¼•å‰é¢å°±å¥½ã€‚<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> staff_id)/<span class="keyword">count</span>(*) <span class="keyword">as</span> staff_id_selectivity,</div><div class="line"><span class="keyword">count</span>(<span class="keyword">distinct</span> customer_id)/<span class="keyword">count</span>(*) <span class="keyword">as</span> customer_id_selectivity,</div><div class="line"><span class="keyword">count</span>(*) <span class="keyword">from</span> payment</div></pre></td></tr></table></figure></p>
<p>å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨è¿™ä¸ªåŸåˆ™æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†ä»ç„¶æ³¨æ„ä½ çš„æ•°æ®ä¸­æ˜¯å¦å­˜åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚è¦æŸ¥è¯¢æŸä¸ªç”¨æˆ·ç»„ä¸‹æœ‰è¿‡äº¤æ˜“çš„ç”¨æˆ·ä¿¡æ¯ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> user_id <span class="keyword">from</span> trade <span class="keyword">where</span> user_group_id = <span class="number">1</span> <span class="keyword">and</span> trade_amount &gt; <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>MySQLä¸ºè¿™ä¸ªæŸ¥è¯¢é€‰æ‹©äº†ç´¢å¼•(user_group_id,trade_amount)ï¼Œå¦‚æœä¸è€ƒè™‘ç‰¹æ®Šæƒ…å†µï¼Œè¿™çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†å®é™…æƒ…å†µæ˜¯è¿™å¼ è¡¨çš„å¤§å¤šæ•°æ•°æ®éƒ½æ˜¯ä»è€ç³»ç»Ÿä¸­è¿ç§»è¿‡æ¥çš„ï¼Œç”±äºæ–°è€ç³»ç»Ÿçš„æ•°æ®ä¸å…¼å®¹ï¼Œæ‰€ä»¥å°±ç»™è€ç³»ç»Ÿè¿ç§»è¿‡æ¥çš„æ•°æ®èµ‹äºˆäº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·ç»„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡ç´¢å¼•æ‰«æçš„è¡Œæ•°è·Ÿå…¨è¡¨æ‰«æåŸºæœ¬æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œç´¢å¼•ä¹Ÿå°±èµ·ä¸åˆ°ä»»ä½•ä½œç”¨ã€‚</p>
<p>æ¨å¹¿å¼€æ¥è¯´ï¼Œç»éªŒæ³•åˆ™å’Œæ¨è®ºåœ¨å¤šæ•°æƒ…å†µä¸‹æ˜¯æœ‰ç”¨çš„ï¼Œå¯ä»¥æŒ‡å¯¼æˆ‘ä»¬å¼€å‘å’Œè®¾è®¡ï¼Œä½†å®é™…æƒ…å†µå¾€å¾€ä¼šæ›´å¤æ‚ï¼Œå®é™…ä¸šåŠ¡åœºæ™¯ä¸‹çš„æŸäº›ç‰¹æ®Šæƒ…å†µå¯èƒ½ä¼šæ‘§æ¯ä½ çš„æ•´ä¸ªè®¾è®¡ã€‚</p>
<h4 id="é¿å…å¤šä¸ªèŒƒå›´æ¡ä»¶"><a href="#é¿å…å¤šä¸ªèŒƒå›´æ¡ä»¶" class="headerlink" title="é¿å…å¤šä¸ªèŒƒå›´æ¡ä»¶"></a>é¿å…å¤šä¸ªèŒƒå›´æ¡ä»¶</h4><p>å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ä½¿ç”¨å¤šä¸ªèŒƒå›´æ¡ä»¶ï¼Œæ¯”å¦‚æƒ³æŸ¥è¯¢æŸä¸ªæ—¶é—´æ®µå†…ç™»å½•è¿‡çš„ç”¨æˆ·ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> user.* <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> login_time &gt; <span class="string">'2017-04-01'</span> <span class="keyword">and</span> age <span class="keyword">between</span> <span class="number">18</span> <span class="keyword">and</span> <span class="number">30</span>;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæŸ¥è¯¢æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå®ƒæœ‰ä¸¤ä¸ªèŒƒå›´æ¡ä»¶ï¼Œlogin_timeåˆ—å’Œageåˆ—ï¼ŒMySQLå¯ä»¥ä½¿ç”¨login_timeåˆ—çš„ç´¢å¼•æˆ–è€…ageåˆ—çš„ç´¢å¼•ï¼Œä½†æ— æ³•åŒæ—¶ä½¿ç”¨å®ƒä»¬ã€‚</p>
<h4 id="è¦†ç›–ç´¢å¼•"><a href="#è¦†ç›–ç´¢å¼•" class="headerlink" title="è¦†ç›–ç´¢å¼•"></a>è¦†ç›–ç´¢å¼•</h4><p>å¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«æˆ–è€…è¯´è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¿…è¦å†å›è¡¨æŸ¥è¯¢ï¼Œè¿™å°±ç§°ä¸ºè¦†ç›–ç´¢å¼•ã€‚è¦†ç›–ç´¢å¼•æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥æå¤§çš„æé«˜æ€§èƒ½ï¼Œå› ä¸ºæŸ¥è¯¢åªéœ€è¦æ‰«æç´¢å¼•ä¼šå¸¦æ¥è®¸å¤šå¥½å¤„ï¼š</p>
<ul>
<li>ç´¢å¼•æ¡ç›®è¿œå°äºæ•°æ®è¡Œå¤§å°ï¼Œå¦‚æœåªè¯»å–ç´¢å¼•ï¼Œæå¤§å‡å°‘æ•°æ®è®¿é—®é‡</li>
<li>ç´¢å¼•æ˜¯æœ‰æŒ‰ç…§åˆ—å€¼é¡ºåºå­˜å‚¨çš„ï¼Œå¯¹äºI/Oå¯†é›†å‹çš„èŒƒå›´æŸ¥è¯¢è¦æ¯”éšæœºä»ç£ç›˜è¯»å–æ¯ä¸€è¡Œæ•°æ®çš„IOè¦å°‘çš„å¤š</li>
</ul>
<h4 id="ä½¿ç”¨ç´¢å¼•æ‰«ææ¥æ’åº"><a href="#ä½¿ç”¨ç´¢å¼•æ‰«ææ¥æ’åº" class="headerlink" title="ä½¿ç”¨ç´¢å¼•æ‰«ææ¥æ’åº"></a>ä½¿ç”¨ç´¢å¼•æ‰«ææ¥æ’åº</h4><p>MySQLæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ç”Ÿäº§æœ‰åºçš„ç»“æœé›†ï¼Œå…¶ä¸€æ˜¯å¯¹ç»“æœé›†è¿›è¡Œæ’åºçš„æ“ä½œï¼Œå…¶äºŒæ˜¯æŒ‰ç…§ç´¢å¼•é¡ºåºæ‰«æå¾—å‡ºçš„ç»“æœè‡ªç„¶æ˜¯æœ‰åºçš„ã€‚å¦‚æœexplainçš„ç»“æœä¸­typeåˆ—çš„å€¼ä¸ºindexè¡¨ç¤ºä½¿ç”¨äº†ç´¢å¼•æ‰«ææ¥åšæ’åºã€‚</p>
<p>æ‰«æç´¢å¼•æœ¬èº«å¾ˆå¿«ï¼Œå› ä¸ºåªéœ€è¦ä»ä¸€æ¡ç´¢å¼•è®°å½•ç§»åŠ¨åˆ°ç›¸é‚»çš„ä¸‹ä¸€æ¡è®°å½•ã€‚ä½†å¦‚æœç´¢å¼•æœ¬èº«ä¸èƒ½è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„åˆ—ï¼Œé‚£ä¹ˆå°±ä¸å¾—ä¸æ¯æ‰«æä¸€æ¡ç´¢å¼•è®°å½•å°±å›è¡¨æŸ¥è¯¢ä¸€æ¬¡å¯¹åº”çš„è¡Œã€‚è¿™ä¸ªè¯»å–æ“ä½œåŸºæœ¬ä¸Šæ˜¯éšæœºI/Oï¼Œå› æ­¤æŒ‰ç…§ç´¢å¼•é¡ºåºè¯»å–æ•°æ®çš„é€Ÿåº¦é€šå¸¸è¦æ¯”é¡ºåºåœ°å…¨è¡¨æ‰«æè¦æ…¢ã€‚</p>
<p>åœ¨è®¾è®¡ç´¢å¼•æ—¶ï¼Œå¦‚æœä¸€ä¸ªç´¢å¼•æ—¢èƒ½å¤Ÿæ»¡è¶³æ’åºï¼Œåˆæ»¡è¶³æŸ¥è¯¢ï¼Œæ˜¯æœ€å¥½çš„ã€‚</p>
<p>åªæœ‰å½“ç´¢å¼•çš„åˆ—é¡ºåºå’ŒORDER BYå­å¥çš„é¡ºåºå®Œå…¨ä¸€è‡´ï¼Œå¹¶ä¸”æ‰€æœ‰åˆ—çš„æ’åºæ–¹å‘ä¹Ÿä¸€æ ·æ—¶ï¼Œæ‰èƒ½å¤Ÿä½¿ç”¨ç´¢å¼•æ¥å¯¹ç»“æœåšæ’åºã€‚å¦‚æœæŸ¥è¯¢éœ€è¦å…³è”å¤šå¼ è¡¨ï¼Œåˆ™åªæœ‰ORDER BYå­å¥å¼•ç”¨çš„å­—æ®µå…¨éƒ¨ä¸ºç¬¬ä¸€å¼ è¡¨æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨ç´¢å¼•åšæ’åºã€‚ORDER BYå­å¥å’ŒæŸ¥è¯¢çš„é™åˆ¶æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¦æ»¡è¶³æœ€å·¦å‰ç¼€çš„è¦æ±‚ï¼ˆæœ‰ä¸€ç§æƒ…å†µä¾‹å¤–ï¼Œå°±æ˜¯æœ€å·¦çš„åˆ—è¢«æŒ‡å®šä¸ºå¸¸æ•°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼‰ï¼Œå…¶å®ƒæƒ…å†µä¸‹éƒ½éœ€è¦æ‰§è¡Œæ’åºæ“ä½œï¼Œè€Œæ— æ³•åˆ©ç”¨ç´¢å¼•æ’åºã€‚<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- æœ€å·¦åˆ—ä¸ºå¸¸æ•°ï¼Œç´¢å¼•ï¼š(date,staff_id,customer_id)</span></div><div class="line"><span class="keyword">select</span> staff_id,customer_id <span class="keyword">from</span> demo <span class="keyword">where</span> <span class="built_in">date</span> = <span class="string">'2015-06-01'</span> <span class="keyword">order</span> <span class="keyword">by</span> staff_id,customer_id</div></pre></td></tr></table></figure></p>
<h4 id="å†—ä½™å’Œé‡å¤ç´¢å¼•"><a href="#å†—ä½™å’Œé‡å¤ç´¢å¼•" class="headerlink" title="å†—ä½™å’Œé‡å¤ç´¢å¼•"></a>å†—ä½™å’Œé‡å¤ç´¢å¼•</h4><p>å†—ä½™ç´¢å¼•æ˜¯æŒ‡åœ¨ç›¸åŒçš„åˆ—ä¸ŠæŒ‰ç…§ç›¸åŒçš„é¡ºåºåˆ›å»ºçš„ç›¸åŒç±»å‹çš„ç´¢å¼•ï¼Œåº”å½“å°½é‡é¿å…è¿™ç§ç´¢å¼•ï¼Œå‘ç°åç«‹å³åˆ é™¤ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªç´¢å¼•(A,B)ï¼Œå†åˆ›å»ºç´¢å¼•(A)å°±æ˜¯å†—ä½™ç´¢å¼•ã€‚å†—ä½™ç´¢å¼•ç»å¸¸å‘ç”Ÿåœ¨ä¸ºè¡¨æ·»åŠ æ–°ç´¢å¼•æ—¶ï¼Œæ¯”å¦‚æœ‰äººæ–°å»ºäº†ç´¢å¼•(A,B)ï¼Œä½†è¿™ä¸ªç´¢å¼•ä¸æ˜¯æ‰©å±•å·²æœ‰çš„ç´¢å¼•(A)ã€‚</p>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½åº”è¯¥å°½é‡æ‰©å±•å·²æœ‰çš„ç´¢å¼•è€Œä¸æ˜¯åˆ›å»ºæ–°ç´¢å¼•ã€‚ä½†æœ‰æå°‘æƒ…å†µä¸‹å‡ºç°æ€§èƒ½æ–¹é¢çš„è€ƒè™‘éœ€è¦å†—ä½™ç´¢å¼•ï¼Œæ¯”å¦‚æ‰©å±•å·²æœ‰ç´¢å¼•è€Œå¯¼è‡´å…¶å˜å¾—è¿‡å¤§ï¼Œä»è€Œå½±å“åˆ°å…¶ä»–ä½¿ç”¨è¯¥ç´¢å¼•çš„æŸ¥è¯¢ã€‚</p>
<h4 id="åˆ é™¤é•¿æœŸæœªä½¿ç”¨çš„ç´¢å¼•"><a href="#åˆ é™¤é•¿æœŸæœªä½¿ç”¨çš„ç´¢å¼•" class="headerlink" title="åˆ é™¤é•¿æœŸæœªä½¿ç”¨çš„ç´¢å¼•"></a>åˆ é™¤é•¿æœŸæœªä½¿ç”¨çš„ç´¢å¼•</h4><p>å®šæœŸåˆ é™¤ä¸€äº›é•¿æ—¶é—´æœªä½¿ç”¨è¿‡çš„ç´¢å¼•æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ã€‚</p>
<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å…³äºç´¢å¼•è¿™ä¸ªè¯é¢˜æ‰“ç®—å°±æ­¤æ‰“ä½ï¼Œæœ€åè¦è¯´ä¸€å¥ï¼Œç´¢å¼•å¹¶ä¸æ€»æ˜¯æœ€å¥½çš„å·¥å…·ï¼Œåªæœ‰å½“ç´¢å¼•å¸®åŠ©æé«˜æŸ¥è¯¢é€Ÿåº¦å¸¦æ¥çš„å¥½å¤„å¤§äºå…¶å¸¦æ¥çš„é¢å¤–å·¥ä½œæ—¶ï¼Œç´¢å¼•æ‰æ˜¯æœ‰æ•ˆçš„ã€‚å¯¹äºéå¸¸å°çš„è¡¨ï¼Œç®€å•çš„å…¨è¡¨æ‰«ææ›´é«˜æ•ˆã€‚å¯¹äºä¸­åˆ°å¤§å‹çš„è¡¨ï¼Œç´¢å¼•å°±éå¸¸æœ‰æ•ˆã€‚å¯¹äºè¶…å¤§å‹çš„è¡¨ï¼Œå»ºç«‹å’Œç»´æŠ¤ç´¢å¼•çš„ä»£ä»·éšä¹‹å¢é•¿ï¼Œè¿™æ—¶å€™å…¶ä»–æŠ€æœ¯ä¹Ÿè®¸æ›´æœ‰æ•ˆï¼Œæ¯”å¦‚åˆ†åŒºè¡¨ã€‚æœ€åçš„æœ€åï¼Œexplainåå†ææµ‹æ˜¯ä¸€ç§ç¾å¾·ã€‚</p>
<h2 id="ç‰¹å®šç±»å‹æŸ¥è¯¢ä¼˜åŒ–"><a href="#ç‰¹å®šç±»å‹æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="ç‰¹å®šç±»å‹æŸ¥è¯¢ä¼˜åŒ–"></a>ç‰¹å®šç±»å‹æŸ¥è¯¢ä¼˜åŒ–</h2><h3 id="ä¼˜åŒ–COUNT-æŸ¥è¯¢"><a href="#ä¼˜åŒ–COUNT-æŸ¥è¯¢" class="headerlink" title="ä¼˜åŒ–COUNT()æŸ¥è¯¢"></a>ä¼˜åŒ–COUNT()æŸ¥è¯¢</h3><p>COUNT()å¯èƒ½æ˜¯è¢«å¤§å®¶è¯¯è§£æœ€å¤šçš„å‡½æ•°äº†ï¼Œå®ƒæœ‰ä¸¤ç§ä¸åŒçš„ä½œç”¨ï¼Œå…¶ä¸€æ˜¯ç»Ÿè®¡æŸä¸ªåˆ—å€¼çš„æ•°é‡ï¼Œå…¶äºŒæ˜¯ç»Ÿè®¡è¡Œæ•°ã€‚ç»Ÿè®¡åˆ—å€¼æ—¶ï¼Œè¦æ±‚åˆ—å€¼æ˜¯éç©ºçš„ï¼Œå®ƒä¸ä¼šç»Ÿè®¡NULLã€‚å¦‚æœç¡®è®¤æ‹¬å·ä¸­çš„è¡¨è¾¾å¼ä¸å¯èƒ½ä¸ºç©ºæ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨ç»Ÿè®¡è¡Œæ•°ã€‚æœ€ç®€å•çš„å°±æ˜¯å½“ä½¿ç”¨COUNT(*)æ—¶ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€æƒ³è±¡çš„é‚£æ ·æ‰©å±•æˆæ‰€æœ‰çš„åˆ—ï¼Œå®é™…ä¸Šï¼Œå®ƒä¼šå¿½ç•¥æ‰€æœ‰çš„åˆ—è€Œç›´æ¥ç»Ÿè®¡æ‰€æœ‰çš„è¡Œæ•°ã€‚</p>
<p>æˆ‘ä»¬æœ€å¸¸è§çš„è¯¯è§£ä¹Ÿå°±åœ¨è¿™å„¿ï¼Œåœ¨æ‹¬å·å†…æŒ‡å®šäº†ä¸€åˆ—å´å¸Œæœ›ç»Ÿè®¡ç»“æœæ˜¯è¡Œæ•°ï¼Œè€Œä¸”è¿˜å¸¸å¸¸è¯¯ä»¥ä¸ºå‰è€…çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚ä½†å®é™…å¹¶éè¿™æ ·ï¼Œå¦‚æœè¦ç»Ÿè®¡è¡Œæ•°ï¼Œç›´æ¥ä½¿ç”¨COUNT(*)ï¼Œæ„ä¹‰æ¸…æ™°ï¼Œä¸”æ€§èƒ½æ›´å¥½ã€‚</p>
<p>æœ‰æ—¶å€™æŸäº›ä¸šåŠ¡åœºæ™¯å¹¶ä¸éœ€è¦å®Œå…¨ç²¾ç¡®çš„COUNTå€¼ï¼Œå¯ä»¥ç”¨è¿‘ä¼¼å€¼æ¥ä»£æ›¿ï¼ŒEXPLAINå‡ºæ¥çš„è¡Œæ•°å°±æ˜¯ä¸€ä¸ªä¸é”™çš„è¿‘ä¼¼å€¼ï¼Œè€Œä¸”æ‰§è¡ŒEXPLAINå¹¶ä¸éœ€è¦çœŸæ­£åœ°å»æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ‰€ä»¥æˆæœ¬éå¸¸ä½ã€‚é€šå¸¸æ¥è¯´ï¼Œæ‰§è¡ŒCOUNT()éƒ½éœ€è¦æ‰«æå¤§é‡çš„è¡Œæ‰èƒ½è·å–åˆ°ç²¾ç¡®çš„æ•°æ®ï¼Œå› æ­¤å¾ˆéš¾ä¼˜åŒ–ï¼ŒMySQLå±‚é¢è¿˜èƒ½åšå¾—ä¹Ÿå°±åªæœ‰è¦†ç›–ç´¢å¼•äº†ã€‚å¦‚æœä¸è¿˜èƒ½è§£å†³é—®é¢˜ï¼Œåªæœ‰ä»æ¶æ„å±‚é¢è§£å†³äº†ï¼Œæ¯”å¦‚æ·»åŠ æ±‡æ€»è¡¨ï¼Œæˆ–è€…ä½¿ç”¨redisè¿™æ ·çš„å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿã€‚</p>
<h3 id="ä¼˜åŒ–å…³è”æŸ¥è¯¢"><a href="#ä¼˜åŒ–å…³è”æŸ¥è¯¢" class="headerlink" title="ä¼˜åŒ–å…³è”æŸ¥è¯¢"></a>ä¼˜åŒ–å…³è”æŸ¥è¯¢</h3><p>åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œè¡¨ä¸è¡¨ä¹‹é—´é€šè¿‡ä¸€ä¸ªå†—ä½™å­—æ®µæ¥å…³è”ï¼Œè¦æ¯”ç›´æ¥ä½¿ç”¨JOINæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚å¦‚æœç¡®å®éœ€è¦ä½¿ç”¨å…³è”æŸ¥è¯¢çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š</p>
<ol>
<li>ç¡®ä¿ONå’ŒUSINGå­—å¥ä¸­çš„åˆ—ä¸Šæœ‰ç´¢å¼•ã€‚åœ¨åˆ›å»ºç´¢å¼•çš„æ—¶å€™å°±è¦è€ƒè™‘åˆ°å…³è”çš„é¡ºåºã€‚å½“è¡¨Aå’Œè¡¨Bç”¨åˆ—cå…³è”çš„æ—¶å€™ï¼Œå¦‚æœä¼˜åŒ–å™¨å…³è”çš„é¡ºåºæ˜¯Aã€Bï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åœ¨Aè¡¨çš„å¯¹åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•ã€‚æ²¡æœ‰ç”¨åˆ°çš„ç´¢å¼•ä¼šå¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé™¤éæœ‰å…¶ä»–ç†ç”±ï¼Œåªéœ€è¦åœ¨å…³è”é¡ºåºä¸­çš„ç¬¬äºŒå¼ è¡¨çš„ç›¸åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆå…·ä½“åŸå› ä¸‹æ–‡åˆ†æï¼‰ã€‚</li>
<li>ç¡®ä¿ä»»ä½•çš„GROUP BYå’ŒORDER BYä¸­çš„è¡¨è¾¾å¼åªæ¶‰åŠåˆ°ä¸€ä¸ªè¡¨ä¸­çš„åˆ—ï¼Œè¿™æ ·MySQLæ‰æœ‰å¯èƒ½ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–ã€‚</li>
</ol>
<p>è¦ç†è§£ä¼˜åŒ–å…³è”æŸ¥è¯¢çš„ç¬¬ä¸€ä¸ªæŠ€å·§ï¼Œå°±éœ€è¦ç†è§£MySQLæ˜¯å¦‚ä½•æ‰§è¡Œå…³è”æŸ¥è¯¢çš„ã€‚å½“å‰MySQLå…³è”æ‰§è¡Œçš„ç­–ç•¥éå¸¸ç®€å•ï¼Œå®ƒå¯¹ä»»ä½•çš„å…³è”éƒ½æ‰§è¡ŒåµŒå¥—å¾ªç¯å…³è”æ“ä½œï¼Œå³å…ˆåœ¨ä¸€ä¸ªè¡¨ä¸­å¾ªç¯å–å‡ºå•æ¡æ•°æ®ï¼Œç„¶ååœ¨åµŒå¥—å¾ªç¯åˆ°ä¸‹ä¸€ä¸ªè¡¨ä¸­å¯»æ‰¾åŒ¹é…çš„è¡Œï¼Œä¾æ¬¡ä¸‹å»ï¼Œç›´åˆ°æ‰¾åˆ°æ‰€æœ‰è¡¨ä¸­åŒ¹é…çš„è¡Œä¸ºä¸ºæ­¢ã€‚ç„¶åæ ¹æ®å„ä¸ªè¡¨åŒ¹é…çš„è¡Œï¼Œè¿”å›æŸ¥è¯¢ä¸­éœ€è¦çš„å„ä¸ªåˆ—ã€‚</p>
<p>å¤ªæŠ½è±¡äº†ï¼Ÿä»¥ä¸Šé¢çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œæ¯”å¦‚æœ‰è¿™æ ·çš„ä¸€ä¸ªæŸ¥è¯¢ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> A.xx,B.yy</div><div class="line"><span class="keyword">FROM</span> A <span class="keyword">INNER</span> <span class="keyword">JOIN</span> B <span class="keyword">USING</span>(c)</div><div class="line"><span class="keyword">WHERE</span> A.xx <span class="keyword">IN</span> (<span class="number">5</span>,<span class="number">6</span>)</div></pre></td></tr></table></figure></p>
<p>å‡è®¾MySQLæŒ‰ç…§æŸ¥è¯¢ä¸­çš„å…³è”é¡ºåºAã€Bæ¥è¿›è¡Œå…³è”æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ä¸‹é¢çš„ä¼ªä»£ç è¡¨ç¤ºMySQLå¦‚ä½•å®Œæˆè¿™ä¸ªæŸ¥è¯¢ï¼š<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">outer_iterator = SELECT A.xx,A.c FROM A WHERE A.xx IN (5,6);</div><div class="line">outer_row = outer_iterator.next;</div><div class="line">while(outer_row) &#123;</div><div class="line">    inner_iterator = SELECT B.yy FROM B WHERE B.c = outer_row.c;</div><div class="line">    inner_row = inner_iterator.next;</div><div class="line">    while(inner_row) &#123;</div><div class="line">        output[inner_row.yy,outer_row.xx];</div><div class="line">        inner_row = inner_iterator.next;</div><div class="line">    &#125;</div><div class="line">    outer_row = outer_iterator.next;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€å¤–å±‚çš„æŸ¥è¯¢æ˜¯æ ¹æ®A.xxåˆ—æ¥æŸ¥è¯¢çš„ï¼ŒA.cä¸Šå¦‚æœæœ‰ç´¢å¼•çš„è¯ï¼Œæ•´ä¸ªå…³è”æŸ¥è¯¢ä¹Ÿä¸ä¼šä½¿ç”¨ã€‚å†çœ‹å†…å±‚çš„æŸ¥è¯¢ï¼Œå¾ˆæ˜æ˜¾B.cä¸Šå¦‚æœæœ‰ç´¢å¼•çš„è¯ï¼Œèƒ½å¤ŸåŠ é€ŸæŸ¥è¯¢ï¼Œå› æ­¤åªéœ€è¦åœ¨å…³è”é¡ºåºä¸­çš„ç¬¬äºŒå¼ è¡¨çš„ç›¸åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•å³å¯ã€‚</p>
<h3 id="ä¼˜åŒ–LIMITåˆ†é¡µ"><a href="#ä¼˜åŒ–LIMITåˆ†é¡µ" class="headerlink" title="ä¼˜åŒ–LIMITåˆ†é¡µ"></a>ä¼˜åŒ–LIMITåˆ†é¡µ</h3><p>å½“éœ€è¦åˆ†é¡µæ“ä½œæ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨LIMITåŠ ä¸Šåç§»é‡çš„åŠæ³•å®ç°ï¼ŒåŒæ—¶åŠ ä¸Šåˆé€‚çš„ORDER BYå­—å¥ã€‚å¦‚æœæœ‰å¯¹åº”çš„ç´¢å¼•ï¼Œé€šå¸¸æ•ˆç‡ä¼šä¸é”™ï¼Œå¦åˆ™ï¼ŒMySQLéœ€è¦åšå¤§é‡çš„æ–‡ä»¶æ’åºæ“ä½œã€‚</p>
<p>ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯å½“åç§»é‡éå¸¸å¤§çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼šLIMIT 10000 20è¿™æ ·çš„æŸ¥è¯¢ï¼ŒMySQLéœ€è¦æŸ¥è¯¢10020æ¡è®°å½•ç„¶ååªè¿”å›20æ¡è®°å½•ï¼Œå‰é¢çš„10000æ¡éƒ½å°†è¢«æŠ›å¼ƒï¼Œè¿™æ ·çš„ä»£ä»·éå¸¸é«˜ã€‚</p>
<p>ä¼˜åŒ–è¿™ç§æŸ¥è¯¢ä¸€ä¸ªæœ€ç®€å•çš„åŠæ³•å°±æ˜¯å°½å¯èƒ½çš„ä½¿ç”¨è¦†ç›–ç´¢å¼•æ‰«æï¼Œè€Œä¸æ˜¯æŸ¥è¯¢æ‰€æœ‰çš„åˆ—ã€‚ç„¶åæ ¹æ®éœ€è¦åšä¸€æ¬¡å…³è”æŸ¥è¯¢å†è¿”å›æ‰€æœ‰çš„åˆ—ã€‚å¯¹äºåç§»é‡å¾ˆå¤§æ—¶ï¼Œè¿™æ ·åšçš„æ•ˆç‡ä¼šæå‡éå¸¸å¤§ã€‚è€ƒè™‘ä¸‹é¢çš„æŸ¥è¯¢ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> film_id,description <span class="keyword">FROM</span> film <span class="keyword">ORDER</span> <span class="keyword">BY</span> title <span class="keyword">LIMIT</span> <span class="number">50</span>,<span class="number">5</span>;</div></pre></td></tr></table></figure></p>
<p>å¦‚æœè¿™å¼ è¡¨éå¸¸å¤§ï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢æœ€å¥½æ”¹æˆä¸‹é¢çš„æ ·å­ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> film.film_id,film.description</div><div class="line"><span class="keyword">FROM</span> film <span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</div><div class="line"><span class="keyword">SELECT</span> film_id <span class="keyword">FROM</span> film <span class="keyword">ORDER</span> <span class="keyword">BY</span> title <span class="keyword">LIMIT</span> <span class="number">50</span>,<span class="number">5</span></div><div class="line">) <span class="keyword">AS</span> tmp <span class="keyword">USING</span>(film_id);</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„å»¶è¿Ÿå…³è”å°†å¤§å¤§æå‡æŸ¥è¯¢æ•ˆç‡ï¼Œè®©MySQLæ‰«æå°½å¯èƒ½å°‘çš„é¡µé¢ï¼Œè·å–éœ€è¦è®¿é—®çš„è®°å½•ååœ¨æ ¹æ®å…³è”åˆ—å›åŸè¡¨æŸ¥è¯¢æ‰€éœ€è¦çš„åˆ—ã€‚</p>
<p>æœ‰æ—¶å€™å¦‚æœå¯ä»¥ä½¿ç”¨ä¹¦ç­¾è®°å½•ä¸Šæ¬¡å–æ•°æ®çš„ä½ç½®ï¼Œé‚£ä¹ˆä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥ä»è¯¥ä¹¦ç­¾è®°å½•çš„ä½ç½®å¼€å§‹æ‰«æï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ä½¿ç”¨OFFSETï¼Œæ¯”å¦‚ä¸‹é¢çš„æŸ¥è¯¢ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> t <span class="keyword">LIMIT</span> <span class="number">10000</span>, <span class="number">10</span>;</div></pre></td></tr></table></figure></p>
<p>æ”¹ä¸ºï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">10000</span> <span class="keyword">LIMIT</span> <span class="number">10</span>;</div></pre></td></tr></table></figure></p>
<p>å…¶å®ƒä¼˜åŒ–çš„åŠæ³•è¿˜åŒ…æ‹¬ä½¿ç”¨é¢„å…ˆè®¡ç®—çš„æ±‡æ€»è¡¨ï¼Œæˆ–è€…å…³è”åˆ°ä¸€ä¸ªå†—ä½™è¡¨ï¼Œå†—ä½™è¡¨ä¸­åªåŒ…å«ä¸»é”®åˆ—å’Œéœ€è¦åšæ’åºçš„åˆ—ã€‚</p>
<h3 id="ä¼˜åŒ–UNION"><a href="#ä¼˜åŒ–UNION" class="headerlink" title="ä¼˜åŒ–UNION"></a>ä¼˜åŒ–UNION</h3><p>MySQLå¤„ç†UNIONçš„ç­–ç•¥æ˜¯å…ˆåˆ›å»ºä¸´æ—¶è¡¨ï¼Œç„¶åå†æŠŠå„ä¸ªæŸ¥è¯¢ç»“æœæ’å…¥åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œæœ€åå†æ¥åšæŸ¥è¯¢ã€‚å› æ­¤å¾ˆå¤šä¼˜åŒ–ç­–ç•¥åœ¨UNIONæŸ¥è¯¢ä¸­éƒ½æ²¡æœ‰åŠæ³•å¾ˆå¥½çš„æ—¶å€™ã€‚ç»å¸¸éœ€è¦æ‰‹åŠ¨å°†WHEREã€LIMITã€ORDER BYç­‰å­—å¥â€œä¸‹æ¨â€åˆ°å„ä¸ªå­æŸ¥è¯¢ä¸­ï¼Œä»¥ä¾¿ä¼˜åŒ–å™¨å¯ä»¥å……åˆ†åˆ©ç”¨è¿™äº›æ¡ä»¶å…ˆä¼˜åŒ–ã€‚</p>
<p>é™¤éç¡®å®éœ€è¦æœåŠ¡å™¨å»é‡ï¼Œå¦åˆ™å°±ä¸€å®šè¦ä½¿ç”¨UNION ALLï¼Œå¦‚æœæ²¡æœ‰ALLå…³é”®å­—ï¼ŒMySQLä¼šç»™ä¸´æ—¶è¡¨åŠ ä¸ŠDISTINCTé€‰é¡¹ï¼Œè¿™ä¼šå¯¼è‡´æ•´ä¸ªä¸´æ—¶è¡¨çš„æ•°æ®åšå”¯ä¸€æ€§æ£€æŸ¥ï¼Œè¿™æ ·åšçš„ä»£ä»·éå¸¸é«˜ã€‚å½“ç„¶å³ä½¿ä½¿ç”¨ALLå…³é”®å­—ï¼ŒMySQLæ€»æ˜¯å°†ç»“æœæ”¾å…¥ä¸´æ—¶è¡¨ï¼Œç„¶åå†è¯»å‡ºï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è™½ç„¶å¾ˆå¤šæ—¶å€™æ²¡æœ‰è¿™ä¸ªå¿…è¦ï¼Œæ¯”å¦‚æœ‰æ—¶å€™å¯ä»¥ç›´æ¥æŠŠæ¯ä¸ªå­æŸ¥è¯¢çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>ç†è§£æŸ¥è¯¢æ˜¯å¦‚ä½•æ‰§è¡Œä»¥åŠæ—¶é—´éƒ½æ¶ˆè€—åœ¨å“ªäº›åœ°æ–¹ï¼Œå†åŠ ä¸Šä¸€äº›ä¼˜åŒ–è¿‡ç¨‹çš„çŸ¥è¯†ï¼Œå¯ä»¥å¸®åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£MySQLï¼Œç†è§£å¸¸è§ä¼˜åŒ–æŠ€å·§èƒŒåçš„åŸç†ã€‚å¸Œæœ›æœ¬æ–‡ä¸­çš„åŸç†ã€ç¤ºä¾‹èƒ½å¤Ÿå¸®åŠ©å¤§å®¶æ›´å¥½çš„å°†ç†è®ºå’Œå®è·µè”ç³»èµ·æ¥ï¼Œæ›´å¤šçš„å°†ç†è®ºçŸ¥è¯†è¿ç”¨åˆ°å®è·µä¸­ã€‚</p>
<p>å…¶ä»–ä¹Ÿæ²¡å•¥è¯´çš„äº†ï¼Œç»™å¤§å®¶ç•™ä¸¤ä¸ªæ€è€ƒé¢˜å§ï¼Œå¯ä»¥åœ¨è„‘è¢‹é‡Œæƒ³æƒ³ç­”æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯å¤§å®¶ç»å¸¸æŒ‚åœ¨å˜´è¾¹çš„ï¼Œä½†å¾ˆå°‘æœ‰äººä¼šæ€è€ƒä¸ºä»€ä¹ˆï¼Ÿ</p>
<ol>
<li>æœ‰éå¸¸å¤šçš„ç¨‹åºå‘˜åœ¨åˆ†äº«æ—¶éƒ½ä¼šæŠ›å‡ºè¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼šå°½å¯èƒ½ä¸è¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨è¿‡ç¨‹éå¸¸ä¸å®¹æ˜“ç»´æŠ¤ï¼Œä¹Ÿä¼šå¢åŠ ä½¿ç”¨æˆæœ¬ï¼Œåº”è¯¥æŠŠä¸šåŠ¡é€»è¾‘æ”¾åˆ°å®¢æˆ·ç«¯ã€‚æ—¢ç„¶å®¢æˆ·ç«¯éƒ½èƒ½å¹²è¿™äº›äº‹ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å­˜å‚¨è¿‡ç¨‹ï¼Ÿ</li>
<li>JOINæœ¬èº«ä¹ŸæŒºæ–¹ä¾¿çš„ï¼Œç›´æ¥æŸ¥è¯¢å°±å¥½äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è§†å›¾å‘¢ï¼Ÿ</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¯´èµ·MySQLçš„æŸ¥è¯¢ä¼˜åŒ–ï¼Œç›¸ä¿¡å¤§å®¶æ”¶è—äº†ä¸€å †å¥‡æŠ€æ·«å·§ï¼šä¸èƒ½ä½¿ç”¨SELECT *ã€ä¸ä½¿ç”¨NULLå­—æ®µã€åˆç†åˆ›å»ºç´¢å¼•ã€ä¸ºå­—æ®µé€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹â€¦.. ä½ æ˜¯å¦çœŸçš„ç†è§£è¿™äº›ä¼˜åŒ–æŠ€å·§ï¼Ÿæ˜¯å¦ç†è§£å…¶èƒŒåçš„å·¥ä½œåŸç†ï¼Ÿåœ¨å®é™…åœºæ™¯ä¸‹æ€§èƒ½çœŸæœ‰æå‡å—ï¼Ÿæˆ‘æƒ³æœªå¿…ã€‚å› è€Œç†è§£è¿™äº›ä¼˜åŒ–å»ºè®®èƒŒåçš„åŸç†å°±å°¤ä¸ºé‡è¦ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ é‡æ–°å®¡è§†è¿™äº›ä¼˜åŒ–å»ºè®®ï¼Œå¹¶åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸‹åˆç†çš„è¿ç”¨ã€‚&lt;/p&gt;
&lt;h1 id=&quot;MySQLé€»è¾‘æ¶æ„&quot;&gt;&lt;a href=&quot;#MySQLé€»è¾‘æ¶æ„&quot; class=&quot;headerlink&quot; title=&quot;MySQLé€»è¾‘æ¶æ„&quot;&gt;&lt;/a&gt;MySQLé€»è¾‘æ¶æ„&lt;/h1&gt;&lt;p&gt;å¦‚æœèƒ½åœ¨å¤´è„‘ä¸­æ„å»ºä¸€å¹…MySQLå„ç»„ä»¶ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œçš„æ¶æ„å›¾ï¼Œæœ‰åŠ©äºæ·±å…¥ç†è§£MySQLæœåŠ¡å™¨ã€‚ä¸‹å›¾å±•ç¤ºäº†MySQLçš„é€»è¾‘æ¶æ„å›¾ã€‚&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images1/mysql-optimization-mechanism-1.jpg&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images1/mysql-optimization-mechanism-1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="mysql" scheme="http://idiotsky.me/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://idiotsky.me/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>ä»ä¸€ä¸ª NullPointerException æ¢ç©¶ Java çš„è‡ªåŠ¨è£…ç®±æ‹†ç®±æœºåˆ¶</title>
    <link href="http://idiotsky.me/2017/09/28/java-box-unbox/"/>
    <id>http://idiotsky.me/2017/09/28/java-box-unbox/</id>
    <published>2017-09-28T12:35:44.000Z</published>
    <updated>2017-09-28T15:54:46.025Z</updated>
    
    <content type="html"><![CDATA[<p>å‰å¤©é‡åˆ°äº†ä¸€ä¸ª NullPointerExceptionï¼Œè§¦å‘çš„ä»£ç ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">test</span><span class="params">(<span class="keyword">long</span> value)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Long value = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        test(value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>main æ–¹æ³•é‡Œçš„ä»£ç å®é™…ä¸Šç›¸å½“äºè°ƒç”¨ <code>test(null);</code>ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥è¿™æ ·å†™å‘¢ï¼Ÿå› ä¸ºç¼–è¯‘ä¸è¿‡ï¼Œä¼šæŠ¥ <code>é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: &lt;ç©ºå€¼&gt;æ— æ³•è½¬æ¢ä¸ºlong</code>ã€‚</p>
<h1 id="æŠ›å‡ºé—®é¢˜"><a href="#æŠ›å‡ºé—®é¢˜" class="headerlink" title="æŠ›å‡ºé—®é¢˜"></a>æŠ›å‡ºé—®é¢˜</h1><p>è¿è¡Œæ—¶æç¤º <code>test(value);</code> è¿™ä¸€è¡ŒæŠ›å‡º NullPointerExceptionï¼Œä½†æ˜¯çœ‹ç€ä»¥ä¸Šä»£ç ä¼šæœ‰äº›è®¸å›°æƒ‘ï¼šä»¥ä¸Šä»£ç é‡Œä¸€ä¸ªå¯¹è±¡æ–¹æ³•éƒ½æ²¡æœ‰è°ƒç”¨å•Šï¼ŒNullPointerException ä»ä½•è€Œæ¥ï¼Ÿ<br><a id="more"></a></p>
<h1 id="åŸå› åˆ†æ"><a href="#åŸå› åˆ†æ" class="headerlink" title="åŸå› åˆ†æ"></a>åŸå› åˆ†æ</h1><p>è¿™æ—¶ï¼Œå¦‚æœç•™æ„åˆ° test æ–¹æ³•æ¥å—çš„å‚æ•°æ˜¯ long ç±»å‹ï¼Œè€Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ Long ç±»å‹ï¼ˆè™½ç„¶å…¶å®æ˜¯ nullï¼‰ï¼Œå°±ä¼šæƒ³åˆ°è¿™ä¼šç»å†ä¸€æ¬¡ä»ç±»å‹ Long åˆ°åŸºæœ¬æ•°æ®ç±»å‹ long çš„è‡ªåŠ¨æ‹†ç®±è¿‡ç¨‹ï¼Œé‚£ä¼šä¸ä¼šæ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­æŠ›å‡ºçš„ NullPointerException å‘¢ï¼Ÿå› ä¸ºä»¥å‰åªçŸ¥é“ Java ä¸ºä¸€äº›åŸºç¡€æ•°æ®ç±»å‹ä¸å¯¹åº”çš„åŒ…è£…å™¨ç±»å‹ä¹‹é—´æä¾›äº†è‡ªåŠ¨è£…ç®±æ‹†ç®±æœºåˆ¶ï¼Œè€Œå¹¶ä¸çŸ¥è¿™æœºåˆ¶çš„å…·ä½“å®ç°æ–¹æ³•æ˜¯æ€ä¹ˆæ ·çš„ï¼Œæ­£å¥½å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<p>ç”¨å‘½ä»¤ <code>javap -c Test</code> å°†ä»¥ä¸Šä»£ç ç¼–è¯‘å‡ºçš„ Test.class æ–‡ä»¶è¿›è¡Œåæ±‡ç¼–ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Compiled from "Test.java"</div><div class="line">public class Test &#123;</div><div class="line">  public Test();</div><div class="line">    Code:</div><div class="line">       0: aload_0</div><div class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</div><div class="line">       4: return</div><div class="line"></div><div class="line">  public static long test(long);</div><div class="line">    Code:</div><div class="line">       0: lload_0</div><div class="line">       1: lreturn</div><div class="line"></div><div class="line">  public static void main(java.lang.String[]);</div><div class="line">    Code:</div><div class="line">       0: aconst_null</div><div class="line">       1: astore_1</div><div class="line">       2: aload_1</div><div class="line">       3: invokevirtual #2                  // Method java/lang/Long.longValue:()J</div><div class="line">       6: invokestatic  #3                  // Method test:(J)J</div><div class="line">       9: pop2</div><div class="line">      10: return</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»ä»¥ä¸Šå­—èŠ‚ç åŠå¯¹åº”çš„æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼Œ<code>test(value);</code> è¿™ä¸€è¡Œè¢«ç¼–è¯‘åç­‰åŒäºå¦‚ä¸‹ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> primitive = value.longValue();</div><div class="line">test(promitive);</div></pre></td></tr></table></figure></p>
<p>ç›¸æ¯”å®é™…ä»£ç ï¼Œå¤šå‡ºçš„ <code>long primitive = value.longValue();</code> è¿™ä¸€è¡Œçœ‹èµ·æ¥å°±æ˜¯è‡ªåŠ¨æ‹†ç®±çš„è¿‡ç¨‹äº†ï¼Œè€Œæˆ‘ä»¬ä¼ å…¥çš„ <code>value</code> ä¸º nullï¼Œ<code>value.longValue()</code> ä¼šæŠ›å‡º NullPointerExceptionï¼Œä¸€åˆ‡å°±è§£é‡Šå¾—é€šäº†ã€‚ç”¨æ›´ç®€æ´çš„ä»£ç è¡¨è¾¾å‡ºäº†æ›´ä¸°å¯Œçš„å«ä¹‰ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„è¯­æ³•ç³–äº†ã€‚</p>
<h1 id="è¯å®çŒœæƒ³"><a href="#è¯å®çŒœæƒ³" class="headerlink" title="è¯å®çŒœæƒ³"></a>è¯å®çŒœæƒ³</h1><p>é‚£ä¹ˆæˆ‘ä»¬ä¸Šé¢å¾—å‡ºçš„è‡ªåŠ¨æ‹†ç®±æœºåˆ¶çš„ç»“è®ºæ˜¯å¦æ­£ç¡®å‘¢ï¼Ÿé€‰æ‹©ä¸€ç§å…¶å®ƒåŸºæœ¬æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ intï¼Œæ¥ä½è¯ä¸€ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Integer value = <span class="number">10</span>;</div><div class="line">        <span class="keyword">int</span> primitive = value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åæ±‡ç¼–åå¯¹åº”çš„å­—èŠ‚ç ï¼š<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Compiled from "Test.java"</div><div class="line">public class Test &#123;</div><div class="line">  public Test();</div><div class="line">    Code:</div><div class="line">       0: aload_0</div><div class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</div><div class="line">       4: return</div><div class="line"></div><div class="line">  public static void main(java.lang.String[]);</div><div class="line">    Code:</div><div class="line">       0: bipush        10</div><div class="line">       2: invokestatic  #2                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</div><div class="line">       5: astore_1</div><div class="line">       6: aload_1</div><div class="line">       7: invokevirtual #3                  // Method java/lang/Integer.intValue:()I</div><div class="line">      10: istore_2</div><div class="line">      11: return</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç”±ä»¥ä¸Šå­—èŠ‚ç æˆ‘ä»¬å¯ä»¥å°è¯ä¸‹æ–‡é‡Œçš„çŸ¥è¯†ç‚¹äº†ã€‚</p>
<h1 id="è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±"><a href="#è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±" class="headerlink" title="è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±"></a>è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±</h1><p>è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±æ˜¯ Java 1.5 å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œæ˜¯ä¸€ç§è¯­æ³•ç³–ã€‚</p>
<p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªå€¼ä¸º 10 çš„ Integer å¯¹è±¡ï¼Œåªèƒ½å†™ä½œï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Integer value = <span class="keyword">new</span> Integer(<span class="number">10</span>);</div></pre></td></tr></table></figure></p>
<p>è€Œç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿åœ°å†™ä¸ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Integer value = <span class="number">10</span>;</div></pre></td></tr></table></figure></p>
<h1 id="å®šä¹‰ä¸å®ç°æœºåˆ¶"><a href="#å®šä¹‰ä¸å®ç°æœºåˆ¶" class="headerlink" title="å®šä¹‰ä¸å®ç°æœºåˆ¶"></a>å®šä¹‰ä¸å®ç°æœºåˆ¶</h1><p>è‡ªåŠ¨è£…ç®±ï¼Œæ˜¯æŒ‡ä»åŸºæœ¬æ•°æ®ç±»å‹å€¼åˆ°å…¶å¯¹åº”çš„åŒ…è£…ç±»å¯¹è±¡çš„è‡ªåŠ¨è½¬æ¢ã€‚æ¯”å¦‚ <code>Integer value = 10;</code>ï¼Œæ˜¯é€šè¿‡è°ƒç”¨ Integer.valueOf æ–¹æ³•å®ç°è½¬æ¢çš„ã€‚</p>
<p>è‡ªåŠ¨æ‹†ç®±ï¼Œæ˜¯æŒ‡ä»åŒ…è£…ç±»å¯¹è±¡åˆ°å…¶å¯¹åº”çš„åŸºæœ¬æ•°æ®ç±»å‹å€¼çš„è‡ªåŠ¨è½¬æ¢ã€‚æ¯”å¦‚ <code>int primitive = value;</code>ï¼Œæ˜¯é€šè¿‡è°ƒç”¨ Integer.intValue æ–¹æ³•å®ç°è½¬æ¢çš„ã€‚</p>
<table>
<thead>
<tr>
<th>åŸºæœ¬æ•°æ®ç±»å‹</th>
<th>åŒ…è£…ç±»å‹</th>
<th>è£…ç®±æ–¹æ³•</th>
<th>æ‹†ç®±æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>boolean</td>
<td>Boolean</td>
<td>Boolean.valueOf(boolean)</td>
<td>Boolean.booleanValue()</td>
</tr>
<tr>
<td>byte</td>
<td>Byte</td>
<td>Byte.valueOf(byte)</td>
<td>Byte.byteValue()</td>
</tr>
<tr>
<td>char</td>
<td>Character</td>
<td>Character.valueOf(char)</td>
<td>Character.charValue()</td>
</tr>
<tr>
<td>short</td>
<td>Short</td>
<td>Short.valueOf(short)</td>
<td>Short.shortValue()</td>
</tr>
<tr>
<td>int</td>
<td>Integer</td>
<td>Integer.valueOf(int)</td>
<td>Integer.intValue()</td>
</tr>
<tr>
<td>long</td>
<td>Long</td>
<td>Long.valueOf(long)</td>
<td>Long.longValue()</td>
</tr>
<tr>
<td>float</td>
<td>Float</td>
<td>Float.valueOf(float)</td>
<td>Float.floatValue()</td>
</tr>
<tr>
<td>double</td>
<td>Double</td>
<td>Double.valueOf(double)</td>
<td>Double.doubleValue()</td>
</tr>
</tbody>
</table>
<h1 id="å‘ç”Ÿæ—¶æœº"><a href="#å‘ç”Ÿæ—¶æœº" class="headerlink" title="å‘ç”Ÿæ—¶æœº"></a>å‘ç”Ÿæ—¶æœº</h1><p>è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±ä¸»è¦å‘ç”Ÿåœ¨ä»¥ä¸‹å››ç§æ—¶æœºï¼š</p>
<ol>
<li><p>èµ‹å€¼æ—¶ï¼›</p>
</li>
<li><p>æ¯”è¾ƒæ—¶ï¼›</p>
</li>
<li><p>ç®—æœ¯è¿ç®—æ—¶ï¼›</p>
</li>
<li><p>æ–¹æ³•è°ƒç”¨æ—¶ã€‚</p>
</li>
</ol>
<h1 id="å¸¸è§åº”ç”¨åœºæ™¯"><a href="#å¸¸è§åº”ç”¨åœºæ™¯" class="headerlink" title="å¸¸è§åº”ç”¨åœºæ™¯"></a>å¸¸è§åº”ç”¨åœºæ™¯</h1><h2 id="Case-1"><a href="#Case-1" class="headerlink" title="Case 1"></a>Case 1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Integer value = <span class="number">10</span>; <span class="comment">// è‡ªåŠ¨è£…ç®±ï¼ˆèµ‹å€¼æ—¶ï¼‰</span></div><div class="line"><span class="keyword">int</span> primitive = value; <span class="comment">// è‡ªåŠ¨æ‹†ç®±ï¼ˆæ–¹æ³•è°ƒç”¨æ—¶ï¼‰</span></div></pre></td></tr></table></figure>
<h2 id="Case-2"><a href="#Case-2" class="headerlink" title="Case 2"></a>Case 2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Integer value = <span class="number">1000</span>;</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">if</span> (value &lt;= <span class="number">1000</span>) &#123; <span class="comment">// è‡ªåŠ¨æ‹†ç®±ï¼ˆæ¯”è¾ƒæ—¶ï¼‰</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Case-3"><a href="#Case-3" class="headerlink" title="Case 3"></a>Case 3</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">list.add(<span class="number">10</span>); <span class="comment">// è‡ªåŠ¨è£…ç®±ï¼ˆæ–¹æ³•è°ƒç”¨æ—¶ï¼‰</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> i = list.get(<span class="number">0</span>); <span class="comment">// è‡ªåŠ¨æ‹†ç®±ï¼ˆèµ‹å€¼æ—¶ï¼‰</span></div></pre></td></tr></table></figure>
<p><strong>æ³¨ï¼šé›†åˆï¼ˆCollectionsï¼‰é‡Œä¸èƒ½ç›´æ¥æ”¾å…¥åŸå§‹ç±»å‹ï¼Œé›†åˆåªæ¥æ”¶å¯¹è±¡ã€‚</strong></p>
<h2 id="Case-4"><a href="#Case-4" class="headerlink" title="Case 4"></a>Case 4</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ThreadLocal&lt;Integer&gt; local = <span class="keyword">new</span> ThreadLocal&lt;Integer&gt;();</div><div class="line">local.set(<span class="number">10</span>); <span class="comment">// è‡ªåŠ¨è£…ç®±ï¼ˆæ–¹æ³•è°ƒç”¨æ—¶ï¼‰</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> i = local.get(); <span class="comment">// è‡ªåŠ¨æ‹†ç®±ï¼ˆèµ‹å€¼æ—¶ï¼‰</span></div></pre></td></tr></table></figure>
<p><strong>æ³¨ï¼šThreadLocal ä¸èƒ½å­˜å‚¨åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåªæ¥æ”¶å¼•ç”¨ç±»å‹ã€‚</strong></p>
<h2 id="Case-5"><a href="#Case-5" class="headerlink" title="Case 5"></a>Case 5</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fun1</span><span class="params">(Integer value)</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fun2</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">    fun1(<span class="number">10</span>); <span class="comment">// è‡ªåŠ¨è£…ç®±ï¼ˆæ–¹æ³•è°ƒç”¨æ—¶ï¼‰</span></div><div class="line"></div><div class="line">    Integer value = <span class="number">10</span>;</div><div class="line">    fun2(value); <span class="comment">// è‡ªåŠ¨æ‹†ç®±ï¼ˆæ–¹æ³•è°ƒç”¨æ—¶ï¼‰</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Case-6"><a href="#Case-6" class="headerlink" title="Case 6"></a>Case 6</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Integer v1 = <span class="keyword">new</span> Integer(<span class="number">10</span>);</div><div class="line">Integer v2 = <span class="keyword">new</span> Integer(<span class="number">20</span>);</div><div class="line"><span class="keyword">int</span> v3 = <span class="number">30</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> sum = v1 + v2; <span class="comment">// è‡ªåŠ¨æ‹†ç®±ï¼ˆç®—æœ¯è¿ç®—æ—¶ï¼‰</span></div><div class="line">sum = v1 + <span class="number">30</span>; <span class="comment">// è‡ªåŠ¨æ‹†ç®±ï¼ˆç®—æœ¯è¿ç®—æ—¶ï¼‰</span></div></pre></td></tr></table></figure>
<h1 id="ç›¸å…³çŸ¥è¯†ç‚¹"><a href="#ç›¸å…³çŸ¥è¯†ç‚¹" class="headerlink" title="ç›¸å…³çŸ¥è¯†ç‚¹"></a>ç›¸å…³çŸ¥è¯†ç‚¹</h1><h2 id="æ¯”è¾ƒ"><a href="#æ¯”è¾ƒ" class="headerlink" title="æ¯”è¾ƒ"></a>æ¯”è¾ƒ</h2><p>é™¤ <code>==</code> ä»¥å¤–ï¼ŒåŒ…è£…ç±»å¯¹è±¡ä¸åŸºæœ¬æ•°æ®ç±»å‹å€¼çš„æ¯”è¾ƒï¼ŒåŒ…è£…ç±»å¯¹è±¡ä¸åŒ…è£…ç±»å¯¹è±¡ä¹‹é—´çš„æ¯”è¾ƒï¼Œéƒ½æ˜¯è‡ªåŠ¨æ‹†ç®±åå¯¹åŸºæœ¬æ•°æ®ç±»å‹å€¼è¿›è¡Œæ¯”è¾ƒï¼Œæ‰€ä»¥ï¼Œ<strong>è¦æ³¨æ„è¿™äº›ç±»å‹é—´è¿›è¡Œæ¯”è¾ƒæ—¶è‡ªåŠ¨æ‹†ç®±å¯èƒ½å¼•å‘çš„ NullPointerException</strong>ã€‚</p>
<p><code>==</code> æ¯”è¾ƒç‰¹æ®Šï¼Œå› ä¸ºå¯ä»¥ç”¨äºåˆ¤æ–­å·¦å³æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡ï¼Œæ‰€ä»¥ä¸¤ä¸ªåŒ…è£…ç±»å¯¹è±¡ä¹‹é—´ <code>==</code>ï¼Œä¼šç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€å¯¹è±¡ï¼Œè€Œä¸ä¼šè¿›è¡Œè‡ªåŠ¨æ‹†ç®±æ“ä½œï¼›åŒ…è£…ç±»å¯¹è±¡ä¸åŸºæœ¬æ•°æ®ç±»å‹å€¼ä¹‹é—´ <code>==</code>ï¼Œä¼šè‡ªåŠ¨æ‹†ç®±ã€‚</p>
<p>ç¤ºä¾‹ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Integer v1 = <span class="keyword">new</span> Integer(<span class="number">10</span>);</div><div class="line">Integer v2 = <span class="keyword">new</span> Integer(<span class="number">20</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (v1 &lt; v2) &#123; <span class="comment">// è‡ªåŠ¨æ‹†ç®±</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (v1 == v2) &#123; <span class="comment">// ä¸æ‹†ç®±</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (v1 == <span class="number">10</span>) &#123; <span class="comment">// è‡ªåŠ¨æ‹†ç®±</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h2><p>Java ä¸ºæ•´å‹å€¼åŒ…è£…ç±» Byteã€Characterã€Shortã€Integerã€Long è®¾ç½®äº†ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨ä¸€å®šèŒƒå›´å†…çš„å€¼ï¼Œè¯¦ç»†å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç¼“å­˜å€¼èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr>
<td>Byte</td>
<td>-128 ~ 127</td>
</tr>
<tr>
<td>Character</td>
<td>0 ~ 127</td>
</tr>
<tr>
<td>Short</td>
<td>-128 ~ 127</td>
</tr>
<tr>
<td>Integer</td>
<td>-128 ~ 127ï¼ˆå¯é…ç½®ï¼‰</td>
</tr>
<tr>
<td>Long</td>
<td>-128 ~ 127</td>
</tr>
</tbody>
</table>
<p>åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚è‡ªåŠ¨è£…ç®±æ—¶ï¼Œå¦‚æœå€¼åœ¨ç¼“å­˜å€¼èŒƒå›´å†…ï¼Œå°†ä¸åˆ›å»ºæ–°å¯¹è±¡ï¼Œç›´æ¥ä»ç¼“å­˜é‡Œå–å‡ºå¯¹è±¡è¿”å›ï¼Œæ¯”å¦‚ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Integer v1 = <span class="number">10</span>;</div><div class="line">Integer v2 = <span class="number">10</span>;</div><div class="line">Integer v3 = <span class="keyword">new</span> Integer(<span class="number">10</span>);</div><div class="line">Integer v4 = <span class="number">128</span>;</div><div class="line">Integer v5 = <span class="number">128</span>;</div><div class="line">Integer v6 = Integer.valueOf(<span class="number">10</span>);</div><div class="line"></div><div class="line">System.out.println(v1 == v2); <span class="comment">// true</span></div><div class="line">System.out.println(v1 == v3); <span class="comment">// false</span></div><div class="line">System.out.println(v4 == v5); <span class="comment">// false</span></div><div class="line">System.out.println(v1 == v6); <span class="comment">// true</span></div></pre></td></tr></table></figure></p>
<h3 id="ç¼“å­˜å®ç°æœºåˆ¶"><a href="#ç¼“å­˜å®ç°æœºåˆ¶" class="headerlink" title="ç¼“å­˜å®ç°æœºåˆ¶"></a>ç¼“å­˜å®ç°æœºåˆ¶</h3><p>è¿™é‡Œä½¿ç”¨äº†è®¾è®¡æ¨¡å¼äº«å…ƒæ¨¡å¼ã€‚</p>
<p>ä»¥ Short ç±»å®ç°æºç ä¸ºä¾‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Short</span> <span class="keyword">extends</span> <span class="title">Number</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Short</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ShortCache</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">ShortCache</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Short cache[] = <span class="keyword">new</span> Short[-(-<span class="number">128</span>) + <span class="number">127</span> + <span class="number">1</span>];</div><div class="line"></div><div class="line">        <span class="keyword">static</span> &#123;</div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cache.length; i++)</div><div class="line">                cache[i] = <span class="keyword">new</span> Short((<span class="keyword">short</span>)(i - <span class="number">128</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Short <span class="title">valueOf</span><span class="params">(<span class="keyword">short</span> s)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> offset = <span class="number">128</span>;</div><div class="line">        <span class="keyword">int</span> sAsInt = s;</div><div class="line">        <span class="keyword">if</span> (sAsInt &gt;= -<span class="number">128</span> &amp;&amp; sAsInt &lt;= <span class="number">127</span>) &#123; <span class="comment">// must cache</span></div><div class="line">            <span class="keyword">return</span> ShortCache.cache[sAsInt + offset];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Short(s);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨åˆ° <code>Short.valueOf(short)</code> æ–¹æ³•æ—¶ï¼Œå°†åˆ›å»º -128 ~ 127 å¯¹åº”çš„ 256 ä¸ªå¯¹è±¡ç¼“å­˜åˆ°å †å†…å­˜é‡Œã€‚</p>
<p>è¿™ç§è®¾è®¡ï¼Œåœ¨é¢‘ç¹ç”¨åˆ°è¿™ä¸ªèŒƒå›´å†…çš„å€¼çš„æ—¶å€™æ•ˆç‡è¾ƒé«˜ï¼Œå¯ä»¥é¿å…é‡å¤åˆ›å»ºå’Œå›æ”¶å¯¹è±¡ï¼Œå¦åˆ™æœ‰å¯èƒ½é—²ç½®è¾ƒå¤šå¯¹è±¡åœ¨å†…å­˜ä¸­ã€‚</p>
<h3 id="ä½¿ç”¨ä¸å½“çš„æƒ…å†µ"><a href="#ä½¿ç”¨ä¸å½“çš„æƒ…å†µ" class="headerlink" title="ä½¿ç”¨ä¸å½“çš„æƒ…å†µ"></a>ä½¿ç”¨ä¸å½“çš„æƒ…å†µ</h3><p>è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±è¿™ç§è¯­æ³•ç³–ä¸ºæˆ‘ä»¬å†™ä»£ç å¸¦æ¥äº†ç®€æ´å’Œä¾¿åˆ©ï¼Œä½†å¦‚æœä½¿ç”¨ä¸å½“ï¼Œä¹Ÿæœ‰å¯èƒ½å¸¦æ¥è´Ÿé¢å½±å“ã€‚</p>
<ol>
<li>æ€§èƒ½çš„æŸè€—<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Integer sum = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1000</span>; i &lt; <span class="number">5000</span>; i++) &#123;</div><div class="line">       <span class="comment">// 1. å…ˆå¯¹ sum è¿›è¡Œè‡ªåŠ¨æ‹†ç®±</span></div><div class="line">       <span class="comment">// 2. åŠ æ³•</span></div><div class="line">       <span class="comment">// 3. è‡ªåŠ¨è£…ç®±èµ‹å€¼ç»™ sumï¼Œæ— æ³•å‘½ä¸­ç¼“å­˜ï¼Œä¼š new Integer(int)</span></div><div class="line">       sum = sum + i;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>åœ¨å¾ªç¯è¿‡ç¨‹ä¸­ä¼šåˆ†åˆ«è°ƒç”¨ 4000 æ¬¡ Integer.intValue() å’Œ Integer.valueOf(int)ï¼Œå¹¶ new 4000 ä¸ª Integer å¯¹è±¡ï¼Œè€Œè¿™äº›æ“ä½œå°† sum çš„ç±»å‹æ”¹ä¸º int å³å¯é¿å…ï¼ŒèŠ‚çº¦è¿è¡Œæ—¶é—´å’Œç©ºé—´ï¼Œæå‡æ€§èƒ½ã€‚</p>
<ol>
<li>java.lang.NullPointerException<br>å°è¯•å¯¹ä¸€ä¸ªå€¼ä¸º null çš„åŒ…è£…ç±»å¯¹è±¡è¿›è¡Œè‡ªåŠ¨æ‹†ç®±ï¼Œå°±æœ‰å¯èƒ½é€ æˆ NullPointerExceptionã€‚<br>æ¯”å¦‚ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Integer v1 = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">int</span> v2 = v1; <span class="comment">// NullPointerException</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (v1 &gt; <span class="number">10</span>) &#123; <span class="comment">// NullPointerException</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> v3 = v1 + <span class="number">10</span>; <span class="comment">// NullPointerException</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>è¿˜æœ‰ä¸€ç§æ›´éšè”½çš„æƒ…å½¢<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> value = <span class="keyword">true</span> ? <span class="keyword">null</span> : <span class="number">1</span>; <span class="comment">// NullPointerException</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™å®é™…ä¸Šè¿˜æ˜¯å¯¹ä¸€ä¸ªå€¼ä¸º null çš„ Long ç±»å‹è¿›è¡Œè‡ªåŠ¨æ‹†ç®±ï¼Œåæ±‡ç¼–ä»£ç ï¼š<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Compiled from "Test.java"</div><div class="line">public class Test &#123;</div><div class="line">  public Test();</div><div class="line">    Code:</div><div class="line">       0: aload_0</div><div class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</div><div class="line">       4: return</div><div class="line"></div><div class="line">  public static void main(java.lang.String[]);</div><div class="line">    Code:</div><div class="line">       0: aconst_null</div><div class="line">       1: checkcast     #2                  // class java/lang/Long</div><div class="line">       4: invokevirtual #3                  // Method java/lang/Long.longValue:()J</div><div class="line">       7: lstore_1</div><div class="line">       8: return</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è½¬è½½ <a href="http://mazhuang.org/2017/08/20/java-auto-boxing-unboxing/" target="_blank" rel="external">http://mazhuang.org/2017/08/20/java-auto-boxing-unboxing/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰å¤©é‡åˆ°äº†ä¸€ä¸ª NullPointerExceptionï¼Œè§¦å‘çš„ä»£ç ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Test&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; value)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; value;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Long value = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        test(value);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;main æ–¹æ³•é‡Œçš„ä»£ç å®é™…ä¸Šç›¸å½“äºè°ƒç”¨ &lt;code&gt;test(null);&lt;/code&gt;ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥è¿™æ ·å†™å‘¢ï¼Ÿå› ä¸ºç¼–è¯‘ä¸è¿‡ï¼Œä¼šæŠ¥ &lt;code&gt;é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: &amp;lt;ç©ºå€¼&amp;gt;æ— æ³•è½¬æ¢ä¸ºlong&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h1 id=&quot;æŠ›å‡ºé—®é¢˜&quot;&gt;&lt;a href=&quot;#æŠ›å‡ºé—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;æŠ›å‡ºé—®é¢˜&quot;&gt;&lt;/a&gt;æŠ›å‡ºé—®é¢˜&lt;/h1&gt;&lt;p&gt;è¿è¡Œæ—¶æç¤º &lt;code&gt;test(value);&lt;/code&gt; è¿™ä¸€è¡ŒæŠ›å‡º NullPointerExceptionï¼Œä½†æ˜¯çœ‹ç€ä»¥ä¸Šä»£ç ä¼šæœ‰äº›è®¸å›°æƒ‘ï¼šä»¥ä¸Šä»£ç é‡Œä¸€ä¸ªå¯¹è±¡æ–¹æ³•éƒ½æ²¡æœ‰è°ƒç”¨å•Šï¼ŒNullPointerException ä»ä½•è€Œæ¥ï¼Ÿ&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="è£…ç®±" scheme="http://idiotsky.me/tags/%E8%A3%85%E7%AE%B1/"/>
    
      <category term="æ‹†ç®±" scheme="http://idiotsky.me/tags/%E6%8B%86%E7%AE%B1/"/>
    
  </entry>
  
  <entry>
    <title>goåŸºç¡€-iota</title>
    <link href="http://idiotsky.me/2017/09/18/go-basic-iota/"/>
    <id>http://idiotsky.me/2017/09/18/go-basic-iota/</id>
    <published>2017-09-18T07:44:21.000Z</published>
    <updated>2017-09-19T13:18:39.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>iotaè¿™ä¸ªå…³é”®å­—ï¼Œç”¨æ¥å®ç°æšä¸¾çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç”¨èµ·æ¥å¾ˆå¥‡æ€ªï¼Œå…¶å®æœ€åè¡¨ç¤ºçš„è¿˜æ˜¯å¸¸é‡ã€‚</p>
</blockquote>
<h1 id="å…ˆä¸Šä»£ç "><a href="#å…ˆä¸Šä»£ç " class="headerlink" title="å…ˆä¸Šä»£ç "></a>å…ˆä¸Šä»£ç </h1><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span>(</div><div class="line">    a= <span class="number">10</span>+<span class="literal">iota</span></div><div class="line">    b</div><div class="line">    c</div><div class="line">    d</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	fmt.Println(a)</div><div class="line">	fmt.Println(b)</div><div class="line">	fmt.Println(c)</div><div class="line">	fmt.Println(d)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»“æœï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td></tr></table></figure></p>
<p>å…¶å®ä¸Šé¢ä»£ç ç­‰ä»·äº<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span>(</div><div class="line">    a= <span class="number">10</span>+<span class="number">0</span></div><div class="line">    b= <span class="number">10</span>+<span class="number">1</span></div><div class="line">    c= <span class="number">10</span>+<span class="number">2</span></div><div class="line">    d= <span class="number">10</span>+<span class="number">3</span></div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>çœ‹å‡ºè§„å¾‹äº†å§ï¼Œåªè¦iotaå‡ºç°ä¸€æ¬¡ï¼Œå°±ç´¯åŠ ä¸€æ¬¡ï¼Œè€Œä¸”ä¸€æ—¦å‡ºç°ä¸€æ¬¡ï¼Œå°±ç®—åé¢ä¸ä½¿ç”¨è¿™ä¸ªiotaå…³é”®å­—ï¼Œæ¥ä¸‹æ¥çš„å˜é‡éƒ½ä¼šå¥—ç”¨å‰é¢çš„è¡¨è¾¾å¼æ¥è®¡ç®—ï¼Œæ‰€ä»¥b,c,dç”¨çš„å°±æ˜¯açš„è¡¨è¾¾å¼<br><a id="more"></a></p>
<h1 id="å†ä¸Šä»£ç "><a href="#å†ä¸Šä»£ç " class="headerlink" title="å†ä¸Šä»£ç "></a>å†ä¸Šä»£ç </h1><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span>(</div><div class="line">    a= <span class="number">10</span>+<span class="literal">iota</span></div><div class="line">    b</div><div class="line">    c</div><div class="line">    d</div><div class="line">	  e=<span class="number">1</span>+<span class="literal">iota</span></div><div class="line">	  f</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	fmt.Println(a)</div><div class="line">	fmt.Println(b)</div><div class="line">	fmt.Println(c)</div><div class="line">	fmt.Println(d)</div><div class="line">	fmt.Println(e)</div><div class="line">	fmt.Println(f)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªçš„è¾“å‡ºï¼Œåº”è¯¥èƒ½çŒœå‡ºæ¥äº†å§<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">5</div><div class="line">6</div></pre></td></tr></table></figure></p>
<p>få¾ˆæ˜æ˜¾æ˜¯ç”±äºeçš„è¡¨è¾¾å¼å˜äº†ï¼Œæ‰€ä»¥æ˜¯å¥—ç”¨äº†eçš„è¡¨è¾¾å¼ï¼Œè€Œä¸ç”¨açš„è¡¨è¾¾å¼</p>
<h1 id="æœ€åçš„ä»£ç "><a href="#æœ€åçš„ä»£ç " class="headerlink" title="æœ€åçš„ä»£ç "></a>æœ€åçš„ä»£ç </h1><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span>(</div><div class="line">    a= <span class="number">10</span>+<span class="literal">iota</span></div><div class="line">    b</div><div class="line">    c</div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span>(</div><div class="line">	d=<span class="number">1</span>+<span class="literal">iota</span></div><div class="line">	e</div><div class="line">	f</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	fmt.Println(a)</div><div class="line">	fmt.Println(b)</div><div class="line">	fmt.Println(c)</div><div class="line">	fmt.Println(d)</div><div class="line">	fmt.Println(e)</div><div class="line">	fmt.Println(f)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»“æœï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td></tr></table></figure></p>
<p>å¾ˆæ˜æ˜¾ï¼Œiotaåªèƒ½åœ¨ä¸€ä¸ªä»£ç å—ç´¯åŠ ï¼Œåœ¨å¦å¤–çš„ä»£ç å—å°±åˆé‡ç½®äº†ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å…¶å®iotaåœ¨goå°±æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå®šä¹‰åœ¨builtin.goè¿™ä¸ªæºæ–‡ä»¶<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// iota is a predeclared identifier representing the untyped integer ordinal</span></div><div class="line"><span class="comment">// number of the current const specification in a (usually parenthesized)</span></div><div class="line"><span class="comment">// const declaration. It is zero-indexed.</span></div><div class="line"><span class="keyword">const</span> <span class="literal">iota</span> = <span class="number">0</span> <span class="comment">// Untyped int.</span></div></pre></td></tr></table></figure></p>
<p>æœ¬æ–‡ä»£ç åœ¨ <a href="https://github.com/ejunjsh/go-code/tree/master/iota" target="_blank" rel="external">https://github.com/ejunjsh/go-code/tree/master/iota</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;iotaè¿™ä¸ªå…³é”®å­—ï¼Œç”¨æ¥å®ç°æšä¸¾çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç”¨èµ·æ¥å¾ˆå¥‡æ€ªï¼Œå…¶å®æœ€åè¡¨ç¤ºçš„è¿˜æ˜¯å¸¸é‡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;å…ˆä¸Šä»£ç &quot;&gt;&lt;a href=&quot;#å…ˆä¸Šä»£ç &quot; class=&quot;headerlink&quot; title=&quot;å…ˆä¸Šä»£ç &quot;&gt;&lt;/a&gt;å…ˆä¸Šä»£ç &lt;/h1&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;&quot;fmt&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt;(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    a= &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;+&lt;span class=&quot;literal&quot;&gt;iota&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    b&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    c&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    d&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	fmt.Println(a)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	fmt.Println(b)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	fmt.Println(c)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;	fmt.Println(d)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ç»“æœï¼š&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å…¶å®ä¸Šé¢ä»£ç ç­‰ä»·äº&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt;(&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    a= &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    b= &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    c= &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    d= &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;+&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;çœ‹å‡ºè§„å¾‹äº†å§ï¼Œåªè¦iotaå‡ºç°ä¸€æ¬¡ï¼Œå°±ç´¯åŠ ä¸€æ¬¡ï¼Œè€Œä¸”ä¸€æ—¦å‡ºç°ä¸€æ¬¡ï¼Œå°±ç®—åé¢ä¸ä½¿ç”¨è¿™ä¸ªiotaå…³é”®å­—ï¼Œæ¥ä¸‹æ¥çš„å˜é‡éƒ½ä¼šå¥—ç”¨å‰é¢çš„è¡¨è¾¾å¼æ¥è®¡ç®—ï¼Œæ‰€ä»¥b,c,dç”¨çš„å°±æ˜¯açš„è¡¨è¾¾å¼&lt;br&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.me/categories/go/"/>
    
    
      <category term="go" scheme="http://idiotsky.me/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>redisæ•°æ®ç»“æ„-å¯¹è±¡</title>
    <link href="http://idiotsky.me/2017/09/18/redis-object/"/>
    <id>http://idiotsky.me/2017/09/18/redis-object/</id>
    <published>2017-09-17T17:29:58.000Z</published>
    <updated>2017-10-07T13:24:55.648Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨å‰é¢çš„æ•°ä¸ªç« èŠ‚é‡Œï¼Œ æˆ‘ä»¬é™†ç»­ä»‹ç»äº† Redis ç”¨åˆ°çš„æ‰€æœ‰ä¸»è¦æ•°æ®ç»“æ„ï¼Œ æ¯”å¦‚ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰ã€åŒç«¯é“¾è¡¨ã€å­—å…¸ã€å‹ç¼©åˆ—è¡¨ã€æ•´æ•°é›†åˆï¼Œ ç­‰ç­‰ã€‚</p>
<p>Redis å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨è¿™äº›æ•°æ®ç»“æ„æ¥å®ç°é”®å€¼å¯¹æ•°æ®åº“ï¼Œ è€Œæ˜¯åŸºäºè¿™äº›æ•°æ®ç»“æ„åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿï¼Œ è¿™ä¸ªç³»ç»ŸåŒ…å«å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡è¿™äº”ç§ç±»å‹çš„å¯¹è±¡ï¼Œ æ¯ç§å¯¹è±¡éƒ½ç”¨åˆ°äº†è‡³å°‘ä¸€ç§æˆ‘ä»¬å‰é¢æ‰€ä»‹ç»çš„æ•°æ®ç»“æ„ã€‚</p>
<p>é€šè¿‡è¿™äº”ç§ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œ Redis å¯ä»¥åœ¨æ‰§è¡Œå‘½ä»¤ä¹‹å‰ï¼Œ æ ¹æ®å¯¹è±¡çš„ç±»å‹æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥æ‰§è¡Œç»™å®šçš„å‘½ä»¤ã€‚ ä½¿ç”¨å¯¹è±¡çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œ æˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œ ä¸ºå¯¹è±¡è®¾ç½®å¤šç§ä¸åŒçš„æ•°æ®ç»“æ„å®ç°ï¼Œ ä»è€Œä¼˜åŒ–å¯¹è±¡åœ¨ä¸åŒåœºæ™¯ä¸‹çš„ä½¿ç”¨æ•ˆç‡ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ Redis çš„å¯¹è±¡ç³»ç»Ÿè¿˜å®ç°äº†åŸºäºå¼•ç”¨è®¡æ•°æŠ€æœ¯çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼š å½“ç¨‹åºä¸å†ä½¿ç”¨æŸä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œ è¿™ä¸ªå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜å°±ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼› å¦å¤–ï¼Œ Redis è¿˜é€šè¿‡å¼•ç”¨è®¡æ•°æŠ€æœ¯å®ç°äº†å¯¹è±¡å…±äº«æœºåˆ¶ï¼Œ è¿™ä¸€æœºåˆ¶å¯ä»¥åœ¨é€‚å½“çš„æ¡ä»¶ä¸‹ï¼Œ é€šè¿‡è®©å¤šä¸ªæ•°æ®åº“é”®å…±äº«åŒä¸€ä¸ªå¯¹è±¡æ¥èŠ‚çº¦å†…å­˜ã€‚</p>
<p>æœ€åï¼Œ Redis çš„å¯¹è±¡å¸¦æœ‰è®¿é—®æ—¶é—´è®°å½•ä¿¡æ¯ï¼Œ è¯¥ä¿¡æ¯å¯ä»¥ç”¨äºè®¡ç®—æ•°æ®åº“é”®çš„ç©ºè½¬æ—¶é•¿ï¼Œ åœ¨æœåŠ¡å™¨å¯ç”¨äº† maxmemory åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œ ç©ºè½¬æ—¶é•¿è¾ƒå¤§çš„é‚£äº›é”®å¯èƒ½ä¼šä¼˜å…ˆè¢«æœåŠ¡å™¨åˆ é™¤ã€‚</p>
<p>æœ¬ç« æ¥ä¸‹æ¥å°†é€ä¸€ä»‹ç»ä»¥ä¸Šæåˆ°çš„ Redis å¯¹è±¡ç³»ç»Ÿçš„å„ä¸ªç‰¹æ€§ã€‚<br><a id="more"></a></p>
<h1 id="å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç "><a href="#å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç " class="headerlink" title="å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç "></a>å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç </h1><p>Redis ä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„é”®å’Œå€¼ï¼Œ æ¯æ¬¡å½“æˆ‘ä»¬åœ¨ Redis çš„æ•°æ®åº“ä¸­æ–°åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œ æˆ‘ä»¬è‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œ ä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„é”®ï¼ˆé”®å¯¹è±¡ï¼‰ï¼Œ å¦ä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„å€¼ï¼ˆå€¼å¯¹è±¡ï¼‰ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ ä»¥ä¸‹ SET å‘½ä»¤åœ¨æ•°æ®åº“ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹ï¼Œ å…¶ä¸­é”®å€¼å¯¹çš„é”®æ˜¯ä¸€ä¸ªåŒ…å«äº†å­—ç¬¦ä¸²å€¼ â€œmsgâ€ çš„å¯¹è±¡ï¼Œ è€Œé”®å€¼å¯¹çš„å€¼åˆ™æ˜¯ä¸€ä¸ªåŒ…å«äº†å­—ç¬¦ä¸²å€¼ â€œhello worldâ€ çš„å¯¹è±¡ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SET msg <span class="string">"hello world"</span></span></div><div class="line">OK</div></pre></td></tr></table></figure></p>
<p>Redis ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ç”±ä¸€ä¸ª redisObject ç»“æ„è¡¨ç¤ºï¼Œ è¯¥ç»“æ„ä¸­å’Œä¿å­˜æ•°æ®æœ‰å…³çš„ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯ type å±æ€§ã€ encoding å±æ€§å’Œ ptr å±æ€§ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// ç±»å‹</span></div><div class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</div><div class="line"></div><div class="line">    <span class="comment">// ç¼–ç </span></div><div class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</div><div class="line"></div><div class="line">    <span class="comment">// æŒ‡å‘åº•å±‚å®ç°æ•°æ®ç»“æ„çš„æŒ‡é’ˆ</span></div><div class="line">    <span class="keyword">void</span> *ptr;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125; robj;</div></pre></td></tr></table></figure></p>
<h2 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h2><p>å¯¹è±¡çš„ type å±æ€§è®°å½•äº†å¯¹è±¡çš„ç±»å‹ï¼Œ è¿™ä¸ªå±æ€§çš„å€¼å¯ä»¥æ˜¯è¡¨ 8-1 åˆ—å‡ºçš„å¸¸é‡çš„å…¶ä¸­ä¸€ä¸ªã€‚</p>
<table>
<thead>
<tr>
<th>ç±»å‹å¸¸é‡</th>
<th>å¯¹è±¡çš„åç§°</th>
</tr>
</thead>
<tbody>
<tr>
<td>REDIS_STRING</td>
<td>å­—ç¬¦ä¸²å¯¹è±¡</td>
</tr>
<tr>
<td>REDIS_LIST</td>
<td>åˆ—è¡¨å¯¹è±¡</td>
</tr>
<tr>
<td>REDIS_HASH</td>
<td>å“ˆå¸Œå¯¹è±¡</td>
</tr>
<tr>
<td>REDIS_SET</td>
<td>é›†åˆå¯¹è±¡</td>
</tr>
<tr>
<td>REDIS_ZSET</td>
<td>æœ‰åºé›†åˆå¯¹è±¡</td>
</tr>
</tbody>
</table>
<p>å¯¹äº Redis æ•°æ®åº“ä¿å­˜çš„é”®å€¼å¯¹æ¥è¯´ï¼Œ é”®æ€»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ è€Œå€¼åˆ™å¯ä»¥æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡æˆ–è€…æœ‰åºé›†åˆå¯¹è±¡çš„å…¶ä¸­ä¸€ç§ï¼Œ å› æ­¤ï¼š</p>
<ul>
<li>å½“æˆ‘ä»¬ç§°å‘¼ä¸€ä¸ªæ•°æ®åº“é”®ä¸ºâ€œå­—ç¬¦ä¸²é”®â€æ—¶ï¼Œ æˆ‘ä»¬æŒ‡çš„æ˜¯â€œè¿™ä¸ªæ•°æ®åº“é”®æ‰€å¯¹åº”çš„å€¼ä¸ºå­—ç¬¦ä¸²å¯¹è±¡â€ï¼›</li>
<li>å½“æˆ‘ä»¬ç§°å‘¼ä¸€ä¸ªé”®ä¸ºâ€œåˆ—è¡¨é”®â€æ—¶ï¼Œ æˆ‘ä»¬æŒ‡çš„æ˜¯â€œè¿™ä¸ªæ•°æ®åº“é”®æ‰€å¯¹åº”çš„å€¼ä¸ºåˆ—è¡¨å¯¹è±¡â€ï¼Œ</li>
</ul>
<p>è¯¸å¦‚æ­¤ç±»ã€‚</p>
<p>TYPE å‘½ä»¤çš„å®ç°æ–¹å¼ä¹Ÿä¸æ­¤ç±»ä¼¼ï¼Œ å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªæ•°æ®åº“é”®æ‰§è¡Œ TYPE å‘½ä»¤æ—¶ï¼Œ å‘½ä»¤è¿”å›çš„ç»“æœä¸ºæ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç±»å‹ï¼Œ è€Œä¸æ˜¯é”®å¯¹è±¡çš„ç±»å‹ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> é”®ä¸ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå€¼ä¸ºå­—ç¬¦ä¸²å¯¹è±¡</span></div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> SET msg <span class="string">"hello world"</span></span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> TYPE msg</span></div><div class="line">string</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> é”®ä¸ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå€¼ä¸ºåˆ—è¡¨å¯¹è±¡</span></div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> RPUSH numbers 1 3 5</span></div><div class="line">(integer) 6</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> TYPE numbers</span></div><div class="line">list</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> é”®ä¸ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå€¼ä¸ºå“ˆå¸Œå¯¹è±¡</span></div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> HMSET profile name Tome age 25 career Programmer</span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> TYPE profile</span></div><div class="line">hash</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> é”®ä¸ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå€¼ä¸ºé›†åˆå¯¹è±¡</span></div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> SADD fruits apple banana cherry</span></div><div class="line">(integer) 3</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> TYPE fruits</span></div><div class="line">set</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> é”®ä¸ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå€¼ä¸ºæœ‰åºé›†åˆå¯¹è±¡</span></div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> ZADD price 8.5 apple 5.0 banana 6.0 cherry</span></div><div class="line">(integer) 3</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> TYPE price</span></div><div class="line">zset</div></pre></td></tr></table></figure></p>
<p>è¡¨ 8-2 åˆ—å‡ºäº† TYPE å‘½ä»¤åœ¨é¢å¯¹ä¸åŒç±»å‹çš„å€¼å¯¹è±¡æ—¶æ‰€äº§ç”Ÿçš„è¾“å‡ºã€‚</p>
<table>
<thead>
<tr>
<th>å¯¹è±¡</th>
<th>å¯¹è±¡ type å±æ€§çš„å€¼</th>
<th>TYPE å‘½ä»¤çš„è¾“å‡º</th>
</tr>
</thead>
<tbody>
<tr>
<td>å­—ç¬¦ä¸²å¯¹è±¡</td>
<td>REDIS_STRING</td>
<td>â€œstringâ€</td>
</tr>
<tr>
<td>åˆ—è¡¨å¯¹è±¡</td>
<td>REDIS_LIST</td>
<td>â€œlistâ€</td>
</tr>
<tr>
<td>å“ˆå¸Œå¯¹è±¡</td>
<td>REDIS_HASH</td>
<td>â€œhashâ€</td>
</tr>
<tr>
<td>é›†åˆå¯¹è±¡</td>
<td>REDIS_SET</td>
<td>â€œsetâ€</td>
</tr>
<tr>
<td>æœ‰åºé›†åˆå¯¹è±¡</td>
<td>REDIS_ZSET</td>
<td>â€œzsetâ€</td>
</tr>
</tbody>
</table>
<h2 id="ç¼–ç å’Œåº•å±‚å®ç°"><a href="#ç¼–ç å’Œåº•å±‚å®ç°" class="headerlink" title="ç¼–ç å’Œåº•å±‚å®ç°"></a>ç¼–ç å’Œåº•å±‚å®ç°</h2><p>å¯¹è±¡çš„ ptr æŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åº•å±‚å®ç°æ•°æ®ç»“æ„ï¼Œ è€Œè¿™äº›æ•°æ®ç»“æ„ç”±å¯¹è±¡çš„ encoding å±æ€§å†³å®šã€‚</p>
<p>encoding å±æ€§è®°å½•äº†å¯¹è±¡æ‰€ä½¿ç”¨çš„ç¼–ç ï¼Œ ä¹Ÿå³æ˜¯è¯´è¿™ä¸ªå¯¹è±¡ä½¿ç”¨äº†ä»€ä¹ˆæ•°æ®ç»“æ„ä½œä¸ºå¯¹è±¡çš„åº•å±‚å®ç°ï¼Œ è¿™ä¸ªå±æ€§çš„å€¼å¯ä»¥æ˜¯è¡¨ 8-3 åˆ—å‡ºçš„å¸¸é‡çš„å…¶ä¸­ä¸€ä¸ªã€‚</p>
<table>
<thead>
<tr>
<th>ç¼–ç å¸¸é‡</th>
<th>ç¼–ç æ‰€å¯¹åº”çš„åº•å±‚æ•°æ®ç»“æ„</th>
</tr>
</thead>
<tbody>
<tr>
<td>REDIS_ENCODING_INT</td>
<td>long ç±»å‹çš„æ•´æ•°</td>
</tr>
<tr>
<td>REDIS_ENCODING_EMBSTR</td>
<td>embstr ç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>REDIS_ENCODING_RAW</td>
<td>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>REDIS_ENCODING_HT</td>
<td>å­—å…¸</td>
</tr>
<tr>
<td>REDIS_ENCODING_LINKEDLIST</td>
<td>åŒç«¯é“¾è¡¨</td>
</tr>
<tr>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>å‹ç¼©åˆ—è¡¨</td>
</tr>
<tr>
<td>REDIS_ENCODING_INTSET</td>
<td>æ•´æ•°é›†åˆ</td>
</tr>
<tr>
<td>REDIS_ENCODING_SKIPLIST</td>
<td>è·³è·ƒè¡¨å’Œå­—å…¸</td>
</tr>
</tbody>
</table>
<p>æ¯ç§ç±»å‹çš„å¯¹è±¡éƒ½è‡³å°‘ä½¿ç”¨äº†ä¸¤ç§ä¸åŒçš„ç¼–ç ï¼Œ è¡¨ 8-4 åˆ—å‡ºäº†æ¯ç§ç±»å‹çš„å¯¹è±¡å¯ä»¥ä½¿ç”¨çš„ç¼–ç ã€‚</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç¼–ç </th>
<th>å¯¹è±¡</th>
</tr>
</thead>
<tbody>
<tr>
<td>REDIS_STRING</td>
<td>REDIS_ENCODING_INT</td>
<td>ä½¿ç”¨æ•´æ•°å€¼å®ç°çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_STRING</td>
<td>REDIS_ENCODING_EMBSTR</td>
<td>ä½¿ç”¨ embstr ç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸²å®ç°çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_STRING</td>
<td>REDIS_ENCODING_RAW</td>
<td>ä½¿ç”¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²å®ç°çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_LIST</td>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>ä½¿ç”¨å‹ç¼©åˆ—è¡¨å®ç°çš„åˆ—è¡¨å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_LIST</td>
<td>REDIS_ENCODING_LINKEDLIST</td>
<td>ä½¿ç”¨åŒç«¯é“¾è¡¨å®ç°çš„åˆ—è¡¨å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_HASH</td>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>ä½¿ç”¨å‹ç¼©åˆ—è¡¨å®ç°çš„å“ˆå¸Œå¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_HASH</td>
<td>REDIS_ENCODING_HT</td>
<td>ä½¿ç”¨å­—å…¸å®ç°çš„å“ˆå¸Œå¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_SET</td>
<td>REDIS_ENCODING_INTSET</td>
<td>ä½¿ç”¨æ•´æ•°é›†åˆå®ç°çš„é›†åˆå¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_SET</td>
<td>REDIS_ENCODING_HT</td>
<td>ä½¿ç”¨å­—å…¸å®ç°çš„é›†åˆå¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_ZSET</td>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>ä½¿ç”¨å‹ç¼©åˆ—è¡¨å®ç°çš„æœ‰åºé›†åˆå¯¹è±¡ã€‚</td>
</tr>
<tr>
<td>REDIS_ZSET</td>
<td>REDIS_ENCODING_SKIPLIST</td>
<td>ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸å®ç°çš„æœ‰åºé›†åˆå¯¹è±¡ã€‚</td>
</tr>
</tbody>
</table>
<p>ä½¿ç”¨ OBJECT ENCODING å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªæ•°æ®åº“é”®çš„å€¼å¯¹è±¡çš„ç¼–ç ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SET msg <span class="string">"hello wrold"</span></span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING msg</span></div><div class="line">"embstr"</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> SET story <span class="string">"long long long long long long ago ..."</span></span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING story</span></div><div class="line">"raw"</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> SADD numbers 1 3 5</span></div><div class="line">(integer) 3</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING numbers</span></div><div class="line">"intset"</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> SADD numbers <span class="string">"seven"</span></span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING numbers</span></div><div class="line">"hashtable"</div></pre></td></tr></table></figure></p>
<p>è¡¨ 8-5 åˆ—å‡ºäº†ä¸åŒç¼–ç çš„å¯¹è±¡æ‰€å¯¹åº”çš„ OBJECT ENCODING å‘½ä»¤è¾“å‡ºã€‚</p>
<table>
<thead>
<tr>
<th>å¯¹è±¡æ‰€ä½¿ç”¨çš„åº•å±‚æ•°æ®ç»“æ„</th>
<th>ç¼–ç å¸¸é‡</th>
<th>OBJECT ENCODING å‘½ä»¤è¾“å‡º</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•´æ•°</td>
<td>REDIS_ENCODING_INT</td>
<td>â€œintâ€</td>
</tr>
<tr>
<td>embstr ç¼–ç çš„ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰</td>
<td>REDIS_ENCODING_EMBSTR</td>
<td>â€œembstrâ€</td>
</tr>
<tr>
<td>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</td>
<td>REDIS_ENCODING_RAW</td>
<td>â€œrawâ€</td>
</tr>
<tr>
<td>å­—å…¸</td>
<td>REDIS_ENCODING_HT</td>
<td>â€œhashtableâ€</td>
</tr>
<tr>
<td>åŒç«¯é“¾è¡¨</td>
<td>REDIS_ENCODING_LINKEDLIST</td>
<td>â€œlinkedlistâ€</td>
</tr>
<tr>
<td>å‹ç¼©åˆ—è¡¨</td>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>â€œziplistâ€</td>
</tr>
<tr>
<td>æ•´æ•°é›†åˆ</td>
<td>REDIS_ENCODING_INTSET</td>
<td>â€œintsetâ€</td>
</tr>
<tr>
<td>è·³è·ƒè¡¨å’Œå­—å…¸</td>
<td>REDIS_ENCODING_SKIPLIST</td>
<td>â€œskiplistâ€</td>
</tr>
</tbody>
</table>
<p>é€šè¿‡ encoding å±æ€§æ¥è®¾å®šå¯¹è±¡æ‰€ä½¿ç”¨çš„ç¼–ç ï¼Œ è€Œä¸æ˜¯ä¸ºç‰¹å®šç±»å‹çš„å¯¹è±¡å…³è”ä¸€ç§å›ºå®šçš„ç¼–ç ï¼Œ æå¤§åœ°æå‡äº† Redis çš„çµæ´»æ€§å’Œæ•ˆç‡ï¼Œ å› ä¸º Redis å¯ä»¥æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯æ¥ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®ä¸åŒçš„ç¼–ç ï¼Œ ä»è€Œä¼˜åŒ–å¯¹è±¡åœ¨æŸä¸€åœºæ™¯ä¸‹çš„æ•ˆç‡ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ åœ¨åˆ—è¡¨å¯¹è±¡åŒ…å«çš„å…ƒç´ æ¯”è¾ƒå°‘æ—¶ï¼Œ Redis ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåˆ—è¡¨å¯¹è±¡çš„åº•å±‚å®ç°ï¼š</p>
<ul>
<li>å› ä¸ºå‹ç¼©åˆ—è¡¨æ¯”åŒç«¯é“¾è¡¨æ›´èŠ‚çº¦å†…å­˜ï¼Œ å¹¶ä¸”åœ¨å…ƒç´ æ•°é‡è¾ƒå°‘æ—¶ï¼Œ åœ¨å†…å­˜ä¸­ä»¥è¿ç»­å—æ–¹å¼ä¿å­˜çš„å‹ç¼©åˆ—è¡¨æ¯”èµ·åŒç«¯é“¾è¡¨å¯ä»¥æ›´å¿«è¢«è½½å…¥åˆ°ç¼“å­˜ä¸­ï¼›</li>
<li>éšç€åˆ—è¡¨å¯¹è±¡åŒ…å«çš„å…ƒç´ è¶Šæ¥è¶Šå¤šï¼Œ ä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥ä¿å­˜å…ƒç´ çš„ä¼˜åŠ¿é€æ¸æ¶ˆå¤±æ—¶ï¼Œ å¯¹è±¡å°±ä¼šå°†åº•å±‚å®ç°ä»å‹ç¼©åˆ—è¡¨è½¬å‘åŠŸèƒ½æ›´å¼ºã€ä¹Ÿæ›´é€‚åˆä¿å­˜å¤§é‡å…ƒç´ çš„åŒç«¯é“¾è¡¨ä¸Šé¢ï¼›</li>
</ul>
<p>å…¶ä»–ç±»å‹çš„å¯¹è±¡ä¹Ÿä¼šé€šè¿‡ä½¿ç”¨å¤šç§ä¸åŒçš„ç¼–ç æ¥è¿›è¡Œç±»ä¼¼çš„ä¼˜åŒ–ã€‚</p>
<p>åœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­ï¼Œ æˆ‘ä»¬å°†åˆ†åˆ«ä»‹ç» Redis ä¸­çš„äº”ç§ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œ è¯´æ˜è¿™äº›å¯¹è±¡åº•å±‚æ‰€ä½¿ç”¨çš„ç¼–ç æ–¹å¼ï¼Œ åˆ—å‡ºå¯¹è±¡ä»ä¸€ç§ç¼–ç è½¬æ¢æˆå¦ä¸€ç§ç¼–ç æ‰€éœ€çš„æ¡ä»¶ï¼Œ ä»¥åŠåŒä¸€ä¸ªå‘½ä»¤åœ¨å¤šç§ä¸åŒç¼–ç ä¸Šçš„å®ç°æ–¹æ³•ã€‚</p>
<h1 id="å­—ç¬¦ä¸²å¯¹è±¡"><a href="#å­—ç¬¦ä¸²å¯¹è±¡" class="headerlink" title="å­—ç¬¦ä¸²å¯¹è±¡"></a>å­—ç¬¦ä¸²å¯¹è±¡</h1><p>å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ int ã€ raw æˆ–è€… embstr ã€‚</p>
<p>å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯æ•´æ•°å€¼ï¼Œ å¹¶ä¸”è¿™ä¸ªæ•´æ•°å€¼å¯ä»¥ç”¨ long ç±»å‹æ¥è¡¨ç¤ºï¼Œ é‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡ä¼šå°†æ•´æ•°å€¼ä¿å­˜åœ¨å­—ç¬¦ä¸²å¯¹è±¡ç»“æ„çš„ ptr å±æ€§é‡Œé¢ï¼ˆå°† void* è½¬æ¢æˆ long ï¼‰ï¼Œ å¹¶å°†å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º int ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ SET å‘½ä»¤ï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†åˆ›å»ºä¸€ä¸ªå¦‚å›¾ 8-1 æ‰€ç¤ºçš„ int ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ä½œä¸º number é”®çš„å€¼ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SET number 10086</span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING number</span></div><div class="line">"int"</div></pre></td></tr></table></figure></p>
<p><a href="http://idiotsky.me/images1/redis-object-1.png"><img src="http://idiotsky.me/images1/redis-object-1.png" alt=""></a><br>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œ å¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸²å€¼çš„é•¿åº¦å¤§äº 39 å­—èŠ‚ï¼Œ é‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡å°†ä½¿ç”¨ä¸€ä¸ªç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œ å¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º raw ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†åˆ›å»ºä¸€ä¸ªå¦‚å›¾ 8-2 æ‰€ç¤ºçš„ raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ä½œä¸º story é”®çš„å€¼ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SET story <span class="string">"Long, long, long ago there lived a king ..."</span></span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> STRLEN story</span></div><div class="line">(integer) 43</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING story</span></div><div class="line">"raw"</div></pre></td></tr></table></figure></p>
<p><a href="http://idiotsky.me/images1/redis-object-2.png"><img src="http://idiotsky.me/images1/redis-object-2.png" alt=""></a><br>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œ å¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸²å€¼çš„é•¿åº¦å°äºç­‰äº 39 å­—èŠ‚ï¼Œ é‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡å°†ä½¿ç”¨ embstr ç¼–ç çš„æ–¹å¼æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ã€‚</p>
<p>embstr ç¼–ç æ˜¯ä¸“é—¨ç”¨äºä¿å­˜çŸ­å­—ç¬¦ä¸²çš„ä¸€ç§ä¼˜åŒ–ç¼–ç æ–¹å¼ï¼Œ è¿™ç§ç¼–ç å’Œ raw ç¼–ç ä¸€æ ·ï¼Œ éƒ½ä½¿ç”¨ redisObject ç»“æ„å’Œ sdshdr ç»“æ„æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ ä½† raw ç¼–ç ä¼šè°ƒç”¨ä¸¤æ¬¡å†…å­˜åˆ†é…å‡½æ•°æ¥åˆ†åˆ«åˆ›å»º redisObject ç»“æ„å’Œ sdshdr ç»“æ„ï¼Œ è€Œ embstr ç¼–ç åˆ™é€šè¿‡è°ƒç”¨ä¸€æ¬¡å†…å­˜åˆ†é…å‡½æ•°æ¥åˆ†é…ä¸€å—è¿ç»­çš„ç©ºé—´ï¼Œ ç©ºé—´ä¸­ä¾æ¬¡åŒ…å« redisObject å’Œ sdshdr ä¸¤ä¸ªç»“æ„ï¼Œ å¦‚å›¾ 8-3 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images1/redis-object-3.png"><img src="http://idiotsky.me/images1/redis-object-3.png" alt=""></a><br>embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œ äº§ç”Ÿçš„æ•ˆæœå’Œ raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ‰§è¡Œå‘½ä»¤æ—¶äº§ç”Ÿçš„æ•ˆæœæ˜¯ç›¸åŒçš„ï¼Œ ä½†ä½¿ç”¨ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ¥ä¿å­˜çŸ­å­—ç¬¦ä¸²å€¼æœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p>
<p>embstr ç¼–ç å°†åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡æ‰€éœ€çš„å†…å­˜åˆ†é…æ¬¡æ•°ä» raw ç¼–ç çš„ä¸¤æ¬¡é™ä½ä¸ºä¸€æ¬¡ã€‚<br>é‡Šæ”¾ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åªéœ€è¦è°ƒç”¨ä¸€æ¬¡å†…å­˜é‡Šæ”¾å‡½æ•°ï¼Œ è€Œé‡Šæ”¾ raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡éœ€è¦è°ƒç”¨ä¸¤æ¬¡å†…å­˜é‡Šæ”¾å‡½æ•°ã€‚<br>å› ä¸º embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ä¸€å—è¿ç»­çš„å†…å­˜é‡Œé¢ï¼Œ æ‰€ä»¥è¿™ç§ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ¯”èµ· raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡èƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜å¸¦æ¥çš„ä¼˜åŠ¿ã€‚<br>ä½œä¸ºä¾‹å­ï¼Œ ä»¥ä¸‹å‘½ä»¤åˆ›å»ºäº†ä¸€ä¸ª embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ä½œä¸º msg é”®çš„å€¼ï¼Œ å€¼å¯¹è±¡çš„æ ·å­å¦‚å›¾ 8-4 æ‰€ç¤ºï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SET msg <span class="string">"hello"</span></span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING msg</span></div><div class="line">"embstr"</div></pre></td></tr></table></figure></p>
<p><a href="http://idiotsky.me/images1/redis-object-4.png"><img src="http://idiotsky.me/images1/redis-object-4.png" alt=""></a><br>æœ€åè¦è¯´çš„æ˜¯ï¼Œ å¯ä»¥ç”¨ long double ç±»å‹è¡¨ç¤ºçš„æµ®ç‚¹æ•°åœ¨ Redis ä¸­ä¹Ÿæ˜¯ä½œä¸ºå­—ç¬¦ä¸²å€¼æ¥ä¿å­˜çš„ï¼š å¦‚æœæˆ‘ä»¬è¦ä¿å­˜ä¸€ä¸ªæµ®ç‚¹æ•°åˆ°å­—ç¬¦ä¸²å¯¹è±¡é‡Œé¢ï¼Œ é‚£ä¹ˆç¨‹åºä¼šå…ˆå°†è¿™ä¸ªæµ®ç‚¹æ•°è½¬æ¢æˆå­—ç¬¦ä¸²å€¼ï¼Œ ç„¶åå†ä¿å­˜èµ·è½¬æ¢æ‰€å¾—çš„å­—ç¬¦ä¸²å€¼ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ æ‰§è¡Œä»¥ä¸‹ä»£ç å°†åˆ›å»ºä¸€ä¸ªåŒ…å« 3.14 çš„å­—ç¬¦ä¸²è¡¨ç¤º â€œ3.14â€ çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SET pi 3.14</span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING pi</span></div><div class="line">"embstr"</div></pre></td></tr></table></figure></p>
<p>åœ¨æœ‰éœ€è¦çš„æ—¶å€™ï¼Œ ç¨‹åºä¼šå°†ä¿å­˜åœ¨å­—ç¬¦ä¸²å¯¹è±¡é‡Œé¢çš„å­—ç¬¦ä¸²å€¼è½¬æ¢å›æµ®ç‚¹æ•°å€¼ï¼Œ æ‰§è¡ŒæŸäº›æ“ä½œï¼Œ ç„¶åå†å°†æ‰§è¡Œæ“ä½œæ‰€å¾—çš„æµ®ç‚¹æ•°å€¼è½¬æ¢å›å­—ç¬¦ä¸²å€¼ï¼Œ å¹¶ç»§ç»­ä¿å­˜åœ¨å­—ç¬¦ä¸²å¯¹è±¡é‡Œé¢ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ä»£ç çš„è¯ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> INCRBYFLOAT pi 2.0</span></div><div class="line">"5.14"</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING pi</span></div><div class="line">"embstr"</div></pre></td></tr></table></figure></p>
<p>é‚£ä¹ˆç¨‹åºé¦–å…ˆä¼šå–å‡ºå­—ç¬¦ä¸²å¯¹è±¡é‡Œé¢ä¿å­˜çš„å­—ç¬¦ä¸²å€¼ â€œ3.14â€ ï¼Œ å°†å®ƒè½¬æ¢å›æµ®ç‚¹æ•°å€¼ 3.14 ï¼Œ ç„¶åæŠŠ 3.14 å’Œ 2.0 ç›¸åŠ å¾—å‡ºçš„å€¼ 5.14 è½¬æ¢æˆå­—ç¬¦ä¸² â€œ5.14â€ ï¼Œ å¹¶å°†è¿™ä¸ª â€œ5.14â€ ä¿å­˜åˆ°å­—ç¬¦ä¸²å¯¹è±¡é‡Œé¢ã€‚</p>
<p>è¡¨ 8-6 æ€»ç»“å¹¶åˆ—å‡ºäº†å­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜å„ç§ä¸åŒç±»å‹çš„å€¼æ‰€ä½¿ç”¨çš„ç¼–ç æ–¹å¼ã€‚</p>
<table>
<thead>
<tr>
<th>å€¼</th>
<th>ç¼–ç </th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯ä»¥ç”¨ long ç±»å‹ä¿å­˜çš„æ•´æ•°ã€‚</td>
<td>int</td>
</tr>
<tr>
<td>å¯ä»¥ç”¨ long double ç±»å‹ä¿å­˜çš„æµ®ç‚¹æ•°ã€‚</td>
<td>embstr æˆ–è€… raw</td>
</tr>
<tr>
<td>å­—ç¬¦ä¸²å€¼ï¼Œ æˆ–è€…å› ä¸ºé•¿åº¦å¤ªå¤§è€Œæ²¡åŠæ³•ç”¨ long ç±»å‹è¡¨ç¤ºçš„æ•´æ•°ï¼Œ åˆæˆ–è€…å› ä¸ºé•¿åº¦å¤ªå¤§è€Œæ²¡åŠæ³•ç”¨ long double ç±»å‹è¡¨ç¤ºçš„æµ®ç‚¹æ•°ã€‚</td>
<td>embstr æˆ–è€… raw</td>
</tr>
</tbody>
</table>
<h2 id="ç¼–ç çš„è½¬æ¢"><a href="#ç¼–ç çš„è½¬æ¢" class="headerlink" title="ç¼–ç çš„è½¬æ¢"></a>ç¼–ç çš„è½¬æ¢</h2><p>int ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡å’Œ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ¡ä»¶æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œ ä¼šè¢«è½¬æ¢ä¸º raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚</p>
<p>å¯¹äº int ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ¥è¯´ï¼Œ å¦‚æœæˆ‘ä»¬å‘å¯¹è±¡æ‰§è¡Œäº†ä¸€äº›å‘½ä»¤ï¼Œ ä½¿å¾—è¿™ä¸ªå¯¹è±¡ä¿å­˜çš„ä¸å†æ˜¯æ•´æ•°å€¼ï¼Œ è€Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œ é‚£ä¹ˆå­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å°†ä» int å˜ä¸º raw ã€‚</p>
<p>åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œ æˆ‘ä»¬é€šè¿‡ APPEND å‘½ä»¤ï¼Œ å‘ä¸€ä¸ªä¿å­˜æ•´æ•°å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡è¿½åŠ äº†ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œ å› ä¸ºè¿½åŠ æ“ä½œåªèƒ½å¯¹å­—ç¬¦ä¸²å€¼æ‰§è¡Œï¼Œ æ‰€ä»¥ç¨‹åºä¼šå…ˆå°†ä¹‹å‰ä¿å­˜çš„æ•´æ•°å€¼ 10086 è½¬æ¢ä¸ºå­—ç¬¦ä¸²å€¼ â€œ10086â€ ï¼Œ ç„¶åå†æ‰§è¡Œè¿½åŠ æ“ä½œï¼Œ æ“ä½œçš„æ‰§è¡Œç»“æœå°±æ˜¯ä¸€ä¸ª raw ç¼–ç çš„ã€ä¿å­˜äº†å­—ç¬¦ä¸²å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SET number 10086</span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING number</span></div><div class="line">"int"</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> APPEND number <span class="string">" is a good number!"</span></span></div><div class="line">(integer) 23</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> GET number</span></div><div class="line">"10086 is a good number!"</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING number</span></div><div class="line">"raw"</div></pre></td></tr></table></figure></p>
<p>å¦å¤–ï¼Œ å› ä¸º Redis æ²¡æœ‰ä¸º embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ç¼–å†™ä»»ä½•ç›¸åº”çš„ä¿®æ”¹ç¨‹åº ï¼ˆåªæœ‰ int ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡å’Œ raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æœ‰è¿™äº›ç¨‹åºï¼‰ï¼Œ æ‰€ä»¥ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡å®é™…ä¸Šæ˜¯åªè¯»çš„ï¼š å½“æˆ‘ä»¬å¯¹ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ‰§è¡Œä»»ä½•ä¿®æ”¹å‘½ä»¤æ—¶ï¼Œ ç¨‹åºä¼šå…ˆå°†å¯¹è±¡çš„ç¼–ç ä» embstr è½¬æ¢æˆ raw ï¼Œ ç„¶åå†æ‰§è¡Œä¿®æ”¹å‘½ä»¤ï¼› å› ä¸ºè¿™ä¸ªåŸå› ï¼Œ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ‰§è¡Œä¿®æ”¹å‘½ä»¤ä¹‹åï¼Œ æ€»ä¼šå˜æˆä¸€ä¸ª raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚</p>
<p>ä»¥ä¸‹ä»£ç å±•ç¤ºäº†ä¸€ä¸ª embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ‰§è¡Œ APPEND å‘½ä»¤ä¹‹åï¼Œ å¯¹è±¡çš„ç¼–ç ä» embstr å˜ä¸º raw çš„ä¾‹å­ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SET msg <span class="string">"hello world"</span></span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING msg</span></div><div class="line">"embstr"</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> APPEND msg <span class="string">" again!"</span></span></div><div class="line">(integer) 18</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING msg</span></div><div class="line">"raw"</div></pre></td></tr></table></figure></p>
<h1 id="åˆ—è¡¨å¯¹è±¡"><a href="#åˆ—è¡¨å¯¹è±¡" class="headerlink" title="åˆ—è¡¨å¯¹è±¡"></a>åˆ—è¡¨å¯¹è±¡</h1><p>åˆ—è¡¨å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ ziplist æˆ–è€… linkedlist ã€‚</p>
<p>ziplist ç¼–ç çš„åˆ—è¡¨å¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œ æ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹ï¼ˆentryï¼‰ä¿å­˜äº†ä¸€ä¸ªåˆ—è¡¨å…ƒç´ ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ RPUSH å‘½ä»¤ï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†åˆ›å»ºä¸€ä¸ªåˆ—è¡¨å¯¹è±¡ä½œä¸º numbers é”®çš„å€¼ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> RPUSH numbers 1 <span class="string">"three"</span> 5</span></div><div class="line">(integer) 3</div></pre></td></tr></table></figure></p>
<p>å¦‚æœ numbers é”®çš„å€¼å¯¹è±¡ä½¿ç”¨çš„æ˜¯ ziplist ç¼–ç ï¼Œ è¿™ä¸ªè¿™ä¸ªå€¼å¯¹è±¡å°†ä¼šæ˜¯å›¾ 8-5 æ‰€å±•ç¤ºçš„æ ·å­ã€‚<br><a href="http://idiotsky.me/images1/redis-object-5.png"><img src="http://idiotsky.me/images1/redis-object-5.png" alt=""></a><br>å¦ä¸€æ–¹é¢ï¼Œ linkedlist ç¼–ç çš„åˆ—è¡¨å¯¹è±¡ä½¿ç”¨åŒç«¯é“¾è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œ æ¯ä¸ªåŒç«¯é“¾è¡¨èŠ‚ç‚¹ï¼ˆnodeï¼‰éƒ½ä¿å­˜äº†ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ è€Œæ¯ä¸ªå­—ç¬¦ä¸²å¯¹è±¡éƒ½ä¿å­˜äº†ä¸€ä¸ªåˆ—è¡¨å…ƒç´ ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœå‰é¢æ‰€è¯´çš„ numbers é”®åˆ›å»ºçš„åˆ—è¡¨å¯¹è±¡ä½¿ç”¨çš„ä¸æ˜¯ ziplist ç¼–ç ï¼Œ è€Œæ˜¯ linkedlist ç¼–ç ï¼Œ é‚£ä¹ˆ numbers é”®çš„å€¼å¯¹è±¡å°†æ˜¯å›¾ 8-6 æ‰€ç¤ºçš„æ ·å­ã€‚<br><a href="http://idiotsky.me/images1/redis-object-6.png"><img src="http://idiotsky.me/images1/redis-object-6.png" alt=""></a><br>æ³¨æ„ï¼Œ linkedlist ç¼–ç çš„åˆ—è¡¨å¯¹è±¡åœ¨åº•å±‚çš„åŒç«¯é“¾è¡¨ç»“æ„ä¸­åŒ…å«äº†å¤šä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ è¿™ç§åµŒå¥—å­—ç¬¦ä¸²å¯¹è±¡çš„è¡Œä¸ºåœ¨ç¨åä»‹ç»çš„å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡ä¸­éƒ½ä¼šå‡ºç°ï¼Œ å­—ç¬¦ä¸²å¯¹è±¡æ˜¯ Redis äº”ç§ç±»å‹çš„å¯¹è±¡ä¸­å”¯ä¸€ä¸€ç§ä¼šè¢«å…¶ä»–å››ç§ç±»å‹å¯¹è±¡åµŒå¥—çš„å¯¹è±¡ã€‚</p>
<h2 id="ç¼–ç è½¬æ¢"><a href="#ç¼–ç è½¬æ¢" class="headerlink" title="ç¼–ç è½¬æ¢"></a>ç¼–ç è½¬æ¢</h2><p>å½“åˆ—è¡¨å¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œ åˆ—è¡¨å¯¹è±¡ä½¿ç”¨ ziplist ç¼–ç ï¼š</p>
<ol>
<li>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº 64 å­—èŠ‚ï¼›</li>
<li>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 512 ä¸ªï¼›</li>
</ol>
<p>ä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„åˆ—è¡¨å¯¹è±¡éœ€è¦ä½¿ç”¨ linkedlist ç¼–ç ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong><br>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œ å…·ä½“è¯·çœ‹é…ç½®æ–‡ä»¶ä¸­å…³äº list-max-ziplist-value é€‰é¡¹å’Œ list-max-ziplist-entries é€‰é¡¹çš„è¯´æ˜ã€‚</p>
</blockquote>
<p>å¯¹äºä½¿ç”¨ ziplist ç¼–ç çš„åˆ—è¡¨å¯¹è±¡æ¥è¯´ï¼Œ å½“ä½¿ç”¨ ziplist ç¼–ç æ‰€éœ€çš„ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œ å¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œï¼š åŸæœ¬ä¿å­˜åœ¨å‹ç¼©åˆ—è¡¨é‡Œçš„æ‰€æœ‰åˆ—è¡¨å…ƒç´ éƒ½ä¼šè¢«è½¬ç§»å¹¶ä¿å­˜åˆ°åŒç«¯é“¾è¡¨é‡Œé¢ï¼Œ å¯¹è±¡çš„ç¼–ç ä¹Ÿä¼šä» ziplist å˜ä¸º linkedlist ã€‚</p>
<p>ä»¥ä¸‹ä»£ç å±•ç¤ºäº†åˆ—è¡¨å¯¹è±¡å› ä¸ºä¿å­˜äº†é•¿åº¦å¤ªå¤§çš„å…ƒç´ è€Œè¿›è¡Œç¼–ç è½¬æ¢çš„æƒ…å†µï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> æ‰€æœ‰å…ƒç´ çš„é•¿åº¦éƒ½å°äº 64 å­—èŠ‚</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> RPUSH blah <span class="string">"hello"</span> <span class="string">"world"</span> <span class="string">"again"</span></span></div><div class="line">(integer) 3</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING blah</span></div><div class="line">"ziplist"</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> å°†ä¸€ä¸ª 65 å­—èŠ‚é•¿çš„å…ƒç´ æ¨å…¥åˆ—è¡¨å¯¹è±¡ä¸­</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> RPUSH blah <span class="string">"wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww"</span></span></div><div class="line">(integer) 4</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> ç¼–ç å·²æ”¹å˜</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> OBJECT ENCODING blah</span></div><div class="line">"linkedlist"</div></pre></td></tr></table></figure></p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ ä»¥ä¸‹ä»£ç å±•ç¤ºäº†åˆ—è¡¨å¯¹è±¡å› ä¸ºä¿å­˜çš„å…ƒç´ æ•°é‡è¿‡å¤šè€Œè¿›è¡Œç¼–ç è½¬æ¢çš„æƒ…å†µï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> åˆ—è¡¨å¯¹è±¡åŒ…å« 512 ä¸ªå…ƒç´ </span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> EVAL <span class="string">"for i=1,512 do redis.call('RPUSH', KEYS[1], i) end"</span> 1 <span class="string">"integers"</span></span></div><div class="line">(nil)</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> LLEN integers</span></div><div class="line">(integer) 512</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING integers</span></div><div class="line">"ziplist"</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> å†å‘åˆ—è¡¨å¯¹è±¡æ¨å…¥ä¸€ä¸ªæ–°å…ƒç´ ï¼Œä½¿å¾—å¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡è¾¾åˆ° 513 ä¸ª</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> RPUSH integers 513</span></div><div class="line">(integer) 513</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> ç¼–ç å·²æ”¹å˜</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> OBJECT ENCODING integers</span></div><div class="line">"linkedlist"</div></pre></td></tr></table></figure></p>
<h1 id="å“ˆå¸Œå¯¹è±¡"><a href="#å“ˆå¸Œå¯¹è±¡" class="headerlink" title="å“ˆå¸Œå¯¹è±¡"></a>å“ˆå¸Œå¯¹è±¡</h1><p>å“ˆå¸Œå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ ziplist æˆ–è€… hashtable ã€‚</p>
<p>ziplist ç¼–ç çš„å“ˆå¸Œå¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œ æ¯å½“æœ‰æ–°çš„é”®å€¼å¯¹è¦åŠ å…¥åˆ°å“ˆå¸Œå¯¹è±¡æ—¶ï¼Œ ç¨‹åºä¼šå…ˆå°†ä¿å­˜äº†é”®çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¨å…¥åˆ°å‹ç¼©åˆ—è¡¨è¡¨å°¾ï¼Œ ç„¶åå†å°†ä¿å­˜äº†å€¼çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¨å…¥åˆ°å‹ç¼©åˆ—è¡¨è¡¨å°¾ï¼Œ å› æ­¤ï¼š</p>
<ul>
<li>ä¿å­˜äº†åŒä¸€é”®å€¼å¯¹çš„ä¸¤ä¸ªèŠ‚ç‚¹æ€»æ˜¯ç´§æŒ¨åœ¨ä¸€èµ·ï¼Œ ä¿å­˜é”®çš„èŠ‚ç‚¹åœ¨å‰ï¼Œ ä¿å­˜å€¼çš„èŠ‚ç‚¹åœ¨åï¼›</li>
<li>å…ˆæ·»åŠ åˆ°å“ˆå¸Œå¯¹è±¡ä¸­çš„é”®å€¼å¯¹ä¼šè¢«æ”¾åœ¨å‹ç¼©åˆ—è¡¨çš„è¡¨å¤´æ–¹å‘ï¼Œ è€Œåæ¥æ·»åŠ åˆ°å“ˆå¸Œå¯¹è±¡ä¸­çš„é”®å€¼å¯¹ä¼šè¢«æ”¾åœ¨å‹ç¼©åˆ—è¡¨çš„è¡¨å°¾æ–¹å‘ã€‚</li>
</ul>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ HSET å‘½ä»¤ï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†åˆ›å»ºä¸€ä¸ªåˆ—è¡¨å¯¹è±¡ä½œä¸º profile é”®çš„å€¼ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> HSET profile name <span class="string">"Tom"</span></span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> HSET profile age 25</span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> HSET profile career <span class="string">"Programmer"</span></span></div><div class="line">(integer) 1</div></pre></td></tr></table></figure></p>
<p>å¦‚æœ profile é”®çš„å€¼å¯¹è±¡ä½¿ç”¨çš„æ˜¯ ziplist ç¼–ç ï¼Œ é‚£ä¹ˆè¿™ä¸ªå€¼å¯¹è±¡å°†ä¼šæ˜¯å›¾ 8-9 æ‰€ç¤ºçš„æ ·å­ï¼Œ å…¶ä¸­å¯¹è±¡æ‰€ä½¿ç”¨çš„å‹ç¼©åˆ—è¡¨å¦‚å›¾ 8-10 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images1/redis-object-9.png"><img src="http://idiotsky.me/images1/redis-object-9.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-object-10.png"><img src="http://idiotsky.me/images1/redis-object-10.png" alt=""></a></p>
<p>å¦ä¸€æ–¹é¢ï¼Œ hashtable ç¼–ç çš„å“ˆå¸Œå¯¹è±¡ä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ï¼Œ å“ˆå¸Œå¯¹è±¡ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹éƒ½ä½¿ç”¨ä¸€ä¸ªå­—å…¸é”®å€¼å¯¹æ¥ä¿å­˜ï¼š</p>
<ul>
<li>å­—å…¸çš„æ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ å¯¹è±¡ä¸­ä¿å­˜äº†é”®å€¼å¯¹çš„é”®ï¼›</li>
<li>å­—å…¸çš„æ¯ä¸ªå€¼éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ å¯¹è±¡ä¸­ä¿å­˜äº†é”®å€¼å¯¹çš„å€¼ã€‚</li>
</ul>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœå‰é¢ profile é”®åˆ›å»ºçš„ä¸æ˜¯ ziplist ç¼–ç çš„å“ˆå¸Œå¯¹è±¡ï¼Œ è€Œæ˜¯ hashtable ç¼–ç çš„å“ˆå¸Œå¯¹è±¡ï¼Œ é‚£ä¹ˆè¿™ä¸ªå“ˆå¸Œå¯¹è±¡åº”è¯¥ä¼šæ˜¯å›¾ 8-11 æ‰€ç¤ºçš„æ ·å­ã€‚<br><a href="http://idiotsky.me/images1/redis-object-11.png"><img src="http://idiotsky.me/images1/redis-object-11.png" alt=""></a></p>
<h2 id="ç¼–ç è½¬æ¢-1"><a href="#ç¼–ç è½¬æ¢-1" class="headerlink" title="ç¼–ç è½¬æ¢"></a>ç¼–ç è½¬æ¢</h2><p>å½“å“ˆå¸Œå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œ å“ˆå¸Œå¯¹è±¡ä½¿ç”¨ ziplist ç¼–ç ï¼š</p>
<ol>
<li>å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰é”®å€¼å¯¹çš„é”®å’Œå€¼çš„å­—ç¬¦ä¸²é•¿åº¦éƒ½å°äº 64 å­—èŠ‚ï¼›</li>
<li>å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å°äº 512 ä¸ªï¼›</li>
</ol>
<p>ä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„å“ˆå¸Œå¯¹è±¡éœ€è¦ä½¿ç”¨ hashtable ç¼–ç ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong><br>è¿™ä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œ å…·ä½“è¯·çœ‹é…ç½®æ–‡ä»¶ä¸­å…³äº hash-max-ziplist-value é€‰é¡¹å’Œ hash-max-ziplist-entries é€‰é¡¹çš„è¯´æ˜ã€‚</p>
</blockquote>
<p>å¯¹äºä½¿ç”¨ ziplist ç¼–ç çš„åˆ—è¡¨å¯¹è±¡æ¥è¯´ï¼Œ å½“ä½¿ç”¨ ziplist ç¼–ç æ‰€éœ€çš„ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œ å¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œï¼š åŸæœ¬ä¿å­˜åœ¨å‹ç¼©åˆ—è¡¨é‡Œçš„æ‰€æœ‰é”®å€¼å¯¹éƒ½ä¼šè¢«è½¬ç§»å¹¶ä¿å­˜åˆ°å­—å…¸é‡Œé¢ï¼Œ å¯¹è±¡çš„ç¼–ç ä¹Ÿä¼šä» ziplist å˜ä¸º hashtable ã€‚</p>
<p>ä»¥ä¸‹ä»£ç å±•ç¤ºäº†å“ˆå¸Œå¯¹è±¡å› ä¸ºé”®å€¼å¯¹çš„é”®é•¿åº¦å¤ªå¤§è€Œå¼•èµ·ç¼–ç è½¬æ¢çš„æƒ…å†µï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> å“ˆå¸Œå¯¹è±¡åªåŒ…å«ä¸€ä¸ªé”®å’Œå€¼éƒ½ä¸è¶…è¿‡ 64 ä¸ªå­—èŠ‚çš„é”®å€¼å¯¹</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> HSET book name <span class="string">"Mastering C++ in 21 days"</span></span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING book</span></div><div class="line">"ziplist"</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> å‘å“ˆå¸Œå¯¹è±¡æ·»åŠ ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹ï¼Œé”®çš„é•¿åº¦ä¸º 66 å­—èŠ‚</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> HSET book long_long_long_long_long_long_long_long_long_long_long_description <span class="string">"content"</span></span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> ç¼–ç å·²æ”¹å˜</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> OBJECT ENCODING book</span></div><div class="line">"hashtable"</div></pre></td></tr></table></figure></p>
<p>é™¤äº†é”®çš„é•¿åº¦å¤ªå¤§ä¼šå¼•èµ·ç¼–ç è½¬æ¢ä¹‹å¤–ï¼Œ å€¼çš„é•¿åº¦å¤ªå¤§ä¹Ÿä¼šå¼•èµ·ç¼–ç è½¬æ¢ï¼Œ ä»¥ä¸‹ä»£ç å±•ç¤ºäº†è¿™ç§æƒ…å†µçš„ä¸€ä¸ªç¤ºä¾‹ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> å“ˆå¸Œå¯¹è±¡åªåŒ…å«ä¸€ä¸ªé”®å’Œå€¼éƒ½ä¸è¶…è¿‡ 64 ä¸ªå­—èŠ‚çš„é”®å€¼å¯¹</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> HSET blah greeting <span class="string">"hello world"</span></span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING blah</span></div><div class="line">"ziplist"</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> å‘å“ˆå¸Œå¯¹è±¡æ·»åŠ ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹ï¼Œå€¼çš„é•¿åº¦ä¸º 68 å­—èŠ‚</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> HSET blah story <span class="string">"many string ... many string ... many string ... many string ... many"</span></span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> ç¼–ç å·²æ”¹å˜</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> OBJECT ENCODING blah</span></div><div class="line">"hashtable"</div></pre></td></tr></table></figure></p>
<p>æœ€åï¼Œ ä»¥ä¸‹ä»£ç å±•ç¤ºäº†å“ˆå¸Œå¯¹è±¡å› ä¸ºåŒ…å«çš„é”®å€¼å¯¹æ•°é‡è¿‡å¤šè€Œå¼•èµ·ç¼–ç è½¬æ¢çš„æƒ…å†µï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºä¸€ä¸ªåŒ…å« 512 ä¸ªé”®å€¼å¯¹çš„å“ˆå¸Œå¯¹è±¡</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> EVAL <span class="string">"for i=1, 512 do redis.call('HSET', KEYS[1], i, i) end"</span> 1 <span class="string">"numbers"</span></span></div><div class="line">(nil)</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> HLEN numbers</span></div><div class="line">(integer) 512</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING numbers</span></div><div class="line">"ziplist"</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> å†å‘å“ˆå¸Œå¯¹è±¡æ·»åŠ ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹ï¼Œä½¿å¾—é”®å€¼å¯¹çš„æ•°é‡å˜æˆ 513 ä¸ª</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> HMSET numbers <span class="string">"key"</span> <span class="string">"value"</span></span></div><div class="line">OK</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> HLEN numbers</span></div><div class="line">(integer) 513</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> ç¼–ç æ”¹å˜</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> OBJECT ENCODING numbers</span></div><div class="line">"hashtable"</div></pre></td></tr></table></figure></p>
<h1 id="é›†åˆå¯¹è±¡"><a href="#é›†åˆå¯¹è±¡" class="headerlink" title="é›†åˆå¯¹è±¡"></a>é›†åˆå¯¹è±¡</h1><p>é›†åˆå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ intset æˆ–è€… hashtable ã€‚</p>
<p>intset ç¼–ç çš„é›†åˆå¯¹è±¡ä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºåº•å±‚å®ç°ï¼Œ é›†åˆå¯¹è±¡åŒ…å«çš„æ‰€æœ‰å…ƒç´ éƒ½è¢«ä¿å­˜åœ¨æ•´æ•°é›†åˆé‡Œé¢ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ ä»¥ä¸‹ä»£ç å°†åˆ›å»ºä¸€ä¸ªå¦‚å›¾ 8-12 æ‰€ç¤ºçš„ intset ç¼–ç é›†åˆå¯¹è±¡ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SADD numbers 1 3 5</span></div><div class="line">(integer) 3</div></pre></td></tr></table></figure></p>
<p><a href="http://idiotsky.me/images1/redis-object-12.png"><img src="http://idiotsky.me/images1/redis-object-12.png" alt=""></a><br>å¦ä¸€æ–¹é¢ï¼Œ hashtable ç¼–ç çš„é›†åˆå¯¹è±¡ä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ï¼Œ å­—å…¸çš„æ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ æ¯ä¸ªå­—ç¬¦ä¸²å¯¹è±¡åŒ…å«äº†ä¸€ä¸ªé›†åˆå…ƒç´ ï¼Œ è€Œå­—å…¸çš„å€¼åˆ™å…¨éƒ¨è¢«è®¾ç½®ä¸º NULL ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ ä»¥ä¸‹ä»£ç å°†åˆ›å»ºä¸€ä¸ªå¦‚å›¾ 8-13 æ‰€ç¤ºçš„ hashtable ç¼–ç é›†åˆå¯¹è±¡ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SADD fruits <span class="string">"apple"</span> <span class="string">"banana"</span> <span class="string">"cherry"</span></span></div><div class="line">(integer) 3</div></pre></td></tr></table></figure></p>
<p><a href="http://idiotsky.me/images1/redis-object-13.png"><img src="http://idiotsky.me/images1/redis-object-13.png" alt=""></a></p>
<h2 id="ç¼–ç çš„è½¬æ¢-1"><a href="#ç¼–ç çš„è½¬æ¢-1" class="headerlink" title="ç¼–ç çš„è½¬æ¢"></a>ç¼–ç çš„è½¬æ¢</h2><p>å½“é›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œ å¯¹è±¡ä½¿ç”¨ intset ç¼–ç ï¼š</p>
<ol>
<li>é›†åˆå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼ï¼›</li>
<li>é›†åˆå¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡ä¸è¶…è¿‡ 512 ä¸ªï¼›</li>
</ol>
<p>ä¸èƒ½æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„é›†åˆå¯¹è±¡éœ€è¦ä½¿ç”¨ hashtable ç¼–ç ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong><br>ç¬¬äºŒä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œ å…·ä½“è¯·çœ‹é…ç½®æ–‡ä»¶ä¸­å…³äº set-max-intset-entries é€‰é¡¹çš„è¯´æ˜ã€‚</p>
</blockquote>
<p>å¯¹äºä½¿ç”¨ intset ç¼–ç çš„é›†åˆå¯¹è±¡æ¥è¯´ï¼Œ å½“ä½¿ç”¨ intset ç¼–ç æ‰€éœ€çš„ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œ å¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œï¼š åŸæœ¬ä¿å­˜åœ¨æ•´æ•°é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šè¢«è½¬ç§»å¹¶ä¿å­˜åˆ°å­—å…¸é‡Œé¢ï¼Œ å¹¶ä¸”å¯¹è±¡çš„ç¼–ç ä¹Ÿä¼šä» intset å˜ä¸º hashtable ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ ä»¥ä¸‹ä»£ç åˆ›å»ºäº†ä¸€ä¸ªåªåŒ…å«æ•´æ•°å…ƒç´ çš„é›†åˆå¯¹è±¡ï¼Œ è¯¥å¯¹è±¡çš„ç¼–ç ä¸º intset ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SADD numbers 1 3 5</span></div><div class="line">(integer) 3</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING numbers</span></div><div class="line">"intset"</div></pre></td></tr></table></figure></p>
<p>ä¸è¿‡ï¼Œ åªè¦æˆ‘ä»¬å‘è¿™ä¸ªåªåŒ…å«æ•´æ•°å…ƒç´ çš„é›†åˆå¯¹è±¡æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²å…ƒç´ ï¼Œ é›†åˆå¯¹è±¡çš„ç¼–ç è½¬ç§»æ“ä½œå°±ä¼šè¢«æ‰§è¡Œï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SADD numbers <span class="string">"seven"</span></span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING numbers</span></div><div class="line">"hashtable"</div></pre></td></tr></table></figure></p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ å¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å« 512 ä¸ªæ•´æ•°å…ƒç´ çš„é›†åˆå¯¹è±¡ï¼Œ é‚£ä¹ˆå¯¹è±¡çš„ç¼–ç åº”è¯¥ä¼šæ˜¯ intset ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> EVAL <span class="string">"for i=1, 512 do redis.call('SADD', KEYS[1], i) end"</span> 1 integers</span></div><div class="line">(nil)</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> SCARD integers</span></div><div class="line">(integer) 512</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING integers</span></div><div class="line">"intset"</div></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯ï¼Œ åªè¦æˆ‘ä»¬å†å‘é›†åˆæ·»åŠ ä¸€ä¸ªæ–°çš„æ•´æ•°å…ƒç´ ï¼Œ ä½¿å¾—è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡å˜æˆ 513 ï¼Œ é‚£ä¹ˆå¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> SADD integers 10086</span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> SCARD integers</span></div><div class="line">(integer) 513</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING integers</span></div><div class="line">"hashtable"</div></pre></td></tr></table></figure></p>
<h1 id="æœ‰åºé›†åˆå¯¹è±¡"><a href="#æœ‰åºé›†åˆå¯¹è±¡" class="headerlink" title="æœ‰åºé›†åˆå¯¹è±¡"></a>æœ‰åºé›†åˆå¯¹è±¡</h1><p>æœ‰åºé›†åˆçš„ç¼–ç å¯ä»¥æ˜¯ ziplist æˆ–è€… skiplist ã€‚</p>
<p>ziplist ç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œ æ¯ä¸ªé›†åˆå…ƒç´ ä½¿ç”¨ä¸¤ä¸ªç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜ï¼Œ ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„æˆå‘˜ï¼ˆmemberï¼‰ï¼Œ è€Œç¬¬äºŒä¸ªå…ƒç´ åˆ™ä¿å­˜å…ƒç´ çš„åˆ†å€¼ï¼ˆscoreï¼‰ã€‚</p>
<p>å‹ç¼©åˆ—è¡¨å†…çš„é›†åˆå…ƒç´ æŒ‰åˆ†å€¼ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œ åˆ†å€¼è¾ƒå°çš„å…ƒç´ è¢«æ”¾ç½®åœ¨é è¿‘è¡¨å¤´çš„æ–¹å‘ï¼Œ è€Œåˆ†å€¼è¾ƒå¤§çš„å…ƒç´ åˆ™è¢«æ”¾ç½®åœ¨é è¿‘è¡¨å°¾çš„æ–¹å‘ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ ZADD å‘½ä»¤ï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†åˆ›å»ºä¸€ä¸ªæœ‰åºé›†åˆå¯¹è±¡ä½œä¸º price é”®çš„å€¼ï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">redis&gt;</span><span class="bash"> ZADD price 8.5 apple 5.0 banana 6.0 cherry</span></div><div class="line">(integer) 3</div></pre></td></tr></table></figure></p>
<p>å¦‚æœ price é”®çš„å€¼å¯¹è±¡ä½¿ç”¨çš„æ˜¯ ziplist ç¼–ç ï¼Œ é‚£ä¹ˆè¿™ä¸ªå€¼å¯¹è±¡å°†ä¼šæ˜¯å›¾ 8-14 æ‰€ç¤ºçš„æ ·å­ï¼Œ è€Œå¯¹è±¡æ‰€ä½¿ç”¨çš„å‹ç¼©åˆ—è¡¨åˆ™ä¼šæ˜¯ 8-15 æ‰€ç¤ºçš„æ ·å­ã€‚<br><a href="http://idiotsky.me/images1/redis-object-14.png"><img src="http://idiotsky.me/images1/redis-object-14.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-object-15.png"><img src="http://idiotsky.me/images1/redis-object-15.png" alt=""></a><br>skiplist ç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨ zset ç»“æ„ä½œä¸ºåº•å±‚å®ç°ï¼Œ ä¸€ä¸ª zset ç»“æ„åŒæ—¶åŒ…å«ä¸€ä¸ªå­—å…¸å’Œä¸€ä¸ªè·³è·ƒè¡¨ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zset</span> &#123;</span></div><div class="line"></div><div class="line">    zskiplist *zsl;</div><div class="line"></div><div class="line">    dict *dict;</div><div class="line"></div><div class="line">&#125; zset;</div></pre></td></tr></table></figure></p>
<p>zset ç»“æ„ä¸­çš„ zsl è·³è·ƒè¡¨æŒ‰åˆ†å€¼ä»å°åˆ°å¤§ä¿å­˜äº†æ‰€æœ‰é›†åˆå…ƒç´ ï¼Œ æ¯ä¸ªè·³è·ƒè¡¨èŠ‚ç‚¹éƒ½ä¿å­˜äº†ä¸€ä¸ªé›†åˆå…ƒç´ ï¼š è·³è·ƒè¡¨èŠ‚ç‚¹çš„ object å±æ€§ä¿å­˜äº†å…ƒç´ çš„æˆå‘˜ï¼Œ è€Œè·³è·ƒè¡¨èŠ‚ç‚¹çš„ score å±æ€§åˆ™ä¿å­˜äº†å…ƒç´ çš„åˆ†å€¼ã€‚ é€šè¿‡è¿™ä¸ªè·³è·ƒè¡¨ï¼Œ ç¨‹åºå¯ä»¥å¯¹æœ‰åºé›†åˆè¿›è¡ŒèŒƒå›´å‹æ“ä½œï¼Œ æ¯”å¦‚ ZRANK ã€ ZRANGE ç­‰å‘½ä»¤å°±æ˜¯åŸºäºè·³è·ƒè¡¨ API æ¥å®ç°çš„ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ zset ç»“æ„ä¸­çš„ dict å­—å…¸ä¸ºæœ‰åºé›†åˆåˆ›å»ºäº†ä¸€ä¸ªä»æˆå‘˜åˆ°åˆ†å€¼çš„æ˜ å°„ï¼Œ å­—å…¸ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹éƒ½ä¿å­˜äº†ä¸€ä¸ªé›†åˆå…ƒç´ ï¼š å­—å…¸çš„é”®ä¿å­˜äº†å…ƒç´ çš„æˆå‘˜ï¼Œ è€Œå­—å…¸çš„å€¼åˆ™ä¿å­˜äº†å…ƒç´ çš„åˆ†å€¼ã€‚ é€šè¿‡è¿™ä¸ªå­—å…¸ï¼Œ ç¨‹åºå¯ä»¥ç”¨ O(1) å¤æ‚åº¦æŸ¥æ‰¾ç»™å®šæˆå‘˜çš„åˆ†å€¼ï¼Œ ZSCORE å‘½ä»¤å°±æ˜¯æ ¹æ®è¿™ä¸€ç‰¹æ€§å®ç°çš„ï¼Œ è€Œå¾ˆå¤šå…¶ä»–æœ‰åºé›†åˆå‘½ä»¤éƒ½åœ¨å®ç°çš„å†…éƒ¨ç”¨åˆ°äº†è¿™ä¸€ç‰¹æ€§ã€‚</p>
<p>æœ‰åºé›†åˆæ¯ä¸ªå…ƒç´ çš„æˆå‘˜éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ è€Œæ¯ä¸ªå…ƒç´ çš„åˆ†å€¼éƒ½æ˜¯ä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ è™½ç„¶ zset ç»“æ„åŒæ—¶ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸æ¥ä¿å­˜æœ‰åºé›†åˆå…ƒç´ ï¼Œ ä½†è¿™ä¸¤ç§æ•°æ®ç»“æ„éƒ½ä¼šé€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œ æ‰€ä»¥åŒæ—¶ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸æ¥ä¿å­˜é›†åˆå…ƒç´ ä¸ä¼šäº§ç”Ÿä»»ä½•é‡å¤æˆå‘˜æˆ–è€…åˆ†å€¼ï¼Œ ä¹Ÿä¸ä¼šå› æ­¤è€Œæµªè´¹é¢å¤–çš„å†…å­˜ã€‚</p>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆæœ‰åºé›†åˆéœ€è¦åŒæ—¶ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸æ¥å®ç°ï¼Ÿ</strong><br>åœ¨ç†è®ºä¸Šæ¥è¯´ï¼Œ æœ‰åºé›†åˆå¯ä»¥å•ç‹¬ä½¿ç”¨å­—å…¸æˆ–è€…è·³è·ƒè¡¨çš„å…¶ä¸­ä¸€ç§æ•°æ®ç»“æ„æ¥å®ç°ï¼Œ ä½†æ— è®ºå•ç‹¬ä½¿ç”¨å­—å…¸è¿˜æ˜¯è·³è·ƒè¡¨ï¼Œ åœ¨æ€§èƒ½ä¸Šå¯¹æ¯”èµ·åŒæ—¶ä½¿ç”¨å­—å…¸å’Œè·³è·ƒè¡¨éƒ½ä¼šæœ‰æ‰€é™ä½ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæˆ‘ä»¬åªä½¿ç”¨å­—å…¸æ¥å®ç°æœ‰åºé›†åˆï¼Œ é‚£ä¹ˆè™½ç„¶ä»¥ O(1) å¤æ‚åº¦æŸ¥æ‰¾æˆå‘˜çš„åˆ†å€¼è¿™ä¸€ç‰¹æ€§ä¼šè¢«ä¿ç•™ï¼Œ ä½†æ˜¯ï¼Œ å› ä¸ºå­—å…¸ä»¥æ— åºçš„æ–¹å¼æ¥ä¿å­˜é›†åˆå…ƒç´ ï¼Œ æ‰€ä»¥æ¯æ¬¡åœ¨æ‰§è¡ŒèŒƒå›´å‹æ“ä½œ â€”â€” æ¯”å¦‚ ZRANK ã€ ZRANGE ç­‰å‘½ä»¤æ—¶ï¼Œ ç¨‹åºéƒ½éœ€è¦å¯¹å­—å…¸ä¿å­˜çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œæ’åºï¼Œ å®Œæˆè¿™ç§æ’åºéœ€è¦è‡³å°‘ O(N \log N) æ—¶é—´å¤æ‚åº¦ï¼Œ ä»¥åŠé¢å¤–çš„ O(N) å†…å­˜ç©ºé—´ ï¼ˆå› ä¸ºè¦åˆ›å»ºä¸€ä¸ªæ•°ç»„æ¥ä¿å­˜æ’åºåçš„å…ƒç´ ï¼‰ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œ å¦‚æœæˆ‘ä»¬åªä½¿ç”¨è·³è·ƒè¡¨æ¥å®ç°æœ‰åºé›†åˆï¼Œ é‚£ä¹ˆè·³è·ƒè¡¨æ‰§è¡ŒèŒƒå›´å‹æ“ä½œçš„æ‰€æœ‰ä¼˜ç‚¹éƒ½ä¼šè¢«ä¿ç•™ï¼Œ ä½†å› ä¸ºæ²¡æœ‰äº†å­—å…¸ï¼Œ æ‰€ä»¥æ ¹æ®æˆå‘˜æŸ¥æ‰¾åˆ†å€¼è¿™ä¸€æ“ä½œçš„å¤æ‚åº¦å°†ä» O(1) ä¸Šå‡ä¸º O(\log N) ã€‚</p>
<p>å› ä¸ºä»¥ä¸ŠåŸå› ï¼Œ ä¸ºäº†è®©æœ‰åºé›†åˆçš„æŸ¥æ‰¾å’ŒèŒƒå›´å‹æ“ä½œéƒ½å°½å¯èƒ½å¿«åœ°æ‰§è¡Œï¼Œ Redis é€‰æ‹©äº†åŒæ—¶ä½¿ç”¨å­—å…¸å’Œè·³è·ƒè¡¨ä¸¤ç§æ•°æ®ç»“æ„æ¥å®ç°æœ‰åºé›†åˆã€‚</p>
</blockquote>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœå‰é¢ price é”®åˆ›å»ºçš„ä¸æ˜¯ ziplist ç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ï¼Œ è€Œæ˜¯ skiplist ç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ï¼Œ é‚£ä¹ˆè¿™ä¸ªæœ‰åºé›†åˆå¯¹è±¡å°†ä¼šæ˜¯å›¾ 8-16 æ‰€ç¤ºçš„æ ·å­ï¼Œ è€Œå¯¹è±¡æ‰€ä½¿ç”¨çš„ zset ç»“æ„å°†ä¼šæ˜¯å›¾ 8-17 æ‰€ç¤ºçš„æ ·å­ã€‚<br><a href="http://idiotsky.me/images1/redis-object-16.png"><img src="http://idiotsky.me/images1/redis-object-16.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-object-17.png"><img src="http://idiotsky.me/images1/redis-object-17.png" alt=""></a></p>
<blockquote>
<p><strong>æ³¨æ„</strong><br>ä¸ºäº†å±•ç¤ºæ–¹ä¾¿ï¼Œ å›¾ 8-17 åœ¨å­—å…¸å’Œè·³è·ƒè¡¨ä¸­é‡å¤å±•ç¤ºäº†å„ä¸ªå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œ ä½†åœ¨å®é™…ä¸­ï¼Œ å­—å…¸å’Œè·³è·ƒè¡¨ä¼šå…±äº«å…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œ æ‰€ä»¥å¹¶ä¸ä¼šé€ æˆä»»ä½•æ•°æ®é‡å¤ï¼Œ ä¹Ÿä¸ä¼šå› æ­¤è€Œæµªè´¹ä»»ä½•å†…å­˜ã€‚</p>
</blockquote>
<h2 id="ç¼–ç çš„è½¬æ¢-2"><a href="#ç¼–ç çš„è½¬æ¢-2" class="headerlink" title="ç¼–ç çš„è½¬æ¢"></a>ç¼–ç çš„è½¬æ¢</h2><p>å½“æœ‰åºé›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œ å¯¹è±¡ä½¿ç”¨ ziplist ç¼–ç ï¼š</p>
<ol>
<li>æœ‰åºé›†åˆä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 128 ä¸ªï¼›</li>
<li>æœ‰åºé›†åˆä¿å­˜çš„æ‰€æœ‰å…ƒç´ æˆå‘˜çš„é•¿åº¦éƒ½å°äº 64 å­—èŠ‚ï¼›</li>
</ol>
<p>ä¸èƒ½æ»¡è¶³ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„æœ‰åºé›†åˆå¯¹è±¡å°†ä½¿ç”¨ skiplist ç¼–ç ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong><br>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œ å…·ä½“è¯·çœ‹é…ç½®æ–‡ä»¶ä¸­å…³äº zset-max-ziplist-entries é€‰é¡¹å’Œ zset-max-ziplist-value é€‰é¡¹çš„è¯´æ˜ã€‚</p>
</blockquote>
<p>å¯¹äºä½¿ç”¨ ziplist ç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡æ¥è¯´ï¼Œ å½“ä½¿ç”¨ ziplist ç¼–ç æ‰€éœ€çš„ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œ ç¨‹åºå°±ä¼šæ‰§è¡Œç¼–ç è½¬æ¢æ“ä½œï¼Œ å°†åŸæœ¬å‚¨å­˜åœ¨å‹ç¼©åˆ—è¡¨é‡Œé¢çš„æ‰€æœ‰é›†åˆå…ƒç´ è½¬ç§»åˆ° zset ç»“æ„é‡Œé¢ï¼Œ å¹¶å°†å¯¹è±¡çš„ç¼–ç ä» ziplist æ”¹ä¸º skiplist ã€‚</p>
<p>ä»¥ä¸‹ä»£ç å±•ç¤ºäº†æœ‰åºé›†åˆå¯¹è±¡å› ä¸ºåŒ…å«äº†è¿‡å¤šå…ƒç´ è€Œå¼•å‘ç¼–ç è½¬æ¢çš„æƒ…å†µï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> å¯¹è±¡åŒ…å«äº† 128 ä¸ªå…ƒç´ </span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> EVAL <span class="string">"for i=1, 128 do redis.call('ZADD', KEYS[1], i, i) end"</span> 1 numbers</span></div><div class="line">(nil)</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> ZCARD numbers</span></div><div class="line">(integer) 128</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING numbers</span></div><div class="line">"ziplist"</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> å†æ·»åŠ ä¸€ä¸ªæ–°å…ƒç´ </span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> ZADD numbers 3.14 pi</span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> å¯¹è±¡åŒ…å«çš„å…ƒç´ æ•°é‡å˜ä¸º 129 ä¸ª</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> ZCARD numbers</span></div><div class="line">(integer) 129</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> ç¼–ç å·²æ”¹å˜</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> OBJECT ENCODING numbers</span></div><div class="line">"skiplist"</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸‹ä»£ç åˆ™å±•ç¤ºäº†æœ‰åºé›†åˆå¯¹è±¡å› ä¸ºå…ƒç´ çš„æˆå‘˜è¿‡é•¿è€Œå¼•å‘ç¼–ç è½¬æ¢çš„æƒ…å†µï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> å‘æœ‰åºé›†åˆæ·»åŠ ä¸€ä¸ªæˆå‘˜åªæœ‰ä¸‰å­—èŠ‚é•¿çš„å…ƒç´ </span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> ZADD blah 1.0 www</span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">redis&gt;<span class="bash"> OBJECT ENCODING blah</span></div><div class="line">"ziplist"</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> å‘æœ‰åºé›†åˆæ·»åŠ ä¸€ä¸ªæˆå‘˜ä¸º 66 å­—èŠ‚é•¿çš„å…ƒç´ </span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> ZADD blah 2.0 oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo</span></div><div class="line">(integer) 1</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> ç¼–ç å·²æ”¹å˜</span></div><div class="line"><span class="meta">redis&gt;</span><span class="bash"> OBJECT ENCODING blah</span></div><div class="line">"skiplist"</div></pre></td></tr></table></figure></p>
<h1 id="é‡ç‚¹å›é¡¾"><a href="#é‡ç‚¹å›é¡¾" class="headerlink" title="é‡ç‚¹å›é¡¾"></a>é‡ç‚¹å›é¡¾</h1><ul>
<li>Redis æ•°æ®åº“ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹çš„é”®å’Œå€¼éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</li>
<li>Redis å…±æœ‰å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å“ˆå¸Œã€é›†åˆã€æœ‰åºé›†åˆäº”ç§ç±»å‹çš„å¯¹è±¡ï¼Œ æ¯ç§ç±»å‹çš„å¯¹è±¡è‡³å°‘éƒ½æœ‰ä¸¤ç§æˆ–ä»¥ä¸Šçš„ç¼–ç æ–¹å¼ï¼Œ ä¸åŒçš„ç¼–ç å¯ä»¥åœ¨ä¸åŒçš„ä½¿ç”¨åœºæ™¯ä¸Šä¼˜åŒ–å¯¹è±¡çš„ä½¿ç”¨æ•ˆç‡ã€‚</li>
</ul>
<p>å‚è€ƒ <a href="http://redisbook.com" target="_blank" rel="external">http://redisbook.com</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;åœ¨å‰é¢çš„æ•°ä¸ªç« èŠ‚é‡Œï¼Œ æˆ‘ä»¬é™†ç»­ä»‹ç»äº† Redis ç”¨åˆ°çš„æ‰€æœ‰ä¸»è¦æ•°æ®ç»“æ„ï¼Œ æ¯”å¦‚ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰ã€åŒç«¯é“¾è¡¨ã€å­—å…¸ã€å‹ç¼©åˆ—è¡¨ã€æ•´æ•°é›†åˆï¼Œ ç­‰ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;Redis å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨è¿™äº›æ•°æ®ç»“æ„æ¥å®ç°é”®å€¼å¯¹æ•°æ®åº“ï¼Œ è€Œæ˜¯åŸºäºè¿™äº›æ•°æ®ç»“æ„åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿï¼Œ è¿™ä¸ªç³»ç»ŸåŒ…å«å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡è¿™äº”ç§ç±»å‹çš„å¯¹è±¡ï¼Œ æ¯ç§å¯¹è±¡éƒ½ç”¨åˆ°äº†è‡³å°‘ä¸€ç§æˆ‘ä»¬å‰é¢æ‰€ä»‹ç»çš„æ•°æ®ç»“æ„ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡è¿™äº”ç§ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œ Redis å¯ä»¥åœ¨æ‰§è¡Œå‘½ä»¤ä¹‹å‰ï¼Œ æ ¹æ®å¯¹è±¡çš„ç±»å‹æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥æ‰§è¡Œç»™å®šçš„å‘½ä»¤ã€‚ ä½¿ç”¨å¯¹è±¡çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œ æˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œ ä¸ºå¯¹è±¡è®¾ç½®å¤šç§ä¸åŒçš„æ•°æ®ç»“æ„å®ç°ï¼Œ ä»è€Œä¼˜åŒ–å¯¹è±¡åœ¨ä¸åŒåœºæ™¯ä¸‹çš„ä½¿ç”¨æ•ˆç‡ã€‚&lt;/p&gt;
&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œ Redis çš„å¯¹è±¡ç³»ç»Ÿè¿˜å®ç°äº†åŸºäºå¼•ç”¨è®¡æ•°æŠ€æœ¯çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼š å½“ç¨‹åºä¸å†ä½¿ç”¨æŸä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œ è¿™ä¸ªå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜å°±ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼› å¦å¤–ï¼Œ Redis è¿˜é€šè¿‡å¼•ç”¨è®¡æ•°æŠ€æœ¯å®ç°äº†å¯¹è±¡å…±äº«æœºåˆ¶ï¼Œ è¿™ä¸€æœºåˆ¶å¯ä»¥åœ¨é€‚å½“çš„æ¡ä»¶ä¸‹ï¼Œ é€šè¿‡è®©å¤šä¸ªæ•°æ®åº“é”®å…±äº«åŒä¸€ä¸ªå¯¹è±¡æ¥èŠ‚çº¦å†…å­˜ã€‚&lt;/p&gt;
&lt;p&gt;æœ€åï¼Œ Redis çš„å¯¹è±¡å¸¦æœ‰è®¿é—®æ—¶é—´è®°å½•ä¿¡æ¯ï¼Œ è¯¥ä¿¡æ¯å¯ä»¥ç”¨äºè®¡ç®—æ•°æ®åº“é”®çš„ç©ºè½¬æ—¶é•¿ï¼Œ åœ¨æœåŠ¡å™¨å¯ç”¨äº† maxmemory åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œ ç©ºè½¬æ—¶é•¿è¾ƒå¤§çš„é‚£äº›é”®å¯èƒ½ä¼šä¼˜å…ˆè¢«æœåŠ¡å™¨åˆ é™¤ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬ç« æ¥ä¸‹æ¥å°†é€ä¸€ä»‹ç»ä»¥ä¸Šæåˆ°çš„ Redis å¯¹è±¡ç³»ç»Ÿçš„å„ä¸ªç‰¹æ€§ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="redis" scheme="http://idiotsky.me/categories/redis/"/>
    
    
      <category term="æ•°æ®ç»“æ„" scheme="http://idiotsky.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="redis" scheme="http://idiotsky.me/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisæ•°æ®ç»“æ„-å‹ç¼©åˆ—è¡¨</title>
    <link href="http://idiotsky.me/2017/09/17/redis-ziplist/"/>
    <id>http://idiotsky.me/2017/09/17/redis-ziplist/</id>
    <published>2017-09-17T14:07:30.000Z</published>
    <updated>2017-09-29T15:15:01.029Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰æ˜¯åˆ—è¡¨é”®å’Œå“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚<br>å½“ä¸€ä¸ªåˆ—è¡¨é”®åªåŒ…å«å°‘é‡åˆ—è¡¨é¡¹ï¼Œ å¹¶ä¸”æ¯ä¸ªåˆ—è¡¨é¡¹è¦ä¹ˆå°±æ˜¯å°æ•´æ•°å€¼ï¼Œ è¦ä¹ˆå°±æ˜¯é•¿åº¦æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²ï¼Œ é‚£ä¹ˆ Redis å°±ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥åšåˆ—è¡¨é”®çš„åº•å±‚å®ç°ã€‚</p>
</blockquote>
<h1 id="å‹ç¼©åˆ—è¡¨çš„æ„æˆ"><a href="#å‹ç¼©åˆ—è¡¨çš„æ„æˆ" class="headerlink" title="å‹ç¼©åˆ—è¡¨çš„æ„æˆ"></a>å‹ç¼©åˆ—è¡¨çš„æ„æˆ</h1><p>å‹ç¼©åˆ—è¡¨æ˜¯ Redis ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„ï¼Œ ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹ï¼ˆsequentialï¼‰æ•°æ®ç»“æ„ã€‚<br>ä¸€ä¸ªå‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹ï¼ˆentryï¼‰ï¼Œ æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼ã€‚<br>å›¾ 7-1 å±•ç¤ºäº†å‹ç¼©åˆ—è¡¨çš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼Œ è¡¨ 7-1 åˆ™è®°å½•äº†å„ä¸ªç»„æˆéƒ¨åˆ†çš„ç±»å‹ã€é•¿åº¦ã€ä»¥åŠç”¨é€”ã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-1.png"><img src="http://idiotsky.me/images1/redis-ziplist-1.png" alt=""></a></p>
<p>è¡¨ 7-1 å‹ç¼©åˆ—è¡¨å„ä¸ªç»„æˆéƒ¨åˆ†çš„è¯¦ç»†è¯´æ˜</p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>ç±»å‹</th>
<th>é•¿åº¦</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td>zlbytes</td>
<td>uint32_t</td>
<td>4 å­—èŠ‚</td>
<td>è®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°ï¼šåœ¨å¯¹å‹ç¼©åˆ—è¡¨è¿›è¡Œå†…å­˜é‡åˆ†é…ï¼Œ æˆ–è€…è®¡ç®— zlend çš„ä½ç½®æ—¶ä½¿ç”¨ã€‚</td>
</tr>
<tr>
<td>zltail</td>
<td>uint32_t</td>
<td>4 å­—èŠ‚</td>
<td>è®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»å‹ç¼©åˆ—è¡¨çš„èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼š é€šè¿‡è¿™ä¸ªåç§»é‡ï¼Œç¨‹åºæ— é¡»éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨å°±å¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€ã€‚</td>
</tr>
<tr>
<td>zllen</td>
<td>uint16_t</td>
<td>2 å­—èŠ‚</td>
<td>è®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ï¼š å½“è¿™ä¸ªå±æ€§çš„å€¼å°äº UINT16_MAX ï¼ˆ65535ï¼‰æ—¶ï¼Œ è¿™ä¸ªå±æ€§çš„å€¼å°±æ˜¯å‹ç¼©åˆ—è¡¨åŒ…å«èŠ‚ç‚¹çš„æ•°é‡ï¼› å½“è¿™ä¸ªå€¼ç­‰äº UINT16_MAX æ—¶ï¼Œ èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡ºã€‚</td>
</tr>
<tr>
<td>entryX</td>
<td>åˆ—è¡¨èŠ‚ç‚¹</td>
<td>ä¸å®š</td>
<td>å‹ç¼©åˆ—è¡¨åŒ…å«çš„å„ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®šã€‚</td>
</tr>
<tr>
<td>zlend</td>
<td>uint8_t</td>
<td>1 å­—èŠ‚</td>
<td>ç‰¹æ®Šå€¼ 0xFF ï¼ˆåè¿›åˆ¶ 255 ï¼‰ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯ã€‚</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<p>å›¾ 7-2 å±•ç¤ºäº†ä¸€ä¸ªå‹ç¼©åˆ—è¡¨ç¤ºä¾‹ï¼š</p>
<ul>
<li>åˆ—è¡¨ zlbytes å±æ€§çš„å€¼ä¸º 0x50 ï¼ˆåè¿›åˆ¶ 80ï¼‰ï¼Œ è¡¨ç¤ºå‹ç¼©åˆ—è¡¨çš„æ€»é•¿ä¸º 80 å­—èŠ‚ã€‚</li>
<li>åˆ—è¡¨ zltail å±æ€§çš„å€¼ä¸º 0x3c ï¼ˆåè¿›åˆ¶ 60ï¼‰ï¼Œ è¿™è¡¨ç¤ºå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæŒ‡å‘å‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„æŒ‡é’ˆ p ï¼Œ é‚£ä¹ˆåªè¦ç”¨æŒ‡é’ˆ p åŠ ä¸Šåç§»é‡ 60 ï¼Œ å°±å¯ä»¥è®¡ç®—å‡ºè¡¨å°¾èŠ‚ç‚¹ entry3 çš„åœ°å€ã€‚</li>
<li>åˆ—è¡¨ zllen å±æ€§çš„å€¼ä¸º 0x3 ï¼ˆåè¿›åˆ¶ 3ï¼‰ï¼Œ è¡¨ç¤ºå‹ç¼©åˆ—è¡¨åŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹ã€‚</li>
</ul>
<p><a href="http://idiotsky.me/images1/redis-ziplist-2.png"><img src="http://idiotsky.me/images1/redis-ziplist-2.png" alt=""></a><br>å›¾ 7-3 å±•ç¤ºäº†å¦ä¸€ä¸ªå‹ç¼©åˆ—è¡¨ç¤ºä¾‹ï¼š</p>
<ul>
<li>åˆ—è¡¨ zlbytes å±æ€§çš„å€¼ä¸º 0xd2 ï¼ˆåè¿›åˆ¶ 210ï¼‰ï¼Œ è¡¨ç¤ºå‹ç¼©åˆ—è¡¨çš„æ€»é•¿ä¸º 210 å­—èŠ‚ã€‚</li>
<li>åˆ—è¡¨ zltail å±æ€§çš„å€¼ä¸º 0xb3 ï¼ˆåè¿›åˆ¶ 179ï¼‰ï¼Œ è¿™è¡¨ç¤ºå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæŒ‡å‘å‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„æŒ‡é’ˆ p ï¼Œ é‚£ä¹ˆåªè¦ç”¨æŒ‡é’ˆ p åŠ ä¸Šåç§»é‡ 179 ï¼Œ å°±å¯ä»¥è®¡ç®—å‡ºè¡¨å°¾èŠ‚ç‚¹ entry5 çš„åœ°å€ã€‚</li>
<li>åˆ—è¡¨ zllen å±æ€§çš„å€¼ä¸º 0x5 ï¼ˆåè¿›åˆ¶ 5ï¼‰ï¼Œ è¡¨ç¤ºå‹ç¼©åˆ—è¡¨åŒ…å«äº”ä¸ªèŠ‚ç‚¹ã€‚</li>
</ul>
<p><a href="http://idiotsky.me/images1/redis-ziplist-3.png"><img src="http://idiotsky.me/images1/redis-ziplist-3.png" alt=""></a></p>
<h1 id="å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹çš„æ„æˆ"><a href="#å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹çš„æ„æˆ" class="headerlink" title="å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹çš„æ„æˆ"></a>å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹çš„æ„æˆ</h1><p>æ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼ï¼Œ å…¶ä¸­ï¼Œ å­—èŠ‚æ•°ç»„å¯ä»¥æ˜¯ä»¥ä¸‹ä¸‰ç§é•¿åº¦çš„å…¶ä¸­ä¸€ç§ï¼š</p>
<ol>
<li>é•¿åº¦å°äºç­‰äº 63 ï¼ˆ2^{6}-1ï¼‰å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ï¼›</li>
<li>é•¿åº¦å°äºç­‰äº 16383 ï¼ˆ2^{14}-1ï¼‰ å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ï¼›</li>
<li>é•¿åº¦å°äºç­‰äº 4294967295 ï¼ˆ2^{32}-1ï¼‰å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ï¼›</li>
</ol>
<p>è€Œæ•´æ•°å€¼åˆ™å¯ä»¥æ˜¯ä»¥ä¸‹å…­ç§é•¿åº¦çš„å…¶ä¸­ä¸€ç§ï¼š</p>
<ol>
<li>4 ä½é•¿ï¼Œä»‹äº 0 è‡³ 12 ä¹‹é—´çš„æ— ç¬¦å·æ•´æ•°ï¼›</li>
<li>1 å­—èŠ‚é•¿çš„æœ‰ç¬¦å·æ•´æ•°ï¼›</li>
<li>3 å­—èŠ‚é•¿çš„æœ‰ç¬¦å·æ•´æ•°ï¼›</li>
<li>int16_t ç±»å‹æ•´æ•°ï¼›</li>
<li>int32_t ç±»å‹æ•´æ•°ï¼›</li>
<li>int64_t ç±»å‹æ•´æ•°ã€‚</li>
</ol>
<p>æ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹éƒ½ç”± previous_entry_length ã€ encoding ã€ content ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œ å¦‚å›¾ 7-4 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-4.png"><img src="http://idiotsky.me/images1/redis-ziplist-4.png" alt=""></a><br>æ¥ä¸‹æ¥çš„å†…å®¹å°†åˆ†åˆ«ä»‹ç»è¿™ä¸‰ä¸ªç»„æˆéƒ¨åˆ†ã€‚</p>
<h2 id="previous-entry-length"><a href="#previous-entry-length" class="headerlink" title="previous_entry_length"></a>previous_entry_length</h2><p>èŠ‚ç‚¹çš„ previous_entry_length å±æ€§ä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œ è®°å½•äº†å‹ç¼©åˆ—è¡¨ä¸­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ã€‚</p>
<p>previous_entry_length å±æ€§çš„é•¿åº¦å¯ä»¥æ˜¯ 1 å­—èŠ‚æˆ–è€… 5 å­—èŠ‚ï¼š</p>
<ul>
<li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº 254 å­—èŠ‚ï¼Œ é‚£ä¹ˆ previous_entry_length å±æ€§çš„é•¿åº¦ä¸º 1 å­—èŠ‚ï¼š å‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°±ä¿å­˜åœ¨è¿™ä¸€ä¸ªå­—èŠ‚é‡Œé¢ã€‚</li>
<li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚ï¼Œ é‚£ä¹ˆ previous_entry_length å±æ€§çš„é•¿åº¦ä¸º 5 å­—èŠ‚ï¼š å…¶ä¸­å±æ€§çš„ç¬¬ä¸€å­—èŠ‚ä¼šè¢«è®¾ç½®ä¸º 0xFE ï¼ˆåè¿›åˆ¶å€¼ 254ï¼‰ï¼Œ è€Œä¹‹åçš„å››ä¸ªå­—èŠ‚åˆ™ç”¨äºä¿å­˜å‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦ã€‚</li>
</ul>
<p>å›¾ 7-5 å±•ç¤ºäº†ä¸€ä¸ªåŒ…å«ä¸€å­—èŠ‚é•¿ previous_entry_length å±æ€§çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹ï¼Œ å±æ€§çš„å€¼ä¸º 0x05 ï¼Œ è¡¨ç¤ºå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦ä¸º 5 å­—èŠ‚ã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-5.png"><img src="http://idiotsky.me/images1/redis-ziplist-5.png" alt=""></a><br>å›¾ 7-6 å±•ç¤ºäº†ä¸€ä¸ªåŒ…å«äº”å­—èŠ‚é•¿ previous_entry_length å±æ€§çš„å‹ç¼©èŠ‚ç‚¹ï¼Œ å±æ€§çš„å€¼ä¸º 0xFE00002766 ï¼Œ å…¶ä¸­å€¼çš„æœ€é«˜ä½å­—èŠ‚ 0xFE è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªäº”å­—èŠ‚é•¿çš„ previous_entry_length å±æ€§ï¼Œ è€Œä¹‹åçš„å››å­—èŠ‚ 0x00002766 ï¼ˆåè¿›åˆ¶å€¼ 10086 ï¼‰æ‰æ˜¯å‰ä¸€èŠ‚ç‚¹çš„å®é™…é•¿åº¦ã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-6.png"><img src="http://idiotsky.me/images1/redis-ziplist-6.png" alt=""></a></p>
<p>å› ä¸ºèŠ‚ç‚¹çš„ previous_entry_length å±æ€§è®°å½•äº†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼Œ æ‰€ä»¥ç¨‹åºå¯ä»¥é€šè¿‡æŒ‡é’ˆè¿ç®—ï¼Œ æ ¹æ®å½“å‰èŠ‚ç‚¹çš„èµ·å§‹åœ°å€æ¥è®¡ç®—å‡ºå‰ä¸€ä¸ªèŠ‚ç‚¹çš„èµ·å§‹åœ°å€ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªæŒ‡å‘å½“å‰èŠ‚ç‚¹èµ·å§‹åœ°å€çš„æŒ‡é’ˆ c ï¼Œ é‚£ä¹ˆæˆ‘ä»¬åªè¦ç”¨æŒ‡é’ˆ c å‡å»å½“å‰èŠ‚ç‚¹ previous_entry_length å±æ€§çš„å€¼ï¼Œ å°±å¯ä»¥å¾—å‡ºä¸€ä¸ªæŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹èµ·å§‹åœ°å€çš„æŒ‡é’ˆ p ï¼Œ å¦‚å›¾ 7-7 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-7.png"><img src="http://idiotsky.me/images1/redis-ziplist-7.png" alt=""></a></p>
<p>å‹ç¼©åˆ—è¡¨çš„ä»è¡¨å°¾å‘è¡¨å¤´éå†æ“ä½œå°±æ˜¯ä½¿ç”¨è¿™ä¸€åŸç†å®ç°çš„ï¼š åªè¦æˆ‘ä»¬æ‹¥æœ‰äº†ä¸€ä¸ªæŒ‡å‘æŸä¸ªèŠ‚ç‚¹èµ·å§‹åœ°å€çš„æŒ‡é’ˆï¼Œ é‚£ä¹ˆé€šè¿‡è¿™ä¸ªæŒ‡é’ˆä»¥åŠè¿™ä¸ªèŠ‚ç‚¹çš„ previous_entry_length å±æ€§ï¼Œ ç¨‹åºå°±å¯ä»¥ä¸€ç›´å‘å‰ä¸€ä¸ªèŠ‚ç‚¹å›æº¯ï¼Œ æœ€ç»ˆåˆ°è¾¾å‹ç¼©åˆ—è¡¨çš„è¡¨å¤´èŠ‚ç‚¹ã€‚</p>
<p>å›¾ 7-8 å±•ç¤ºäº†ä¸€ä¸ªä»è¡¨å°¾èŠ‚ç‚¹å‘è¡¨å¤´èŠ‚ç‚¹è¿›è¡Œéå†çš„å®Œæ•´è¿‡ç¨‹ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œæˆ‘ä»¬æ‹¥æœ‰æŒ‡å‘å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹ entry4 èµ·å§‹åœ°å€çš„æŒ‡é’ˆ p1 ï¼ˆæŒ‡å‘è¡¨å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆå¯ä»¥é€šè¿‡æŒ‡å‘å‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„æŒ‡é’ˆåŠ ä¸Š zltail å±æ€§çš„å€¼å¾—å‡ºï¼‰ï¼›</li>
<li>é€šè¿‡ç”¨ p1 å‡å» entry4 èŠ‚ç‚¹ previous_entry_length å±æ€§çš„å€¼ï¼Œ æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæŒ‡å‘ entry4 å‰ä¸€èŠ‚ç‚¹ entry3 èµ·å§‹åœ°å€çš„æŒ‡é’ˆ p2 ï¼›</li>
<li>é€šè¿‡ç”¨ p2 å‡å» entry3 èŠ‚ç‚¹ previous_entry_length å±æ€§çš„å€¼ï¼Œ æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæŒ‡å‘ entry3 å‰ä¸€èŠ‚ç‚¹ entry2 èµ·å§‹åœ°å€çš„æŒ‡é’ˆ p3 ï¼›</li>
<li>é€šè¿‡ç”¨ p3 å‡å» entry2 èŠ‚ç‚¹ previous_entry_length å±æ€§çš„å€¼ï¼Œ æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæŒ‡å‘ entry2 å‰ä¸€èŠ‚ç‚¹ entry1 èµ·å§‹åœ°å€çš„æŒ‡é’ˆ p4 ï¼Œ entry1 ä¸ºå‹ç¼©åˆ—è¡¨çš„è¡¨å¤´èŠ‚ç‚¹ï¼›</li>
<li>æœ€ç»ˆï¼Œ æˆ‘ä»¬ä»è¡¨å°¾èŠ‚ç‚¹å‘è¡¨å¤´èŠ‚ç‚¹éå†äº†æ•´ä¸ªåˆ—è¡¨ã€‚</li>
</ul>
<p><a href="http://idiotsky.me/images1/redis-ziplist-8.png"><img src="http://idiotsky.me/images1/redis-ziplist-8.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-ziplist-9.png"><img src="http://idiotsky.me/images1/redis-ziplist-9.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-ziplist-10.png"><img src="http://idiotsky.me/images1/redis-ziplist-10.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-ziplist-11.png"><img src="http://idiotsky.me/images1/redis-ziplist-11.png" alt=""></a></p>
<h2 id="encoding"><a href="#encoding" class="headerlink" title="encoding"></a>encoding</h2><p>èŠ‚ç‚¹çš„ encoding å±æ€§è®°å½•äº†èŠ‚ç‚¹çš„ content å±æ€§æ‰€ä¿å­˜æ•°æ®çš„ç±»å‹ä»¥åŠé•¿åº¦ï¼š</p>
<ul>
<li>ä¸€å­—èŠ‚ã€ä¸¤å­—èŠ‚æˆ–è€…äº”å­—èŠ‚é•¿ï¼Œ å€¼çš„æœ€é«˜ä½ä¸º 00 ã€ 01 æˆ–è€… 10 çš„æ˜¯å­—èŠ‚æ•°ç»„ç¼–ç ï¼š è¿™ç§ç¼–ç è¡¨ç¤ºèŠ‚ç‚¹çš„ content å±æ€§ä¿å­˜ç€å­—èŠ‚æ•°ç»„ï¼Œ æ•°ç»„çš„é•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•ï¼›</li>
<li>ä¸€å­—èŠ‚é•¿ï¼Œ å€¼çš„æœ€é«˜ä½ä»¥ 11 å¼€å¤´çš„æ˜¯æ•´æ•°ç¼–ç ï¼š è¿™ç§ç¼–ç è¡¨ç¤ºèŠ‚ç‚¹çš„ content å±æ€§ä¿å­˜ç€æ•´æ•°å€¼ï¼Œ æ•´æ•°å€¼çš„ç±»å‹å’Œé•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•ï¼›</li>
</ul>
<p>è¡¨ 7-2 è®°å½•äº†æ‰€æœ‰å¯ç”¨çš„å­—èŠ‚æ•°ç»„ç¼–ç ï¼Œ è€Œè¡¨ 7-3 åˆ™è®°å½•äº†æ‰€æœ‰å¯ç”¨çš„æ•´æ•°ç¼–ç ã€‚ è¡¨æ ¼ä¸­çš„ä¸‹åˆ’çº¿ _ è¡¨ç¤ºç•™ç©ºï¼Œ è€Œ b ã€ x ç­‰å˜é‡åˆ™ä»£è¡¨å®é™…çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œ ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œ å¤šä¸ªå­—èŠ‚ä¹‹é—´ç”¨ç©ºæ ¼éš”å¼€ã€‚</p>
<p>è¡¨ 7-2 å­—èŠ‚æ•°ç»„ç¼–ç </p>
<table>
<thead>
<tr>
<th>ç¼–ç </th>
<th>ç¼–ç é•¿åº¦</th>
<th>content å±æ€§ä¿å­˜çš„å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>00bbbbbb</td>
<td>1 å­—èŠ‚</td>
<td>é•¿åº¦å°äºç­‰äº 63 å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ã€‚</td>
</tr>
<tr>
<td>01bbbbbb xxxxxxxx</td>
<td>2 å­—èŠ‚</td>
<td>é•¿åº¦å°äºç­‰äº 16383 å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ã€‚</td>
</tr>
<tr>
<td>10<strong>__</strong> aaaaaaaa bbbbbbbb cccccccc dddddddd</td>
<td>5 å­—èŠ‚</td>
<td>é•¿åº¦å°äºç­‰äº 4294967295 çš„å­—èŠ‚æ•°ç»„ã€‚</td>
</tr>
</tbody>
</table>
<p>è¡¨ 7-3 æ•´æ•°ç¼–ç </p>
<table>
<thead>
<tr>
<th>ç¼–ç </th>
<th>ç¼–ç é•¿åº¦</th>
<th>content å±æ€§ä¿å­˜çš„å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>11000000</td>
<td>1 å­—èŠ‚</td>
<td>int16_t ç±»å‹çš„æ•´æ•°ã€‚</td>
</tr>
<tr>
<td>11010000</td>
<td>1 å­—èŠ‚</td>
<td>int32_t ç±»å‹çš„æ•´æ•°ã€‚</td>
</tr>
<tr>
<td>11100000</td>
<td>1 å­—èŠ‚</td>
<td>int64_t ç±»å‹çš„æ•´æ•°ã€‚</td>
</tr>
<tr>
<td>11110000</td>
<td>1 å­—èŠ‚</td>
<td>24 ä½æœ‰ç¬¦å·æ•´æ•°ã€‚</td>
</tr>
<tr>
<td>11111110</td>
<td>1 å­—èŠ‚</td>
<td>8 ä½æœ‰ç¬¦å·æ•´æ•°ã€‚</td>
</tr>
<tr>
<td>1111xxxx</td>
<td>1 å­—èŠ‚</td>
<td>ä½¿ç”¨è¿™ä¸€ç¼–ç çš„èŠ‚ç‚¹æ²¡æœ‰ç›¸åº”çš„ content å±æ€§ï¼Œ å› ä¸ºç¼–ç æœ¬èº«çš„ xxxx å››ä¸ªä½å·²ç»ä¿å­˜äº†ä¸€ä¸ªä»‹äº 0 å’Œ 12 ä¹‹é—´çš„å€¼ï¼Œ æ‰€ä»¥å®ƒæ— é¡» content å±æ€§ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="content"><a href="#content" class="headerlink" title="content"></a>content</h2><p>èŠ‚ç‚¹çš„ content å±æ€§è´Ÿè´£ä¿å­˜èŠ‚ç‚¹çš„å€¼ï¼Œ èŠ‚ç‚¹å€¼å¯ä»¥æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…æ•´æ•°ï¼Œ å€¼çš„ç±»å‹å’Œé•¿åº¦ç”±èŠ‚ç‚¹çš„ encoding å±æ€§å†³å®šã€‚</p>
<p>å›¾ 7-9 å±•ç¤ºäº†ä¸€ä¸ªä¿å­˜å­—èŠ‚æ•°ç»„çš„èŠ‚ç‚¹ç¤ºä¾‹ï¼š</p>
<ul>
<li>ç¼–ç çš„æœ€é«˜ä¸¤ä½ 00 è¡¨ç¤ºèŠ‚ç‚¹ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼›</li>
<li>ç¼–ç çš„åå…­ä½ 001011 è®°å½•äº†å­—èŠ‚æ•°ç»„çš„é•¿åº¦ 11 ï¼›</li>
<li>content å±æ€§ä¿å­˜ç€èŠ‚ç‚¹çš„å€¼ â€œhello worldâ€ ã€‚</li>
</ul>
<p><a href="http://idiotsky.me/images1/redis-ziplist-12.png"><img src="http://idiotsky.me/images1/redis-ziplist-12.png" alt=""></a></p>
<p>å›¾ 7-10 å±•ç¤ºäº†ä¸€ä¸ªä¿å­˜æ•´æ•°å€¼çš„èŠ‚ç‚¹ç¤ºä¾‹ï¼š</p>
<ul>
<li>ç¼–ç  11000000 è¡¨ç¤ºèŠ‚ç‚¹ä¿å­˜çš„æ˜¯ä¸€ä¸ª int16_t ç±»å‹çš„æ•´æ•°å€¼ï¼›</li>
<li>content å±æ€§ä¿å­˜ç€èŠ‚ç‚¹çš„å€¼ 10086 ã€‚</li>
</ul>
<p><a href="http://idiotsky.me/images1/redis-ziplist-13.png"><img src="http://idiotsky.me/images1/redis-ziplist-13.png" alt=""></a></p>
<h1 id="è¿é”æ›´æ–°"><a href="#è¿é”æ›´æ–°" class="headerlink" title="è¿é”æ›´æ–°"></a>è¿é”æ›´æ–°</h1><p>å‰é¢è¯´è¿‡ï¼Œ æ¯ä¸ªèŠ‚ç‚¹çš„ previous_entry_length å±æ€§éƒ½è®°å½•äº†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼š</p>
<ul>
<li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº 254 å­—èŠ‚ï¼Œ é‚£ä¹ˆ previous_entry_length å±æ€§éœ€è¦ç”¨ 1 å­—èŠ‚é•¿çš„ç©ºé—´æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ã€‚</li>
<li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚ï¼Œ é‚£ä¹ˆ previous_entry_length å±æ€§éœ€è¦ç”¨ 5 å­—èŠ‚é•¿çš„ç©ºé—´æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ã€‚</li>
</ul>
<p>ç°åœ¨ï¼Œ è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼š åœ¨ä¸€ä¸ªå‹ç¼©åˆ—è¡¨ä¸­ï¼Œ æœ‰å¤šä¸ªè¿ç»­çš„ã€é•¿åº¦ä»‹äº 250 å­—èŠ‚åˆ° 253 å­—èŠ‚ä¹‹é—´çš„èŠ‚ç‚¹ e1 è‡³ eN ï¼Œ å¦‚å›¾ 7-11 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-14.png"><img src="http://idiotsky.me/images1/redis-ziplist-14.png" alt=""></a><br>å› ä¸º e1 è‡³ eN çš„æ‰€æœ‰èŠ‚ç‚¹çš„é•¿åº¦éƒ½å°äº 254 å­—èŠ‚ï¼Œ æ‰€ä»¥è®°å½•è¿™äº›èŠ‚ç‚¹çš„é•¿åº¦åªéœ€è¦ 1 å­—èŠ‚é•¿çš„ previous_entry_length å±æ€§ï¼Œ æ¢å¥è¯è¯´ï¼Œ e1 è‡³ eN çš„æ‰€æœ‰èŠ‚ç‚¹çš„ previous_entry_length å±æ€§éƒ½æ˜¯ 1 å­—èŠ‚é•¿çš„ã€‚</p>
<p>è¿™æ—¶ï¼Œ å¦‚æœæˆ‘ä»¬å°†ä¸€ä¸ªé•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚çš„æ–°èŠ‚ç‚¹ new è®¾ç½®ä¸ºå‹ç¼©åˆ—è¡¨çš„è¡¨å¤´èŠ‚ç‚¹ï¼Œ é‚£ä¹ˆ new å°†æˆä¸º e1 çš„å‰ç½®èŠ‚ç‚¹ï¼Œ å¦‚å›¾ 7-12 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-15.png"><img src="http://idiotsky.me/images1/redis-ziplist-15.png" alt=""></a></p>
<p>å› ä¸º e1 çš„ previous_entry_length å±æ€§ä»…é•¿ 1 å­—èŠ‚ï¼Œ å®ƒæ²¡åŠæ³•ä¿å­˜æ–°èŠ‚ç‚¹ new çš„é•¿åº¦ï¼Œ æ‰€ä»¥ç¨‹åºå°†å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œ å¹¶å°† e1 èŠ‚ç‚¹çš„ previous_entry_length å±æ€§ä»åŸæ¥çš„ 1 å­—èŠ‚é•¿æ‰©å±•ä¸º 5 å­—èŠ‚é•¿ã€‚</p>
<p>ç°åœ¨ï¼Œ éº»çƒ¦çš„äº‹æƒ…æ¥äº† â€”â€” e1 åŸæœ¬çš„é•¿åº¦ä»‹äº 250 å­—èŠ‚è‡³ 253 å­—èŠ‚ä¹‹é—´ï¼Œ åœ¨ä¸º previous_entry_length å±æ€§æ–°å¢å››ä¸ªå­—èŠ‚çš„ç©ºé—´ä¹‹åï¼Œ e1 çš„é•¿åº¦å°±å˜æˆäº†ä»‹äº 254 å­—èŠ‚è‡³ 257 å­—èŠ‚ä¹‹é—´ï¼Œ è€Œè¿™ç§é•¿åº¦ä½¿ç”¨ 1 å­—èŠ‚é•¿çš„ previous_entry_length å±æ€§æ˜¯æ²¡åŠæ³•ä¿å­˜çš„ã€‚</p>
<p>å› æ­¤ï¼Œ ä¸ºäº†è®© e2 çš„ previous_entry_length å±æ€§å¯ä»¥è®°å½•ä¸‹ e1 çš„é•¿åº¦ï¼Œ ç¨‹åºéœ€è¦å†æ¬¡å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œ å¹¶å°† e2 èŠ‚ç‚¹çš„ previous_entry_length å±æ€§ä»åŸæ¥çš„ 1 å­—èŠ‚é•¿æ‰©å±•ä¸º 5 å­—èŠ‚é•¿ã€‚</p>
<p>æ­£å¦‚æ‰©å±• e1 å¼•å‘äº†å¯¹ e2 çš„æ‰©å±•ä¸€æ ·ï¼Œ æ‰©å±• e2 ä¹Ÿä¼šå¼•å‘å¯¹ e3 çš„æ‰©å±•ï¼Œ è€Œæ‰©å±• e3 åˆä¼šå¼•å‘å¯¹ e4 çš„æ‰©å±•â€¦â€¦ä¸ºäº†è®©æ¯ä¸ªèŠ‚ç‚¹çš„ previous_entry_length å±æ€§éƒ½ç¬¦åˆå‹ç¼©åˆ—è¡¨å¯¹èŠ‚ç‚¹çš„è¦æ±‚ï¼Œ ç¨‹åºéœ€è¦ä¸æ–­åœ°å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œ ç›´åˆ° eN ä¸ºæ­¢ã€‚</p>
<p>Redis å°†è¿™ç§åœ¨ç‰¹æ®Šæƒ…å†µä¸‹äº§ç”Ÿçš„è¿ç»­å¤šæ¬¡ç©ºé—´æ‰©å±•æ“ä½œç§°ä¹‹ä¸ºâ€œè¿é”æ›´æ–°â€ï¼ˆcascade updateï¼‰ï¼Œ å›¾ 7-13 å±•ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-16.png"><img src="http://idiotsky.me/images1/redis-ziplist-16.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-ziplist-17.png"><img src="http://idiotsky.me/images1/redis-ziplist-17.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-ziplist-18.png"><img src="http://idiotsky.me/images1/redis-ziplist-18.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-ziplist-19.png"><img src="http://idiotsky.me/images1/redis-ziplist-19.png" alt=""></a><br><a href="http://idiotsky.me/images1/redis-ziplist-20.png"><img src="http://idiotsky.me/images1/redis-ziplist-20.png" alt=""></a></p>
<p>é™¤äº†æ·»åŠ æ–°èŠ‚ç‚¹å¯èƒ½ä¼šå¼•å‘è¿é”æ›´æ–°ä¹‹å¤–ï¼Œ åˆ é™¤èŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¼šå¼•å‘è¿é”æ›´æ–°ã€‚</p>
<p>è€ƒè™‘å›¾ 7-14 æ‰€ç¤ºçš„å‹ç¼©åˆ—è¡¨ï¼Œ å¦‚æœ e1 è‡³ eN éƒ½æ˜¯å¤§å°ä»‹äº 250 å­—èŠ‚è‡³ 253 å­—èŠ‚çš„èŠ‚ç‚¹ï¼Œ big èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚ï¼ˆéœ€è¦ 5 å­—èŠ‚çš„ previous_entry_length æ¥ä¿å­˜ï¼‰ï¼Œ è€Œ small èŠ‚ç‚¹çš„é•¿åº¦å°äº 254 å­—èŠ‚ï¼ˆåªéœ€è¦ 1 å­—èŠ‚çš„ previous_entry_length æ¥ä¿å­˜ï¼‰ï¼Œ é‚£ä¹ˆå½“æˆ‘ä»¬å°† small èŠ‚ç‚¹ä»å‹ç¼©åˆ—è¡¨ä¸­åˆ é™¤ä¹‹åï¼Œ ä¸ºäº†è®© e1 çš„ previous_entry_length å±æ€§å¯ä»¥è®°å½• big èŠ‚ç‚¹çš„é•¿åº¦ï¼Œ ç¨‹åºå°†æ‰©å±• e1 çš„ç©ºé—´ï¼Œ å¹¶ç”±æ­¤å¼•å‘ä¹‹åçš„è¿é”æ›´æ–°ã€‚<br><a href="http://idiotsky.me/images1/redis-ziplist-21.png"><img src="http://idiotsky.me/images1/redis-ziplist-21.png" alt=""></a><br>å› ä¸ºè¿é”æ›´æ–°åœ¨æœ€åæƒ…å†µä¸‹éœ€è¦å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œ N æ¬¡ç©ºé—´é‡åˆ†é…æ“ä½œï¼Œ è€Œæ¯æ¬¡ç©ºé—´é‡åˆ†é…çš„æœ€åå¤æ‚åº¦ä¸º O(N) ï¼Œ æ‰€ä»¥è¿é”æ›´æ–°çš„æœ€åå¤æ‚åº¦ä¸º O(N^2) ã€‚</p>
<p>è¦æ³¨æ„çš„æ˜¯ï¼Œ å°½ç®¡è¿é”æ›´æ–°çš„å¤æ‚åº¦è¾ƒé«˜ï¼Œ ä½†å®ƒçœŸæ­£é€ æˆæ€§èƒ½é—®é¢˜çš„å‡ ç‡æ˜¯å¾ˆä½çš„ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œ å‹ç¼©åˆ—è¡¨é‡Œè¦æ°å¥½æœ‰å¤šä¸ªè¿ç»­çš„ã€é•¿åº¦ä»‹äº 250 å­—èŠ‚è‡³ 253 å­—èŠ‚ä¹‹é—´çš„èŠ‚ç‚¹ï¼Œ è¿é”æ›´æ–°æ‰æœ‰å¯èƒ½è¢«å¼•å‘ï¼Œ åœ¨å®é™…ä¸­ï¼Œ è¿™ç§æƒ…å†µå¹¶ä¸å¤šè§ï¼›</li>
<li>å…¶æ¬¡ï¼Œ å³ä½¿å‡ºç°è¿é”æ›´æ–°ï¼Œ ä½†åªè¦è¢«æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ä¸å¤šï¼Œ å°±ä¸ä¼šå¯¹æ€§èƒ½é€ æˆä»»ä½•å½±å“ï¼š æ¯”å¦‚è¯´ï¼Œ å¯¹ä¸‰äº”ä¸ªèŠ‚ç‚¹è¿›è¡Œè¿é”æ›´æ–°æ˜¯ç»å¯¹ä¸ä¼šå½±å“æ€§èƒ½çš„ï¼›</li>
</ul>
<p>å› ä¸ºä»¥ä¸ŠåŸå› ï¼Œ ziplistPush ç­‰å‘½ä»¤çš„å¹³å‡å¤æ‚åº¦ä»…ä¸º O(N) ï¼Œ åœ¨å®é™…ä¸­ï¼Œ æˆ‘ä»¬å¯ä»¥æ”¾å¿ƒåœ°ä½¿ç”¨è¿™äº›å‡½æ•°ï¼Œ è€Œä¸å¿…æ‹…å¿ƒè¿é”æ›´æ–°ä¼šå½±å“å‹ç¼©åˆ—è¡¨çš„æ€§èƒ½ã€‚</p>
<h1 id="é‡ç‚¹å›é¡¾"><a href="#é‡ç‚¹å›é¡¾" class="headerlink" title="é‡ç‚¹å›é¡¾"></a>é‡ç‚¹å›é¡¾</h1><ul>
<li>å‹ç¼©åˆ—è¡¨æ˜¯ä¸€ç§ä¸ºèŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„é¡ºåºå‹æ•°æ®ç»“æ„ã€‚</li>
<li>å‹ç¼©åˆ—è¡¨è¢«ç”¨ä½œåˆ—è¡¨é”®å’Œå“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚</li>
<li>å‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«å¤šä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…æ•´æ•°å€¼ã€‚</li>
<li>æ·»åŠ æ–°èŠ‚ç‚¹åˆ°å‹ç¼©åˆ—è¡¨ï¼Œ æˆ–è€…ä»å‹ç¼©åˆ—è¡¨ä¸­åˆ é™¤èŠ‚ç‚¹ï¼Œ å¯èƒ½ä¼šå¼•å‘è¿é”æ›´æ–°æ“ä½œï¼Œ ä½†è¿™ç§æ“ä½œå‡ºç°çš„å‡ ç‡å¹¶ä¸é«˜ã€‚</li>
</ul>
<p>å‚è€ƒ <a href="http://redisbook.com" target="_blank" rel="external">http://redisbook.com</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰æ˜¯åˆ—è¡¨é”®å’Œå“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚&lt;br&gt;å½“ä¸€ä¸ªåˆ—è¡¨é”®åªåŒ…å«å°‘é‡åˆ—è¡¨é¡¹ï¼Œ å¹¶ä¸”æ¯ä¸ªåˆ—è¡¨é¡¹è¦ä¹ˆå°±æ˜¯å°æ•´æ•°å€¼ï¼Œ è¦ä¹ˆå°±æ˜¯é•¿åº¦æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²ï¼Œ é‚£ä¹ˆ Redis å°±ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥åšåˆ—è¡¨é”®çš„åº•å±‚å®ç°ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;å‹ç¼©åˆ—è¡¨çš„æ„æˆ&quot;&gt;&lt;a href=&quot;#å‹ç¼©åˆ—è¡¨çš„æ„æˆ&quot; class=&quot;headerlink&quot; title=&quot;å‹ç¼©åˆ—è¡¨çš„æ„æˆ&quot;&gt;&lt;/a&gt;å‹ç¼©åˆ—è¡¨çš„æ„æˆ&lt;/h1&gt;&lt;p&gt;å‹ç¼©åˆ—è¡¨æ˜¯ Redis ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„ï¼Œ ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹ï¼ˆsequentialï¼‰æ•°æ®ç»“æ„ã€‚&lt;br&gt;ä¸€ä¸ªå‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹ï¼ˆentryï¼‰ï¼Œ æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼ã€‚&lt;br&gt;å›¾ 7-1 å±•ç¤ºäº†å‹ç¼©åˆ—è¡¨çš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼Œ è¡¨ 7-1 åˆ™è®°å½•äº†å„ä¸ªç»„æˆéƒ¨åˆ†çš„ç±»å‹ã€é•¿åº¦ã€ä»¥åŠç”¨é€”ã€‚&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images1/redis-ziplist-1.png&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images1/redis-ziplist-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¡¨ 7-1 å‹ç¼©åˆ—è¡¨å„ä¸ªç»„æˆéƒ¨åˆ†çš„è¯¦ç»†è¯´æ˜&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å±æ€§&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;é•¿åº¦&lt;/th&gt;
&lt;th&gt;ç”¨é€”&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;zlbytes&lt;/td&gt;
&lt;td&gt;uint32_t&lt;/td&gt;
&lt;td&gt;4 å­—èŠ‚&lt;/td&gt;
&lt;td&gt;è®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°ï¼šåœ¨å¯¹å‹ç¼©åˆ—è¡¨è¿›è¡Œå†…å­˜é‡åˆ†é…ï¼Œ æˆ–è€…è®¡ç®— zlend çš„ä½ç½®æ—¶ä½¿ç”¨ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;zltail&lt;/td&gt;
&lt;td&gt;uint32_t&lt;/td&gt;
&lt;td&gt;4 å­—èŠ‚&lt;/td&gt;
&lt;td&gt;è®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»å‹ç¼©åˆ—è¡¨çš„èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼š é€šè¿‡è¿™ä¸ªåç§»é‡ï¼Œç¨‹åºæ— é¡»éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨å°±å¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;zllen&lt;/td&gt;
&lt;td&gt;uint16_t&lt;/td&gt;
&lt;td&gt;2 å­—èŠ‚&lt;/td&gt;
&lt;td&gt;è®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ï¼š å½“è¿™ä¸ªå±æ€§çš„å€¼å°äº UINT16_MAX ï¼ˆ65535ï¼‰æ—¶ï¼Œ è¿™ä¸ªå±æ€§çš„å€¼å°±æ˜¯å‹ç¼©åˆ—è¡¨åŒ…å«èŠ‚ç‚¹çš„æ•°é‡ï¼› å½“è¿™ä¸ªå€¼ç­‰äº UINT16_MAX æ—¶ï¼Œ èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡ºã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;entryX&lt;/td&gt;
&lt;td&gt;åˆ—è¡¨èŠ‚ç‚¹&lt;/td&gt;
&lt;td&gt;ä¸å®š&lt;/td&gt;
&lt;td&gt;å‹ç¼©åˆ—è¡¨åŒ…å«çš„å„ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®šã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;zlend&lt;/td&gt;
&lt;td&gt;uint8_t&lt;/td&gt;
&lt;td&gt;1 å­—èŠ‚&lt;/td&gt;
&lt;td&gt;ç‰¹æ®Šå€¼ 0xFF ï¼ˆåè¿›åˆ¶ 255 ï¼‰ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
      <category term="redis" scheme="http://idiotsky.me/categories/redis/"/>
    
    
      <category term="æ•°æ®ç»“æ„" scheme="http://idiotsky.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="redis" scheme="http://idiotsky.me/tags/redis/"/>
    
      <category term="å‹ç¼©åˆ—è¡¨" scheme="http://idiotsky.me/tags/%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>redisæ•°æ®ç»“æ„-æ•´æ•°é›†åˆ</title>
    <link href="http://idiotsky.me/2017/09/17/redis-intset/"/>
    <id>http://idiotsky.me/2017/09/17/redis-intset/</id>
    <published>2017-09-17T04:07:30.000Z</published>
    <updated>2017-09-24T06:34:26.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼š å½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ï¼Œ å¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼Œ Redis å°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚</p>
</blockquote>
<h1 id="æ•´æ•°é›†åˆçš„å®ç°"><a href="#æ•´æ•°é›†åˆçš„å®ç°" class="headerlink" title="æ•´æ•°é›†åˆçš„å®ç°"></a>æ•´æ•°é›†åˆçš„å®ç°</h1><p>æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯ Redis ç”¨äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæŠ½è±¡æ•°æ®ç»“æ„ï¼Œ å®ƒå¯ä»¥ä¿å­˜ç±»å‹ä¸º int16_t ã€ int32_t æˆ–è€… int64_t çš„æ•´æ•°å€¼ï¼Œ å¹¶ä¸”ä¿è¯é›†åˆä¸­ä¸ä¼šå‡ºç°é‡å¤å…ƒç´ ã€‚</p>
<p>æ¯ä¸ª intset.h/intset ç»“æ„è¡¨ç¤ºä¸€ä¸ªæ•´æ•°é›†åˆï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// ç¼–ç æ–¹å¼</span></div><div class="line">    <span class="keyword">uint32_t</span> encoding;</div><div class="line"></div><div class="line">    <span class="comment">// é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡</span></div><div class="line">    <span class="keyword">uint32_t</span> length;</div><div class="line"></div><div class="line">    <span class="comment">// ä¿å­˜å…ƒç´ çš„æ•°ç»„</span></div><div class="line">    <span class="keyword">int8_t</span> contents[];</div><div class="line"></div><div class="line">&#125; intset;</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>contents æ•°ç»„æ˜¯æ•´æ•°é›†åˆçš„åº•å±‚å®ç°ï¼š æ•´æ•°é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ contents æ•°ç»„çš„ä¸€ä¸ªæ•°ç»„é¡¹ï¼ˆitemï¼‰ï¼Œ å„ä¸ªé¡¹åœ¨æ•°ç»„ä¸­æŒ‰å€¼çš„å¤§å°ä»å°åˆ°å¤§æœ‰åºåœ°æ’åˆ—ï¼Œ å¹¶ä¸”æ•°ç»„ä¸­ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹ã€‚</p>
<p>length å±æ€§è®°å½•äº†æ•´æ•°é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡ï¼Œ ä¹Ÿå³æ˜¯ contents æ•°ç»„çš„é•¿åº¦ã€‚</p>
<p>è™½ç„¶ intset ç»“æ„å°† contents å±æ€§å£°æ˜ä¸º int8_t ç±»å‹çš„æ•°ç»„ï¼Œ ä½†å®é™…ä¸Š contents æ•°ç»„å¹¶ä¸ä¿å­˜ä»»ä½• int8_t ç±»å‹çš„å€¼ â€”â€” contents æ•°ç»„çš„çœŸæ­£ç±»å‹å–å†³äº encoding å±æ€§çš„å€¼ï¼š</p>
<ul>
<li>å¦‚æœ encoding å±æ€§çš„å€¼ä¸º INTSET_ENC_INT16 ï¼Œ é‚£ä¹ˆ contents å°±æ˜¯ä¸€ä¸ª int16_t ç±»å‹çš„æ•°ç»„ï¼Œ æ•°ç»„é‡Œçš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª int16_t ç±»å‹çš„æ•´æ•°å€¼ ï¼ˆæœ€å°å€¼ä¸º -32,768 ï¼Œæœ€å¤§å€¼ä¸º 32,767 ï¼‰ã€‚</li>
<li>å¦‚æœ encoding å±æ€§çš„å€¼ä¸º INTSET_ENC_INT32 ï¼Œ é‚£ä¹ˆ contents å°±æ˜¯ä¸€ä¸ª int32_t ç±»å‹çš„æ•°ç»„ï¼Œ æ•°ç»„é‡Œçš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª int32_t ç±»å‹çš„æ•´æ•°å€¼ ï¼ˆæœ€å°å€¼ä¸º -2,147,483,648 ï¼Œæœ€å¤§å€¼ä¸º 2,147,483,647 ï¼‰ã€‚</li>
<li>å¦‚æœ encoding å±æ€§çš„å€¼ä¸º INTSET_ENC_INT64 ï¼Œ é‚£ä¹ˆ contents å°±æ˜¯ä¸€ä¸ª int64_t ç±»å‹çš„æ•°ç»„ï¼Œ æ•°ç»„é‡Œçš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª int64_t ç±»å‹çš„æ•´æ•°å€¼ ï¼ˆæœ€å°å€¼ä¸º -9,223,372,036,854,775,808 ï¼Œæœ€å¤§å€¼ä¸º 9,223,372,036,854,775,807 ï¼‰ã€‚</li>
</ul>
<p>å›¾ 6-1 å±•ç¤ºäº†ä¸€ä¸ªæ•´æ•°é›†åˆç¤ºä¾‹ï¼š<br>encoding å±æ€§çš„å€¼ä¸º INTSET_ENC_INT16 ï¼Œ è¡¨ç¤ºæ•´æ•°é›†åˆçš„åº•å±‚å®ç°ä¸º int16_t ç±»å‹çš„æ•°ç»„ï¼Œ è€Œé›†åˆä¿å­˜çš„éƒ½æ˜¯ int16_t ç±»å‹çš„æ•´æ•°å€¼ã€‚<br>length å±æ€§çš„å€¼ä¸º 5 ï¼Œ è¡¨ç¤ºæ•´æ•°é›†åˆåŒ…å«äº”ä¸ªå…ƒç´ ã€‚<br>contents æ•°ç»„æŒ‰ä»å°åˆ°å¤§çš„é¡ºåºä¿å­˜ç€é›†åˆä¸­çš„äº”ä¸ªå…ƒç´ ã€‚<br>å› ä¸ºæ¯ä¸ªé›†åˆå…ƒç´ éƒ½æ˜¯ int16_t ç±»å‹çš„æ•´æ•°å€¼ï¼Œ æ‰€ä»¥ contents æ•°ç»„çš„å¤§å°ç­‰äº sizeof(int16_t) <em> 5 = 16 </em> 5 = 80 ä½ã€‚<br><a href="http://idiotsky.me/images/redis-intset-1.png"><img src="http://idiotsky.me/images/redis-intset-1.png" alt=""></a><br>å›¾ 6-2 å±•ç¤ºäº†å¦ä¸€ä¸ªæ•´æ•°é›†åˆç¤ºä¾‹ï¼š<br>encoding å±æ€§çš„å€¼ä¸º INTSET_ENC_INT64 ï¼Œ è¡¨ç¤ºæ•´æ•°é›†åˆçš„åº•å±‚å®ç°ä¸º int64_t ç±»å‹çš„æ•°ç»„ï¼Œ è€Œæ•°ç»„ä¸­ä¿å­˜çš„éƒ½æ˜¯ int64_t ç±»å‹çš„æ•´æ•°å€¼ã€‚<br>length å±æ€§çš„å€¼ä¸º 4 ï¼Œ è¡¨ç¤ºæ•´æ•°é›†åˆåŒ…å«å››ä¸ªå…ƒç´ ã€‚<br>contents æ•°ç»„æŒ‰ä»å°åˆ°å¤§çš„é¡ºåºä¿å­˜ç€é›†åˆä¸­çš„å››ä¸ªå…ƒç´ ã€‚<br>å› ä¸ºæ¯ä¸ªé›†åˆå…ƒç´ éƒ½æ˜¯ int64_t ç±»å‹çš„æ•´æ•°å€¼ï¼Œ æ‰€ä»¥ contents æ•°ç»„çš„å¤§å°ä¸º sizeof(int64_t) <em> 4 = 64 </em> 4 = 256 ä½ã€‚<br><a href="http://idiotsky.me/images/redis-intset-2.png"><img src="http://idiotsky.me/images/redis-intset-2.png" alt=""></a><br>è™½ç„¶ contents æ•°ç»„ä¿å­˜çš„å››ä¸ªæ•´æ•°å€¼ä¸­ï¼Œ åªæœ‰ -2675256175807981027 æ˜¯çœŸæ­£éœ€è¦ç”¨ int64_t ç±»å‹æ¥ä¿å­˜çš„ï¼Œ è€Œå…¶ä»–çš„ 1 ã€ 3 ã€ 5 ä¸‰ä¸ªå€¼éƒ½å¯ä»¥ç”¨ int16_t ç±»å‹æ¥ä¿å­˜ï¼Œ ä¸è¿‡æ ¹æ®æ•´æ•°é›†åˆçš„å‡çº§è§„åˆ™ï¼Œ å½“å‘ä¸€ä¸ªåº•å±‚ä¸º int16_t æ•°ç»„çš„æ•´æ•°é›†åˆæ·»åŠ ä¸€ä¸ª int64_t ç±»å‹çš„æ•´æ•°å€¼æ—¶ï¼Œ æ•´æ•°é›†åˆå·²æœ‰çš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šè¢«è½¬æ¢æˆ int64_t ç±»å‹ï¼Œ æ‰€ä»¥ contents æ•°ç»„ä¿å­˜çš„å››ä¸ªæ•´æ•°å€¼éƒ½æ˜¯ int64_t ç±»å‹çš„ï¼Œ ä¸ä»…ä»…æ˜¯ -2675256175807981027 ã€‚</p>
<h1 id="å‡çº§"><a href="#å‡çº§" class="headerlink" title="å‡çº§"></a>å‡çº§</h1><p>æ¯å½“æˆ‘ä»¬è¦å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢ï¼Œ å¹¶ä¸”æ–°å…ƒç´ çš„ç±»å‹æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶ï¼Œ æ•´æ•°é›†åˆéœ€è¦å…ˆè¿›è¡Œå‡çº§ï¼ˆupgradeï¼‰ï¼Œ ç„¶åæ‰èƒ½å°†æ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢ã€‚</p>
<p>å‡çº§æ•´æ•°é›†åˆå¹¶æ·»åŠ æ–°å…ƒç´ å…±åˆ†ä¸ºä¸‰æ­¥è¿›è¡Œï¼š</p>
<ol>
<li>æ ¹æ®æ–°å…ƒç´ çš„ç±»å‹ï¼Œ æ‰©å±•æ•´æ•°é›†åˆåº•å±‚æ•°ç»„çš„ç©ºé—´å¤§å°ï¼Œ å¹¶ä¸ºæ–°å…ƒç´ åˆ†é…ç©ºé—´ã€‚</li>
<li>å°†åº•å±‚æ•°ç»„ç°æœ‰çš„æ‰€æœ‰å…ƒç´ éƒ½è½¬æ¢æˆä¸æ–°å…ƒç´ ç›¸åŒçš„ç±»å‹ï¼Œ å¹¶å°†ç±»å‹è½¬æ¢åçš„å…ƒç´ æ”¾ç½®åˆ°æ­£ç¡®çš„ä½ä¸Šï¼Œ è€Œä¸”åœ¨æ”¾ç½®å…ƒç´ çš„è¿‡ç¨‹ä¸­ï¼Œ éœ€è¦ç»§ç»­ç»´æŒåº•å±‚æ•°ç»„çš„æœ‰åºæ€§è´¨ä¸å˜ã€‚</li>
<li>å°†æ–°å…ƒç´ æ·»åŠ åˆ°åº•å±‚æ•°ç»„é‡Œé¢ã€‚</li>
</ol>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ª INTSET_ENC_INT16 ç¼–ç çš„æ•´æ•°é›†åˆï¼Œ é›†åˆä¸­åŒ…å«ä¸‰ä¸ª int16_t ç±»å‹çš„å…ƒç´ ï¼Œ å¦‚å›¾ 6-3 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-intset-3.png"><img src="http://idiotsky.me/images/redis-intset-3.png" alt=""></a><br>å› ä¸ºæ¯ä¸ªå…ƒç´ éƒ½å ç”¨ 16 ä½ç©ºé—´ï¼Œ æ‰€ä»¥æ•´æ•°é›†åˆåº•å±‚æ•°ç»„çš„å¤§å°ä¸º 3 * 16 = 48 ä½ï¼Œ å›¾ 6-4 å±•ç¤ºäº†æ•´æ•°é›†åˆçš„ä¸‰ä¸ªå…ƒç´ åœ¨è¿™ 48 ä½é‡Œçš„ä½ç½®ã€‚<br><a href="http://idiotsky.me/images/redis-intset-4.png"><img src="http://idiotsky.me/images/redis-intset-4.png" alt=""></a><br>ç°åœ¨ï¼Œ å‡è®¾æˆ‘ä»¬è¦å°†ç±»å‹ä¸º int32_t çš„æ•´æ•°å€¼ 65535 æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢ï¼Œ å› ä¸º 65535 çš„ç±»å‹ int32_t æ¯”æ•´æ•°é›†åˆå½“å‰æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿ï¼Œ æ‰€ä»¥åœ¨å°† 65535 æ·»åŠ åˆ°æ•´æ•°é›†åˆä¹‹å‰ï¼Œ ç¨‹åºéœ€è¦å…ˆå¯¹æ•´æ•°é›†åˆè¿›è¡Œå‡çº§ã€‚</p>
<p>å‡çº§é¦–å…ˆè¦åšçš„æ˜¯ï¼Œ æ ¹æ®æ–°ç±»å‹çš„é•¿åº¦ï¼Œ ä»¥åŠé›†åˆå…ƒç´ çš„æ•°é‡ï¼ˆåŒ…æ‹¬è¦æ·»åŠ çš„æ–°å…ƒç´ åœ¨å†…ï¼‰ï¼Œ å¯¹åº•å±‚æ•°ç»„è¿›è¡Œç©ºé—´é‡åˆ†é…ã€‚</p>
<p>æ•´æ•°é›†åˆç›®å‰æœ‰ä¸‰ä¸ªå…ƒç´ ï¼Œ å†åŠ ä¸Šæ–°å…ƒç´  65535 ï¼Œ æ•´æ•°é›†åˆéœ€è¦åˆ†é…å››ä¸ªå…ƒç´ çš„ç©ºé—´ï¼Œ å› ä¸ºæ¯ä¸ª int32_t æ•´æ•°å€¼éœ€è¦å ç”¨ 32 ä½ç©ºé—´ï¼Œ æ‰€ä»¥åœ¨ç©ºé—´é‡åˆ†é…ä¹‹åï¼Œ åº•å±‚æ•°ç»„çš„å¤§å°å°†æ˜¯ 32 * 4 = 128 ä½ï¼Œ å¦‚å›¾ 6-5 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-intset-5.png"><img src="http://idiotsky.me/images/redis-intset-5.png" alt=""></a><br>è™½ç„¶ç¨‹åºå¯¹åº•å±‚æ•°ç»„è¿›è¡Œäº†ç©ºé—´é‡åˆ†é…ï¼Œ ä½†æ•°ç»„åŸæœ‰çš„ä¸‰ä¸ªå…ƒç´  1 ã€ 2 ã€ 3 ä»ç„¶æ˜¯ int16_t ç±»å‹ï¼Œ è¿™äº›å…ƒç´ è¿˜ä¿å­˜åœ¨æ•°ç»„çš„å‰ 48 ä½é‡Œé¢ï¼Œ æ‰€ä»¥ç¨‹åºæ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å°†è¿™ä¸‰ä¸ªå…ƒç´ è½¬æ¢æˆ int32_t ç±»å‹ï¼Œ å¹¶å°†è½¬æ¢åçš„å…ƒç´ æ”¾ç½®åˆ°æ­£ç¡®çš„ä½ä¸Šé¢ï¼Œ è€Œä¸”åœ¨æ”¾ç½®å…ƒç´ çš„è¿‡ç¨‹ä¸­ï¼Œ éœ€è¦ç»´æŒåº•å±‚æ•°ç»„çš„æœ‰åºæ€§è´¨ä¸å˜ã€‚</p>
<p>é¦–å…ˆï¼Œ å› ä¸ºå…ƒç´  3 åœ¨ 1 ã€ 2 ã€ 3 ã€ 65535 å››ä¸ªå…ƒç´ ä¸­æ’åç¬¬ä¸‰ï¼Œ æ‰€ä»¥å®ƒå°†è¢«ç§»åŠ¨åˆ° contents æ•°ç»„çš„ç´¢å¼• 2 ä½ç½®ä¸Šï¼Œ ä¹Ÿå³æ˜¯æ•°ç»„ 64 ä½è‡³ 95 ä½çš„ç©ºé—´å†…ï¼Œ å¦‚å›¾ 6-6 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-intset-6.png"><img src="http://idiotsky.me/images/redis-intset-6.png" alt=""></a><br>æ¥ç€ï¼Œ å› ä¸ºå…ƒç´  2 åœ¨ 1 ã€ 2 ã€ 3 ã€ 65535 å››ä¸ªå…ƒç´ ä¸­æ’åç¬¬äºŒï¼Œ æ‰€ä»¥å®ƒå°†è¢«ç§»åŠ¨åˆ° contents æ•°ç»„çš„ç´¢å¼• 1 ä½ç½®ä¸Šï¼Œ ä¹Ÿå³æ˜¯æ•°ç»„çš„ 32 ä½è‡³ 63 ä½çš„ç©ºé—´å†…ï¼Œ å¦‚å›¾ 6-7 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-intset-7.png"><img src="http://idiotsky.me/images/redis-intset-7.png" alt=""></a><br>ä¹‹åï¼Œ å› ä¸ºå…ƒç´  1 åœ¨ 1 ã€ 2 ã€ 3 ã€ 65535 å››ä¸ªå…ƒç´ ä¸­æ’åç¬¬ä¸€ï¼Œ æ‰€ä»¥å®ƒå°†è¢«ç§»åŠ¨åˆ° contents æ•°ç»„çš„ç´¢å¼• 0 ä½ç½®ä¸Šï¼Œ ä¹Ÿå³æ˜¯æ•°ç»„çš„ 0 ä½è‡³ 31 ä½çš„ç©ºé—´å†…ï¼Œ å¦‚å›¾ 6-8 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-intset-8.png"><img src="http://idiotsky.me/images/redis-intset-8.png" alt=""></a><br>ç„¶åï¼Œ å› ä¸ºå…ƒç´  65535 åœ¨ 1 ã€ 2 ã€ 3 ã€ 65535 å››ä¸ªå…ƒç´ ä¸­æ’åç¬¬å››ï¼Œ æ‰€ä»¥å®ƒå°†è¢«æ·»åŠ åˆ° contents æ•°ç»„çš„ç´¢å¼• 3 ä½ç½®ä¸Šï¼Œ ä¹Ÿå³æ˜¯æ•°ç»„çš„ 96 ä½è‡³ 127 ä½çš„ç©ºé—´å†…ï¼Œ å¦‚å›¾ 6-9 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-intset-9.png"><img src="http://idiotsky.me/images/redis-intset-9.png" alt=""></a><br>æœ€åï¼Œ ç¨‹åºå°†æ•´æ•°é›†åˆ encoding å±æ€§çš„å€¼ä» INTSET_ENC_INT16 æ”¹ä¸º INTSET_ENC_INT32 ï¼Œ å¹¶å°† length å±æ€§çš„å€¼ä» 3 æ”¹ä¸º 4 ï¼Œ è®¾ç½®å®Œæˆä¹‹åçš„æ•´æ•°é›†åˆå¦‚å›¾ 6-10 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-intset-10.png"><img src="http://idiotsky.me/images/redis-intset-10.png" alt=""></a><br>å› ä¸ºæ¯æ¬¡å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ éƒ½å¯èƒ½ä¼šå¼•èµ·å‡çº§ï¼Œ è€Œæ¯æ¬¡å‡çº§éƒ½éœ€è¦å¯¹åº•å±‚æ•°ç»„ä¸­å·²æœ‰çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œç±»å‹è½¬æ¢ï¼Œ æ‰€ä»¥å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸º O(N) ã€‚</p>
<p>å…¶ä»–ç±»å‹çš„å‡çº§æ“ä½œï¼Œ æ¯”å¦‚ä» INTSET_ENC_INT16 ç¼–ç å‡çº§ä¸º INTSET_ENC_INT64 ç¼–ç ï¼Œ æˆ–è€…ä» INTSET_ENC_INT32 ç¼–ç å‡çº§ä¸º INTSET_ENC_INT64 ç¼–ç ï¼Œ å‡çº§çš„è¿‡ç¨‹éƒ½å’Œä¸Šé¢å±•ç¤ºçš„å‡çº§è¿‡ç¨‹ç±»ä¼¼ã€‚</p>
<blockquote>
<p>å‡çº§ä¹‹åæ–°å…ƒç´ çš„æ‘†æ”¾ä½ç½®<br>å› ä¸ºå¼•å‘å‡çº§çš„æ–°å…ƒç´ çš„é•¿åº¦æ€»æ˜¯æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„é•¿åº¦éƒ½å¤§ï¼Œ æ‰€ä»¥è¿™ä¸ªæ–°å…ƒç´ çš„å€¼è¦ä¹ˆå°±å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼Œ è¦ä¹ˆå°±å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼š</p>
<ul>
<li>åœ¨æ–°å…ƒç´ å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œ æ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€å¼€å¤´ï¼ˆç´¢å¼• 0 ï¼‰ï¼›</li>
<li>åœ¨æ–°å…ƒç´ å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œ æ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€æœ«å°¾ï¼ˆç´¢å¼• length-1 ï¼‰ã€‚</li>
</ul>
</blockquote>
<h1 id="å‡çº§çš„å¥½å¤„"><a href="#å‡çº§çš„å¥½å¤„" class="headerlink" title="å‡çº§çš„å¥½å¤„"></a>å‡çº§çš„å¥½å¤„</h1><p>æ•´æ•°é›†åˆçš„å‡çº§ç­–ç•¥æœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œ ä¸€ä¸ªæ˜¯æå‡æ•´æ•°é›†åˆçš„çµæ´»æ€§ï¼Œ å¦ä¸€ä¸ªæ˜¯å°½å¯èƒ½åœ°èŠ‚çº¦å†…å­˜ã€‚</p>
<h2 id="æå‡çµæ´»æ€§"><a href="#æå‡çµæ´»æ€§" class="headerlink" title="æå‡çµæ´»æ€§"></a>æå‡çµæ´»æ€§</h2><p>å› ä¸º C è¯­è¨€æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œ ä¸ºäº†é¿å…ç±»å‹é”™è¯¯ï¼Œ æˆ‘ä»¬é€šå¸¸ä¸ä¼šå°†ä¸¤ç§ä¸åŒç±»å‹çš„å€¼æ”¾åœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„é‡Œé¢ã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œ æˆ‘ä»¬ä¸€èˆ¬åªä½¿ç”¨ int16_t ç±»å‹çš„æ•°ç»„æ¥ä¿å­˜ int16_t ç±»å‹çš„å€¼ï¼Œ åªä½¿ç”¨ int32_t ç±»å‹çš„æ•°ç»„æ¥ä¿å­˜ int32_t ç±»å‹çš„å€¼ï¼Œ è¯¸å¦‚æ­¤ç±»ã€‚</p>
<p>ä½†æ˜¯ï¼Œ å› ä¸ºæ•´æ•°é›†åˆå¯ä»¥é€šè¿‡è‡ªåŠ¨å‡çº§åº•å±‚æ•°ç»„æ¥é€‚åº”æ–°å…ƒç´ ï¼Œ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥éšæ„åœ°å°† int16_t ã€ int32_t æˆ–è€… int64_t ç±»å‹çš„æ•´æ•°æ·»åŠ åˆ°é›†åˆä¸­ï¼Œ è€Œä¸å¿…æ‹…å¿ƒå‡ºç°ç±»å‹é”™è¯¯ï¼Œ è¿™ç§åšæ³•éå¸¸çµæ´»ã€‚</p>
<h2 id="èŠ‚çº¦å†…å­˜"><a href="#èŠ‚çº¦å†…å­˜" class="headerlink" title="èŠ‚çº¦å†…å­˜"></a>èŠ‚çº¦å†…å­˜</h2><p>å½“ç„¶ï¼Œ è¦è®©ä¸€ä¸ªæ•°ç»„å¯ä»¥åŒæ—¶ä¿å­˜ int16_t ã€ int32_t ã€ int64_t ä¸‰ç§ç±»å‹çš„å€¼ï¼Œ æœ€ç®€å•çš„åšæ³•å°±æ˜¯ç›´æ¥ä½¿ç”¨ int64_t ç±»å‹çš„æ•°ç»„ä½œä¸ºæ•´æ•°é›†åˆçš„åº•å±‚å®ç°ã€‚ ä¸è¿‡è¿™æ ·ä¸€æ¥ï¼Œ å³ä½¿æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢çš„éƒ½æ˜¯ int16_t ç±»å‹æˆ–è€… int32_t ç±»å‹çš„å€¼ï¼Œ æ•°ç»„éƒ½éœ€è¦ä½¿ç”¨ int64_t ç±»å‹çš„ç©ºé—´å»ä¿å­˜å®ƒä»¬ï¼Œ ä»è€Œå‡ºç°æµªè´¹å†…å­˜çš„æƒ…å†µã€‚</p>
<p>è€Œæ•´æ•°é›†åˆç°åœ¨çš„åšæ³•æ—¢å¯ä»¥è®©é›†åˆèƒ½åŒæ—¶ä¿å­˜ä¸‰ç§ä¸åŒç±»å‹çš„å€¼ï¼Œ åˆå¯ä»¥ç¡®ä¿å‡çº§æ“ä½œåªä¼šåœ¨æœ‰éœ€è¦çš„æ—¶å€™è¿›è¡Œï¼Œ è¿™å¯ä»¥å°½é‡èŠ‚çœå†…å­˜ã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œ å¦‚æœæˆ‘ä»¬ä¸€ç›´åªå‘æ•´æ•°é›†åˆæ·»åŠ  int16_t ç±»å‹çš„å€¼ï¼Œ é‚£ä¹ˆæ•´æ•°é›†åˆçš„åº•å±‚å®ç°å°±ä¼šä¸€ç›´æ˜¯ int16_t ç±»å‹çš„æ•°ç»„ï¼Œ åªæœ‰åœ¨æˆ‘ä»¬è¦å°† int32_t ç±»å‹æˆ–è€… int64_t ç±»å‹çš„å€¼æ·»åŠ åˆ°é›†åˆæ—¶ï¼Œ ç¨‹åºæ‰ä¼šå¯¹æ•°ç»„è¿›è¡Œå‡çº§ã€‚</p>
<h1 id="é™çº§"><a href="#é™çº§" class="headerlink" title="é™çº§"></a>é™çº§</h1><p>æ•´æ•°é›†åˆä¸æ”¯æŒé™çº§æ“ä½œï¼Œ ä¸€æ—¦å¯¹æ•°ç»„è¿›è¡Œäº†å‡çº§ï¼Œ ç¼–ç å°±ä¼šä¸€ç›´ä¿æŒå‡çº§åçš„çŠ¶æ€ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¯¹äºå›¾ 6-11 æ‰€ç¤ºçš„æ•´æ•°é›†åˆæ¥è¯´ï¼Œ å³ä½¿æˆ‘ä»¬å°†é›†åˆé‡Œå”¯ä¸€ä¸€ä¸ªçœŸæ­£éœ€è¦ä½¿ç”¨ int64_t ç±»å‹æ¥ä¿å­˜çš„å…ƒç´  4294967295 åˆ é™¤äº†ï¼Œ æ•´æ•°é›†åˆçš„ç¼–ç ä»ç„¶ä¼šç»´æŒ INTSET_ENC_INT64 ï¼Œ åº•å±‚æ•°ç»„ä¹Ÿä»ç„¶ä¼šæ˜¯ int64_t ç±»å‹çš„ï¼Œ å¦‚å›¾ 6-12 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-intset-11.png"><img src="http://idiotsky.me/images/redis-intset-11.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-intset-12.png"><img src="http://idiotsky.me/images/redis-intset-12.png" alt=""></a></p>
<h1 id="é‡ç‚¹å›é¡¾"><a href="#é‡ç‚¹å›é¡¾" class="headerlink" title="é‡ç‚¹å›é¡¾"></a>é‡ç‚¹å›é¡¾</h1><ul>
<li>æ•´æ•°é›†åˆæ˜¯é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚</li>
<li>æ•´æ•°é›†åˆçš„åº•å±‚å®ç°ä¸ºæ•°ç»„ï¼Œ è¿™ä¸ªæ•°ç»„ä»¥æœ‰åºã€æ— é‡å¤çš„æ–¹å¼ä¿å­˜é›†åˆå…ƒç´ ï¼Œ åœ¨æœ‰éœ€è¦æ—¶ï¼Œ ç¨‹åºä¼šæ ¹æ®æ–°æ·»åŠ å…ƒç´ çš„ç±»å‹ï¼Œ æ”¹å˜è¿™ä¸ªæ•°ç»„çš„ç±»å‹ã€‚</li>
<li>å‡çº§æ“ä½œä¸ºæ•´æ•°é›†åˆå¸¦æ¥äº†æ“ä½œä¸Šçš„çµæ´»æ€§ï¼Œ å¹¶ä¸”å°½å¯èƒ½åœ°èŠ‚çº¦äº†å†…å­˜ã€‚</li>
<li>æ•´æ•°é›†åˆåªæ”¯æŒå‡çº§æ“ä½œï¼Œ ä¸æ”¯æŒé™çº§æ“ä½œã€‚</li>
</ul>
<p>å‚è€ƒ <a href="http://redisbook.com" target="_blank" rel="external">http://redisbook.com</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼š å½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ï¼Œ å¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼Œ Redis å°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ•´æ•°é›†åˆçš„å®ç°&quot;&gt;&lt;a href=&quot;#æ•´æ•°é›†åˆçš„å®ç°&quot; class=&quot;headerlink&quot; title=&quot;æ•´æ•°é›†åˆçš„å®ç°&quot;&gt;&lt;/a&gt;æ•´æ•°é›†åˆçš„å®ç°&lt;/h1&gt;&lt;p&gt;æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯ Redis ç”¨äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæŠ½è±¡æ•°æ®ç»“æ„ï¼Œ å®ƒå¯ä»¥ä¿å­˜ç±»å‹ä¸º int16_t ã€ int32_t æˆ–è€… int64_t çš„æ•´æ•°å€¼ï¼Œ å¹¶ä¸”ä¿è¯é›†åˆä¸­ä¸ä¼šå‡ºç°é‡å¤å…ƒç´ ã€‚&lt;/p&gt;
&lt;p&gt;æ¯ä¸ª intset.h/intset ç»“æ„è¡¨ç¤ºä¸€ä¸ªæ•´æ•°é›†åˆï¼š&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;intset&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ç¼–ç æ–¹å¼&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;uint32_t&lt;/span&gt; encoding;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;uint32_t&lt;/span&gt; length;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ä¿å­˜å…ƒç´ çš„æ•°ç»„&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int8_t&lt;/span&gt; contents[];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125; intset;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redis" scheme="http://idiotsky.me/categories/redis/"/>
    
    
      <category term="æ•°æ®ç»“æ„" scheme="http://idiotsky.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="redis" scheme="http://idiotsky.me/tags/redis/"/>
    
      <category term="æ•´æ•°é›†åˆ" scheme="http://idiotsky.me/tags/%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88/"/>
    
  </entry>
  
  <entry>
    <title>redisæ•°æ®ç»“æ„-è·³è·ƒè¡¨</title>
    <link href="http://idiotsky.me/2017/09/16/redis-skiplist/"/>
    <id>http://idiotsky.me/2017/09/16/redis-skiplist/</id>
    <published>2017-09-16T04:07:30.000Z</published>
    <updated>2017-09-24T06:26:26.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è·³è·ƒè¡¨ï¼ˆskiplistï¼‰æ˜¯ä¸€ç§æœ‰åºæ•°æ®ç»“æ„ï¼Œ å®ƒé€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ç»´æŒå¤šä¸ªæŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œ ä»è€Œè¾¾åˆ°å¿«é€Ÿè®¿é—®èŠ‚ç‚¹çš„ç›®çš„ã€‚</p>
<p>è·³è·ƒè¡¨æ”¯æŒå¹³å‡ O(\log N) æœ€å O(N) å¤æ‚åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œ è¿˜å¯ä»¥é€šè¿‡é¡ºåºæ€§æ“ä½œæ¥æ‰¹é‡å¤„ç†èŠ‚ç‚¹ã€‚</p>
<p>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ è·³è·ƒè¡¨çš„æ•ˆç‡å¯ä»¥å’Œå¹³è¡¡æ ‘ç›¸åª²ç¾ï¼Œ å¹¶ä¸”å› ä¸ºè·³è·ƒè¡¨çš„å®ç°æ¯”å¹³è¡¡æ ‘è¦æ¥å¾—æ›´ä¸ºç®€å•ï¼Œ æ‰€ä»¥æœ‰ä¸å°‘ç¨‹åºéƒ½ä½¿ç”¨è·³è·ƒè¡¨æ¥ä»£æ›¿å¹³è¡¡æ ‘ã€‚<br>Redis ä½¿ç”¨è·³è·ƒè¡¨ä½œä¸ºæœ‰åºé›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼š å¦‚æœä¸€ä¸ªæœ‰åºé›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡æ¯”è¾ƒå¤šï¼Œ åˆæˆ–è€…æœ‰åºé›†åˆä¸­å…ƒç´ çš„æˆå‘˜ï¼ˆmemberï¼‰æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶ï¼Œ Redis å°±ä¼šä½¿ç”¨è·³è·ƒè¡¨æ¥ä½œä¸ºæœ‰åºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚</p>
</blockquote>
<h1 id="æ¦‚æ‹¬"><a href="#æ¦‚æ‹¬" class="headerlink" title="æ¦‚æ‹¬"></a>æ¦‚æ‹¬</h1><p>Redis çš„è·³è·ƒè¡¨ç”± redis.h/zskiplistNode å’Œ redis.h/zskiplist ä¸¤ä¸ªç»“æ„å®šä¹‰ï¼Œ å…¶ä¸­ zskiplistNode ç»“æ„ç”¨äºè¡¨ç¤ºè·³è·ƒè¡¨èŠ‚ç‚¹ï¼Œ è€Œ zskiplist ç»“æ„åˆ™ç”¨äºä¿å­˜è·³è·ƒè¡¨èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯ï¼Œ æ¯”å¦‚èŠ‚ç‚¹çš„æ•°é‡ï¼Œ ä»¥åŠæŒ‡å‘è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œ ç­‰ç­‰ã€‚<br><a href="http://idiotsky.me/images/redis-skiplist.png"><img src="http://idiotsky.me/images/redis-skiplist.png" alt=""></a><br>å›¾ 5-1 å±•ç¤ºäº†ä¸€ä¸ªè·³è·ƒè¡¨ç¤ºä¾‹ï¼Œ ä½äºå›¾ç‰‡æœ€å·¦è¾¹çš„æ˜¯ zskiplist ç»“æ„ï¼Œ è¯¥ç»“æ„åŒ…å«ä»¥ä¸‹å±æ€§ï¼š</p>
<ul>
<li>header ï¼šæŒ‡å‘è·³è·ƒè¡¨çš„è¡¨å¤´èŠ‚ç‚¹ã€‚</li>
<li>tail ï¼šæŒ‡å‘è·³è·ƒè¡¨çš„è¡¨å°¾èŠ‚ç‚¹ã€‚</li>
<li>level ï¼šè®°å½•ç›®å‰è·³è·ƒè¡¨å†…ï¼Œå±‚æ•°æœ€å¤§çš„é‚£ä¸ªèŠ‚ç‚¹çš„å±‚æ•°ï¼ˆè¡¨å¤´èŠ‚ç‚¹çš„å±‚æ•°ä¸è®¡ç®—åœ¨å†…ï¼‰ã€‚</li>
<li>length ï¼šè®°å½•è·³è·ƒè¡¨çš„é•¿åº¦ï¼Œä¹Ÿå³æ˜¯ï¼Œè·³è·ƒè¡¨ç›®å‰åŒ…å«èŠ‚ç‚¹çš„æ•°é‡ï¼ˆè¡¨å¤´èŠ‚ç‚¹ä¸è®¡ç®—åœ¨å†…ï¼‰ã€‚</li>
</ul>
<p>ä½äº zskiplist ç»“æ„å³æ–¹çš„æ˜¯å››ä¸ª zskiplistNode ç»“æ„ï¼Œ è¯¥ç»“æ„åŒ…å«ä»¥ä¸‹å±æ€§ï¼š</p>
<ul>
<li>å±‚ï¼ˆlevelï¼‰ï¼šèŠ‚ç‚¹ä¸­ç”¨ L1 ã€ L2 ã€ L3 ç­‰å­—æ ·æ ‡è®°èŠ‚ç‚¹çš„å„ä¸ªå±‚ï¼Œ L1 ä»£è¡¨ç¬¬ä¸€å±‚ï¼Œ L2 ä»£è¡¨ç¬¬äºŒå±‚ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ¯ä¸ªå±‚éƒ½å¸¦æœ‰ä¸¤ä¸ªå±æ€§ï¼šå‰è¿›æŒ‡é’ˆå’Œè·¨åº¦ã€‚å‰è¿›æŒ‡é’ˆç”¨äºè®¿é—®ä½äºè¡¨å°¾æ–¹å‘çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè€Œè·¨åº¦åˆ™è®°å½•äº†å‰è¿›æŒ‡é’ˆæ‰€æŒ‡å‘èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹çš„è·ç¦»ã€‚åœ¨ä¸Šé¢çš„å›¾ç‰‡ä¸­ï¼Œè¿çº¿ä¸Šå¸¦æœ‰æ•°å­—çš„ç®­å¤´å°±ä»£è¡¨å‰è¿›æŒ‡é’ˆï¼Œè€Œé‚£ä¸ªæ•°å­—å°±æ˜¯è·¨åº¦ã€‚å½“ç¨‹åºä»è¡¨å¤´å‘è¡¨å°¾è¿›è¡Œéå†æ—¶ï¼Œè®¿é—®ä¼šæ²¿ç€å±‚çš„å‰è¿›æŒ‡é’ˆè¿›è¡Œã€‚</li>
<li>åé€€ï¼ˆbackwardï¼‰æŒ‡é’ˆï¼šèŠ‚ç‚¹ä¸­ç”¨ BW å­—æ ·æ ‡è®°èŠ‚ç‚¹çš„åé€€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä½äºå½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚åé€€æŒ‡é’ˆåœ¨ç¨‹åºä»è¡¨å°¾å‘è¡¨å¤´éå†æ—¶ä½¿ç”¨ã€‚</li>
<li>åˆ†å€¼ï¼ˆscoreï¼‰ï¼šå„ä¸ªèŠ‚ç‚¹ä¸­çš„ 1.0 ã€ 2.0 å’Œ 3.0 æ˜¯èŠ‚ç‚¹æ‰€ä¿å­˜çš„åˆ†å€¼ã€‚åœ¨è·³è·ƒè¡¨ä¸­ï¼ŒèŠ‚ç‚¹æŒ‰å„è‡ªæ‰€ä¿å­˜çš„åˆ†å€¼ä»å°åˆ°å¤§æ’åˆ—ã€‚</li>
<li>æˆå‘˜å¯¹è±¡ï¼ˆobjï¼‰ï¼šå„ä¸ªèŠ‚ç‚¹ä¸­çš„ o1 ã€ o2 å’Œ o3 æ˜¯èŠ‚ç‚¹æ‰€ä¿å­˜çš„æˆå‘˜å¯¹è±¡ã€‚</li>
</ul>
<p>æ³¨æ„è¡¨å¤´èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹çš„æ„é€ æ˜¯ä¸€æ ·çš„ï¼š è¡¨å¤´èŠ‚ç‚¹ä¹Ÿæœ‰åé€€æŒ‡é’ˆã€åˆ†å€¼å’Œæˆå‘˜å¯¹è±¡ï¼Œ ä¸è¿‡è¡¨å¤´èŠ‚ç‚¹çš„è¿™äº›å±æ€§éƒ½ä¸ä¼šè¢«ç”¨åˆ°ï¼Œ æ‰€ä»¥å›¾ä¸­çœç•¥äº†è¿™äº›éƒ¨åˆ†ï¼Œ åªæ˜¾ç¤ºäº†è¡¨å¤´èŠ‚ç‚¹çš„å„ä¸ªå±‚ã€‚</p>
<p>æœ¬èŠ‚æ¥ä¸‹æ¥çš„å†…å®¹å°†å¯¹ zskiplistNode å’Œ zskiplist ä¸¤ä¸ªç»“æ„è¿›è¡Œæ›´è¯¦ç»†çš„ä»‹ç»ã€‚<br><a id="more"></a></p>
<h1 id="è·³è·ƒè¡¨èŠ‚ç‚¹"><a href="#è·³è·ƒè¡¨èŠ‚ç‚¹" class="headerlink" title="è·³è·ƒè¡¨èŠ‚ç‚¹"></a>è·³è·ƒè¡¨èŠ‚ç‚¹</h1><p>è·³è·ƒè¡¨èŠ‚ç‚¹çš„å®ç°ç”± redis.h/zskiplistNode ç»“æ„å®šä¹‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// åé€€æŒ‡é’ˆ</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span></div><div class="line"></div><div class="line">    <span class="comment">// åˆ†å€¼</span></div><div class="line">    <span class="keyword">double</span> score;</div><div class="line"></div><div class="line">    <span class="comment">// æˆå‘˜å¯¹è±¡</span></div><div class="line">    robj *obj;</div><div class="line"></div><div class="line">    <span class="comment">// å±‚</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></div><div class="line"></div><div class="line">        <span class="comment">// å‰è¿›æŒ‡é’ˆ</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span></div><div class="line"></div><div class="line">        <span class="comment">// è·¨åº¦</span></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> span;</div><div class="line"></div><div class="line">    &#125; level[];</div><div class="line"></div><div class="line">&#125; zskiplistNode;</div></pre></td></tr></table></figure></p>
<h2 id="å±‚"><a href="#å±‚" class="headerlink" title="å±‚"></a>å±‚</h2><p>è·³è·ƒè¡¨èŠ‚ç‚¹çš„ level æ•°ç»„å¯ä»¥åŒ…å«å¤šä¸ªå…ƒç´ ï¼Œ æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œ ç¨‹åºå¯ä»¥é€šè¿‡è¿™äº›å±‚æ¥åŠ å¿«è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„é€Ÿåº¦ï¼Œ ä¸€èˆ¬æ¥è¯´ï¼Œ å±‚çš„æ•°é‡è¶Šå¤šï¼Œ è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„é€Ÿåº¦å°±è¶Šå¿«ã€‚</p>
<p>æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°è·³è·ƒè¡¨èŠ‚ç‚¹çš„æ—¶å€™ï¼Œ ç¨‹åºéƒ½æ ¹æ®å¹‚æ¬¡å®šå¾‹ ï¼ˆpower lawï¼Œè¶Šå¤§çš„æ•°å‡ºç°çš„æ¦‚ç‡è¶Šå°ï¼‰ éšæœºç”Ÿæˆä¸€ä¸ªä»‹äº 1 å’Œ 32 ä¹‹é—´çš„å€¼ä½œä¸º level æ•°ç»„çš„å¤§å°ï¼Œ è¿™ä¸ªå¤§å°å°±æ˜¯å±‚çš„â€œé«˜åº¦â€ã€‚</p>
<p>å›¾ 5-2 åˆ†åˆ«å±•ç¤ºäº†ä¸‰ä¸ªé«˜åº¦ä¸º 1 å±‚ã€ 3 å±‚å’Œ 5 å±‚çš„èŠ‚ç‚¹ï¼Œ å› ä¸º C è¯­è¨€çš„æ•°ç»„ç´¢å¼•æ€»æ˜¯ä» 0 å¼€å§‹çš„ï¼Œ æ‰€ä»¥èŠ‚ç‚¹çš„ç¬¬ä¸€å±‚æ˜¯ level[0] ï¼Œ è€Œç¬¬äºŒå±‚æ˜¯ level[1] ï¼Œ ä»¥æ­¤ç±»æ¨ã€‚<br><a href="http://idiotsky.me/images/redis-skiplist-1.png"><img src="http://idiotsky.me/images/redis-skiplist-1.png" alt=""></a></p>
<h2 id="å‰è¿›æŒ‡é’ˆ"><a href="#å‰è¿›æŒ‡é’ˆ" class="headerlink" title="å‰è¿›æŒ‡é’ˆ"></a>å‰è¿›æŒ‡é’ˆ</h2><p>æ¯ä¸ªå±‚éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘è¡¨å°¾æ–¹å‘çš„å‰è¿›æŒ‡é’ˆï¼ˆlevel[i].forward å±æ€§ï¼‰ï¼Œ ç”¨äºä»è¡¨å¤´å‘è¡¨å°¾æ–¹å‘è®¿é—®èŠ‚ç‚¹ã€‚</p>
<p>å›¾ 5-3 ç”¨è™šçº¿è¡¨ç¤ºå‡ºäº†ç¨‹åºä»è¡¨å¤´å‘è¡¨å°¾æ–¹å‘ï¼Œ éå†è·³è·ƒè¡¨ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„è·¯å¾„ï¼š</p>
<ol>
<li>è¿­ä»£ç¨‹åºé¦–å…ˆè®¿é—®è·³è·ƒè¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¡¨å¤´ï¼‰ï¼Œ ç„¶åä»ç¬¬å››å±‚çš„å‰è¿›æŒ‡é’ˆç§»åŠ¨åˆ°è¡¨ä¸­çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹ã€‚</li>
<li>åœ¨ç¬¬äºŒä¸ªèŠ‚ç‚¹æ—¶ï¼Œ ç¨‹åºæ²¿ç€ç¬¬äºŒå±‚çš„å‰è¿›æŒ‡é’ˆç§»åŠ¨åˆ°è¡¨ä¸­çš„ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>åœ¨ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹æ—¶ï¼Œ ç¨‹åºåŒæ ·æ²¿ç€ç¬¬äºŒå±‚çš„å‰è¿›æŒ‡é’ˆç§»åŠ¨åˆ°è¡¨ä¸­çš„ç¬¬å››ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>å½“ç¨‹åºå†æ¬¡æ²¿ç€ç¬¬å››ä¸ªèŠ‚ç‚¹çš„å‰è¿›æŒ‡é’ˆç§»åŠ¨æ—¶ï¼Œ å®ƒç¢°åˆ°ä¸€ä¸ª NULL ï¼Œ ç¨‹åºçŸ¥é“è¿™æ—¶å·²ç»åˆ°è¾¾äº†è·³è·ƒè¡¨çš„è¡¨å°¾ï¼Œ äºæ˜¯ç»“æŸè¿™æ¬¡éå†ã€‚</li>
</ol>
<p><a href="http://idiotsky.me/images/redis-skiplist-2.png"><img src="http://idiotsky.me/images/redis-skiplist-2.png" alt=""></a></p>
<h2 id="è·¨åº¦"><a href="#è·¨åº¦" class="headerlink" title="è·¨åº¦"></a>è·¨åº¦</h2><p>å±‚çš„è·¨åº¦ï¼ˆlevel[i].span å±æ€§ï¼‰ç”¨äºè®°å½•ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»ï¼š</p>
<ul>
<li>ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·¨åº¦è¶Šå¤§ï¼Œ å®ƒä»¬ç›¸è·å¾—å°±è¶Šè¿œã€‚</li>
<li>æŒ‡å‘ NULL çš„æ‰€æœ‰å‰è¿›æŒ‡é’ˆçš„è·¨åº¦éƒ½ä¸º 0 ï¼Œ å› ä¸ºå®ƒä»¬æ²¡æœ‰è¿å‘ä»»ä½•èŠ‚ç‚¹ã€‚</li>
</ul>
<p>åˆçœ‹ä¸Šå»ï¼Œ å¾ˆå®¹æ˜“ä»¥ä¸ºè·¨åº¦å’Œéå†æ“ä½œæœ‰å…³ï¼Œ ä½†å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ · â€”â€” éå†æ“ä½œåªä½¿ç”¨å‰è¿›æŒ‡é’ˆå°±å¯ä»¥å®Œæˆäº†ï¼Œ è·¨åº¦å®é™…ä¸Šæ˜¯ç”¨æ¥è®¡ç®—æ’ä½ï¼ˆrankï¼‰çš„ï¼š åœ¨æŸ¥æ‰¾æŸä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œ å°†æ²¿é€”è®¿é—®è¿‡çš„æ‰€æœ‰å±‚çš„è·¨åº¦ç´¯è®¡èµ·æ¥ï¼Œ å¾—åˆ°çš„ç»“æœå°±æ˜¯ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å›¾ 5-4 ç”¨è™šçº¿æ ‡è®°äº†åœ¨è·³è·ƒè¡¨ä¸­æŸ¥æ‰¾åˆ†å€¼ä¸º 3.0 ã€ æˆå‘˜å¯¹è±¡ä¸º o3 çš„èŠ‚ç‚¹æ—¶ï¼Œ æ²¿é€”ç»å†çš„å±‚ï¼š æŸ¥æ‰¾çš„è¿‡ç¨‹åªç»è¿‡äº†ä¸€ä¸ªå±‚ï¼Œ å¹¶ä¸”å±‚çš„è·¨åº¦ä¸º 3 ï¼Œ æ‰€ä»¥ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 3 ã€‚<br><a href="http://idiotsky.me/images/redis-skiplist-3.png"><img src="http://idiotsky.me/images/redis-skiplist-3.png" alt=""></a><br>å†ä¸¾ä¸ªä¾‹å­ï¼Œ å›¾ 5-5 ç”¨è™šçº¿æ ‡è®°äº†åœ¨è·³è·ƒè¡¨ä¸­æŸ¥æ‰¾åˆ†å€¼ä¸º 2.0 ã€ æˆå‘˜å¯¹è±¡ä¸º o2 çš„èŠ‚ç‚¹æ—¶ï¼Œ æ²¿é€”ç»å†çš„å±‚ï¼š åœ¨æŸ¥æ‰¾èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œ ç¨‹åºç»è¿‡äº†ä¸¤ä¸ªè·¨åº¦ä¸º 1 çš„èŠ‚ç‚¹ï¼Œ å› æ­¤å¯ä»¥è®¡ç®—å‡ºï¼Œ ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 2 ã€‚<br><a href="http://idiotsky.me/images/redis-skiplist-4.png"><img src="http://idiotsky.me/images/redis-skiplist-4.png" alt=""></a></p>
<h2 id="åé€€æŒ‡é’ˆ"><a href="#åé€€æŒ‡é’ˆ" class="headerlink" title="åé€€æŒ‡é’ˆ"></a>åé€€æŒ‡é’ˆ</h2><p>èŠ‚ç‚¹çš„åé€€æŒ‡é’ˆï¼ˆbackward å±æ€§ï¼‰ç”¨äºä»è¡¨å°¾å‘è¡¨å¤´æ–¹å‘è®¿é—®èŠ‚ç‚¹ï¼š è·Ÿå¯ä»¥ä¸€æ¬¡è·³è¿‡å¤šä¸ªèŠ‚ç‚¹çš„å‰è¿›æŒ‡é’ˆä¸åŒï¼Œ å› ä¸ºæ¯ä¸ªèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªåé€€æŒ‡é’ˆï¼Œ æ‰€ä»¥æ¯æ¬¡åªèƒ½åé€€è‡³å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>å›¾ 5-6 ç”¨è™šçº¿å±•ç¤ºäº†å¦‚æœä»è¡¨å°¾å‘è¡¨å¤´éå†è·³è·ƒè¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼š ç¨‹åºé¦–å…ˆé€šè¿‡è·³è·ƒè¡¨çš„ tail æŒ‡é’ˆè®¿é—®è¡¨å°¾èŠ‚ç‚¹ï¼Œ ç„¶åé€šè¿‡åé€€æŒ‡é’ˆè®¿é—®å€’æ•°ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œ ä¹‹åå†æ²¿ç€åé€€æŒ‡é’ˆè®¿é—®å€’æ•°ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œ å†ä¹‹åé‡åˆ°æŒ‡å‘ NULL çš„åé€€æŒ‡é’ˆï¼Œ äºæ˜¯è®¿é—®ç»“æŸã€‚<br><a href="http://idiotsky.me/images/redis-skiplist-5.png"><img src="http://idiotsky.me/images/redis-skiplist-5.png" alt=""></a></p>
<h2 id="åˆ†å€¼å’Œæˆå‘˜"><a href="#åˆ†å€¼å’Œæˆå‘˜" class="headerlink" title="åˆ†å€¼å’Œæˆå‘˜"></a>åˆ†å€¼å’Œæˆå‘˜</h2><p>èŠ‚ç‚¹çš„åˆ†å€¼ï¼ˆscore å±æ€§ï¼‰æ˜¯ä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ï¼Œ è·³è·ƒè¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‰åˆ†å€¼ä»å°åˆ°å¤§æ¥æ’åºã€‚</p>
<p>èŠ‚ç‚¹çš„æˆå‘˜å¯¹è±¡ï¼ˆobj å±æ€§ï¼‰æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œ å®ƒæŒ‡å‘ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œ è€Œå­—ç¬¦ä¸²å¯¹è±¡åˆ™ä¿å­˜ç€ä¸€ä¸ª SDS å€¼ã€‚</p>
<p>åœ¨åŒä¸€ä¸ªè·³è·ƒè¡¨ä¸­ï¼Œ å„ä¸ªèŠ‚ç‚¹ä¿å­˜çš„æˆå‘˜å¯¹è±¡å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œ ä½†æ˜¯å¤šä¸ªèŠ‚ç‚¹ä¿å­˜çš„åˆ†å€¼å´å¯ä»¥æ˜¯ç›¸åŒçš„ï¼š åˆ†å€¼ç›¸åŒçš„èŠ‚ç‚¹å°†æŒ‰ç…§æˆå‘˜å¯¹è±¡åœ¨å­—å…¸åºä¸­çš„å¤§å°æ¥è¿›è¡Œæ’åºï¼Œ æˆå‘˜å¯¹è±¡è¾ƒå°çš„èŠ‚ç‚¹ä¼šæ’åœ¨å‰é¢ï¼ˆé è¿‘è¡¨å¤´çš„æ–¹å‘ï¼‰ï¼Œ è€Œæˆå‘˜å¯¹è±¡è¾ƒå¤§çš„èŠ‚ç‚¹åˆ™ä¼šæ’åœ¨åé¢ï¼ˆé è¿‘è¡¨å°¾çš„æ–¹å‘ï¼‰ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ åœ¨å›¾ 5-7 æ‰€ç¤ºçš„è·³è·ƒè¡¨ä¸­ï¼Œ ä¸‰ä¸ªè·³è·ƒè¡¨èŠ‚ç‚¹éƒ½ä¿å­˜äº†ç›¸åŒçš„åˆ†å€¼ 10086.0 ï¼Œ ä½†ä¿å­˜æˆå‘˜å¯¹è±¡ o1 çš„èŠ‚ç‚¹å´æ’åœ¨ä¿å­˜æˆå‘˜å¯¹è±¡ o2 å’Œ o3 çš„èŠ‚ç‚¹ä¹‹å‰ï¼Œ è€Œä¿å­˜æˆå‘˜å¯¹è±¡ o2 çš„èŠ‚ç‚¹åˆæ’åœ¨ä¿å­˜æˆå‘˜å¯¹è±¡ o3 çš„èŠ‚ç‚¹ä¹‹å‰ï¼Œ ç”±æ­¤å¯è§ï¼Œ o1 ã€ o2 ã€ o3 ä¸‰ä¸ªæˆå‘˜å¯¹è±¡åœ¨å­—å…¸ä¸­çš„æ’åºä¸º o1 &lt;= o2 &lt;= o3 ã€‚<br><a href="http://idiotsky.me/images/redis-skiplist-6.png"><img src="http://idiotsky.me/images/redis-skiplist-6.png" alt=""></a></p>
<h1 id="è·³è·ƒè¡¨"><a href="#è·³è·ƒè¡¨" class="headerlink" title="è·³è·ƒè¡¨"></a>è·³è·ƒè¡¨</h1><p>è™½ç„¶ä»…é å¤šä¸ªè·³è·ƒè¡¨èŠ‚ç‚¹å°±å¯ä»¥ç»„æˆä¸€ä¸ªè·³è·ƒè¡¨ï¼Œ å¦‚å›¾ 5-8 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-skiplist-7.png"><img src="http://idiotsky.me/images/redis-skiplist-7.png" alt=""></a><br>ä½†é€šè¿‡ä½¿ç”¨ä¸€ä¸ª zskiplist ç»“æ„æ¥æŒæœ‰è¿™äº›èŠ‚ç‚¹ï¼Œ ç¨‹åºå¯ä»¥æ›´æ–¹ä¾¿åœ°å¯¹æ•´ä¸ªè·³è·ƒè¡¨è¿›è¡Œå¤„ç†ï¼Œ æ¯”å¦‚å¿«é€Ÿè®¿é—®è·³è·ƒè¡¨çš„è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹ï¼Œ åˆæˆ–è€…å¿«é€Ÿåœ°è·å–è·³è·ƒè¡¨èŠ‚ç‚¹çš„æ•°é‡ï¼ˆä¹Ÿå³æ˜¯è·³è·ƒè¡¨çš„é•¿åº¦ï¼‰ç­‰ä¿¡æ¯ï¼Œ å¦‚å›¾ 5-9 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-skiplist-8.png"><img src="http://idiotsky.me/images/redis-skiplist-8.png" alt=""></a><br>zskiplist ç»“æ„çš„å®šä¹‰å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span></div><div class="line"></div><div class="line">    <span class="comment">// è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> length;</div><div class="line"></div><div class="line">    <span class="comment">// è¡¨ä¸­å±‚æ•°æœ€å¤§çš„èŠ‚ç‚¹çš„å±‚æ•°</span></div><div class="line">    <span class="keyword">int</span> level;</div><div class="line"></div><div class="line">&#125; zskiplist;</div></pre></td></tr></table></figure></p>
<p>header å’Œ tail æŒ‡é’ˆåˆ†åˆ«æŒ‡å‘è·³è·ƒè¡¨çš„è¡¨å¤´å’Œè¡¨å°¾èŠ‚ç‚¹ï¼Œ é€šè¿‡è¿™ä¸¤ä¸ªæŒ‡é’ˆï¼Œ ç¨‹åºå®šä½è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„å¤æ‚åº¦ä¸º O(1) ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨ length å±æ€§æ¥è®°å½•èŠ‚ç‚¹çš„æ•°é‡ï¼Œ ç¨‹åºå¯ä»¥åœ¨ O(1) å¤æ‚åº¦å†…è¿”å›è·³è·ƒè¡¨çš„é•¿åº¦ã€‚</p>
<p>level å±æ€§åˆ™ç”¨äºåœ¨ O(1) å¤æ‚åº¦å†…è·å–è·³è·ƒè¡¨ä¸­å±‚é«˜æœ€å¤§çš„é‚£ä¸ªèŠ‚ç‚¹çš„å±‚æ•°é‡ï¼Œ æ³¨æ„è¡¨å¤´èŠ‚ç‚¹çš„å±‚é«˜å¹¶ä¸è®¡ç®—åœ¨å†…ã€‚</p>
<h1 id="é‡ç‚¹å›é¡¾"><a href="#é‡ç‚¹å›é¡¾" class="headerlink" title="é‡ç‚¹å›é¡¾"></a>é‡ç‚¹å›é¡¾</h1><ul>
<li>è·³è·ƒè¡¨æ˜¯æœ‰åºé›†åˆçš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œ é™¤æ­¤ä¹‹å¤–å®ƒåœ¨ Redis ä¸­æ²¡æœ‰å…¶ä»–åº”ç”¨ã€‚</li>
<li>Redis çš„è·³è·ƒè¡¨å®ç°ç”± zskiplist å’Œ zskiplistNode ä¸¤ä¸ªç»“æ„ç»„æˆï¼Œ å…¶ä¸­ zskiplist ç”¨äºä¿å­˜è·³è·ƒè¡¨ä¿¡æ¯ï¼ˆæ¯”å¦‚è¡¨å¤´èŠ‚ç‚¹ã€è¡¨å°¾èŠ‚ç‚¹ã€é•¿åº¦ï¼‰ï¼Œ è€Œ zskiplistNode åˆ™ç”¨äºè¡¨ç¤ºè·³è·ƒè¡¨èŠ‚ç‚¹ã€‚</li>
<li>æ¯ä¸ªè·³è·ƒè¡¨èŠ‚ç‚¹çš„å±‚é«˜éƒ½æ˜¯ 1 è‡³ 32 ä¹‹é—´çš„éšæœºæ•°ã€‚</li>
<li>åœ¨åŒä¸€ä¸ªè·³è·ƒè¡¨ä¸­ï¼Œ å¤šä¸ªèŠ‚ç‚¹å¯ä»¥åŒ…å«ç›¸åŒçš„åˆ†å€¼ï¼Œ ä½†æ¯ä¸ªèŠ‚ç‚¹çš„æˆå‘˜å¯¹è±¡å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚</li>
<li>è·³è·ƒè¡¨ä¸­çš„èŠ‚ç‚¹æŒ‰ç…§åˆ†å€¼å¤§å°è¿›è¡Œæ’åºï¼Œ å½“åˆ†å€¼ç›¸åŒæ—¶ï¼Œ èŠ‚ç‚¹æŒ‰ç…§æˆå‘˜å¯¹è±¡çš„å¤§å°è¿›è¡Œæ’åºã€‚</li>
</ul>
<p>å‚è€ƒ <a href="http://redisbook.com" target="_blank" rel="external">http://redisbook.com</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è·³è·ƒè¡¨ï¼ˆskiplistï¼‰æ˜¯ä¸€ç§æœ‰åºæ•°æ®ç»“æ„ï¼Œ å®ƒé€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ç»´æŒå¤šä¸ªæŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œ ä»è€Œè¾¾åˆ°å¿«é€Ÿè®¿é—®èŠ‚ç‚¹çš„ç›®çš„ã€‚&lt;/p&gt;
&lt;p&gt;è·³è·ƒè¡¨æ”¯æŒå¹³å‡ O(\log N) æœ€å O(N) å¤æ‚åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œ è¿˜å¯ä»¥é€šè¿‡é¡ºåºæ€§æ“ä½œæ¥æ‰¹é‡å¤„ç†èŠ‚ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ è·³è·ƒè¡¨çš„æ•ˆç‡å¯ä»¥å’Œå¹³è¡¡æ ‘ç›¸åª²ç¾ï¼Œ å¹¶ä¸”å› ä¸ºè·³è·ƒè¡¨çš„å®ç°æ¯”å¹³è¡¡æ ‘è¦æ¥å¾—æ›´ä¸ºç®€å•ï¼Œ æ‰€ä»¥æœ‰ä¸å°‘ç¨‹åºéƒ½ä½¿ç”¨è·³è·ƒè¡¨æ¥ä»£æ›¿å¹³è¡¡æ ‘ã€‚&lt;br&gt;Redis ä½¿ç”¨è·³è·ƒè¡¨ä½œä¸ºæœ‰åºé›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼š å¦‚æœä¸€ä¸ªæœ‰åºé›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡æ¯”è¾ƒå¤šï¼Œ åˆæˆ–è€…æœ‰åºé›†åˆä¸­å…ƒç´ çš„æˆå‘˜ï¼ˆmemberï¼‰æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶ï¼Œ Redis å°±ä¼šä½¿ç”¨è·³è·ƒè¡¨æ¥ä½œä¸ºæœ‰åºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ¦‚æ‹¬&quot;&gt;&lt;a href=&quot;#æ¦‚æ‹¬&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚æ‹¬&quot;&gt;&lt;/a&gt;æ¦‚æ‹¬&lt;/h1&gt;&lt;p&gt;Redis çš„è·³è·ƒè¡¨ç”± redis.h/zskiplistNode å’Œ redis.h/zskiplist ä¸¤ä¸ªç»“æ„å®šä¹‰ï¼Œ å…¶ä¸­ zskiplistNode ç»“æ„ç”¨äºè¡¨ç¤ºè·³è·ƒè¡¨èŠ‚ç‚¹ï¼Œ è€Œ zskiplist ç»“æ„åˆ™ç”¨äºä¿å­˜è·³è·ƒè¡¨èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯ï¼Œ æ¯”å¦‚èŠ‚ç‚¹çš„æ•°é‡ï¼Œ ä»¥åŠæŒ‡å‘è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œ ç­‰ç­‰ã€‚&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images/redis-skiplist.png&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images/redis-skiplist.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;å›¾ 5-1 å±•ç¤ºäº†ä¸€ä¸ªè·³è·ƒè¡¨ç¤ºä¾‹ï¼Œ ä½äºå›¾ç‰‡æœ€å·¦è¾¹çš„æ˜¯ zskiplist ç»“æ„ï¼Œ è¯¥ç»“æ„åŒ…å«ä»¥ä¸‹å±æ€§ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;header ï¼šæŒ‡å‘è·³è·ƒè¡¨çš„è¡¨å¤´èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;tail ï¼šæŒ‡å‘è·³è·ƒè¡¨çš„è¡¨å°¾èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;level ï¼šè®°å½•ç›®å‰è·³è·ƒè¡¨å†…ï¼Œå±‚æ•°æœ€å¤§çš„é‚£ä¸ªèŠ‚ç‚¹çš„å±‚æ•°ï¼ˆè¡¨å¤´èŠ‚ç‚¹çš„å±‚æ•°ä¸è®¡ç®—åœ¨å†…ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;length ï¼šè®°å½•è·³è·ƒè¡¨çš„é•¿åº¦ï¼Œä¹Ÿå³æ˜¯ï¼Œè·³è·ƒè¡¨ç›®å‰åŒ…å«èŠ‚ç‚¹çš„æ•°é‡ï¼ˆè¡¨å¤´èŠ‚ç‚¹ä¸è®¡ç®—åœ¨å†…ï¼‰ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä½äº zskiplist ç»“æ„å³æ–¹çš„æ˜¯å››ä¸ª zskiplistNode ç»“æ„ï¼Œ è¯¥ç»“æ„åŒ…å«ä»¥ä¸‹å±æ€§ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å±‚ï¼ˆlevelï¼‰ï¼šèŠ‚ç‚¹ä¸­ç”¨ L1 ã€ L2 ã€ L3 ç­‰å­—æ ·æ ‡è®°èŠ‚ç‚¹çš„å„ä¸ªå±‚ï¼Œ L1 ä»£è¡¨ç¬¬ä¸€å±‚ï¼Œ L2 ä»£è¡¨ç¬¬äºŒå±‚ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ¯ä¸ªå±‚éƒ½å¸¦æœ‰ä¸¤ä¸ªå±æ€§ï¼šå‰è¿›æŒ‡é’ˆå’Œè·¨åº¦ã€‚å‰è¿›æŒ‡é’ˆç”¨äºè®¿é—®ä½äºè¡¨å°¾æ–¹å‘çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè€Œè·¨åº¦åˆ™è®°å½•äº†å‰è¿›æŒ‡é’ˆæ‰€æŒ‡å‘èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹çš„è·ç¦»ã€‚åœ¨ä¸Šé¢çš„å›¾ç‰‡ä¸­ï¼Œè¿çº¿ä¸Šå¸¦æœ‰æ•°å­—çš„ç®­å¤´å°±ä»£è¡¨å‰è¿›æŒ‡é’ˆï¼Œè€Œé‚£ä¸ªæ•°å­—å°±æ˜¯è·¨åº¦ã€‚å½“ç¨‹åºä»è¡¨å¤´å‘è¡¨å°¾è¿›è¡Œéå†æ—¶ï¼Œè®¿é—®ä¼šæ²¿ç€å±‚çš„å‰è¿›æŒ‡é’ˆè¿›è¡Œã€‚&lt;/li&gt;
&lt;li&gt;åé€€ï¼ˆbackwardï¼‰æŒ‡é’ˆï¼šèŠ‚ç‚¹ä¸­ç”¨ BW å­—æ ·æ ‡è®°èŠ‚ç‚¹çš„åé€€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä½äºå½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚åé€€æŒ‡é’ˆåœ¨ç¨‹åºä»è¡¨å°¾å‘è¡¨å¤´éå†æ—¶ä½¿ç”¨ã€‚&lt;/li&gt;
&lt;li&gt;åˆ†å€¼ï¼ˆscoreï¼‰ï¼šå„ä¸ªèŠ‚ç‚¹ä¸­çš„ 1.0 ã€ 2.0 å’Œ 3.0 æ˜¯èŠ‚ç‚¹æ‰€ä¿å­˜çš„åˆ†å€¼ã€‚åœ¨è·³è·ƒè¡¨ä¸­ï¼ŒèŠ‚ç‚¹æŒ‰å„è‡ªæ‰€ä¿å­˜çš„åˆ†å€¼ä»å°åˆ°å¤§æ’åˆ—ã€‚&lt;/li&gt;
&lt;li&gt;æˆå‘˜å¯¹è±¡ï¼ˆobjï¼‰ï¼šå„ä¸ªèŠ‚ç‚¹ä¸­çš„ o1 ã€ o2 å’Œ o3 æ˜¯èŠ‚ç‚¹æ‰€ä¿å­˜çš„æˆå‘˜å¯¹è±¡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ³¨æ„è¡¨å¤´èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹çš„æ„é€ æ˜¯ä¸€æ ·çš„ï¼š è¡¨å¤´èŠ‚ç‚¹ä¹Ÿæœ‰åé€€æŒ‡é’ˆã€åˆ†å€¼å’Œæˆå‘˜å¯¹è±¡ï¼Œ ä¸è¿‡è¡¨å¤´èŠ‚ç‚¹çš„è¿™äº›å±æ€§éƒ½ä¸ä¼šè¢«ç”¨åˆ°ï¼Œ æ‰€ä»¥å›¾ä¸­çœç•¥äº†è¿™äº›éƒ¨åˆ†ï¼Œ åªæ˜¾ç¤ºäº†è¡¨å¤´èŠ‚ç‚¹çš„å„ä¸ªå±‚ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬èŠ‚æ¥ä¸‹æ¥çš„å†…å®¹å°†å¯¹ zskiplistNode å’Œ zskiplist ä¸¤ä¸ªç»“æ„è¿›è¡Œæ›´è¯¦ç»†çš„ä»‹ç»ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="redis" scheme="http://idiotsky.me/categories/redis/"/>
    
    
      <category term="æ•°æ®ç»“æ„" scheme="http://idiotsky.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="redis" scheme="http://idiotsky.me/tags/redis/"/>
    
      <category term="è·³è·ƒè¡¨" scheme="http://idiotsky.me/tags/%E8%B7%B3%E8%B7%83%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>redisæ•°æ®ç»“æ„-å­—å…¸</title>
    <link href="http://idiotsky.me/2017/09/15/redis-dict/"/>
    <id>http://idiotsky.me/2017/09/15/redis-dict/</id>
    <published>2017-09-14T16:59:31.000Z</published>
    <updated>2017-09-24T06:27:48.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>Redis çš„æ•°æ®åº“å°±æ˜¯ä½¿ç”¨å­—å…¸æ¥ä½œä¸ºåº•å±‚å®ç°çš„, å­—å…¸è¿˜æ˜¯å“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€<br>Redis çš„å­—å…¸ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œ ä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œé¢å¯ä»¥æœ‰å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œ è€Œæ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å°±ä¿å­˜äº†å­—å…¸ä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹ã€‚</p>
</blockquote>
<h1 id="å“ˆå¸Œè¡¨"><a href="#å“ˆå¸Œè¡¨" class="headerlink" title="å“ˆå¸Œè¡¨"></a>å“ˆå¸Œè¡¨</h1><p>Redis å­—å…¸æ‰€ä½¿ç”¨çš„å“ˆå¸Œè¡¨ç”± dict.h/dictht ç»“æ„å®šä¹‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// å“ˆå¸Œè¡¨æ•°ç»„</span></div><div class="line">    dictEntry **table;</div><div class="line"></div><div class="line">    <span class="comment">// å“ˆå¸Œè¡¨å¤§å°</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</div><div class="line"></div><div class="line">    <span class="comment">// å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼</span></div><div class="line">    <span class="comment">// æ€»æ˜¯ç­‰äº size - 1</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</div><div class="line"></div><div class="line">    <span class="comment">// è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</div><div class="line"></div><div class="line">&#125; dictht;</div></pre></td></tr></table></figure></p>
<p>table å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ dict.h/dictEntry ç»“æ„çš„æŒ‡é’ˆï¼Œ æ¯ä¸ª dictEntry ç»“æ„ä¿å­˜ç€ä¸€ä¸ªé”®å€¼å¯¹ã€‚<br>size å±æ€§è®°å½•äº†å“ˆå¸Œè¡¨çš„å¤§å°ï¼Œ ä¹Ÿå³æ˜¯ table æ•°ç»„çš„å¤§å°ï¼Œ è€Œ used å±æ€§åˆ™è®°å½•äº†å“ˆå¸Œè¡¨ç›®å‰å·²æœ‰èŠ‚ç‚¹ï¼ˆé”®å€¼å¯¹ï¼‰çš„æ•°é‡ã€‚<br>sizemask å±æ€§çš„å€¼æ€»æ˜¯ç­‰äº size - 1 ï¼Œ è¿™ä¸ªå±æ€§å’Œå“ˆå¸Œå€¼ä¸€èµ·å†³å®šä¸€ä¸ªé”®åº”è¯¥è¢«æ”¾åˆ° table æ•°ç»„çš„å“ªä¸ªç´¢å¼•ä¸Šé¢ã€‚<br>å›¾ 4-1 å±•ç¤ºäº†ä¸€ä¸ªå¤§å°ä¸º 4 çš„ç©ºå“ˆå¸Œè¡¨ ï¼ˆæ²¡æœ‰åŒ…å«ä»»ä½•é”®å€¼å¯¹ï¼‰ã€‚<br><a href="http://idiotsky.me/images/redis-dict-1.png"><img src="http://idiotsky.me/images/redis-dict-1.png" alt=""></a><br><a id="more"></a></p>
<h1 id="å“ˆå¸Œè¡¨èŠ‚ç‚¹"><a href="#å“ˆå¸Œè¡¨èŠ‚ç‚¹" class="headerlink" title="å“ˆå¸Œè¡¨èŠ‚ç‚¹"></a>å“ˆå¸Œè¡¨èŠ‚ç‚¹</h1><p>å“ˆå¸Œè¡¨èŠ‚ç‚¹ä½¿ç”¨ dictEntry ç»“æ„è¡¨ç¤ºï¼Œ æ¯ä¸ª dictEntry ç»“æ„éƒ½ä¿å­˜ç€ä¸€ä¸ªé”®å€¼å¯¹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// é”®</span></div><div class="line">    <span class="keyword">void</span> *key;</div><div class="line"></div><div class="line">    <span class="comment">// å€¼</span></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">void</span> *val;</div><div class="line">        <span class="keyword">uint64_t</span> u64;</div><div class="line">        <span class="keyword">int64_t</span> s64;</div><div class="line">    &#125; v;</div><div class="line"></div><div class="line">    <span class="comment">// æŒ‡å‘ä¸‹ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></div><div class="line"></div><div class="line">&#125; dictEntry;</div></pre></td></tr></table></figure></p>
<p>key å±æ€§ä¿å­˜ç€é”®å€¼å¯¹ä¸­çš„é”®ï¼Œ è€Œ v å±æ€§åˆ™ä¿å­˜ç€é”®å€¼å¯¹ä¸­çš„å€¼ï¼Œ å…¶ä¸­é”®å€¼å¯¹çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œ æˆ–è€…æ˜¯ä¸€ä¸ª uint64_t æ•´æ•°ï¼Œ åˆæˆ–è€…æ˜¯ä¸€ä¸ª int64_t æ•´æ•°ã€‚<br>next å±æ€§æ˜¯æŒ‡å‘å¦ä¸€ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œ è¿™ä¸ªæŒ‡é’ˆå¯ä»¥å°†å¤šä¸ªå“ˆå¸Œå€¼ç›¸åŒçš„é”®å€¼å¯¹è¿æ¥åœ¨ä¸€æ¬¡ï¼Œ ä»¥æ­¤æ¥è§£å†³é”®å†²çªï¼ˆcollisionï¼‰çš„é—®é¢˜ã€‚<br>ä¸¾ä¸ªä¾‹å­ï¼Œ å›¾ 4-2 å°±å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ next æŒ‡é’ˆï¼Œ å°†ä¸¤ä¸ªç´¢å¼•å€¼ç›¸åŒçš„é”® k1 å’Œ k0 è¿æ¥åœ¨ä¸€èµ·ã€‚<br><a href="http://idiotsky.me/images/redis-dict-2.png"><img src="http://idiotsky.me/images/redis-dict-2.png" alt=""></a></p>
<h1 id="å­—å…¸"><a href="#å­—å…¸" class="headerlink" title="å­—å…¸"></a>å­—å…¸</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dict</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// ç±»å‹ç‰¹å®šå‡½æ•°</span></div><div class="line">    dictType *type;</div><div class="line"></div><div class="line">    <span class="comment">// ç§æœ‰æ•°æ®</span></div><div class="line">    <span class="keyword">void</span> *privdata;</div><div class="line"></div><div class="line">    <span class="comment">// å“ˆå¸Œè¡¨</span></div><div class="line">    dictht ht[<span class="number">2</span>];</div><div class="line"></div><div class="line">    <span class="comment">// rehash ç´¢å¼•</span></div><div class="line">    <span class="comment">// å½“ rehash ä¸åœ¨è¿›è¡Œæ—¶ï¼Œå€¼ä¸º -1</span></div><div class="line">    <span class="keyword">int</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></div><div class="line"></div><div class="line">&#125; dict;</div></pre></td></tr></table></figure>
<p>type å±æ€§å’Œ privdata å±æ€§æ˜¯é’ˆå¯¹ä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œ ä¸ºåˆ›å»ºå¤šæ€å­—å…¸è€Œè®¾ç½®çš„ï¼š</p>
<ul>
<li>type å±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘ dictType ç»“æ„çš„æŒ‡é’ˆï¼Œ æ¯ä¸ª dictType ç»“æ„ä¿å­˜äº†ä¸€ç°‡ç”¨äºæ“ä½œç‰¹å®šç±»å‹é”®å€¼å¯¹çš„å‡½æ•°ï¼Œ Redis ä¼šä¸ºç”¨é€”ä¸åŒçš„å­—å…¸è®¾ç½®ä¸åŒçš„ç±»å‹ç‰¹å®šå‡½æ•°ã€‚</li>
<li>è€Œ privdata å±æ€§åˆ™ä¿å­˜äº†éœ€è¦ä¼ ç»™é‚£äº›ç±»å‹ç‰¹å®šå‡½æ•°çš„å¯é€‰å‚æ•°ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictType</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// è®¡ç®—å“ˆå¸Œå€¼çš„å‡½æ•°</span></div><div class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunction)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// å¤åˆ¶é”®çš„å‡½æ•°</span></div><div class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</div><div class="line"></div><div class="line">    <span class="comment">// å¤åˆ¶å€¼çš„å‡½æ•°</span></div><div class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</div><div class="line"></div><div class="line">    <span class="comment">// å¯¹æ¯”é”®çš„å‡½æ•°</span></div><div class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</div><div class="line"></div><div class="line">    <span class="comment">// é”€æ¯é”®çš„å‡½æ•°</span></div><div class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</div><div class="line"></div><div class="line">    <span class="comment">// é”€æ¯å€¼çš„å‡½æ•°</span></div><div class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</div><div class="line"></div><div class="line">&#125; dictType;</div></pre></td></tr></table></figure>
<p>ht å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé¡¹çš„æ•°ç»„ï¼Œ æ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª dictht å“ˆå¸Œè¡¨ï¼Œ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ å­—å…¸åªä½¿ç”¨ ht[0] å“ˆå¸Œè¡¨ï¼Œ ht[1] å“ˆå¸Œè¡¨åªä¼šåœ¨å¯¹ ht[0] å“ˆå¸Œè¡¨è¿›è¡Œ rehash æ—¶ä½¿ç”¨ã€‚</p>
<p>é™¤äº† ht[1] ä¹‹å¤–ï¼Œ å¦ä¸€ä¸ªå’Œ rehash æœ‰å…³çš„å±æ€§å°±æ˜¯ rehashidx ï¼š å®ƒè®°å½•äº† rehash ç›®å‰çš„è¿›åº¦ï¼Œ å¦‚æœç›®å‰æ²¡æœ‰åœ¨è¿›è¡Œ rehash ï¼Œ é‚£ä¹ˆå®ƒçš„å€¼ä¸º -1 ã€‚</p>
<p>å›¾ 4-3 å±•ç¤ºäº†ä¸€ä¸ªæ™®é€šçŠ¶æ€ä¸‹ï¼ˆæ²¡æœ‰è¿›è¡Œ rehashï¼‰çš„å­—å…¸ï¼š<br><a href="http://idiotsky.me/images/redis-dict-3.png"><img src="http://idiotsky.me/images/redis-dict-3.png" alt=""></a></p>
<h1 id="å“ˆå¸Œç®—æ³•"><a href="#å“ˆå¸Œç®—æ³•" class="headerlink" title="å“ˆå¸Œç®—æ³•"></a>å“ˆå¸Œç®—æ³•</h1><p>å½“è¦å°†ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸é‡Œé¢æ—¶ï¼Œ ç¨‹åºéœ€è¦å…ˆæ ¹æ®é”®å€¼å¯¹çš„é”®è®¡ç®—å‡ºå“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œ ç„¶åå†æ ¹æ®ç´¢å¼•å€¼ï¼Œ å°†åŒ…å«æ–°é”®å€¼å¯¹çš„å“ˆå¸Œè¡¨èŠ‚ç‚¹æ”¾åˆ°å“ˆå¸Œè¡¨æ•°ç»„çš„æŒ‡å®šç´¢å¼•ä¸Šé¢ã€‚</p>
<p>Redis è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼çš„æ–¹æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä½¿ç”¨å­—å…¸è®¾ç½®çš„å“ˆå¸Œå‡½æ•°ï¼Œè®¡ç®—é”® key çš„å“ˆå¸Œå€¼</span></div><div class="line">hash = dict-&gt;type-&gt;hashFunction(key);</div><div class="line"></div><div class="line"><span class="comment">//ä½¿ç”¨å“ˆå¸Œè¡¨çš„ sizemask å±æ€§å’Œå“ˆå¸Œå€¼ï¼Œè®¡ç®—å‡ºç´¢å¼•å€¼</span></div><div class="line"><span class="comment">//æ ¹æ®æƒ…å†µä¸åŒï¼Œ ht[x] å¯ä»¥æ˜¯ ht[0] æˆ–è€… ht[1]</span></div><div class="line">index = hash &amp; dict-&gt;ht[x].sizemask;</div></pre></td></tr></table></figure></p>
<p><a href="http://idiotsky.me/images/redis-dict-4.png"><img src="http://idiotsky.me/images/redis-dict-4.png" alt=""></a><br>ä¸¾ä¸ªä¾‹å­ï¼Œ å¯¹äºå›¾ 4-4 æ‰€ç¤ºçš„å­—å…¸æ¥è¯´ï¼Œ å¦‚æœæˆ‘ä»¬è¦å°†ä¸€ä¸ªé”®å€¼å¯¹ k0 å’Œ v0 æ·»åŠ åˆ°å­—å…¸é‡Œé¢ï¼Œ é‚£ä¹ˆç¨‹åºä¼šå…ˆä½¿ç”¨è¯­å¥ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hash = dict-&gt;type-&gt;hashFunction(k0);</div></pre></td></tr></table></figure></p>
<p>è®¡ç®—é”® k0 çš„å“ˆå¸Œå€¼ã€‚<br>å‡è®¾è®¡ç®—å¾—å‡ºçš„å“ˆå¸Œå€¼ä¸º 8 ï¼Œ é‚£ä¹ˆç¨‹åºä¼šç»§ç»­ä½¿ç”¨è¯­å¥ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">index = hash &amp; dict-&gt;ht[<span class="number">0</span>].sizemask = <span class="number">8</span> &amp; <span class="number">3</span> = <span class="number">0</span>;</div></pre></td></tr></table></figure></p>
<p>è®¡ç®—å‡ºé”® k0 çš„ç´¢å¼•å€¼ 0 ï¼Œ è¿™è¡¨ç¤ºåŒ…å«é”®å€¼å¯¹ k0 å’Œ v0 çš„èŠ‚ç‚¹åº”è¯¥è¢«æ”¾ç½®åˆ°å“ˆå¸Œè¡¨æ•°ç»„çš„ç´¢å¼• 0 ä½ç½®ä¸Šï¼Œ å¦‚å›¾ 4-5 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-dict-5.png"><img src="http://idiotsky.me/images/redis-dict-5.png" alt=""></a><br>å½“å­—å…¸è¢«ç”¨ä½œæ•°æ®åº“çš„åº•å±‚å®ç°ï¼Œ æˆ–è€…å“ˆå¸Œé”®çš„åº•å±‚å®ç°æ—¶ï¼Œ Redis ä½¿ç”¨ MurmurHash2 ç®—æ³•æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼ã€‚</p>
<p>MurmurHash ç®—æ³•æœ€åˆç”± Austin Appleby äº 2008 å¹´å‘æ˜ï¼Œ è¿™ç§ç®—æ³•çš„ä¼˜ç‚¹åœ¨äºï¼Œ å³ä½¿è¾“å…¥çš„é”®æ˜¯æœ‰è§„å¾‹çš„ï¼Œ ç®—æ³•ä»èƒ½ç»™å‡ºä¸€ä¸ªå¾ˆå¥½çš„éšæœºåˆ†å¸ƒæ€§ï¼Œå¹¶ä¸”ç®—æ³•çš„è®¡ç®—é€Ÿåº¦ä¹Ÿéå¸¸å¿«ã€‚</p>
<p>MurmurHash ç®—æ³•ç›®å‰çš„æœ€æ–°ç‰ˆæœ¬ä¸º MurmurHash3 ï¼Œ è€Œ Redis ä½¿ç”¨çš„æ˜¯ MurmurHash2 ï¼Œ å…³äº MurmurHash ç®—æ³•çš„æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒè¯¥ç®—æ³•çš„ä¸»é¡µï¼š <a href="http://code.google.com/p/smhasher/" target="_blank" rel="external">http://code.google.com/p/smhasher/</a> ã€‚</p>
<h1 id="è§£å†³é”®å†²çª"><a href="#è§£å†³é”®å†²çª" class="headerlink" title="è§£å†³é”®å†²çª"></a>è§£å†³é”®å†²çª</h1><p>å½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®è¢«åˆ†é…åˆ°äº†å“ˆå¸Œè¡¨æ•°ç»„çš„åŒä¸€ä¸ªç´¢å¼•ä¸Šé¢æ—¶ï¼Œ æˆ‘ä»¬ç§°è¿™äº›é”®å‘ç”Ÿäº†å†²çªï¼ˆcollisionï¼‰ã€‚</p>
<p>Redis çš„å“ˆå¸Œè¡¨ä½¿ç”¨é“¾åœ°å€æ³•ï¼ˆseparate chainingï¼‰æ¥è§£å†³é”®å†²çªï¼š æ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª next æŒ‡é’ˆï¼Œ å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å¯ä»¥ç”¨ next æŒ‡é’ˆæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œ è¢«åˆ†é…åˆ°åŒä¸€ä¸ªç´¢å¼•ä¸Šçš„å¤šä¸ªèŠ‚ç‚¹å¯ä»¥ç”¨è¿™ä¸ªå•å‘é“¾è¡¨è¿æ¥èµ·æ¥ï¼Œ è¿™å°±è§£å†³äº†é”®å†²çªçš„é—®é¢˜ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å‡è®¾ç¨‹åºè¦å°†é”®å€¼å¯¹ k2 å’Œ v2 æ·»åŠ åˆ°å›¾ 4-6 æ‰€ç¤ºçš„å“ˆå¸Œè¡¨é‡Œé¢ï¼Œ å¹¶ä¸”è®¡ç®—å¾—å‡º k2 çš„ç´¢å¼•å€¼ä¸º 2 ï¼Œ é‚£ä¹ˆé”® k1 å’Œ k2 å°†äº§ç”Ÿå†²çªï¼Œ è€Œè§£å†³å†²çªçš„åŠæ³•å°±æ˜¯ä½¿ç”¨ next æŒ‡é’ˆå°†é”® k2 å’Œ k1 æ‰€åœ¨çš„èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œ å¦‚å›¾ 4-7 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-dict-6.png"><img src="http://idiotsky.me/images/redis-dict-6.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-7.png"><img src="http://idiotsky.me/images/redis-dict-7.png" alt=""></a><br>å› ä¸º dictEntry èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨æ²¡æœ‰æŒ‡å‘é“¾è¡¨è¡¨å°¾çš„æŒ‡é’ˆï¼Œ æ‰€ä»¥ä¸ºäº†é€Ÿåº¦è€ƒè™‘ï¼Œ ç¨‹åºæ€»æ˜¯å°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨çš„è¡¨å¤´ä½ç½®ï¼ˆå¤æ‚åº¦ä¸º O(1)ï¼‰ï¼Œ æ’åœ¨å…¶ä»–å·²æœ‰èŠ‚ç‚¹çš„å‰é¢ã€‚</p>
<h1 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h1><p>éšç€æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œ å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹ä¼šé€æ¸åœ°å¢å¤šæˆ–è€…å‡å°‘ï¼Œ ä¸ºäº†è®©å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ï¼ˆload factorï¼‰ç»´æŒåœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ä¹‹å†…ï¼Œ å½“å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å¤ªå¤šæˆ–è€…å¤ªå°‘æ—¶ï¼Œ ç¨‹åºéœ€è¦å¯¹å“ˆå¸Œè¡¨çš„å¤§å°è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼©ã€‚<br>æ‰©å±•å’Œæ”¶ç¼©å“ˆå¸Œè¡¨çš„å·¥ä½œå¯ä»¥é€šè¿‡æ‰§è¡Œ rehash ï¼ˆé‡æ–°æ•£åˆ—ï¼‰æ“ä½œæ¥å®Œæˆï¼Œ Redis å¯¹å­—å…¸çš„å“ˆå¸Œè¡¨æ‰§è¡Œ rehash çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>ä¸ºå­—å…¸çš„ ht[1] å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´ï¼Œ è¿™ä¸ªå“ˆå¸Œè¡¨çš„ç©ºé—´å¤§å°å–å†³äºè¦æ‰§è¡Œçš„æ“ä½œï¼Œ ä»¥åŠ ht[0] å½“å‰åŒ…å«çš„é”®å€¼å¯¹æ•°é‡ ï¼ˆä¹Ÿå³æ˜¯ ht[0].used å±æ€§çš„å€¼ï¼‰ï¼š</p>
<ul>
<li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ‰©å±•æ“ä½œï¼Œ é‚£ä¹ˆ ht[1] çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº ht[0].used * 2 çš„ 2^n ï¼ˆ2 çš„ n æ¬¡æ–¹å¹‚ï¼‰ï¼›</li>
<li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œ é‚£ä¹ˆ ht[1] çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº ht[0].used çš„ 2^n ã€‚</li>
</ul>
</li>
<li><p>å°†ä¿å­˜åœ¨ ht[0] ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ rehash åˆ° ht[1] ä¸Šé¢ï¼š rehash æŒ‡çš„æ˜¯é‡æ–°è®¡ç®—é”®çš„å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œ ç„¶åå°†é”®å€¼å¯¹æ”¾ç½®åˆ° ht[1] å“ˆå¸Œè¡¨çš„æŒ‡å®šä½ç½®ä¸Šã€‚</p>
</li>
<li>å½“ ht[0] åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿ç§»åˆ°äº† ht[1] ä¹‹å ï¼ˆht[0] å˜ä¸ºç©ºè¡¨ï¼‰ï¼Œ é‡Šæ”¾ ht[0] ï¼Œ å°† ht[1] è®¾ç½®ä¸º ht[0] ï¼Œ å¹¶åœ¨ ht[1] æ–°åˆ›å»ºä¸€ä¸ªç©ºç™½å“ˆå¸Œè¡¨ï¼Œ ä¸ºä¸‹ä¸€æ¬¡ rehash åšå‡†å¤‡ã€‚</li>
</ol>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œ å‡è®¾ç¨‹åºè¦å¯¹å›¾ 4-8 æ‰€ç¤ºå­—å…¸çš„ ht[0] è¿›è¡Œæ‰©å±•æ“ä½œï¼Œ é‚£ä¹ˆç¨‹åºå°†æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>ht[0].used å½“å‰çš„å€¼ä¸º 4 ï¼Œ 4 * 2 = 8 ï¼Œ è€Œ 8 ï¼ˆ2^3ï¼‰æ°å¥½æ˜¯ç¬¬ä¸€ä¸ªå¤§äºç­‰äº 4 çš„ 2 çš„ n æ¬¡æ–¹ï¼Œ æ‰€ä»¥ç¨‹åºä¼šå°† ht[1] å“ˆå¸Œè¡¨çš„å¤§å°è®¾ç½®ä¸º 8 ã€‚ å›¾ 4-9 å±•ç¤ºäº† ht[1] åœ¨åˆ†é…ç©ºé—´ä¹‹åï¼Œ å­—å…¸çš„æ ·å­ã€‚</li>
<li>å°† ht[0] åŒ…å«çš„å››ä¸ªé”®å€¼å¯¹éƒ½ rehash åˆ° ht[1] ï¼Œ å¦‚å›¾ 4-10 æ‰€ç¤ºã€‚</li>
<li>é‡Šæ”¾ ht[0] ï¼Œå¹¶å°† ht[1] è®¾ç½®ä¸º ht[0] ï¼Œç„¶åä¸º ht[1] åˆ†é…ä¸€ä¸ªç©ºç™½å“ˆå¸Œè¡¨ï¼Œå¦‚å›¾ 4-11 æ‰€ç¤ºã€‚</li>
</ol>
<p>è‡³æ­¤ï¼Œ å¯¹å“ˆå¸Œè¡¨çš„æ‰©å±•æ“ä½œæ‰§è¡Œå®Œæ¯•ï¼Œ ç¨‹åºæˆåŠŸå°†å“ˆå¸Œè¡¨çš„å¤§å°ä»åŸæ¥çš„ 4 æ”¹ä¸ºäº†ç°åœ¨çš„ 8 ã€‚<br><a href="http://idiotsky.me/images/redis-dict-8.png"><img src="http://idiotsky.me/images/redis-dict-8.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-9.png"><img src="http://idiotsky.me/images/redis-dict-9.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-10.png"><img src="http://idiotsky.me/images/redis-dict-10.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-11.png"><img src="http://idiotsky.me/images/redis-dict-11.png" alt=""></a></p>
<h1 id="å“ˆå¸Œè¡¨çš„æ‰©å±•ä¸æ”¶ç¼©"><a href="#å“ˆå¸Œè¡¨çš„æ‰©å±•ä¸æ”¶ç¼©" class="headerlink" title="å“ˆå¸Œè¡¨çš„æ‰©å±•ä¸æ”¶ç¼©"></a>å“ˆå¸Œè¡¨çš„æ‰©å±•ä¸æ”¶ç¼©</h1><p>å½“ä»¥ä¸‹æ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªè¢«æ»¡è¶³æ—¶ï¼Œ ç¨‹åºä¼šè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ‰©å±•æ“ä½œï¼š</p>
<ol>
<li>æœåŠ¡å™¨ç›®å‰æ²¡æœ‰åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œ å¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 1 ï¼›</li>
<li>æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œ å¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 5 ï¼›</li>
</ol>
<p>å…¶ä¸­å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¯ä»¥é€šè¿‡å…¬å¼ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// è´Ÿè½½å› å­ = å“ˆå¸Œè¡¨å·²ä¿å­˜èŠ‚ç‚¹æ•°é‡ / å“ˆå¸Œè¡¨å¤§å°</span></div><div class="line">load_factor = ht[<span class="number">0</span>].used / ht[<span class="number">0</span>].size</div></pre></td></tr></table></figure></p>
<p>è®¡ç®—å¾—å‡ºã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œ å¯¹äºä¸€ä¸ªå¤§å°ä¸º 4 ï¼Œ åŒ…å« 4 ä¸ªé”®å€¼å¯¹çš„å“ˆå¸Œè¡¨æ¥è¯´ï¼Œ è¿™ä¸ªå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ä¸ºï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">load_factor = <span class="number">4</span> / <span class="number">4</span> = <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>åˆæ¯”å¦‚è¯´ï¼Œ å¯¹äºä¸€ä¸ªå¤§å°ä¸º 512 ï¼Œ åŒ…å« 256 ä¸ªé”®å€¼å¯¹çš„å“ˆå¸Œè¡¨æ¥è¯´ï¼Œ è¿™ä¸ªå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ä¸ºï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">load_factor = <span class="number">256</span> / <span class="number">512</span> = <span class="number">0.5</span></div></pre></td></tr></table></figure></p>
<p>æ ¹æ® BGSAVE å‘½ä»¤æˆ– BGREWRITEAOF å‘½ä»¤æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œ æœåŠ¡å™¨æ‰§è¡Œæ‰©å±•æ“ä½œæ‰€éœ€çš„è´Ÿè½½å› å­å¹¶ä¸ç›¸åŒï¼Œ è¿™æ˜¯å› ä¸ºåœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ– BGREWRITEAOF å‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼Œ Redis éœ€è¦åˆ›å»ºå½“å‰æœåŠ¡å™¨è¿›ç¨‹çš„å­è¿›ç¨‹ï¼Œ è€Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼ˆ<a href="http://en.wikipedia.org/wiki/Copy-on-write" target="_blank" rel="external">copy-on-write</a>ï¼‰æŠ€æœ¯æ¥ä¼˜åŒ–å­è¿›ç¨‹çš„ä½¿ç”¨æ•ˆç‡ï¼Œ æ‰€ä»¥åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´ï¼Œ æœåŠ¡å™¨ä¼šæé«˜æ‰§è¡Œæ‰©å±•æ“ä½œæ‰€éœ€çš„è´Ÿè½½å› å­ï¼Œ ä»è€Œå°½å¯èƒ½åœ°é¿å…åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´è¿›è¡Œå“ˆå¸Œè¡¨æ‰©å±•æ“ä½œï¼Œ è¿™å¯ä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜å†™å…¥æ“ä½œï¼Œ æœ€å¤§é™åº¦åœ°èŠ‚çº¦å†…å­˜ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œ å½“å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å°äº 0.1 æ—¶ï¼Œ ç¨‹åºè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ”¶ç¼©æ“ä½œã€‚</p>
<h1 id="æ¸è¿›å¼-rehash"><a href="#æ¸è¿›å¼-rehash" class="headerlink" title="æ¸è¿›å¼ rehash"></a>æ¸è¿›å¼ rehash</h1><p>ä¸Šä¸€èŠ‚è¯´è¿‡ï¼Œ æ‰©å±•æˆ–æ”¶ç¼©å“ˆå¸Œè¡¨éœ€è¦å°† ht[0] é‡Œé¢çš„æ‰€æœ‰é”®å€¼å¯¹ rehash åˆ° ht[1] é‡Œé¢ï¼Œ ä½†æ˜¯ï¼Œ è¿™ä¸ª rehash åŠ¨ä½œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼åœ°å®Œæˆçš„ï¼Œ è€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼åœ°å®Œæˆçš„ã€‚</p>
<p>è¿™æ ·åšçš„åŸå› åœ¨äºï¼Œ å¦‚æœ ht[0] é‡Œåªä¿å­˜ç€å››ä¸ªé”®å€¼å¯¹ï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å¯ä»¥åœ¨ç¬é—´å°±å°†è¿™äº›é”®å€¼å¯¹å…¨éƒ¨ rehash åˆ° ht[1] ï¼› ä½†æ˜¯ï¼Œ å¦‚æœå“ˆå¸Œè¡¨é‡Œä¿å­˜çš„é”®å€¼å¯¹æ•°é‡ä¸æ˜¯å››ä¸ªï¼Œ è€Œæ˜¯å››ç™¾ä¸‡ã€å››åƒä¸‡ç”šè‡³å››äº¿ä¸ªé”®å€¼å¯¹ï¼Œ é‚£ä¹ˆè¦ä¸€æ¬¡æ€§å°†è¿™äº›é”®å€¼å¯¹å…¨éƒ¨ rehash åˆ° ht[1] çš„è¯ï¼Œ åºå¤§çš„è®¡ç®—é‡å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨åœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢æœåŠ¡ã€‚</p>
<p>å› æ­¤ï¼Œ ä¸ºäº†é¿å… rehash å¯¹æœåŠ¡å™¨æ€§èƒ½é€ æˆå½±å“ï¼Œ æœåŠ¡å™¨ä¸æ˜¯ä¸€æ¬¡æ€§å°† ht[0] é‡Œé¢çš„æ‰€æœ‰é”®å€¼å¯¹å…¨éƒ¨ rehash åˆ° ht[1] ï¼Œ è€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼åœ°å°† ht[0] é‡Œé¢çš„é”®å€¼å¯¹æ…¢æ…¢åœ° rehash åˆ° ht[1] ã€‚</p>
<p>ä»¥ä¸‹æ˜¯å“ˆå¸Œè¡¨æ¸è¿›å¼ rehash çš„è¯¦ç»†æ­¥éª¤ï¼š</p>
<ol>
<li>ä¸º ht[1] åˆ†é…ç©ºé—´ï¼Œ è®©å­—å…¸åŒæ—¶æŒæœ‰ ht[0] å’Œ ht[1] ä¸¤ä¸ªå“ˆå¸Œè¡¨ã€‚</li>
<li>åœ¨å­—å…¸ä¸­ç»´æŒä¸€ä¸ªç´¢å¼•è®¡æ•°å™¨å˜é‡ rehashidx ï¼Œ å¹¶å°†å®ƒçš„å€¼è®¾ç½®ä¸º 0 ï¼Œ è¡¨ç¤º rehash å·¥ä½œæ­£å¼å¼€å§‹ã€‚</li>
<li>åœ¨ rehash è¿›è¡ŒæœŸé—´ï¼Œ æ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾æˆ–è€…æ›´æ–°æ“ä½œæ—¶ï¼Œ ç¨‹åºé™¤äº†æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œä»¥å¤–ï¼Œ è¿˜ä¼šé¡ºå¸¦å°† ht[0] å“ˆå¸Œè¡¨åœ¨ rehashidx ç´¢å¼•ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹ rehash åˆ° ht[1] ï¼Œ å½“ rehash å·¥ä½œå®Œæˆä¹‹åï¼Œ ç¨‹åºå°† rehashidx å±æ€§çš„å€¼å¢ä¸€ã€‚</li>
<li>éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œ æœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œ ht[0] çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½ä¼šè¢« rehash è‡³ ht[1] ï¼Œ è¿™æ—¶ç¨‹åºå°† rehashidx å±æ€§çš„å€¼è®¾ä¸º -1 ï¼Œ è¡¨ç¤º rehash æ“ä½œå·²å®Œæˆã€‚<br>æ¸è¿›å¼ rehash çš„å¥½å¤„åœ¨äºå®ƒé‡‡å–åˆ†è€Œæ²»ä¹‹çš„æ–¹å¼ï¼Œ å°† rehash é”®å€¼å¯¹æ‰€éœ€çš„è®¡ç®—å·¥ä½œå‡æ»©åˆ°å¯¹å­—å…¸çš„æ¯ä¸ªæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾å’Œæ›´æ–°æ“ä½œä¸Šï¼Œ ä»è€Œé¿å…äº†é›†ä¸­å¼ rehash è€Œå¸¦æ¥çš„åºå¤§è®¡ç®—é‡ã€‚</li>
</ol>
<p>å›¾ 4-12 è‡³å›¾ 4-17 å±•ç¤ºäº†ä¸€æ¬¡å®Œæ•´çš„æ¸è¿›å¼ rehash è¿‡ç¨‹ï¼Œ æ³¨æ„è§‚å¯Ÿåœ¨æ•´ä¸ª rehash è¿‡ç¨‹ä¸­ï¼Œ å­—å…¸çš„ rehashidx å±æ€§æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚<br><a href="http://idiotsky.me/images/redis-dict-12.png"><img src="http://idiotsky.me/images/redis-dict-12.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-13.png"><img src="http://idiotsky.me/images/redis-dict-13.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-14.png"><img src="http://idiotsky.me/images/redis-dict-14.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-15.png"><img src="http://idiotsky.me/images/redis-dict-15.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-16.png"><img src="http://idiotsky.me/images/redis-dict-16.png" alt=""></a><br><a href="http://idiotsky.me/images/redis-dict-17.png"><img src="http://idiotsky.me/images/redis-dict-17.png" alt=""></a></p>
<h1 id="æ¸è¿›å¼-rehash-æ‰§è¡ŒæœŸé—´çš„å“ˆå¸Œè¡¨æ“ä½œ"><a href="#æ¸è¿›å¼-rehash-æ‰§è¡ŒæœŸé—´çš„å“ˆå¸Œè¡¨æ“ä½œ" class="headerlink" title="æ¸è¿›å¼ rehash æ‰§è¡ŒæœŸé—´çš„å“ˆå¸Œè¡¨æ“ä½œ"></a>æ¸è¿›å¼ rehash æ‰§è¡ŒæœŸé—´çš„å“ˆå¸Œè¡¨æ“ä½œ</h1><p>å› ä¸ºåœ¨è¿›è¡Œæ¸è¿›å¼ rehash çš„è¿‡ç¨‹ä¸­ï¼Œ å­—å…¸ä¼šåŒæ—¶ä½¿ç”¨ ht[0] å’Œ ht[1] ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œ æ‰€ä»¥åœ¨æ¸è¿›å¼ rehash è¿›è¡ŒæœŸé—´ï¼Œ å­—å…¸çš„åˆ é™¤ï¼ˆdeleteï¼‰ã€æŸ¥æ‰¾ï¼ˆfindï¼‰ã€æ›´æ–°ï¼ˆupdateï¼‰ç­‰æ“ä½œä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œï¼š æ¯”å¦‚è¯´ï¼Œ è¦åœ¨å­—å…¸é‡Œé¢æŸ¥æ‰¾ä¸€ä¸ªé”®çš„è¯ï¼Œ ç¨‹åºä¼šå…ˆåœ¨ ht[0] é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ï¼Œ å¦‚æœæ²¡æ‰¾åˆ°çš„è¯ï¼Œ å°±ä¼šç»§ç»­åˆ° ht[1] é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ï¼Œ è¯¸å¦‚æ­¤ç±»ã€‚</p>
<p>å¦å¤–ï¼Œ åœ¨æ¸è¿›å¼ rehash æ‰§è¡ŒæœŸé—´ï¼Œ æ–°æ·»åŠ åˆ°å­—å…¸çš„é”®å€¼å¯¹ä¸€å¾‹ä¼šè¢«ä¿å­˜åˆ° ht[1] é‡Œé¢ï¼Œ è€Œ ht[0] åˆ™ä¸å†è¿›è¡Œä»»ä½•æ·»åŠ æ“ä½œï¼š è¿™ä¸€æªæ–½ä¿è¯äº† ht[0] åŒ…å«çš„é”®å€¼å¯¹æ•°é‡ä¼šåªå‡ä¸å¢ï¼Œ å¹¶éšç€ rehash æ“ä½œçš„æ‰§è¡Œè€Œæœ€ç»ˆå˜æˆç©ºè¡¨ã€‚</p>
<h1 id="é‡ç‚¹å›é¡¾"><a href="#é‡ç‚¹å›é¡¾" class="headerlink" title="é‡ç‚¹å›é¡¾"></a>é‡ç‚¹å›é¡¾</h1><ul>
<li>å­—å…¸è¢«å¹¿æ³›ç”¨äºå®ç° Redis çš„å„ç§åŠŸèƒ½ï¼Œ å…¶ä¸­åŒ…æ‹¬æ•°æ®åº“å’Œå“ˆå¸Œé”®ã€‚</li>
<li>Redis ä¸­çš„å­—å…¸ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œ æ¯ä¸ªå­—å…¸å¸¦æœ‰ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œ ä¸€ä¸ªç”¨äºå¹³æ—¶ä½¿ç”¨ï¼Œ å¦ä¸€ä¸ªä»…åœ¨è¿›è¡Œ rehash æ—¶ä½¿ç”¨ã€‚</li>
<li>å½“å­—å…¸è¢«ç”¨ä½œæ•°æ®åº“çš„åº•å±‚å®ç°ï¼Œ æˆ–è€…å“ˆå¸Œé”®çš„åº•å±‚å®ç°æ—¶ï¼Œ Redis ä½¿ç”¨ MurmurHash2 ç®—æ³•æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼ã€‚</li>
<li>å“ˆå¸Œè¡¨ä½¿ç”¨é“¾åœ°å€æ³•æ¥è§£å†³é”®å†²çªï¼Œ è¢«åˆ†é…åˆ°åŒä¸€ä¸ªç´¢å¼•ä¸Šçš„å¤šä¸ªé”®å€¼å¯¹ä¼šè¿æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚</li>
<li>åœ¨å¯¹å“ˆå¸Œè¡¨è¿›è¡Œæ‰©å±•æˆ–è€…æ”¶ç¼©æ“ä½œæ—¶ï¼Œ ç¨‹åºéœ€è¦å°†ç°æœ‰å“ˆå¸Œè¡¨åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹ rehash åˆ°æ–°å“ˆå¸Œè¡¨é‡Œé¢ï¼Œ å¹¶ä¸”è¿™ä¸ª rehash è¿‡ç¨‹å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§åœ°å®Œæˆçš„ï¼Œ è€Œæ˜¯æ¸è¿›å¼åœ°å®Œæˆçš„ã€‚</li>
</ul>
<p>å‚è€ƒ <a href="http://redisbook.com" target="_blank" rel="external">http://redisbook.com</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Redis çš„æ•°æ®åº“å°±æ˜¯ä½¿ç”¨å­—å…¸æ¥ä½œä¸ºåº•å±‚å®ç°çš„, å­—å…¸è¿˜æ˜¯å“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€&lt;br&gt;Redis çš„å­—å…¸ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œ ä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œé¢å¯ä»¥æœ‰å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œ è€Œæ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å°±ä¿å­˜äº†å­—å…¸ä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;å“ˆå¸Œè¡¨&quot;&gt;&lt;a href=&quot;#å“ˆå¸Œè¡¨&quot; class=&quot;headerlink&quot; title=&quot;å“ˆå¸Œè¡¨&quot;&gt;&lt;/a&gt;å“ˆå¸Œè¡¨&lt;/h1&gt;&lt;p&gt;Redis å­—å…¸æ‰€ä½¿ç”¨çš„å“ˆå¸Œè¡¨ç”± dict.h/dictht ç»“æ„å®šä¹‰ï¼š&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;dictht&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å“ˆå¸Œè¡¨æ•°ç»„&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    dictEntry **table;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å“ˆå¸Œè¡¨å¤§å°&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; size;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// æ€»æ˜¯ç­‰äº size - 1&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; sizemask;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; used;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125; dictht;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;table å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ dict.h/dictEntry ç»“æ„çš„æŒ‡é’ˆï¼Œ æ¯ä¸ª dictEntry ç»“æ„ä¿å­˜ç€ä¸€ä¸ªé”®å€¼å¯¹ã€‚&lt;br&gt;size å±æ€§è®°å½•äº†å“ˆå¸Œè¡¨çš„å¤§å°ï¼Œ ä¹Ÿå³æ˜¯ table æ•°ç»„çš„å¤§å°ï¼Œ è€Œ used å±æ€§åˆ™è®°å½•äº†å“ˆå¸Œè¡¨ç›®å‰å·²æœ‰èŠ‚ç‚¹ï¼ˆé”®å€¼å¯¹ï¼‰çš„æ•°é‡ã€‚&lt;br&gt;sizemask å±æ€§çš„å€¼æ€»æ˜¯ç­‰äº size - 1 ï¼Œ è¿™ä¸ªå±æ€§å’Œå“ˆå¸Œå€¼ä¸€èµ·å†³å®šä¸€ä¸ªé”®åº”è¯¥è¢«æ”¾åˆ° table æ•°ç»„çš„å“ªä¸ªç´¢å¼•ä¸Šé¢ã€‚&lt;br&gt;å›¾ 4-1 å±•ç¤ºäº†ä¸€ä¸ªå¤§å°ä¸º 4 çš„ç©ºå“ˆå¸Œè¡¨ ï¼ˆæ²¡æœ‰åŒ…å«ä»»ä½•é”®å€¼å¯¹ï¼‰ã€‚&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images/redis-dict-1.png&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images/redis-dict-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="redis" scheme="http://idiotsky.me/categories/redis/"/>
    
    
      <category term="æ•°æ®ç»“æ„" scheme="http://idiotsky.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="redis" scheme="http://idiotsky.me/tags/redis/"/>
    
      <category term="hashtable" scheme="http://idiotsky.me/tags/hashtable/"/>
    
  </entry>
  
  <entry>
    <title>redisæ•°æ®ç»“æ„-é“¾è¡¨</title>
    <link href="http://idiotsky.me/2017/09/14/redis-linkedlist/"/>
    <id>http://idiotsky.me/2017/09/14/redis-linkedlist/</id>
    <published>2017-09-14T15:59:31.000Z</published>
    <updated>2017-09-24T06:30:13.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>åˆ—è¡¨é”®çš„åº•å±‚å°±æ˜¯ä¸€ä¸ªé“¾è¡¨</p>
</blockquote>
<h1 id="é“¾è¡¨èŠ‚ç‚¹"><a href="#é“¾è¡¨èŠ‚ç‚¹" class="headerlink" title="é“¾è¡¨èŠ‚ç‚¹"></a>é“¾è¡¨èŠ‚ç‚¹</h1><p>æ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨ä¸€ä¸ª adlist.h/listNode ç»“æ„æ¥è¡¨ç¤ºï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// å‰ç½®èŠ‚ç‚¹</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">prev</span>;</span></div><div class="line"></div><div class="line">    <span class="comment">// åç½®èŠ‚ç‚¹</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">listNode</span> *<span class="title">next</span>;</span></div><div class="line"></div><div class="line">    <span class="comment">// èŠ‚ç‚¹çš„å€¼</span></div><div class="line">    <span class="keyword">void</span> *value;</div><div class="line"></div><div class="line">&#125; listNode;</div></pre></td></tr></table></figure></p>
<p>å¤šä¸ª listNode å¯ä»¥é€šè¿‡ prev å’Œ next æŒ‡é’ˆç»„æˆåŒç«¯é“¾è¡¨ï¼Œ å¦‚å›¾ 3-1 æ‰€ç¤ºã€‚<br><a href="http://idiotsky.me/images/redis-linkedlist-1.png"><img src="http://idiotsky.me/images/redis-linkedlist-1.png" alt=""></a><br><a id="more"></a></p>
<h1 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h1><p>è™½ç„¶ä»…ä»…ä½¿ç”¨å¤šä¸ª listNode ç»“æ„å°±å¯ä»¥ç»„æˆé“¾è¡¨ï¼Œ ä½†ä½¿ç”¨ adlist.h/list æ¥æŒæœ‰é“¾è¡¨çš„è¯ï¼Œ æ“ä½œèµ·æ¥ä¼šæ›´æ–¹ä¾¿ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">list</span> &#123;</span></div><div class="line"></div><div class="line">    <span class="comment">// è¡¨å¤´èŠ‚ç‚¹</span></div><div class="line">    listNode *head;</div><div class="line"></div><div class="line">    <span class="comment">// è¡¨å°¾èŠ‚ç‚¹</span></div><div class="line">    listNode *tail;</div><div class="line"></div><div class="line">    <span class="comment">// é“¾è¡¨æ‰€åŒ…å«çš„èŠ‚ç‚¹æ•°é‡</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len;</div><div class="line"></div><div class="line">    <span class="comment">// èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•°</span></div><div class="line">    <span class="keyword">void</span> *(*dup)(<span class="keyword">void</span> *ptr);</div><div class="line"></div><div class="line">    <span class="comment">// èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•°</span></div><div class="line">    <span class="keyword">void</span> (*<span class="built_in">free</span>)(<span class="keyword">void</span> *ptr);</div><div class="line"></div><div class="line">    <span class="comment">// èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•°</span></div><div class="line">    <span class="keyword">int</span> (*match)(<span class="keyword">void</span> *ptr, <span class="keyword">void</span> *key);</div><div class="line"></div><div class="line">&#125; <span class="built_in">list</span>;</div></pre></td></tr></table></figure></p>
<p>list ç»“æ„ä¸ºé“¾è¡¨æä¾›äº†è¡¨å¤´æŒ‡é’ˆ head ã€è¡¨å°¾æŒ‡é’ˆ tail ï¼Œ ä»¥åŠé“¾è¡¨é•¿åº¦è®¡æ•°å™¨ len ï¼Œ è€Œ dup ã€ free å’Œ match æˆå‘˜åˆ™æ˜¯ç”¨äºå®ç°å¤šæ€é“¾è¡¨æ‰€éœ€çš„ç±»å‹ç‰¹å®šå‡½æ•°ï¼š</p>
<ul>
<li>dup å‡½æ•°ç”¨äºå¤åˆ¶é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼ï¼›</li>
<li>free å‡½æ•°ç”¨äºé‡Šæ”¾é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼ï¼›</li>
<li>match å‡½æ•°åˆ™ç”¨äºå¯¹æ¯”é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼å’Œå¦ä¸€ä¸ªè¾“å…¥å€¼æ˜¯å¦ç›¸ç­‰ã€‚</li>
</ul>
<p>å›¾ 3-2 æ˜¯ç”±ä¸€ä¸ª list ç»“æ„å’Œä¸‰ä¸ª listNode ç»“æ„ç»„æˆçš„é“¾è¡¨ï¼š<br><a href="http://idiotsky.me/images/redis-linkedlist-2.png"><img src="http://idiotsky.me/images/redis-linkedlist-2.png" alt=""></a></p>
<p>Redis çš„é“¾è¡¨å®ç°çš„ç‰¹æ€§å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>åŒç«¯ï¼š é“¾è¡¨èŠ‚ç‚¹å¸¦æœ‰ prev å’Œ next æŒ‡é’ˆï¼Œ è·å–æŸä¸ªèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„å¤æ‚åº¦éƒ½æ˜¯ O(1) ã€‚</li>
<li>æ— ç¯ï¼š è¡¨å¤´èŠ‚ç‚¹çš„ prev æŒ‡é’ˆå’Œè¡¨å°¾èŠ‚ç‚¹çš„ next æŒ‡é’ˆéƒ½æŒ‡å‘ NULL ï¼Œ å¯¹é“¾è¡¨çš„è®¿é—®ä»¥ NULL ä¸ºç»ˆç‚¹ã€‚</li>
<li>å¸¦è¡¨å¤´æŒ‡é’ˆå’Œè¡¨å°¾æŒ‡é’ˆï¼š é€šè¿‡ list ç»“æ„çš„ head æŒ‡é’ˆå’Œ tail æŒ‡é’ˆï¼Œ ç¨‹åºè·å–é“¾è¡¨çš„è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„å¤æ‚åº¦ä¸º O(1) ã€‚</li>
<li>å¸¦é“¾è¡¨é•¿åº¦è®¡æ•°å™¨ï¼š ç¨‹åºä½¿ç”¨ list ç»“æ„çš„ len å±æ€§æ¥å¯¹ list æŒæœ‰çš„é“¾è¡¨èŠ‚ç‚¹è¿›è¡Œè®¡æ•°ï¼Œ ç¨‹åºè·å–é“¾è¡¨ä¸­èŠ‚ç‚¹æ•°é‡çš„å¤æ‚åº¦ä¸º O(1) ã€‚</li>
<li>å¤šæ€ï¼š é“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨ void* æŒ‡é’ˆæ¥ä¿å­˜èŠ‚ç‚¹å€¼ï¼Œ å¹¶ä¸”å¯ä»¥é€šè¿‡ list ç»“æ„çš„ dup ã€ free ã€ match ä¸‰ä¸ªå±æ€§ä¸ºèŠ‚ç‚¹å€¼è®¾ç½®ç±»å‹ç‰¹å®šå‡½æ•°ï¼Œ æ‰€ä»¥é“¾è¡¨å¯ä»¥ç”¨äºä¿å­˜å„ç§ä¸åŒç±»å‹çš„å€¼ã€‚</li>
</ul>
<h1 id="é‡ç‚¹å›é¡¾"><a href="#é‡ç‚¹å›é¡¾" class="headerlink" title="é‡ç‚¹å›é¡¾"></a>é‡ç‚¹å›é¡¾</h1><ul>
<li>é“¾è¡¨è¢«å¹¿æ³›ç”¨äºå®ç° Redis çš„å„ç§åŠŸèƒ½ï¼Œ æ¯”å¦‚åˆ—è¡¨é”®ï¼Œ å‘å¸ƒä¸è®¢é˜…ï¼Œ æ…¢æŸ¥è¯¢ï¼Œ ç›‘è§†å™¨ï¼Œ ç­‰ç­‰ã€‚</li>
<li>æ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹ç”±ä¸€ä¸ª listNode ç»“æ„æ¥è¡¨ç¤ºï¼Œ æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œ æ‰€ä»¥ Redis çš„é“¾è¡¨å®ç°æ˜¯åŒç«¯é“¾è¡¨ã€‚</li>
<li>æ¯ä¸ªé“¾è¡¨ä½¿ç”¨ä¸€ä¸ª list ç»“æ„æ¥è¡¨ç¤ºï¼Œ è¿™ä¸ªç»“æ„å¸¦æœ‰è¡¨å¤´èŠ‚ç‚¹æŒ‡é’ˆã€è¡¨å°¾èŠ‚ç‚¹æŒ‡é’ˆã€ä»¥åŠé“¾è¡¨é•¿åº¦ç­‰ä¿¡æ¯ã€‚</li>
<li>å› ä¸ºé“¾è¡¨è¡¨å¤´èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„åç½®èŠ‚ç‚¹éƒ½æŒ‡å‘ NULL ï¼Œ æ‰€ä»¥ Redis çš„é“¾è¡¨å®ç°æ˜¯æ— ç¯é“¾è¡¨ã€‚</li>
<li>é€šè¿‡ä¸ºé“¾è¡¨è®¾ç½®ä¸åŒçš„ç±»å‹ç‰¹å®šå‡½æ•°ï¼Œ Redis çš„é“¾è¡¨å¯ä»¥ç”¨äºä¿å­˜å„ç§ä¸åŒç±»å‹çš„å€¼ã€‚</li>
</ul>
<p>å‚è€ƒ <a href="http://redisbook.com" target="_blank" rel="external">http://redisbook.com</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åˆ—è¡¨é”®çš„åº•å±‚å°±æ˜¯ä¸€ä¸ªé“¾è¡¨&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;é“¾è¡¨èŠ‚ç‚¹&quot;&gt;&lt;a href=&quot;#é“¾è¡¨èŠ‚ç‚¹&quot; class=&quot;headerlink&quot; title=&quot;é“¾è¡¨èŠ‚ç‚¹&quot;&gt;&lt;/a&gt;é“¾è¡¨èŠ‚ç‚¹&lt;/h1&gt;&lt;p&gt;æ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨ä¸€ä¸ª adlist.h/listNode ç»“æ„æ¥è¡¨ç¤ºï¼š&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;listNode&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// å‰ç½®èŠ‚ç‚¹&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;listNode&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;prev&lt;/span&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// åç½®èŠ‚ç‚¹&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;listNode&lt;/span&gt; *&lt;span class=&quot;title&quot;&gt;next&lt;/span&gt;;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// èŠ‚ç‚¹çš„å€¼&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *value;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125; listNode;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;å¤šä¸ª listNode å¯ä»¥é€šè¿‡ prev å’Œ next æŒ‡é’ˆç»„æˆåŒç«¯é“¾è¡¨ï¼Œ å¦‚å›¾ 3-1 æ‰€ç¤ºã€‚&lt;br&gt;&lt;a href=&quot;http://idiotsky.me/images/redis-linkedlist-1.png&quot;&gt;&lt;img src=&quot;http://idiotsky.me/images/redis-linkedlist-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="redis" scheme="http://idiotsky.me/categories/redis/"/>
    
    
      <category term="æ•°æ®ç»“æ„" scheme="http://idiotsky.me/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="redis" scheme="http://idiotsky.me/tags/redis/"/>
    
      <category term="é“¾è¡¨" scheme="http://idiotsky.me/tags/%E9%93%BE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>JVMæ‚è°ˆä¹‹JIT</title>
    <link href="http://idiotsky.me/2017/09/14/java-jit/"/>
    <id>http://idiotsky.me/2017/09/14/java-jit/</id>
    <published>2017-09-14T14:41:24.000Z</published>
    <updated>2017-09-19T17:15:45.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Just-In-Time"><a href="#Just-In-Time" class="headerlink" title="Just In Time"></a>Just In Time</h1><p>Just in timeç¼–è¯‘ï¼Œä¹Ÿå«åšè¿è¡Œæ—¶ç¼–è¯‘ï¼Œä¸åŒäº C / C++ è¯­è¨€ç›´æ¥è¢«ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ï¼ŒjavacæŠŠjavaçš„æºæ–‡ä»¶ç¿»è¯‘æˆäº†classæ–‡ä»¶ï¼Œè€Œclassæ–‡ä»¶ä¸­å…¨éƒ½æ˜¯Javaå­—èŠ‚ç ã€‚é‚£ä¹ˆï¼ŒJVMåœ¨åŠ è½½äº†è¿™äº›classæ–‡ä»¶ä»¥åï¼Œé’ˆå¯¹è¿™äº›å­—èŠ‚ç ï¼Œé€æ¡å–å‡ºï¼Œé€æ¡æ‰§è¡Œï¼Œè¿™ç§æ–¹æ³•å°±æ˜¯è§£é‡Šæ‰§è¡Œã€‚</p>
<p>è¿˜æœ‰ä¸€ç§ï¼Œå°±æ˜¯æŠŠè¿™äº›Javaå­—èŠ‚ç é‡æ–°ç¼–è¯‘ä¼˜åŒ–ï¼Œç”Ÿæˆæœºå™¨ç ï¼Œè®©CPUç›´æ¥æ‰§è¡Œã€‚è¿™æ ·ç¼–å‡ºæ¥çš„ä»£ç æ•ˆç‡ä¼šæ›´é«˜ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¸å¿…æŠŠæ‰€æœ‰çš„Javaæ–¹æ³•éƒ½ç¼–è¯‘æˆæœºå™¨ç ï¼Œåªéœ€è¦æŠŠè°ƒç”¨æœ€é¢‘ç¹ï¼Œå æ®CPUæ—¶é—´æœ€é•¿çš„æ–¹æ³•æ‰¾å‡ºæ¥å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ã€‚è¿™ç§è°ƒç”¨æœ€é¢‘ç¹çš„Javaæ–¹æ³•å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„çƒ­ç‚¹æ–¹æ³•ï¼ˆHotspotï¼Œè¯´ä¸å®šè¿™ä¸ªè™šæ‹Ÿæœºçš„åå­—å°±æ˜¯ä»è¿™é‡Œæ¥çš„ï¼‰ã€‚</p>
<p>è¿™ç§åœ¨è¿è¡Œæ—¶æŒ‰éœ€ç¼–è¯‘çš„æ–¹å¼å°±æ˜¯Just In Timeã€‚<br><a id="more"></a></p>
<h1 id="ä¸»è¦æŠ€æœ¯ç‚¹"><a href="#ä¸»è¦æŠ€æœ¯ç‚¹" class="headerlink" title="ä¸»è¦æŠ€æœ¯ç‚¹"></a>ä¸»è¦æŠ€æœ¯ç‚¹</h1><p>å…¶å®JITçš„ä¸»è¦æŠ€æœ¯ç‚¹ï¼Œä»å¤§çš„æ¡†æ¶ä¸Šæ¥è¯´ï¼Œéå¸¸ç®€å•ï¼Œå°±æ˜¯ç”³è¯·ä¸€å—æ—¢æœ‰å†™æƒé™åˆæœ‰æ‰§è¡Œæƒé™çš„å†…å­˜ï¼Œç„¶åæŠŠä½ è¦ç¼–è¯‘çš„Javaæ–¹æ³•ï¼Œç¿»è¯‘æˆæœºå™¨ç ï¼Œå†™å…¥åˆ°è¿™å—å†…å­˜é‡Œã€‚å½“å†éœ€è¦è°ƒç”¨åŸæ¥çš„Javaæ–¹æ³•æ—¶ï¼Œå°±è½¬å‘è°ƒç”¨è¿™å—å†…å­˜ã€‚</p>
<p>æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">inc</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, inc(<span class="number">3</span>));</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢è¿™ä¸ªä¾‹å­å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠ3åŠ 1ï¼Œç„¶åæ‰“å°å‡ºæ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹ä¸€ä¸‹å®ƒçš„æœºå™¨ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># gcc -o inc inc.c</div><div class="line"># objdump -d inc</div></pre></td></tr></table></figure></p>
<p>ç„¶ååœ¨è¿™ä¸€å †è¾“å‡ºä¸­ï¼Œå¯ä»¥æ‰¾åˆ° inc æ–¹æ³•æœ€ç»ˆè¢«ç¿»è¯‘æˆäº†è¿™æ ·çš„æœºå™¨ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">40052d:	55                   	push   %rbp</div><div class="line">40052e:	48 89 e5             	mov    %rsp,%rbp</div><div class="line">400531:	89 7d fc             	mov    %edi,-0x4(%rbp)</div><div class="line">400534:	8b 45 fc             	mov    -0x4(%rbp),%eax</div><div class="line">400537:	83 c0 01             	add    $0x1,%eax</div><div class="line">40053a:	5d                   	pop    %rbp</div><div class="line">40053b:	c3                   	retq</div></pre></td></tr></table></figure></p>
<p>æˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼ˆè¯»è€…éœ€è¦ä¸€å®šçš„x86æ±‡ç¼–è¯­è¨€çš„çŸ¥è¯†ï¼‰ã€‚</p>
<p>ç¬¬ä¸€å¥ï¼Œä¿å­˜ä¸Šä¸€ä¸ªæ ˆå¸§çš„åŸºå€ï¼Œå¹¶æŠŠå½“å‰çš„æ ˆæŒ‡é’ˆèµ‹ç»™æ ˆåŸºå€å¯„å­˜å™¨ï¼Œè¿™æ˜¯è¿›å…¥ä¸€ä¸ªå‡½æ•°çš„å¸¸è§„æ“ä½œã€‚æˆ‘ä»¬ä¸å»ç®¡å®ƒã€‚</p>
<p>ç¬¬ä¸‰å¥ï¼ŒæŠŠediå­˜åˆ°æ ˆä¸Šã€‚åœ¨x64å¤„ç†å™¨ä¸Šï¼Œå‰6ä¸ªå‚æ•°éƒ½æ˜¯ä½¿ç”¨å¯„å­˜å™¨ä¼ å‚çš„ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ä¼šä½¿ç”¨rdiï¼Œç¬¬äºŒä¸ªå‚æ•°ä½¿ç”¨ rsiï¼Œç­‰ç­‰ã€‚æ‰€ä»¥ edi é‡Œå­˜çš„å…¶å®å°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ•´æ•° 3ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨rdiçš„ä½32ä½ï¼Œä¹Ÿå°±æ˜¯ edi å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çš„å…¥å‚ a æ˜¯ int å‹å•Šã€‚å¤§å®¶å¯ä»¥æ¢æˆ long å‹çœ‹çœ‹æ•ˆæœã€‚</p>
<p>ç¬¬å››å¥ï¼ŒæŠŠä¸Šä¸€æ­¥å­˜åˆ°æ ˆä¸Šçš„é‚£ä¸ªæ•´æ•°å†å­˜è¿› eax ä¸­ã€‚</p>
<p>ç¬¬äº”å¥å¾€åï¼ŒæŠŠ eax åŠ ä¸Š 1ï¼Œ ç„¶åå°±é€€æ ˆï¼Œè¿”å›ã€‚æŒ‰ç…§x64çš„è§„å®šï¼ˆABIï¼‰ï¼Œè¿”å›å€¼é€šè¿‡eaxä¼ é€’ã€‚</p>
<p>æˆ‘ä»¬çœ‹åˆ°äº†ï¼Œå…¶å®ç¬¬ä¸‰å¥ï¼Œç¬¬å››å¥å¥½åƒæ ¹æœ¬æ²¡æœ‰å­˜åœ¨çš„å¿…è¦ï¼Œgcc é»˜è®¤æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„æœºå™¨ç æœ‰ç‚¹å‚»ï¼Œå®ƒæ€»è¦æŠŠå…¥å‚æ”¾åˆ°æ ˆä¸Šï¼Œä½†å…¶å®ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥ç›´æ¥æŠŠå‚æ•°ä» rdi ä¸­æ”¾å…¥åˆ° rax ä¸­çš„ã€‚ä¸æ»¡æ„ã€‚é‚£æˆ‘ä»¬å¯ä»¥è‡ªå·±æ”¹ä¸€ä¸‹ï¼Œè®©å®ƒæ›´ç²¾ç®€ä¸€ç‚¹ã€‚æ€ä¹ˆåšå‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯è¿è¡Œæ—¶ä¿®æ”¹ inc çš„é€»è¾‘ã€‚<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;memory.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(* inc_func)</span><span class="params">(<span class="keyword">int</span> a)</span></span>; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> code[] = &#123; </div><div class="line">        <span class="number">0x55</span>,             <span class="comment">// push rbp</span></div><div class="line">        <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe5</span>, <span class="comment">// mov rsp, rbp</span></div><div class="line">        <span class="number">0x89</span>, <span class="number">0xf8</span>,       <span class="comment">// mov edi, eax</span></div><div class="line">        <span class="number">0x83</span>, <span class="number">0xc0</span>, <span class="number">0x01</span>, <span class="comment">// add $1, eax</span></div><div class="line">        <span class="number">0x5d</span>,             <span class="comment">// pop rbp</span></div><div class="line">        <span class="number">0xc3</span>              <span class="comment">// ret</span></div><div class="line">    &#125;;  </div><div class="line"></div><div class="line">    <span class="keyword">void</span> * temp = mmap(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(code), PROT_WRITE | PROT_EXEC,</div><div class="line">            MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>); </div><div class="line"></div><div class="line">    <span class="built_in">memcpy</span>(temp, code, <span class="keyword">sizeof</span>(code));</div><div class="line">    inc_func p_inc = (inc_func)temp;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, p_inc(<span class="number">7</span>));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† mmap æ¥ç”³è¯·äº†ä¸€å—æœ‰å†™æƒé™å’Œæ‰§è¡Œæƒé™çš„å†…å­˜ï¼Œç„¶åæŠŠæˆ‘ä»¬æ‰‹å†™çš„æœºå™¨ç æ‹·è¿›å»ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å‘è¿™å—å†…å­˜ï¼Œå¹¶ä¸”è°ƒç”¨å®ƒã€‚é€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œè¿™ä¸€æ®µæ‰‹å†™çš„æœºå™¨ç äº†ã€‚</p>
<p>è¿è¡Œä¸€ä¸‹çœ‹çœ‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># gcc -o inc_a inc_a.c </div><div class="line"># ./inc_a</div><div class="line">8</div></pre></td></tr></table></figure></p>
<p>å†å›æƒ³ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬é€šè¿‡æ‰‹å†™æœºå™¨ç æŠŠåŸæ¥çš„ inc å‡½æ•°ä»£æ›¿æ‰äº†ã€‚åœ¨æ–°çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ˜¯ä½¿ç”¨ç¨‹åºä¸­å®šä¹‰çš„æ•°æ®æ¥é‡æ–°é€ äº†ä¸€ä¸ª inc å‡½æ•°ã€‚è¿™ç§åœ¨è¿è¡Œçš„è¿‡ç¨‹åˆ›å»ºæ–°çš„å‡½æ•°çš„æ–¹å¼ï¼Œå°±æ˜¯JITçš„æ ¸å¿ƒæ“ä½œã€‚</p>
<h1 id="è§£é‡Šå™¨ï¼ŒC1å’ŒC2"><a href="#è§£é‡Šå™¨ï¼ŒC1å’ŒC2" class="headerlink" title="è§£é‡Šå™¨ï¼ŒC1å’ŒC2"></a>è§£é‡Šå™¨ï¼ŒC1å’ŒC2</h1><p>åœ¨Hotspotä¸­ï¼Œè§£é‡Šå™¨æ˜¯ä¸ºæ¯ä¸€ä¸ªå­—èŠ‚ç ç”Ÿæˆä¸€å°æ®µæœºå™¨ç ï¼Œåœ¨æ‰§è¡ŒJavaæ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡å–ä¸€æ¡æŒ‡ä»¤ï¼Œç„¶åå°±å»æ‰§è¡Œè¿™ä¸€ä¸ªæŒ‡ä»¤æ‰€å¯¹åº”çš„é‚£ä¸€æ®µæœºå™¨ç ã€‚256æ¡æŒ‡ä»¤ï¼Œå°±ç»„æˆäº†ä¸€ä¸ªè¡¨ï¼Œåœ¨è¿™ä¸ªè¡¨é‡Œï¼Œæ¯ä¸€æ¡æŒ‡ä»¤éƒ½å¯¹åº”ä¸€æ®µæœºå™¨ç ï¼Œå½“æ‰§è¡Œåˆ°æŸä¸€æ¡æŒ‡ä»¤æ—¶ï¼Œå°±ä»è¿™ä¸ªè¡¨é‡Œå»æŸ¥è¿™æ®µæœºå™¨ç ï¼Œå¹¶ä¸”é€šè¿‡ jmp æŒ‡ä»¤å»æ‰§è¡Œè¿™æ®µæœºå™¨ç å°±è¡Œäº†ã€‚</p>
<p>è¿™ç§æ–¹å¼è¢«ç§°ä¸ºæ¨¡æ¿è§£é‡Šå™¨ã€‚</p>
<p>æ¨¡æ¿è§£é‡Šå™¨ç”Ÿæˆçš„ä»£ç æœ‰å¾ˆå¤šå†—ä½™ï¼Œå°±åƒæˆ‘ä»¬ä¸Šé¢çš„ç¬¬ä¸€ä¸ªä¾‹å­é‚£æ ·ã€‚ä¸ºäº†ç”Ÿæˆæ›´ç²¾ç®€çš„æœºå™¨ç ï¼Œæˆ‘ä»¬å¯ä»¥å¼•å…¥ç¼–è¯‘å™¨ä¼˜åŒ–æ‰‹æ®µï¼Œä¾‹å¦‚å…¨å±€å€¼ç¼–ç ï¼Œæ­»ä»£ç æ¶ˆé™¤ï¼Œæ ‡é‡å±•å¼€ï¼Œå…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤ï¼Œå¸¸é‡ä¼ æ’­ç­‰ç­‰ã€‚è¿™æ ·ç”Ÿæˆå‡ºæ¥çš„æœºå™¨ç ä¼šæ›´åŠ ä¼˜åŒ–ã€‚</p>
<p>ä½†æ˜¯ï¼Œç”Ÿæˆæœºå™¨ç çš„è´¨é‡è¶Šé«˜ï¼Œæ‰€éœ€è¦çš„æ—¶é—´ä¹Ÿå°±è¶Šé•¿ã€‚JITçº¿ç¨‹ä¹Ÿæ˜¯è¦æŒ¤å Java åº”ç”¨çº¿ç¨‹çš„èµ„æºçš„ã€‚æ‰€ä»¥C1æ˜¯ä¸€ä¸ªæŠ˜è¡·ï¼Œç¼–è¯‘æ—¶é—´æ—¢ä¸ä¼šå¤ªé•¿ï¼Œç”Ÿæˆçš„æœºå™¨ç çš„æŒ‡ä»¤ä¹Ÿä¸æ˜¯æœ€ä¼˜åŒ–çš„ï¼Œä½†è‚¯å®šæ¯”è§£é‡Šå™¨çš„æ•ˆç‡è¦é«˜å¾ˆå¤šã€‚</p>
<p>å¦‚æœä¸€ä¸ªJavaæ–¹æ³•è°ƒç”¨å¾—è¶³å¤Ÿé¢‘ç¹ï¼Œé‚£å°±æ›´å€¼å¾—èŠ±å¤§åŠ›æ°”å»ä¸ºå®ƒç”Ÿæˆæ›´ä¼˜è´¨çš„æœºå™¨ç ï¼Œè¿™æ—¶å°±ä¼šè§¦å‘C2ç¼–è¯‘ï¼Œc2æ˜¯ä¸€ä¸ªè¿è¡Œå¾—æ›´æ…¢ï¼Œä½†å´èƒ½ç”Ÿæˆæ›´é«˜æ•ˆä»£ç çš„ç¼–è¯‘å™¨ã€‚</p>
<p>ç”±æ­¤ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå…¶å®Javaçš„è¿è¡Œï¼Œå‡ ä¹å…¨éƒ¨éƒ½ä¾èµ–è¿è¡Œæ—¶ç”Ÿæˆçš„æœºå™¨ç ä¸Šã€‚æ‰€ä»¥ï¼Œå¯¹äºæ–‡ç« å¼€å¤´çš„é‚£ä¸ªé—®é¢˜â€œJavaæ˜¯è¿è¡Œåœ¨C++ä¸Šçš„å—ï¼Ÿâ€ï¼Œå¤§å®¶åº”è¯¥éƒ½æœ‰è‡ªå·±çš„ç­”æ¡ˆäº†ã€‚è¿™ä¸ªé—®é¢˜æ— æ³•ç®€å•åœ°å›ç­”æ˜¯æˆ–è€…ä¸æ˜¯ï¼Œæ­£ç¡®ç­”æ¡ˆå°±æ˜¯Javaçš„è¿è¡Œä¾èµ–æ¨¡æ¿è§£é‡Šå™¨å’ŒJITç¼–è¯‘å™¨ã€‚</p>
<h1 id="å¤šè¯´ä¸€ç‚¹ä¼˜åŒ–"><a href="#å¤šè¯´ä¸€ç‚¹ä¼˜åŒ–" class="headerlink" title="å¤šè¯´ä¸€ç‚¹ä¼˜åŒ–"></a>å¤šè¯´ä¸€ç‚¹ä¼˜åŒ–</h1><p>æˆ‘ä»¬è¿™èŠ‚è¯¾æ‰€ä¸¾çš„ä¾‹å­ä¸­ï¼Œå¯ä»¥åšæ›´å¤šçš„ä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼Œæ—¢ç„¶æˆ‘è¿›åˆ°incå‡½æ•°ä»¥åï¼Œå®Œå…¨æ²¡æœ‰ä½¿ç”¨æ ˆï¼Œé‚£å…¶å®ï¼Œæˆ‘å°±ä¸è¦å†ä¸ºå®ƒå¼€è¾Ÿæ ˆå¸§äº†ã€‚æ‰€ä»¥å¯ä»¥æŠŠpush rbp, pop rbpçš„é€»è¾‘éƒ½å»æ‰ã€‚</p>
<p>è¿›ä¸€æ­¥ä¼˜åŒ–æˆè¿™æ ·ï¼š<br>inc_b.c<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> code[] = &#123; </div><div class="line">    <span class="number">0x89</span>, <span class="number">0xf8</span>,       <span class="comment">// mov edi, eax</span></div><div class="line">    <span class="number">0x83</span>, <span class="number">0xc0</span>, <span class="number">0x01</span>, <span class="comment">// add $1, eax</span></div><div class="line">    <span class="number">0xc3</span>              <span class="comment">// ret</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‡ä»¤æ›´åŠ ç²¾ç®€äº†ã€‚æˆ‘ä»¬é‡æ–°ç¼–è¯‘è¿è¡Œï¼Œè¿˜æ˜¯èƒ½æˆåŠŸæ‰“å°å‡º8ã€‚</p>
<p>æ ¹æ®è¿™ä¸ªé—®é¢˜ï¼š<a href="https://www.zhihu.com/question/61724266" target="_blank" rel="external">ä¸ºä»€ä¹ˆ lea ä¼šè¢«ç”¨æ¥è®¡ç®—ï¼Ÿ</a></p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥å†™å‡ºæ›´ä¼˜åŒ–çš„ä»£ç æ¥ï¼š<br>inc_c.c<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> code[] = &#123; </div><div class="line">    <span class="number">0x8d</span>, <span class="number">0x47</span>, <span class="number">0x01</span>,    <span class="comment">// lea 0x1(rdi), rax</span></div><div class="line">    <span class="number">0xc3</span>                 <span class="comment">// ret</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>å¦‚æœå¼€å¯ gcc çš„ä¼˜åŒ–ç¼–è¯‘ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—åˆ°è¿™æ ·çš„ä»£ç ï¼Œä¾‹å¦‚ï¼Œè¿˜æ˜¯é’ˆå¯¹è¿™ä¸ªæ–¹æ³•ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">inc</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨ -O2 ä¼˜åŒ–ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># gcc -o inc inc.c -O2</div><div class="line"># objdump -d inc</div></pre></td></tr></table></figure></p>
<p>å°±å¯ä»¥çœ‹åˆ°ï¼Œinc çš„æœºå™¨ç å˜æˆè¿™æ ·äº†ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">00000000004005f0 &lt;inc&gt;:</div><div class="line">  4005f0:	8d 47 01             	lea    0x1(%rdi),%eax</div><div class="line">  4005f3:	c3                   	retq</div></pre></td></tr></table></figure></p>
<p>è¿™å’Œæˆ‘ä»¬æ‰‹å†™çš„ä¼˜åŒ–çš„æœºå™¨ç æ˜¯å®Œå…¨ä¸€æ ·çš„äº†ã€‚</p>
<p>å®é™…ä¸Šï¼ŒC1å’ŒC2æ‰€è¦åšçš„å’Œgccçš„ä¼˜åŒ–ç¼–è¯‘æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯ä½¿ç”¨ç‰¹å®šçš„æ–¹æ³•ç”Ÿæˆæ›´é«˜æ•ˆçš„æœºå™¨ç ã€‚ä½†æ˜¯ä»åŸç†ä¸Šæ¥è¯´ï¼Œè¿è¡Œæ—¶ç”Ÿæˆæœºå™¨ç è¿™ä¸ªæŠ€æœ¯ï¼Œå¤§å®¶éƒ½æ˜¯ç›¸é€šçš„ã€‚</p>
<p>ä»£ç <a href="https://github.com/ejunjsh/c-code/tree/master/inc" target="_blank" rel="external">https://github.com/ejunjsh/c-code/tree/master/inc</a><br>å‚è€ƒ<a href="https://zhuanlan.zhihu.com/p/28476709" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/28476709</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Just-In-Time&quot;&gt;&lt;a href=&quot;#Just-In-Time&quot; class=&quot;headerlink&quot; title=&quot;Just In Time&quot;&gt;&lt;/a&gt;Just In Time&lt;/h1&gt;&lt;p&gt;Just in timeç¼–è¯‘ï¼Œä¹Ÿå«åšè¿è¡Œæ—¶ç¼–è¯‘ï¼Œä¸åŒäº C / C++ è¯­è¨€ç›´æ¥è¢«ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ï¼ŒjavacæŠŠjavaçš„æºæ–‡ä»¶ç¿»è¯‘æˆäº†classæ–‡ä»¶ï¼Œè€Œclassæ–‡ä»¶ä¸­å…¨éƒ½æ˜¯Javaå­—èŠ‚ç ã€‚é‚£ä¹ˆï¼ŒJVMåœ¨åŠ è½½äº†è¿™äº›classæ–‡ä»¶ä»¥åï¼Œé’ˆå¯¹è¿™äº›å­—èŠ‚ç ï¼Œé€æ¡å–å‡ºï¼Œé€æ¡æ‰§è¡Œï¼Œè¿™ç§æ–¹æ³•å°±æ˜¯è§£é‡Šæ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;è¿˜æœ‰ä¸€ç§ï¼Œå°±æ˜¯æŠŠè¿™äº›Javaå­—èŠ‚ç é‡æ–°ç¼–è¯‘ä¼˜åŒ–ï¼Œç”Ÿæˆæœºå™¨ç ï¼Œè®©CPUç›´æ¥æ‰§è¡Œã€‚è¿™æ ·ç¼–å‡ºæ¥çš„ä»£ç æ•ˆç‡ä¼šæ›´é«˜ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬ä¸å¿…æŠŠæ‰€æœ‰çš„Javaæ–¹æ³•éƒ½ç¼–è¯‘æˆæœºå™¨ç ï¼Œåªéœ€è¦æŠŠè°ƒç”¨æœ€é¢‘ç¹ï¼Œå æ®CPUæ—¶é—´æœ€é•¿çš„æ–¹æ³•æ‰¾å‡ºæ¥å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ã€‚è¿™ç§è°ƒç”¨æœ€é¢‘ç¹çš„Javaæ–¹æ³•å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„çƒ­ç‚¹æ–¹æ³•ï¼ˆHotspotï¼Œè¯´ä¸å®šè¿™ä¸ªè™šæ‹Ÿæœºçš„åå­—å°±æ˜¯ä»è¿™é‡Œæ¥çš„ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ç§åœ¨è¿è¡Œæ—¶æŒ‰éœ€ç¼–è¯‘çš„æ–¹å¼å°±æ˜¯Just In Timeã€‚&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="jvm" scheme="http://idiotsky.me/tags/jvm/"/>
    
      <category term="jit" scheme="http://idiotsky.me/tags/jit/"/>
    
  </entry>
  
  <entry>
    <title>openstackå®‰è£…-neutron(äºŒ)</title>
    <link href="http://idiotsky.me/2017/09/14/openstack-install-neutron-2/"/>
    <id>http://idiotsky.me/2017/09/14/openstack-install-neutron-2/</id>
    <published>2017-09-14T11:11:12.000Z</published>
    <updated>2017-11-03T15:44:33.615Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>take the placeâ€¦.</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;take the placeâ€¦.&lt;/p&gt;
&lt;/blockquote&gt;

    
    </summary>
    
      <category term="openstack" scheme="http://idiotsky.me/categories/openstack/"/>
    
    
      <category term="openstack" scheme="http://idiotsky.me/tags/openstack/"/>
    
      <category term="ubuntu" scheme="http://idiotsky.me/tags/ubuntu/"/>
    
      <category term="kvm" scheme="http://idiotsky.me/tags/kvm/"/>
    
      <category term="neutron" scheme="http://idiotsky.me/tags/neutron/"/>
    
  </entry>
  
  <entry>
    <title>kafkaå­¦ä¹ ï¼ˆä¸€ï¼‰</title>
    <link href="http://idiotsky.me/2017/09/13/kafka-design/"/>
    <id>http://idiotsky.me/2017/09/13/kafka-design/</id>
    <published>2017-09-13T13:38:51.000Z</published>
    <updated>2017-09-14T13:22:33.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>to be continue</p>
</blockquote>
<a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;to be continue&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="kafka" scheme="http://idiotsky.me/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>openstackå®‰è£…-neutron(ä¸€)</title>
    <link href="http://idiotsky.me/2017/09/13/openstack-install-neutron-1/"/>
    <id>http://idiotsky.me/2017/09/13/openstack-install-neutron-1/</id>
    <published>2017-09-13T11:11:12.000Z</published>
    <updated>2017-11-03T15:44:21.707Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>take the placeâ€¦.</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;take the placeâ€¦.&lt;/p&gt;
&lt;/blockquote&gt;

    
    </summary>
    
      <category term="openstack" scheme="http://idiotsky.me/categories/openstack/"/>
    
    
      <category term="openstack" scheme="http://idiotsky.me/tags/openstack/"/>
    
      <category term="ubuntu" scheme="http://idiotsky.me/tags/ubuntu/"/>
    
      <category term="kvm" scheme="http://idiotsky.me/tags/kvm/"/>
    
      <category term="neutron" scheme="http://idiotsky.me/tags/neutron/"/>
    
  </entry>
  
</feed>
