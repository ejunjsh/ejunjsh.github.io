<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>IdiotSky</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://idiotsky.top/"/>
  <updated>2018-11-04T07:23:38.199Z</updated>
  <id>http://idiotsky.top/</id>
  
  <author>
    <name>ejunjsh</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>dockeræ€»ç»“</title>
    <link href="http://idiotsky.top/2018/10/24/docker-summary/"/>
    <id>http://idiotsky.top/2018/10/24/docker-summary/</id>
    <published>2018-10-24T14:50:22.000Z</published>
    <updated>2018-11-04T07:23:38.199Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ä¸æƒ³åˆ†å‡ ç« äº†ï¼Œæ‰€ä»¥å¾ˆé•¿å¾ˆé•¿ğŸ‘¿</p>
</blockquote>
<h1 id="docker-å®¹å™¨çš„çŠ¶æ€æœº"><a href="#docker-å®¹å™¨çš„çŠ¶æ€æœº" class="headerlink" title="docker å®¹å™¨çš„çŠ¶æ€æœº"></a>docker å®¹å™¨çš„çŠ¶æ€æœº</h1><p><a href="http://idiotsky.top/images3/docker-summary-1.jpg"><img src="http://idiotsky.top/images3/docker-summary-1.jpg" alt=""></a></p>
<p>ä¸€ä¸ªå®¹å™¨åœ¨æŸä¸ªæ—¶åˆ»å¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p>
<ul>
<li>createdï¼šå·²ç»è¢«åˆ›å»º ï¼ˆä½¿ç”¨ docker ps -a å‘½ä»¤å¯ä»¥åˆ—å‡ºï¼‰ä½†æ˜¯è¿˜æ²¡æœ‰è¢«å¯åŠ¨ ï¼ˆä½¿ç”¨ docker ps å‘½ä»¤è¿˜æ— æ³•åˆ—å‡ºï¼‰</li>
<li>runningï¼šè¿è¡Œä¸­</li>
<li>pausedï¼šå®¹å™¨çš„è¿›ç¨‹è¢«æš‚åœäº†</li>
<li>restartingï¼šå®¹å™¨çš„è¿›ç¨‹æ­£åœ¨é‡å¯è¿‡ç¨‹ä¸­</li>
<li>exitedï¼šä¸Šå›¾ä¸­çš„ stopped çŠ¶æ€ï¼Œè¡¨ç¤ºå®¹å™¨ä¹‹å‰è¿è¡Œè¿‡ä½†æ˜¯ç°åœ¨å¤„äºåœæ­¢çŠ¶æ€ï¼ˆè¦åŒºåˆ«äº created çŠ¶æ€ï¼Œå®ƒæ˜¯æŒ‡ä¸€ä¸ªæ–°åˆ›å‡ºçš„å°šæœªè¿è¡Œè¿‡çš„å®¹å™¨ï¼‰ã€‚å¯ä»¥é€šè¿‡ start å‘½ä»¤ä½¿å…¶é‡æ–°è¿›å…¥ running çŠ¶æ€</li>
<li>destroyedï¼šå®¹å™¨è¢«åˆ é™¤äº†ï¼Œå†ä¹Ÿä¸å­˜åœ¨äº†</li>
</ul>
<a id="more"></a>
<h1 id="Docker-å‘½ä»¤æ¦‚è¿°"><a href="#Docker-å‘½ä»¤æ¦‚è¿°" class="headerlink" title="Docker å‘½ä»¤æ¦‚è¿°"></a>Docker å‘½ä»¤æ¦‚è¿°</h1><p>æˆ‘ä»¬å¯ä»¥æŠŠDocker çš„å‘½ä»¤å¤§æ¦‚åœ°åˆ†ç±»å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">é•œåƒæ“ä½œï¼š</span><br><span class="line">    build     Build an image from a Dockerfile</span><br><span class="line">    commit    Create a new image from a container&apos;s changes</span><br><span class="line">    images    List images</span><br><span class="line">    load      Load an image from a tar archive or STDIN</span><br><span class="line">    pull      Pull an image or a repository from a registry</span><br><span class="line">    push      Push an image or a repository to a registry</span><br><span class="line">    rmi       Remove one or more images</span><br><span class="line">    search    Search the Docker Hub for images</span><br><span class="line">    tag       Tag an image into a repository</span><br><span class="line">    save      Save one or more images to a tar archive (streamed to STDOUT by default)</span><br><span class="line">    history   æ˜¾ç¤ºæŸé•œåƒçš„å†å²</span><br><span class="line">    inspect   è·å–é•œåƒçš„è¯¦ç»†ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">    å®¹å™¨åŠå…¶ä¸­åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸæ“ä½œï¼š</span><br><span class="line">    create    Create a new container ï¼ˆåˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼‰        </span><br><span class="line">    kill      Kill one or more running containers</span><br><span class="line">    inspect   Return low-level information on a container, image or task</span><br><span class="line">    pause     Pause all processes within one or more containers</span><br><span class="line">    ps        List containers</span><br><span class="line">    rm        Remove one or more containers ï¼ˆåˆ é™¤ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼‰</span><br><span class="line">    rename    Rename a container</span><br><span class="line">    restart   Restart a container</span><br><span class="line">    run       Run a command in a new container ï¼ˆåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼‰</span><br><span class="line">    start     Start one or more stopped containers ï¼ˆå¯åŠ¨ä¸€ä¸ªå¤„äºåœæ­¢çŠ¶æ€çš„å®¹å™¨ï¼‰</span><br><span class="line">    stats     Display a live stream of container(s) resource usage statistics ï¼ˆæ˜¾ç¤ºå®¹å™¨å®æ—¶çš„èµ„æºæ¶ˆè€—ä¿¡æ¯ï¼‰</span><br><span class="line">    stop      Stop one or more running containers ï¼ˆåœæ­¢ä¸€ä¸ªå¤„äºè¿è¡ŒçŠ¶æ€çš„å®¹å™¨ï¼‰</span><br><span class="line">    top       Display the running processes of a container</span><br><span class="line">    unpause   Unpause all processes within one or more containers</span><br><span class="line">    update    Update configuration of one or more containers</span><br><span class="line">    wait      Block until a container stops, then print its exit code</span><br><span class="line">    attach    Attach to a running container</span><br><span class="line">    exec      Run a command in a running container</span><br><span class="line">    port      List port mappings or a specific mapping for the container</span><br><span class="line">    logs      è·å–å®¹å™¨çš„æ—¥å¿—    </span><br><span class="line">    </span><br><span class="line">    å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼š</span><br><span class="line">    cp        Copy files/folders between a container and the local filesystem</span><br><span class="line">    diff      Inspect changes on a container&apos;s filesystem</span><br><span class="line">    export    Export a container&apos;s filesystem as a tar archive</span><br><span class="line">    import    Import the contents from a tarball to create a filesystem image</span><br><span class="line">    </span><br><span class="line">    Docker registry æ“ä½œï¼š</span><br><span class="line">    login     Log in to a Docker registry.</span><br><span class="line">    logout    Log out from a Docker registry.</span><br><span class="line">    </span><br><span class="line">    Volume æ“ä½œ</span><br><span class="line">    volume    Manage Docker volumes</span><br><span class="line">    </span><br><span class="line">    ç½‘ç»œæ“ä½œ</span><br><span class="line">    network   Manage Docker networks</span><br><span class="line">    </span><br><span class="line">    Swarm ç›¸å…³æ“ä½œ</span><br><span class="line">    swarm     Manage Docker Swarm</span><br><span class="line">    service   Manage Docker services</span><br><span class="line">    node      Manage Docker Swarm nodes       </span><br><span class="line">    </span><br><span class="line">    ç³»ç»Ÿæ“ä½œï¼š    </span><br><span class="line">    version   Show the Docker version information</span><br><span class="line">    events    Get real time events from the server  (æŒç»­è¿”å›docker äº‹ä»¶)</span><br><span class="line">    info      Display system-wide information ï¼ˆæ˜¾ç¤ºDocker ä¸»æœºç³»ç»ŸèŒƒå›´å†…çš„ä¿¡æ¯ï¼‰</span><br></pre></td></tr></table></figure>
<h1 id="Doker-å¹³å°çš„åŸºæœ¬æ„æˆ"><a href="#Doker-å¹³å°çš„åŸºæœ¬æ„æˆ" class="headerlink" title="Doker å¹³å°çš„åŸºæœ¬æ„æˆ"></a>Doker å¹³å°çš„åŸºæœ¬æ„æˆ</h1><p><a href="http://idiotsky.top/images3/docker-summary-2.jpg"><img src="http://idiotsky.top/images3/docker-summary-2.jpg" alt=""></a></p>
<p>Docker å¹³å°åŸºæœ¬ä¸Šç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯ï¼šç”¨æˆ·ä½¿ç”¨ Docker æä¾›çš„å·¥å…·ï¼ˆCLI ä»¥åŠ API ç­‰ï¼‰æ¥æ„å»ºï¼Œä¸Šä¼ é•œåƒå¹¶å‘å¸ƒå‘½ä»¤æ¥åˆ›å»ºå’Œå¯åŠ¨å®¹å™¨</li>
<li>Docker ä¸»æœºï¼šä» Docker registry ä¸Šä¸‹è½½é•œåƒå¹¶å¯åŠ¨å®¹å™¨</li>
<li>Docker registryï¼šDocker é•œåƒä»“åº“ï¼Œç”¨äºä¿å­˜é•œåƒï¼Œå¹¶æä¾›é•œåƒä¸Šä¼ å’Œä¸‹è½½</li>
</ul>
<h1 id="Docker-é•œåƒåˆ†å±‚-COW-å’Œ-é•œåƒå¤§å°ï¼ˆsizeï¼‰"><a href="#Docker-é•œåƒåˆ†å±‚-COW-å’Œ-é•œåƒå¤§å°ï¼ˆsizeï¼‰" class="headerlink" title="Docker é•œåƒåˆ†å±‚,COW å’Œ é•œåƒå¤§å°ï¼ˆsizeï¼‰"></a>Docker é•œåƒåˆ†å±‚,COW å’Œ é•œåƒå¤§å°ï¼ˆsizeï¼‰</h1><h2 id="é•œåƒåˆ†å±‚å’Œå®¹å™¨å±‚"><a href="#é•œåƒåˆ†å±‚å’Œå®¹å™¨å±‚" class="headerlink" title="é•œåƒåˆ†å±‚å’Œå®¹å™¨å±‚"></a>é•œåƒåˆ†å±‚å’Œå®¹å™¨å±‚</h2><p>ä¸€ä¸ª Docker é•œåƒæ˜¯åŸºäºåŸºç¡€é•œåƒçš„å¤šå±‚å åŠ ï¼Œæœ€ç»ˆæ„æˆå’Œå®¹å™¨çš„ rootfs ï¼ˆæ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚å½“ Docker åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå®ƒä¼šåœ¨åŸºç¡€é•œåƒçš„å®¹å™¨å±‚ä¹‹ä¸Šæ·»åŠ ä¸€å±‚æ–°çš„è–„è–„çš„å¯å†™å®¹å™¨å±‚ã€‚æ¥ä¸‹æ¥ï¼Œæ‰€æœ‰å¯¹å®¹å™¨çš„å˜åŒ–ï¼Œæ¯”å¦‚å†™æ–°çš„æ–‡ä»¶ï¼Œä¿®æ”¹å·²æœ‰æ–‡ä»¶å’Œåˆ é™¤æ–‡ä»¶ï¼Œéƒ½åªä¼šä½œç”¨åœ¨è¿™ä¸ªå®¹å™¨å±‚ä¹‹ä¸­ã€‚å› æ­¤ï¼Œé€šè¿‡ä¸æ‹·è´å®Œæ•´çš„ rootfsï¼ŒDocker å‡å°‘äº†å®¹å™¨æ‰€å ç”¨çš„ç©ºé—´ï¼Œä»¥åŠå‡å°‘äº†å®¹å™¨å¯åŠ¨æ‰€éœ€æ—¶é—´ã€‚</p>
<p><a href="http://idiotsky.top/images3/docker-summary-3.jpg"><img src="http://idiotsky.top/images3/docker-summary-3.jpg" alt=""></a></p>
<h2 id="COW-å’Œé•œåƒå¤§å°"><a href="#COW-å’Œé•œåƒå¤§å°" class="headerlink" title="COW å’Œé•œåƒå¤§å°"></a>COW å’Œé•œåƒå¤§å°</h2><p>COWï¼Œcopy-on-write æŠ€æœ¯ï¼Œä¸€æ–¹é¢å¸¦æ¥äº†å®¹å™¨å¯åŠ¨çš„å¿«æ·ï¼Œå¦ä¸€æ–¹ä¹Ÿé€ æˆäº†å®¹å™¨é•œåƒå¤§å°çš„å¢åŠ ã€‚æ¯ä¸€æ¬¡ RUN å‘½ä»¤éƒ½ä¼šåœ¨é•œåƒä¸Šå¢åŠ ä¸€å±‚ï¼Œæ¯ä¸€å±‚éƒ½ä¼šå ç”¨ç£ç›˜ç©ºé—´ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ Ubuntu 14.04 åŸºç¡€é•œåƒä¸­è¿è¡Œ RUN apt-get upgrade ä¼šåœ¨ä¿ç•™åŸºç¡€å±‚çš„åŒæ—¶å†åˆ›å»ºä¸€ä¸ªæ–°å±‚æ¥æ”¾æ‰€æœ‰æ–°çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¿®æ”¹è€çš„æ–‡ä»¶ï¼Œå› æ­¤ï¼Œæ–°çš„é•œåƒå¤§å°ä¼šè¶…è¿‡ç›´æ¥åœ¨è€çš„æ–‡ä»¶ç³»ç»Ÿä¸Šåšæ›´æ–°æ—¶çš„æ–‡ä»¶å¤§å°ã€‚å› æ­¤ï¼Œä¸ºäº†å‡å°‘é•œåƒå¤§å°èµ·è§ï¼Œæ‰€æœ‰æ–‡ä»¶ç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚åˆ é™¤ï¼Œé‡Šæ”¾å’Œç§»åŠ¨ç­‰ï¼Œéƒ½éœ€è¦å°½å¯èƒ½åœ°æ”¾åœ¨ä¸€ä¸ª RUN æŒ‡ä»¤ä¸­è¿›è¡Œã€‚</p>
<h2 id="ä½¿ç”¨å®¹å™¨éœ€è¦é¿å…çš„ä¸€äº›åšæ³•"><a href="#ä½¿ç”¨å®¹å™¨éœ€è¦é¿å…çš„ä¸€äº›åšæ³•" class="headerlink" title="ä½¿ç”¨å®¹å™¨éœ€è¦é¿å…çš„ä¸€äº›åšæ³•"></a>ä½¿ç”¨å®¹å™¨éœ€è¦é¿å…çš„ä¸€äº›åšæ³•</h2><p>è¿™ç¯‡æ–‡ç«  <a href="http://developers.redhat.com/blog/2016/02/24/10-things-to-avoid-in-docker-containers/" target="_blank" rel="noopener">10 things to avoid in docker containers</a> åˆ—ä¸¾äº†ä¸€äº›åœ¨ä½¿ç”¨å®¹å™¨æ—¶éœ€è¦é¿å…çš„åšæ³•ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>ä¸è¦åœ¨å®¹å™¨ä¸­ä¿å­˜æ•°æ®ï¼ˆDonâ€™t store data in containersï¼‰</li>
<li>å°†åº”ç”¨æ‰“åŒ…åˆ°é•œåƒå†éƒ¨ç½²è€Œä¸æ˜¯æ›´æ–°åˆ°å·²æœ‰å®¹å™¨ï¼ˆDonâ€™t ship your application in two piecesï¼‰</li>
<li>ä¸è¦äº§ç”Ÿè¿‡å¤§çš„é•œåƒ ï¼ˆDonâ€™t create large imagesï¼‰</li>
<li>ä¸è¦ä½¿ç”¨å•å±‚é•œåƒ ï¼ˆDonâ€™t use a single layer imageï¼‰</li>
<li>ä¸è¦ä»è¿è¡Œç€çš„å®¹å™¨ä¸Šäº§ç”Ÿé•œåƒ ï¼ˆDonâ€™t create images from running containers ï¼‰</li>
<li>ä¸è¦åªæ˜¯ä½¿ç”¨ â€œlatestâ€æ ‡ç­¾ ï¼ˆDonâ€™t use only the â€œlatestâ€ tagï¼‰</li>
<li>ä¸è¦åœ¨å®¹å™¨å†…è¿è¡Œè¶…è¿‡ä¸€ä¸ªçš„è¿›ç¨‹ ï¼ˆDonâ€™t run more than one process in a single container ï¼‰</li>
<li>ä¸è¦åœ¨å®¹å™¨å†…ä¿å­˜ credentialsï¼Œè€Œæ˜¯è¦ä»å¤–é¢é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ ï¼ˆ Donâ€™t store credentials in the image. Use environment variablesï¼‰</li>
<li>ä¸è¦ä½¿ç”¨ root ç”¨æˆ·è·‘å®¹å™¨è¿›ç¨‹ï¼ˆDonâ€™t run processes as a root user ï¼‰</li>
<li>ä¸è¦ä¾èµ–äºIPåœ°å€ï¼Œè€Œæ˜¯è¦ä»å¤–é¢é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ ï¼ˆDonâ€™t rely on IP addresses ï¼‰</li>
</ul>
<h1 id="Linux-namespace-çš„æ¦‚å¿µ"><a href="#Linux-namespace-çš„æ¦‚å¿µ" class="headerlink" title="Linux namespace çš„æ¦‚å¿µ"></a>Linux namespace çš„æ¦‚å¿µ</h1><p>Linux å†…æ ¸ä»ç‰ˆæœ¬ 2.4.19 å¼€å§‹é™†ç»­å¼•å…¥äº† namespace çš„æ¦‚å¿µã€‚å…¶ç›®çš„æ˜¯å°†æŸä¸ªç‰¹å®šçš„å…¨å±€ç³»ç»Ÿèµ„æºï¼ˆglobal system resourceï¼‰é€šè¿‡æŠ½è±¡æ–¹æ³•ä½¿å¾—namespace ä¸­çš„è¿›ç¨‹çœ‹èµ·æ¥æ‹¥æœ‰å®ƒä»¬è‡ªå·±çš„éš”ç¦»çš„å…¨å±€ç³»ç»Ÿèµ„æºå®ä¾‹ï¼ˆThe purpose of each namespace is to wrap a particular global system resource in an abstraction that makes it appear to the processes within the namespace that they have their own isolated instance of the global resource. ï¼‰ã€‚Linux å†…æ ¸ä¸­å®ç°äº†å…­ç§ namespaceï¼ŒæŒ‰ç…§å¼•å…¥çš„å…ˆåé¡ºåºï¼Œåˆ—è¡¨å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>namespace</th>
<th>å¼•å…¥çš„ç›¸å…³å†…æ ¸ç‰ˆæœ¬</th>
<th>è¢«éš”ç¦»çš„å…¨å±€ç³»ç»Ÿèµ„æº</th>
<th>åœ¨å®¹å™¨è¯­å¢ƒä¸‹çš„éš”ç¦»æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mount namespaces</td>
<td>Linux 2.4.19</td>
<td>æ–‡ä»¶ç³»ç»ŸæŒ‚æ¥ç‚¹</td>
<td>æ¯ä¸ªå®¹å™¨èƒ½çœ‹åˆ°ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„</td>
</tr>
<tr>
<td>ÂšUTS namespaces</td>
<td>Linux 2.6.19</td>
<td>nodename å’Œ domainname</td>
<td>æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰è‡ªå·±çš„ hostname å’Œ domainame</td>
</tr>
<tr>
<td>IPC namespaces</td>
<td>Linux 2.6.19</td>
<td>ç‰¹å®šçš„è¿›ç¨‹é—´é€šä¿¡èµ„æºï¼ŒåŒ…æ‹¬System V IPC å’Œ  POSIX message queues</td>
<td>æ¯ä¸ªå®¹å™¨æœ‰å…¶è‡ªå·±çš„ System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ª IPC namespace çš„è¿›ç¨‹ä¹‹é—´æ‰èƒ½äº’ç›¸é€šä¿¡</td>
</tr>
<tr>
<td>PID namespaces</td>
<td>Linux 2.6.24</td>
<td>è¿›ç¨‹ ID æ•°å­—ç©ºé—´ ï¼ˆprocess ID number spaceï¼‰</td>
<td>æ¯ä¸ª PID namespace ä¸­çš„è¿›ç¨‹å¯ä»¥æœ‰å…¶ç‹¬ç«‹çš„ PIDï¼› æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰å…¶ PID ä¸º 1 çš„root è¿›ç¨‹ï¼›ä¹Ÿä½¿å¾—å®¹å™¨å¯ä»¥åœ¨ä¸åŒçš„ host ä¹‹é—´è¿ç§»ï¼Œå› ä¸º namespace ä¸­çš„è¿›ç¨‹ ID å’Œ host æ— å…³äº†ã€‚è¿™ä¹Ÿä½¿å¾—å®¹å™¨ä¸­çš„æ¯ä¸ªè¿›ç¨‹æœ‰ä¸¤ä¸ªPIDï¼šå®¹å™¨ä¸­çš„ PID å’Œ host ä¸Šçš„ PIDã€‚</td>
</tr>
<tr>
<td>Network namespaces</td>
<td>å§‹äºLinux 2.6.24 å®Œæˆäº Linux 2.6.29</td>
<td>ç½‘ç»œç›¸å…³çš„ç³»ç»Ÿèµ„æº</td>
<td>æ¯ä¸ªå®¹å™¨ç”¨æœ‰å…¶ç‹¬ç«‹çš„ç½‘ç»œè®¾å¤‡ï¼ŒIP åœ°å€ï¼ŒIP è·¯ç”±è¡¨ï¼Œ/proc/net ç›®å½•ï¼Œç«¯å£å·ç­‰ç­‰ã€‚è¿™ä¹Ÿä½¿å¾—ä¸€ä¸ª host ä¸Šå¤šä¸ªå®¹å™¨å†…çš„åŒä¸€ä¸ªåº”ç”¨éƒ½ç»‘å®šåˆ°å„è‡ªå®¹å™¨çš„ 80 ç«¯å£ä¸Šã€‚</td>
</tr>
<tr>
<td>User namespaces</td>
<td>å§‹äº Linux 2.6.23 å®Œæˆäº Linux 3.8)</td>
<td>ç”¨æˆ·å’Œç»„ ID ç©ºé—´</td>
<td>åœ¨ user namespace ä¸­çš„è¿›ç¨‹çš„ç”¨æˆ·å’Œç»„ ID å¯ä»¥å’Œåœ¨ host ä¸Šä¸åŒï¼› æ¯ä¸ª container å¯ä»¥æœ‰ä¸åŒçš„ user å’Œ group idï¼›ä¸€ä¸ª host ä¸Šçš„éç‰¹æƒç”¨æˆ·å¯ä»¥æˆä¸º user namespace ä¸­çš„ç‰¹æƒç”¨æˆ·ï¼›</td>
</tr>
</tbody>
</table>
<p>Linux namespace çš„æ¦‚å¿µè¯´ç®€å•ä¹Ÿç®€å•è¯´å¤æ‚ä¹Ÿå¤æ‚ã€‚ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“ï¼Œå¤„äºæŸä¸ª namespace ä¸­çš„è¿›ç¨‹ï¼Œèƒ½çœ‹åˆ°ç‹¬ç«‹çš„å®ƒè‡ªå·±çš„éš”ç¦»çš„æŸäº›ç‰¹å®šç³»ç»Ÿèµ„æºï¼›å¤æ‚æ¥è¯´ï¼Œå¯ä»¥å»çœ‹çœ‹ Linux å†…æ ¸ä¸­å®ç° namespace çš„åŸç†ï¼Œç½‘ç»œä¸Šä¹Ÿæœ‰å¤§é‡çš„æ–‡æ¡£ä¾›å‚è€ƒï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h1 id="Docker-å®¹å™¨ä½¿ç”¨-linux-namespace-åšè¿è¡Œç¯å¢ƒéš”ç¦»"><a href="#Docker-å®¹å™¨ä½¿ç”¨-linux-namespace-åšè¿è¡Œç¯å¢ƒéš”ç¦»" class="headerlink" title="Docker å®¹å™¨ä½¿ç”¨ linux namespace åšè¿è¡Œç¯å¢ƒéš”ç¦»"></a>Docker å®¹å™¨ä½¿ç”¨ linux namespace åšè¿è¡Œç¯å¢ƒéš”ç¦»</h1><p>å½“ Docker åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå®ƒä¼šåˆ›å»ºæ–°çš„ä»¥ä¸Šå…­ç§ namespace çš„å®ä¾‹ï¼Œç„¶åæŠŠå®¹å™¨ä¸­çš„æ‰€æœ‰è¿›ç¨‹æ”¾åˆ°è¿™äº› namespace ä¹‹ä¸­ï¼Œä½¿å¾—Docker å®¹å™¨ä¸­çš„è¿›ç¨‹åªèƒ½çœ‹åˆ°éš”ç¦»çš„ç³»ç»Ÿèµ„æºã€‚ </p>
<h2 id="PID-namespace"><a href="#PID-namespace" class="headerlink" title="PID namespace"></a>PID namespace</h2><p>æˆ‘ä»¬èƒ½çœ‹åˆ°åŒä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨å®¹å™¨å†…å¤–çš„ PID æ˜¯ä¸åŒçš„ï¼š</p>
<ul>
<li>åœ¨å®¹å™¨å†… PID æ˜¯ 1ï¼ŒPPID æ˜¯ 0ã€‚</li>
<li>åœ¨å®¹å™¨å¤– PID æ˜¯ 2198ï¼Œ PPID æ˜¯ 2179 å³ docker-containerd-shim è¿›ç¨‹.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# ps -ef | grep python</span><br><span class="line">root 2198 2179 0 00:06 ? 00:00:00 python app.py</span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# ps -ef | grep 2179</span><br><span class="line">root 2179 765 0 00:06 ? 00:00:00 docker-containerd-shim 8b7dd09fbcae00373207f01e2acde45740871c9e3b98286b5458b4ea09f41b3e /var/run/docker/libcontainerd/8b7dd09fbcae00373207f01e2acde45740871c9e3b98286b5458b4ea09f41b3e docker-runc</span><br><span class="line">root 2198 2179 0 00:06 ? 00:00:00 python app.py</span><br><span class="line">root 2249 1692 0 00:06 pts/0 00:00:00 grep --color=auto 2179</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# docker exec -it web31 ps -ef</span><br><span class="line">UID PID PPID C STIME TTY TIME CMD</span><br><span class="line">root 1 0 0 16:06 ? 00:00:00 python app.py</span><br></pre></td></tr></table></figure>
<p>å…³äº containerdï¼Œcontainerd-shim å’Œ container çš„å…³ç³»ï¼Œ<a href="https://github.com/crosbymichael/dockercon-2016/blob/master/Creating%20Containerd.pdf" target="_blank" rel="noopener">æ–‡ç« </a> ä¸­çš„ä¸‹å›¾å¯ä»¥è¯´æ˜ï¼š</p>
<p><a href="http://idiotsky.top/images3/docker-summary-3.jpg"><img src="http://idiotsky.top/images3/docker-summary-3.jpg" alt=""></a></p>
<ul>
<li>Docker å¼•æ“ç®¡ç†ç€é•œåƒï¼Œç„¶åç§»äº¤ç»™ containerd è¿è¡Œï¼Œcontainerd å†ä½¿ç”¨ runC è¿è¡Œå®¹å™¨ã€‚</li>
<li>Containerd æ˜¯ä¸€ä¸ªç®€å•çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ runC ç®¡ç†å®¹å™¨ï¼Œä½¿ç”¨ gRPC æš´éœ²å®¹å™¨çš„å…¶ä»–åŠŸèƒ½ã€‚å®ƒç®¡ç†å®¹å™¨çš„å¼€å§‹ï¼Œåœæ­¢ï¼Œæš‚åœå’Œé”€æ¯ã€‚ç”±äºå®¹å™¨è¿è¡Œæ—¶æ˜¯å­¤ç«‹çš„å¼•æ“ï¼Œå¼•æ“æœ€ç»ˆèƒ½å¤Ÿå¯åŠ¨å’Œå‡çº§è€Œæ— éœ€é‡æ–°å¯åŠ¨å®¹å™¨ã€‚</li>
<li>runCæ˜¯ä¸€ä¸ªè½»é‡çº§çš„å·¥å…·ï¼Œå®ƒæ˜¯ç”¨æ¥è¿è¡Œå®¹å™¨çš„ï¼Œåªç”¨æ¥åšè¿™ä¸€ä»¶äº‹ï¼Œå¹¶ä¸”è¿™ä¸€ä»¶äº‹è¦åšå¥½ã€‚runCåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªå°å‘½ä»¤è¡Œå·¥å…·ä¸”å®ƒå¯ä»¥ä¸ç”¨é€šè¿‡Dockerå¼•æ“ï¼Œç›´æ¥å°±å¯ä»¥ä½¿ç”¨å®¹å™¨ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œå®¹å™¨ä¸­çš„ä¸»åº”ç”¨åœ¨ host ä¸Šçš„çˆ¶è¿›ç¨‹æ˜¯ containerd-shimï¼Œæ˜¯å®ƒé€šè¿‡å·¥å…· runC æ¥å¯åŠ¨è¿™äº›è¿›ç¨‹çš„ã€‚</p>
<p>è¿™ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œpid namespace é€šè¿‡å°† host ä¸Š PID æ˜ å°„ä¸ºå®¹å™¨å†…çš„ PIDï¼Œ ä½¿å¾—å®¹å™¨å†…çš„è¿›ç¨‹çœ‹èµ·æ¥æœ‰ä¸ªç‹¬ç«‹çš„ PID ç©ºé—´ã€‚</p>
<h2 id="UTS-namespace"><a href="#UTS-namespace" class="headerlink" title="UTS namespace"></a>UTS namespace</h2><p>ç±»ä¼¼åœ°ï¼Œå®¹å™¨å¯ä»¥æœ‰è‡ªå·±çš„ hostname å’Œ domainnameï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# hostname</span><br><span class="line">devstack</span><br><span class="line">root@devstack:/home/sammy# docker exec -it web31 hostname</span><br><span class="line">8b7dd09fbcae</span><br></pre></td></tr></table></figure>
<h2 id="user-namespace"><a href="#user-namespace" class="headerlink" title="user namespace"></a>user namespace</h2><p>åœ¨ Docker 1.10 ç‰ˆæœ¬ä¹‹å‰ï¼ŒDocker æ˜¯ä¸æ”¯æŒ user namespaceã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤åœ°ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹çš„è¿è¡Œç”¨æˆ·å°±æ˜¯ host ä¸Šçš„ root ç”¨æˆ·ï¼Œè¿™æ ·çš„è¯ï¼Œå½“ host ä¸Šçš„æ–‡ä»¶æˆ–è€…ç›®å½•ä½œä¸º volume è¢«æ˜ å°„åˆ°å®¹å™¨ä»¥åï¼Œå®¹å™¨å†…çš„è¿›ç¨‹å…¶å®æ˜¯æœ‰ root çš„å‡ ä¹æ‰€æœ‰æƒé™å»ä¿®æ”¹è¿™äº› host ä¸Šçš„ç›®å½•çš„ï¼Œè¿™ä¼šæœ‰å¾ˆå¤§çš„å®‰å…¨é—®é¢˜ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<ul>
<li>å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼š docker run -d -v /bin:/host/bin â€“name web34 training/webapp python app.py</li>
<li>æ­¤æ—¶è¿›ç¨‹çš„ç”¨æˆ·åœ¨å®¹å™¨å†…å’Œå¤–éƒ½æ˜¯rootï¼Œå®ƒåœ¨å®¹å™¨å†…å¯ä»¥å¯¹ host ä¸Šçš„ /bin ç›®å½•åšä»»æ„ä¿®æ”¹</li>
</ul>
<p>è€Œ Docker 1.10 ä¸­å¼•å…¥çš„ user namespace å°±å¯ä»¥è®©å®¹å™¨æœ‰ä¸€ä¸ª â€œå‡â€çš„  root ç”¨æˆ·ï¼Œå®ƒåœ¨å®¹å™¨å†…æ˜¯ rootï¼Œåœ¨å®¹å™¨å¤–æ˜¯ä¸€ä¸ªé root ç”¨æˆ·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œuser namespace å®ç°äº† host users å’Œ container users ä¹‹é—´çš„æ˜ å°„ã€‚</p>
<p>å¯ç”¨æ­¥éª¤ï¼š</p>
<ol>
<li>ä¿®æ”¹ /etc/default/docker æ–‡ä»¶ï¼Œæ·»åŠ è¡Œ  DOCKER_OPTS=â€â€“userns-remap=defaultâ€</li>
<li>é‡å¯ docker æœåŠ¡ï¼Œæ­¤æ—¶ dockerd è¿›ç¨‹ä¸º /usr/bin/dockerd â€“userns-remap=default â€“raw-logs</li>
<li>ç„¶ååˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼šdocker run -d -v /bin:/host/bin â€“name web35 training/webapp python app.py</li>
<li>æŸ¥çœ‹è¿›ç¨‹åœ¨å®¹å™¨å†…å¤–çš„ç”¨æˆ·ï¼š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# ps -ef | grep python</span><br><span class="line">231072    1726  1686  0 01:44 ?        00:00:00 python app.py</span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# docker exec web35 ps -ef</span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">root         1     0  0 17:44 ?        00:00:00 python app.py</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æ–‡ä»¶/etc/subuid å’Œ /etc/subgidï¼Œå¯ä»¥çœ‹åˆ° dockermap ç”¨æˆ·åœ¨host ä¸Šçš„ uid å’Œ gid éƒ½æ˜¯ 231072ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# cat /etc/subuid</span><br><span class="line">sammy:100000:65536</span><br><span class="line">stack:165536:65536</span><br><span class="line">dockremap:231072:65536</span><br><span class="line">root@devstack:/home/sammy# cat /etc/subgid</span><br><span class="line">sammy:100000:65536</span><br><span class="line">stack:165536:65536</span><br><span class="line">dockremap:231072:65536</span><br></pre></td></tr></table></figure>
<p>å†çœ‹æ–‡ä»¶/proc/1726/uid_mapï¼Œå®ƒè¡¨ç¤ºäº†å®¹å™¨å†…å¤–ç”¨æˆ·çš„æ˜ å°„å…³ç³»ï¼Œå³å°†host ä¸Šçš„ 231072 ç”¨æˆ·æ˜ å°„ä¸ºå®¹å™¨å†…çš„ 0 ï¼ˆå³rootï¼‰ç”¨æˆ·ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# cat /proc/1726/uid_map</span><br><span class="line">         0     231072      65536</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬è¯•å›¾åœ¨å®¹å™¨å†…ä¿®æ”¹ host ä¸Šçš„ /bin æ–‡ä»¶å¤¹ï¼Œå°±ä¼šæç¤ºæƒé™ä¸è¶³äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@80993d821f7b:/host/bin# touch test2</span><br><span class="line">touch: cannot touch &apos;test2&apos;: Permission denied</span><br></pre></td></tr></table></figure>
<p>è¿™è¯´æ˜é€šè¿‡ä½¿ç”¨ user namespaceï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ°é™åˆ¶äº†å®¹å™¨å†…è¿›ç¨‹çš„æƒé™ã€‚</p>
<h2 id="network-namespace"><a href="#network-namespace" class="headerlink" title="network namespace"></a>network namespace</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ docker å®ä¾‹è¢«åˆ›å»ºå‡ºæ¥åï¼Œä½¿ç”¨ ip netns  å‘½ä»¤æ— æ³•çœ‹åˆ°å®¹å™¨å®ä¾‹å¯¹åº”çš„ network namespaceã€‚è¿™æ˜¯å› ä¸º ip netns å‘½ä»¤æ˜¯ä» /var/run/netns æ–‡ä»¶å¤¹ä¸­è¯»å–å†…å®¹çš„ã€‚</p>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li><p>æ‰¾åˆ°å®¹å™¨çš„ä¸»è¿›ç¨‹ ID</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# docker inspect --format &apos;&#123;&#123;.State.Pid&#125;&#125;&apos; web5</span><br><span class="line">2704</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»º  /var/run/netns ç›®å½•ä»¥åŠç¬¦å·è¿æ¥</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# mkdir /var/run/netns</span><br><span class="line">root@devstack:/home/sammy# ln -s /proc/2704/ns/net /var/run/netns/web5</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ­¤æ—¶å¯ä»¥ä½¿ç”¨ ip netns å‘½ä»¤äº†</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# ip netns</span><br><span class="line">web5</span><br><span class="line">root@devstack:/home/sammy# ip netns exec web5 ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default</span><br><span class="line">link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">inet 127.0.0.1/8 scope host lo</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">inet6 ::1/128 scope host</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">15: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet 172.17.0.3/16 scope global eth0</span><br><span class="line">valid_lft forever preferred_lft forever</span><br><span class="line">inet6 fe80::42:acff:fe11:3/64 scope link</span><br><span class="line">valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="Linux-control-groups"><a href="#Linux-control-groups" class="headerlink" title="Linux control groups"></a>Linux control groups</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>Linux Cgroup å¯â€‹â€‹â€‹è®©â€‹â€‹â€‹æ‚¨â€‹â€‹â€‹ä¸ºâ€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä¸­â€‹â€‹â€‹æ‰€â€‹â€‹â€‹è¿â€‹â€‹â€‹è¡Œâ€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹ï¼ˆè¿›â€‹â€‹â€‹ç¨‹â€‹â€‹â€‹ï¼‰çš„â€‹â€‹â€‹ç”¨â€‹â€‹â€‹æˆ·â€‹â€‹â€‹å®šâ€‹â€‹â€‹ä¹‰â€‹â€‹â€‹ç»„â€‹â€‹â€‹ç¾¤â€‹â€‹â€‹åˆ†â€‹â€‹â€‹é…â€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹ â€” æ¯”â€‹â€‹â€‹å¦‚â€‹â€‹â€‹ CPU æ—¶â€‹â€‹â€‹é—´â€‹â€‹â€‹ã€â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹å†…â€‹â€‹â€‹å­˜â€‹â€‹â€‹ã€â€‹â€‹â€‹ç½‘â€‹â€‹â€‹ç»œâ€‹â€‹â€‹å¸¦â€‹â€‹â€‹å®½â€‹â€‹â€‹æˆ–â€‹â€‹â€‹è€…â€‹â€‹â€‹è¿™â€‹â€‹â€‹äº›â€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹çš„â€‹â€‹â€‹ç»„â€‹â€‹â€‹åˆâ€‹â€‹â€‹ã€‚â€‹â€‹â€‹æ‚¨â€‹â€‹â€‹å¯â€‹â€‹â€‹ä»¥â€‹â€‹â€‹ç›‘â€‹â€‹â€‹æ§â€‹â€‹â€‹æ‚¨â€‹â€‹â€‹é…â€‹â€‹â€‹ç½®â€‹â€‹â€‹çš„â€‹â€‹â€‹ cgroupï¼Œæ‹’â€‹â€‹â€‹ç»cgroup è®¿â€‹â€‹â€‹é—®â€‹â€‹â€‹æŸâ€‹â€‹â€‹äº›â€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹ï¼Œç”šâ€‹â€‹â€‹è‡³â€‹â€‹â€‹åœ¨â€‹â€‹â€‹è¿â€‹â€‹â€‹è¡Œâ€‹â€‹â€‹çš„â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä¸­â€‹â€‹â€‹åŠ¨â€‹â€‹â€‹æ€â€‹â€‹â€‹é…â€‹â€‹â€‹ç½®â€‹â€‹â€‹æ‚¨â€‹â€‹â€‹çš„â€‹â€‹â€‹ cgroupã€‚æ‰€ä»¥ï¼Œå¯ä»¥å°† controll groups ç†è§£ä¸º controller ï¼ˆsystem resourceï¼‰ ï¼ˆforï¼‰ ï¼ˆprocessï¼‰groupsï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´å®ƒä»¥ä¸€ç»„è¿›ç¨‹ä¸ºç›®æ ‡è¿›è¡Œç³»ç»Ÿèµ„æºåˆ†é…å’Œæ§åˆ¶ã€‚</p>
<p>å®ƒä¸»è¦æä¾›äº†å¦‚ä¸‹åŠŸèƒ½ï¼š </p>
<ul>
<li>Resource limitation: é™åˆ¶èµ„æºä½¿ç”¨ï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨ä¸Šé™ä»¥åŠæ–‡ä»¶ç³»ç»Ÿçš„ç¼“å­˜é™åˆ¶ã€‚</li>
<li>Prioritization: ä¼˜å…ˆçº§æ§åˆ¶ï¼Œæ¯”å¦‚ï¼šCPUåˆ©ç”¨å’Œç£ç›˜IOååã€‚</li>
<li>Accounting: ä¸€äº›å®¡è®¡æˆ–ä¸€äº›ç»Ÿè®¡ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è®¡è´¹ã€‚</li>
<li>Control: æŒ‚èµ·è¿›ç¨‹ï¼Œæ¢å¤æ‰§è¡Œè¿›ç¨‹ã€‚</li>
</ul>
<p>ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹ cgroupï¼Œç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ç®¡â€‹â€‹â€‹ç†â€‹â€‹â€‹å‘˜â€‹â€‹â€‹å¯â€‹â€‹â€‹æ›´â€‹â€‹â€‹å…·â€‹â€‹â€‹ä½“â€‹â€‹â€‹åœ°â€‹â€‹â€‹æ§â€‹â€‹â€‹åˆ¶â€‹â€‹â€‹å¯¹â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹çš„â€‹â€‹â€‹åˆ†â€‹â€‹â€‹é…â€‹â€‹â€‹ã€â€‹â€‹â€‹ä¼˜â€‹â€‹â€‹å…ˆâ€‹â€‹â€‹é¡ºâ€‹â€‹â€‹åºâ€‹â€‹â€‹ã€â€‹â€‹â€‹æ‹’â€‹â€‹â€‹ç»â€‹â€‹â€‹ã€â€‹â€‹â€‹ç®¡â€‹â€‹â€‹ç†â€‹â€‹â€‹å’Œâ€‹â€‹â€‹ç›‘â€‹â€‹â€‹æ§â€‹â€‹â€‹ã€‚â€‹â€‹â€‹å¯â€‹â€‹â€‹æ›´â€‹â€‹â€‹å¥½â€‹â€‹â€‹åœ°â€‹â€‹â€‹æ ¹â€‹â€‹â€‹æ®â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹å’Œâ€‹â€‹â€‹ç”¨â€‹â€‹â€‹æˆ·â€‹â€‹â€‹åˆ†â€‹â€‹â€‹é…â€‹â€‹â€‹ç¡¬â€‹â€‹â€‹ä»¶â€‹â€‹â€‹èµ„â€‹â€‹â€‹æºâ€‹â€‹â€‹ï¼Œæâ€‹â€‹â€‹é«˜â€‹â€‹â€‹æ€»â€‹â€‹â€‹ä½“â€‹â€‹â€‹æ•ˆâ€‹â€‹â€‹ç‡â€‹â€‹â€‹ã€‚</p>
<p>åœ¨å®è·µä¸­ï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¸€èˆ¬ä¼šåˆ©ç”¨CGroupåšä¸‹é¢è¿™äº›äº‹ï¼ˆæœ‰ç‚¹åƒä¸ºæŸä¸ªè™šæ‹Ÿæœºåˆ†é…èµ„æºä¼¼çš„ï¼‰ï¼š</p>
<ul>
<li>éš”ç¦»ä¸€ä¸ªè¿›ç¨‹é›†åˆï¼ˆæ¯”å¦‚ï¼šnginxçš„æ‰€æœ‰è¿›ç¨‹ï¼‰ï¼Œå¹¶é™åˆ¶ä»–ä»¬æ‰€æ¶ˆè´¹çš„èµ„æºï¼Œæ¯”å¦‚ç»‘å®šCPUçš„æ ¸ã€‚</li>
<li>ä¸ºè¿™ç»„è¿›ç¨‹åˆ†é…å…¶è¶³å¤Ÿä½¿ç”¨çš„å†…å­˜</li>
<li>ä¸ºè¿™ç»„è¿›ç¨‹åˆ†é…ç›¸åº”çš„ç½‘ç»œå¸¦å®½å’Œç£ç›˜å­˜å‚¨é™åˆ¶</li>
<li>é™åˆ¶è®¿é—®æŸäº›è®¾å¤‡ï¼ˆé€šè¿‡è®¾ç½®è®¾å¤‡çš„ç™½åå•ï¼‰</li>
</ul>
<p>Linux ç³»ç»Ÿä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ã€‚Linux ä¹Ÿå°† cgroups å®ç°æˆäº†æ–‡ä»¶ç³»ç»Ÿï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# mount -t cgroup</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,relatime,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu type cgroup (rw,relatime,cpu)</span><br><span class="line">systemd on /sys/fs/cgroup/systemd type cgroup (rw,noexec,nosuid,nodev,none,name=systemd)</span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# lssubsys -m</span><br><span class="line">cpuset /sys/fs/cgroup/cpuset</span><br><span class="line">cpu /sys/fs/cgroup/cpu</span><br><span class="line">cpuacct /sys/fs/cgroup/cpuacct</span><br><span class="line">memory /sys/fs/cgroup/memory</span><br><span class="line">devices /sys/fs/cgroup/devices</span><br><span class="line">freezer /sys/fs/cgroup/freezer</span><br><span class="line">blkio /sys/fs/cgroup/blkio</span><br><span class="line">perf_event /sys/fs/cgroup/perf_event</span><br><span class="line">hugetlb /sys/fs/cgroup/hugetlb</span><br><span class="line"></span><br><span class="line">root@devstack:/home/sammy# ls /sys/fs/cgroup/ -l</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 blkio</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 cpu</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 cpuacct</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 cpuset</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 devices</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 freezer</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 hugetlb</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 memory</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 perf_event</span><br><span class="line">drwxr-xr-x 3 root root 0 Sep 18 21:46 systemd</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ° /sys/fs/cgroup ç›®å½•ä¸­æœ‰è‹¥å¹²ä¸ªå­ç›®å½•ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™äº›éƒ½æ˜¯å— cgroups æ§åˆ¶çš„èµ„æºä»¥åŠè¿™äº›èµ„æºçš„ä¿¡æ¯ã€‚</p>
<ul>
<li>blkio â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä¸ºâ€‹â€‹â€‹å—â€‹â€‹â€‹è®¾â€‹â€‹â€‹å¤‡â€‹â€‹â€‹è®¾â€‹â€‹â€‹å®šâ€‹â€‹â€‹è¾“â€‹â€‹â€‹å…¥â€‹â€‹â€‹/è¾“â€‹â€‹â€‹å‡ºâ€‹â€‹â€‹é™â€‹â€‹â€‹åˆ¶â€‹â€‹â€‹ï¼Œæ¯”â€‹â€‹â€‹å¦‚â€‹â€‹â€‹ç‰©â€‹â€‹â€‹ç†â€‹â€‹â€‹è®¾â€‹â€‹â€‹å¤‡â€‹â€‹â€‹ï¼ˆç£â€‹â€‹â€‹ç›˜â€‹â€‹â€‹ï¼Œå›ºâ€‹â€‹â€‹æ€â€‹â€‹â€‹ç¡¬â€‹â€‹â€‹ç›˜â€‹â€‹â€‹ï¼ŒUSB ç­‰â€‹â€‹â€‹ç­‰â€‹â€‹â€‹ï¼‰ã€‚</li>
<li>cpu â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹è°ƒâ€‹â€‹â€‹åº¦â€‹â€‹â€‹ç¨‹â€‹â€‹â€‹åºâ€‹â€‹â€‹æâ€‹â€‹â€‹ä¾›â€‹â€‹â€‹å¯¹â€‹â€‹â€‹ CPU çš„â€‹â€‹â€‹ cgroup ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹è®¿â€‹â€‹â€‹é—®â€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>cpuacct â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹è‡ªâ€‹â€‹â€‹åŠ¨â€‹â€‹â€‹ç”Ÿâ€‹â€‹â€‹æˆâ€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹æ‰€â€‹â€‹â€‹ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹çš„â€‹â€‹â€‹ CPU æŠ¥â€‹â€‹â€‹å‘Šâ€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>cpuset â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä¸ºâ€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹çš„â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹åˆ†â€‹â€‹â€‹é…â€‹â€‹â€‹ç‹¬â€‹â€‹â€‹ç«‹â€‹â€‹â€‹ CPUï¼ˆåœ¨â€‹â€‹â€‹å¤šâ€‹â€‹â€‹æ ¸â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ï¼‰å’Œâ€‹â€‹â€‹å†…â€‹â€‹â€‹å­˜â€‹â€‹â€‹èŠ‚â€‹â€‹â€‹ç‚¹ã€‚</li>
<li>devices â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹å¯â€‹â€‹â€‹å…â€‹â€‹â€‹è®¸â€‹â€‹â€‹æˆ–â€‹â€‹â€‹è€…â€‹â€‹â€‹æ‹’â€‹â€‹â€‹ç»â€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹çš„â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹è®¿â€‹â€‹â€‹é—®â€‹â€‹â€‹è®¾â€‹â€‹â€‹å¤‡â€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>freezer â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹æŒ‚â€‹â€‹â€‹èµ·â€‹â€‹â€‹æˆ–â€‹â€‹â€‹è€…â€‹â€‹â€‹æ¢â€‹â€‹â€‹å¤â€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹çš„â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>memory â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹è®¾â€‹â€‹â€‹å®šâ€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹ä»»â€‹â€‹â€‹åŠ¡â€‹â€‹â€‹ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹çš„â€‹â€‹â€‹å†…â€‹â€‹â€‹å­˜â€‹â€‹â€‹é™â€‹â€‹â€‹åˆ¶â€‹â€‹â€‹ï¼Œå¹¶â€‹â€‹â€‹è‡ªâ€‹â€‹â€‹åŠ¨â€‹â€‹â€‹ç”Ÿâ€‹â€‹â€‹æˆâ€‹â€‹â€‹â€‹â€‹å†…â€‹â€‹â€‹å­˜â€‹â€‹â€‹èµ„â€‹æºä½¿ç”¨â€‹â€‹â€‹æŠ¥â€‹â€‹â€‹å‘Šâ€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>net_cls â€” è¿™â€‹â€‹â€‹ä¸ªâ€‹â€‹â€‹å­â€‹â€‹â€‹ç³»â€‹â€‹â€‹ç»Ÿâ€‹â€‹â€‹ä½¿â€‹â€‹â€‹ç”¨â€‹â€‹â€‹ç­‰â€‹â€‹â€‹çº§â€‹â€‹â€‹è¯†â€‹â€‹â€‹åˆ«â€‹â€‹â€‹ç¬¦â€‹â€‹â€‹ï¼ˆclassidï¼‰æ ‡â€‹â€‹â€‹è®°â€‹â€‹â€‹ç½‘â€‹â€‹â€‹ç»œâ€‹â€‹â€‹æ•°â€‹â€‹â€‹æ®â€‹â€‹â€‹åŒ…â€‹â€‹â€‹ï¼Œå¯â€‹â€‹â€‹å…â€‹â€‹â€‹è®¸â€‹â€‹â€‹ Linux æµé‡â€‹â€‹â€‹æ§â€‹â€‹â€‹åˆ¶â€‹â€‹â€‹ç¨‹â€‹â€‹â€‹åºâ€‹â€‹â€‹ï¼ˆtcï¼‰è¯†â€‹â€‹â€‹åˆ«â€‹â€‹â€‹ä»â€‹â€‹â€‹å…·â€‹â€‹â€‹ä½“â€‹â€‹â€‹ cgroup ä¸­â€‹â€‹â€‹ç”Ÿâ€‹â€‹â€‹æˆâ€‹â€‹â€‹çš„â€‹â€‹â€‹æ•°â€‹â€‹â€‹æ®â€‹â€‹â€‹åŒ…â€‹â€‹â€‹ã€‚â€‹â€‹â€‹</li>
<li>net_prio â€” è¿™ä¸ªå­ç³»ç»Ÿç”¨æ¥è®¾è®¡ç½‘ç»œæµé‡çš„ä¼˜å…ˆçº§</li>
<li>hugetlb â€” è¿™ä¸ªå­ç³»ç»Ÿä¸»è¦é’ˆå¯¹äºHugeTLBç³»ç»Ÿè¿›è¡Œé™åˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤§é¡µæ–‡ä»¶ç³»ç»Ÿã€‚</li>
</ul>
<p>é»˜è®¤çš„è¯ï¼Œåœ¨ Ubuntu ç³»ç»Ÿä¸­ï¼Œä½ å¯èƒ½çœ‹ä¸åˆ° net_cls å’Œ net_prio ç›®å½•ï¼Œå®ƒä»¬éœ€è¦ä½ æ‰‹å·¥åš mountï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup# modprobe cls_cgroup</span><br><span class="line">root@devstack:/sys/fs/cgroup# mkdir net_cls</span><br><span class="line">root@devstack:/sys/fs/cgroup# mount -t cgroup -o net_cls none net_cls</span><br><span class="line"></span><br><span class="line">root@devstack:/sys/fs/cgroup# modprobe netprio_cgroup</span><br><span class="line">root@devstack:/sys/fs/cgroup# mkdir net_prio</span><br><span class="line">root@devstack:/sys/fs/cgroup# mount -t cgroup -o net_prio none net_prio</span><br><span class="line"></span><br><span class="line">root@devstack:/sys/fs/cgroup# ls net_prio/cgroup.clone_children  cgroup.procs          net_prio.ifpriomap  notify_on_release  tasks</span><br><span class="line">cgroup.event_control   cgroup.sane_behavior  net_prio.prioidx    release_agent</span><br><span class="line">root@devstack:/sys/fs/cgroup# ls net_cls/</span><br><span class="line">cgroup.clone_children  cgroup.event_control  cgroup.procs  cgroup.sane_behavior  net_cls.classid  notify_on_release  release_agent  tasks</span><br></pre></td></tr></table></figure>
<h2 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h2><h3 id="é€šè¿‡-cgroups-é™åˆ¶è¿›ç¨‹çš„-CPU"><a href="#é€šè¿‡-cgroups-é™åˆ¶è¿›ç¨‹çš„-CPU" class="headerlink" title="é€šè¿‡ cgroups é™åˆ¶è¿›ç¨‹çš„ CPU"></a>é€šè¿‡ cgroups é™åˆ¶è¿›ç¨‹çš„ CPU</h3><p>å†™ä¸€æ®µæœ€ç®€å•çš„ C ç¨‹åºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;;) i++;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘ï¼Œè¿è¡Œï¼Œå‘ç°å®ƒå ç”¨çš„ CPU å‡ ä¹åˆ°äº† 100%ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">2204 root      20   0    4188    356    276 R 99.6  0.0   0:46.03 hello</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åšå¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy/c# mkdir /sys/fs/cgroup/cpu/hello</span><br><span class="line">root@devstack:/home/sammy/c# cd /sys/fs/cgroup/cpu/hello</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# ls</span><br><span class="line">cgroup.clone_children  cgroup.procs       cpu.cfs_quota_us  cpu.stat           tasks</span><br><span class="line">cgroup.event_control   cpu.cfs_period_us  cpu.shares        notify_on_release</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# cat cpu.cfs_quota_us</span><br><span class="line">-1</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# echo 20000 &gt; cpu.cfs_quota_us</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# cat cpu.cfs_quota_us</span><br><span class="line">20000</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/hello# echo 2428 &gt; tasks</span><br></pre></td></tr></table></figure>
<p>ç„¶åå†æ¥çœ‹çœ‹è¿™ä¸ªè¿›ç¨‹çš„ CPU å ç”¨æƒ…å†µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">2428 root      20   0    4188    356    276 R 19.9  0.0   0:46.03 hello</span><br></pre></td></tr></table></figure>
<p>å®ƒå ç”¨çš„ CPU å‡ ä¹å°±æ˜¯ 20%ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é¢„è®¾çš„é˜ˆå€¼ã€‚è¿™è¯´æ˜æˆ‘ä»¬é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ï¼ŒæˆåŠŸåœ°å°†è¿™ä¸ªè¿›ç¨‹è¿è¡Œæ‰€å ç”¨çš„ CPU èµ„æºé™åˆ¶åœ¨æŸä¸ªé˜ˆå€¼ä¹‹å†…äº†ã€‚</p>
<p>å¦‚æœæ­¤æ—¶å†å¯åŠ¨å¦ä¸€ä¸ª hello è¿›ç¨‹å¹¶å°†å…¶ id åŠ å…¥ tasks æ–‡ä»¶ï¼Œåˆ™ä¸¤ä¸ªè¿›ç¨‹ä¼šå…±äº«è®¾å®šçš„ CPU é™åˆ¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 2428 root      20   0    4188    356    276 R 10.0  0.0 285:39.54 hello</span><br><span class="line">12526 root      20   0    4188    356    276 R 10.0  0.0   0:25.09 hello</span><br></pre></td></tr></table></figure>
<h3 id="é€šè¿‡-cgroups-é™åˆ¶è¿›ç¨‹çš„-Memory"><a href="#é€šè¿‡-cgroups-é™åˆ¶è¿›ç¨‹çš„-Memory" class="headerlink" title="é€šè¿‡ cgroups é™åˆ¶è¿›ç¨‹çš„ Memory"></a>é€šè¿‡ cgroups é™åˆ¶è¿›ç¨‹çš„ Memory</h3><p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬é’ˆå¯¹å®ƒå ç”¨çš„å†…å­˜åšå¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup/memory# mkdir hello</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory# cd hello/</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory/hello# cat memory.limit_in_bytes</span><br><span class="line">18446744073709551615</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory/hello# echo 64k &gt; memory.limit_in_bytes</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory/hello# echo 2428 &gt; tasks</span><br><span class="line">root@devstack:/sys/fs/cgroup/memory/hello#</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ­¥éª¤ä¼šæŠŠè¿›ç¨‹ 2428 è¯´å ç”¨çš„å†…å­˜é˜ˆå€¼è®¾ç½®ä¸º 64Kã€‚è¶…è¿‡çš„è¯ï¼Œå®ƒä¼šè¢«æ€æ‰ã€‚</p>
<h3 id="é™åˆ¶è¿›ç¨‹çš„-I-O"><a href="#é™åˆ¶è¿›ç¨‹çš„-I-O" class="headerlink" title="é™åˆ¶è¿›ç¨‹çš„ I/O"></a>é™åˆ¶è¿›ç¨‹çš„ I/O</h3><p>è¿è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dd if=/dev/sda1 of=/dev/null</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ iotop å‘½ä»¤çœ‹ IO ï¼ˆæ­¤æ—¶ç£ç›˜åœ¨å¿«é€Ÿè½¬åŠ¨ï¼‰ï¼Œæ­¤æ—¶å…¶å†™é€Ÿåº¦ä¸º 242M/sï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND</span><br><span class="line">2555 be/4 root      242.60 M/s    0.00 B/s  0.00 % 61.66 % dd if=/dev/sda1 of=/dev/null</span><br></pre></td></tr></table></figure>
<p>æ¥ç€åšä¸‹é¢çš„æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/home/sammy# mkdir /sys/fs/cgroup/blkio/io</span><br><span class="line">root@devstack:/home/sammy# cd /sys/fs/cgroup/blkio/io</span><br><span class="line">root@devstack:/sys/fs/cgroup/blkio/io# ls -l /dev/sda1</span><br><span class="line">brw-rw---- 1 root disk 8, 1 Sep 18 21:46 /dev/sda1</span><br><span class="line">root@devstack:/sys/fs/cgroup/blkio/io# echo &apos;8:0 1048576&apos;  &gt; /sys/fs/cgroup/blkio/io/blkio.throttle.read_bps_device</span><br><span class="line">root@devstack:/sys/fs/cgroup/blkio/io# echo 2725 &gt; /sys/fs/cgroup/blkio/io/tasks</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼Œè¿™ä¸ªè¿›ç¨‹çš„IO é€Ÿåº¦å°±è¢«é™åˆ¶åœ¨ 1Mb/s ä¹‹å†…äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND</span><br><span class="line">2555 be/4 root      990.44 K/s    0.00 B/s  0.00 % 96.29 % dd if=/dev/sda1 of=/dev/null</span><br></pre></td></tr></table></figure>
<h2 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h2><p>cgroups çš„æœ¯è¯­åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä»»åŠ¡ï¼ˆTasksï¼‰ï¼šå°±æ˜¯ç³»ç»Ÿçš„ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
<li>æ§åˆ¶ç»„ï¼ˆControl Groupï¼‰ï¼šä¸€ç»„æŒ‰ç…§æŸç§æ ‡å‡†åˆ’åˆ†çš„è¿›ç¨‹ï¼Œæ¯”å¦‚å®˜æ–¹æ–‡æ¡£ä¸­çš„Professorå’ŒStudentï¼Œæˆ–æ˜¯WWWå’ŒSystemä¹‹ç±»çš„ï¼Œå…¶è¡¨ç¤ºäº†æŸè¿›ç¨‹ç»„ã€‚Cgroupsä¸­çš„èµ„æºæ§åˆ¶éƒ½æ˜¯ä»¥æ§åˆ¶ç»„ä¸ºå•ä½å®ç°ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŠ å…¥åˆ°æŸä¸ªæ§åˆ¶ç»„ã€‚è€Œèµ„æºçš„é™åˆ¶æ˜¯å®šä¹‰åœ¨è¿™ä¸ªç»„ä¸Šï¼Œå°±åƒä¸Šé¢ç¤ºä¾‹ä¸­æˆ‘ç”¨çš„ hello ä¸€æ ·ã€‚ç®€å•ç‚¹è¯´ï¼Œcgroupçš„å‘ˆç°å°±æ˜¯ä¸€ä¸ªç›®å½•å¸¦ä¸€ç³»åˆ—çš„å¯é…ç½®æ–‡ä»¶ã€‚</li>
<li>å±‚çº§ï¼ˆHierarchyï¼‰ï¼šæ§åˆ¶ç»„å¯ä»¥ç»„ç»‡æˆhierarchicalçš„å½¢å¼ï¼Œæ—¢ä¸€é¢—æ§åˆ¶ç»„çš„æ ‘ï¼ˆç›®å½•ç»“æ„ï¼‰ã€‚æ§åˆ¶ç»„æ ‘ä¸Šçš„å­èŠ‚ç‚¹ç»§æ‰¿çˆ¶ç»“ç‚¹çš„å±æ€§ã€‚ç®€å•ç‚¹è¯´ï¼Œhierarchyå°±æ˜¯åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªå­ç³»ç»Ÿä¸Šçš„cgroupsç›®å½•æ ‘ã€‚</li>
<li>å­ç³»ç»Ÿï¼ˆSubsystemï¼‰ï¼šä¸€ä¸ªå­ç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªèµ„æºæ§åˆ¶å™¨ï¼Œæ¯”å¦‚CPUå­ç³»ç»Ÿå°±æ˜¯æ§åˆ¶CPUæ—¶é—´åˆ†é…çš„ä¸€ä¸ªæ§åˆ¶å™¨ã€‚å­ç³»ç»Ÿå¿…é¡»é™„åŠ åˆ°ä¸€ä¸ªå±‚çº§ä¸Šæ‰èƒ½èµ·ä½œç”¨ï¼Œä¸€ä¸ªå­ç³»ç»Ÿé™„åŠ åˆ°æŸä¸ªå±‚çº§ä»¥åï¼Œè¿™ä¸ªå±‚çº§ä¸Šçš„æ‰€æœ‰æ§åˆ¶æ—ç¾¤éƒ½å—åˆ°è¿™ä¸ªå­ç³»ç»Ÿçš„æ§åˆ¶ã€‚Cgroupçš„å­ç³»ç»Ÿå¯ä»¥æœ‰å¾ˆå¤šï¼Œä¹Ÿåœ¨ä¸æ–­å¢åŠ ä¸­ã€‚</li>
</ul>
<h1 id="Docker-å¯¹-cgroups-çš„ä½¿ç”¨"><a href="#Docker-å¯¹-cgroups-çš„ä½¿ç”¨" class="headerlink" title="Docker å¯¹ cgroups çš„ä½¿ç”¨"></a>Docker å¯¹ cgroups çš„ä½¿ç”¨</h1><h2 id="é»˜è®¤æƒ…å†µ"><a href="#é»˜è®¤æƒ…å†µ" class="headerlink" title="é»˜è®¤æƒ…å†µ"></a>é»˜è®¤æƒ…å†µ</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker å¯åŠ¨ä¸€ä¸ªå®¹å™¨åï¼Œä¼šåœ¨ /sys/fs/cgroup ç›®å½•ä¸‹çš„å„ä¸ªèµ„æºç›®å½•ä¸‹ç”Ÿæˆä»¥å®¹å™¨ ID ä¸ºåå­—çš„ç›®å½•ï¼ˆgroupï¼‰ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sys/fs/cgroup/cpu/docker/03dd196f415276375f754d51ce29b418b170bd92d88c5e420d6901c32f93dc14</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ cpu.cfs_quota_us çš„å†…å®¹ä¸º -1ï¼Œè¡¨ç¤ºé»˜è®¤æƒ…å†µä¸‹å¹¶æ²¡æœ‰é™åˆ¶å®¹å™¨çš„ CPU ä½¿ç”¨ã€‚åœ¨å®¹å™¨è¢« stopped åï¼Œè¯¥ç›®å½•è¢«åˆ é™¤ã€‚</p>
<p>è¿è¡Œå‘½ä»¤ docker run -d â€“name web41 â€“cpu-quota 25000 â€“cpu-period 100 â€“cpu-shares 30 training/webapp python app.py å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup/cpu/docker/06bd180cd340f8288c18e8f0e01ade66d066058dd053ef46161eb682ab69ec24# cat cpu.cfs_quota_us</span><br><span class="line">25000</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/docker/06bd180cd340f8288c18e8f0e01ade66d066058dd053ef46161eb682ab69ec24# cat tasks</span><br><span class="line">3704</span><br><span class="line">root@devstack:/sys/fs/cgroup/cpu/docker/06bd180cd340f8288c18e8f0e01ade66d066058dd053ef46161eb682ab69ec24# cat cpu.cfs_period_us</span><br><span class="line">2000</span><br></pre></td></tr></table></figure>
<p>Docker ä¼šå°†å®¹å™¨ä¸­çš„è¿›ç¨‹çš„ ID åŠ å…¥åˆ°å„ä¸ªèµ„æºå¯¹åº”çš„ tasks æ–‡ä»¶ä¸­ã€‚è¡¨ç¤º Docker ä¹Ÿæ˜¯ä»¥ä¸Šé¢çš„æœºåˆ¶æ¥ä½¿ç”¨ cgroups å¯¹å®¹å™¨çš„ CPU ä½¿ç”¨è¿›è¡Œé™åˆ¶ã€‚</p>
<p>ç›¸ä¼¼åœ°ï¼Œå¯ä»¥é€šè¿‡ docker run ä¸­ mem ç›¸å…³çš„å‚æ•°å¯¹å®¹å™¨çš„å†…å­˜ä½¿ç”¨è¿›è¡Œé™åˆ¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    --cpuset-mems string          MEMs in which to allow execution (0-3, 0,1)</span><br><span class="line">    --kernel-memory string        Kernel memory limit</span><br><span class="line">-m, --memory string               Memory limit</span><br><span class="line">    --memory-reservation string   Memory soft limit</span><br><span class="line">    --memory-swap string          Swap limit equal to memory plus swap: &apos;-1&apos; to enable unlimited swap</span><br><span class="line">    --memory-swappiness int       Tune container memory swappiness (0 to 100) (default -1)</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚  docker run -d â€“name web42 â€“blkio-weight 100 â€“memory 10M â€“cpu-quota 25000 â€“cpu-period 2000 â€“cpu-shares 30 training/webapp python app.pyï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup/memory/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410# cat memory.limit_in_bytes</span><br><span class="line">10485760</span><br><span class="line">  root@devstack:/sys/fs/cgroup/blkio/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410# cat blkio.weight</span><br><span class="line">  100</span><br></pre></td></tr></table></figure>
<p>ç›®å‰ docker å·²ç»å‡ ä¹æ”¯æŒäº†æ‰€æœ‰çš„ cgroups èµ„æºï¼Œå¯ä»¥é™åˆ¶å®¹å™¨å¯¹åŒ…æ‹¬ networkï¼Œdeviceï¼Œcpu å’Œ memory åœ¨å†…çš„èµ„æºçš„ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@devstack:/sys/fs/cgroup# find -iname ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./net_prio/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./net_cls/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./systemd/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./hugetlb/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./perf_event/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./blkio/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./freezer/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./devices/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./memory/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./cpuacct/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./cpu/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br><span class="line">./cpuset/docker/ec8d850ebbabaf24df572cb5acd89a6e7a953fe5aa5d3c6a69c4532f92b57410</span><br></pre></td></tr></table></figure>
<h1 id="Docker-run-å‘½ä»¤ä¸­-cgroups-ç›¸å…³å‘½ä»¤"><a href="#Docker-run-å‘½ä»¤ä¸­-cgroups-ç›¸å…³å‘½ä»¤" class="headerlink" title="Docker run å‘½ä»¤ä¸­ cgroups ç›¸å…³å‘½ä»¤"></a>Docker run å‘½ä»¤ä¸­ cgroups ç›¸å…³å‘½ä»¤</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">block IO:</span><br><span class="line">      --blkio-weight value          Block IO (relative weight), between 10 and 1000</span><br><span class="line">      --blkio-weight-device value   Block IO weight (relative device weight) (default [])</span><br><span class="line">      --cgroup-parent string        Optional parent cgroup for the container</span><br><span class="line">CPU:</span><br><span class="line">      --cpu-percent int             CPU percent (Windows only)</span><br><span class="line">      --cpu-period int              Limit CPU CFS (Completely Fair Scheduler) period</span><br><span class="line">      --cpu-quota int               Limit CPU CFS (Completely Fair Scheduler) quota</span><br><span class="line">  -c, --cpu-shares int              CPU shares (relative weight)</span><br><span class="line">      --cpuset-cpus string          CPUs in which to allow execution (0-3, 0,1)</span><br><span class="line">      --cpuset-mems string          MEMs in which to allow execution (0-3, 0,1)</span><br><span class="line">Device:    </span><br><span class="line">      --device value                Add a host device to the container (default [])</span><br><span class="line">      --device-read-bps value       Limit read rate (bytes per second) from a device (default [])</span><br><span class="line">      --device-read-iops value      Limit read rate (IO per second) from a device (default [])</span><br><span class="line">      --device-write-bps value      Limit write rate (bytes per second) to a device (default [])</span><br><span class="line">      --device-write-iops value     Limit write rate (IO per second) to a device (default [])</span><br><span class="line">Memory:      </span><br><span class="line">      --kernel-memory string        Kernel memory limit</span><br><span class="line">  -m, --memory string               Memory limit</span><br><span class="line">      --memory-reservation string   Memory soft limit</span><br><span class="line">      --memory-swap string          Swap limit equal to memory plus swap: &apos;-1&apos; to enable unlimited swap</span><br><span class="line">      --memory-swappiness int       Tune container memory swappiness (0 to 100) (default -1)</span><br></pre></td></tr></table></figure>
<p>ä¸€äº›è¯´æ˜ï¼š</p>
<ol>
<li>cgroup åªèƒ½é™åˆ¶ CPU çš„ä½¿ç”¨ï¼Œè€Œä¸èƒ½ä¿è¯CPUçš„ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ ä½¿ç”¨ cpuset-cpusï¼Œå¯ä»¥è®©å®¹å™¨åœ¨æŒ‡å®šçš„CPUæˆ–è€…æ ¸ä¸Šè¿è¡Œï¼Œä½†æ˜¯ä¸èƒ½ç¡®ä¿å®ƒç‹¬å è¿™äº›CPUï¼›cpu-shares æ˜¯ä¸ªç›¸å¯¹å€¼ï¼Œåªæœ‰åœ¨CPUä¸å¤Ÿç”¨çš„æ—¶å€™æ‰å…¶ä½œç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“CPUå¤Ÿç”¨çš„æ—¶å€™ï¼Œæ¯ä¸ªå®¹å™¨ä¼šåˆ†åˆ°è¶³å¤Ÿçš„CPUï¼›ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§æŒ‡å®šçš„æ¯”é‡åœ¨å¤šä¸ªå®¹å™¨ä¹‹é—´åˆ†é…CPUã€‚</li>
<li>å¯¹å†…å­˜æ¥è¯´ï¼Œcgroups å¯ä»¥é™åˆ¶å®¹å™¨æœ€å¤šä½¿ç”¨çš„å†…å­˜ã€‚ä½¿ç”¨ -m å‚æ•°å¯ä»¥è®¾ç½®æœ€å¤šå¯ä»¥ä½¿ç”¨çš„å†…å­˜ã€‚</li>
</ol>
<h1 id="Docker-ç½‘ç»œæ¦‚å†µ"><a href="#Docker-ç½‘ç»œæ¦‚å†µ" class="headerlink" title="Docker ç½‘ç»œæ¦‚å†µ"></a>Docker ç½‘ç»œæ¦‚å†µ</h1><p>ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜ Docker ç½‘ç»œçš„åŸºæœ¬æ¦‚å†µï¼š</p>
<p><a href="http://idiotsky.top/images3/docker-summary-5.jpg"><img src="http://idiotsky.top/images3/docker-summary-5.jpg" alt=""></a></p>
<h1 id="å››ç§å•èŠ‚ç‚¹ç½‘ç»œæ¨¡å¼"><a href="#å››ç§å•èŠ‚ç‚¹ç½‘ç»œæ¨¡å¼" class="headerlink" title="å››ç§å•èŠ‚ç‚¹ç½‘ç»œæ¨¡å¼"></a>å››ç§å•èŠ‚ç‚¹ç½‘ç»œæ¨¡å¼</h1><h2 id="bridge-æ¨¡å¼"><a href="#bridge-æ¨¡å¼" class="headerlink" title="bridge æ¨¡å¼"></a>bridge æ¨¡å¼</h2><p>Docker å®¹å™¨é»˜è®¤ä½¿ç”¨ bridge æ¨¡å¼çš„ç½‘ç»œã€‚å…¶ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä½¿ç”¨ä¸€ä¸ª linux bridgeï¼Œé»˜è®¤ä¸º docker0</li>
<li>ä½¿ç”¨ veth å¯¹ï¼Œä¸€å¤´åœ¨å®¹å™¨çš„ç½‘ç»œ namespace ä¸­ï¼Œä¸€å¤´åœ¨ docker0 ä¸Š</li>
<li>è¯¥æ¨¡å¼ä¸‹Docker Containerä¸å…·æœ‰ä¸€ä¸ªå…¬æœ‰IPï¼Œå› ä¸ºå®¿ä¸»æœºçš„IPåœ°å€ä¸veth pairçš„ IPåœ°å€ä¸åœ¨åŒä¸€ä¸ªç½‘æ®µå†…</li>
<li>Dockeré‡‡ç”¨ NAT æ–¹å¼ï¼Œå°†å®¹å™¨å†…éƒ¨çš„æœåŠ¡ç›‘å¬çš„ç«¯å£ä¸å®¿ä¸»æœºçš„æŸä¸€ä¸ªç«¯å£port è¿›è¡Œâ€œç»‘å®šâ€ï¼Œä½¿å¾—å®¿ä¸»æœºä»¥å¤–çš„ä¸–ç•Œå¯ä»¥ä¸»åŠ¨å°†ç½‘ç»œæŠ¥æ–‡å‘é€è‡³å®¹å™¨å†…éƒ¨</li>
<li>å¤–ç•Œè®¿é—®å®¹å™¨å†…çš„æœåŠ¡æ—¶ï¼Œéœ€è¦è®¿é—®å®¿ä¸»æœºçš„ IP ä»¥åŠå®¿ä¸»æœºçš„ç«¯å£ port</li>
<li>NAT æ¨¡å¼ç”±äºæ˜¯åœ¨ä¸‰å±‚ç½‘ç»œä¸Šçš„å®ç°æ‰‹æ®µï¼Œæ•…è‚¯å®šä¼šå½±å“ç½‘ç»œçš„ä¼ è¾“æ•ˆç‡ã€‚</li>
<li>å®¹å™¨æ‹¥æœ‰ç‹¬ç«‹ã€éš”ç¦»çš„ç½‘ç»œæ ˆï¼›è®©å®¹å™¨å’Œå®¿ä¸»æœºä»¥å¤–çš„ä¸–ç•Œé€šè¿‡NATå»ºç«‹é€šä¿¡</li>
</ul>
<p>iptables çš„ SNTA è§„åˆ™ï¼Œä½¿å¾—ä»å®¹å™¨ç¦»å¼€å»å¤–ç•Œçš„ç½‘ç»œåŒ…çš„æº IP åœ°å€è¢«è½¬æ¢ä¸º Docker ä¸»æœºçš„IPåœ°å€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Chain POSTROUTING (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line">MASQUERADE  all  --  172.17.0.0/16        0.0.0.0/0</span><br><span class="line">MASQUERADE  all  --  172.18.0.0/16        0.0.0.0/0</span><br></pre></td></tr></table></figure>
<p>ç¤ºæ„å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images3/docker-summary-6.jpg"><img src="http://idiotsky.top/images3/docker-summary-6.jpg" alt=""></a></p>
<blockquote>
<p>to be continue â€¦</p>
</blockquote>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.cnblogs.com/sammyliu/p/5875470.html" target="_blank" rel="noopener">http://www.cnblogs.com/sammyliu/p/5875470.html</a></p>
<p><a href="http://www.cnblogs.com/sammyliu/p/5878973.html" target="_blank" rel="noopener">http://www.cnblogs.com/sammyliu/p/5878973.html</a></p>
<p><a href="http://www.cnblogs.com/sammyliu/p/5886833.html" target="_blank" rel="noopener">http://www.cnblogs.com/sammyliu/p/5886833.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸æƒ³åˆ†å‡ ç« äº†ï¼Œæ‰€ä»¥å¾ˆé•¿å¾ˆé•¿ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;docker-å®¹å™¨çš„çŠ¶æ€æœº&quot;&gt;&lt;a href=&quot;#docker-å®¹å™¨çš„çŠ¶æ€æœº&quot; class=&quot;headerlink&quot; title=&quot;docker å®¹å™¨çš„çŠ¶æ€æœº&quot;&gt;&lt;/a&gt;docker å®¹å™¨çš„çŠ¶æ€æœº&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;http://idiotsky.top/images3/docker-summary-1.jpg&quot;&gt;&lt;img src=&quot;http://idiotsky.top/images3/docker-summary-1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸€ä¸ªå®¹å™¨åœ¨æŸä¸ªæ—¶åˆ»å¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ä¹‹ä¸€ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;createdï¼šå·²ç»è¢«åˆ›å»º ï¼ˆä½¿ç”¨ docker ps -a å‘½ä»¤å¯ä»¥åˆ—å‡ºï¼‰ä½†æ˜¯è¿˜æ²¡æœ‰è¢«å¯åŠ¨ ï¼ˆä½¿ç”¨ docker ps å‘½ä»¤è¿˜æ— æ³•åˆ—å‡ºï¼‰&lt;/li&gt;
&lt;li&gt;runningï¼šè¿è¡Œä¸­&lt;/li&gt;
&lt;li&gt;pausedï¼šå®¹å™¨çš„è¿›ç¨‹è¢«æš‚åœäº†&lt;/li&gt;
&lt;li&gt;restartingï¼šå®¹å™¨çš„è¿›ç¨‹æ­£åœ¨é‡å¯è¿‡ç¨‹ä¸­&lt;/li&gt;
&lt;li&gt;exitedï¼šä¸Šå›¾ä¸­çš„ stopped çŠ¶æ€ï¼Œè¡¨ç¤ºå®¹å™¨ä¹‹å‰è¿è¡Œè¿‡ä½†æ˜¯ç°åœ¨å¤„äºåœæ­¢çŠ¶æ€ï¼ˆè¦åŒºåˆ«äº created çŠ¶æ€ï¼Œå®ƒæ˜¯æŒ‡ä¸€ä¸ªæ–°åˆ›å‡ºçš„å°šæœªè¿è¡Œè¿‡çš„å®¹å™¨ï¼‰ã€‚å¯ä»¥é€šè¿‡ start å‘½ä»¤ä½¿å…¶é‡æ–°è¿›å…¥ running çŠ¶æ€&lt;/li&gt;
&lt;li&gt;destroyedï¼šå®¹å™¨è¢«åˆ é™¤äº†ï¼Œå†ä¹Ÿä¸å­˜åœ¨äº†&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="docker" scheme="http://idiotsky.top/categories/docker/"/>
    
    
      <category term="docker" scheme="http://idiotsky.top/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>TCMallocï¼šThread-Caching(çº¿ç¨‹ç¼“å­˜)Malloc</title>
    <link href="http://idiotsky.top/2018/09/17/tcmalloc/"/>
    <id>http://idiotsky.top/2018/09/17/tcmalloc/</id>
    <published>2018-09-17T14:56:41.000Z</published>
    <updated>2018-09-25T14:02:35.895Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŠ¨æœº"><a href="#åŠ¨æœº" class="headerlink" title="åŠ¨æœº"></a>åŠ¨æœº</h1><p>TCMallocæ¯”glibc 2.3 mallocï¼ˆä½œä¸ºä¸€ä¸ªåä¸ºptmalloc2çš„ç‹¬ç«‹åº“æä¾›ï¼‰å’Œæˆ‘æµ‹è¯•çš„å…¶ä»–mallocæ›´å¿«ã€‚ptmalloc2åœ¨2.8 GHz P4ä¸Šæ‰§è¡Œmalloc/freeæ“ä½œå¯¹ï¼ˆå¯¹äºå°å¯¹è±¡ï¼‰éœ€è¦å¤§çº¦300çº³ç§’ã€‚å¯¹äºç›¸åŒçš„æ“ä½œå¯¹ï¼ŒTCMallocå®ç°å¤§çº¦éœ€è¦50çº³ç§’ã€‚é€Ÿåº¦å¯¹äºmallocå®ç°å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœmallocä¸å¤Ÿå¿«ï¼Œåº”ç”¨ç¨‹åºç¼–å†™è€…å€¾å‘äºåœ¨mallocä¹‹ä¸Šç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰ç©ºé—²åˆ—è¡¨ã€‚è¿™å¯èƒ½å¯¼è‡´é¢å¤–çš„å¤æ‚æ€§å’Œæ›´å¤šçš„å†…å­˜ä½¿ç”¨ï¼Œé™¤éåº”ç”¨ç¨‹åºç¼–å†™è€…éå¸¸å°å¿ƒåœ°é€‚å½“è°ƒæ•´ç©ºé—²åˆ—è¡¨çš„å¤§å°å¹¶ä»ç©ºé—²åˆ—è¡¨ä¸­æ¸…é™¤ç©ºé—²å¯¹è±¡</p>
<p>TCMallocè¿˜å‡å°‘äº†å¤šçº¿ç¨‹ç¨‹åºçš„é”äº‰ç”¨ã€‚å¯¹äºå°å‹å¯¹è±¡ï¼Œå‡ ä¹æ²¡æœ‰äº‰ç”¨ã€‚å¯¹äºå¤§å‹å¯¹è±¡ï¼ŒTCMallocå°è¯•ä½¿ç”¨ç»†ç²’åº¦å’Œé«˜æ•ˆçš„è‡ªæ—‹é”ã€‚ptmalloc2è¿˜é€šè¿‡ä½¿ç”¨æ¯çº¿ç¨‹arenaæ¥å‡å°‘é”äº‰ç”¨ï¼Œä½†æ˜¯ptmalloc2ä½¿ç”¨æ¯çº¿ç¨‹arenaå­˜åœ¨å¾ˆå¤§é—®é¢˜ã€‚åœ¨ptmalloc2ä¸­ï¼Œå†…å­˜æ°¸è¿œä¸ä¼šä»ä¸€ä¸ªarenaè½¬ç§»åˆ°å¦ä¸€ä¸ªarenaã€‚è¿™å¯èƒ½å¯¼è‡´å¤§é‡æµªè´¹çš„ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªGoogleåº”ç”¨ç¨‹åºä¸­ï¼Œç¬¬ä¸€é˜¶æ®µå°†ä¸ºå…¶æ•°æ®ç»“æ„åˆ†é…å¤§çº¦300MBçš„å†…å­˜ã€‚å½“ç¬¬ä¸€é˜¶æ®µç»“æŸæ—¶ï¼Œç¬¬äºŒé˜¶æ®µå°†åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¼€å§‹ã€‚å¦‚æœç¬¬äºŒé˜¶æ®µè¢«æŒ‡å®šä¸ºä¸ç¬¬ä¸€é˜¶æ®µä½¿ç”¨çš„arenaä¸åŒçš„arenaï¼Œæ­¤é˜¶æ®µä¸ä¼šé‡ç”¨ç¬¬ä¸€é˜¶æ®µä¹‹åå‰©ä½™çš„ä»»ä½•å†…å­˜ï¼Œå¹¶ä¼šå‘åœ°å€ç©ºé—´æ·»åŠ å¦å¤–300MBã€‚åœ¨å…¶ä»–åº”ç”¨ä¸­ä¹Ÿæ³¨æ„åˆ°ç±»ä¼¼çš„å†…å­˜çˆ†ç‚¸é—®é¢˜ã€‚<br><a id="more"></a><br>TCMallocçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯å°å¯¹è±¡éƒ½èƒ½èŠ‚çœæ›´å¤šç©ºé—´ã€‚ä¾‹å¦‚ï¼Œåˆ†é…Nä¸ª8å­—èŠ‚å¯¹è±¡ï¼Œæ‰ä½¿ç”¨å¤§çº¦8N * 1.01å­—èŠ‚çš„ç©ºé—´ã€‚å³ï¼Œä¸€ä¸ªç™¾åˆ†ä¹‹ä¸€çš„ç©ºé—´å¼€é”€ã€‚è€Œptmalloc2ä¸ºæ¯ä¸ªå¯¹è±¡ä½¿ç”¨ä¸€ä¸ªå››å­—èŠ‚çš„å¤´ï¼Œå¹¶ä¸”ï¼ˆæˆ‘è®¤ä¸ºï¼‰å°†å¤§å°å››èˆäº”å…¥ä¸º8ä¸ªå­—èŠ‚çš„å€æ•°ï¼Œæœ€åä½¿ç”¨16Nå­—èŠ‚ã€‚</p>
<h1 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h1><p>è¦ä½¿ç”¨TCmallocï¼Œåªéœ€é€šè¿‡â€œ-ltcmallocâ€é“¾æ¥å™¨æ ‡å¿—å°†tcmallocé“¾æ¥åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨LD_PRELOADåœ¨è‡ªå·±æ²¡æœ‰ç¼–è¯‘çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨tcmallocï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ LD_PRELOAD =â€œ/ usr / lib / libtcmalloc.so</span><br></pre></td></tr></table></figure>
<p>LD_PRELOADå¾ˆæ£˜æ‰‹ï¼Œæˆ‘ä»¬ä¸ä¸€å®šæ¨èè¿™ç§ä½¿ç”¨æ¨¡å¼ã€‚</p>
<p>TCMallocè¿˜åŒ…æ‹¬<a href="http://goog-perftools.sourceforge.net/doc/heap_checker.html" target="_blank" rel="noopener">æ£€æŸ¥å™¨</a> å’Œ<a href="http://goog-perftools.sourceforge.net/doc/heap_profiler.html" target="_blank" rel="noopener">å †åˆ†æå™¨</a>ã€‚</p>
<p>å¦‚æœæ‚¨æ›´å–œæ¬¢é“¾æ¥ä¸åŒ…å«å †åˆ†æå™¨å’Œæ£€æŸ¥å™¨çš„TCMallocç‰ˆæœ¬ï¼ˆå¯èƒ½å‡å°‘é™æ€äºŒè¿›åˆ¶æ–‡ä»¶çš„äºŒè¿›åˆ¶å¤§å°ï¼‰ï¼Œåˆ™å¯ä»¥é“¾æ¥libtcmalloc_minimal ã€‚</p>
<h1 id="æ¦‚è§‚"><a href="#æ¦‚è§‚" class="headerlink" title="æ¦‚è§‚"></a>æ¦‚è§‚</h1><p>TCMallocä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…çº¿ç¨‹æœ¬åœ°ç¼“å­˜ã€‚çº¿ç¨‹æœ¬åœ°ç¼“å­˜æ»¡è¶³å°å†…å­˜çš„åˆ†é…ã€‚æ ¹æ®éœ€è¦å°†å¯¹è±¡ä»centralæ•°æ®ç»“æ„ç§»åŠ¨åˆ°çº¿ç¨‹æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå¹¶ä½¿ç”¨å‘¨æœŸæ€§åƒåœ¾æ”¶é›†å°†å†…å­˜ä»çº¿ç¨‹æœ¬åœ°ç¼“å­˜è¿ç§»å›centralæ•°æ®ç»“æ„ã€‚</p>
<p><a href="http://idiotsky.top/images3/tcmalloc-1.gif"><img src="http://idiotsky.top/images3/tcmalloc-1.gif" alt=""></a></p>
<p>TCMallocä»¥ä¸åŒäºè¾ƒå¤§å¯¹è±¡çš„æ–¹å¼å¤„ç†å¤§å°&lt;= 32Kï¼ˆâ€œå°â€å¯¹è±¡ï¼‰çš„å¯¹è±¡ã€‚ä½¿ç”¨é¡µçº§åˆ†é…å™¨ç›´æ¥ä»centralå †åˆ†é…å¤§å¯¹è±¡ï¼ˆé¡µæ˜¯4Kå¯¹é½çš„å†…å­˜åŒºåŸŸï¼‰ã€‚å³ï¼Œå¤§å¯¹è±¡æ€»æ˜¯é¡µå¯¹é½å¹¶å æ®æ•´æ•°é¡µã€‚</p>
<p>å¯ä»¥å°†ä¸€ç³»åˆ—é¡µåˆ’åˆ†ä¸ºä¸€ç³»åˆ—å°å¯¹è±¡ï¼Œæ¯ä¸ªå°å¯¹è±¡çš„å¤§å°ç›¸åŒã€‚ä¾‹å¦‚ï¼Œä¸€é¡µï¼ˆ4Kï¼‰å¯ä»¥è¢«åˆ†æˆ32ä¸ªå¤§å°ä¸º128å­—èŠ‚çš„å¯¹è±¡ã€‚</p>
<h1 id="å°å¯¹è±¡åˆ†é…"><a href="#å°å¯¹è±¡åˆ†é…" class="headerlink" title="å°å¯¹è±¡åˆ†é…"></a>å°å¯¹è±¡åˆ†é…</h1><p>æ¯ä¸ªå°å¯¹è±¡å¤§å°æ˜ å°„åˆ°å¤§çº¦170ä¸ªå¯åˆ†é…size-classä¸­çš„ä¸€ä¸ªã€‚ä¾‹å¦‚ï¼Œ961åˆ°1024å­—èŠ‚èŒƒå›´å†…çš„æ‰€æœ‰åˆ†é…éƒ½å‘ä¸Šèˆå…¥åˆ°1024.size-classé—´éš”å¼€ï¼Œä»¥ä¾¿å°çš„å¤§å°åˆ†éš”8ä¸ªå­—èŠ‚ï¼Œè¾ƒå¤§çš„å¤§å°åˆ†éš”16ä¸ªå­—èŠ‚ï¼Œç”šè‡³æ›´å¤§çš„å¤§å°åˆ†éš”32ä¸ªå­—èŠ‚ï¼Œä¾æ­¤ç±»æ¨ã€‚æœ€å¤§é—´è·ï¼ˆå¯¹äºå¤§å°&gt; = ~2Kï¼‰æ˜¯256ä¸ªå­—èŠ‚ã€‚<br>çº¿ç¨‹ç¼“å­˜åŒ…å«æ¯ä¸ªsize-classçš„å•â€‹â€‹ç‹¬çš„ç©ºé—²å¯¹è±¡é“¾è¡¨ã€‚</p>
<p><a href="http://idiotsky.top/images3/tcmalloc-2.gif"><img src="http://idiotsky.top/images3/tcmalloc-2.gif" alt=""></a></p>
<p>åˆ†é…å°å¯¹è±¡æ—¶ï¼šï¼ˆ1ï¼‰æˆ‘ä»¬å°†å…¶å¤§å°æ˜ å°„åˆ°ç›¸åº”çš„size-classã€‚ï¼ˆ2ï¼‰æŸ¥æ‰¾å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ç¼“å­˜ä¸­çš„ç›¸åº”ç©ºé—²åˆ—è¡¨ã€‚ï¼ˆ3ï¼‰å¦‚æœç©ºé—²åˆ—è¡¨ä¸ä¸ºç©ºï¼Œæˆ‘ä»¬ä»åˆ—è¡¨ä¸­åˆ é™¤ç¬¬ä¸€ä¸ªå¯¹è±¡å¹¶å°†å…¶è¿”å›ã€‚éµå¾ªæ­¤å¿«é€Ÿè·¯å¾„æ—¶ï¼ŒTCMallocæ ¹æœ¬ä¸ä¼šè·å–ä»»ä½•é”ã€‚è¿™æœ‰åŠ©äºæ˜¾ç€åŠ é€Ÿåˆ†é…ï¼Œå› ä¸ºåŠ é”/è§£é”å¯¹åœ¨2.8 GHz Xeonä¸Šå¤§çº¦éœ€è¦100çº³ç§’ã€‚</p>
<p>å¦‚æœç©ºé—²åˆ—è¡¨ä¸ºç©ºï¼šï¼ˆ1ï¼‰æˆ‘ä»¬ä»è¿™ä¸ªsize-classçš„centralç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€å †å¯¹è±¡ï¼ˆæ‰€æœ‰çº¿ç¨‹å…±äº«centralç©ºé—²åˆ—è¡¨ï¼‰ã€‚ï¼ˆ2ï¼‰å°†å®ƒä»¬æ”¾åœ¨çº¿ç¨‹æœ¬åœ°ç©ºé—²åˆ—è¡¨ä¸­ã€‚ï¼ˆ3ï¼‰å°†ä¸€ä¸ªæ–°è·å–çš„å¯¹è±¡è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚</p>
<p>å¦‚æœcentralç©ºé—²åˆ—è¡¨ä¹Ÿæ˜¯ç©ºçš„ï¼šï¼ˆ1ï¼‰æˆ‘ä»¬ä»centralé¡µåˆ†é…å™¨åˆ†é…ä¸€ç³»åˆ—é¡µã€‚ï¼ˆ2ï¼‰å°†ä¸€ç³»åˆ—é¡µåˆ†æˆè¿™ä¸ªsize-classçš„ä¸€ç»„å¯¹è±¡ã€‚ï¼ˆ3ï¼‰å°†æ–°å¯¹è±¡æ”¾åœ¨centralç©ºé—²åˆ—è¡¨ä¸­ã€‚ï¼ˆ4ï¼‰å’Œä»¥å‰ä¸€æ ·ï¼Œå°†å…¶ä¸­ä¸€äº›å¯¹è±¡ç§»åŠ¨åˆ°çº¿ç¨‹æœ¬åœ°ç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
<h1 id="å¤§å¯¹è±¡åˆ†é…"><a href="#å¤§å¯¹è±¡åˆ†é…" class="headerlink" title="å¤§å¯¹è±¡åˆ†é…"></a>å¤§å¯¹è±¡åˆ†é…</h1><p>å¤§å¯¹è±¡å¤§å°ï¼ˆ&gt; 32Kï¼‰å‘ä¸Šèˆå…¥åˆ°é¡µå¤§å°ï¼ˆ4Kï¼‰å¹¶ç”±centralé¡µå †å¤„ç†ã€‚centralé¡µå †ä¹Ÿæ˜¯ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ•°ç»„ã€‚å¯¹äºi &lt; 256ï¼Œç¬¬kä¸ªæ•°ç»„å…ƒç´ æ˜¯ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œåˆ—è¡¨å…ƒç´ ç”±kä¸ªé¡µç»„æˆã€‚æ‰€ä»¥ç¬¬256ä¸ªæ•°ç»„å…ƒç´ çš„ç©ºé—²åˆ—è¡¨å…ƒç´ æ˜¯ç”±&gt;= 256ä¸ªé¡µç»„æˆï¼š</p>
<p><a href="http://idiotsky.top/images3/tcmalloc-3.gif"><img src="http://idiotsky.top/images3/tcmalloc-3.gif" alt=""></a></p>
<p>åˆ†é…ä¸€ä¸ªkä¸ªé¡µçš„å†…å­˜é¦–å…ˆè¦åˆ°ç¬¬kä¸ªç©ºé—²åˆ—è¡¨çœ‹çœ‹æ˜¯å¦æ»¡è¶³ã€‚å¦‚æœè¯¥ç©ºé—²åˆ—è¡¨ä¸ºç©ºï¼Œæˆ‘ä»¬å°†æŸ¥çœ‹ä¸‹ä¸€ä¸ªç©ºé—²åˆ—è¡¨ï¼Œä¾æ­¤ç±»æ¨ã€‚æœ€åï¼Œå¦‚æœ‰å¿…è¦ï¼Œæˆ‘ä»¬ä¼šæŸ¥çœ‹æœ€åä¸€ä¸ªç©ºé—²åˆ—è¡¨ã€‚å¦‚æœå¤±è´¥ï¼Œæˆ‘ä»¬ä»ç³»ç»Ÿä¸­è·å–å†…å­˜ï¼ˆä½¿ç”¨sbrkï¼Œmmapæˆ–åœ¨/dev/memæ˜ å°„éƒ¨åˆ†å†…å­˜ï¼‰ã€‚</p>
<p>å¦‚æœæ»¡è¶³kä¸ªé¡µå†…å­˜åˆ†é…çš„æ˜¯é¡µå¤§å°&gt;kï¼Œåˆ™å°†åˆ†é…åå‰©ä½™éƒ¨åˆ†é‡æ–°æ’å…¥é¡µå †ä¸­çš„ç›¸åº”ç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
<h1 id="Spansï¼ˆè·¨åº¦ï¼‰"><a href="#Spansï¼ˆè·¨åº¦ï¼‰" class="headerlink" title="Spansï¼ˆè·¨åº¦ï¼‰"></a>Spansï¼ˆè·¨åº¦ï¼‰</h1><p>ç”±TCMallocç®¡ç†çš„å †ç”±ä¸€ç»„é¡µç»„æˆã€‚ä¸€ç³»åˆ—è¿ç»­é¡µé¢ç”±Spanå¯¹è±¡è¡¨ç¤ºã€‚Spanå¯ä»¥åˆ†é…ï¼Œä¹Ÿå¯ä»¥æ˜¯ç©ºé—²çš„ã€‚å¦‚æœç©ºé—²ï¼Œåˆ™spanæ˜¯é¡µå †é“¾æ¥åˆ—è¡¨ä¸­çš„æ¡ç›®ä¹‹ä¸€ã€‚å¦‚æœå·²åˆ†é…ï¼Œåˆ™å®ƒæ˜¯å·²ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„å¤§å¯¹è±¡ï¼Œæˆ–è€…å·²åˆ†å‰²ä¸ºä¸€ç³»åˆ—å°å¯¹è±¡çš„ä¸€ç»„é¡µã€‚å¦‚æœæ‹†åˆ†ä¸ºå°å¯¹è±¡ï¼Œåˆ™ä¼šåœ¨Spanä¸­è®°å½•å¯¹è±¡çš„size-classã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ç”±é¡µç ç´¢å¼•çš„centralæ•°ç»„æ¥æŸ¥æ‰¾é¡µé¢æ‰€å±çš„Spanã€‚ä¾‹å¦‚ï¼ŒSpan aå ç”¨2é¡µï¼ŒSpan bå 1é¡µï¼ŒSpan cå 5é¡µï¼ŒSpan då 3é¡µã€‚</p>
<p><a href="http://idiotsky.top/images3/tcmalloc-4.gif"><img src="http://idiotsky.top/images3/tcmalloc-4.gif" alt=""></a></p>
<p>32ä½åœ°å€ç©ºé—´å¯ä»¥å®¹çº³2 ^ 20ä¸ª4Ké¡µé¢ï¼Œå› æ­¤è¿™ä¸ªä¸­å¤®é˜µåˆ—å ç”¨4MBç©ºé—´ï¼Œè¿™ä¼¼ä¹æ˜¯å¯ä»¥æ¥å—çš„ã€‚åœ¨64ä½è®¡ç®—æœºä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨3å±‚åŸºæ•°æ ‘(radix tree)è€Œä¸æ˜¯æ•°ç»„æ¥ä»é¡µç æ˜ å°„åˆ°ç›¸åº”çš„SpanæŒ‡é’ˆã€‚</p>
<h1 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h1><p>å½“ä¸€ä¸ªå¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬è®¡ç®—å…¶é¡µç å¹¶åœ¨centralæ•°ç»„ä¸­æŸ¥æ‰¾å®ƒä»¥æ‰¾åˆ°ç›¸åº”çš„spanå¯¹è±¡ã€‚spanå‘Šè¯‰æˆ‘ä»¬å¯¹è±¡æ˜¯å¦å¾ˆå°ï¼Œå¦‚æœå¯¹è±¡å¾ˆå°ï¼Œspanå‘Šè¯‰æˆ‘ä»¬å¯¹è±¡çš„size-classã€‚å¦‚æœå¯¹è±¡å¾ˆå°ï¼Œæˆ‘ä»¬å°†å®ƒæ’å…¥å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ç¼“å­˜ä¸­çš„ç›¸åº”ç©ºé—²åˆ—è¡¨ä¸­ã€‚å¦‚æœçº¿ç¨‹ç¼“å­˜ç°åœ¨è¶…è¿‡é¢„å®šå¤§å°ï¼ˆé»˜è®¤ä¸º2MBï¼‰ï¼Œæˆ‘ä»¬è¿è¡Œåƒåœ¾æ”¶é›†å™¨ï¼Œå°†æœªä½¿ç”¨çš„å¯¹è±¡ä»çº¿ç¨‹ç¼“å­˜ç§»åŠ¨åˆ°centralç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
<p>å¦‚æœå¯¹è±¡å¾ˆå¤§ï¼Œåˆ™spanå‘Šè¯‰æˆ‘ä»¬å¯¹è±¡è¦†ç›–çš„é¡µèŒƒå›´ã€‚å‡è®¾è¿™ä¸ªèŒƒå›´æ˜¯[p,q]ã€‚æˆ‘ä»¬è¿˜ä¸ºspanæŸ¥æ‰¾é¡µp-1å’Œé¡µq+1ã€‚å¦‚æœè¿™äº›ç›¸é‚»spanä¸­çš„ä»»ä½•ä¸€ä¸ªæ˜¯ç©ºé—²çš„ï¼Œæˆ‘ä»¬å°†å®ƒä»¬ä¸[p,q]çš„spanåˆå¹¶ ã€‚ç”Ÿæˆçš„spanå°†æ’å…¥é¡µå †ä¸­çš„ç›¸åº”ç©ºé—²åˆ—è¡¨ä¸­ã€‚</p>
<h1 id="å°å¯¹è±¡çš„centralç©ºé—²åˆ—è¡¨"><a href="#å°å¯¹è±¡çš„centralç©ºé—²åˆ—è¡¨" class="headerlink" title="å°å¯¹è±¡çš„centralç©ºé—²åˆ—è¡¨"></a>å°å¯¹è±¡çš„centralç©ºé—²åˆ—è¡¨</h1><p>å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªsize-classä¿ç•™ä¸€ä¸ªcentralç©ºé—²åˆ—è¡¨ã€‚æ¯ä¸ªcentralç©ºé—²åˆ—è¡¨éƒ½è¢«ç»„ç»‡ä¸ºä¸€ä¸ªä¸¤çº§æ•°æ®ç»“æ„ï¼šä¸€ç»„spanï¼Œä»¥åŠæ¯ä¸ªspançš„ç©ºé—²å¯¹è±¡çš„é“¾è¡¨ã€‚</p>
<p>ä»centralç©ºé—²åˆ—è¡¨åˆ†é…å¯¹è±¡,æ˜¯é€šè¿‡ä»æŸä¸ªspançš„é“¾è¡¨ä¸­åˆ é™¤ç¬¬ä¸€ä¸ªæ¡ç›®ã€‚ï¼ˆå¦‚æœæ‰€æœ‰spanéƒ½æœ‰ç©ºé“¾è¡¨ï¼Œåˆ™é¦–å…ˆä»centralé¡µå †åˆ†é…é€‚å½“å¤§å°çš„spanã€‚ï¼‰</p>
<p>å°†å¯¹è±¡è¿”å›åˆ°centralç©ºé—²åˆ—è¡¨ï¼Œæ˜¯é€šè¿‡å°†å¯¹è±¡æ·»åŠ åˆ°å…¶åŒ…å«spançš„é“¾è¡¨ã€‚å¦‚æœé“¾è¡¨é•¿åº¦ç°åœ¨ç­‰äºspanä¸­çš„å°å¯¹è±¡æ€»æ•°ï¼Œåˆ™æ­¤spanç°åœ¨å®Œå…¨ç©ºé—²å¹¶è¿”å›åˆ°é¡µå †ã€‚</p>
<h1 id="çº¿ç¨‹ç¼“å­˜çš„åƒåœ¾å›æ”¶"><a href="#çº¿ç¨‹ç¼“å­˜çš„åƒåœ¾å›æ”¶" class="headerlink" title="çº¿ç¨‹ç¼“å­˜çš„åƒåœ¾å›æ”¶"></a>çº¿ç¨‹ç¼“å­˜çš„åƒåœ¾å›æ”¶</h1><p>å½“ç¼“å­˜ä¸­æ‰€æœ‰å¯¹è±¡çš„ç»„åˆå¤§å°è¶…è¿‡2MBæ—¶ï¼Œå°†å¯¹çº¿ç¨‹ç¼“å­˜è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚éšç€çº¿ç¨‹æ•°é‡çš„å¢åŠ ï¼Œåƒåœ¾æ”¶é›†é˜ˆå€¼ä¼šè‡ªåŠ¨é™ä½ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šåœ¨å…·æœ‰å¤§é‡çº¿ç¨‹çš„ç¨‹åºä¸­æµªè´¹è¿‡å¤šçš„å†…å­˜ã€‚</p>
<p>æˆ‘ä»¬éå†ç¼“å­˜ä¸­çš„æ‰€æœ‰ç©ºé—²åˆ—è¡¨ï¼Œå¹¶å°†ä¸€äº›å¯¹è±¡ä»ç©ºé—²åˆ—è¡¨ç§»åŠ¨åˆ°ç›¸åº”çš„centralåˆ—è¡¨ã€‚</p>
<p>ä»ç©ºé—²åˆ—è¡¨ç§»åŠ¨çš„å¯¹è±¡æ•°é‡æ˜¯ä½¿ç”¨æ¯ä¸ªåˆ—è¡¨çš„ä½æ°´ä½æ ‡è®°Lå†³å®šçš„ã€‚ Lè®°å½•è‡ªä¸Šæ¬¡åƒåœ¾å›æ”¶ä»¥æ¥åˆ—è¡¨çš„æœ€å°é•¿åº¦ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Læœ€åä¸€ä¸ªåƒåœ¾æ”¶é›†ä¸­çš„å¯¹è±¡ç¼©çŸ­åˆ—è¡¨ï¼Œè€Œæ— éœ€å¯¹centralè¡¨è¿›è¡Œä»»ä½•é¢å¤–è®¿é—®ã€‚æˆ‘ä»¬ä½¿ç”¨æ­¤å†å²è®°å½•ä½œä¸ºå°†æ¥è®¿é—®çš„é¢„æµ‹å™¨ï¼Œå¹¶å°†L/2å¯¹è±¡ä»çº¿ç¨‹ç¼“å­˜ç©ºé—²åˆ—è¡¨ç§»åŠ¨åˆ°ç›¸åº”çš„centralç©ºé—²åˆ—è¡¨ã€‚è¯¥ç®—æ³•å…·æœ‰è‰¯å¥½çš„å±æ€§ï¼Œå¦‚æœçº¿ç¨‹åœæ­¢ä½¿ç”¨ç‰¹å®šå¤§å°ï¼Œåˆ™è¯¥å¤§å°çš„æ‰€æœ‰å¯¹è±¡å°†å¿«é€Ÿä»çº¿ç¨‹é«˜é€Ÿç¼“å­˜ç§»åŠ¨åˆ°centralç©ºé—²åˆ—è¡¨ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p>ç¿»è¯‘ <a href="http://goog-perftools.sourceforge.net/doc/tcmalloc.html" target="_blank" rel="noopener">http://goog-perftools.sourceforge.net/doc/tcmalloc.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;åŠ¨æœº&quot;&gt;&lt;a href=&quot;#åŠ¨æœº&quot; class=&quot;headerlink&quot; title=&quot;åŠ¨æœº&quot;&gt;&lt;/a&gt;åŠ¨æœº&lt;/h1&gt;&lt;p&gt;TCMallocæ¯”glibc 2.3 mallocï¼ˆä½œä¸ºä¸€ä¸ªåä¸ºptmalloc2çš„ç‹¬ç«‹åº“æä¾›ï¼‰å’Œæˆ‘æµ‹è¯•çš„å…¶ä»–mallocæ›´å¿«ã€‚ptmalloc2åœ¨2.8 GHz P4ä¸Šæ‰§è¡Œmalloc/freeæ“ä½œå¯¹ï¼ˆå¯¹äºå°å¯¹è±¡ï¼‰éœ€è¦å¤§çº¦300çº³ç§’ã€‚å¯¹äºç›¸åŒçš„æ“ä½œå¯¹ï¼ŒTCMallocå®ç°å¤§çº¦éœ€è¦50çº³ç§’ã€‚é€Ÿåº¦å¯¹äºmallocå®ç°å¾ˆé‡è¦ï¼Œå› ä¸ºå¦‚æœmallocä¸å¤Ÿå¿«ï¼Œåº”ç”¨ç¨‹åºç¼–å†™è€…å€¾å‘äºåœ¨mallocä¹‹ä¸Šç¼–å†™è‡ªå·±çš„è‡ªå®šä¹‰ç©ºé—²åˆ—è¡¨ã€‚è¿™å¯èƒ½å¯¼è‡´é¢å¤–çš„å¤æ‚æ€§å’Œæ›´å¤šçš„å†…å­˜ä½¿ç”¨ï¼Œé™¤éåº”ç”¨ç¨‹åºç¼–å†™è€…éå¸¸å°å¿ƒåœ°é€‚å½“è°ƒæ•´ç©ºé—²åˆ—è¡¨çš„å¤§å°å¹¶ä»ç©ºé—²åˆ—è¡¨ä¸­æ¸…é™¤ç©ºé—²å¯¹è±¡&lt;/p&gt;
&lt;p&gt;TCMallocè¿˜å‡å°‘äº†å¤šçº¿ç¨‹ç¨‹åºçš„é”äº‰ç”¨ã€‚å¯¹äºå°å‹å¯¹è±¡ï¼Œå‡ ä¹æ²¡æœ‰äº‰ç”¨ã€‚å¯¹äºå¤§å‹å¯¹è±¡ï¼ŒTCMallocå°è¯•ä½¿ç”¨ç»†ç²’åº¦å’Œé«˜æ•ˆçš„è‡ªæ—‹é”ã€‚ptmalloc2è¿˜é€šè¿‡ä½¿ç”¨æ¯çº¿ç¨‹arenaæ¥å‡å°‘é”äº‰ç”¨ï¼Œä½†æ˜¯ptmalloc2ä½¿ç”¨æ¯çº¿ç¨‹arenaå­˜åœ¨å¾ˆå¤§é—®é¢˜ã€‚åœ¨ptmalloc2ä¸­ï¼Œå†…å­˜æ°¸è¿œä¸ä¼šä»ä¸€ä¸ªarenaè½¬ç§»åˆ°å¦ä¸€ä¸ªarenaã€‚è¿™å¯èƒ½å¯¼è‡´å¤§é‡æµªè´¹çš„ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªGoogleåº”ç”¨ç¨‹åºä¸­ï¼Œç¬¬ä¸€é˜¶æ®µå°†ä¸ºå…¶æ•°æ®ç»“æ„åˆ†é…å¤§çº¦300MBçš„å†…å­˜ã€‚å½“ç¬¬ä¸€é˜¶æ®µç»“æŸæ—¶ï¼Œç¬¬äºŒé˜¶æ®µå°†åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¼€å§‹ã€‚å¦‚æœç¬¬äºŒé˜¶æ®µè¢«æŒ‡å®šä¸ºä¸ç¬¬ä¸€é˜¶æ®µä½¿ç”¨çš„arenaä¸åŒçš„arenaï¼Œæ­¤é˜¶æ®µä¸ä¼šé‡ç”¨ç¬¬ä¸€é˜¶æ®µä¹‹åå‰©ä½™çš„ä»»ä½•å†…å­˜ï¼Œå¹¶ä¼šå‘åœ°å€ç©ºé—´æ·»åŠ å¦å¤–300MBã€‚åœ¨å…¶ä»–åº”ç”¨ä¸­ä¹Ÿæ³¨æ„åˆ°ç±»ä¼¼çš„å†…å­˜çˆ†ç‚¸é—®é¢˜ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="c" scheme="http://idiotsky.top/categories/c/"/>
    
    
      <category term="tcmalloc" scheme="http://idiotsky.top/tags/tcmalloc/"/>
    
      <category term="malloc" scheme="http://idiotsky.top/tags/malloc/"/>
    
  </entry>
  
  <entry>
    <title>MySqlä¸­çš„é”æœºåˆ¶</title>
    <link href="http://idiotsky.top/2018/09/10/mysql-lock/"/>
    <id>http://idiotsky.top/2018/09/10/mysql-lock/</id>
    <published>2018-09-10T09:51:52.000Z</published>
    <updated>2018-09-11T15:26:07.796Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¹è§‚é”ä¸æ‚²è§‚é”"><a href="#ä¹è§‚é”ä¸æ‚²è§‚é”" class="headerlink" title="ä¹è§‚é”ä¸æ‚²è§‚é”"></a>ä¹è§‚é”ä¸æ‚²è§‚é”</h1><ul>
<li>ä¹è§‚é”ï¼šæ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºå…¶ä»–äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œè€Œæ˜¯åœ¨æ›´æ–°çš„æ—¶å€™å»åˆ¤æ–­åœ¨æ­¤æœŸé—´æœ‰æ²¡æœ‰å…¶ä»–äººæ›´æ–°äº†æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶ã€‚åœ¨æ•°æ®åº“ä¸­å¯ä»¥é€šè¿‡ä¸ºæ•°æ®è¡¨å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·å­—æ®µå®ç°ã€‚è¯»å–æ•°æ®æ—¶å°†ç‰ˆæœ¬å·ä¸€åŒè¯»å‡ºï¼Œæ•°æ®æ¯æ¬¡æ›´æ–°æ—¶å¯¹ç‰ˆæœ¬å·åŠ ä¸€ã€‚å½“æˆ‘ä»¬æ›´æ–°çš„æ—¶å€™ï¼Œåˆ¤æ–­æ•°æ®åº“è¡¨å¯¹åº”è®°å½•çš„å½“å‰ç‰ˆæœ¬å·ä¸ç¬¬ä¸€æ¬¡å–å‡ºæ¥çš„ç‰ˆæœ¬å·å€¼è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœå€¼ç›¸ç­‰ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ®ã€‚ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œå¯ä»¥æé«˜ååé‡ã€‚</li>
<li>æ‚²è§‚é”ï¼šæ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨è¯»æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³è¯»è¿™ä¸ªæ•°æ®æ—¶å°±ä¼šè¢«é˜»å¡ã€‚MySQLä¸­å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨æ“ä½œä¹‹å‰å…ˆä¸Šé”ã€‚</li>
</ul>
<a id="more"></a>
<h1 id="å…±äº«é”ä¸æ’ä»–é”"><a href="#å…±äº«é”ä¸æ’ä»–é”" class="headerlink" title="å…±äº«é”ä¸æ’ä»–é”"></a>å…±äº«é”ä¸æ’ä»–é”</h1><ul>
<li><p>å…±äº«é”ï¼šå…±äº«é”åˆå«åšè¯»é”æˆ–Sé”ï¼ŒåŠ ä¸Šå…±äº«é”ååœ¨äº‹åŠ¡ç»“æŸä¹‹å‰å…¶ä»–äº‹åŠ¡åªèƒ½å†åŠ å…±äº«é”ã€åªèƒ½å¯¹å…¶è¿›è¡Œè¯»æ“ä½œä¸èƒ½å†™æ“ä½œï¼Œé™¤æ­¤ä¹‹å¤–å…¶ä»–ä»»ä½•ç±»å‹çš„é”éƒ½ä¸èƒ½å†åŠ äº†ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># åŠ ä¸Šlock in share mode</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span> book_book <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ’ä»–é”ï¼šæ’ä»–é”åˆå«å†™é”æˆ–Xé”ï¼ŒæŸä¸ªäº‹åŠ¡å¯¹æ•°æ®åŠ ä¸Šæ’ä»–é”åï¼Œåªèƒ½è¿™ä¸ªäº‹åŠ¡å¯¹å…¶è¿›è¡Œè¯»å†™ï¼Œåœ¨æ­¤äº‹åŠ¡ç»“æŸä¹‹å‰ï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½å¯¹å…¶åŠ ä»»ä½•é”ï¼Œå¯ä»¥è¯»å–,ä¸èƒ½è¿›è¡Œå†™æ“ä½œï¼Œéœ€ç­‰å¾…å…¶é‡Šæ”¾ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># åŠ ä¸Šfor update</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span> book_book <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="è¡Œé”ä¸è¡¨é”"><a href="#è¡Œé”ä¸è¡¨é”" class="headerlink" title="è¡Œé”ä¸è¡¨é”"></a>è¡Œé”ä¸è¡¨é”</h1><blockquote>
<p>è¡Œé”ä¸è¡¨é”åŒºåˆ«åœ¨äºé”çš„ç²’åº¦ï¼Œåœ¨Innodbå¼•æ“ä¸­æ—¢æ”¯æŒè¡Œé”ä¹Ÿæ”¯æŒè¡¨é”(MyISAMå¼•æ“åªæ”¯æŒè¡¨é”)ï¼Œåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®InnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ã€‚</p>
</blockquote>
<ul>
<li>è¡¨é”ï¼šå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªæ¦‚ç‡é«˜ï¼Œå¹¶å‘åº¦æœ€ä½</li>
<li>è¡Œé”ï¼šå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡ä½ï¼Œå¹¶å‘åº¦é«˜</li>
</ul>
<p>ä¸‹é¢ä¸¾ä¸¤ä¸ªä¾‹å­è¯´æ˜ä¸Šé¢å‡ ç§é”ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># äº‹åŠ¡1</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span> book_book <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'JAVAç¼–ç¨‹æ€æƒ³'</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"></span><br><span class="line"># äº‹åŠ¡2</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> book_book <span class="keyword">SET</span> <span class="keyword">name</span> = <span class="string">'new book'</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'new'</span>;</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_TRX;</span><br><span class="line"></span><br><span class="line">trx_id  trx_state       trx_started           trx_tables_locked    trx_rows_locked</span><br><span class="line">39452	<span class="keyword">LOCK</span> <span class="keyword">WAIT</span>	<span class="number">2018</span><span class="number">-09</span><span class="number">-08</span> <span class="number">19</span>:<span class="number">01</span>:<span class="number">39</span>	    <span class="number">1</span>	                <span class="number">1</span>	</span><br><span class="line"><span class="number">282907511143936</span>	RUNNING	<span class="number">2018</span><span class="number">-09</span><span class="number">-08</span> <span class="number">18</span>:<span class="number">58</span>:<span class="number">47</span>	    <span class="number">1</span>	                <span class="number">38</span></span><br></pre></td></tr></table></figure>
<p>äº‹åŠ¡1ç»™bookè¡¨åŠ ä¸Šäº†å…±äº«é”ï¼Œäº‹åŠ¡2å°è¯•ä¿®æ”¹bookè¡¨å‘ç”Ÿäº†é˜»å¡ï¼ŒæŸ¥çœ‹äº‹åŠ¡çŠ¶æ€å¯ä»¥çŸ¥é“äº‹åŠ¡ä¸€ç”±äºæ²¡æœ‰èµ°ç´¢å¼•ä½¿ç”¨äº†è¡¨é”ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># äº‹åŠ¡1</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span> book_book <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">2</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"></span><br><span class="line"># äº‹åŠ¡2</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> book_book <span class="keyword">SET</span> <span class="keyword">name</span> = <span class="string">'new book'</span> <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="number">1</span>; </span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.INNODB_TRX;</span><br><span class="line"></span><br><span class="line">trx_id          trx_state   trx_started     trx_tables_locked    trx_rows_locked</span><br><span class="line">39454	        RUNNING	2018-09-08 19:10:44	1	                1	</span><br><span class="line">282907511143936	RUNNING	2018-09-08 19:10:35	1	                1</span><br></pre></td></tr></table></figure>
<p>äº‹åŠ¡1ç»™bookè¡¨åŠ ä¸Šäº†å…±äº«é”ï¼Œäº‹åŠ¡2å°è¯•ä¿®æ”¹bookè¡¨å¹¶æ²¡æœ‰å‘ç”Ÿé˜»å¡ã€‚è¿™æ˜¯ç”±äºäº‹åŠ¡ä¸€å’Œäº‹åŠ¡äºŒéƒ½èµ°äº†ç´¢å¼•ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯è¡Œé”ï¼Œå¹¶ä¸ä¼šå‘ç”Ÿé˜»å¡ã€‚</p>
<h1 id="æ„å‘é”-InnoDBç‰¹æœ‰"><a href="#æ„å‘é”-InnoDBç‰¹æœ‰" class="headerlink" title="æ„å‘é”(InnoDBç‰¹æœ‰)"></a>æ„å‘é”(InnoDBç‰¹æœ‰)</h1><blockquote>
<p>æ„å‘é”çš„æ„ä¹‰åœ¨äºæ–¹ä¾¿æ£€æµ‹è¡¨é”å’Œè¡Œé”ä¹‹é—´çš„å†²çª</p>
</blockquote>
<ul>
<li>æ„å‘é”ï¼šæ„å‘é”æ˜¯ä¸€ç§è¡¨çº§é”ï¼Œä»£è¡¨è¦å¯¹æŸè¡Œè®°å½•è¿›è¡Œæ“ä½œã€‚åˆ†ä¸ºæ„å‘å…±äº«é”(IS)å’Œæ„å‘æ’ä»–é”(IX)ã€‚</li>
<li>è¡Œé”å’Œè¡¨é”ä¹‹é—´çš„å†²çªï¼šäº‹åŠ¡Aç»™è¡¨ä¸­çš„æŸä¸€è¡ŒåŠ äº†å…±äº«é”ï¼Œè®©è¿™ä¸€è¡Œåªèƒ½è¯»ä¸èƒ½å†™ã€‚ä¹‹åäº‹åŠ¡Bç”³è¯·æ•´ä¸ªè¡¨çš„æ’ä»–é”ã€‚å¦‚æœäº‹åŠ¡Bç”³è¯·æˆåŠŸï¼Œé‚£ä¹ˆå®ƒå°±èƒ½ä¿®æ”¹è¡¨ä¸­çš„ä»»æ„ä¸€è¡Œï¼Œè¿™ä¸AæŒæœ‰çš„è¡Œé”æ˜¯å†²çªçš„ã€‚InnoDBå¼•å…¥äº†æ„å‘é”æ¥åˆ¤æ–­å®ƒä»¬ä¹‹é—´çš„å†²çªã€‚<ul>
<li>æ²¡æœ‰æ„å‘é”çš„æƒ…å†µï¼š1ã€åˆ¤æ–­è¡¨æ˜¯å¦å·²è¢«å…¶ä»–äº‹åŠ¡ç”¨è¡¨é”é”è¡¨ã€‚2ã€åˆ¤æ–­è¡¨ä¸­çš„æ¯ä¸€è¡Œæ˜¯å¦å·²è¢«è¡Œé”é”ä½ï¼Œè¿™æ ·è¦éå†æ•´ä¸ªè¡¨ï¼Œæ•ˆç‡å¾ˆä½ã€‚</li>
<li>æ„å‘é”å­˜åœ¨çš„æƒ…å†µï¼š1ã€åˆ¤æ–­è¡¨æ˜¯å¦å·²è¢«å…¶ä»–äº‹åŠ¡ç”¨è¡¨é”é”è¡¨ã€‚2ã€åˆ¤æ–­è¡¨ä¸Šæ˜¯å¦æœ‰æ„å‘é”</li>
</ul>
</li>
<li>æ„å‘é”å­˜åœ¨æ—¶ç”³è¯·é”ï¼šç”³è¯·æ„å‘é”çš„åŠ¨ä½œæ˜¯æ•°æ®åº“å®Œæˆçš„ï¼Œä¸Šè¿°ä¾‹å­ä¸­äº‹åŠ¡Aç”³è¯·ä¸€è¡Œçš„è¡Œé”çš„æ—¶å€™ï¼Œæ•°æ®åº“ä¼šè‡ªåŠ¨å…ˆå¼€å§‹ç”³è¯·è¡¨çš„æ„å‘é”ï¼Œå½“äº‹åŠ¡Bç”³è¯·è¡¨çš„æ’ä»–é”æ—¶æ£€æµ‹åˆ°å­˜åœ¨æ„å‘é”åˆ™ä¼šé˜»å¡ã€‚</li>
<li>æ„å‘é”ä¼šä¸ä¼šå­˜åœ¨å†²çªï¼š æ„å‘é”ä¹‹é—´ä¸ä¼šå†²çª, å› ä¸ºæ„å‘é”åªæ˜¯ä»£è¡¨è¦å¯¹æŸè¡Œè®°å½•è¿›è¡Œæ“ä½œã€‚</li>
</ul>
<h1 id="å„ç§é”ä¹‹é—´çš„å…±å­˜æƒ…å†µ"><a href="#å„ç§é”ä¹‹é—´çš„å…±å­˜æƒ…å†µ" class="headerlink" title="å„ç§é”ä¹‹é—´çš„å…±å­˜æƒ…å†µ"></a>å„ç§é”ä¹‹é—´çš„å…±å­˜æƒ…å†µ</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">       IX     IS       X      S</span><br><span class="line">IX    å…¼å®¹    å…¼å®¹    å†²çª    å†²çª</span><br><span class="line">IS    å…¼å®¹    å…¼å®¹    å†²çª    å…¼å®¹</span><br><span class="line">X     å†²çª    å†²çª    å†²çª    å†²çª</span><br><span class="line">S     å†²çª    å…¼å®¹    å†²çª    å…¼å®¹</span><br></pre></td></tr></table></figure>
<h1 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h1><ul>
<li>æ¦‚å¿µï¼šä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ã€‚</li>
<li>å­˜åœ¨æ¡ä»¶ï¼š1ã€ äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨ã€‚2ã€ è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªäº‹åŠ¡å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚3ã€ä¸å‰¥å¤ºæ¡ä»¶ï¼šå·²è·å¾—çš„èµ„æºï¼Œåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚4ã€å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šå½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…å…³ç³»</li>
<li>è§£é™¤æ­£åœ¨æ­»é”çš„çŠ¶æ€ï¼šæ’¤é”€å…¶ä¸­ä¸€ä¸ªäº‹åŠ¡</li>
</ul>
<h1 id="é—´éš™é”-Next-Keyé”"><a href="#é—´éš™é”-Next-Keyé”" class="headerlink" title="é—´éš™é”(Next-Keyé”)"></a>é—´éš™é”(Next-Keyé”)</h1><blockquote>
<p>é—´éš™é”ä½¿å¾—InnoDBè§£å†³å¹»è¯»é—®é¢˜ï¼ŒåŠ ä¸ŠMVCCä½¿å¾—InnoDBçš„RRéš”ç¦»çº§åˆ«å®ç°äº†ä¸²è¡ŒåŒ–çº§åˆ«çš„æ•ˆæœï¼Œå¹¶ä¸”ä¿ç•™äº†æ¯”è¾ƒå¥½çš„å¹¶å‘æ€§èƒ½ã€‚</p>
</blockquote>
<p>å®šä¹‰ï¼šå½“æˆ‘ä»¬ç”¨èŒƒå›´æ¡ä»¶æ£€ç´¢æ•°æ®æ—¶è¯·æ±‚å…±äº«æˆ–æ’ä»–é”æ—¶ï¼ŒInnoDBä¼šç»™ç¬¦åˆæ¡ä»¶çš„å·²æœ‰æ•°æ®çš„ç´¢å¼•åŠ é”ï¼›å¯¹äºé”®å€¼åœ¨æ¡ä»¶èŒƒå›´å†…ä½†å¹¶ä¸å­˜åœ¨çš„è®°å½•ï¼Œå«åšé—´éš™(GAP)ï¼ŒInnoDBä¹Ÿä¼šå¯¹è¿™ä¸ªâ€é—´éš™â€åŠ é”ï¼Œè¿™ç§é”æœºåˆ¶å°±æ˜¯é—´éš™é”ã€‚</p>
<p>ä¾‹å¦‚ï¼šbookè¡¨ä¸­å­˜åœ¨bookId 1-80ï¼Œ90-99çš„è®°å½•ã€‚SELECT * FROM book WHERE bookId &lt; 100 FOR UPDATEã€‚InnoDBä¸ä»…ä¼šå¯¹bookIdå€¼ä¸º1-80ï¼Œ90-99çš„è®°å½•åŠ é”ï¼Œä¹Ÿä¼šå¯¹bookIdåœ¨81-89ä¹‹é—´(è¿™äº›è®°å½•å¹¶ä¸å­˜åœ¨)çš„é—´éš™åŠ é”ã€‚è¿™æ ·å°±èƒ½é¿å…äº‹åŠ¡éš”ç¦»çº§åˆ«å¯é‡å¤è¯»ä¸‹çš„å¹»è¯»ã€‚</p>
<h1 id="MVCC-å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"><a href="#MVCC-å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶" class="headerlink" title="MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)"></a>MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)</h1><blockquote>
<p>MVCC (Multiversion Concurrency Control)ï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æŠ€æœ¯,å®ƒä½¿å¾—å¤§éƒ¨åˆ†æ”¯æŒè¡Œé”çš„äº‹åŠ¡å¼•æ“ï¼Œä¸å†å•çº¯çš„ä½¿ç”¨è¡Œé”æ¥è¿›è¡Œæ•°æ®åº“çš„å¹¶å‘æ§åˆ¶ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æŠŠæ•°æ®åº“çš„è¡Œé”ä¸è¡Œçš„å¤šä¸ªç‰ˆæœ¬ç»“åˆèµ·æ¥ï¼Œåªéœ€è¦å¾ˆå°çš„å¼€é”€,å°±å¯ä»¥å®ç°éé”å®šè¯»ï¼Œä»è€Œå¤§å¤§æé«˜æ•°æ®åº“ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½</p>
</blockquote>
<h2 id="MVCCå®ç°åŸç†"><a href="#MVCCå®ç°åŸç†" class="headerlink" title="MVCCå®ç°åŸç†"></a>MVCCå®ç°åŸç†</h2><p>innodb MVCCä¸»è¦æ˜¯ä¸ºRepeatable-Readäº‹åŠ¡éš”ç¦»çº§åˆ«åšçš„ã€‚åœ¨æ­¤éš”ç¦»çº§åˆ«ä¸‹ï¼ŒAã€Bå®¢æˆ·ç«¯æ‰€ç¤ºçš„æ•°æ®ç›¸äº’éš”ç¦»ï¼Œäº’ç›¸æ›´æ–°ä¸å¯è§</p>
<p>äº†è§£innodbçš„è¡Œç»“æ„ã€Read-Viewçš„ç»“æ„å¯¹äºç†è§£innodb mvccçš„å®ç°ç”±é‡è¦æ„ä¹‰</p>
<p>innodbå­˜å‚¨çš„æœ€åŸºæœ¬rowä¸­åŒ…å«ä¸€äº›é¢å¤–çš„å­˜å‚¨ä¿¡æ¯ DATA_TRX_IDï¼ŒDATA_ROLL_PTRï¼ŒDB_ROW_IDï¼ŒDELETE BIT</p>
<ul>
<li>6å­—èŠ‚çš„DATA_TRX_ID æ ‡è®°äº†æœ€æ–°æ›´æ–°è¿™æ¡è¡Œè®°å½•çš„transaction idï¼Œæ¯å¤„ç†ä¸€ä¸ªäº‹åŠ¡ï¼Œå…¶å€¼è‡ªåŠ¨+1</li>
<li>7å­—èŠ‚çš„DATA_ROLL_PTR æŒ‡å‘å½“å‰è®°å½•é¡¹çš„rollback segmentçš„undo logè®°å½•ï¼Œæ‰¾ä¹‹å‰ç‰ˆæœ¬çš„æ•°æ®å°±æ˜¯é€šè¿‡è¿™ä¸ªæŒ‡</li>
<li>6å­—èŠ‚çš„DB_ROW_IDï¼Œå½“ç”±innodbè‡ªåŠ¨äº§ç”Ÿèšé›†ç´¢å¼•æ—¶ï¼Œèšé›†ç´¢å¼•åŒ…æ‹¬è¿™ä¸ªDB_ROW_IDçš„å€¼ï¼Œå¦åˆ™èšé›†ç´¢å¼•ä¸­ä¸åŒ…æ‹¬è¿™ä¸ªå€¼.ï¼Œè¿™ä¸ªç”¨äºç´¢å¼•å½“ä¸­</li>
<li>DELETE BITä½ç”¨äºæ ‡è¯†è¯¥è®°å½•æ˜¯å¦è¢«åˆ é™¤ï¼Œè¿™é‡Œçš„ä¸æ˜¯çœŸæ­£çš„åˆ é™¤æ•°æ®ï¼Œè€Œæ˜¯æ ‡å¿—å‡ºæ¥çš„åˆ é™¤ã€‚çœŸæ­£æ„ä¹‰çš„åˆ é™¤æ˜¯åœ¨commitçš„æ—¶å€™</li>
</ul>
<p><a href="http://idiotsky.top/images3/mysql-lock.png"><img src="http://idiotsky.top/images3/mysql-lock.png" alt=""></a></p>
<p>å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹</p>
<p>begin-&gt;ç”¨æ’ä»–é”é”å®šè¯¥è¡Œ-&gt;è®°å½•redo log-&gt;è®°å½•undo log-&gt;ä¿®æ”¹å½“å‰è¡Œçš„å€¼ï¼Œå†™äº‹åŠ¡ç¼–å·ï¼Œå›æ»šæŒ‡é’ˆæŒ‡å‘undo logä¸­çš„ä¿®æ”¹å‰çš„è¡Œ</p>
<p>ä¸Šè¿°è¿‡ç¨‹ç¡®åˆ‡åœ°è¯´æ˜¯æè¿°äº†UPDATEçš„äº‹åŠ¡è¿‡ç¨‹ï¼Œå…¶å®undo logåˆ†insertå’Œupdate undo logï¼Œå› ä¸ºinsertæ—¶ï¼ŒåŸå§‹çš„æ•°æ®å¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å›æ»šæ—¶æŠŠinsert undo logä¸¢å¼ƒå³å¯ï¼Œè€Œupdate undo logåˆ™å¿…é¡»éµå®ˆä¸Šè¿°è¿‡ç¨‹</p>
<p>ä¸‹é¢åˆ†åˆ«ä»¥ <strong>select</strong>ã€<strong>delete</strong>ã€ <strong>insert</strong>ã€ <strong>update</strong>è¯­å¥æ¥è¯´æ˜</p>
<p><strong>SELECT</strong></p>
<p>Innodbæ£€æŸ¥æ¯è¡Œæ•°æ®ï¼Œç¡®ä¿ä»–ä»¬ç¬¦åˆä¸¤ä¸ªæ ‡å‡†ï¼š</p>
<p>1.InnoDBåªæŸ¥æ‰¾ç‰ˆæœ¬æ—©äºå½“å‰äº‹åŠ¡ç‰ˆæœ¬çš„æ•°æ®è¡Œ(ä¹Ÿå°±æ˜¯æ•°æ®è¡Œçš„ç‰ˆæœ¬å¿…é¡»å°äºç­‰äºäº‹åŠ¡çš„ç‰ˆæœ¬)ï¼Œè¿™ç¡®ä¿å½“å‰äº‹åŠ¡è¯»å–çš„è¡Œéƒ½æ˜¯äº‹åŠ¡ä¹‹å‰å·²ç»å­˜åœ¨çš„ï¼Œæˆ–è€…æ˜¯ç”±å½“å‰äº‹åŠ¡åˆ›å»ºæˆ–ä¿®æ”¹çš„è¡Œ<br>2.è¡Œçš„åˆ é™¤æ“ä½œçš„ç‰ˆæœ¬ä¸€å®šæ˜¯æœªå®šä¹‰çš„æˆ–è€…å¤§äºå½“å‰äº‹åŠ¡çš„ç‰ˆæœ¬å·ï¼Œç¡®å®šäº†å½“å‰äº‹åŠ¡å¼€å§‹ä¹‹å‰ï¼Œè¡Œæ²¡æœ‰è¢«åˆ é™¤</p>
<p>ç¬¦åˆäº†ä»¥ä¸Šä¸¤ç‚¹åˆ™è¿”å›æŸ¥è¯¢ç»“æœã€‚</p>
<p><strong>INSERT</strong></p>
<p>InnoDBä¸ºæ¯ä¸ªæ–°å¢è¡Œè®°å½•å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºåˆ›å»ºIDã€‚</p>
<p><strong>DELETE</strong></p>
<p>InnoDBä¸ºæ¯ä¸ªåˆ é™¤è¡Œçš„è®°å½•å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºè¡Œçš„åˆ é™¤IDã€‚</p>
<p><strong>UPDATE</strong></p>
<p>InnoDBå¤åˆ¶äº†ä¸€è¡Œã€‚è¿™ä¸ªæ–°è¡Œçš„ç‰ˆæœ¬å·ä½¿ç”¨äº†ç³»ç»Ÿç‰ˆæœ¬å·ã€‚å®ƒä¹ŸæŠŠç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºäº†åˆ é™¤è¡Œçš„ç‰ˆæœ¬ã€‚</p>
<p><strong>è¯´æ˜</strong></p>
<p>insertæ“ä½œæ—¶ â€œåˆ›å»ºæ—¶é—´â€=DB_ROW_IDï¼Œè¿™æ—¶ï¼Œâ€œåˆ é™¤æ—¶é—´ â€æ˜¯æœªå®šä¹‰çš„ï¼›</p>
<p>updateæ—¶ï¼Œå¤åˆ¶æ–°å¢è¡Œçš„â€œåˆ›å»ºæ—¶é—´â€=DB_ROW_IDï¼Œåˆ é™¤æ—¶é—´æœªå®šä¹‰ï¼Œæ—§æ•°æ®è¡Œâ€œåˆ›å»ºæ—¶é—´â€ä¸å˜ï¼Œåˆ é™¤æ—¶é—´=è¯¥äº‹åŠ¡çš„DB_ROW_IDï¼›</p>
<p>deleteæ“ä½œï¼Œç›¸åº”æ•°æ®è¡Œçš„â€œåˆ›å»ºæ—¶é—´â€ä¸å˜ï¼Œåˆ é™¤æ—¶é—´=è¯¥äº‹åŠ¡çš„DB_ROW_IDï¼›</p>
<p>selectæ“ä½œå¯¹ä¸¤è€…éƒ½ä¸ä¿®æ”¹ï¼Œåªè¯»ç›¸åº”çš„æ•°æ®</p>
<h2 id="å¯¹äºMVCCçš„æ€»ç»“"><a href="#å¯¹äºMVCCçš„æ€»ç»“" class="headerlink" title="å¯¹äºMVCCçš„æ€»ç»“"></a>å¯¹äºMVCCçš„æ€»ç»“</h2><p>ä¸Šè¿°æ›´æ–°å‰å»ºç«‹undo logï¼Œæ ¹æ®å„ç§ç­–ç•¥è¯»å–æ—¶éé˜»å¡å°±æ˜¯MVCCï¼Œundo logä¸­çš„è¡Œå°±æ˜¯MVCCä¸­çš„å¤šç‰ˆæœ¬ï¼Œè¿™ä¸ªå¯èƒ½ä¸æˆ‘ä»¬æ‰€ç†è§£çš„MVCCæœ‰è¾ƒå¤§çš„å‡ºå…¥ï¼Œä¸€èˆ¬æˆ‘ä»¬è®¤ä¸ºMVCCæœ‰ä¸‹é¢å‡ ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¯è¡Œæ•°æ®éƒ½å­˜åœ¨ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ¯æ¬¡æ•°æ®æ›´æ–°æ—¶éƒ½æ›´æ–°è¯¥ç‰ˆæœ¬</li>
<li>ä¿®æ”¹æ—¶Copyå‡ºå½“å‰ç‰ˆæœ¬éšæ„ä¿®æ”¹ï¼Œå„ä¸ªäº‹åŠ¡ä¹‹é—´æ— å¹²æ‰°</li>
<li>ä¿å­˜æ—¶æ¯”è¾ƒç‰ˆæœ¬å·ï¼Œå¦‚æœæˆåŠŸï¼ˆcommitï¼‰ï¼Œåˆ™è¦†ç›–åŸè®°å½•ï¼›å¤±è´¥åˆ™æ”¾å¼ƒcopyï¼ˆrollbackï¼‰</li>
</ul>
<p>å°±æ˜¯æ¯è¡Œéƒ½æœ‰ç‰ˆæœ¬å·ï¼Œä¿å­˜æ—¶æ ¹æ®ç‰ˆæœ¬å·å†³å®šæ˜¯å¦æˆåŠŸï¼Œå¬èµ·æ¥å«æœ‰ä¹è§‚é”çš„å‘³é“ï¼Œè€ŒInnodbçš„å®ç°æ–¹å¼æ˜¯ï¼š</p>
<ul>
<li>äº‹åŠ¡ä»¥æ’ä»–é”çš„å½¢å¼ä¿®æ”¹åŸå§‹æ•°æ®</li>
<li>æŠŠä¿®æ”¹å‰çš„æ•°æ®å­˜æ”¾äºundo logï¼Œé€šè¿‡å›æ»šæŒ‡é’ˆä¸ä¸»æ•°æ®å…³è”</li>
<li>ä¿®æ”¹æˆåŠŸï¼ˆcommitï¼‰å•¥éƒ½ä¸åšï¼Œå¤±è´¥åˆ™æ¢å¤undo logä¸­çš„æ•°æ®ï¼ˆrollbackï¼‰</li>
</ul>
<p>äºŒè€…æœ€æœ¬è´¨çš„åŒºåˆ«æ˜¯ï¼Œå½“ä¿®æ”¹æ•°æ®æ—¶æ˜¯å¦è¦æ’ä»–é”å®šï¼Œå¦‚æœé”å®šäº†è¿˜ç®—ä¸ç®—æ˜¯MVCCï¼Ÿ </p>
<p>Innodbçš„å®ç°çœŸç®—ä¸ä¸ŠMVCCï¼Œå› ä¸ºå¹¶æ²¡æœ‰å®ç°æ ¸å¿ƒçš„å¤šç‰ˆæœ¬å…±å­˜ï¼Œundo logä¸­çš„å†…å®¹åªæ˜¯ä¸²è¡ŒåŒ–çš„ç»“æœï¼Œè®°å½•äº†å¤šä¸ªäº‹åŠ¡çš„è¿‡ç¨‹ï¼Œä¸å±äºå¤šç‰ˆæœ¬å…±å­˜ã€‚ä½†ç†æƒ³çš„MVCCæ˜¯éš¾ä»¥å®ç°çš„ï¼Œå½“äº‹åŠ¡ä»…ä¿®æ”¹ä¸€è¡Œè®°å½•ä½¿ç”¨ç†æƒ³çš„MVCCæ¨¡å¼æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¯ä»¥é€šè¿‡æ¯”è¾ƒç‰ˆæœ¬å·è¿›è¡Œå›æ»šï¼›ä½†å½“äº‹åŠ¡å½±å“åˆ°å¤šè¡Œæ•°æ®æ—¶ï¼Œç†æƒ³çš„MVCCæ®æ— èƒ½ä¸ºåŠ›äº†ã€‚</p>
<p>æ¯”å¦‚ï¼Œå¦‚æœTransaciton1æ‰§è¡Œç†æƒ³çš„MVCCï¼Œä¿®æ”¹Row1æˆåŠŸï¼Œè€Œä¿®æ”¹Row2å¤±è´¥ï¼Œæ­¤æ—¶éœ€è¦å›æ»šRow1ï¼Œä½†å› ä¸ºRow1æ²¡æœ‰è¢«é”å®šï¼Œå…¶æ•°æ®å¯èƒ½åˆè¢«Transaction2æ‰€ä¿®æ”¹ï¼Œå¦‚æœæ­¤æ—¶å›æ»šRow1çš„å†…å®¹ï¼Œåˆ™ä¼šç ´åTransaction2çš„ä¿®æ”¹ç»“æœï¼Œå¯¼è‡´Transaction2è¿åACIDã€‚</p>
<p>ç†æƒ³MVCCéš¾ä»¥å®ç°çš„æ ¹æœ¬åŸå› åœ¨äºä¼å›¾é€šè¿‡ä¹è§‚é”ä»£æ›¿äºŒæ®µæäº¤ã€‚ä¿®æ”¹ä¸¤è¡Œæ•°æ®ï¼Œä½†ä¸ºäº†ä¿è¯å…¶ä¸€è‡´æ€§ï¼Œä¸ä¿®æ”¹ä¸¤ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®å¹¶æ— åŒºåˆ«ï¼Œè€ŒäºŒæäº¤æ˜¯ç›®å‰è¿™ç§åœºæ™¯ä¿è¯ä¸€è‡´æ€§çš„å”¯ä¸€æ‰‹æ®µã€‚äºŒæ®µæäº¤çš„æœ¬è´¨æ˜¯é”å®šï¼Œä¹è§‚é”çš„æœ¬è´¨æ˜¯æ¶ˆé™¤é”å®šï¼ŒäºŒè€…çŸ›ç›¾ï¼Œæ•…ç†æƒ³çš„MVCCéš¾ä»¥çœŸæ­£åœ¨å®é™…ä¸­è¢«åº”ç”¨ï¼ŒInnodbåªæ˜¯å€Ÿäº†MVCCè¿™ä¸ªåå­—ï¼Œæä¾›äº†è¯»çš„éé˜»å¡è€Œå·²ã€‚</p>
<h2 id="å¿«ç…§è¯»å’Œå½“å‰è¯»"><a href="#å¿«ç…§è¯»å’Œå½“å‰è¯»" class="headerlink" title="å¿«ç…§è¯»å’Œå½“å‰è¯»"></a>å¿«ç…§è¯»å’Œå½“å‰è¯»</h2><p>åœ¨ä¸€ä¸ªæ”¯æŒMVCCå¹¶å‘æ§åˆ¶çš„ç³»ç»Ÿä¸­ï¼Œå“ªäº›è¯»æ“ä½œæ˜¯å¿«ç…§è¯»ï¼Ÿå“ªäº›æ“ä½œåˆæ˜¯å½“å‰è¯»å‘¢ï¼Ÿä»¥MySQL InnoDBä¸ºä¾‹ï¼š</p>
<p>å¿«ç…§è¯»ï¼šç®€å•çš„selectæ“ä½œï¼Œå±äºå¿«ç…§è¯»ï¼Œä¸åŠ é”ã€‚(å½“ç„¶ï¼Œä¹Ÿæœ‰ä¾‹å¤–ï¼Œä¸‹é¢ä¼šåˆ†æ)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from table where ?;</span><br></pre></td></tr></table></figure>
<p>å½“å‰è¯»ï¼šç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œï¼Œå±äºå½“å‰è¯»ï¼Œéœ€è¦åŠ é”ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select * from table where ? lock in share mode;</span><br><span class="line">select * from table where ? for update;</span><br><span class="line">insert into table values (â€¦);</span><br><span class="line">update table set ? where ?;</span><br><span class="line">delete from table where ?;</span><br></pre></td></tr></table></figure></p>
<p>æ‰€æœ‰ä»¥ä¸Šçš„è¯­å¥ï¼Œéƒ½å±äºå½“å‰è¯»ï¼Œè¯»å–è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ã€‚å¹¶ä¸”ï¼Œè¯»å–ä¹‹åï¼Œè¿˜éœ€è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œå¯¹è¯»å–è®°å½•åŠ é”ã€‚å…¶ä¸­ï¼Œé™¤äº†ç¬¬ä¸€æ¡è¯­å¥ï¼Œå¯¹è¯»å–è®°å½•åŠ Sé” (å…±äº«é”)å¤–ï¼Œå…¶ä»–çš„æ“ä½œï¼Œéƒ½åŠ çš„æ˜¯Xé” (æ’å®ƒé”)ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://juejin.im/post/5b9332685188255c432279aa" target="_blank" rel="noopener">https://juejin.im/post/5b9332685188255c432279aa</a><br><a href="https://www.cnblogs.com/chenpingzhao/p/5041968.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenpingzhao/p/5041968.html</a><br><a href="https://www.cnblogs.com/chenpingzhao/p/5065316.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenpingzhao/p/5065316.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ä¹è§‚é”ä¸æ‚²è§‚é”&quot;&gt;&lt;a href=&quot;#ä¹è§‚é”ä¸æ‚²è§‚é”&quot; class=&quot;headerlink&quot; title=&quot;ä¹è§‚é”ä¸æ‚²è§‚é”&quot;&gt;&lt;/a&gt;ä¹è§‚é”ä¸æ‚²è§‚é”&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;ä¹è§‚é”ï¼šæ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºå…¶ä»–äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œè€Œæ˜¯åœ¨æ›´æ–°çš„æ—¶å€™å»åˆ¤æ–­åœ¨æ­¤æœŸé—´æœ‰æ²¡æœ‰å…¶ä»–äººæ›´æ–°äº†æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶ã€‚åœ¨æ•°æ®åº“ä¸­å¯ä»¥é€šè¿‡ä¸ºæ•°æ®è¡¨å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·å­—æ®µå®ç°ã€‚è¯»å–æ•°æ®æ—¶å°†ç‰ˆæœ¬å·ä¸€åŒè¯»å‡ºï¼Œæ•°æ®æ¯æ¬¡æ›´æ–°æ—¶å¯¹ç‰ˆæœ¬å·åŠ ä¸€ã€‚å½“æˆ‘ä»¬æ›´æ–°çš„æ—¶å€™ï¼Œåˆ¤æ–­æ•°æ®åº“è¡¨å¯¹åº”è®°å½•çš„å½“å‰ç‰ˆæœ¬å·ä¸ç¬¬ä¸€æ¬¡å–å‡ºæ¥çš„ç‰ˆæœ¬å·å€¼è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœå€¼ç›¸ç­‰ï¼Œåˆ™äºˆä»¥æ›´æ–°ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯è¿‡æœŸæ•°æ®ã€‚ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œå¯ä»¥æé«˜ååé‡ã€‚&lt;/li&gt;
&lt;li&gt;æ‚²è§‚é”ï¼šæ¯æ¬¡è¯»æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨è¯»æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³è¯»è¿™ä¸ªæ•°æ®æ—¶å°±ä¼šè¢«é˜»å¡ã€‚MySQLä¸­å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨æ“ä½œä¹‹å‰å…ˆä¸Šé”ã€‚&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="mysql" scheme="http://idiotsky.top/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://idiotsky.top/tags/mysql/"/>
    
      <category term="æ‚²è§‚é”" scheme="http://idiotsky.top/tags/%E6%82%B2%E8%A7%82%E9%94%81/"/>
    
      <category term="ä¹è§‚é”" scheme="http://idiotsky.top/tags/%E4%B9%90%E8%A7%82%E9%94%81/"/>
    
      <category term="å…±äº«é”" scheme="http://idiotsky.top/tags/%E5%85%B1%E4%BA%AB%E9%94%81/"/>
    
      <category term="æ’ä»–é”" scheme="http://idiotsky.top/tags/%E6%8E%92%E4%BB%96%E9%94%81/"/>
    
      <category term="é—´éš™é”" scheme="http://idiotsky.top/tags/%E9%97%B4%E9%9A%99%E9%94%81/"/>
    
      <category term="æ„å‘é”" scheme="http://idiotsky.top/tags/%E6%84%8F%E5%90%91%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>epollçš„ETå’ŒLTä¸¾ä¾‹</title>
    <link href="http://idiotsky.top/2018/08/14/epoll-et-lt/"/>
    <id>http://idiotsky.top/2018/08/14/epoll-et-lt/</id>
    <published>2018-08-14T13:30:07.000Z</published>
    <updated>2018-08-16T13:27:15.541Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ET"><a href="#ET" class="headerlink" title="ET"></a>ET</h1><p>Edge Triggered (ET) è¾¹ç¼˜è§¦å‘åªæœ‰æ•°æ®åˆ°æ¥,æ‰è§¦å‘,ä¸ç®¡ç¼“å­˜åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®ã€‚</p>
<p>LT(level triggered)æ˜¯ç¼ºçœçš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒblock(é˜»å¡)å’Œno-block(éé˜»å¡) socket.åœ¨è¿™ç§åšæ³•ä¸­ï¼Œå†…æ ¸å‘Šè¯‰ä½ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªäº†ï¼Œç„¶åä½ å¯ä»¥å¯¹è¿™ä¸ªå°±ç»ªçš„fdè¿›è¡ŒIOæ“ä½œã€‚å¦‚æœä½ ä¸ä½œä»»ä½•æ“ä½œï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­é€šçŸ¥ä½ çš„ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ¨¡å¼ç¼–ç¨‹å‡ºé”™è¯¯å¯èƒ½æ€§è¦å°ä¸€ç‚¹ã€‚ä¼ ç»Ÿçš„select/polléƒ½æ˜¯è¿™ç§æ¨¡å‹çš„ä»£è¡¨ï¼</p>
<p>ä¼˜ç‚¹ï¼šå½“è¿›è¡Œsocketé€šä¿¡çš„æ—¶å€™ï¼Œä¿è¯äº†æ•°æ®çš„å®Œæ•´è¾“å‡ºï¼Œè¿›è¡ŒIOæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœè¿˜æœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´çš„é€šçŸ¥ä½ ã€‚</p>
<p>ç¼ºç‚¹ï¼šç”±äºåªè¦è¿˜æœ‰æ•°æ®ï¼Œå†…æ ¸å°±ä¼šä¸åœçš„ä»å†…æ ¸ç©ºé—´è½¬åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæ‰€æœ‰å ç”¨äº†å¤§é‡å†…æ ¸èµ„æºï¼Œè¯•æƒ³ä¸€ä¸‹å½“æœ‰å¤§é‡æ•°æ®åˆ°æ¥çš„æ—¶å€™ï¼Œæ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±ä¼šä¸åœçš„è¿›è¡Œåˆ‡æ¢ã€‚å†…æ ¸èµ„æºçš„æµªè´¹ä¸¥é‡ã€‚æ•ˆç‡æ¥è®²ä¹Ÿæ˜¯å¾ˆä½çš„ã€‚</p>
<h1 id="LT"><a href="#LT" class="headerlink" title="LT"></a>LT</h1><p>Level Triggered (LT) æ°´å¹³è§¦å‘åªè¦æœ‰æ•°æ®éƒ½ä¼šè§¦å‘ã€‚</p>
<p>ET(edge-triggered)æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒno-block socketã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰ä½ ã€‚ç„¶åå®ƒä¼šå‡è®¾ä½ çŸ¥é“æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œå¹¶ä¸”ä¸ä¼šå†ä¸ºé‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦å‘é€æ›´å¤šçš„å°±ç»ªé€šçŸ¥ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä¸€ç›´ä¸å¯¹è¿™ä¸ªfdä½œIOæ“ä½œ(ä»è€Œå¯¼è‡´å®ƒå†æ¬¡å˜æˆæœªå°±ç»ª)ï¼Œå†…æ ¸ä¸ä¼šå‘é€æ›´å¤šçš„é€šçŸ¥(only once).</p>
<p>ä¼˜ç‚¹ï¼šæ¯æ¬¡å†…æ ¸åªä¼šé€šçŸ¥ä¸€æ¬¡ï¼Œå¤§å¤§å‡å°‘äº†å†…æ ¸èµ„æºçš„æµªè´¹ï¼Œæé«˜æ•ˆç‡ã€‚</p>
<p>ç¼ºç‚¹ï¼šä¸èƒ½ä¿è¯æ•°æ®çš„å®Œæ•´ã€‚ä¸èƒ½åŠæ—¶çš„å–å‡ºæ‰€æœ‰çš„æ•°æ®ã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼š å¤„ç†å¤§æ•°æ®ã€‚ä½¿ç”¨non-block(éé˜»å¡)æ¨¡å¼çš„socketã€‚</p>
<a id="more"></a>
<h1 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h1><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä»£ç ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡è¾“å‡º10ä¸ªå­—èŠ‚ï¼Œç„¶åä¼‘çœ 5ç§’ï¼ŒæœåŠ¡å™¨ä¼šåˆ†åˆ«ä½¿ç”¨LTå’ŒETæ¥å±•ç¤ºä»–ä»¬çš„ä¸åŒã€‚</p>
<p>å®¢æˆ·ç«¯ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE  10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PROT 8000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">seraddr</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="keyword">int</span> connfd, i;</span><br><span class="line">    <span class="keyword">char</span> ch = <span class="string">'a'</span>;</span><br><span class="line">    connfd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line">    bzero(&amp;seraddr,<span class="keyword">sizeof</span>(seraddr));</span><br><span class="line">    seraddr.sin_family = AF_INET;</span><br><span class="line">    seraddr.sin_port = htons(SERV_PROT);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">s</span>;</span></span><br><span class="line">    inet_pton(AF_INET, <span class="string">"127.0.0.1"</span>, (<span class="keyword">void</span> *)&amp;s);</span><br><span class="line">    seraddr.sin_addr=s;</span><br><span class="line">    connect(connfd, (struct sockaddr *)&amp;seraddr, <span class="keyword">sizeof</span>(seraddr));</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i &lt; MAXLINE/<span class="number">2</span>;i++)&#123;</span><br><span class="line">            buf[i] = ch;</span><br><span class="line">        &#125;</span><br><span class="line">        buf[i<span class="number">-1</span>] = <span class="string">'\n'</span>;</span><br><span class="line">        ch++;</span><br><span class="line">        <span class="keyword">for</span>(;i&lt;MAXLINE;i++)</span><br><span class="line">            buf[i] = ch;</span><br><span class="line">        buf[i<span class="number">-1</span>] = <span class="string">'\n'</span>;</span><br><span class="line">        ch++;</span><br><span class="line">        write(connfd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(connfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡ç«¯ä»£ç ï¼ˆLTï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 8000</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>, <span class="title">cliaddr</span>;</span></span><br><span class="line"> <span class="keyword">socklen_t</span> cliaddr_len;</span><br><span class="line"> <span class="keyword">int</span> listenfd, connfd;</span><br><span class="line"> <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line"> <span class="keyword">char</span> str[INET_ADDRSTRLEN];</span><br><span class="line"> <span class="keyword">int</span> i, efd;</span><br><span class="line"> listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"> bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line"> servaddr.sin_family = AF_INET;</span><br><span class="line"> servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"> servaddr.sin_port = htons(SERV_PORT);</span><br><span class="line"> bind(listenfd, (struct sockaddr *)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line"> listen(listenfd, <span class="number">20</span>);</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">resevent</span>[10];</span></span><br><span class="line"> <span class="keyword">int</span> res, len;</span><br><span class="line"> efd = epoll_create(<span class="number">10</span>);</span><br><span class="line"> event.events = EPOLLIN;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"Accepting connections ...\n"</span>);</span><br><span class="line"> cliaddr_len = <span class="keyword">sizeof</span>(cliaddr);</span><br><span class="line"> connfd = accept(listenfd, (struct sockaddr *)&amp;cliaddr, &amp;cliaddr_len);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"received from %s at PORT %d\n"</span>,</span><br><span class="line"> inet_ntop(AF_INET, &amp;cliaddr.sin_addr, str, <span class="keyword">sizeof</span>(str)),</span><br><span class="line"> ntohs(cliaddr.sin_port));</span><br><span class="line"> event.data.fd = connfd;</span><br><span class="line"> epoll_ctl(efd, EPOLL_CTL_ADD, connfd, &amp;event);</span><br><span class="line"> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  res = epoll_wait(efd, resevent, <span class="number">10</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (resevent[<span class="number">0</span>].data.fd == connfd) &#123;</span><br><span class="line">  len = read(connfd, buf, MAXLINE/<span class="number">2</span>);</span><br><span class="line">  write(STDOUT_FILENO, buf, len);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./server</span><br><span class="line">Accepting connections ...</span><br><span class="line">received from 127.0.0.1 at PORT 40580</span><br><span class="line">aaaa</span><br><span class="line">bbbb</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">cccc</span><br><span class="line">dddd</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line"># ä»¥ä¸‹è¾“å‡ºçœç•¥</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¾“å‡ºç¬¦åˆé¢„æœŸ</p>
<p>æ¥ä¸‹é‡ŒæŠŠæœåŠ¡å™¨æ”¹æˆETæ¨¡å¼ä¼šæ€ä¹ˆæ ·å‘¢ï¼Œä¸‹é¢æ˜¯è¦ä¿®æ”¹çš„åœ°æ–¹</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">32c32</span><br><span class="line">&lt;  event.events = EPOLLIN;</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt; event.events = EPOLLIN|EPOLLET;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./server</span><br><span class="line">Accepting connections ...</span><br><span class="line">received from 127.0.0.1 at PORT 40580</span><br><span class="line">aaaa</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">bbbb</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">cccc</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">dddd</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line"># ä»¥ä¸‹è¾“å‡ºçœç•¥</span><br></pre></td></tr></table></figure>
<p>é—®é¢˜æ¥äº†ï¼Œè¾“å‡ºçš„ä¸œè¥¿æ¯”ETçš„æ—¶å€™æ…¢äº†åŠæ‹äº†ï¼ŒåŸå› åœ¨äºä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  res = epoll_wait(efd, resevent, <span class="number">10</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (resevent[<span class="number">0</span>].data.fd == connfd) &#123;</span><br><span class="line">  len = read(connfd, buf, MAXLINE/<span class="number">2</span>);</span><br><span class="line">  write(STDOUT_FILENO, buf, len);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><code>read</code>å‡½æ•°åªå–5ä¸ªå­—èŠ‚ï¼Œä¹‹åå°±æ²¡æœ‰è¾“å‡ºäº†ï¼Œç­‰å®¢æˆ·ç«¯ä¸‹æ¬¡æ¥æ•°æ®çš„æ—¶å€™å†æ¬¡è§¦å‘ä¸‹5ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯ETæ¨¡å¼çš„æ­£å¸¸è¡¨ç°å½¢å¼ï¼Œè€ŒLTä¼šåœ¨ä¸‹æ¬¡å¾ªç¯çš„æ—¶å€™ï¼Œä¼šå†æ¬¡è§¦å‘å¯è¯»ï¼Œç„¶å<code>epoll_wait</code>è¿”å›ï¼Œæ¥ä¸‹æ¥ç»§ç»­æŠŠå‰©ä¸‹5ä¸ªå­—èŠ‚è¯»å…¥ã€‚</p>
<p>é‚£æ¥ä¸‹æ¥ä¿®æ”¹ETæ¨¡å¼</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">9a10</span><br><span class="line">&gt; #include &lt;fcntl.h&gt;</span><br><span class="line">38a40,42</span><br><span class="line">&gt; int flag=fcntl(connfd,F_GETFL);</span><br><span class="line">&gt; flag|=O_NONBLOCK;</span><br><span class="line">&gt; fcntl(connfd,F_SETFL,flag);</span><br><span class="line">44,45c48,50</span><br><span class="line">&lt;   len = read(connfd, buf, MAXLINE/2);</span><br><span class="line">&lt;   write(STDOUT_FILENO, buf, len);</span><br><span class="line"><span class="comment">---</span></span><br><span class="line">&gt;   while ((len = read(connfd, buf, MAXLINE/2)) &gt;0 )</span><br><span class="line">&gt;         write(STDOUT_FILENO, buf, len);</span><br><span class="line">&gt;    &#125;</span><br><span class="line">47d51</span><br><span class="line">&lt; &#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./server</span><br><span class="line">Accepting connections ...</span><br><span class="line">received from 127.0.0.1 at PORT 40580</span><br><span class="line">aaaa</span><br><span class="line">bbbb</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line">cccc</span><br><span class="line">dddd</span><br><span class="line"># ç­‰5ç§’</span><br><span class="line"># ä»¥ä¸‹è¾“å‡ºçœç•¥</span><br></pre></td></tr></table></figure>
<p>æ­£å¸¸äº†ï¼Œä¸Šé¢ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p>
<ul>
<li>æŠŠå¥—æ¥å­—æè¿°ç¬¦æ”¹æˆéé˜»å¡</li>
<li>å¾ªç¯è¯»å‡ºæ‰€æœ‰æ•°æ®</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆETæ¨¡å¼åªèƒ½ç”¨åœ¨éé˜»å¡çš„å¥—æ¥å­—å‘¢ï¼Œé€šè¿‡ä¸Šé¢ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯é˜»å¡çš„è¯ï¼Œåœ¨è¯»å‡º10ä¸ªå­—èŠ‚ä¹‹åï¼Œå¾ªç¯è¿˜ä¼šç»§ç»­ï¼Œ<code>read</code>å‡½æ•°ä¼šé˜»å¡ç›´åˆ°ä¸‹æ¬¡æ•°æ®åˆ°æ¥ï¼Œè¿™æ ·çš„è¯ï¼Œå¦‚æœæ˜¯å¤šè¿æ¥çš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¿æ¥çš„æ•°æ®éƒ½ä¼šé˜»å¡åœ¨è¿™ä¸ªè¿æ¥çš„<code>read</code>å‡½æ•°é‡Œé¢äº†ï¼Œæ‰€ä»¥ETæ¨¡å¼åªæ”¯æŒéé˜»å¡æ˜¯æœ‰é“ç†çš„ã€‚</strong></p>
<h1 id="å®éªŒä»£ç "><a href="#å®éªŒä»£ç " class="headerlink" title="å®éªŒä»£ç "></a>å®éªŒä»£ç </h1><p>æ‰€æœ‰ä»£ç åœ¨è¿™ä¸ª<a href="https://github.com/ejunjsh/c-code/tree/master/epoll" target="_blank" rel="noopener">é“¾æ¥</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ET&quot;&gt;&lt;a href=&quot;#ET&quot; class=&quot;headerlink&quot; title=&quot;ET&quot;&gt;&lt;/a&gt;ET&lt;/h1&gt;&lt;p&gt;Edge Triggered (ET) è¾¹ç¼˜è§¦å‘åªæœ‰æ•°æ®åˆ°æ¥,æ‰è§¦å‘,ä¸ç®¡ç¼“å­˜åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;LT(level triggered)æ˜¯ç¼ºçœçš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒblock(é˜»å¡)å’Œno-block(éé˜»å¡) socket.åœ¨è¿™ç§åšæ³•ä¸­ï¼Œå†…æ ¸å‘Šè¯‰ä½ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªäº†ï¼Œç„¶åä½ å¯ä»¥å¯¹è¿™ä¸ªå°±ç»ªçš„fdè¿›è¡ŒIOæ“ä½œã€‚å¦‚æœä½ ä¸ä½œä»»ä½•æ“ä½œï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­é€šçŸ¥ä½ çš„ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ¨¡å¼ç¼–ç¨‹å‡ºé”™è¯¯å¯èƒ½æ€§è¦å°ä¸€ç‚¹ã€‚ä¼ ç»Ÿçš„select/polléƒ½æ˜¯è¿™ç§æ¨¡å‹çš„ä»£è¡¨ï¼&lt;/p&gt;
&lt;p&gt;ä¼˜ç‚¹ï¼šå½“è¿›è¡Œsocketé€šä¿¡çš„æ—¶å€™ï¼Œä¿è¯äº†æ•°æ®çš„å®Œæ•´è¾“å‡ºï¼Œè¿›è¡ŒIOæ“ä½œçš„æ—¶å€™ï¼Œå¦‚æœè¿˜æœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´çš„é€šçŸ¥ä½ ã€‚&lt;/p&gt;
&lt;p&gt;ç¼ºç‚¹ï¼šç”±äºåªè¦è¿˜æœ‰æ•°æ®ï¼Œå†…æ ¸å°±ä¼šä¸åœçš„ä»å†…æ ¸ç©ºé—´è½¬åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæ‰€æœ‰å ç”¨äº†å¤§é‡å†…æ ¸èµ„æºï¼Œè¯•æƒ³ä¸€ä¸‹å½“æœ‰å¤§é‡æ•°æ®åˆ°æ¥çš„æ—¶å€™ï¼Œæ¯æ¬¡è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±ä¼šä¸åœçš„è¿›è¡Œåˆ‡æ¢ã€‚å†…æ ¸èµ„æºçš„æµªè´¹ä¸¥é‡ã€‚æ•ˆç‡æ¥è®²ä¹Ÿæ˜¯å¾ˆä½çš„ã€‚&lt;/p&gt;
&lt;h1 id=&quot;LT&quot;&gt;&lt;a href=&quot;#LT&quot; class=&quot;headerlink&quot; title=&quot;LT&quot;&gt;&lt;/a&gt;LT&lt;/h1&gt;&lt;p&gt;Level Triggered (LT) æ°´å¹³è§¦å‘åªè¦æœ‰æ•°æ®éƒ½ä¼šè§¦å‘ã€‚&lt;/p&gt;
&lt;p&gt;ET(edge-triggered)æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒno-block socketã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰ä½ ã€‚ç„¶åå®ƒä¼šå‡è®¾ä½ çŸ¥é“æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œå¹¶ä¸”ä¸ä¼šå†ä¸ºé‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦å‘é€æ›´å¤šçš„å°±ç»ªé€šçŸ¥ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä¸€ç›´ä¸å¯¹è¿™ä¸ªfdä½œIOæ“ä½œ(ä»è€Œå¯¼è‡´å®ƒå†æ¬¡å˜æˆæœªå°±ç»ª)ï¼Œå†…æ ¸ä¸ä¼šå‘é€æ›´å¤šçš„é€šçŸ¥(only once).&lt;/p&gt;
&lt;p&gt;ä¼˜ç‚¹ï¼šæ¯æ¬¡å†…æ ¸åªä¼šé€šçŸ¥ä¸€æ¬¡ï¼Œå¤§å¤§å‡å°‘äº†å†…æ ¸èµ„æºçš„æµªè´¹ï¼Œæé«˜æ•ˆç‡ã€‚&lt;/p&gt;
&lt;p&gt;ç¼ºç‚¹ï¼šä¸èƒ½ä¿è¯æ•°æ®çš„å®Œæ•´ã€‚ä¸èƒ½åŠæ—¶çš„å–å‡ºæ‰€æœ‰çš„æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;åº”ç”¨åœºæ™¯ï¼š å¤„ç†å¤§æ•°æ®ã€‚ä½¿ç”¨non-block(éé˜»å¡)æ¨¡å¼çš„socketã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="c" scheme="http://idiotsky.top/categories/c/"/>
    
    
      <category term="epoll" scheme="http://idiotsky.top/tags/epoll/"/>
    
      <category term="c" scheme="http://idiotsky.top/tags/c/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥goä¹‹goroutine</title>
    <link href="http://idiotsky.top/2018/08/12/go-goroutine/"/>
    <id>http://idiotsky.top/2018/08/12/go-goroutine/</id>
    <published>2018-08-12T11:56:31.000Z</published>
    <updated>2018-08-12T13:25:03.801Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>goroutineæ˜¯goçš„æ ¸å¿ƒï¼Œæ²¡æœ‰goroutineï¼Œgoå°±æ²¡ä»€ä¹ˆæ„æ€äº†ğŸ‘¿ã€‚goroutineç¦»ä¸å¼€åç¨‹ï¼Œçº¿ç¨‹å’Œå¹¶å‘ï¼Œæ‰€ä»¥ä¸‹é¢ä¼šè¯´è¯´ç›¸å…³çš„å†…å®¹ã€‚</p>
</blockquote>
<h1 id="åç¨‹"><a href="#åç¨‹" class="headerlink" title="åç¨‹"></a>åç¨‹</h1><p>åç¨‹(coroutine)å…¶å®å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ–¹æ³•æˆ–è€…ä¾‹ç¨‹ï¼ˆroutineï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹å‡½æ•°éƒ½æ˜¯åœ¨ç”¨æˆ·çº¿ç¨‹ä¸‹é¢æ‰§è¡Œçš„ï¼Œçº¿ç¨‹çš„è°ƒåº¦ç”±å†…æ ¸è§¦å‘ï¼Œæ‰€ä»¥å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹æ²¡åŠæ³•æ§åˆ¶å‡½æ•°çš„æ‰§è¡Œè°ƒåº¦ï¼Œåªèƒ½ä»»ç”±å†…æ ¸ä¸»å®°ã€‚åç¨‹å°±ä¸åŒï¼Œå®ƒå¯ä»¥ç”±ç”¨æˆ·çº¿ç¨‹æ§åˆ¶è°ƒåº¦ï¼Œåœ¨ä»»ä½•æ—¶å€™è°ƒåº¦åç¨‹çš„æ‰§è¡Œã€‚å‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œå†…æ ¸è°ƒåº¦ä¼šé™·å…¥å†…æ ¸å¹¶ä¿å­˜å½“å‰çº¿ç¨‹çš„æ ˆå’Œä¸Šä¸‹æ–‡ï¼Œç„¶åæ¢å¤ä¹‹å‰è¢«åœæ­¢çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œä»£ä»·æ¯”è¾ƒé«˜ã€‚è€Œåç¨‹çš„è°ƒåº¦ï¼Œä¸ç”¨é™·å…¥å†…æ ¸ï¼Œç”¨æˆ·çº¿ç¨‹åªæ˜¯ä¿å­˜å½“å‰åç¨‹çš„æ ˆå’Œä¸Šä¸‹æ–‡ï¼Œæ¢å¤ä¹‹å‰çš„è¢«åœæ­¢åç¨‹ç»§ç»­æ‰§è¡Œã€‚</p>
<p>è¿˜æœ‰ç§è¯´æ³•æ˜¯è¯´å‡½æ•°æ˜¯åç¨‹çš„ä¸€ç§ç‰¹ä¾‹ã€‚å› ä¸ºå‡½æ•°åªæœ‰åœ¨returnè¯­å¥æ‰ä¼šè¿”å›ï¼Œè€Œåç¨‹å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»è¿”å›ã€‚</p>
<p>åç¨‹å¾ˆæ—©å°±æå‡ºæ¥äº†ï¼Œå¯æ˜¯åœ¨ç°åœ¨æ‰ç«èµ·æ¥å§ï¼Œå¤§æ¦‚ç”±äºæŸç§è¯­è¨€ï¼ˆluaï¼‰çš„å¹¿æ³›ä½¿ç”¨å§ã€‚è€Œgoæ›´æ˜¯æŠŠåç¨‹ç”¨åˆ°åº•ï¼ŒåŸºæœ¬å¯ä»¥ç†è§£goçš„æ‰€æœ‰ä»£ç éƒ½è·‘åœ¨åç¨‹ä¸‹ï¼Œå¹¶ç”¨goroutineæ¥ä»£è¡¨å®ƒè‡ªå·±çš„åç¨‹ã€‚<br><a id="more"></a></p>
<h1 id="åç¨‹-vs-çº¿ç¨‹"><a href="#åç¨‹-vs-çº¿ç¨‹" class="headerlink" title="åç¨‹ vs çº¿ç¨‹"></a>åç¨‹ vs çº¿ç¨‹</h1><p>çº¿ç¨‹æ˜¯å¤„ç†å™¨è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œåœ¨CPUåˆ‡åˆ†æ—¶é—´ç‰‡çš„å‰æä¸‹ï¼Œæ“ä½œç³»ç»Ÿè¿›è¡ŒæŠ¢å å¼è°ƒåº¦ã€‚</p>
<p>åç¨‹ä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ç§æ›´å°çš„è°ƒåº¦åŸºæœ¬å•ä½ã€‚å®ƒç”±è¿è¡Œåœ¨ç”¨æˆ·çº¿ç¨‹çš„è°ƒåº¦å™¨æ¥è°ƒåº¦ã€‚</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>è°ƒåº¦</th>
<th>å†…å­˜æ¶ˆè€—</th>
<th>åˆ‡æ¢ä»£ä»·</th>
</tr>
</thead>
<tbody>
<tr>
<td>çº¿ç¨‹</td>
<td>å†…æ ¸è¿›è¡Œè°ƒåº¦</td>
<td>è¾ƒå¤§ï¼ˆ1MB~8MBï¼‰</td>
<td>é™·å…¥å†…æ ¸ï¼Œå„ç§å¯„å­˜å™¨çš„ä¿å­˜å’Œåˆ·æ–°</td>
</tr>
<tr>
<td>åç¨‹</td>
<td>ç”¨æˆ·çº¿ç¨‹è°ƒåº¦</td>
<td>è¾ƒå°ï¼ˆ2KB~5KBï¼‰</td>
<td>å„ç§å¯„å­˜å™¨çš„ä¿å­˜å’Œåˆ·æ–°</td>
</tr>
</tbody>
</table>
<p>ä»ä¸Šè¡¨å¯ä»¥å‘ç°ï¼Œçº¿ç¨‹æ¯”åç¨‹æ›´åŠ è€—è´¹å†…å­˜ï¼Œè€Œä¸”è¿˜ä¼šé€ æˆé™·å…¥å†…æ ¸ã€‚ä½†æ˜¯åç¨‹çš„åˆ‡æ¢å®Œå…¨äº¤ç»™ç”¨æˆ·çº¿ç¨‹æ¥è°ƒåº¦ï¼Œè¿™ä¸ªå¢åŠ äº†å®ç°çš„éš¾åº¦ã€‚è¿˜æœ‰å°±æ˜¯åç¨‹çš„è°ƒåº¦æ˜¯ç”±å•ä¸ªçº¿ç¨‹è°ƒåº¦ï¼Œå¦‚æœå¤„ç†å™¨æ˜¯å¤šæ ¸çš„è¯ï¼Œæ²¡åŠæ³•å……åˆ†åˆ©ç”¨ã€‚å¾ˆåº†å¹¸çš„æ˜¯ï¼Œgoå·²ç»å®ç°äº†å®ƒè‡ªå·±çš„åç¨‹è°ƒåº¦é€»è¾‘ï¼Œå¹¶ä¸”å……åˆ†åˆ©ç”¨å¤šçº¿ç¨‹æ¥è°ƒåº¦goroutineã€‚</p>
<h1 id="è¦åç¨‹ä½•ç”¨ï¼Ÿ"><a href="#è¦åç¨‹ä½•ç”¨ï¼Ÿ" class="headerlink" title="è¦åç¨‹ä½•ç”¨ï¼Ÿ"></a>è¦åç¨‹ä½•ç”¨ï¼Ÿ</h1><p>åç¨‹èƒ½ç«ä¹Ÿæ˜¯æœ‰å„ç§ç†ç”±çš„ã€‚</p>
<ul>
<li>é«˜å¹¶å‘å¤„ç†ã€‚åœ¨ç”¨æˆ·ç©ºé—´åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œä¸ç”¨é™·å…¥å†…æ ¸æ¥åšçº¿ç¨‹åˆ‡æ¢ï¼Œé¿å…ä¸å¿…è¦ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®æ‹·è´ã€‚</li>
<li>ç”¨åŒæ­¥çš„æ–¹å¼å»å†™å¼‚æ­¥ä»£ç ï¼Œé«˜æ•ˆç‡ä¸”ä¸å®¹æ˜“å‡ºé”™ (nodejsé‡Œé¢çš„asyn/awaitï¼Œå°±æ˜¯è¿™ç§)</li>
<li>éæŠ¢å å¼æ¨¡å‹ï¼Œèƒ½æ§åˆ¶ä¸­æ–­ä½ç½®ï¼Œä¸ä¼šå‘ç”Ÿç”±äºå¼ºè¡Œåˆ‡æ¢çº¿ç¨‹å¯¼è‡´çš„èµ„æºç«äº‰ã€‚(æç«¯æƒ…å†µä¸‹è¿˜æ˜¯ä¼šæ‰§è¡ŒæŠ¢å ï¼Œé˜²æ­¢åç¨‹é•¿æ—¶é—´å ç”¨CPUï¼Œä½†è¿™ä¸æ˜¯æ ‡å‡†æŠ¢å å¼æ¨¡å‹ï¼‰</li>
</ul>
<h1 id="å¹¶å‘-VS-å¹¶è¡Œ"><a href="#å¹¶å‘-VS-å¹¶è¡Œ" class="headerlink" title="å¹¶å‘ VS å¹¶è¡Œ"></a>å¹¶å‘ VS å¹¶è¡Œ</h1><p>å…ˆä¸Šå›¾ï¼š</p>
<p><a href="http://idiotsky.top/images2/go-goroutine.jpg"><img src="http://idiotsky.top/images2/go-goroutine.jpg" alt=""></a></p>
<ul>
<li>å¹¶å‘ï¼šå¤„ç†å™¨è¢«åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªæ—¶é—´åˆ†ç‰‡ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨å¤„ç†å™¨ä¸­äº¤æ›¿æ‰§è¡Œï¼ŒåŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«æ‰§è¡Œï¼ˆé€šç”¨åœ°æ¥è¯´ï¼Œæ”¯æŒå¹¶å‘æ˜¯ä¸€ç§ç³»ç»Ÿæ‹¥æœ‰äº¤æ›¿æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„èƒ½åŠ›çš„è¡¨ç°ï¼‰</li>
<li>å¹¶è¡Œï¼šå¤šä¸ªçº¿ç¨‹ï¼Œåœ¨å¤šä¸ªå¤„ç†å™¨ä¸ŠåŒæ—¶æ‰§è¡Œã€‚</li>
</ul>
<blockquote>
<p>ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼ŒåŒ»é™¢è¯Šå®¤çœ‹ç—…ã€‚æŠŠç—…äººå½“åšçº¿ç¨‹ï¼ŒåŒ»ç”Ÿå½“åšå¤„ç†å™¨ã€‚</p>
</blockquote>
<blockquote>
<p>å¹¶å‘ï¼šåªæœ‰ä¸€ä¸ªåŒ»ç”Ÿï¼Œç—…äººAçœ‹äº†ä¸€ä¼šå„¿ï¼ŒåŒ»ç”Ÿè®©ä»–ä¸‹æ¥¼æ‹Xå…‰ï¼Œç„¶åç—…äººBè¿›æ¥çœ‹è¯Šï¼Œä¹‹ååŒ»ç”Ÿè®©Bå»åšå½©è¶…ï¼Œç„¶åAæ­¤æ—¶å›æ¥äº†ï¼ŒåŒ»ç”Ÿç»§ç»­ç»™Açœ‹ç—…ã€‚ï¼ˆä»»æ„ç¬é—´ï¼ŒåŒ»ç”Ÿåªåœ¨ç»™å…¶ä¸­ä¸€ä¸ªäººçœ‹ç—…ï¼‰</p>
</blockquote>
<blockquote>
<p>å¹¶è¡Œï¼š æœ‰3ä¸ªåŒ»ç”Ÿï¼Œ3ä¸ªç—…äººï¼Œä¸€ä¸ªç—…äººå¯¹åº”ä¸€ä¸ªåŒ»ç”Ÿï¼ŒåŒæ—¶é—®è¯Šã€‚</p>
</blockquote>
<p>å¦‚æœå¹¶å‘äº¤æ›¿çš„é€Ÿåº¦å¤Ÿå¿«ï¼Œå°±èƒ½è¾¾åˆ°â€œé€»è¾‘å¹¶è¡Œâ€çš„æ•ˆæœï¼Œå¯¹å¤–çœ‹èµ·æ¥å°±å’Œå¹¶è¡Œä¸€æ ·ã€‚</p>
<p>å¹¶å‘æ‰§è¡Œå¤šçº¿ç¨‹å¹¶ä¸èƒ½çœŸçš„å……åˆ†åˆ©ç”¨CPUï¼Œè¾¾åˆ°å‡å°‘å•ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶é—´çš„æ•ˆæœï¼Œè¿™ç§äº¤æ›¿æŒ‚èµ·æ‰§è¡Œçš„æ–¹å¼å´èƒ½å¤Ÿç»™ç”¨æˆ·å¸¦æ¥æ¯ä¸ªçº¿ç¨‹éƒ½åœ¨â€åŒæ—¶æ‰§è¡Œâ€œçš„æ„Ÿè§‰ï¼Œä»è€Œå¢å¼ºäº†æœåŠ¡çš„å“åº”é€Ÿåº¦ã€‚å°±åƒä¸Šé¢ä¾‹å­ä¸­çš„ç—…äººBä¸ç”¨ä¸€ç›´æ’é˜Ÿç­‰å¾… Aæ‹å®ŒXå…‰å¹¶ä¸”åŒ»ç”Ÿç¡®å®šAçš„ç—…çœ‹å®Œäº† æ‰èƒ½å»çœ‹ç—…ã€‚</p>
<h1 id="è°ƒåº¦"><a href="#è°ƒåº¦" class="headerlink" title="è°ƒåº¦"></a>è°ƒåº¦</h1><p>goroutineçš„è°ƒåº¦å¯ä»¥ç†è§£ä¸ºå¤šçº¿ç¨‹è°ƒåº¦åç¨‹ï¼ˆgoroutineï¼‰ã€‚æ‰€ä»¥è¿™é‡Œè°ƒåº¦ä¼šæœ‰ä¸‰ä¸ªè§’è‰²ï¼šçº¿ç¨‹ï¼Œè°ƒåº¦å™¨ï¼Œåç¨‹ã€‚å®ƒä»¬åˆ†åˆ«ç”¨M,P,Gæ¥è¡¨ç¤ºå§ã€‚</p>
<p><a href="http://idiotsky.top/images2/go-goroutine-1.jpg"><img src="http://idiotsky.top/images2/go-goroutine-1.jpg" alt=""></a></p>
<ul>
<li>G: è¡¨ç¤ºgoroutineï¼Œå­˜å‚¨äº†goroutineçš„æ‰§è¡Œstackä¿¡æ¯ã€goroutineçŠ¶æ€ä»¥åŠgoroutineçš„ä»»åŠ¡å‡½æ•°ç­‰ï¼›å¦å¤–Gå¯¹è±¡æ˜¯å¯ä»¥é‡ç”¨çš„ã€‚</li>
<li>P: è¡¨ç¤ºé€»è¾‘processorï¼ŒPçš„æ•°é‡å†³å®šäº†ç³»ç»Ÿå†…æœ€å¤§å¯å¹¶è¡Œçš„Gçš„æ•°é‡ï¼ˆå‰æï¼šç³»ç»Ÿçš„ç‰©ç†cpuæ ¸æ•°&gt;=Pçš„æ•°é‡ï¼ŒGOMAXPROCSç¯å¢ƒå˜é‡ä»£è¡¨çš„ä¸ªæ•°æ˜¯Pçš„ä¸ªæ•°ï¼Œæ¨èå€¼ä¸ºCPUçš„æ ¸å¿ƒæ•°ï¼‰ï¼›Pçš„æœ€å¤§ä½œç”¨è¿˜æ˜¯å…¶æ‹¥æœ‰çš„å„ç§Gå¯¹è±¡é˜Ÿåˆ—ã€é“¾è¡¨ã€ä¸€äº›cacheå’ŒçŠ¶æ€ã€‚</li>
<li>M: Mä»£è¡¨ç€çœŸæ­£çš„æ‰§è¡Œè®¡ç®—èµ„æºã€‚åœ¨ç»‘å®šæœ‰æ•ˆçš„påï¼Œè¿›å…¥scheduleå¾ªç¯ï¼›è€Œscheduleå¾ªç¯çš„æœºåˆ¶å¤§è‡´æ˜¯ä»å„ç§é˜Ÿåˆ—ã€pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–Gï¼Œåˆ‡æ¢åˆ°Gçš„æ‰§è¡Œæ ˆä¸Šå¹¶æ‰§è¡ŒGçš„å‡½æ•°ï¼Œè°ƒç”¨goexitåšæ¸…ç†å·¥ä½œå¹¶å›åˆ°mï¼Œå¦‚æ­¤åå¤ã€‚Må¹¶ä¸ä¿ç•™GçŠ¶æ€ï¼Œè¿™æ˜¯Gå¯ä»¥è·¨Mè°ƒåº¦çš„åŸºç¡€ã€‚</li>
</ul>
<p><strong>ä¸‹é¢æ˜¯Gã€Pã€Må®šä¹‰çš„ä»£ç ç‰‡æ®µï¼š</strong><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/runtime/runtime2.go</span></span><br><span class="line"><span class="keyword">type</span> g <span class="keyword">struct</span> &#123;</span><br><span class="line">        stack      stack   <span class="comment">// offset known to runtime/cgo</span></span><br><span class="line">        sched     gobuf</span><br><span class="line">        goid        <span class="keyword">int64</span></span><br><span class="line">        gopc       <span class="keyword">uintptr</span> <span class="comment">// pc of go statement that created this goroutine</span></span><br><span class="line">        startpc    <span class="keyword">uintptr</span> <span class="comment">// pc of goroutine function</span></span><br><span class="line">        ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> p <span class="keyword">struct</span> &#123;</span><br><span class="line">    lock mutex</span><br><span class="line"></span><br><span class="line">    id          <span class="keyword">int32</span></span><br><span class="line">    status      <span class="keyword">uint32</span> <span class="comment">// one of pidle/prunning/...</span></span><br><span class="line"></span><br><span class="line">    mcache      *mcache</span><br><span class="line">    racectx     <span class="keyword">uintptr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queue of runnable goroutines. Accessed without lock.</span></span><br><span class="line">    runqhead <span class="keyword">uint32</span></span><br><span class="line">    runqtail <span class="keyword">uint32</span></span><br><span class="line">    runq     [<span class="number">256</span>]guintptr</span><br><span class="line"></span><br><span class="line">    runnext guintptr</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Available G's (status == Gdead)</span></span><br><span class="line">    gfree    *g</span><br><span class="line">    gfreecnt <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> m <span class="keyword">struct</span> &#123;</span><br><span class="line">    g0      *g     <span class="comment">// goroutine with scheduling stack</span></span><br><span class="line">    mstartfn      <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="title">curg</span>          *<span class="title">g</span>       // <span class="title">current</span> <span class="title">running</span> <span class="title">goroutine</span></span></span><br><span class="line"><span class="function"> .... ..</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><a href="http://idiotsky.top/images2/go-goroutine-2.jpg"><img src="http://idiotsky.top/images2/go-goroutine-2.jpg" alt=""></a></p>
<p>ä¸Šå›¾æ˜¯2ä¸ªMï¼ˆçº¿ç¨‹ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªå¤„ç†å™¨ï¼ˆPï¼‰ï¼ŒMæ˜¯å¿…é¡»å…³è”Pæ‰èƒ½æ‰§è¡Œåç¨‹ï¼ˆGï¼‰çš„ã€‚å›¾ä¸­è“Gä»£è¡¨çš„æ˜¯è¿è¡Œä¸­çš„goroutineï¼Œç°Gè¡¨ç¤ºçš„å¾…æ‰§è¡Œçš„Goroutineï¼Œå¾…æ‰§è¡Œçš„Goroutineå­˜å‚¨åœ¨ P ä¸­çš„ä¸€ä¸ªå±€éƒ¨é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶Pæ‰§è¡ŒGoroutineä¼šè¿™ä¸ªé˜Ÿåˆ—ä¸­å–ï¼Œä¸ç”¨åŠ é”ï¼Œæé«˜äº†å¹¶å‘åº¦ã€‚ï¼ˆGo1.0ç‰ˆæœ¬ä¸­ï¼Œè°ƒåº¦å™¨å–Goroutineæ˜¯å»ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­å–ï¼Œéœ€è¦åŠ é”ï¼Œçº¿ç¨‹ä¼šç»å¸¸é˜»å¡ç­‰å¾…é”ï¼‰</p>
<p>ä¸‹é¢æ›´åŠ æ¸…æ™°è¯´æ˜æ•´ä¸ªç»“æ„</p>
<p><a href="http://idiotsky.top/images2/go-goroutine-5.png"><img src="http://idiotsky.top/images2/go-goroutine-5.png" alt=""></a></p>
<p><strong>å¦‚æœå…¶ä¸­ä¸€ä¸ªGæ‰§è¡Œçš„æ—¶å€™ï¼Œå‘ç”Ÿäº†ç³»ç»Ÿè°ƒç”¨ï¼Œé˜»å¡äº†æ€ä¹ˆåŠï¼Ÿ</strong></p>
<p><a href="http://idiotsky.top/images2/go-goroutine-3.jpg"><img src="http://idiotsky.top/images2/go-goroutine-3.jpg" alt=""></a></p>
<p>ä¸Šå›¾å·¦è¾¹ï¼ŒG0ä¸­é™·å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¼è‡´M0é˜»å¡ã€‚</p>
<p>æ­¤æ—¶ï¼ŒM0æ”¾å¼ƒäº†å®ƒçš„Pï¼Œè®©M1å»å¤„ç†Pä¸­å‰©ä¸‹çš„Goroutineã€‚è¿™é‡Œçš„M1å¯èƒ½æ˜¯åœ¨çº¿ç¨‹ç¼“å­˜ä¸­å–çš„ï¼Œæˆ–è€…è¿è¡Œä¸­ç”Ÿæˆçš„ã€‚</p>
<p>å½“M0ä»ç³»ç»Ÿè°ƒç”¨ä¸­æ¢å¤ï¼Œå®ƒä¼šå»åˆ«çš„Mä¸­æ‰¾Pæ¥æ‰§è¡ŒG0ï¼ˆæ¯”å¦‚è¯´åˆ«çš„Mé˜»å¡ä¸¢å‡ºäº†Pï¼‰ï¼Œå¦‚æœæ²¡æœ‰Pï¼Œé‚£ä¹ˆå®ƒä¼šæŠŠG0æ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æŠŠå®ƒè‡ªå·±æ”¾åˆ°çº¿ç¨‹ç¼“å­˜ä¸­ã€‚</p>
<p>å…¨å±€é˜Ÿåˆ—ä¿å­˜äº†Goroutineï¼Œå½“å„è‡ªPä¸­çš„å±€éƒ¨é˜Ÿåˆ—æ²¡æœ‰Goroutineæ—¶ï¼ŒPä¼šåˆ°å…¨å±€é˜Ÿåˆ—ä¸­å–Goroutineã€‚å¹¶ä¸”å³ä½¿Pä¸­å±€éƒ¨é˜Ÿåˆ—æœ‰Goroutineï¼Œä¹Ÿä¼šå‘¨æœŸæ€§åœ°ä»å…¨å±€é˜Ÿåˆ—ä¸­å–Goroutineï¼Œä¿æŒå…¨å±€é˜Ÿåˆ—ä¸­çš„Goroutineèƒ½å¤Ÿå°½å¿«è¢«æ‰§è¡Œã€‚</p>
<p>å¤„ç†ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿæ˜¯goç¨‹åºä¸ºä»€ä¹ˆè·‘åœ¨å¤šçº¿ç¨‹ä¸Šçš„ä¸€ä¸ªåŸå› ï¼Œå³ä½¿GOMAXPROCSæ˜¯1ï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰å¤šä¸ªå·¥ä½œçº¿ç¨‹ã€‚</p>
<p><strong>å½“På±€éƒ¨é˜Ÿåˆ—ä¸å‡è¡¡æ—¶æ€ä¹ˆå¤„ç†ï¼Ÿå¦‚æœæœ‰å¤šä¸ªPï¼Œå…¶ä¸­ä¸€ä¸ªPçš„å±€éƒ¨é˜Ÿåˆ—Goroutineæ‰§è¡Œå®Œäº†ã€‚</strong></p>
<p><a href="http://idiotsky.top/images2/go-goroutine-4.jpg"><img src="http://idiotsky.top/images2/go-goroutine-4.jpg" alt=""></a></p>
<p>å¦‚æœä¸€ä¸ªPå±€éƒ¨é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆå®ƒå°è¯•ä»å…¨å±€é˜Ÿåˆ—ä¸­å–Goroutineï¼Œå¦‚å…¨å±€é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ä¼šéšæœºä»å…¶å®ƒPçš„å±€éƒ¨é˜Ÿåˆ—ä¸­â€œæŒªâ€ä¸€åŠGoroutineåˆ°è‡ªå·±çš„é˜Ÿåˆ—å½“ä¸­ï¼Œ ä»¥ä¿è¯æ‰€æœ‰çš„Méƒ½æ˜¯æœ‰ä»»åŠ¡æ‰§è¡Œçš„ï¼Œé—´æ¥åšåˆ°è´Ÿè½½å‡è¡¡ï¼ˆå¯ä»¥å‚è€ƒgoæºç çš„findrunnable()å‡½æ•° ï¼‰</p>
<p><strong>channelé˜»å¡æ€ä¹ˆåŠ</strong></p>
<p>å¦‚æœGè¢«é˜»å¡åœ¨æŸä¸ªchannelæ“ä½œä¸Šæ—¶ï¼ŒGä¼šè¢«æ”¾ç½®åˆ°æŸä¸ªwaité˜Ÿåˆ—ä¸­ï¼Œè€ŒMä¼šå°è¯•è¿è¡Œä¸‹ä¸€ä¸ªrunnableçš„Gï¼›å¦‚æœæ­¤æ—¶æ²¡æœ‰runnableçš„Gä¾›mè¿è¡Œï¼Œé‚£ä¹ˆmå°†è§£ç»‘Pï¼Œå¹¶è¿›å…¥sleepçŠ¶æ€ã€‚å½“channelæ“ä½œå®Œæˆï¼Œåœ¨waité˜Ÿåˆ—ä¸­çš„Gä¼šè¢«å”¤é†’ï¼Œæ ‡è®°ä¸ºrunnableï¼Œæ”¾å…¥åˆ°æŸPçš„é˜Ÿåˆ—ä¸­ï¼Œç»‘å®šä¸€ä¸ªMç»§ç»­æ‰§è¡Œã€‚</p>
<p><strong>ç½‘ç»œI/Oå’Œæ–‡ä»¶I/Oæ€ä¹ˆåŠ</strong></p>
<p>Go runtimeå·²ç»å®ç°äº†<a href="http://morsmachine.dk/netpoller" target="_blank" rel="noopener">netpoller</a>ï¼Œè¿™ä½¿å¾—å³ä¾¿Gå‘èµ·ç½‘ç»œI/Oæ“ä½œä¹Ÿä¸ä¼šå¯¼è‡´Mè¢«é˜»å¡ï¼ˆä»…é˜»å¡Gï¼‰ï¼Œä»è€Œä¸ä¼šå¯¼è‡´å¤§é‡Mè¢«åˆ›å»ºå‡ºæ¥ã€‚ä½†æ˜¯å¯¹äºregular fileçš„I/Oæ“ä½œä¸€æ—¦é˜»å¡ï¼Œé‚£ä¹ˆMå°†è¿›å…¥sleepçŠ¶æ€ï¼Œç­‰å¾…I/Oè¿”å›åè¢«å”¤é†’ï¼›è¿™ç§æƒ…å†µä¸‹På°†ä¸sleepçš„Måˆ†ç¦»ï¼Œå†é€‰æ‹©ä¸€ä¸ªidleçš„Mã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰idleçš„Mï¼Œåˆ™ä¼šæ–°åˆ›å»ºä¸€ä¸ªMï¼Œè¿™å°±æ˜¯ä¸ºä½•å¤§é‡I/Oæ“ä½œå¯¼è‡´å¤§é‡Threadè¢«åˆ›å»ºçš„åŸå› ã€‚</p>
<p><strong>é‡åˆ°é”æ€ä¹ˆåŠ</strong></p>
<p>goçš„é”ä¸æ˜¯ç³»ç»Ÿçº§åˆ«çš„MUTEXé”ï¼Œè€Œæ˜¯è½»é‡çº§çš„CASé”ï¼Œæ‰€ä»¥æŠ¢é”å¤±è´¥ä¸ä¼šé˜»å¡Mï¼Œè€Œæ˜¯é˜»å¡G(é˜»å¡ä¹‹å‰è¿˜è‡ªæ—‹ä¸€ä¸‹çœ‹çœ‹èƒ½ä¸èƒ½å†æŠ¢åˆ°é”)ï¼Œç„¶åè¿™ä¸ªGå°±ä¼šè¢«æ­£å¸¸çš„è°ƒåº¦å‡ºå»ï¼Œåœ¨æŸä¸ªæ—¶åˆ»åˆè°ƒåº¦å›æ¥ç»§ç»­æŠ¢é”ã€‚</p>
<p><strong>å¦‚æœä¸€ä¸ªPè¿ç»­æ‰§è¡Œé•¿æ—¶é—´ï¼Œæ²¡æœ‰åˆ‡æ¢Gï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿ</strong></p>
<p>å’Œæ“ä½œç³»ç»ŸæŒ‰æ—¶é—´ç‰‡è°ƒåº¦çº¿ç¨‹ä¸åŒï¼ŒGoå¹¶æ²¡æœ‰æ—¶é—´ç‰‡çš„æ¦‚å¿µã€‚å¦‚æœæŸä¸ªGæ²¡æœ‰è¿›è¡Œsystem callè°ƒç”¨ã€æ²¡æœ‰è¿›è¡ŒI/Oæ“ä½œã€æ²¡æœ‰é˜»å¡åœ¨ä¸€ä¸ªchannelæ“ä½œä¸Šï¼Œé‚£ä¹ˆmæ˜¯å¦‚ä½•è®©Gåœä¸‹æ¥å¹¶è°ƒåº¦ä¸‹ä¸€ä¸ªrunnable Gçš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š<strong>Gæ˜¯è¢«æŠ¢å è°ƒåº¦çš„</strong>ã€‚</p>
<p>é™¤éæç«¯çš„æ— é™å¾ªç¯æˆ–æ­»å¾ªç¯ï¼Œå¦åˆ™åªè¦Gè°ƒç”¨å‡½æ•°ï¼ŒGo runtimeå°±æœ‰æŠ¢å Gçš„æœºä¼šã€‚Goç¨‹åºå¯åŠ¨æ—¶ï¼Œruntimeä¼šå»å¯åŠ¨ä¸€ä¸ªåä¸ºsysmonçš„m(ä¸€èˆ¬ç§°ä¸ºç›‘æ§çº¿ç¨‹)ï¼Œè¯¥mæ— éœ€ç»‘å®špå³å¯è¿è¡Œï¼Œè¯¥måœ¨æ•´ä¸ªGoç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­è‡³å…³é‡è¦ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$GOROOT/src/runtime/proc.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The main goroutine.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">     ... ...</span><br><span class="line">    systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        newm(sysmon, <span class="literal">nil</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Always runs without a P, so write barriers are not allowed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:nowritebarrierrec</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sysmon</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// If a heap span goes unused for 5 minutes after a garbage collection,</span></span><br><span class="line">    <span class="comment">// we hand it back to the operating system.</span></span><br><span class="line">    scavengelimit := <span class="keyword">int64</span>(<span class="number">5</span> * <span class="number">60</span> * <span class="number">1e9</span>)</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>  .... &#123;</span><br><span class="line">        ... ...</span><br><span class="line">        <span class="comment">// retake P's blocked in syscalls</span></span><br><span class="line">        <span class="comment">// and preempt long running G's</span></span><br><span class="line">        <span class="keyword">if</span> retake(now) != <span class="number">0</span> &#123;</span><br><span class="line">            idle = <span class="number">0</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            idle++</span><br><span class="line">        &#125;</span><br><span class="line">       ... ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sysmonæ¯20us~10mså¯åŠ¨ä¸€æ¬¡ï¼ŒæŒ‰ç…§ã€ŠGoè¯­è¨€å­¦ä¹ ç¬”è®°ã€‹ä¸­çš„æ€»ç»“ï¼Œsysmonä¸»è¦å®Œæˆå¦‚ä¸‹å·¥ä½œï¼š</p>
<ul>
<li>é‡Šæ”¾é—²ç½®è¶…è¿‡5åˆ†é’Ÿçš„spanç‰©ç†å†…å­˜ï¼›</li>
<li>å¦‚æœè¶…è¿‡2åˆ†é’Ÿæ²¡æœ‰åƒåœ¾å›æ”¶ï¼Œå¼ºåˆ¶æ‰§è¡Œï¼›</li>
<li>å°†é•¿æ—¶é—´æœªå¤„ç†çš„netpollç»“æœæ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼›</li>
<li>å‘é•¿æ—¶é—´è¿è¡Œçš„Gä»»åŠ¡å‘å‡ºæŠ¢å è°ƒåº¦ï¼›</li>
<li>æ”¶å›å› syscallé•¿æ—¶é—´é˜»å¡çš„Pï¼›</li>
</ul>
<p>æˆ‘ä»¬çœ‹åˆ°sysmonå°†â€œå‘é•¿æ—¶é—´è¿è¡Œçš„Gä»»åŠ¡å‘å‡ºæŠ¢å è°ƒåº¦â€ï¼Œè¿™ä¸ªäº‹æƒ…ç”±retakeå®æ–½ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// forcePreemptNS is the time slice given to a G before it is</span></span><br><span class="line"><span class="comment">// preempted.</span></span><br><span class="line"><span class="keyword">const</span> forcePreemptNS = <span class="number">10</span> * <span class="number">1000</span> * <span class="number">1000</span> <span class="comment">// 10ms</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">retake</span><span class="params">(now <span class="keyword">int64</span>)</span> <span class="title">uint32</span></span> &#123;</span><br><span class="line">          ... ...</span><br><span class="line">           <span class="comment">// Preempt G if it's running for too long.</span></span><br><span class="line">            t := <span class="keyword">int64</span>(_p_.schedtick)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">int64</span>(pd.schedtick) != t &#123;</span><br><span class="line">                pd.schedtick = <span class="keyword">uint32</span>(t)</span><br><span class="line">                pd.schedwhen = now</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> pd.schedwhen+forcePreemptNS &gt; now &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            preemptone(_p_)</span><br><span class="line">         ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸€ä¸ªGä»»åŠ¡è¿è¡Œ10msï¼Œsysmonå°±ä¼šè®¤ä¸ºå…¶è¿è¡Œæ—¶é—´å¤ªä¹…è€Œå‘å‡ºæŠ¢å å¼è°ƒåº¦çš„è¯·æ±‚ã€‚ä¸€æ—¦Gçš„æŠ¢å æ ‡å¿—ä½è¢«è®¾ä¸ºtrueï¼Œé‚£ä¹ˆå¾…è¿™ä¸ªGä¸‹ä¸€æ¬¡è°ƒç”¨å‡½æ•°æˆ–æ–¹æ³•æ—¶ï¼Œruntimeä¾¿å¯ä»¥å°†GæŠ¢å ï¼Œå¹¶ç§»å‡ºè¿è¡ŒçŠ¶æ€ï¼Œæ”¾å…¥Pä¸­å±€éƒ¨é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«è°ƒåº¦ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://zhuanlan.zhihu.com/p/32497435" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/32497435</a></p>
<p><a href="https://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/" target="_blank" rel="noopener">https://tonybai.com/2017/06/23/an-intro-about-goroutine-scheduler/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;goroutineæ˜¯goçš„æ ¸å¿ƒï¼Œæ²¡æœ‰goroutineï¼Œgoå°±æ²¡ä»€ä¹ˆæ„æ€äº†ğŸ‘¿ã€‚goroutineç¦»ä¸å¼€åç¨‹ï¼Œçº¿ç¨‹å’Œå¹¶å‘ï¼Œæ‰€ä»¥ä¸‹é¢ä¼šè¯´è¯´ç›¸å…³çš„å†…å®¹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;åç¨‹&quot;&gt;&lt;a href=&quot;#åç¨‹&quot; class=&quot;headerlink&quot; title=&quot;åç¨‹&quot;&gt;&lt;/a&gt;åç¨‹&lt;/h1&gt;&lt;p&gt;åç¨‹(coroutine)å…¶å®å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ–¹æ³•æˆ–è€…ä¾‹ç¨‹ï¼ˆroutineï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹å‡½æ•°éƒ½æ˜¯åœ¨ç”¨æˆ·çº¿ç¨‹ä¸‹é¢æ‰§è¡Œçš„ï¼Œçº¿ç¨‹çš„è°ƒåº¦ç”±å†…æ ¸è§¦å‘ï¼Œæ‰€ä»¥å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹æ²¡åŠæ³•æ§åˆ¶å‡½æ•°çš„æ‰§è¡Œè°ƒåº¦ï¼Œåªèƒ½ä»»ç”±å†…æ ¸ä¸»å®°ã€‚åç¨‹å°±ä¸åŒï¼Œå®ƒå¯ä»¥ç”±ç”¨æˆ·çº¿ç¨‹æ§åˆ¶è°ƒåº¦ï¼Œåœ¨ä»»ä½•æ—¶å€™è°ƒåº¦åç¨‹çš„æ‰§è¡Œã€‚å‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œå†…æ ¸è°ƒåº¦ä¼šé™·å…¥å†…æ ¸å¹¶ä¿å­˜å½“å‰çº¿ç¨‹çš„æ ˆå’Œä¸Šä¸‹æ–‡ï¼Œç„¶åæ¢å¤ä¹‹å‰è¢«åœæ­¢çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œä»£ä»·æ¯”è¾ƒé«˜ã€‚è€Œåç¨‹çš„è°ƒåº¦ï¼Œä¸ç”¨é™·å…¥å†…æ ¸ï¼Œç”¨æˆ·çº¿ç¨‹åªæ˜¯ä¿å­˜å½“å‰åç¨‹çš„æ ˆå’Œä¸Šä¸‹æ–‡ï¼Œæ¢å¤ä¹‹å‰çš„è¢«åœæ­¢åç¨‹ç»§ç»­æ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;è¿˜æœ‰ç§è¯´æ³•æ˜¯è¯´å‡½æ•°æ˜¯åç¨‹çš„ä¸€ç§ç‰¹ä¾‹ã€‚å› ä¸ºå‡½æ•°åªæœ‰åœ¨returnè¯­å¥æ‰ä¼šè¿”å›ï¼Œè€Œåç¨‹å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»è¿”å›ã€‚&lt;/p&gt;
&lt;p&gt;åç¨‹å¾ˆæ—©å°±æå‡ºæ¥äº†ï¼Œå¯æ˜¯åœ¨ç°åœ¨æ‰ç«èµ·æ¥å§ï¼Œå¤§æ¦‚ç”±äºæŸç§è¯­è¨€ï¼ˆluaï¼‰çš„å¹¿æ³›ä½¿ç”¨å§ã€‚è€Œgoæ›´æ˜¯æŠŠåç¨‹ç”¨åˆ°åº•ï¼ŒåŸºæœ¬å¯ä»¥ç†è§£goçš„æ‰€æœ‰ä»£ç éƒ½è·‘åœ¨åç¨‹ä¸‹ï¼Œå¹¶ç”¨goroutineæ¥ä»£è¡¨å®ƒè‡ªå·±çš„åç¨‹ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.top/categories/go/"/>
    
    
      <category term="go" scheme="http://idiotsky.top/tags/go/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://idiotsky.top/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="goroutine" scheme="http://idiotsky.top/tags/goroutine/"/>
    
      <category term="åç¨‹" scheme="http://idiotsky.top/tags/%E5%8D%8F%E7%A8%8B/"/>
    
      <category term="å¹¶å‘" scheme="http://idiotsky.top/tags/%E5%B9%B6%E5%8F%91/"/>
    
      <category term="å¹¶è¡Œ" scheme="http://idiotsky.top/tags/%E5%B9%B6%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>mysql å¹»è¯»å®éªŒ</title>
    <link href="http://idiotsky.top/2018/08/08/mysql-dirty-read/"/>
    <id>http://idiotsky.top/2018/08/08/mysql-dirty-read/</id>
    <published>2018-08-08T12:24:11.000Z</published>
    <updated>2018-08-09T01:01:56.658Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¯åŠ¨ä¸€ä¸ªmysql"><a href="#å¯åŠ¨ä¸€ä¸ªmysql" class="headerlink" title="å¯åŠ¨ä¸€ä¸ªmysql"></a>å¯åŠ¨ä¸€ä¸ªmysql</h1><p>ç”¨dockerå¾ˆå®¹æ˜“å°±èµ·ä¸€ä¸ªmysqlçš„ç¯å¢ƒäº†ï¼Œæˆ‘çš„<a href="https://github.com/ejunjsh/docker-code" target="_blank" rel="noopener">github repo docker-code</a>,æœ‰ä¾‹å­</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mysql</span><br><span class="line">sudo docker-compose up</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="ç™»é™†mysql"><a href="#ç™»é™†mysql" class="headerlink" title="ç™»é™†mysql"></a>ç™»é™†mysql</h1><p>ç”¨ä¸‹é¢å‘½ä»¤å¯ä»¥ç¡®è®¤mysqlæ‰€åœ¨çš„å®¹å™¨ï¼Œåœ¨æˆ‘æœºå­æ˜¯<code>mysql_db_1</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps</span><br><span class="line">[sudo] password <span class="keyword">for</span> sky:</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">c7f451f632c0        adminer             <span class="string">"entrypoint.sh doc..."</span>   2 weeks ago         Up 2 minutes        0.0.0.0:8080-&gt;8080/tcp   mysql_adminer_1</span><br><span class="line">e2645139c23b        mysql               <span class="string">"docker-entrypoint..."</span>   2 weeks ago         Up 2 minutes        3306/tcp                 mysql_db_1</span><br></pre></td></tr></table></figure></p>
<p>è¿›å…¥å®¹å™¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker <span class="built_in">exec</span> -it mysql_db_1 bash</span><br><span class="line">mysql -p</span><br></pre></td></tr></table></figure>
<p>å¯†ç é»˜è®¤æ˜¯<code>example</code></p>
<h1 id="åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨"><a href="#åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨" class="headerlink" title="åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨"></a>åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database test;</span><br><span class="line">mysql&gt; use test;</span><br><span class="line">mysql&gt; DROP TABLE IF EXISTS `tx`;</span><br><span class="line">mysql&gt; CREATE TABLE `tx` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `num` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure>
<h1 id="å¼€å§‹å®éªŒ"><a href="#å¼€å§‹å®éªŒ" class="headerlink" title="å¼€å§‹å®éªŒ"></a>å¼€å§‹å®éªŒ</h1><p>mysqlçš„é»˜è®¤éš”ç¦»çº§åˆ«ä¸º<code>å¯é‡å¤è¯»</code>ï¼Œæ‰€ä»¥æ˜¯ä¼šå‡ºç°<code>å¹»è¯»</code>çš„æƒ…å†µçš„ã€‚</p>
<p>è¿˜æ˜¯éªŒè¯ä¸‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT @@transaction_isolation;</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>ä»¥å‰æ˜¯<code>SELECT @@tx_isolation;</code>,æ–°ç‰ˆæœ¬è¦ç”¨<code>SELECT @@transaction_isolation;</code></p>
<p>æ¥ä¸‹æ¥æ’å…¥ä¸€æ¡æ•°æ®<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into tx (num) values(100);</span><br></pre></td></tr></table></figure></p>
<p>ç„¶åå¼€å¯äº‹åŠ¡<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction;</span><br></pre></td></tr></table></figure></p>
<p>æ›´æ–°è¿™æ¡è®°å½•</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set num=200 where num=100;</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure>
<p>ç•™æ„ä¸Šé¢çš„<code>matched</code>æ˜¯1çš„ã€‚</p>
<p>å…ˆä¸æäº¤è¿™ä¸ªäº‹åŠ¡ï¼Œå¼€å¦å¤–ä¸ªç»ˆç«¯æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•å†æ‰“å¼€ä¸ªmysql,ä¹‹åä¹Ÿå¼€ä¸€ä¸ªäº‹åŠ¡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use <span class="built_in">test</span>;</span><br><span class="line">mysql&gt; start transaction;</span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+----+-----+</span><br><span class="line">| id | num |</span><br><span class="line">+----+-----+</span><br><span class="line">|  1 | 100 |</span><br><span class="line">+----+-----+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>ç”±äºéš”ç¦»çº§åˆ«ï¼Œæ‰€ä»¥çœ‹ä¸åˆ°å¯¹æ–¹æ›´æ–°çš„</p>
<p>ç„¶åå›åˆ°ç¬¬ä¸€ä¸ªç»ˆç«¯,æäº¤äº‹åŠ¡</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; commit;</span><br></pre></td></tr></table></figure>
<p>å†å›åˆ°ç¬¬äºŒç»ˆç«¯ï¼Œ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">| id | num |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">|  1 | 100 |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯å› ä¸ºéš”ç¦»çº§åˆ«ï¼Œè¿˜æ˜¯çœ‹ä¸åˆ°å¯¹æ–¹æ›´æ–°çš„ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œé‡å¤´æˆæ¥äº†ï¼Œå°è¯•åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸Šæ‰§è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set num=300 where num=100;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 0  Changed: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">| id | num |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">|  1 | 100 |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>å±…ç„¶æ›´æ–°ä¸äº†ï¼Œç„¶åå°±<code>å¹»è¯»</code>äº†ã€‚è¿™ä¸ªå¾ˆå®¹æ˜“ç†è§£ï¼Œåœ¨ç¬¬äºŒä¸ªç»ˆç«¯çš„äº‹åŠ¡é‡Œï¼Œçœ‹åˆ°éƒ½æ˜¯å®ƒå¯åŠ¨äº‹åŠ¡é‚£ä¸€åˆ»çš„å¿«ç…§<code>snapshot</code>,æ‰€ä»¥çœ‹ä¸åˆ°å…¶ä»–äº‹åŠ¡çš„ä¸œè¥¿ï¼Œå¯æ˜¯ä¸€æ—¦æ›´æ–°çš„æ—¶å€™ï¼Œå°±ä¼šå› ä¸ºåˆ«äººäº‹åŠ¡æ”¹å˜äº†åŸæ¥çš„å€¼ï¼Œè‡ªå·±æ²¡åŠæ³•å†æ›´æ–°å®ƒä»¥ä¸ºçš„é‚£ä¸ªå€¼äº†ï¼Œæ‰€ä»¥è¿™ç§ä»¥ä¸ºå°±ç§°ä¸ºäº†<code>å¹»è§‰(phantom)</code>ï¼Œä¿—ç§°<code>å¹»è¯»</code>ã€‚</p>
<p>é‚£å‡å¦‚ä¸Šé¢æˆ‘ä¸æŒ‡å®šæ¡ä»¶å‘¢ </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set num=300;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure>
<p>æ˜¯å¯ä»¥æ›´æ–°çš„ï¼Œå› ä¸ºè¿™æ˜¯å…¨è¡¨æ›´æ–°ï¼Œæ‰€ä»¥æ²¡é—®é¢˜ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; commit;</span><br></pre></td></tr></table></figure>
<p>æäº¤ä¸‹ï¼Œæ–¹ä¾¿ä¸‹é¢ç»§ç»­åšå®éªŒ</p>
<p>è™½è¯´è¿™ä¸ª<code>å¹»è¯»</code>æ˜¯é—®é¢˜ï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯äººä»¬ç”¨æ¥åšæ•°æ®åº“<code>CAS</code>çš„ä¿è¯å§ã€‚</p>
<h1 id="æ•°æ®åº“CAS"><a href="#æ•°æ®åº“CAS" class="headerlink" title="æ•°æ®åº“CAS"></a>æ•°æ®åº“<code>CAS</code></h1><p>æˆ‘ä»¬åœ¨ä¸Šé¢çš„è¡¨åŸºç¡€ä¸Šå†åŠ ä¸€åˆ—<code>version</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table tx add column version int null;</span><br><span class="line">Query OK, 0 rows affected (0.16 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">| id | num | version |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">|  1 | 300 |    NULL |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®ä¸ªåˆå§‹å€¼</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set version =0;</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">| id | num | version |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">|  1 | 300 |       0 |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>ç„¶åç”¨javaè·‘ä¸ªå¹¶å‘æ‰£<code>num</code>çš„ç¨‹åº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.code.mysql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbCas</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JDBC é©±åŠ¨ååŠæ•°æ®åº“ URL</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String JDBC_DRIVER = <span class="string">"com.mysql.cj.jdbc.Driver"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String DB_URL = <span class="string">"jdbc:mysql://192.168.5.129:3306/test"</span>;<span class="comment">//è¿™é‡Œçš„ipæ˜¯ä½ dockerçš„hostçš„ip</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•°æ®åº“çš„ç”¨æˆ·åä¸å¯†ç ï¼Œéœ€è¦æ ¹æ®è‡ªå·±çš„è®¾ç½®</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String USER = <span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String PASS = <span class="string">"example"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicInteger counter=<span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Connection conn = DriverManager.getConnection(DB_URL,USER,PASS);</span><br><span class="line">            conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            Statement statement=conn.createStatement();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">                String sql=<span class="string">"select version from tx where id=1 and num&lt;&gt;0"</span>;</span><br><span class="line">                ResultSet rs=statement.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">                    <span class="keyword">int</span> version = rs.getInt(<span class="string">"version"</span>);</span><br><span class="line"></span><br><span class="line">                    rs.close();</span><br><span class="line"></span><br><span class="line">                    sql=<span class="string">"update tx set num=num-1,version=version+1 where id=1 and version="</span> + version;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> record = statement.executeUpdate(sql);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (record == <span class="number">1</span>) &#123;</span><br><span class="line">                        counter.getAndIncrement();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    conn.commit();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            statement.close();</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(JDBC_DRIVER);</span><br><span class="line"></span><br><span class="line">            Thread[] threads=<span class="keyword">new</span> Thread[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                Thread thread=<span class="keyword">new</span> Thread(() -&gt; consumer());</span><br><span class="line">                thread.start();</span><br><span class="line">                threads[i]=thread;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    threads[i].join();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.printf(<span class="string">"finally update %d records"</span>,counter.get());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœä¸º</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finally update 300 records</span><br></pre></td></tr></table></figure>
<p>æ•°æ®åº“æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">| id | num | version |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">|  1 |   0 |     300 |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°ï¼Œåªæœ‰300ä¸ªæˆåŠŸæ›´æ–°çš„è®°å½•,æ•°æ®åº“çš„è®°å½•ä¹Ÿæ²¡æœ‰è¶…æ‰£ã€‚</p>
<p>æ‰€ä»¥åˆ©ç”¨è¿™ä¸ªï¼Œå¯ä»¥ä¸ç”¨<code>select for update</code>ç­‰é”çš„æ“ä½œã€‚</p>
<h1 id="å†è¯•ä¸‹é”"><a href="#å†è¯•ä¸‹é”" class="headerlink" title="å†è¯•ä¸‹é”"></a>å†è¯•ä¸‹é”</h1><p>æ¥ä¸‹æ¥è¯•è¯•é”å§</p>
<p>ç¬¬ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start transaction;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tx;</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">| id | num | version |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">|  1 | 300 |       1 |</span><br><span class="line">+<span class="comment">----+-----+---------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">update</span> tx <span class="keyword">set</span> <span class="keyword">num</span> =<span class="number">400</span> <span class="keyword">where</span> <span class="keyword">version</span>=<span class="number">1</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ²¡æœ‰æäº¤äº‹åŠ¡</p>
<p>ç„¶åç¬¬äºŒä¸ªç»ˆç«¯ï¼Œç›´æ¥è¿è¡Œä¸‹é¢å‘½ä»¤</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update tx set num =400 where version=1;</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°å¡åœ¨é‚£é‡Œï¼Œè¿‡ä¸€ä¼šå°±ä¼šå“åº”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥è¿™é‡Œä½ å°±çœ‹åˆ°æ˜¯æœ‰é”äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç¥å¥‡å‘¢ï¼Œå…¶å®éš”ç¦»çº§åˆ«å°±æ˜¯é é”æ¥å®ç°çš„</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä¸Šé¢åˆ—å­å’Œä»£ç å¯ä»¥å¾ˆå¥½çš„è¯´æ˜äº†ï¼Œæ•°æ®åº“ä¼šåœ¨é€‚å½“çš„æ—¶å€™åŠ é”ï¼Œä¿è¯æ•°æ®ä¸ä¼šæœ‰é—®é¢˜ï¼Œå½“ç„¶å‰ææ˜¯éš”ç¦»çº§åˆ«è®¾ç½®å¤Ÿé«˜ï¼Œmysqlé»˜è®¤æ˜¯å¯é‡å¤è¯»ï¼Œæ‰€ä»¥è¶³å¤Ÿä¿è¯äº†ï¼Œè¿˜æœ‰ä¸Šé¢ä¾‹å­å¯ä»¥ç”¨æ¥åšæ‰£åº“å­˜çš„ä»£ç å“¦ğŸ˜„ï¼Œjavaä»£ç å¯ä»¥åœ¨<a href="https://github.com/ejunjsh/java-code/blob/master/basic/src/main/java/com/sky/code/mysql/DbCas.java" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‹¿åˆ°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å¯åŠ¨ä¸€ä¸ªmysql&quot;&gt;&lt;a href=&quot;#å¯åŠ¨ä¸€ä¸ªmysql&quot; class=&quot;headerlink&quot; title=&quot;å¯åŠ¨ä¸€ä¸ªmysql&quot;&gt;&lt;/a&gt;å¯åŠ¨ä¸€ä¸ªmysql&lt;/h1&gt;&lt;p&gt;ç”¨dockerå¾ˆå®¹æ˜“å°±èµ·ä¸€ä¸ªmysqlçš„ç¯å¢ƒäº†ï¼Œæˆ‘çš„&lt;a href=&quot;https://github.com/ejunjsh/docker-code&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;github repo docker-code&lt;/a&gt;,æœ‰ä¾‹å­&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; mysql&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo docker-compose up&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="mysql" scheme="http://idiotsky.top/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://idiotsky.top/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£Java G1åƒåœ¾æ”¶é›†å™¨</title>
    <link href="http://idiotsky.top/2018/07/28/java-g1/"/>
    <id>http://idiotsky.top/2018/07/28/java-g1/</id>
    <published>2018-07-28T10:54:54.000Z</published>
    <updated>2018-08-14T13:25:49.481Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>æ­¤æ–‡ç« é™¤äº†è¯´g1,è¿˜é¡ºå¸¦æ€»ç»“äº†ä¸€äº›å…¶ä»–æ¦‚å¿µï¼Œmarkä¹‹ğŸ‘¿</p>
</blockquote>
<p>æœ¬æ–‡é¦–å…ˆç®€å•ä»‹ç»äº†åƒåœ¾æ”¶é›†çš„å¸¸è§æ–¹å¼ï¼Œç„¶åå†åˆ†æäº†G1æ”¶é›†å™¨çš„æ”¶é›†åŸç†ï¼Œç›¸æ¯”å…¶ä»–åƒåœ¾æ”¶é›†å™¨çš„ä¼˜åŠ¿ï¼Œæœ€åç»™å‡ºäº†ä¸€äº›è°ƒä¼˜å®è·µã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶"><a href="#ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶" class="headerlink" title="ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶"></a>ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶</h1><p>é¦–å…ˆï¼Œåœ¨äº†è§£G1ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¸…æ¥šçš„çŸ¥é“ï¼Œåƒåœ¾å›æ”¶æ˜¯ä»€ä¹ˆï¼Ÿç®€å•çš„è¯´åƒåœ¾å›æ”¶å°±æ˜¯å›æ”¶å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚</p>
<p>åƒåœ¾å›æ”¶çš„åŸºæœ¬æ­¥éª¤</p>
<p>å›æ”¶çš„æ­¥éª¤æœ‰2æ­¥ï¼š</p>
<ul>
<li>æŸ¥æ‰¾å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡</li>
<li>é‡Šæ”¾è¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜</li>
</ul>
<p><strong>æŸ¥æ‰¾å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡</strong><br><a id="more"></a><br>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•åˆ¤æ–­å“ªäº›å¯¹è±¡ä¸å†è¢«ä½¿ç”¨å‘¢ï¼Ÿæˆ‘ä»¬ä¹Ÿæœ‰2ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>å¼•ç”¨è®¡æ•°æ³•<br> å¼•ç”¨è®¡æ•°æ³•å°±æ˜¯å¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰è¢«ä»»ä½•å¼•ç”¨æŒ‡å‘ï¼Œåˆ™å¯è§†ä¹‹ä¸ºåƒåœ¾ã€‚è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹å°±æ˜¯ä¸èƒ½æ£€æµ‹åˆ°ç¯çš„å­˜åœ¨ã€‚</li>
<li>æ ¹æœç´¢ç®—æ³•<br> æ ¹æœç´¢ç®—æ³•çš„åŸºæœ¬æ€è·¯å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—åä¸ºâ€GC Rootsâ€çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾(Reference Chain)ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚</li>
</ol>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•æ‰¾å‡ºåƒåœ¾å¯¹è±¡äº†ï¼Œå¦‚ä½•æŠŠè¿™äº›å¯¹è±¡æ¸…ç†æ‰å‘¢ï¼Ÿ</p>
<p><strong>é‡Šæ”¾è¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜</strong></p>
<p>å¸¸è§çš„æ–¹å¼æœ‰å¤åˆ¶æˆ–è€…ç›´æ¥æ¸…ç†ï¼Œä½†æ˜¯ç›´æ¥æ¸…ç†ä¼šå­˜åœ¨å†…å­˜ç¢ç‰‡ï¼Œäºæ˜¯å°±ä¼šäº§ç”Ÿäº†æ¸…ç†å†å‹ç¼©çš„æ–¹å¼ã€‚</p>
<p>æ€»å¾—æ¥è¯´å°±äº§ç”Ÿäº†ä¸‰ç§ç±»å‹çš„å›æ”¶ç®—æ³•ã€‚</p>
<ol>
<li>æ ‡è®°-å¤åˆ¶<br> å®ƒå°†å¯ç”¨å†…å­˜å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—ç”¨å®Œä¹‹åï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šé¢ï¼Œç„¶ååœ¨æŠŠå·²ä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´ä¸€æ¬¡ç†æ‰ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œæ•ˆç‡é«˜ï¼Œä¸ä¼šå­˜åœ¨å†…å­˜ç¢ç‰‡ã€‚ç¼ºç‚¹å°±æ˜¯éœ€è¦2å€çš„å†…å­˜æ¥ç®¡ç†ã€‚</li>
<li>æ ‡è®°-æ¸…ç†<br> æ ‡è®°æ¸…é™¤ç®—æ³•åˆ†ä¸ºâ€œæ ‡è®°â€å’Œâ€œæ¸…é™¤â€ä¸¤ä¸ªé˜¶æ®µï¼šé¦–å…ˆæ ‡è®°å‡ºéœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œæ ‡è®°å®Œæˆä¹‹åç»Ÿä¸€æ¸…é™¤å¯¹è±¡ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯æ•ˆç‡é«˜ï¼Œç¼ºç‚¹æ˜¯å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</li>
<li>æ ‡è®°-æ•´ç†<br> æ ‡è®°æ“ä½œå’Œâ€œæ ‡è®°-æ¸…ç†â€ç®—æ³•ä¸€è‡´ï¼Œåç»­æ“ä½œä¸åªæ˜¯ç›´æ¥æ¸…ç†å¯¹è±¡ï¼Œè€Œæ˜¯åœ¨æ¸…ç†æ— ç”¨å¯¹è±¡å®Œæˆåè®©æ‰€æœ‰ å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨ï¼Œå¹¶æ›´æ–°å¼•ç”¨å…¶å¯¹è±¡çš„æŒ‡é’ˆã€‚å› ä¸ºè¦ç§»åŠ¨å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒçš„æ•ˆç‡è¦æ¯”â€œæ ‡è®°-æ¸…ç†â€æ•ˆç‡ä½ï¼Œä½†æ˜¯ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</li>
</ol>
<p><strong>åŸºäºåˆ†ä»£çš„å‡è®¾</strong></p>
<p>ç”±äºå¯¹è±¡çš„å­˜æ´»æ—¶é—´æœ‰é•¿æœ‰çŸ­ï¼Œæ‰€ä»¥å¯¹äºå­˜æ´»æ—¶é—´é•¿çš„å¯¹è±¡ï¼Œå‡å°‘è¢«gcçš„æ¬¡æ•°å¯ä»¥é¿å…ä¸å¿…è¦çš„å¼€é”€ã€‚è¿™æ ·æˆ‘ä»¬å°±æŠŠå†…å­˜åˆ†æˆæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæ–°ç”Ÿä»£å­˜æ”¾åˆšåˆ›å»ºçš„å’Œå­˜æ´»æ—¶é—´æ¯”è¾ƒçŸ­çš„å¯¹è±¡ï¼Œè€å¹´ä»£å­˜æ”¾å­˜æ´»æ—¶é—´æ¯”è¾ƒé•¿çš„å¯¹è±¡ã€‚è¿™æ ·æ¯æ¬¡ä»…ä»…æ¸…ç†å¹´è½»ä»£ï¼Œè€å¹´ä»£ä»…åœ¨å¿…è¦æ—¶æ—¶å†åšæ¸…ç†å¯ä»¥æå¤§çš„æé«˜GCæ•ˆç‡ï¼ŒèŠ‚çœGCæ—¶é—´ã€‚</p>
<p><strong>javaåƒåœ¾æ”¶é›†å™¨çš„å†å²</strong></p>
<p><strong>ç¬¬ä¸€é˜¶æ®µï¼ŒSerialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨</strong></p>
<p>åœ¨jdk1.3.1ä¹‹å‰ï¼Œjavaè™šæ‹Ÿæœºä»…ä»…èƒ½ä½¿ç”¨Serialæ”¶é›†å™¨ã€‚ Serialæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ”¶é›†å™¨ï¼Œä½†å®ƒçš„â€œå•çº¿ç¨‹â€çš„æ„ä¹‰å¹¶ä¸ä»…ä»…æ˜¯è¯´æ˜å®ƒåªä¼šä½¿ç”¨ä¸€ä¸ªCPUæˆ–ä¸€æ¡æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å®ƒè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚</p>
<p>PSï¼šå¼€å¯Serialæ”¶é›†å™¨çš„æ–¹å¼</p>
<blockquote>
<p>-XX:+UseSerialGC</p>
</blockquote>
<p><strong>ç¬¬äºŒé˜¶æ®µï¼ŒParallelï¼ˆå¹¶è¡Œï¼‰æ”¶é›†å™¨</strong></p>
<p>Parallelæ”¶é›†å™¨ä¹Ÿç§°ååé‡æ”¶é›†å™¨ï¼Œç›¸æ¯”Serialæ”¶é›†å™¨ï¼ŒParallelæœ€ä¸»è¦çš„ä¼˜åŠ¿åœ¨äºä½¿ç”¨å¤šçº¿ç¨‹å»å®Œæˆåƒåœ¾æ¸…ç†å·¥ä½œï¼Œè¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸çš„ç‰¹æ€§ï¼Œå¤§å¹…é™ä½gcæ—¶é—´ã€‚</p>
<p>PS:å¼€å¯Parallelæ”¶é›†å™¨çš„æ–¹å¼</p>
<blockquote>
<p>-XX:+UseParallelGC -XX:+UseParallelOldGC</p>
</blockquote>
<p><strong>ç¬¬ä¸‰é˜¶æ®µï¼ŒCMSï¼ˆå¹¶å‘ï¼‰æ”¶é›†å™¨</strong></p>
<p>CMSæ”¶é›†å™¨åœ¨Minor GCæ—¶ä¼šæš‚åœæ‰€æœ‰çš„åº”ç”¨çº¿ç¨‹ï¼Œå¹¶ä»¥å¤šçº¿ç¨‹çš„æ–¹å¼è¿›è¡Œåƒåœ¾å›æ”¶ã€‚åœ¨Full GCæ—¶ä¸å†æš‚åœåº”ç”¨çº¿ç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨è‹¥å¹²ä¸ªåå°çº¿ç¨‹å®šæœŸçš„å¯¹è€å¹´ä»£ç©ºé—´è¿›è¡Œæ‰«æï¼ŒåŠæ—¶å›æ”¶å…¶ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚</p>
<p>PS:å¼€å¯CMSæ”¶é›†å™¨çš„æ–¹å¼</p>
<blockquote>
<p>-XX:+UseParNewGC -XX:+UseConcMarkSweepGC</p>
</blockquote>
<p><strong>ç¬¬å››é˜¶æ®µï¼ŒG1ï¼ˆå¹¶å‘ï¼‰æ”¶é›†å™¨</strong></p>
<p>G1æ”¶é›†å™¨ï¼ˆæˆ–è€…åƒåœ¾ä¼˜å…ˆæ”¶é›†å™¨ï¼‰çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†å°½é‡ç¼©çŸ­å¤„ç†è¶…å¤§å †ï¼ˆå¤§äº4GBï¼‰æ—¶äº§ç”Ÿçš„åœé¡¿ã€‚ç›¸å¯¹äºCMSçš„ä¼˜åŠ¿è€Œè¨€æ˜¯å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿç‡å¤§å¤§é™ä½ã€‚</p>
<p>PS:å¼€å¯G1æ”¶é›†å™¨çš„æ–¹å¼</p>
<blockquote>
<p>-XX:+UseG1GC</p>
</blockquote>
<h1 id="äº†è§£G1"><a href="#äº†è§£G1" class="headerlink" title="äº†è§£G1"></a>äº†è§£G1</h1><p>G1çš„ç¬¬ä¸€ç¯‡paperï¼ˆé™„å½•1ï¼‰å‘è¡¨äº2004å¹´ï¼Œåœ¨2012å¹´æ‰åœ¨jdk1.7u4ä¸­å¯ç”¨ã€‚oracleå®˜æ–¹è®¡åˆ’åœ¨jdk9ä¸­å°†G1å˜æˆé»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä»¥æ›¿ä»£CMSã€‚ä¸ºä½•oracleè¦æåŠ›æ¨èG1å‘¢ï¼ŒG1æœ‰å“ªäº›ä¼˜ç‚¹ï¼Ÿ</p>
<p>é¦–å…ˆï¼ŒG1çš„è®¾è®¡åŸåˆ™å°±æ˜¯ç®€å•å¯è¡Œçš„æ€§èƒ½è°ƒä¼˜</p>
<p>å¼€å‘äººå‘˜ä»…ä»…éœ€è¦å£°æ˜ä»¥ä¸‹å‚æ•°å³å¯ï¼š</p>
<blockquote>
<p>-XX:+UseG1GC -Xmx32g -XX:MaxGCPauseMillis=200</p>
</blockquote>
<p>å…¶ä¸­-XX:+UseG1GCä¸ºå¼€å¯G1åƒåœ¾æ”¶é›†å™¨ï¼Œ-Xmx32g è®¾è®¡å †å†…å­˜çš„æœ€å¤§å†…å­˜ä¸º32Gï¼Œ-XX:MaxGCPauseMillis=200è®¾ç½®GCçš„æœ€å¤§æš‚åœæ—¶é—´ä¸º200msã€‚å¦‚æœæˆ‘ä»¬éœ€è¦è°ƒä¼˜ï¼Œåœ¨å†…å­˜å¤§å°ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹æœ€å¤§æš‚åœæ—¶é—´å³å¯ã€‚</p>
<p>å…¶æ¬¡ï¼ŒG1å°†æ–°ç”Ÿä»£ï¼Œè€å¹´ä»£çš„ç‰©ç†ç©ºé—´åˆ’åˆ†å–æ¶ˆäº†ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å†ä¹Ÿä¸ç”¨å•ç‹¬çš„ç©ºé—´å¯¹æ¯ä¸ªä»£è¿›è¡Œè®¾ç½®äº†ï¼Œä¸ç”¨æ‹…å¿ƒæ¯ä¸ªä»£å†…å­˜æ˜¯å¦è¶³å¤Ÿã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-1.jpg"><img src="http://idiotsky.top/images3/G1-1.png" alt=""></a></p>
<p>å–è€Œä»£ä¹‹çš„æ˜¯ï¼ŒG1ç®—æ³•å°†å †åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼ˆRegionï¼‰ï¼Œå®ƒä»ç„¶å±äºåˆ†ä»£æ”¶é›†å™¨ã€‚ä¸è¿‡ï¼Œè¿™äº›åŒºåŸŸçš„ä¸€éƒ¨åˆ†åŒ…å«æ–°ç”Ÿä»£ï¼Œæ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†ä¾ç„¶é‡‡ç”¨æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹çš„æ–¹å¼ï¼Œå°†å­˜æ´»å¯¹è±¡æ‹·è´åˆ°è€å¹´ä»£æˆ–è€…Survivorç©ºé—´ã€‚è€å¹´ä»£ä¹Ÿåˆ†æˆå¾ˆå¤šåŒºåŸŸï¼ŒG1æ”¶é›†å™¨é€šè¿‡å°†å¯¹è±¡ä»ä¸€ä¸ªåŒºåŸŸå¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªåŒºåŸŸï¼Œå®Œæˆäº†æ¸…ç†å·¥ä½œã€‚è¿™å°±æ„å‘³ç€ï¼Œåœ¨æ­£å¸¸çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼ŒG1å®Œæˆäº†å †çš„å‹ç¼©ï¼ˆè‡³å°‘æ˜¯éƒ¨åˆ†å †çš„å‹ç¼©ï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±ä¸ä¼šæœ‰cmså†…å­˜ç¢ç‰‡é—®é¢˜çš„å­˜åœ¨äº†ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-2.png"><img src="http://idiotsky.top/images3/G1-2.png" alt=""></a></p>
<p>åœ¨G1ä¸­ï¼Œè¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„åŒºåŸŸï¼Œå«HumongousåŒºåŸŸã€‚ å¦‚æœä¸€ä¸ªå¯¹è±¡å ç”¨çš„ç©ºé—´è¶…è¿‡äº†åˆ†åŒºå®¹é‡50%ä»¥ä¸Šï¼ŒG1æ”¶é›†å™¨å°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå·¨å‹å¯¹è±¡ã€‚è¿™äº›å·¨å‹å¯¹è±¡ï¼Œé»˜è®¤ç›´æ¥ä¼šè¢«åˆ†é…åœ¨å¹´è€ä»£ï¼Œä½†æ˜¯å¦‚æœå®ƒæ˜¯ä¸€ä¸ªçŸ­æœŸå­˜åœ¨çš„å·¨å‹å¯¹è±¡ï¼Œå°±ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ æˆè´Ÿé¢å½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒG1åˆ’åˆ†äº†ä¸€ä¸ªHumongousåŒºï¼Œå®ƒç”¨æ¥ä¸“é—¨å­˜æ”¾å·¨å‹å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªHåŒºè£…ä¸ä¸‹ä¸€ä¸ªå·¨å‹å¯¹è±¡ï¼Œé‚£ä¹ˆG1ä¼šå¯»æ‰¾è¿ç»­çš„Håˆ†åŒºæ¥å­˜å‚¨ã€‚ä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨Full GCã€‚</p>
<p>PSï¼šåœ¨java 8ä¸­ï¼ŒæŒä¹…ä»£ä¹Ÿç§»åŠ¨åˆ°äº†æ™®é€šçš„å †å†…å­˜ç©ºé—´ä¸­ï¼Œæ”¹ä¸ºå…ƒç©ºé—´ã€‚</p>
<p><strong>å¯¹è±¡åˆ†é…ç­–ç•¥</strong></p>
<p>è¯´èµ·å¤§å¯¹è±¡çš„åˆ†é…ï¼Œæˆ‘ä»¬ä¸å¾—ä¸è°ˆè°ˆå¯¹è±¡çš„åˆ†é…ç­–ç•¥ã€‚å®ƒåˆ†ä¸º3ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>TLAB(Thread Local Allocation Buffer)çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒº</li>
<li>EdenåŒºä¸­åˆ†é…</li>
<li>HumongousåŒºåˆ†é…</li>
</ol>
<p>TLABä¸ºçº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒºï¼Œå®ƒçš„ç›®çš„ä¸ºäº†ä½¿å¯¹è±¡å°½å¯èƒ½å¿«çš„åˆ†é…å‡ºæ¥ã€‚å¦‚æœå¯¹è±¡åœ¨ä¸€ä¸ªå…±äº«çš„ç©ºé—´ä¸­åˆ†é…ï¼Œæˆ‘ä»¬éœ€è¦é‡‡ç”¨ä¸€äº›åŒæ­¥æœºåˆ¶æ¥ç®¡ç†è¿™äº›ç©ºé—´å†…çš„ç©ºé—²ç©ºé—´æŒ‡é’ˆã€‚åœ¨Edenç©ºé—´ä¸­ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„åˆ†åŒºç”¨äºåˆ†é…å¯¹è±¡ï¼Œå³ä¸€ä¸ªTLABã€‚åˆ†é…å¯¹è±¡æ—¶ï¼Œçº¿ç¨‹ä¹‹é—´ä¸å†éœ€è¦è¿›è¡Œä»»ä½•çš„åŒæ­¥ã€‚</p>
<p>å¯¹TLABç©ºé—´ä¸­æ— æ³•åˆ†é…çš„å¯¹è±¡ï¼ŒJVMä¼šå°è¯•åœ¨Edenç©ºé—´ä¸­è¿›è¡Œåˆ†é…ã€‚å¦‚æœEdenç©ºé—´æ— æ³•å®¹çº³è¯¥å¯¹è±¡ï¼Œå°±åªèƒ½åœ¨è€å¹´ä»£ä¸­è¿›è¡Œåˆ†é…ç©ºé—´ã€‚</p>
<p>æœ€åï¼ŒG1æä¾›äº†ä¸¤ç§GCæ¨¡å¼ï¼ŒYoung GCå’ŒMixed GCï¼Œä¸¤ç§éƒ½æ˜¯Stop The World(STW)çš„ã€‚ä¸‹é¢æˆ‘ä»¬å°†åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™2ç§æ¨¡å¼ã€‚</p>
<h1 id="G1-Young-GC"><a href="#G1-Young-GC" class="headerlink" title="G1 Young GC"></a>G1 Young GC</h1><p>Young GCä¸»è¦æ˜¯å¯¹EdenåŒºè¿›è¡ŒGCï¼Œå®ƒåœ¨Edenç©ºé—´è€—å°½æ—¶ä¼šè¢«è§¦å‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒEdenç©ºé—´çš„æ•°æ®ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¦‚æœSurvivorç©ºé—´ä¸å¤Ÿï¼ŒEdenç©ºé—´çš„éƒ¨åˆ†æ•°æ®ä¼šç›´æ¥æ™‹å‡åˆ°å¹´è€ä»£ç©ºé—´ã€‚SurvivoråŒºçš„æ•°æ®ç§»åŠ¨åˆ°æ–°çš„SurvivoråŒºä¸­ï¼Œä¹Ÿæœ‰éƒ¨åˆ†æ•°æ®æ™‹å‡åˆ°è€å¹´ä»£ç©ºé—´ä¸­ã€‚æœ€ç»ˆEdenç©ºé—´çš„æ•°æ®ä¸ºç©ºï¼ŒGCåœæ­¢å·¥ä½œï¼Œåº”ç”¨çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-3.png"><img src="http://idiotsky.top/images3/G1-3.png" alt=""></a></p>
<p><a href="http://idiotsky.top/images3/G1-4.png"><img src="http://idiotsky.top/images3/G1-4.png" alt=""></a></p>
<p>è¿™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä»…ä»…GC æ–°ç”Ÿä»£å¯¹è±¡ï¼Œæˆ‘ä»¬å¦‚ä½•æ‰¾åˆ°æ‰€æœ‰çš„æ ¹å¯¹è±¡å‘¢ï¼Ÿ è€å¹´ä»£çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯æ ¹ä¹ˆï¼Ÿé‚£è¿™æ ·æ‰«æä¸‹æ¥ä¼šè€—è´¹å¤§é‡çš„æ—¶é—´ã€‚äºæ˜¯ï¼ŒG1å¼•è¿›äº†RSetçš„æ¦‚å¿µã€‚å®ƒçš„å…¨ç§°æ˜¯Remembered Setï¼Œä½œç”¨æ˜¯è·Ÿè¸ªæŒ‡å‘æŸä¸ªheapåŒºå†…çš„å¯¹è±¡å¼•ç”¨ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-5.png"><img src="http://idiotsky.top/images3/G1-5.png" alt=""></a></p>
<p>åœ¨CMSä¸­ï¼Œä¹Ÿæœ‰RSetçš„æ¦‚å¿µï¼Œåœ¨è€å¹´ä»£ä¸­æœ‰ä¸€å—åŒºåŸŸç”¨æ¥è®°å½•æŒ‡å‘æ–°ç”Ÿä»£çš„å¼•ç”¨ã€‚è¿™æ˜¯ä¸€ç§point-outï¼Œåœ¨è¿›è¡ŒYoung GCæ—¶ï¼Œæ‰«ææ ¹æ—¶ï¼Œä»…ä»…éœ€è¦æ‰«æè¿™ä¸€å—åŒºåŸŸï¼Œè€Œä¸éœ€è¦æ‰«ææ•´ä¸ªè€å¹´ä»£ã€‚</p>
<p>ä½†åœ¨G1ä¸­ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨point-outï¼Œè¿™æ˜¯ç”±äºä¸€ä¸ªåˆ†åŒºå¤ªå°ï¼Œåˆ†åŒºæ•°é‡å¤ªå¤šï¼Œå¦‚æœæ˜¯ç”¨point-outçš„è¯ï¼Œä¼šé€ æˆå¤§é‡çš„æ‰«ææµªè´¹ï¼Œæœ‰äº›æ ¹æœ¬ä¸éœ€è¦GCçš„åˆ†åŒºå¼•ç”¨ä¹Ÿæ‰«æäº†ã€‚äºæ˜¯G1ä¸­ä½¿ç”¨point-inæ¥è§£å†³ã€‚point-inçš„æ„æ€æ˜¯å“ªäº›åˆ†åŒºå¼•ç”¨äº†å½“å‰åˆ†åŒºä¸­çš„å¯¹è±¡ã€‚è¿™æ ·ï¼Œä»…ä»…å°†è¿™äº›å¯¹è±¡å½“åšæ ¹æ¥æ‰«æå°±é¿å…äº†æ— æ•ˆçš„æ‰«æã€‚ç”±äºæ–°ç”Ÿä»£æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨æ–°ç”Ÿä»£ä¹‹é—´è®°å½•å¼•ç”¨å—ï¼Ÿè¿™æ˜¯ä¸å¿…è¦çš„ï¼ŒåŸå› åœ¨äºæ¯æ¬¡GCæ—¶ï¼Œæ‰€æœ‰æ–°ç”Ÿä»£éƒ½ä¼šè¢«æ‰«æï¼Œæ‰€ä»¥åªéœ€è¦è®°å½•è€å¹´ä»£åˆ°æ–°ç”Ÿä»£ä¹‹é—´çš„å¼•ç”¨å³å¯ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¼•ç”¨çš„å¯¹è±¡å¾ˆå¤šï¼Œèµ‹å€¼å™¨éœ€è¦å¯¹æ¯ä¸ªå¼•ç”¨åšå¤„ç†ï¼Œèµ‹å€¼å™¨å¼€é”€ä¼šå¾ˆå¤§ï¼Œä¸ºäº†è§£å†³èµ‹å€¼å™¨å¼€é”€è¿™ä¸ªé—®é¢˜ï¼Œåœ¨G1 ä¸­åˆå¼•å…¥äº†å¦å¤–ä¸€ä¸ªæ¦‚å¿µï¼Œå¡è¡¨ï¼ˆCard Tableï¼‰ã€‚ä¸€ä¸ªCard Tableå°†ä¸€ä¸ªåˆ†åŒºåœ¨é€»è¾‘ä¸Šåˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„è¿ç»­åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸç§°ä¹‹ä¸ºå¡ã€‚å¡é€šå¸¸è¾ƒå°ï¼Œä»‹äº128åˆ°512å­—èŠ‚ä¹‹é—´ã€‚Card Tableé€šå¸¸ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç”±Cardçš„ç´¢å¼•ï¼ˆå³æ•°ç»„ä¸‹æ ‡ï¼‰æ¥æ ‡è¯†æ¯ä¸ªåˆ†åŒºçš„ç©ºé—´åœ°å€ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå¡éƒ½æœªè¢«å¼•ç”¨ã€‚å½“ä¸€ä¸ªåœ°å€ç©ºé—´è¢«å¼•ç”¨æ—¶ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´å¯¹åº”çš„æ•°ç»„ç´¢å¼•çš„å€¼è¢«æ ‡è®°ä¸ºâ€0â€³ï¼Œå³æ ‡è®°ä¸ºè„è¢«å¼•ç”¨ï¼Œæ­¤å¤–RSetä¹Ÿå°†è¿™ä¸ªæ•°ç»„ä¸‹æ ‡è®°å½•ä¸‹æ¥ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ä¸ªRSetå…¶å®æ˜¯ä¸€ä¸ªHash Tableï¼ŒKeyæ˜¯åˆ«çš„Regionçš„èµ·å§‹åœ°å€ï¼ŒValueæ˜¯ä¸€ä¸ªé›†åˆï¼Œé‡Œé¢çš„å…ƒç´ æ˜¯Card Tableçš„Indexã€‚</p>
<p>Young GC é˜¶æ®µï¼š</p>
<ul>
<li>é˜¶æ®µ1ï¼šæ ¹æ‰«æ<br>  é™æ€å’Œæœ¬åœ°å¯¹è±¡è¢«æ‰«æ</li>
<li>é˜¶æ®µ2ï¼šæ›´æ–°RS<br>  å¤„ç†dirty cardé˜Ÿåˆ—æ›´æ–°RS</li>
<li>é˜¶æ®µ3ï¼šå¤„ç†RS<br>  æ£€æµ‹ä»å¹´è½»ä»£æŒ‡å‘å¹´è€ä»£çš„å¯¹è±¡</li>
<li>é˜¶æ®µ4ï¼šå¯¹è±¡æ‹·è´<br>  æ‹·è´å­˜æ´»çš„å¯¹è±¡åˆ°survivor/oldåŒºåŸŸ</li>
<li>é˜¶æ®µ5ï¼šå¤„ç†å¼•ç”¨é˜Ÿåˆ—<br>  è½¯å¼•ç”¨ï¼Œå¼±å¼•ç”¨ï¼Œè™šå¼•ç”¨å¤„ç†</li>
</ul>
<h1 id="G1-Mix-GC"><a href="#G1-Mix-GC" class="headerlink" title="G1 Mix GC"></a>G1 Mix GC</h1><p>Mix GCä¸ä»…è¿›è¡Œæ­£å¸¸çš„æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†ï¼ŒåŒæ—¶ä¹Ÿå›æ”¶éƒ¨åˆ†åå°æ‰«æçº¿ç¨‹æ ‡è®°çš„è€å¹´ä»£åˆ†åŒºã€‚</p>
<p>å®ƒçš„GCæ­¥éª¤åˆ†2æ­¥ï¼š</p>
<ol>
<li>å…¨å±€å¹¶å‘æ ‡è®°ï¼ˆglobal concurrent markingï¼‰</li>
<li>æ‹·è´å­˜æ´»å¯¹è±¡ï¼ˆevacuationï¼‰</li>
</ol>
<p>åœ¨è¿›è¡ŒMix GCä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡Œglobal concurrent markingï¼ˆå…¨å±€å¹¶å‘æ ‡è®°ï¼‰ã€‚ global concurrent markingçš„æ‰§è¡Œè¿‡ç¨‹æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</p>
<p>åœ¨G1 GCä¸­ï¼Œå®ƒä¸»è¦æ˜¯ä¸ºMixed GCæä¾›æ ‡è®°æœåŠ¡çš„ï¼Œå¹¶ä¸æ˜¯ä¸€æ¬¡GCè¿‡ç¨‹çš„ä¸€ä¸ªå¿…é¡»ç¯èŠ‚ã€‚global concurrent markingçš„æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>åˆå§‹æ ‡è®°ï¼ˆinitial markï¼ŒSTWï¼‰<br>  åœ¨æ­¤é˜¶æ®µï¼ŒG1 GC å¯¹æ ¹è¿›è¡Œæ ‡è®°ã€‚è¯¥é˜¶æ®µä¸å¸¸è§„çš„ (STW) å¹´è½»ä»£åƒåœ¾å›æ”¶å¯†åˆ‡ç›¸å…³ã€‚</li>
<li>æ ¹åŒºåŸŸæ‰«æï¼ˆroot region scanï¼‰<br>  G1 GC åœ¨åˆå§‹æ ‡è®°çš„å­˜æ´»åŒºæ‰«æå¯¹è€å¹´ä»£çš„å¼•ç”¨ï¼Œå¹¶æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚è¯¥é˜¶æ®µä¸åº”ç”¨ç¨‹åºï¼ˆé STWï¼‰åŒæ—¶è¿è¡Œï¼Œå¹¶ä¸”åªæœ‰å®Œæˆè¯¥é˜¶æ®µåï¼Œæ‰èƒ½å¼€å§‹ä¸‹ä¸€æ¬¡ STW å¹´è½»ä»£åƒåœ¾å›æ”¶ã€‚</li>
<li>å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰<br>  G1 GC åœ¨æ•´ä¸ªå †ä¸­æŸ¥æ‰¾å¯è®¿é—®çš„ï¼ˆå­˜æ´»çš„ï¼‰å¯¹è±¡ã€‚è¯¥é˜¶æ®µä¸åº”ç”¨ç¨‹åºåŒæ—¶è¿è¡Œï¼Œå¯ä»¥è¢« STW å¹´è½»ä»£åƒåœ¾å›æ”¶ä¸­æ–­</li>
<li>æœ€ç»ˆæ ‡è®°ï¼ˆRemarkï¼ŒSTWï¼‰<br>  è¯¥é˜¶æ®µæ˜¯ STW å›æ”¶ï¼Œå¸®åŠ©å®Œæˆæ ‡è®°å‘¨æœŸã€‚G1 GC æ¸…ç©º SATB ç¼“å†²åŒºï¼Œè·Ÿè¸ªæœªè¢«è®¿é—®çš„å­˜æ´»å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œå¼•ç”¨å¤„ç†ã€‚</li>
<li>æ¸…é™¤åƒåœ¾ï¼ˆCleanupï¼ŒSTWï¼‰<br>  åœ¨è¿™ä¸ªæœ€åé˜¶æ®µï¼ŒG1 GC æ‰§è¡Œç»Ÿè®¡å’Œ RSet å‡€åŒ–çš„ STW æ“ä½œã€‚åœ¨ç»Ÿè®¡æœŸé—´ï¼ŒG1 GC ä¼šè¯†åˆ«å®Œå…¨ç©ºé—²çš„åŒºåŸŸå’Œå¯ä¾›è¿›è¡Œæ··åˆåƒåœ¾å›æ”¶çš„åŒºåŸŸã€‚æ¸…ç†é˜¶æ®µåœ¨å°†ç©ºç™½åŒºåŸŸé‡ç½®å¹¶è¿”å›åˆ°ç©ºé—²åˆ—è¡¨æ—¶ä¸ºéƒ¨åˆ†å¹¶å‘ã€‚</li>
</ul>
<p><strong>ä¸‰è‰²æ ‡è®°ç®—æ³•</strong></p>
<p>æåˆ°å¹¶å‘æ ‡è®°ï¼Œæˆ‘ä»¬ä¸å¾—ä¸äº†è§£å¹¶å‘æ ‡è®°çš„ä¸‰è‰²æ ‡è®°ç®—æ³•ã€‚å®ƒæ˜¯æè¿°è¿½è¸ªå¼å›æ”¶å™¨çš„ä¸€ç§æœ‰ç”¨çš„æ–¹æ³•ï¼Œåˆ©ç”¨å®ƒå¯ä»¥æ¨æ¼”å›æ”¶å™¨çš„æ­£ç¡®æ€§ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å°†å¯¹è±¡åˆ†æˆä¸‰ç§ç±»å‹çš„ã€‚</p>
<ul>
<li>é»‘è‰²:æ ¹å¯¹è±¡ï¼Œæˆ–è€…è¯¥å¯¹è±¡ä¸å®ƒçš„å­å¯¹è±¡éƒ½è¢«æ‰«æ</li>
<li>ç°è‰²:å¯¹è±¡æœ¬èº«è¢«æ‰«æ,ä½†è¿˜æ²¡æ‰«æå®Œè¯¥å¯¹è±¡ä¸­çš„å­å¯¹è±¡</li>
<li>ç™½è‰²:æœªè¢«æ‰«æå¯¹è±¡ï¼Œæ‰«æå®Œæˆæ‰€æœ‰å¯¹è±¡ä¹‹åï¼Œæœ€ç»ˆä¸ºç™½è‰²çš„ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œå³åƒåœ¾å¯¹è±¡</li>
</ul>
<p>å½“GCå¼€å§‹æ‰«æå¯¹è±¡æ—¶ï¼ŒæŒ‰ç…§å¦‚ä¸‹å›¾æ­¥éª¤è¿›è¡Œå¯¹è±¡çš„æ‰«æï¼š</p>
<p>æ ¹å¯¹è±¡è¢«ç½®ä¸ºé»‘è‰²ï¼Œå­å¯¹è±¡è¢«ç½®ä¸ºç°è‰²ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-6.png"><img src="http://idiotsky.top/images3/G1-6.png" alt=""></a></p>
<p>ç»§ç»­ç”±ç°è‰²éå†,å°†å·²æ‰«æäº†å­å¯¹è±¡çš„å¯¹è±¡ç½®ä¸ºé»‘è‰²ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-7.png"><img src="http://idiotsky.top/images3/G1-7.png" alt=""></a></p>
<p>éå†äº†æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡åï¼Œæ‰€æœ‰å¯è¾¾çš„å¯¹è±¡éƒ½å˜æˆäº†é»‘è‰²ã€‚ä¸å¯è¾¾çš„å¯¹è±¡å³ä¸ºç™½è‰²ï¼Œéœ€è¦è¢«æ¸…ç†ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-8.png"><img src="http://idiotsky.top/images3/G1-8.png" alt=""></a></p>
<p>è¿™çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œä½†æ˜¯å¦‚æœåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¹Ÿåœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¯¹è±¡çš„æŒ‡é’ˆå°±æœ‰å¯èƒ½æ”¹å˜ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå¯¹è±¡ä¸¢å¤±é—®é¢˜</p>
<p>æˆ‘ä»¬çœ‹ä¸‹é¢ä¸€ç§æƒ…å†µï¼Œå½“åƒåœ¾æ”¶é›†å™¨æ‰«æåˆ°ä¸‹é¢æƒ…å†µæ—¶ï¼š</p>
<p><a href="http://idiotsky.top/images3/G1-9.png"><img src="http://idiotsky.top/images3/G1-9.png" alt=""></a></p>
<p>è¿™æ—¶å€™åº”ç”¨ç¨‹åºæ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š</p>
<blockquote>
<p>A.c=C<br>B.c=null</p>
</blockquote>
<p>è¿™æ ·ï¼Œå¯¹è±¡çš„çŠ¶æ€å›¾å˜æˆå¦‚ä¸‹æƒ…å½¢ï¼š</p>
<p><a href="http://idiotsky.top/images3/G1-10.png"><img src="http://idiotsky.top/images3/G1-10.png" alt=""></a></p>
<p>è¿™æ—¶å€™åƒåœ¾æ”¶é›†å™¨å†æ ‡è®°æ‰«æçš„æ—¶å€™å°±ä¼šä¸‹å›¾æˆè¿™æ ·ï¼š</p>
<p><a href="http://idiotsky.top/images3/G1-11.png"><img src="http://idiotsky.top/images3/G1-11.png" alt=""></a></p>
<p>å¾ˆæ˜¾ç„¶ï¼Œæ­¤æ—¶Cæ˜¯ç™½è‰²ï¼Œè¢«è®¤ä¸ºæ˜¯åƒåœ¾éœ€è¦æ¸…ç†æ‰ï¼Œæ˜¾ç„¶è¿™æ˜¯ä¸åˆç†çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¿è¯åº”ç”¨ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™ï¼ŒGCæ ‡è®°çš„å¯¹è±¡ä¸ä¸¢å¤±å‘¢ï¼Ÿæœ‰å¦‚ä¸‹2ä¸­å¯è¡Œçš„æ–¹å¼ï¼š</p>
<ol>
<li>åœ¨æ’å…¥çš„æ—¶å€™è®°å½•å¯¹è±¡</li>
<li>åœ¨åˆ é™¤çš„æ—¶å€™è®°å½•å¯¹è±¡</li>
</ol>
<p>åˆšå¥½è¿™å¯¹åº”CMSå’ŒG1çš„2ç§ä¸åŒå®ç°æ–¹å¼ï¼š</p>
<p>åœ¨CMSé‡‡ç”¨çš„æ˜¯å¢é‡æ›´æ–°ï¼ˆIncremental updateï¼‰ï¼Œåªè¦åœ¨å†™å±éšœï¼ˆwrite barrierï¼‰é‡Œå‘ç°è¦æœ‰ä¸€ä¸ªç™½å¯¹è±¡çš„å¼•ç”¨è¢«èµ‹å€¼åˆ°ä¸€ä¸ªé»‘å¯¹è±¡ çš„å­—æ®µé‡Œï¼Œé‚£å°±æŠŠè¿™ä¸ªç™½å¯¹è±¡å˜æˆç°è‰²çš„ã€‚å³æ’å…¥çš„æ—¶å€™è®°å½•ä¸‹æ¥ã€‚</p>
<p>åœ¨G1ä¸­ï¼Œä½¿ç”¨çš„æ˜¯STABï¼ˆsnapshot-at-the-beginningï¼‰çš„æ–¹å¼ï¼Œåˆ é™¤çš„æ—¶å€™è®°å½•æ‰€æœ‰çš„å¯¹è±¡ï¼Œå®ƒæœ‰3ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>åœ¨å¼€å§‹æ ‡è®°çš„æ—¶å€™ç”Ÿæˆä¸€ä¸ªå¿«ç…§å›¾æ ‡è®°å­˜æ´»å¯¹è±¡</li>
<li>åœ¨å¹¶å‘æ ‡è®°çš„æ—¶å€™æ‰€æœ‰è¢«æ”¹å˜çš„å¯¹è±¡å…¥é˜Ÿï¼ˆåœ¨write barrieré‡ŒæŠŠæ‰€æœ‰æ—§çš„å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡éƒ½å˜æˆéç™½çš„ï¼‰</li>
<li>å¯èƒ½å­˜åœ¨æ¸¸ç¦»çš„åƒåœ¾ï¼Œå°†åœ¨ä¸‹æ¬¡è¢«æ”¶é›†</li>
</ol>
<p>è¿™æ ·ï¼ŒG1åˆ°ç°åœ¨å¯ä»¥çŸ¥é“å“ªäº›è€çš„åˆ†åŒºå¯å›æ”¶åƒåœ¾æœ€å¤šã€‚ å½“å…¨å±€å¹¶å‘æ ‡è®°å®Œæˆåï¼Œåœ¨æŸä¸ªæ—¶åˆ»ï¼Œå°±å¼€å§‹äº†Mix GCã€‚è¿™äº›åƒåœ¾å›æ”¶è¢«ç§°ä½œâ€œæ··åˆå¼â€æ˜¯å› ä¸ºä»–ä»¬ä¸ä»…ä»…è¿›è¡Œæ­£å¸¸çš„æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†ï¼ŒåŒæ—¶ä¹Ÿå›æ”¶éƒ¨åˆ†åå°æ‰«æçº¿ç¨‹æ ‡è®°çš„åˆ†åŒºã€‚æ··åˆå¼åƒåœ¾æ”¶é›†å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images3/G1-12.png"><img src="http://idiotsky.top/images3/G1-12.png" alt=""></a></p>
<p>æ··åˆå¼GCä¹Ÿæ˜¯é‡‡ç”¨çš„å¤åˆ¶çš„æ¸…ç†ç­–ç•¥ï¼Œå½“GCå®Œæˆåï¼Œä¼šé‡æ–°é‡Šæ”¾ç©ºé—´ã€‚</p>
<p><a href="http://idiotsky.top/images3/G1-13.png"><img src="http://idiotsky.top/images3/G1-13.png" alt=""></a></p>
<p>è‡³æ­¤ï¼Œæ··åˆå¼GCå‘Šä¸€æ®µè½äº†ã€‚ä¸‹ä¸€å°èŠ‚æˆ‘ä»¬è®²è¿›å…¥è°ƒä¼˜å®è·µã€‚</p>
<h1 id="è°ƒä¼˜å®è·µ"><a href="#è°ƒä¼˜å®è·µ" class="headerlink" title="è°ƒä¼˜å®è·µ"></a>è°ƒä¼˜å®è·µ</h1><p><strong>MaxGCPauseMillisè°ƒä¼˜</strong></p>
<p>å‰é¢ä»‹ç»è¿‡ä½¿ç”¨GCçš„æœ€åŸºæœ¬çš„å‚æ•°ï¼š</p>
<blockquote>
<p>-XX:+UseG1GC -Xmx32g -XX:MaxGCPauseMillis=200</p>
</blockquote>
<p>å‰é¢2ä¸ªå‚æ•°éƒ½å¥½ç†è§£ï¼Œåé¢è¿™ä¸ªMaxGCPauseMilliså‚æ•°è¯¥æ€ä¹ˆé…ç½®å‘¢ï¼Ÿè¿™ä¸ªå‚æ•°ä»å­—é¢çš„æ„æ€ä¸Šçœ‹ï¼Œå°±æ˜¯å…è®¸çš„GCæœ€å¤§çš„æš‚åœæ—¶é—´ã€‚G1å°½é‡ç¡®ä¿æ¯æ¬¡GCæš‚åœçš„æ—¶é—´éƒ½åœ¨è®¾ç½®çš„MaxGCPauseMillisèŒƒå›´å†…ã€‚ é‚£G1æ˜¯å¦‚ä½•åšåˆ°æœ€å¤§æš‚åœæ—¶é—´çš„å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°å¦ä¸€ä¸ªæ¦‚å¿µï¼ŒCSet(collection set)ã€‚å®ƒçš„æ„æ€æ˜¯åœ¨ä¸€æ¬¡åƒåœ¾æ”¶é›†å™¨ä¸­è¢«æ”¶é›†çš„åŒºåŸŸé›†åˆã€‚</p>
<ul>
<li>Young GCï¼šé€‰å®šæ‰€æœ‰æ–°ç”Ÿä»£é‡Œçš„regionã€‚é€šè¿‡æ§åˆ¶æ–°ç”Ÿä»£çš„regionä¸ªæ•°æ¥æ§åˆ¶young GCçš„å¼€é”€ã€‚</li>
<li>Mixed GCï¼šé€‰å®šæ‰€æœ‰æ–°ç”Ÿä»£é‡Œçš„regionï¼Œå¤–åŠ æ ¹æ®global concurrent markingç»Ÿè®¡å¾—å‡ºæ”¶é›†æ”¶ç›Šé«˜çš„è‹¥å¹²è€å¹´ä»£regionã€‚åœ¨ç”¨æˆ·æŒ‡å®šçš„å¼€é”€ç›®æ ‡èŒƒå›´å†…å°½å¯èƒ½é€‰æ‹©æ”¶ç›Šé«˜çš„è€å¹´ä»£regionã€‚</li>
</ul>
<p>åœ¨ç†è§£äº†è¿™äº›åï¼Œæˆ‘ä»¬å†è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´å°±å¥½åŠäº†ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬èƒ½å®¹å¿çš„æœ€å¤§æš‚åœæ—¶é—´æ˜¯æœ‰ä¸€ä¸ªé™åº¦çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ªé™åº¦èŒƒå›´å†…è®¾ç½®ã€‚ä½†æ˜¯åº”è¯¥è®¾ç½®çš„å€¼æ˜¯å¤šå°‘å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åœ¨ååé‡è·ŸMaxGCPauseMillisä¹‹é—´åšä¸€ä¸ªå¹³è¡¡ã€‚å¦‚æœMaxGCPauseMillisè®¾ç½®çš„è¿‡å°ï¼Œé‚£ä¹ˆGCå°±ä¼šé¢‘ç¹ï¼Œååé‡å°±ä¼šä¸‹é™ã€‚å¦‚æœMaxGCPauseMillisè®¾ç½®çš„è¿‡å¤§ï¼Œåº”ç”¨ç¨‹åºæš‚åœæ—¶é—´å°±ä¼šå˜é•¿ã€‚G1çš„é»˜è®¤æš‚åœæ—¶é—´æ˜¯200æ¯«ç§’ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå…¥æ‰‹ï¼Œè°ƒæ•´åˆé€‚çš„æ—¶é—´ã€‚</p>
<p><strong>å…¶ä»–è°ƒä¼˜å‚æ•°</strong></p>
<blockquote>
<p>-XX:G1HeapRegionSize=n</p>
</blockquote>
<p>è®¾ç½®çš„ G1 åŒºåŸŸçš„å¤§å°ã€‚å€¼æ˜¯ 2 çš„å¹‚ï¼ŒèŒƒå›´æ˜¯ 1 MB åˆ° 32 MB ä¹‹é—´ã€‚ç›®æ ‡æ˜¯æ ¹æ®æœ€å°çš„ Java å †å¤§å°åˆ’åˆ†å‡ºçº¦ 2048 ä¸ªåŒºåŸŸã€‚</p>
<blockquote>
<p>-XX:ParallelGCThreads=n</p>
</blockquote>
<p>è®¾ç½® STW å·¥ä½œçº¿ç¨‹æ•°çš„å€¼ã€‚å°† n çš„å€¼è®¾ç½®ä¸ºé€»è¾‘å¤„ç†å™¨çš„æ•°é‡ã€‚n çš„å€¼ä¸é€»è¾‘å¤„ç†å™¨çš„æ•°é‡ç›¸åŒï¼Œæœ€å¤šä¸º 8ã€‚</p>
<p>å¦‚æœé€»è¾‘å¤„ç†å™¨ä¸æ­¢å…«ä¸ªï¼Œåˆ™å°† n çš„å€¼è®¾ç½®ä¸ºé€»è¾‘å¤„ç†å™¨æ•°çš„ 5/8 å·¦å³ã€‚è¿™é€‚ç”¨äºå¤§å¤šæ•°æƒ…å†µï¼Œé™¤éæ˜¯è¾ƒå¤§çš„ SPARC ç³»ç»Ÿï¼Œå…¶ä¸­ n çš„å€¼å¯ä»¥æ˜¯é€»è¾‘å¤„ç†å™¨æ•°çš„ 5/16 å·¦å³ã€‚</p>
<blockquote>
<p>-XX:ConcGCThreads=n</p>
</blockquote>
<p>è®¾ç½®å¹¶è¡Œæ ‡è®°çš„çº¿ç¨‹æ•°ã€‚å°† n è®¾ç½®ä¸ºå¹¶è¡Œåƒåœ¾å›æ”¶çº¿ç¨‹æ•° (ParallelGCThreads) çš„ 1/4 å·¦å³ã€‚</p>
<blockquote>
<p>-XX:InitiatingHeapOccupancyPercent=45</p>
</blockquote>
<p>è®¾ç½®è§¦å‘æ ‡è®°å‘¨æœŸçš„ Java å †å ç”¨ç‡é˜ˆå€¼ã€‚é»˜è®¤å ç”¨ç‡æ˜¯æ•´ä¸ª Java å †çš„ 45%ã€‚</p>
<p>é¿å…ä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š</p>
<p>é¿å…ä½¿ç”¨ -Xmn é€‰é¡¹æˆ– -XX:NewRatio ç­‰å…¶ä»–ç›¸å…³é€‰é¡¹æ˜¾å¼è®¾ç½®å¹´è½»ä»£å¤§å°ã€‚å›ºå®šå¹´è½»ä»£çš„å¤§å°ä¼šè¦†ç›–æš‚åœæ—¶é—´ç›®æ ‡ã€‚</p>
<p><strong>è§¦å‘Full GC</strong></p>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒG1è§¦å‘äº†Full GCï¼Œè¿™æ—¶G1ä¼šé€€åŒ–ä½¿ç”¨Serialæ”¶é›†å™¨æ¥å®Œæˆåƒåœ¾çš„æ¸…ç†å·¥ä½œï¼Œå®ƒä»…ä»…ä½¿ç”¨å•çº¿ç¨‹æ¥å®ŒæˆGCå·¥ä½œï¼ŒGCæš‚åœæ—¶é—´å°†è¾¾åˆ°ç§’çº§åˆ«çš„ã€‚æ•´ä¸ªåº”ç”¨å¤„äºå‡æ­»çŠ¶æ€ï¼Œä¸èƒ½å¤„ç†ä»»ä½•è¯·æ±‚ï¼Œæˆ‘ä»¬çš„ç¨‹åºå½“ç„¶ä¸å¸Œæœ›çœ‹åˆ°è¿™äº›ã€‚é‚£ä¹ˆå‘ç”ŸFull GCçš„æƒ…å†µæœ‰å“ªäº›å‘¢ï¼Ÿ</p>
<ul>
<li>å¹¶å‘æ¨¡å¼å¤±è´¥<br>  G1å¯åŠ¨æ ‡è®°å‘¨æœŸï¼Œä½†åœ¨Mix GCä¹‹å‰ï¼Œè€å¹´ä»£å°±è¢«å¡«æ»¡ï¼Œè¿™æ—¶å€™G1ä¼šæ”¾å¼ƒæ ‡è®°å‘¨æœŸã€‚è¿™ç§æƒ…å½¢ä¸‹ï¼Œéœ€è¦å¢åŠ å †å¤§å°ï¼Œæˆ–è€…è°ƒæ•´å‘¨æœŸï¼ˆä¾‹å¦‚å¢åŠ çº¿ç¨‹æ•°-XX:ConcGCThreadsç­‰ï¼‰ã€‚</li>
<li>æ™‹å‡å¤±è´¥æˆ–è€…ç–æ•£å¤±è´¥<br>  G1åœ¨è¿›è¡ŒGCçš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ä¾›å­˜æ´»å¯¹è±¡æˆ–æ™‹å‡å¯¹è±¡ä½¿ç”¨ï¼Œç”±æ­¤è§¦å‘äº†Full GCã€‚å¯ä»¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°(to-space exhausted)æˆ–è€…ï¼ˆto-space overflowï¼‰ã€‚è§£å†³è¿™ç§é—®é¢˜çš„æ–¹å¼æ˜¯ï¼š<ol>
<li>å¢åŠ  -XX:G1ReservePercent é€‰é¡¹çš„å€¼ï¼ˆå¹¶ç›¸åº”å¢åŠ æ€»çš„å †å¤§å°ï¼‰ï¼Œä¸ºâ€œç›®æ ‡ç©ºé—´â€å¢åŠ é¢„ç•™å†…å­˜é‡ã€‚</li>
<li>é€šè¿‡å‡å°‘ -XX:InitiatingHeapOccupancyPercent æå‰å¯åŠ¨æ ‡è®°å‘¨æœŸã€‚</li>
<li>ä¹Ÿå¯ä»¥é€šè¿‡å¢åŠ  -XX:ConcGCThreads é€‰é¡¹çš„å€¼æ¥å¢åŠ å¹¶è¡Œæ ‡è®°çº¿ç¨‹çš„æ•°ç›®ã€‚</li>
</ol>
</li>
<li>å·¨å‹å¯¹è±¡åˆ†é…å¤±è´¥<br>  å½“å·¨å‹å¯¹è±¡æ‰¾ä¸åˆ°åˆé€‚çš„ç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œå°±ä¼šå¯åŠ¨Full GCï¼Œæ¥é‡Šæ”¾ç©ºé—´ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥é¿å…åˆ†é…å¤§é‡çš„å·¨å‹å¯¹è±¡ï¼Œå¢åŠ å†…å­˜æˆ–è€…å¢å¤§-XX:G1HeapRegionSizeï¼Œä½¿å·¨å‹å¯¹è±¡ä¸å†æ˜¯å·¨å‹å¯¹è±¡ã€‚</li>
</ul>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://blog.jobbole.com/109170/" target="_blank" rel="noopener">http://blog.jobbole.com/109170/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æ­¤æ–‡ç« é™¤äº†è¯´g1,è¿˜é¡ºå¸¦æ€»ç»“äº†ä¸€äº›å…¶ä»–æ¦‚å¿µï¼Œmarkä¹‹ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æœ¬æ–‡é¦–å…ˆç®€å•ä»‹ç»äº†åƒåœ¾æ”¶é›†çš„å¸¸è§æ–¹å¼ï¼Œç„¶åå†åˆ†æäº†G1æ”¶é›†å™¨çš„æ”¶é›†åŸç†ï¼Œç›¸æ¯”å…¶ä»–åƒåœ¾æ”¶é›†å™¨çš„ä¼˜åŠ¿ï¼Œæœ€åç»™å‡ºäº†ä¸€äº›è°ƒä¼˜å®è·µã€‚&lt;/p&gt;
&lt;h1 id=&quot;ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶&lt;/h1&gt;&lt;p&gt;é¦–å…ˆï¼Œåœ¨äº†è§£G1ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¸…æ¥šçš„çŸ¥é“ï¼Œåƒåœ¾å›æ”¶æ˜¯ä»€ä¹ˆï¼Ÿç®€å•çš„è¯´åƒåœ¾å›æ”¶å°±æ˜¯å›æ”¶å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚&lt;/p&gt;
&lt;p&gt;åƒåœ¾å›æ”¶çš„åŸºæœ¬æ­¥éª¤&lt;/p&gt;
&lt;p&gt;å›æ”¶çš„æ­¥éª¤æœ‰2æ­¥ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŸ¥æ‰¾å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡&lt;/li&gt;
&lt;li&gt;é‡Šæ”¾è¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥æ‰¾å†…å­˜ä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡&lt;/strong&gt;&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.top/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.top/tags/java/"/>
    
      <category term="G1" scheme="http://idiotsky.top/tags/G1/"/>
    
  </entry>
  
  <entry>
    <title>java ConcurrentHashMapè§£æ</title>
    <link href="http://idiotsky.top/2018/07/28/java-concurrenthashmap/"/>
    <id>http://idiotsky.top/2018/07/28/java-concurrenthashmap/</id>
    <published>2018-07-28T07:31:20.000Z</published>
    <updated>2018-09-13T12:06:17.276Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢</p>
</blockquote>
<h1 id="jdk6å’Œjdk7ä¸­çš„å®ç°"><a href="#jdk6å’Œjdk7ä¸­çš„å®ç°" class="headerlink" title="jdk6å’Œjdk7ä¸­çš„å®ç°"></a>jdk6å’Œjdk7ä¸­çš„å®ç°</h1><h2 id="è®¾è®¡æ€è·¯"><a href="#è®¾è®¡æ€è·¯" class="headerlink" title="è®¾è®¡æ€è·¯"></a>è®¾è®¡æ€è·¯</h2><p>ConcurrentHashMapé‡‡ç”¨äº†åˆ†æ®µé”çš„è®¾è®¡ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†æ®µå†…æ‰å­˜åœ¨ç«æ€å…³ç³»ï¼Œä¸åŒçš„åˆ†æ®µé”ä¹‹é—´æ²¡æœ‰é”ç«äº‰ã€‚ç›¸æ¯”äºå¯¹æ•´ä¸ªMapåŠ é”çš„è®¾è®¡ï¼Œåˆ†æ®µé”å¤§å¤§çš„æé«˜äº†é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å¤„ç†èƒ½åŠ›ã€‚ä½†åŒæ—¶ï¼Œç”±äºä¸æ˜¯å¯¹æ•´ä¸ªMapåŠ é”ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦æ‰«ææ•´ä¸ªMapçš„æ–¹æ³•ï¼ˆå¦‚size(), containsValue()ï¼‰éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„å®ç°ï¼Œå¦å¤–ä¸€äº›æ–¹æ³•ï¼ˆå¦‚clear()ï¼‰ç”šè‡³æ”¾å¼ƒäº†å¯¹ä¸€è‡´æ€§çš„è¦æ±‚ï¼ˆConcurrentHashMapæ˜¯å¼±ä¸€è‡´æ€§çš„ï¼‰ã€‚</p>
<p>ConcurrentHashMapä¸­çš„åˆ†æ®µé”ç§°ä¸ºSegmentï¼Œå®ƒå³ç±»ä¼¼äºHashMapçš„ç»“æ„ï¼Œå³å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªEntryæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼›åŒæ—¶åˆæ˜¯ä¸€ä¸ªReentrantLockï¼ˆSegmentç»§æ‰¿äº†ReentrantLockï¼‰ã€‚ConcurrentHashMapä¸­çš„HashEntryç›¸å¯¹äºHashMapä¸­çš„Entryæœ‰ä¸€å®šçš„å·®å¼‚æ€§ï¼šHashEntryä¸­çš„valueä»¥åŠnextéƒ½è¢«volatileä¿®é¥°ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹è¯»å†™è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒå®ƒä»¬çš„å¯è§æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HashEntry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        <span class="keyword">volatile</span> V value;</span><br><span class="line">        <span class="keyword">volatile</span> HashEntry&lt;K,V&gt; next;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="å¹¶å‘åº¦ï¼ˆConcurrency-Levelï¼‰"><a href="#å¹¶å‘åº¦ï¼ˆConcurrency-Levelï¼‰" class="headerlink" title="å¹¶å‘åº¦ï¼ˆConcurrency Levelï¼‰"></a>å¹¶å‘åº¦ï¼ˆConcurrency Levelï¼‰</h2><p>å¹¶å‘åº¦å¯ä»¥ç†è§£ä¸ºç¨‹åºè¿è¡Œæ—¶èƒ½å¤ŸåŒæ—¶æ›´æ–°ConccurentHashMapä¸”ä¸äº§ç”Ÿé”ç«äº‰çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯ConcurrentHashMapä¸­çš„åˆ†æ®µé”ä¸ªæ•°ï¼Œå³Segment[]çš„æ•°ç»„é•¿åº¦ã€‚ConcurrentHashMapé»˜è®¤çš„å¹¶å‘åº¦ä¸º16ï¼Œä½†ç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½®å¹¶å‘åº¦ã€‚å½“ç”¨æˆ·è®¾ç½®å¹¶å‘åº¦æ—¶ï¼ŒConcurrentHashMapä¼šä½¿ç”¨å¤§äºç­‰äºè¯¥å€¼çš„æœ€å°2å¹‚æŒ‡æ•°ä½œä¸ºå®é™…å¹¶å‘åº¦ï¼ˆå‡å¦‚ç”¨æˆ·è®¾ç½®å¹¶å‘åº¦ä¸º17ï¼Œå®é™…å¹¶å‘åº¦åˆ™ä¸º32ï¼‰ã€‚è¿è¡Œæ—¶é€šè¿‡å°†keyçš„é«˜nä½ï¼ˆ<code>n = 32 â€“ segmentShift</code>ï¼‰å’Œå¹¶å‘åº¦å‡1ï¼ˆsegmentMaskï¼‰åšä½ä¸è¿ç®—å®šä½åˆ°æ‰€åœ¨çš„Segmentã€‚segmentShiftä¸segmentMaskéƒ½æ˜¯åœ¨æ„é€ è¿‡ç¨‹ä¸­æ ¹æ®concurrency levelè¢«ç›¸åº”çš„è®¡ç®—å‡ºæ¥ã€‚</p>
<p>å¦‚æœå¹¶å‘åº¦è®¾ç½®çš„è¿‡å°ï¼Œä¼šå¸¦æ¥ä¸¥é‡çš„é”ç«äº‰é—®é¢˜ï¼›å¦‚æœå¹¶å‘åº¦è®¾ç½®çš„è¿‡å¤§ï¼ŒåŸæœ¬ä½äºåŒä¸€ä¸ªSegmentå†…çš„è®¿é—®ä¼šæ‰©æ•£åˆ°ä¸åŒçš„Segmentä¸­ï¼ŒCPU cacheå‘½ä¸­ç‡ä¼šä¸‹é™ï¼Œä»è€Œå¼•èµ·ç¨‹åºæ€§èƒ½ä¸‹é™ã€‚ï¼ˆæ–‡æ¡£çš„è¯´æ³•æ˜¯æ ¹æ®ä½ å¹¶å‘çš„çº¿ç¨‹æ•°é‡å†³å®šï¼Œå¤ªå¤šä¼šå¯¼æ€§èƒ½é™ä½ï¼‰</p>
<h2 id="åˆ›å»ºåˆ†æ®µé”"><a href="#åˆ›å»ºåˆ†æ®µé”" class="headerlink" title="åˆ›å»ºåˆ†æ®µé”"></a>åˆ›å»ºåˆ†æ®µé”</h2><p>å’ŒJDK6ä¸åŒï¼ŒJDK7ä¸­é™¤äº†ç¬¬ä¸€ä¸ªSegmentä¹‹å¤–ï¼Œå‰©ä½™çš„Segmentsé‡‡ç”¨çš„æ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„æœºåˆ¶ï¼šæ¯æ¬¡putä¹‹å‰éƒ½éœ€è¦æ£€æŸ¥keyå¯¹åº”çš„Segmentæ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ensureSegment()ä»¥ç¡®ä¿å¯¹åº”çš„Segmentè¢«åˆ›å»ºã€‚</p>
<p>ensureSegmentå¯èƒ½åœ¨å¹¶å‘ç¯å¢ƒä¸‹è¢«è°ƒç”¨ï¼Œä½†ä¸æƒ³è±¡ä¸­ä¸åŒï¼ŒensureSegmentå¹¶æœªä½¿ç”¨é”æ¥æ§åˆ¶ç«äº‰ï¼Œè€Œæ˜¯ä½¿ç”¨äº†Unsafeå¯¹è±¡çš„getObjectVolatile()æä¾›çš„åŸå­è¯»è¯­ä¹‰ç»“åˆCASæ¥ç¡®ä¿Segmentåˆ›å»ºçš„åŸå­æ€§ã€‚ä»£ç æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                == <span class="keyword">null</span>) &#123; <span class="comment">// recheck</span></span><br><span class="line">                Segment&lt;K,V&gt; s = <span class="keyword">new</span> Segment&lt;K,V&gt;(lf, threshold, tab);</span><br><span class="line">                <span class="keyword">while</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                       == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(ss, u, <span class="keyword">null</span>, seg = s))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="put-putIfAbsent-putAll"><a href="#put-putIfAbsent-putAll" class="headerlink" title="put/putIfAbsent/putAll"></a>put/putIfAbsent/putAll</h2><p>å’ŒJDK6ä¸€æ ·ï¼ŒConcurrentHashMapçš„putæ–¹æ³•è¢«ä»£ç†åˆ°äº†å¯¹åº”çš„Segmentï¼ˆå®šä½Segmentçš„åŸç†ä¹‹å‰å·²ç»æè¿°è¿‡ï¼‰ä¸­ã€‚ä¸JDK6ä¸åŒçš„æ˜¯ï¼ŒJDK7ç‰ˆæœ¬çš„ConcurrentHashMapåœ¨è·å¾—Segmenté”çš„è¿‡ç¨‹ä¸­ï¼Œåšäº†ä¸€å®šçš„ä¼˜åŒ– - åœ¨çœŸæ­£ç”³è¯·é”ä¹‹å‰ï¼Œputæ–¹æ³•ä¼šé€šè¿‡tryLock()æ–¹æ³•å°è¯•è·å¾—é”ï¼Œåœ¨å°è¯•è·å¾—é”çš„è¿‡ç¨‹ä¸­ä¼šå¯¹å¯¹åº”hashcodeçš„é“¾è¡¨è¿›è¡Œéå†ï¼Œå¦‚æœéå†å®Œæ¯•ä»ç„¶æ‰¾ä¸åˆ°ä¸keyç›¸åŒçš„HashEntryèŠ‚ç‚¹ï¼Œåˆ™ä¸ºåç»­çš„putæ“ä½œæå‰åˆ›å»ºä¸€ä¸ªHashEntryã€‚å½“tryLockä¸€å®šæ¬¡æ•°åä»æ— æ³•è·å¾—é”ï¼Œåˆ™é€šè¿‡lockç”³è¯·é”ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºåœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå…¶ä»–çº¿ç¨‹çš„putï¼Œrehashæˆ–è€…removeæ“ä½œå¯èƒ½ä¼šå¯¼è‡´é“¾è¡¨å¤´ç»“ç‚¹çš„å˜åŒ–ï¼Œå› æ­¤åœ¨è¿‡ç¨‹ä¸­éœ€è¦è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå¤´ç»“ç‚¹å‘ç”Ÿå˜åŒ–åˆ™é‡æ–°å¯¹è¡¨è¿›è¡Œéå†ã€‚è€Œå¦‚æœå…¶ä»–çº¿ç¨‹å¼•èµ·äº†é“¾è¡¨ä¸­çš„æŸä¸ªèŠ‚ç‚¹è¢«åˆ é™¤ï¼Œå³ä½¿è¯¥å˜åŒ–å› ä¸ºæ˜¯éåŸå­å†™æ“ä½œï¼ˆåˆ é™¤èŠ‚ç‚¹åé“¾æ¥åç»­èŠ‚ç‚¹è°ƒç”¨çš„æ˜¯Unsafe.putOrderedObject()ï¼Œè¯¥æ–¹æ³•ä¸æä¾›åŸå­å†™è¯­ä¹‰ï¼‰å¯èƒ½å¯¼è‡´å½“å‰çº¿ç¨‹æ— æ³•è§‚å¯Ÿåˆ°ï¼Œä½†å› ä¸ºä¸å½±å“éå†çš„æ­£ç¡®æ€§æ‰€ä»¥å¿½ç•¥ä¸è®¡ã€‚</p>
<p>ä¹‹æ‰€ä»¥åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­å¯¹æ•´ä¸ªé“¾è¡¨è¿›è¡Œéå†ï¼Œä¸»è¦ç›®çš„æ˜¯å¸Œæœ›éå†çš„é“¾è¡¨è¢«CPU cacheæ‰€ç¼“å­˜ï¼Œä¸ºåç»­å®é™…putè¿‡ç¨‹ä¸­çš„é“¾è¡¨éå†æ“ä½œæå‡æ€§èƒ½ã€‚</p>
<p>åœ¨è·å¾—é”ä¹‹åï¼ŒSegmentå¯¹é“¾è¡¨è¿›è¡Œéå†ï¼Œå¦‚æœæŸä¸ªHashEntryèŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„keyï¼Œåˆ™æ›´æ–°è¯¥HashEntryçš„valueå€¼ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ªHashEntryèŠ‚ç‚¹ï¼Œå°†å®ƒè®¾ç½®ä¸ºé“¾è¡¨çš„æ–°headèŠ‚ç‚¹å¹¶å°†åŸå¤´èŠ‚ç‚¹è®¾ä¸ºæ–°headçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚æ–°å»ºè¿‡ç¨‹ä¸­å¦‚æœèŠ‚ç‚¹æ€»æ•°ï¼ˆå«æ–°å»ºçš„HashEntryï¼‰è¶…è¿‡thresholdï¼Œåˆ™è°ƒç”¨rehash()æ–¹æ³•å¯¹Segmentè¿›è¡Œæ‰©å®¹ï¼Œæœ€åå°†æ–°å»ºHashEntryå†™å…¥åˆ°æ•°ç»„ä¸­ã€‚</p>
<p>putæ–¹æ³•ä¸­ï¼Œé“¾æ¥æ–°èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆHashEntry.setNext()ï¼‰ä»¥åŠå°†é“¾è¡¨å†™å…¥åˆ°æ•°ç»„ä¸­ï¼ˆsetEntryAt()ï¼‰éƒ½æ˜¯é€šè¿‡Unsafeçš„putOrderedObject()æ–¹æ³•æ¥å®ç°ï¼Œè¿™é‡Œå¹¶æœªä½¿ç”¨å…·æœ‰åŸå­å†™è¯­ä¹‰çš„putObjectVolatile()çš„åŸå› æ˜¯ï¼šJMMä¼šä¿è¯è·å¾—é”åˆ°é‡Šæ”¾é”ä¹‹é—´æ‰€æœ‰å¯¹è±¡çš„çŠ¶æ€æ›´æ–°éƒ½ä¼šåœ¨é”è¢«é‡Šæ”¾ä¹‹åæ›´æ–°åˆ°ä¸»å­˜ï¼Œä»è€Œä¿è¯è¿™äº›å˜æ›´å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚</p>
<h2 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h2><p>ç›¸å¯¹äºHashMapçš„resizeï¼ŒConcurrentHashMapçš„rehashåŸç†ç±»ä¼¼ï¼Œä½†æ˜¯Doug Leaä¸ºrehashåšäº†ä¸€å®šçš„ä¼˜åŒ–ï¼Œé¿å…è®©æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½è¿›è¡Œå¤åˆ¶æ“ä½œï¼šç”±äºæ‰©å®¹æ˜¯åŸºäº2çš„å¹‚æŒ‡æ¥æ“ä½œï¼Œå‡è®¾æ‰©å®¹å‰æŸHashEntryå¯¹åº”åˆ°Segmentä¸­æ•°ç»„çš„indexä¸ºiï¼Œæ•°ç»„çš„å®¹é‡ä¸ºcapacityï¼Œé‚£ä¹ˆæ‰©å®¹åè¯¥HashEntryå¯¹åº”åˆ°æ–°æ•°ç»„ä¸­çš„indexåªå¯èƒ½ä¸ºiæˆ–è€…i+capacityï¼Œå› æ­¤å¤§å¤šæ•°HashEntryèŠ‚ç‚¹åœ¨æ‰©å®¹å‰åindexå¯ä»¥ä¿æŒä¸å˜ã€‚åŸºäºæ­¤ï¼Œrehashæ–¹æ³•ä¸­ä¼šå®šä½ç¬¬ä¸€ä¸ªåç»­æ‰€æœ‰èŠ‚ç‚¹åœ¨æ‰©å®¹åindexéƒ½ä¿æŒä¸å˜çš„èŠ‚ç‚¹ï¼Œç„¶åå°†è¿™ä¸ªèŠ‚ç‚¹ä¹‹å‰çš„æ‰€æœ‰èŠ‚ç‚¹é‡æ’å³å¯ã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rehash</span><span class="params">(HashEntry&lt;K,V&gt; node)</span> </span>&#123;</span><br><span class="line">           HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">           <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">           <span class="keyword">int</span> newCapacity = oldCapacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">           threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor);</span><br><span class="line">           HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">               (HashEntry&lt;K,V&gt;[]) <span class="keyword">new</span> HashEntry[newCapacity];</span><br><span class="line">           <span class="keyword">int</span> sizeMask = newCapacity - <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">               HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">               <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">                   <span class="keyword">int</span> idx = e.hash &amp; sizeMask;</span><br><span class="line">                   <span class="keyword">if</span> (next == <span class="keyword">null</span>)   <span class="comment">//  Single node on list</span></span><br><span class="line">                       newTable[idx] = e;</span><br><span class="line">                   <span class="keyword">else</span> &#123; <span class="comment">// Reuse consecutive sequence at same slot</span></span><br><span class="line">                       HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                       <span class="keyword">int</span> lastIdx = idx;</span><br><span class="line">                       <span class="keyword">for</span> (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                            last != <span class="keyword">null</span>;</span><br><span class="line">                            last = last.next) &#123;</span><br><span class="line">                           <span class="keyword">int</span> k = last.hash &amp; sizeMask;</span><br><span class="line">                           <span class="keyword">if</span> (k != lastIdx) &#123;</span><br><span class="line">                               lastIdx = k;</span><br><span class="line">                               lastRun = last;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       newTable[lastIdx] = lastRun;</span><br><span class="line">                       <span class="comment">// Clone remaining nodes</span></span><br><span class="line">                       <span class="keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                           V v = p.value;</span><br><span class="line">                           <span class="keyword">int</span> h = p.hash;</span><br><span class="line">                           <span class="keyword">int</span> k = h &amp; sizeMask;</span><br><span class="line">                           HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                           newTable[k] = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">int</span> nodeIndex = node.hash &amp; sizeMask; <span class="comment">// add the new node</span></span><br><span class="line">           node.setNext(newTable[nodeIndex]);</span><br><span class="line">           newTable[nodeIndex] = node;</span><br><span class="line">           table = newTable;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><p>å’Œputç±»ä¼¼ï¼Œremoveåœ¨çœŸæ­£è·å¾—é”ä¹‹å‰ï¼Œä¹Ÿä¼šå¯¹é“¾è¡¨è¿›è¡Œéå†ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚</p>
<h2 id="getä¸containsKey"><a href="#getä¸containsKey" class="headerlink" title="getä¸containsKey"></a>getä¸containsKey</h2><p><code>get</code>ä¸<code>containsKey</code>ä¸¤ä¸ªæ–¹æ³•å‡ ä¹å®Œå…¨ä¸€è‡´ï¼šä»–ä»¬éƒ½æ²¡æœ‰ä½¿ç”¨é”ï¼Œè€Œæ˜¯é€šè¿‡Unsafeå¯¹è±¡çš„<code>getObjectVolatile()</code>æ–¹æ³•æä¾›çš„åŸå­è¯»è¯­ä¹‰ï¼Œæ¥è·å¾—Segmentä»¥åŠå¯¹åº”çš„é“¾è¡¨ï¼Œç„¶åå¯¹é“¾è¡¨éå†åˆ¤æ–­æ˜¯å¦å­˜åœ¨keyç›¸åŒçš„èŠ‚ç‚¹ä»¥åŠè·å¾—è¯¥èŠ‚ç‚¹çš„valueã€‚ä½†ç”±äºéå†è¿‡ç¨‹ä¸­å…¶ä»–çº¿ç¨‹å¯èƒ½å¯¹é“¾è¡¨ç»“æ„åšäº†è°ƒæ•´ï¼Œå› æ­¤<code>get</code>å’Œ<code>containsKey</code>è¿”å›çš„å¯èƒ½æ˜¯è¿‡æ—¶çš„æ•°æ®ï¼Œè¿™ä¸€ç‚¹æ˜¯ConcurrentHashMapåœ¨å¼±ä¸€è‡´æ€§ä¸Šçš„ä½“ç°ã€‚å¦‚æœè¦æ±‚å¼ºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆå¿…é¡»ä½¿ç”¨<code>Collections.synchronizedMap()</code>æ–¹æ³•ã€‚</p>
<h2 id="sizeã€containsValue"><a href="#sizeã€containsValue" class="headerlink" title="sizeã€containsValue"></a>sizeã€containsValue</h2><p>è¿™äº›æ–¹æ³•éƒ½æ˜¯åŸºäºæ•´ä¸ªConcurrentHashMapæ¥è¿›è¡Œæ“ä½œçš„ï¼Œä»–ä»¬çš„åŸç†ä¹ŸåŸºæœ¬ç±»ä¼¼ï¼šé¦–å…ˆä¸åŠ é”å¾ªç¯æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šå¾ªç¯æ‰€æœ‰çš„Segmentï¼ˆé€šè¿‡Unsafeçš„getObjectVolatile()ä»¥ä¿è¯åŸå­è¯»è¯­ä¹‰ï¼‰ï¼Œè·å¾—å¯¹åº”çš„å€¼ä»¥åŠæ‰€æœ‰Segmentçš„modcountä¹‹å’Œã€‚å¦‚æœè¿ç»­ä¸¤æ¬¡æ‰€æœ‰Segmentçš„modcountå’Œç›¸ç­‰ï¼Œåˆ™è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç”Ÿå…¶ä»–çº¿ç¨‹ä¿®æ”¹ConcurrentHashMapçš„æƒ…å†µï¼Œè¿”å›è·å¾—çš„å€¼ã€‚</p>
<p>å½“å¾ªç¯æ¬¡æ•°è¶…è¿‡é¢„å®šä¹‰çš„å€¼æ—¶ï¼Œè¿™æ—¶éœ€è¦å¯¹æ‰€æœ‰çš„Segmentä¾æ¬¡è¿›è¡ŒåŠ é”ï¼Œè·å–è¿”å›å€¼åå†ä¾æ¬¡è§£é”ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒåŠ é”è¿‡ç¨‹ä¸­è¦å¼ºåˆ¶åˆ›å»ºæ‰€æœ‰çš„Segmentï¼Œå¦åˆ™å®¹æ˜“å‡ºç°å…¶ä»–çº¿ç¨‹åˆ›å»ºSegmentå¹¶è¿›è¡Œputï¼Œremoveç­‰æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j =<span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line"></span><br><span class="line">ensureSegment(j).lock();<span class="comment">// force creation</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥é¿å…åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨sizeå’ŒcontainsValueæ–¹æ³•ã€‚</p>
<p>æ³¨1ï¼šmodcountåœ¨put, replace, removeä»¥åŠclearç­‰æ–¹æ³•ä¸­éƒ½ä¼šè¢«ä¿®æ”¹ã€‚</p>
<p>æ³¨2ï¼šå¯¹äºcontainsValueæ–¹æ³•æ¥è¯´ï¼Œå¦‚æœåœ¨å¾ªç¯è¿‡ç¨‹ä¸­å‘ç°åŒ¹é…valueçš„HashEntryï¼Œåˆ™ç›´æ¥è¿”å›trueã€‚</p>
<p>æœ€åï¼Œä¸HashMapä¸åŒçš„æ˜¯ï¼ŒConcurrentHashMapå¹¶ä¸å…è®¸keyæˆ–è€…valueä¸ºnullï¼ŒæŒ‰ç…§Doug Leaçš„è¯´æ³•ï¼Œè¿™ä¹ˆè®¾è®¡çš„åŸå› æ˜¯åœ¨ConcurrentHashMapä¸­ï¼Œä¸€æ—¦valueå‡ºç°nullï¼Œåˆ™ä»£è¡¨HashEntryçš„key/valueæ²¡æœ‰æ˜ å°„å®Œæˆå°±è¢«å…¶ä»–çº¿ç¨‹æ‰€è§ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚åœ¨JDK6ä¸­ï¼Œgetæ–¹æ³•çš„å®ç°ä¸­å°±æœ‰ä¸€æ®µå¯¹HashEntry.value == nullçš„é˜²å¾¡æ€§åˆ¤æ–­ã€‚ä½†Doug Leaä¹Ÿæ‰¿è®¤å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿™ç§æƒ…å†µä¼¼ä¹ä¸å¯èƒ½å‘ç”Ÿ</p>
<hr>
<h1 id="JDK8ä¸­çš„å®ç°"><a href="#JDK8ä¸­çš„å®ç°" class="headerlink" title="JDK8ä¸­çš„å®ç°"></a>JDK8ä¸­çš„å®ç°</h1><p>ConcurrentHashMapåœ¨JDK8ä¸­è¿›è¡Œäº†å·¨å¤§æ”¹åŠ¨ï¼Œå¾ˆéœ€è¦é€šè¿‡æºç æ¥å†æ¬¡å­¦ä¹ ä¸‹Doug Leaçš„å®ç°æ–¹æ³•ã€‚</p>
<p>å®ƒæ‘’å¼ƒäº†Segmentï¼ˆé”æ®µï¼‰çš„æ¦‚å¿µï¼Œè€Œæ˜¯å¯ç”¨äº†ä¸€ç§å…¨æ–°çš„æ–¹å¼å®ç°,åˆ©ç”¨CASç®—æ³•ã€‚å®ƒæ²¿ç”¨äº†ä¸å®ƒåŒæ—¶æœŸçš„HashMapç‰ˆæœ¬çš„æ€æƒ³ï¼Œåº•å±‚ä¾ç„¶ç”±â€œæ•°ç»„â€+é“¾è¡¨+çº¢é»‘æ ‘çš„æ–¹å¼æ€æƒ³ï¼Œä½†æ˜¯ä¸ºäº†åšåˆ°å¹¶å‘ï¼Œåˆå¢åŠ äº†å¾ˆå¤šè¾…åŠ©çš„ç±»ï¼Œä¾‹å¦‚TreeBinï¼ŒTraverserç­‰å¯¹è±¡å†…éƒ¨ç±»ã€‚</p>
<h2 id="é‡è¦çš„å±æ€§"><a href="#é‡è¦çš„å±æ€§" class="headerlink" title="é‡è¦çš„å±æ€§"></a>é‡è¦çš„å±æ€§</h2><p>é¦–å…ˆæ¥çœ‹å‡ ä¸ªé‡è¦çš„å±æ€§ï¼Œä¸HashMapç›¸åŒçš„å°±ä¸å†ä»‹ç»äº†ï¼Œè¿™é‡Œé‡ç‚¹è§£é‡Šä¸€ä¸‹sizeCtlè¿™ä¸ªå±æ€§ã€‚å¯ä»¥è¯´å®ƒæ˜¯ConcurrentHashMapä¸­å‡ºé•œç‡å¾ˆé«˜çš„ä¸€ä¸ªå±æ€§ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ§åˆ¶æ ‡è¯†ç¬¦ï¼Œåœ¨ä¸åŒçš„åœ°æ–¹æœ‰ä¸åŒç”¨é€”ï¼Œè€Œä¸”å®ƒçš„å–å€¼ä¸åŒï¼Œä¹Ÿä»£è¡¨ä¸åŒçš„å«ä¹‰ã€‚</p>
<ul>
<li>è´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹æ“ä½œ</li>
<li>-1ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–</li>
<li>-N è¡¨ç¤ºæœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</li>
<li>æ­£æ•°æˆ–0ä»£è¡¨hashè¡¨è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºåˆå§‹åŒ–æˆ–ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å°ï¼Œè¿™ä¸€ç‚¹ç±»ä¼¼äºæ‰©å®¹é˜ˆå€¼çš„æ¦‚å¿µã€‚è¿˜åé¢å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å€¼å§‹ç»ˆæ˜¯å½“å‰ConcurrentHashMapå®¹é‡çš„0.75å€ï¼Œè¿™ä¸loadfactoræ˜¯å¯¹åº”çš„ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç››è£…Nodeå…ƒç´ çš„æ•°ç»„ å®ƒçš„å¤§å°æ˜¯2çš„æ•´æ•°æ¬¡å¹‚</span></span><br><span class="line"><span class="comment">     * Size is always a power of two. Accessed directly by iterators.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table initialization and resizing control.  When negative, the</span></span><br><span class="line"><span class="comment">     * table is being initialized or resized: -1 for initialization,</span></span><br><span class="line"><span class="comment">     * else -(1 + the number of active resizing threads).  Otherwise,</span></span><br><span class="line"><span class="comment">     * when table is null, holds the initial table size to use upon</span></span><br><span class="line"><span class="comment">     * creation, or 0 for default. After initialization, holds the</span></span><br><span class="line"><span class="comment">     * next element count value upon which to resize the table.</span></span><br><span class="line"><span class="comment">     hashè¡¨åˆå§‹åŒ–æˆ–æ‰©å®¹æ—¶çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†é‡ã€‚</span></span><br><span class="line"><span class="comment">     è´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment">     -1ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     -N è¡¨ç¤ºæœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment">     æ­£æ•°æˆ–0ä»£è¡¨hashè¡¨è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºåˆå§‹åŒ–æˆ–ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å°</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl; </span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä¸¤ä¸ªæ˜¯ç”¨æ¥æ§åˆ¶æ‰©å®¹çš„æ—¶å€™ å•çº¿ç¨‹è¿›å…¥çš„å˜é‡</span></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of bits used for generation stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     * Must be at least 6 for 32bit arrays.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> RESIZE_STAMP_BITS = <span class="number">16</span>;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The bit shift for recording size stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESIZE_STAMP_SHIFT = <span class="number">32</span> - RESIZE_STAMP_BITS;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Encodings for Node hash fields. See above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hashå€¼æ˜¯-1ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªforwardNodeèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hashå€¼æ˜¯-2  è¡¨ç¤ºè¿™æ—¶ä¸€ä¸ªTreeBinèŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>
<h2 id="é‡è¦çš„ç±»"><a href="#é‡è¦çš„ç±»" class="headerlink" title="é‡è¦çš„ç±»"></a>é‡è¦çš„ç±»</h2><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>Nodeæ˜¯æœ€æ ¸å¿ƒçš„å†…éƒ¨ç±»ï¼Œå®ƒåŒ…è£…äº†key-valueé”®å€¼å¯¹ï¼Œæ‰€æœ‰æ’å…¥ConcurrentHashMapçš„æ•°æ®éƒ½åŒ…è£…åœ¨è¿™é‡Œé¢ã€‚å®ƒä¸HashMapä¸­çš„å®šä¹‰å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯ä½†æ˜¯æœ‰ä¸€äº›å·®åˆ«å®ƒå¯¹valueå’Œnextå±æ€§è®¾ç½®äº†volatileåŒæ­¥é”(ä¸JDK7çš„Segmentç›¸åŒ)ï¼Œå®ƒä¸å…è®¸è°ƒç”¨setValueæ–¹æ³•ç›´æ¥æ”¹å˜Nodeçš„valueåŸŸï¼Œå®ƒå¢åŠ äº†findæ–¹æ³•è¾…åŠ©map.get()æ–¹æ³•ã€‚</p>
<h3 id="TreeNode"><a href="#TreeNode" class="headerlink" title="TreeNode"></a>TreeNode</h3><p>æ ‘èŠ‚ç‚¹ç±»ï¼Œå¦å¤–ä¸€ä¸ªæ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚å½“é“¾è¡¨é•¿åº¦è¿‡é•¿çš„æ—¶å€™ï¼Œä¼šè½¬æ¢ä¸ºTreeNodeã€‚ä½†æ˜¯ä¸HashMapä¸ç›¸åŒçš„æ˜¯ï¼Œå®ƒå¹¶ä¸æ˜¯ç›´æ¥è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œè€Œæ˜¯æŠŠè¿™äº›ç»“ç‚¹åŒ…è£…æˆTreeNodeæ”¾åœ¨TreeBinå¯¹è±¡ä¸­ï¼Œç”±TreeBinå®Œæˆå¯¹çº¢é»‘æ ‘çš„åŒ…è£…ã€‚è€Œä¸”TreeNodeåœ¨ConcurrentHashMapé›†æˆè‡ªNodeç±»ï¼Œè€Œå¹¶éHashMapä¸­çš„é›†æˆè‡ªLinkedHashMap.Entry&lt;K,V&gt;ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´TreeNodeå¸¦æœ‰nextæŒ‡é’ˆï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯æ–¹ä¾¿åŸºäºTreeBinçš„è®¿é—®ã€‚</p>
<h3 id="TreeBin"><a href="#TreeBin" class="headerlink" title="TreeBin"></a>TreeBin</h3><p>è¿™ä¸ªç±»å¹¶ä¸è´Ÿè´£åŒ…è£…ç”¨æˆ·çš„keyã€valueä¿¡æ¯ï¼Œè€Œæ˜¯åŒ…è£…çš„å¾ˆå¤šTreeNodeèŠ‚ç‚¹ã€‚å®ƒä»£æ›¿äº†TreeNodeçš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å®é™…çš„ConcurrentHashMapâ€œæ•°ç»„â€ä¸­ï¼Œå­˜æ”¾çš„æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNodeå¯¹è±¡ï¼Œè¿™æ˜¯ä¸HashMapçš„åŒºåˆ«ã€‚å¦å¤–è¿™ä¸ªç±»è¿˜å¸¦æœ‰äº†è¯»å†™é”ã€‚</p>
<p>è¿™é‡Œä»…è´´å‡ºå®ƒçš„æ„é€ æ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°åœ¨æ„é€ TreeBinèŠ‚ç‚¹æ—¶ï¼Œä»…ä»…æŒ‡å®šäº†å®ƒçš„hashå€¼ä¸ºTREEBINå¸¸é‡ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ªæ ‡è¯†ä¸ºã€‚åŒæ—¶ä¹Ÿçœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„çº¢é»‘æ ‘æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates bin with initial set of nodes headed by b.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TreeBin(TreeNode&lt;K,V&gt; b) &#123;</span><br><span class="line">            <span class="keyword">super</span>(TREEBIN, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.first = b;</span><br><span class="line">            TreeNode&lt;K,V&gt; r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = b, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">                next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">                x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = <span class="keyword">null</span>;</span><br><span class="line">                    x.red = <span class="keyword">false</span>;</span><br><span class="line">                    r = x;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    K k = x.key;</span><br><span class="line">                    <span class="keyword">int</span> h = x.hash;</span><br><span class="line">                    Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = r;;) &#123;</span><br><span class="line">                        <span class="keyword">int</span> dir, ph;</span><br><span class="line">                        K pk = p.key;</span><br><span class="line">                        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                            dir = -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                            dir = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                  (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                                 (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                            dir = tieBreakOrder(k, pk);</span><br><span class="line">                            TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            x.parent = xp;</span><br><span class="line">                            <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                                xp.left = x;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                xp.right = x;</span><br><span class="line">                            r = balanceInsertion(r, x);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.root = r;</span><br><span class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ForwardingNode"><a href="#ForwardingNode" class="headerlink" title="ForwardingNode"></a>ForwardingNode</h3><p>ä¸€ä¸ªç”¨äºè¿æ¥ä¸¤ä¸ªtableçš„èŠ‚ç‚¹ç±»ã€‚å®ƒåŒ…å«ä¸€ä¸ªnextTableæŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘ä¸‹ä¸€å¼ è¡¨ã€‚è€Œä¸”è¿™ä¸ªèŠ‚ç‚¹çš„key value nextæŒ‡é’ˆå…¨éƒ¨ä¸ºnullï¼Œå®ƒçš„hashå€¼ä¸º-1. è¿™é‡Œé¢å®šä¹‰çš„findçš„æ–¹æ³•æ˜¯ä»nextTableé‡Œè¿›è¡ŒæŸ¥è¯¢èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯ä»¥è‡ªèº«ä¸ºå¤´èŠ‚ç‚¹è¿›è¡ŒæŸ¥æ‰¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A node inserted at head of bins during transfer operations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">        ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">            <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// loop to avoid arbitrarily deep recursion on forwarding nodes</span></span><br><span class="line">            outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;) &#123;</span><br><span class="line">                Node&lt;K,V&gt; e; <span class="keyword">int</span> n;</span><br><span class="line">                <span class="keyword">if</span> (k == <span class="keyword">null</span> || tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">                    (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    <span class="keyword">int</span> eh; K ek;</span><br><span class="line">                    <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp;</span><br><span class="line">                        ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                        <span class="keyword">return</span> e;</span><br><span class="line">                    <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                            tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                            <span class="keyword">continue</span> outer;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Unsafeä¸CAS"><a href="#Unsafeä¸CAS" class="headerlink" title="Unsafeä¸CAS"></a>Unsafeä¸CAS</h2><p>åœ¨ConcurrentHashMapä¸­ï¼Œéšå¤„å¯ä»¥çœ‹åˆ°<code>U</code>, å¤§é‡ä½¿ç”¨äº†<code>U.compareAndSwapXXX</code>çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åˆ©ç”¨ä¸€ä¸ªCASç®—æ³•å®ç°æ— é”åŒ–çš„ä¿®æ”¹å€¼çš„æ“ä½œï¼Œä»–å¯ä»¥å¤§å¤§é™ä½é”ä»£ç†çš„æ€§èƒ½æ¶ˆè€—ã€‚è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯ä¸æ–­åœ°å»æ¯”è¾ƒå½“å‰å†…å­˜ä¸­çš„å˜é‡å€¼ä¸ä½ æŒ‡å®šçš„ä¸€ä¸ªå˜é‡å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™æ¥å—ä½ æŒ‡å®šçš„ä¿®æ”¹çš„å€¼ï¼Œå¦åˆ™æ‹’ç»ä½ çš„æ“ä½œã€‚å› ä¸ºå½“å‰çº¿ç¨‹ä¸­çš„å€¼å·²ç»ä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œä½ çš„ä¿®æ”¹å¾ˆå¯èƒ½ä¼šè¦†ç›–æ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹çš„ç»“æœã€‚è¿™ä¸€ç‚¹ä¸ä¹è§‚é”ï¼ŒSVNçš„æ€æƒ³æ˜¯æ¯”è¾ƒç±»ä¼¼çš„ã€‚</p>
<h3 id="unsafeé™æ€å—"><a href="#unsafeé™æ€å—" class="headerlink" title="unsafeé™æ€å—"></a>unsafeé™æ€å—</h3><p>unsafeä»£ç å—æ§åˆ¶äº†ä¸€äº›å±æ€§çš„ä¿®æ”¹å·¥ä½œï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„SIZECTL ã€‚åœ¨è¿™ä¸€ç‰ˆæœ¬çš„concurrentHashMapä¸­ï¼Œå¤§é‡åº”ç”¨æ¥çš„CASæ–¹æ³•è¿›è¡Œå˜é‡ã€å±æ€§çš„ä¿®æ”¹å·¥ä½œã€‚åˆ©ç”¨CASè¿›è¡Œæ— é”æ“ä½œï¼Œå¯ä»¥å¤§å¤§æé«˜æ€§èƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SIZECTL;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TRANSFERINDEX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BASECOUNT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLSBUSY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLVALUE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ABASE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; k = ConcurrentHashMap.class;</span><br><span class="line">            SIZECTL = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"sizeCtl"</span>));</span><br><span class="line">            TRANSFERINDEX = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"transferIndex"</span>));</span><br><span class="line">            BASECOUNT = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"baseCount"</span>));</span><br><span class="line">            CELLSBUSY = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"cellsBusy"</span>));</span><br><span class="line">            Class&lt;?&gt; ck = CounterCell.class;</span><br><span class="line">            CELLVALUE = U.objectFieldOffset</span><br><span class="line">                (ck.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">            Class&lt;?&gt; ak = Node[].class;</span><br><span class="line">            ABASE = U.arrayBaseOffset(ak);</span><br><span class="line">            <span class="keyword">int</span> scale = U.arrayIndexScale(ak);</span><br><span class="line">            <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"data type scale not a power of two"</span>);</span><br><span class="line">            ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•"><a href="#ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•" class="headerlink" title="ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•"></a>ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•</h3><p>ConcurrentHashMapå®šä¹‰äº†ä¸‰ä¸ªåŸå­æ“ä½œï¼Œç”¨äºå¯¹æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚æ­£æ˜¯è¿™äº›åŸå­æ“ä½œä¿è¯äº†ConcurrentHashMapçš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å¾—åœ¨iä½ç½®ä¸Šçš„NodeèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//åˆ©ç”¨CASç®—æ³•è®¾ç½®iä½ç½®ä¸Šçš„NodeèŠ‚ç‚¹ã€‚ä¹‹æ‰€ä»¥èƒ½å®ç°å¹¶å‘æ˜¯å› ä¸ºä»–æŒ‡å®šäº†åŸæ¥è¿™ä¸ªèŠ‚ç‚¹çš„å€¼æ˜¯å¤šå°‘</span></span><br><span class="line">		<span class="comment">//åœ¨CASç®—æ³•ä¸­ï¼Œä¼šæ¯”è¾ƒå†…å­˜ä¸­çš„å€¼ä¸ä½ æŒ‡å®šçš„è¿™ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰æ‰æ¥å—ä½ çš„ä¿®æ”¹ï¼Œå¦åˆ™æ‹’ç»ä½ çš„ä¿®æ”¹</span></span><br><span class="line">		<span class="comment">//å› æ­¤å½“å‰çº¿ç¨‹ä¸­çš„å€¼å¹¶ä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œè¿™ç§ä¿®æ”¹å¯èƒ½ä¼šè¦†ç›–æ‰å…¶ä»–çº¿ç¨‹çš„ä¿®æ”¹ç»“æœ  æœ‰ç‚¹ç±»ä¼¼äºSVN</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//åˆ©ç”¨volatileæ–¹æ³•è®¾ç½®èŠ‚ç‚¹ä½ç½®çš„å€¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–æ–¹æ³•initTable"><a href="#åˆå§‹åŒ–æ–¹æ³•initTable" class="headerlink" title="åˆå§‹åŒ–æ–¹æ³•initTable"></a>åˆå§‹åŒ–æ–¹æ³•initTable</h3><p>å¯¹äºConcurrentHashMapæ¥è¯´ï¼Œè°ƒç”¨å®ƒçš„æ„é€ æ–¹æ³•ä»…ä»…æ˜¯è®¾ç½®äº†ä¸€äº›å‚æ•°è€Œå·²ã€‚è€Œæ•´ä¸ªtableçš„åˆå§‹åŒ–æ˜¯åœ¨å‘ConcurrentHashMapä¸­æ’å…¥å…ƒç´ çš„æ—¶å€™å‘ç”Ÿçš„ã€‚å¦‚è°ƒç”¨putã€computeIfAbsentã€computeã€mergeç­‰æ–¹æ³•çš„æ—¶å€™ï¼Œè°ƒç”¨æ—¶æœºæ˜¯æ£€æŸ¥table==nullã€‚</p>
<p>åˆå§‹åŒ–æ–¹æ³•ä¸»è¦åº”ç”¨äº†å…³é”®å±æ€§sizeCtl å¦‚æœè¿™ä¸ªå€¼ã€ˆ0ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–ï¼Œå°±æ”¾å¼ƒè¿™ä¸ªæ“ä½œã€‚åœ¨è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºConcurrentHashMapçš„åˆå§‹åŒ–åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆã€‚å¦‚æœè·å¾—äº†åˆå§‹åŒ–æƒé™ï¼Œå°±ç”¨CASæ–¹æ³•å°†sizeCtlç½®ä¸º-1ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹è¿›å…¥ã€‚åˆå§‹åŒ–æ•°ç»„åï¼Œå°†sizeCtlçš„å€¼æ”¹ä¸º0.75*nã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes table, using the size recorded in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        		<span class="comment">//sizeCtlè¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼ŒæŠŠçº¿ç¨‹æŒ‚èµ·ã€‚å¯¹äºtableçš„åˆå§‹åŒ–å·¥ä½œï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿›è¡Œã€‚</span></span><br><span class="line">            <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">                Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;<span class="comment">//åˆ©ç”¨CASæ–¹æ³•æŠŠsizectlçš„å€¼ç½®ä¸º-1 è¡¨ç¤ºæœ¬çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = tab = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);<span class="comment">//ç›¸å½“äº0.75*n è®¾ç½®ä¸€ä¸ªæ‰©å®¹çš„é˜ˆå€¼</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tab;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‰©å®¹æ–¹æ³•-transfer"><a href="#æ‰©å®¹æ–¹æ³•-transfer" class="headerlink" title="æ‰©å®¹æ–¹æ³• transfer"></a>æ‰©å®¹æ–¹æ³• transfer</h3><p>å½“ConcurrentHashMapå®¹é‡ä¸è¶³çš„æ—¶å€™ï¼Œéœ€è¦å¯¹tableè¿›è¡Œæ‰©å®¹ã€‚è¿™ä¸ªæ–¹æ³•çš„åŸºæœ¬æ€æƒ³è·ŸHashMapæ˜¯å¾ˆåƒçš„ï¼Œä½†æ˜¯ç”±äºå®ƒæ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œæ‰€ä»¥è¦å¤æ‚çš„å¤šã€‚åŸå› æ˜¯å®ƒæ”¯æŒå¤šçº¿ç¨‹è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè€Œå¹¶æ²¡æœ‰åŠ é”ã€‚æˆ‘æƒ³è¿™æ ·åšçš„ç›®çš„ä¸ä»…ä»…æ˜¯ä¸ºäº†æ»¡è¶³concurrentçš„è¦æ±‚ï¼Œè€Œæ˜¯å¸Œæœ›åˆ©ç”¨å¹¶å‘å¤„ç†å»å‡å°‘æ‰©å®¹å¸¦æ¥çš„æ—¶é—´å½±å“ã€‚å› ä¸ºåœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œæ€»æ˜¯ä¼šæ¶‰åŠåˆ°ä»ä¸€ä¸ªâ€œæ•°ç»„â€åˆ°å¦ä¸€ä¸ªâ€œæ•°ç»„â€æ‹·è´çš„æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ“ä½œèƒ½å¤Ÿå¹¶å‘è¿›è¡Œï¼Œé‚£çœŸçœŸæ˜¯æå¥½çš„äº†ã€‚</p>
<p>æ•´ä¸ªæ‰©å®¹æ“ä½œåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<ul>
<li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ„å»ºä¸€ä¸ªnextTable,å®ƒçš„å®¹é‡æ˜¯åŸæ¥çš„ä¸¤å€ï¼Œè¿™ä¸ªæ“ä½œæ˜¯å•çº¿ç¨‹å®Œæˆçš„ã€‚è¿™ä¸ªå•çº¿ç¨‹çš„ä¿è¯æ˜¯é€šè¿‡RESIZE_STAMP_SHIFTè¿™ä¸ªå¸¸é‡ç»è¿‡ä¸€æ¬¡è¿ç®—æ¥ä¿è¯çš„ï¼Œè¿™ä¸ªåœ°æ–¹åœ¨åé¢ä¼šæœ‰æåˆ°ï¼›</li>
<li>ç¬¬äºŒä¸ªéƒ¨åˆ†å°±æ˜¯å°†åŸæ¥tableä¸­çš„å…ƒç´ å¤åˆ¶åˆ°nextTableä¸­ï¼Œè¿™é‡Œå…è®¸å¤šçº¿ç¨‹è¿›è¡Œæ“ä½œã€‚</li>
</ul>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹å•çº¿ç¨‹æ˜¯å¦‚ä½•å®Œæˆçš„ï¼š</p>
<p>å®ƒçš„å¤§ä½“æ€æƒ³å°±æ˜¯éå†ã€å¤åˆ¶çš„è¿‡ç¨‹ã€‚é¦–å…ˆæ ¹æ®è¿ç®—å¾—åˆ°éœ€è¦éå†çš„æ¬¡æ•°iï¼Œç„¶ååˆ©ç”¨tabAtæ–¹æ³•è·å¾—iä½ç½®çš„å…ƒç´ ï¼š</p>
<ul>
<li>å¦‚æœè¿™ä¸ªä½ç½®ä¸ºç©ºï¼Œå°±åœ¨åŸtableä¸­çš„iä½ç½®æ”¾å…¥forwardNodeèŠ‚ç‚¹ï¼Œè¿™ä¸ªä¹Ÿæ˜¯è§¦å‘å¹¶å‘æ‰©å®¹çš„å…³é”®ç‚¹ï¼›</li>
<li>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯NodeèŠ‚ç‚¹ï¼ˆfh&gt;=0ï¼‰ï¼Œå¦‚æœå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œå°±æ„é€ ä¸€ä¸ªååºé“¾è¡¨ï¼ŒæŠŠä»–ä»¬åˆ†åˆ«æ”¾åœ¨nextTableçš„iå’Œi+nçš„ä½ç½®ä¸Š</li>
<li>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯TreeBinèŠ‚ç‚¹ï¼ˆfh&lt;0ï¼‰ï¼Œä¹Ÿåšä¸€ä¸ªååºå¤„ç†ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦untreefiï¼ŒæŠŠå¤„ç†çš„ç»“æœåˆ†åˆ«æ”¾åœ¨nextTableçš„iå’Œi+nçš„ä½ç½®ä¸Š</li>
<li>éå†è¿‡æ‰€æœ‰çš„èŠ‚ç‚¹ä»¥åå°±å®Œæˆäº†å¤åˆ¶å·¥ä½œï¼Œè¿™æ—¶è®©nextTableä½œä¸ºæ–°çš„tableï¼Œå¹¶ä¸”æ›´æ–°sizeCtlä¸ºæ–°å®¹é‡çš„0.75å€ ï¼Œå®Œæˆæ‰©å®¹ã€‚</li>
</ul>
<p>å†çœ‹ä¸€ä¸‹å¤šçº¿ç¨‹æ˜¯å¦‚ä½•å®Œæˆçš„ï¼š</p>
<p>åœ¨ä»£ç çš„69è¡Œæœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœéå†åˆ°çš„èŠ‚ç‚¹æ˜¯forwardèŠ‚ç‚¹ï¼Œå°±å‘åç»§ç»­éå†ï¼Œå†åŠ ä¸Šç»™èŠ‚ç‚¹ä¸Šé”çš„æœºåˆ¶ï¼Œå°±å®Œæˆäº†å¤šçº¿ç¨‹çš„æ§åˆ¶ã€‚å¤šçº¿ç¨‹éå†èŠ‚ç‚¹ï¼Œå¤„ç†äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æŠŠå¯¹åº”ç‚¹çš„å€¼setä¸ºforwardï¼Œå¦ä¸€ä¸ªçº¿ç¨‹çœ‹åˆ°forwardï¼Œå°±å‘åéå†ã€‚è¿™æ ·äº¤å‰å°±å®Œæˆäº†å¤åˆ¶å·¥ä½œã€‚è€Œä¸”è¿˜å¾ˆå¥½çš„è§£å†³äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚ è¿™ä¸ªæ–¹æ³•çš„è®¾è®¡å®åœ¨æ˜¯è®©æˆ‘è†œæ‹œã€‚</p>
<p><a href="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg" target="_blank" rel="noopener"><img src="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg" alt=""></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸€ä¸ªè¿‡æ¸¡çš„tableè¡¨  åªæœ‰åœ¨æ‰©å®¹çš„æ—¶å€™æ‰ä¼šä½¿ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Moves and/or copies the nodes in each bin to new table. See</span></span><br><span class="line"><span class="comment">     * above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">        <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">            stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">        <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];<span class="comment">//æ„é€ ä¸€ä¸ªnextTableå¯¹è±¡ å®ƒçš„å®¹é‡æ˜¯åŸæ¥çš„ä¸¤å€</span></span><br><span class="line">                nextTab = nt;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">                sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nextTable = nextTab;</span><br><span class="line">            transferIndex = n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">        ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);<span class="comment">//æ„é€ ä¸€ä¸ªè¿èŠ‚ç‚¹æŒ‡é’ˆ ç”¨äºæ ‡å¿—ä½</span></span><br><span class="line">        <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;<span class="comment">//å¹¶å‘æ‰©å®¹çš„å…³é”®å±æ€§ å¦‚æœç­‰äºtrue è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹å·²ç»å¤„ç†è¿‡</span></span><br><span class="line">        <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">            <span class="comment">//è¿™ä¸ªwhileå¾ªç¯ä½“çš„ä½œç”¨å°±æ˜¯åœ¨æ§åˆ¶i--  é€šè¿‡i--å¯ä»¥ä¾æ¬¡éå†åŸhashè¡¨ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">                <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    i = -<span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                         (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                          nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                       nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                    bound = nextBound;</span><br><span class="line">                    i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">                <span class="keyword">int</span> sc;</span><br><span class="line">                <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                	<span class="comment">//å¦‚æœæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å·²ç»å®Œæˆå¤åˆ¶å·¥ä½œ  å°±æŠŠnextTableèµ‹å€¼ç»™table æ¸…ç©ºä¸´æ—¶å¯¹è±¡nextTable</span></span><br><span class="line">                    nextTable = <span class="keyword">null</span>;</span><br><span class="line">                    table = nextTab;</span><br><span class="line">                    sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);<span class="comment">//æ‰©å®¹é˜ˆå€¼è®¾ç½®ä¸ºåŸæ¥å®¹é‡çš„1.5å€  ä¾ç„¶ç›¸å½“äºç°åœ¨å®¹é‡çš„0.75å€</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//åˆ©ç”¨CASæ–¹æ³•æ›´æ–°è¿™ä¸ªæ‰©å®¹é˜ˆå€¼ï¼Œåœ¨è¿™é‡Œé¢sizectlå€¼å‡ä¸€ï¼Œè¯´æ˜æ–°åŠ å…¥ä¸€ä¸ªçº¿ç¨‹å‚ä¸åˆ°æ‰©å®¹æ“ä½œ</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                    i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœéå†åˆ°çš„èŠ‚ç‚¹ä¸ºç©º åˆ™æ”¾å…¥ForwardingNodeæŒ‡é’ˆ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">                advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">            <span class="comment">//å¦‚æœéå†åˆ°ForwardingNodeèŠ‚ç‚¹  è¯´æ˜è¿™ä¸ªç‚¹å·²ç»è¢«å¤„ç†è¿‡äº† ç›´æ¥è·³è¿‡  è¿™é‡Œæ˜¯æ§åˆ¶å¹¶å‘æ‰©å®¹çš„æ ¸å¿ƒ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">            		<span class="comment">//èŠ‚ç‚¹ä¸Šé”</span></span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                        <span class="comment">//å¦‚æœfh&gt;=0 è¯æ˜è¿™æ˜¯ä¸€ä¸ªNodeèŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                            <span class="comment">//ä»¥ä¸‹çš„éƒ¨åˆ†åœ¨å®Œæˆçš„å·¥ä½œæ˜¯æ„é€ ä¸¤ä¸ªé“¾è¡¨  ä¸€ä¸ªæ˜¯åŸé“¾è¡¨  å¦ä¸€ä¸ªæ˜¯åŸé“¾è¡¨çš„ååºæ’åˆ—</span></span><br><span class="line">                            Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                                <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                    runBit = b;</span><br><span class="line">                                    lastRun = p;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                                ln = lastRun;</span><br><span class="line">                                hn = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                hn = lastRun;</span><br><span class="line">                                ln = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                                <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                    ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„iä½ç½®ä¸Šæ’å…¥ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„i+nçš„ä½ç½®ä¸Šæ’å…¥å¦ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                            <span class="comment">//åœ¨tableçš„iä½ç½®ä¸Šæ’å…¥forwardNodeèŠ‚ç‚¹  è¡¨ç¤ºå·²ç»å¤„ç†è¿‡è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            <span class="comment">//è®¾ç½®advanceä¸ºtrue è¿”å›åˆ°ä¸Šé¢çš„whileå¾ªç¯ä¸­ å°±å¯ä»¥æ‰§è¡Œi--æ“ä½œ</span></span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//å¯¹TreeBinå¯¹è±¡è¿›è¡Œå¤„ç†  ä¸ä¸Šé¢çš„è¿‡ç¨‹ç±»ä¼¼</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                            TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                            <span class="comment">//æ„é€ æ­£åºå’Œååºä¸¤ä¸ªé“¾è¡¨</span></span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                                TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                    (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        lo = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        loTail.next = p;</span><br><span class="line">                                    loTail = p;</span><br><span class="line">                                    ++lc;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        hi = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        hiTail.next = p;</span><br><span class="line">                                    hiTail = p;</span><br><span class="line">                                    ++hc;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//å¦‚æœæ‰©å®¹åå·²ç»ä¸å†éœ€è¦treeçš„ç»“æ„ åå‘è½¬æ¢ä¸ºé“¾è¡¨ç»“æ„</span></span><br><span class="line">                            ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                                (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                            hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                                (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                             <span class="comment">//åœ¨nextTableçš„iä½ç½®ä¸Šæ’å…¥ä¸€ä¸ªé“¾è¡¨    </span></span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„i+nçš„ä½ç½®ä¸Šæ’å…¥å¦ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                             <span class="comment">//åœ¨tableçš„iä½ç½®ä¸Šæ’å…¥forwardNodeèŠ‚ç‚¹  è¡¨ç¤ºå·²ç»å¤„ç†è¿‡è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            <span class="comment">//è®¾ç½®advanceä¸ºtrue è¿”å›åˆ°ä¸Šé¢çš„whileå¾ªç¯ä¸­ å°±å¯ä»¥æ‰§è¡Œi--æ“ä½œ</span></span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Putæ–¹æ³•"><a href="#Putæ–¹æ³•" class="headerlink" title="Putæ–¹æ³•"></a>Putæ–¹æ³•</h2><p>å‰é¢çš„æ‰€æœ‰çš„ä»‹ç»å…¶å®éƒ½ä¸ºè¿™ä¸ªæ–¹æ³•åšé“ºå«ã€‚ConcurrentHashMapæœ€å¸¸ç”¨çš„å°±æ˜¯putå’Œgetä¸¤ä¸ªæ–¹æ³•ã€‚ç°åœ¨æ¥ä»‹ç»putæ–¹æ³•ï¼Œè¿™ä¸ªputæ–¹æ³•ä¾ç„¶æ²¿ç”¨HashMapçš„putæ–¹æ³•çš„æ€æƒ³ï¼Œæ ¹æ®hashå€¼è®¡ç®—è¿™ä¸ªæ–°æ’å…¥çš„ç‚¹åœ¨tableä¸­çš„ä½ç½®iï¼Œå¦‚æœiä½ç½®æ˜¯ç©ºçš„ï¼Œç›´æ¥æ”¾è¿›å»ï¼Œå¦åˆ™è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœiä½ç½®æ˜¯æ ‘èŠ‚ç‚¹ï¼ŒæŒ‰ç…§æ ‘çš„æ–¹å¼æ’å…¥æ–°çš„èŠ‚ç‚¹ï¼Œå¦åˆ™æŠŠiæ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚ConcurrentHashMapä¸­ä¾ç„¶æ²¿ç”¨è¿™ä¸ªæ€æƒ³ï¼Œæœ‰ä¸€ä¸ªæœ€é‡è¦çš„ä¸åŒç‚¹å°±æ˜¯ConcurrentHashMapä¸å…è®¸keyæˆ–valueä¸ºnullå€¼ã€‚å¦å¤–ç”±äºæ¶‰åŠåˆ°å¤šçº¿ç¨‹ï¼Œputæ–¹æ³•å°±è¦å¤æ‚ä¸€ç‚¹ã€‚åœ¨å¤šçº¿ç¨‹ä¸­å¯èƒ½æœ‰ä»¥ä¸‹ä¸¤ä¸ªæƒ…å†µ</p>
<ol>
<li><p>å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ­£åœ¨å¯¹ConcurrentHashMapè¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå½“å‰çº¿ç¨‹ä¹Ÿè¦è¿›å…¥æ‰©å®¹çš„æ“ä½œä¸­ã€‚è¿™ä¸ªæ‰©å®¹çš„æ“ä½œä¹‹æ‰€ä»¥èƒ½è¢«æ£€æµ‹åˆ°ï¼Œæ˜¯å› ä¸ºtransferæ–¹æ³•ä¸­åœ¨ç©ºç»“ç‚¹ä¸Šæ’å…¥forwardèŠ‚ç‚¹ï¼Œå¦‚æœæ£€æµ‹åˆ°éœ€è¦æ’å…¥çš„ä½ç½®è¢«forwardèŠ‚ç‚¹å æœ‰ï¼Œå°±å¸®åŠ©è¿›è¡Œæ‰©å®¹ï¼›</p>
</li>
<li><p>å¦‚æœæ£€æµ‹åˆ°è¦æ’å…¥çš„èŠ‚ç‚¹æ˜¯éç©ºä¸”ä¸æ˜¯forwardèŠ‚ç‚¹ï¼Œå°±å¯¹è¿™ä¸ªèŠ‚ç‚¹åŠ é”ï¼Œè¿™æ ·å°±ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡è¿™ä¸ªæœ‰ä¸€äº›å½±å“æ•ˆç‡ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæ¯”hashTableçš„synchronizedè¦å¥½å¾—å¤šã€‚</p>
</li>
</ol>
<p>æ•´ä½“æµç¨‹å°±æ˜¯é¦–å…ˆå®šä¹‰ä¸å…è®¸keyæˆ–valueä¸ºnullçš„æƒ…å†µæ”¾å…¥  å¯¹äºæ¯ä¸€ä¸ªæ”¾å…¥çš„å€¼ï¼Œé¦–å…ˆåˆ©ç”¨spreadæ–¹æ³•å¯¹keyçš„hashcodeè¿›è¡Œä¸€æ¬¡hashè®¡ç®—ï¼Œç”±æ­¤æ¥ç¡®å®šè¿™ä¸ªå€¼åœ¨tableä¸­çš„ä½ç½®ã€‚</p>
<p>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç›´æ¥æ”¾å…¥ï¼Œè€Œä¸”ä¸éœ€è¦åŠ é”æ“ä½œã€‚</p>
<p> å¦‚æœè¿™ä¸ªä½ç½®å­˜åœ¨ç»“ç‚¹ï¼Œè¯´æ˜å‘ç”Ÿäº†hashç¢°æ’ï¼Œé¦–å…ˆåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ç±»å‹ã€‚å¦‚æœæ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼ˆfh&gt;0ï¼‰,åˆ™å¾—åˆ°çš„ç»“ç‚¹å°±æ˜¯hashå€¼ç›¸åŒçš„èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚éœ€è¦ä¾æ¬¡å‘åéå†ç¡®å®šè¿™ä¸ªæ–°åŠ å…¥çš„å€¼æ‰€åœ¨ä½ç½®ã€‚å¦‚æœé‡åˆ°hashå€¼ä¸keyå€¼éƒ½ä¸æ–°åŠ å…¥èŠ‚ç‚¹æ˜¯ä¸€è‡´çš„æƒ…å†µï¼Œåˆ™åªéœ€è¦æ›´æ–°valueå€¼å³å¯ã€‚å¦åˆ™ä¾æ¬¡å‘åéå†ï¼Œç›´åˆ°é“¾è¡¨å°¾æ’å…¥è¿™ä¸ªç»“ç‚¹ã€‚å¦‚æœåŠ å…¥è¿™ä¸ªèŠ‚ç‚¹ä»¥åé“¾è¡¨é•¿åº¦å¤§äº8ï¼Œå°±æŠŠè¿™ä¸ªé“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ã€‚å¦‚æœè¿™ä¸ªèŠ‚ç‚¹çš„ç±»å‹å·²ç»æ˜¯æ ‘èŠ‚ç‚¹çš„è¯ï¼Œç›´æ¥è°ƒç”¨æ ‘èŠ‚ç‚¹çš„æ’å…¥æ–¹æ³•è¿›è¡Œæ’å…¥æ–°çš„å€¼ã€‚</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** Implementation for put and putIfAbsent */</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">   		<span class="comment">//ä¸å…è®¸ keyæˆ–valueä¸ºnull</span></span><br><span class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">       <span class="comment">//è®¡ç®—hashå€¼</span></span><br><span class="line">       <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">       <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">//æ­»å¾ªç¯ ä½•æ—¶æ’å…¥æˆåŠŸ ä½•æ—¶è·³å‡º</span></span><br><span class="line">       <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">           Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">           <span class="comment">//å¦‚æœtableä¸ºç©ºçš„è¯ï¼Œåˆå§‹åŒ–table</span></span><br><span class="line">           <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">               tab = initTable();</span><br><span class="line">           <span class="comment">//æ ¹æ®hashå€¼è®¡ç®—å‡ºåœ¨tableé‡Œé¢çš„ä½ç½® </span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">           	<span class="comment">//å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰å€¼ ï¼Œç›´æ¥æ”¾è¿›å»ï¼Œä¸éœ€è¦åŠ é”</span></span><br><span class="line">               <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                   <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//å½“é‡åˆ°è¡¨è¿æ¥ç‚¹æ—¶ï¼Œéœ€è¦è¿›è¡Œæ•´åˆè¡¨çš„æ“ä½œ</span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">               tab = helpTransfer(tab, f);</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               V oldVal = <span class="keyword">null</span>;</span><br><span class="line">               <span class="comment">//ç»“ç‚¹ä¸Šé”  è¿™é‡Œçš„ç»“ç‚¹å¯ä»¥ç†è§£ä¸ºhashå€¼ç›¸åŒç»„æˆçš„é“¾è¡¨çš„å¤´ç»“ç‚¹</span></span><br><span class="line">               <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                       <span class="comment">//fhã€‰0 è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé“¾è¡¨çš„èŠ‚ç‚¹ ä¸æ˜¯æ ‘çš„èŠ‚ç‚¹</span></span><br><span class="line">                       <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                           binCount = <span class="number">1</span>;</span><br><span class="line">                           <span class="comment">//åœ¨è¿™é‡Œéå†é“¾è¡¨æ‰€æœ‰çš„ç»“ç‚¹</span></span><br><span class="line">                           <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                               K ek;</span><br><span class="line">                               <span class="comment">//å¦‚æœhashå€¼å’Œkeyå€¼ç›¸åŒ  åˆ™ä¿®æ”¹å¯¹åº”ç»“ç‚¹çš„valueå€¼</span></span><br><span class="line">                               <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                   ((ek = e.key) == key ||</span><br><span class="line">                                    (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                   oldVal = e.val;</span><br><span class="line">                                   <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                       e.val = value;</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                               Node&lt;K,V&gt; pred = e;</span><br><span class="line">                               <span class="comment">//å¦‚æœéå†åˆ°äº†æœ€åä¸€ä¸ªç»“ç‚¹ï¼Œé‚£ä¹ˆå°±è¯æ˜æ–°çš„èŠ‚ç‚¹éœ€è¦æ’å…¥ å°±æŠŠå®ƒæ’å…¥åœ¨é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">                               <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                   pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                             value, <span class="keyword">null</span>);</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">//å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ˜¯æ ‘èŠ‚ç‚¹ï¼Œå°±æŒ‰ç…§æ ‘çš„æ–¹å¼æ’å…¥å€¼</span></span><br><span class="line">                       <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                           Node&lt;K,V&gt; p;</span><br><span class="line">                           binCount = <span class="number">2</span>;</span><br><span class="line">                           <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                          value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               oldVal = p.val;</span><br><span class="line">                               <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                   p.val = value;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">               	<span class="comment">//å¦‚æœé“¾è¡¨é•¿åº¦å·²ç»è¾¾åˆ°ä¸´ç•Œå€¼8 å°±éœ€è¦æŠŠé“¾è¡¨è½¬æ¢ä¸ºæ ‘ç»“æ„</span></span><br><span class="line">                   <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                       treeifyBin(tab, i);</span><br><span class="line">                   <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                       <span class="keyword">return</span> oldVal;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//å°†å½“å‰ConcurrentHashMapçš„å…ƒç´ æ•°é‡+1</span></span><br><span class="line">       addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°JDK8ä¸­çš„å®ç°ä¹Ÿæ˜¯é”åˆ†ç¦»çš„æ€æƒ³ï¼Œåªæ˜¯é”ä½çš„æ˜¯ä¸€ä¸ªNodeï¼Œè€Œä¸æ˜¯JDK7ä¸­çš„Segmentï¼Œè€Œé”ä½Nodeä¹‹å‰çš„æ“ä½œæ˜¯æ— é”çš„å¹¶ä¸”ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå»ºç«‹åœ¨ä¹‹å‰æåˆ°çš„3ä¸ªåŸå­æ“ä½œä¸Šã€‚</p>
<h3 id="helpTransferæ–¹æ³•"><a href="#helpTransferæ–¹æ³•" class="headerlink" title="helpTransferæ–¹æ³•"></a>helpTransferæ–¹æ³•</h3><p>è¿™æ˜¯ä¸€ä¸ªååŠ©æ‰©å®¹çš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå½“å‰ConcurrentHashMapä¸€å®šå·²ç»æœ‰äº†nextTableå¯¹è±¡ï¼Œé¦–å…ˆæ‹¿åˆ°è¿™ä¸ªnextTableå¯¹è±¡ï¼Œè°ƒç”¨transferæ–¹æ³•ã€‚å›çœ‹ä¸Šé¢çš„transferæ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå½“æœ¬çº¿ç¨‹è¿›å…¥æ‰©å®¹æ–¹æ³•çš„æ—¶å€™ä¼šç›´æ¥è¿›å…¥å¤åˆ¶é˜¶æ®µã€‚</p>
<h3 id="treeifyBinæ–¹æ³•"><a href="#treeifyBinæ–¹æ³•" class="headerlink" title="treeifyBinæ–¹æ³•"></a>treeifyBinæ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•ç”¨äºå°†è¿‡é•¿çš„é“¾è¡¨è½¬æ¢ä¸ºTreeBinå¯¹è±¡ã€‚ä½†æ˜¯ä»–å¹¶ä¸æ˜¯ç›´æ¥è½¬æ¢ï¼Œè€Œæ˜¯è¿›è¡Œä¸€æ¬¡å®¹é‡åˆ¤æ–­ï¼Œå¦‚æœå®¹é‡æ²¡æœ‰è¾¾åˆ°è½¬æ¢çš„è¦æ±‚ï¼Œç›´æ¥è¿›è¡Œæ‰©å®¹æ“ä½œå¹¶è¿”å›ï¼›å¦‚æœæ»¡è¶³æ¡ä»¶æ‰é“¾è¡¨çš„ç»“æ„æŠ“æ¢ä¸ºTreeBin ï¼Œè¿™ä¸HashMapä¸åŒçš„æ˜¯ï¼Œå®ƒå¹¶æ²¡æœ‰æŠŠTreeNodeç›´æ¥æ”¾å…¥çº¢é»‘æ ‘ï¼Œè€Œæ˜¯åˆ©ç”¨äº†TreeBinè¿™ä¸ªå°å®¹å™¨æ¥å°è£…æ‰€æœ‰çš„TreeNode.</p>
<h2 id="getæ–¹æ³•"><a href="#getæ–¹æ³•" class="headerlink" title="getæ–¹æ³•"></a>getæ–¹æ³•</h2><p>getæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œç»™å®šä¸€ä¸ªkeyæ¥ç¡®å®švalueçš„æ—¶å€™ï¼Œå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶  keyç›¸åŒ  hashå€¼ç›¸åŒï¼Œå¯¹äºèŠ‚ç‚¹å¯èƒ½åœ¨é“¾è¡¨æˆ–æ ‘ä¸Šçš„æƒ…å†µï¼Œéœ€è¦åˆ†åˆ«å»æŸ¥æ‰¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">        <span class="comment">//è®¡ç®—hashå€¼</span></span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        <span class="comment">//æ ¹æ®hashå€¼ç¡®å®šèŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæœç´¢åˆ°çš„èŠ‚ç‚¹keyä¸ä¼ å…¥çš„keyç›¸åŒä¸”ä¸ä¸ºnull,ç›´æ¥è¿”å›è¿™ä¸ªèŠ‚ç‚¹	</span></span><br><span class="line">            <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœeh&lt;0 è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹åœ¨æ ‘ä¸Š ç›´æ¥å¯»æ‰¾</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">             <span class="comment">//å¦åˆ™éå†é“¾è¡¨ æ‰¾åˆ°å¯¹åº”çš„å€¼å¹¶è¿”å›</span></span><br><span class="line">            <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sizeç›¸å…³çš„æ–¹æ³•"><a href="#Sizeç›¸å…³çš„æ–¹æ³•" class="headerlink" title="Sizeç›¸å…³çš„æ–¹æ³•"></a>Sizeç›¸å…³çš„æ–¹æ³•</h2><p>å¯¹äºConcurrentHashMapæ¥è¯´ï¼Œè¿™ä¸ªtableé‡Œåˆ°åº•è£…äº†å¤šå°‘ä¸œè¥¿å…¶å®æ˜¯ä¸ªä¸ç¡®å®šçš„æ•°é‡ï¼Œå› ä¸ºä¸å¯èƒ½åœ¨è°ƒç”¨size()æ–¹æ³•çš„æ—¶å€™åƒGCçš„â€œstop the worldâ€ä¸€æ ·è®©å…¶ä»–çº¿ç¨‹éƒ½åœä¸‹æ¥è®©ä½ å»ç»Ÿè®¡ï¼Œå› æ­¤åªèƒ½è¯´è¿™ä¸ªæ•°é‡æ˜¯ä¸ªä¼°è®¡å€¼ã€‚å¯¹äºè¿™ä¸ªä¼°è®¡å€¼ï¼ŒConcurrentHashMapä¹Ÿæ˜¯å¤§è´¹å‘¨ç« æ‰è®¡ç®—å‡ºæ¥çš„ã€‚</p>
<h3 id="è¾…åŠ©å®šä¹‰"><a href="#è¾…åŠ©å®šä¹‰" class="headerlink" title="è¾…åŠ©å®šä¹‰"></a>è¾…åŠ©å®šä¹‰</h3><p>ä¸ºäº†ç»Ÿè®¡å…ƒç´ ä¸ªæ•°ï¼ŒConcurrentHashMapå®šä¹‰äº†ä¸€äº›å˜é‡å’Œä¸€ä¸ªå†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A padded cell for distributing counts.  Adapted from LongAdder</span></span><br><span class="line"><span class="comment">     * and Striped64.  See their internal docs for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">        CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/******************************************/</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®é™…ä¸Šä¿å­˜çš„æ˜¯hashmapä¸­çš„å…ƒç´ ä¸ªæ•°  åˆ©ç”¨CASé”è¿›è¡Œæ›´æ–°</span></span><br><span class="line"><span class="comment">     ä½†å®ƒå¹¶ä¸ç”¨è¿”å›å½“å‰hashmapçš„å…ƒç´ ä¸ªæ•° </span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spinlock (locked via CAS) used when resizing and/or creating CounterCells.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table of counter cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure>
<h3 id="mappingCountä¸Sizeæ–¹æ³•"><a href="#mappingCountä¸Sizeæ–¹æ³•" class="headerlink" title="mappingCountä¸Sizeæ–¹æ³•"></a>mappingCountä¸Sizeæ–¹æ³•</h3><p>mappingCountä¸sizeæ–¹æ³•çš„ç±»ä¼¼  ä»Javaå·¥ç¨‹å¸ˆç»™å‡ºçš„æ³¨é‡Šæ¥çœ‹ï¼Œåº”è¯¥ä½¿ç”¨mappingCountä»£æ›¿sizeæ–¹æ³• ä¸¤ä¸ªæ–¹æ³•éƒ½æ²¡æœ‰ç›´æ¥è¿”å›basecount è€Œæ˜¯ç»Ÿè®¡ä¸€æ¬¡è¿™ä¸ªå€¼ï¼Œè€Œè¿™ä¸ªå€¼å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå¤§æ¦‚çš„æ•°å€¼ï¼Œå› æ­¤å¯èƒ½åœ¨ç»Ÿè®¡çš„æ—¶å€™æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰§è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">                (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">                (<span class="keyword">int</span>)n);</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of mappings. This method should be used</span></span><br><span class="line"><span class="comment">     * instead of &#123;<span class="doctag">@link</span> #size&#125; because a ConcurrentHashMap may</span></span><br><span class="line"><span class="comment">     * contain more mappings than can be represented as an int. The</span></span><br><span class="line"><span class="comment">     * value returned is an estimate; the actual count may differ if</span></span><br><span class="line"><span class="comment">     * there are concurrent insertions or removals.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of mappings</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">mappingCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0L</span>) ? <span class="number">0L</span> : n; <span class="comment">// ignore transient negative values</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">        <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">        <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                    sum += a.value;<span class="comment">//æ‰€æœ‰counterçš„å€¼æ±‚å’Œ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="addCountæ–¹æ³•"><a href="#addCountæ–¹æ³•" class="headerlink" title="addCountæ–¹æ³•"></a>addCountæ–¹æ³•</h3><p>åœ¨putæ–¹æ³•ç»“å°¾å¤„è°ƒç”¨äº†addCountæ–¹æ³•ï¼ŒæŠŠå½“å‰ConcurrentHashMapçš„å…ƒç´ ä¸ªæ•°+1è¿™ä¸ªæ–¹æ³•ä¸€å…±åšäº†ä¸¤ä»¶äº‹,æ›´æ–°baseCountçš„å€¼ï¼Œæ£€æµ‹æ˜¯å¦è¿›è¡Œæ‰©å®¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">        CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">        <span class="comment">//åˆ©ç”¨CASæ–¹æ³•æ›´æ–°baseCountçš„å€¼ </span></span><br><span class="line">        <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">            !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">            CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">            <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">                (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">                !(uncontended =</span><br><span class="line">                  U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">                fullAddCount(x, uncontended);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœcheckå€¼å¤§äºç­‰äº0 åˆ™éœ€è¦æ£€éªŒæ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">            <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">                <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                        sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                        transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                     <span class="comment">//å¦‚æœå·²ç»æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                        transfer(tab, nt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å½“å‰çº¿ç¨‹æ˜¯å”¯ä¸€çš„æˆ–æ˜¯ç¬¬ä¸€ä¸ªå‘èµ·æ‰©å®¹çš„çº¿ç¨‹  æ­¤æ—¶nextTable=null</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                             (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                    transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">                s = sumCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>JDK6,7ä¸­çš„ConcurrentHashmapä¸»è¦ä½¿ç”¨Segmentæ¥å®ç°å‡å°é”ç²’åº¦ï¼ŒæŠŠHashMapåˆ†å‰²æˆè‹¥å¹²ä¸ªSegmentï¼Œåœ¨putçš„æ—¶å€™éœ€è¦é”ä½Segmentï¼Œgetæ—¶å€™ä¸åŠ é”ï¼Œä½¿ç”¨volatileæ¥ä¿è¯å¯è§æ€§ï¼Œå½“è¦ç»Ÿè®¡å…¨å±€æ—¶ï¼ˆæ¯”å¦‚sizeï¼‰ï¼Œé¦–å…ˆä¼šå°è¯•å¤šæ¬¡è®¡ç®—modcountæ¥ç¡®å®šï¼Œè¿™å‡ æ¬¡å°è¯•ä¸­ï¼Œæ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¿®æ”¹æ“ä½œï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›sizeã€‚å¦‚æœæœ‰ï¼Œåˆ™éœ€è¦ä¾æ¬¡é”ä½æ‰€æœ‰çš„Segmentæ¥è®¡ç®—ã€‚</p>
<p>jdk7ä¸­ConcurrentHashmapä¸­ï¼Œå½“é•¿åº¦è¿‡é•¿ç¢°æ’ä¼šå¾ˆé¢‘ç¹ï¼Œé“¾è¡¨çš„å¢æ”¹åˆ æŸ¥æ“ä½œéƒ½ä¼šæ¶ˆè€—å¾ˆé•¿çš„æ—¶é—´ï¼Œå½±å“æ€§èƒ½,æ‰€ä»¥jdk8 ä¸­å®Œå…¨é‡å†™äº†concurrentHashmap,ä»£ç é‡ä»åŸæ¥çš„1000å¤šè¡Œå˜æˆäº† 6000å¤š è¡Œï¼Œå®ç°ä¸Šä¹Ÿå’ŒåŸæ¥çš„åˆ†æ®µå¼å­˜å‚¨æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚</p>
<p>ä¸»è¦è®¾è®¡ä¸Šçš„å˜åŒ–æœ‰ä»¥ä¸‹å‡ ç‚¹: </p>
<ol>
<li>ä¸é‡‡ç”¨segmentè€Œé‡‡ç”¨nodeï¼Œé”ä½nodeæ¥å®ç°å‡å°é”ç²’åº¦ã€‚</li>
<li>è®¾è®¡äº†MOVEDçŠ¶æ€ å½“resizeçš„ä¸­è¿‡ç¨‹ä¸­ çº¿ç¨‹2è¿˜åœ¨putæ•°æ®ï¼Œçº¿ç¨‹2ä¼šå¸®åŠ©resizeã€‚<br>3, ä½¿ç”¨3ä¸ªCASæ“ä½œæ¥ç¡®ä¿nodeçš„ä¸€äº›æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ç§æ–¹å¼ä»£æ›¿äº†é”ã€‚</li>
<li>sizeCtlçš„ä¸åŒå€¼æ¥ä»£è¡¨ä¸åŒå«ä¹‰ï¼Œèµ·åˆ°äº†æ§åˆ¶çš„ä½œç”¨ã€‚</li>
</ol>
<p>è‡³äºä¸ºä»€ä¹ˆJDK8ä¸­ä½¿ç”¨synchronizedè€Œä¸æ˜¯ReentrantLockï¼Œæ˜¯å› ä¸ºJDK8ä¸­å¯¹synchronizedæœ‰äº†è¶³å¤Ÿçš„ä¼˜åŒ–å§ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.jianshu.com/p/4806633fcc55" target="_blank" rel="noopener">http://www.jianshu.com/p/4806633fcc55</a></p>
<p><a href="http://blog.csdn.net/u010723709/article/details/48007881" target="_blank" rel="noopener">http://blog.csdn.net/u010723709/article/details/48007881</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;jdk6å’Œjdk7ä¸­çš„å®ç°&quot;&gt;&lt;a href=&quot;#jdk6å’Œjdk7ä¸­çš„å®ç°&quot; class=&quot;headerlink&quot; title=&quot;jdk6å’Œjdk7ä¸­çš„å®ç°&quot;&gt;&lt;/a&gt;jdk6å’Œjdk7ä¸­çš„å®ç°&lt;/h1&gt;&lt;h2 id=&quot;è®¾è®¡æ€è·¯&quot;&gt;&lt;a href=&quot;#è®¾è®¡æ€è·¯&quot; class=&quot;headerlink&quot; title=&quot;è®¾è®¡æ€è·¯&quot;&gt;&lt;/a&gt;è®¾è®¡æ€è·¯&lt;/h2&gt;&lt;p&gt;ConcurrentHashMapé‡‡ç”¨äº†åˆ†æ®µé”çš„è®¾è®¡ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†æ®µå†…æ‰å­˜åœ¨ç«æ€å…³ç³»ï¼Œä¸åŒçš„åˆ†æ®µé”ä¹‹é—´æ²¡æœ‰é”ç«äº‰ã€‚ç›¸æ¯”äºå¯¹æ•´ä¸ªMapåŠ é”çš„è®¾è®¡ï¼Œåˆ†æ®µé”å¤§å¤§çš„æé«˜äº†é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å¤„ç†èƒ½åŠ›ã€‚ä½†åŒæ—¶ï¼Œç”±äºä¸æ˜¯å¯¹æ•´ä¸ªMapåŠ é”ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦æ‰«ææ•´ä¸ªMapçš„æ–¹æ³•ï¼ˆå¦‚size(), containsValue()ï¼‰éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„å®ç°ï¼Œå¦å¤–ä¸€äº›æ–¹æ³•ï¼ˆå¦‚clear()ï¼‰ç”šè‡³æ”¾å¼ƒäº†å¯¹ä¸€è‡´æ€§çš„è¦æ±‚ï¼ˆConcurrentHashMapæ˜¯å¼±ä¸€è‡´æ€§çš„ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;ConcurrentHashMapä¸­çš„åˆ†æ®µé”ç§°ä¸ºSegmentï¼Œå®ƒå³ç±»ä¼¼äºHashMapçš„ç»“æ„ï¼Œå³å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªEntryæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼›åŒæ—¶åˆæ˜¯ä¸€ä¸ªReentrantLockï¼ˆSegmentç»§æ‰¿äº†ReentrantLockï¼‰ã€‚ConcurrentHashMapä¸­çš„HashEntryç›¸å¯¹äºHashMapä¸­çš„Entryæœ‰ä¸€å®šçš„å·®å¼‚æ€§ï¼šHashEntryä¸­çš„valueä»¥åŠnextéƒ½è¢«volatileä¿®é¥°ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹è¯»å†™è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒå®ƒä»¬çš„å¯è§æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HashEntry&lt;/span&gt;&amp;lt;&lt;span class=&quot;title&quot;&gt;K&lt;/span&gt;,&lt;span class=&quot;title&quot;&gt;V&lt;/span&gt;&amp;gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; hash;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; K key;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;volatile&lt;/span&gt; V value;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;volatile&lt;/span&gt; HashEntry&amp;lt;K,V&amp;gt; next;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.top/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.top/tags/java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://idiotsky.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="conccurenthashmap" scheme="http://idiotsky.top/tags/conccurenthashmap/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªå¾ˆå¥½ç†è§£raftçš„åŠ¨ç”»æ¼”ç¤º</title>
    <link href="http://idiotsky.top/2018/07/24/understanding-raft/"/>
    <id>http://idiotsky.top/2018/07/24/understanding-raft/</id>
    <published>2018-07-24T13:23:16.000Z</published>
    <updated>2018-09-17T15:38:54.995Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>å¾ˆå¥½ç†è§£çš„åŠ¨ç”»ï¼Œä¸€çœ‹å°±æ‡‚äº†ğŸ‘¿</p>
</blockquote>
<iframe src="http://idiotsky.top/raft/raft/index.html" style="width:100%;height:700px;border-width: 0px;"><br></iframe>

<a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å¾ˆå¥½ç†è§£çš„åŠ¨ç”»ï¼Œä¸€çœ‹å°±æ‡‚äº†ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;iframe src=&quot;http://idiotsky.top/raft/raft/index.html&quot; style=&quot;width:100%;height:700px;border-width: 0px;&quot;&gt;&lt;br&gt;&lt;/iframe&gt;
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://idiotsky.top/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="raft" scheme="http://idiotsky.top/tags/raft/"/>
    
  </entry>
  
  <entry>
    <title>Paxosç¤ºä¾‹</title>
    <link href="http://idiotsky.top/2018/07/24/paxos-example/"/>
    <id>http://idiotsky.top/2018/07/24/paxos-example/</id>
    <published>2018-07-24T12:11:55.000Z</published>
    <updated>2018-07-26T01:25:04.105Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« é€šè¿‡ä¸€ä¸ªæœ‰æ•ˆçš„ä¾‹å­æè¿°äº†ä¸€ä¸ªåä¸ºPaxos çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ã€‚</p>
<p>åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ç”¨äºä½¿ä¸€ç»„è®¡ç®—æœºèƒ½å¤Ÿå°±å•ä¸ªå€¼è¾¾æˆä¸€è‡´ï¼Œä¾‹å¦‚é€šå¸¸ä½¿ç”¨ä¸¤é˜¶æ®µæˆ–ä¸‰é˜¶æ®µæäº¤åšå‡ºçš„æäº¤æˆ–å›æ»šå†³ç­–ã€‚åªè¦é€‰æ‹©ä¸€ä¸ªå€¼ï¼Œç®—æ³•çš„å…¶ä»–å€¼å°±æ²¡æœ‰å…³ç³»äº†ã€‚</p>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿™å¾ˆéš¾ï¼Œå› ä¸ºæœºå™¨ä¹‹é—´çš„æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±æˆ–æ— é™æœŸå»¶è¿Ÿï¼Œæˆ–è€…æœºå™¨æœ¬èº«å¯èƒ½ä¼šå‘ç”Ÿæ•…éšœã€‚</p>
<p>Paxosä¿è¯èŠ‚ç‚¹åªä¼šé€‰æ‹©å•ä¸ªå€¼ï¼ˆæ„å‘³ç€å®ƒä¿è¯å®‰å…¨ï¼‰ï¼Œä½†ä¸ä¿è¯åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸å¯ç”¨æ—¶èƒ½ä¸èƒ½å»åˆ°å€¼</p>
<a id="more"></a>
<h1 id="ä¸€èˆ¬çš„åšæ³•"><a href="#ä¸€èˆ¬çš„åšæ³•" class="headerlink" title="ä¸€èˆ¬çš„åšæ³•"></a>ä¸€èˆ¬çš„åšæ³•</h1><p>ä¸€ä¸ªPaxosçš„èŠ‚ç‚¹å¯ä»¥é‡‡å–ä»»ä½•æˆ–æ‰€æœ‰ä¸‰ä¸ªè§’è‰²ï¼š<code>proposer</code>ï¼Œ<code>acceptor</code>å’Œ<code>learner</code>ã€‚</p>
<p>ä¸€ä¸ª<code>proposer</code>æè®®ä¸€ä¸ªå€¼æ˜¯éœ€è¦åŒæ„æ‰è¡Œçš„ï¼Œå®ƒå‘ä¸€ä¸ªåŒ…å«å€¼çš„æè®®ç»™æ‰€æœ‰çš„<code>acceptor</code>ï¼Œ<code>acceptor</code>å†³å®šæ˜¯å¦åŒæ„è¿™ä¸ªå€¼ã€‚</p>
<p>æ¯ä¸ª<code>acceptor</code>ç‹¬ç«‹é€‰æ‹©ä¸€ä¸ªå€¼â€“å®ƒå¯èƒ½æ”¶åˆ°å¤šä¸ªæ¥è‡ªä¸åŒ<code>proposer</code>çš„æè®®â€“å¹¶å°†å…¶å†³å®šå‘é€ç»™<code>learner</code>ï¼Œä»¥ç¡®å®šæ˜¯å¦å·²æ¥å—ä»»ä½•å€¼ã€‚</p>
<p>å¯¹äºPaxosæ¥å—çš„å€¼ï¼Œå¤§å¤šæ•°<code>acceptor</code>å¿…é¡»é€‰æ‹©ç›¸åŒçš„å€¼ã€‚å®é™…ä¸Šï¼Œå•ä¸ªèŠ‚ç‚¹å¯ä»¥æ‰¿æ‹…è®¸å¤šæˆ–æ‰€æœ‰è¿™äº›è§’è‰²ï¼Œä½†åœ¨æœ¬èŠ‚çš„ç¤ºä¾‹ä¸­ï¼Œæ¯ä¸ªè§’è‰²éƒ½åœ¨ä¸€ä¸ªå•ç‹¬çš„èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><a href="http://idiotsky.top/images3/paxos-example.png"><img src="http://idiotsky.top/images3/paxos-example.png" alt=""></a></p>
<center>å›¾1ï¼šåŸºæœ¬Paxosæ¶æ„ã€‚ä¸€äº›<code>proposer</code>å‘<code>acceptor</code>æå‡ºå»ºè®®ã€‚å½“<code>acceptor</code>æ¥å—ä¸€ä¸ªå€¼æ—¶ï¼Œå®ƒä¼šå°†ç»“æœå‘é€ç»™<code>learner</code>èŠ‚ç‚¹ã€‚<br></center>

<h1 id="Paxosç¤ºä¾‹"><a href="#Paxosç¤ºä¾‹" class="headerlink" title="Paxosç¤ºä¾‹"></a>Paxosç¤ºä¾‹</h1><p>åœ¨æ ‡å‡†çš„Paxosç®—æ³•ä¸­ï¼Œ<code>proposer</code>å‘<code>acceptor</code>å‘é€ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯ï¼š<strong>å‡†å¤‡</strong>å’Œ<strong>æ¥å—</strong>è¯·æ±‚ã€‚</p>
<p>åœ¨è¯¥ç®—æ³•çš„ç¬¬ä¸€é˜¶æ®µï¼Œ<code>proposer</code>å‘æ¯ä¸ª<code>acceptor</code>å‘é€åŒ…å«å»ºè®®å€¼vå’Œæè®®å·nçš„å‡†å¤‡è¯·æ±‚ã€‚</p>
<p>å¯¹äºå…¶ä»–<code>proposer</code>çš„ææ¡ˆå·ï¼Œæ¯ä¸ª<code>proposer</code>çš„æè®®å·å¿…é¡»æ˜¯æ­£æ•°çš„ï¼Œå•è°ƒé€’å¢çš„ï¼Œå”¯ä¸€çš„ï¼Œè‡ªç„¶çš„æ•°å­—ã€‚</p>
<p>åœ¨ä¸‹é¢è¯´æ˜çš„ç¤ºä¾‹ä¸­ï¼Œæœ‰ä¸¤ä¸ª<code>proposer</code>ï¼Œä¸¤ä¸ªéƒ½æå‡ºå‡†å¤‡è¯·æ±‚ã€‚æ¥è‡ª<code>proposer A</code>çš„è¯·æ±‚å’Œæ¥è‡ª<code>proposer B</code>çš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾<code>acceptor X</code>å’Œ<code>acceptor Y</code>ï¼Œè€Œæ¥è‡ª<code>proposer B</code>çš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾<code>acceptor Z</code>ã€‚</p>
<p><a href="http://idiotsky.top/images3/paxos-example-1.png"><img src="http://idiotsky.top/images3/paxos-example-1.png" alt=""></a></p>
<center>å›¾2ï¼šproposer Aå’ŒBå„è‡ªå‘æ¯ä¸ªæ¥å—è€…å‘é€å‡†å¤‡è¯·æ±‚ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œproposer Açš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾æ¥acceptor Xå’ŒYï¼Œè€Œproposer Bçš„è¯·æ±‚é¦–å…ˆåˆ°è¾¾acceptor Z.</center>

<p>å¦‚æœæ¥æ”¶å‡†å¤‡è¯·æ±‚çš„<code>acceptor</code>æ²¡æœ‰çœ‹åˆ°å¦ä¸€ä¸ªæè®®ï¼Œåˆ™<code>acceptor</code>ä»¥å‡†å¤‡å“åº”ä½œå‡ºå“åº”ï¼Œè¯¥å‡†å¤‡å“åº”æ‰¿è¯ºæ°¸è¿œä¸æ¥å—å…·æœ‰è¾ƒä½æè®®ç¼–å·çš„å¦ä¸€æè®®ã€‚</p>
<p>è¿™åœ¨ä¸‹é¢çš„å›¾3ä¸­è¯´æ˜ï¼Œå…¶æ˜¾ç¤ºäº†æ¯ä¸ªæ¥å—è€…å¯¹ä»–ä»¬æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªå‡†å¤‡è¯·æ±‚çš„å“åº”ã€‚</p>
<p><a href="http://idiotsky.top/images3/paxos-example-2.png"><img src="http://idiotsky.top/images3/paxos-example-2.png" alt=""></a></p>
<center>å›¾3ï¼šæ¯ä¸ª<code>acceptor</code>å“åº”å®ƒæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªå‡†å¤‡è¯·æ±‚æ¶ˆæ¯ã€‚</center>

<p>æœ€ç»ˆï¼Œ<code>acceptor Z</code>æ¥æ”¶<code>proposer A</code>çš„è¯·æ±‚ï¼Œ<code>acceptor X</code>å’Œ<code>acceptor Y</code>æ¥æ”¶<code>proposer B</code>çš„è¯·æ±‚ã€‚</p>
<p>å¦‚æœ<code>acceptor</code>å·²ç»çœ‹åˆ°å…·æœ‰æ›´é«˜æè®®å·çš„è¯·æ±‚ï¼Œåˆ™å¿½ç•¥å‡†å¤‡è¯·æ±‚ï¼Œ<code>proposer A</code>å¯¹<code>acceptor Z</code>çš„è¯·æ±‚å°±æ˜¯è¿™ç§æƒ…å†µã€‚</p>
<p>å¦‚æœ<code>acceptor</code>æ²¡æœ‰çœ‹åˆ°æ›´é«˜ç¼–å·çš„è¯·æ±‚ï¼Œå®ƒå†æ¬¡æ‰¿è¯ºå¿½ç•¥å…·æœ‰è¾ƒä½æè®®ç¼–å·çš„ä»»ä½•è¯·æ±‚ï¼Œå¹¶å‘å›å…¶å·²æ¥å—çš„ç¼–å·æœ€é«˜çš„æè®®ä»¥åŠè¯¥æè®®çš„å€¼ã€‚</p>
<p><code>proposer B</code>å¯¹<code>acceptor X</code>å’Œ<code>acceptor Y</code>çš„è¯·æ±‚å°±æ˜¯è¿™ç§æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="http://idiotsky.top/images3/paxos-example-3.png"><img src="http://idiotsky.top/images3/paxos-example-3.png" alt=""></a></p>
<center>å›¾4ï¼šacceptor Zå¿½ç•¥äº†proposer Açš„è¯·æ±‚ï¼Œå› ä¸ºå®ƒå·²ç»çœ‹åˆ°äº†æ›´é«˜ç¼–å·çš„æè®®ï¼ˆ4&gt; 2ï¼‰ã€‚acceptor Xå’ŒYç”¨ä»–ä»¬å…ˆå‰ç¡®è®¤çš„æœ€é«˜è¯·æ±‚æ¥å“åº”proposer Bçš„è¯·æ±‚ï¼Œå¹¶æ‰¿è¯ºå¿½ç•¥ä»»ä½•ç¼–å·è¾ƒä½çš„æè®®ã€‚</center>

<p>ä¸€æ—¦<code>proposer</code>æ”¶åˆ°å¤§å¤šæ•°<code>acceptor</code>çš„å‡†å¤‡å“åº”ï¼Œå®ƒå°±å¯ä»¥å‘å‡ºæ¥å—è¯·æ±‚ã€‚</p>
<p>ç”±äº<code>proposer A</code>ä»…æ”¶åˆ°è¡¨æ˜æ²¡æœ‰å…ˆå‰ææ¡ˆ<code>[no previous]</code>çš„å“åº”ï¼Œå› æ­¤å®ƒå‘<code>acceptor</code>å‘é€ä¸åˆå§‹ææ¡ˆç›¸åŒçš„æè®®ç¼–å·å’Œå€¼çš„æ¥å—è¯·æ±‚ï¼ˆn = 2ï¼Œv = 8ï¼‰ã€‚</p>
<p>ç„¶è€Œï¼Œè¿™äº›è¯·æ±‚è¢«æ¯ä¸€ä¸ª<code>acceptor</code>å¿½ç•¥ï¼Œå› ä¸º<code>acceptor</code>éƒ½æ‰¿è¯ºä¸æ¥å—çš„æè®®å·ä½äºè¯·æ±‚4ï¼ˆå“åº”å‡†å¤‡è¯·æ±‚ç»™<code>proposer B</code>ï¼‰ã€‚</p>
<p><code>proposer B</code>å‘æ¯ä¸ª<code>acceptor</code>å‘é€åŒ…å«å…¶å…ˆå‰ä½¿ç”¨çš„æè®®å·ï¼ˆn = 4ï¼‰çš„æ¥å—è¯·æ±‚ï¼Œå¹¶ä¸”è¿™ä¸ªæ¥å—è¯·æ±‚è¿˜åŒ…å«äº†åœ¨å…¶æ”¶åˆ°çš„å‡†å¤‡å“åº”æ¶ˆæ¯ä¸­ä¸æœ€é«˜æè®®å·ç›¸å…³è”çš„å€¼ï¼ˆv = 8ï¼‰ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œè¿™ä¸æ˜¯<code>proposer B</code>æœ€åˆæå‡ºçš„å€¼ï¼Œè€Œæ˜¯å®ƒçœ‹åˆ°çš„å‡†å¤‡å“åº”æ¶ˆæ¯ä¸­çš„æœ€é«˜å€¼ã€‚</p>
<p><a href="http://idiotsky.top/images3/paxos-example-4.png"><img src="http://idiotsky.top/images3/paxos-example-4.png" alt=""></a></p>
<center>å›¾5ï¼Œ<code>proposer B</code>å‘é€ä¸€ä¸ªæ¥å—è¯·æ±‚ç»™æ¯ä¸ª<code>acceptor</code>,è¿™ä¸ªè¯·æ±‚åŒ…å«äº†å®ƒä¹‹å‰çš„æè®®å·(4)å’Œå®ƒä»[n=2,v=8]ä¸­çœ‹åˆ°çš„å€¼ï¼ˆ8ï¼‰</center>

<p>å¦‚æœ<code>acceptor</code>æ”¶åˆ°çš„æ¥å—è¯·æ±‚çš„æè®®å·å¤§äºæˆ–ç­‰äºä¹‹å‰å®ƒä¿è¯çš„ï¼Œé‚£ä¹ˆå®ƒæ¥å—å¹¶å‘æ¯ä¸ª<code>learner</code>èŠ‚ç‚¹å‘é€é€šçŸ¥ã€‚</p>
<p>å½“<code>learner</code>å‘ç°å¤§å¤šæ•°`acceptorå·²æ¥å—æŸä¸ªå€¼æ—¶ï¼ŒPaxosç®—æ³•ä¼šé€‰æ‹©è¿™ä¸ªå€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><a href="http://idiotsky.top/images3/paxos-example-5.png"><img src="http://idiotsky.top/images3/paxos-example-5.png" alt=""></a></p>
<p>ä¸€æ—¦Paxosé€‰æ‹©äº†ä¸€ä¸ªå€¼ï¼Œä¸å…¶ä»–<code>proposer</code>çš„è¿›ä¸€æ­¥æ²Ÿé€šå°±æ— æ³•æ”¹å˜è¿™ä¸ªå€¼ã€‚</p>
<p>å¦‚æœå¦ä¸€ä¸ª<code>proposer</code>ï¼ˆ<code>proposer C</code>ï¼‰å‘é€çš„æè®®å·æ¯”ä¹‹å‰çœ‹åˆ°çš„æè®®å·æ›´é«˜ï¼Œå¹¶ä¸”å…·æœ‰ä¸åŒçš„å€¼ï¼ˆä¾‹å¦‚ï¼Œn = 6ï¼Œv = 7ï¼‰ï¼Œåˆ™æ¯ä¸ª<code>acceptor</code>éƒ½ä¼šä½¿ç”¨ä¹‹å‰çš„æœ€é«˜æè®®å·è¿›è¡Œå“åº”ï¼ˆn = 4ï¼Œv = 8ï¼‰ã€‚</p>
<p>è¿™è¦æ±‚<code>proposer C</code>å‘é€åŒ…å«[n = 6ï¼Œv = 8] çš„æ¥å—è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä»…ç¡®è®¤å·²ç»é€‰æ‹©çš„å€¼ã€‚æ­¤å¤–ï¼Œå¦‚æœä¸€äº›å°‘<code>acceptor</code>è¿˜æ²¡æœ‰é€‰æ‹©ä¸€ä¸ªä»·å€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç¡®ä¿ä»–ä»¬æœ€ç»ˆå°±åŒä¸€ä»·å€¼è¾¾æˆå…±è¯†ã€‚</p>
<p>Lamportå’ŒBakerç­‰äººåœ¨è®ºæ–‡ä¸­è®¨è®ºäº†å¯¹æ ‡å‡†Paxosç®—æ³•çš„å„ç§æ•ˆç‡æ”¹è¿›ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ<code>proposer</code>çŸ¥é“å®ƒæ˜¯ç¬¬ä¸€ä¸ªå»ºè®®å€¼çš„è¯ï¼Œåˆ™å‡†å¤‡è¯·æ±‚ä¸å†æ˜¯å¿…é¡»çš„äº†ã€‚</p>
<p>å› ä¸ºè¿™ç§è¯·æ±‚çš„æè®®ç¼–å·ä¸º0ï¼Œå¦‚æœæ”¶åˆ°ä»»ä½•æ›´é«˜ç¼–å·çš„è¯·æ±‚çš„è¯ï¼Œè¿™ç§è¯·æ±‚å°±ä¼šè¢«å¿½ç•¥çš„ã€‚</p>
<p>ç¿»è¯‘ <a href="https://angus.nyc/2012/paxos-by-example/" target="_blank" rel="noopener">https://angus.nyc/2012/paxos-by-example/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡æ–‡ç« é€šè¿‡ä¸€ä¸ªæœ‰æ•ˆçš„ä¾‹å­æè¿°äº†ä¸€ä¸ªåä¸ºPaxos çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ã€‚&lt;/p&gt;
&lt;p&gt;åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ç”¨äºä½¿ä¸€ç»„è®¡ç®—æœºèƒ½å¤Ÿå°±å•ä¸ªå€¼è¾¾æˆä¸€è‡´ï¼Œä¾‹å¦‚é€šå¸¸ä½¿ç”¨ä¸¤é˜¶æ®µæˆ–ä¸‰é˜¶æ®µæäº¤åšå‡ºçš„æäº¤æˆ–å›æ»šå†³ç­–ã€‚åªè¦é€‰æ‹©ä¸€ä¸ªå€¼ï¼Œç®—æ³•çš„å…¶ä»–å€¼å°±æ²¡æœ‰å…³ç³»äº†ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿™å¾ˆéš¾ï¼Œå› ä¸ºæœºå™¨ä¹‹é—´çš„æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±æˆ–æ— é™æœŸå»¶è¿Ÿï¼Œæˆ–è€…æœºå™¨æœ¬èº«å¯èƒ½ä¼šå‘ç”Ÿæ•…éšœã€‚&lt;/p&gt;
&lt;p&gt;Paxosä¿è¯èŠ‚ç‚¹åªä¼šé€‰æ‹©å•ä¸ªå€¼ï¼ˆæ„å‘³ç€å®ƒä¿è¯å®‰å…¨ï¼‰ï¼Œä½†ä¸ä¿è¯åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸å¯ç”¨æ—¶èƒ½ä¸èƒ½å»åˆ°å€¼&lt;/p&gt;
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://idiotsky.top/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Paxos" scheme="http://idiotsky.top/tags/Paxos/"/>
    
  </entry>
  
  <entry>
    <title>kafkaæ€»ç»“</title>
    <link href="http://idiotsky.top/2018/07/22/kafka-summary/"/>
    <id>http://idiotsky.top/2018/07/22/kafka-summary/</id>
    <published>2018-07-22T13:38:51.000Z</published>
    <updated>2018-07-22T07:50:29.168Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ç©äº†å¾ˆä¹…çš„kafkaï¼Œç°åœ¨æ€»ç»“ä¸‹å§ï¼Œå½“ç„¶é€šè¿‡åˆ«äººçš„æ–‡ç« æ¥æ€»ç»“è¿˜æ˜¯äº‹åŠåŠŸå€çš„ğŸ‘¿</p>
</blockquote>
<h1 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h1><p><a href="http://idiotsky.top/images3/kafka-1.jpg"><img src="http://idiotsky.top/images3/kafka-1.jpg" alt=""></a></p>
<p>å¦‚ä¸Šå›¾ï¼Œä¸€ä¸ªkafkaæ¶æ„åŒ…æ‹¬è‹¥å¹²ä¸ªProducerï¼ˆæœåŠ¡å™¨æ—¥å¿—ã€ä¸šåŠ¡æ•°æ®ã€webå‰ç«¯äº§ç”Ÿçš„page viewç­‰ï¼‰ï¼Œè‹¥å¹²ä¸ªBrokerï¼ˆkafkaæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œä¸€èˆ¬brokeræ•°é‡è¶Šå¤šé›†ç¾¤çš„ååé‡è¶Šå¤§ï¼‰ï¼Œè‹¥å¹²ä¸ªconsumer groupï¼Œä¸€ä¸ªZookeeperé›†ç¾¤ï¼ˆkafkaé€šè¿‡Zookeeperç®¡ç†é›†ç¾¤é…ç½®ã€é€‰ä¸¾leaderã€consumer groupå‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œrebalanceï¼‰ã€‚</p>
<a id="more"></a>
<h1 id="åç§°è§£é‡Š"><a href="#åç§°è§£é‡Š" class="headerlink" title="åç§°è§£é‡Š"></a>åç§°è§£é‡Š</h1><ul>
<li>Broker: æ¶ˆæ¯ä¸­é—´ä»¶å¤„ç†èŠ‚ç‚¹ï¼ˆæœåŠ¡å™¨ï¼‰ï¼Œä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªbrokerï¼Œä¸€ä¸ªKafkaé›†ç¾¤ç”±ä¸€ä¸ªæˆ–å¤šä¸ªbrokerç»„æˆ</li>
<li>Topic: Kafkaå¯¹æ¶ˆæ¯è¿›è¡Œå½’ç±»ï¼Œå‘é€åˆ°é›†ç¾¤çš„æ¯ä¸€æ¡æ¶ˆæ¯éƒ½è¦æŒ‡å®šä¸€ä¸ªtopic</li>
<li>Partition: ç‰©ç†ä¸Šçš„æ¦‚å¿µï¼Œæ¯ä¸ªtopicåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªpartitionï¼Œä¸€ä¸ªpartitionå¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹å­˜å‚¨partitionçš„æ•°æ®å’Œç´¢å¼•æ–‡ä»¶ï¼Œæ¯ä¸ªpartitionå†…éƒ¨æ˜¯æœ‰åºçš„</li>
<li>Producer: ç”Ÿäº§è€…ï¼Œè´Ÿè´£å‘å¸ƒæ¶ˆæ¯åˆ°broker</li>
<li>Consumer: æ¶ˆè´¹è€…ï¼Œä»brokerè¯»å–æ¶ˆæ¯</li>
<li>ConsumerGroup: æ¯ä¸ªconsumerå±äºä¸€ä¸ªç‰¹å®šçš„consumer groupï¼Œå¯ä¸ºæ¯ä¸ªconsumeræŒ‡å®šgroup nameï¼Œè‹¥ä¸æŒ‡å®šï¼Œåˆ™å±äºé»˜è®¤çš„groupï¼Œä¸€æ¡æ¶ˆæ¯å¯ä»¥å‘é€åˆ°ä¸åŒçš„consumer groupï¼Œä½†ä¸€ä¸ªconsumer groupä¸­åªèƒ½æœ‰ä¸€ä¸ªconsumerèƒ½æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯</li>
</ul>
<h1 id="å…³ç³»è§£é‡Š"><a href="#å…³ç³»è§£é‡Š" class="headerlink" title="å…³ç³»è§£é‡Š"></a>å…³ç³»è§£é‡Š</h1><h2 id="Topic-amp-Partition"><a href="#Topic-amp-Partition" class="headerlink" title="Topic &amp; Partition"></a>Topic &amp; Partition</h2><p>ä¸€ä¸ªtopicä¸ºä¸€ç±»æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»æŒ‡å®šä¸€ä¸ªtopicã€‚ç‰©ç†ä¸Šï¼Œä¸€ä¸ªtopicåˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªpartitionï¼Œæ¯ä¸ªpartitionæœ‰å¤šä¸ªå‰¯æœ¬åˆ†å¸ƒåœ¨ä¸åŒçš„brokerä¸­ï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p><a href="http://idiotsky.top/images3/kafka-2.jpg"><img src="http://idiotsky.top/images3/kafka-2.jpg" alt=""></a></p>
<p>æ¯ä¸ªpartitionåœ¨å­˜å‚¨å±‚é¢æ˜¯ä¸€ä¸ªappend logæ–‡ä»¶ï¼Œå‘å¸ƒåˆ°æ­¤partitionçš„æ¶ˆæ¯ä¼šè¿½åŠ åˆ°logæ–‡ä»¶çš„å°¾éƒ¨ï¼Œä¸ºé¡ºåºå†™äººç£ç›˜ï¼ˆé¡ºåºå†™ç£ç›˜æ¯”éšæœºå†™å†…å­˜çš„æ•ˆç‡è¿˜è¦é«˜ï¼‰ã€‚æ¯æ¡æ¶ˆæ¯åœ¨logæ–‡ä»¶ä¸­çš„ä½ç½®æˆä¸ºoffsetï¼ˆåç§»é‡ï¼‰ï¼Œoffsetä¸ºä¸€ä¸ªlongå‹æ•°å­—ï¼Œå”¯ä¸€æ ‡è®°ä¸€æ¡æ¶ˆæ¯ã€‚å¦‚ä¸‹å›¾</p>
<p><a href="http://idiotsky.top/images3/kafka-3.png"><img src="http://idiotsky.top/images3/kafka-3.png" alt=""></a></p>
<p>æ¯ä¸ªæ¶ˆè´¹è€…å”¯ä¸€ä¿å­˜çš„å…ƒæ•°æ®æ˜¯offsetå€¼ï¼Œè¿™ä¸ªä½ç½®å®Œå…¨ä¸ºæ¶ˆè´¹è€…æ§åˆ¶ï¼Œå› æ­¤æ¶ˆè´¹è€…å¯ä»¥é‡‡ç”¨ä»»ä½•é¡ºåºæ¥æ¶ˆè´¹è®°å½•ï¼Œå¦‚ä¸‹å›¾</p>
<p><a href="http://idiotsky.top/images3/kafka-4.png"><img src="http://idiotsky.top/images3/kafka-4.png" alt=""></a></p>
<p>kafkaä¸­åªèƒ½ä¿è¯partitionä¸­è®°å½•æ˜¯æœ‰åºçš„ï¼Œè€Œä¸ä¿è¯topicä¸­ä¸åŒpartitionçš„é¡ºåº</p>
<h2 id="Consumer-group-amp-consumer"><a href="#Consumer-group-amp-consumer" class="headerlink" title="Consumer group &amp; consumer"></a>Consumer group &amp; consumer</h2><p>ä¸€ä¸ªæ¶ˆè´¹ç»„ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹ç»„æˆï¼Œä¾¿äºæ‰©å®¹ä¸å®¹é”™ã€‚</p>
<p>kafkaæ˜¯å‘å¸ƒä¸è®¢é˜…æ¨¡å¼ï¼Œè¿™ä¸ªè®¢é˜…è€…æ˜¯æ¶ˆè´¹ç»„ï¼Œè€Œä¸æ˜¯æ¶ˆè´¹è€…å®ä¾‹ã€‚æ¯ä¸€æ¡æ¶ˆæ¯åªä¼šè¢«åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œçš„ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹æ¶ˆè´¹ï¼Œä¸åŒçš„æ¶ˆè´¹ç»„å¯ä»¥åŒæ—¶æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾</p>
<p><a href="http://idiotsky.top/images3/kafka-5.png"><img src="http://idiotsky.top/images3/kafka-5.png" alt=""></a></p>
<p>ä¸ºäº†å®ç°ä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡çš„è¯­ä¹‰ï¼Œkafkaä¿è¯åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ä¼šæ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯ï¼Œkafkaè¿˜å…è®¸ä¸åŒçš„æ¶ˆè´¹ç»„åŒæ—¶æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™ä¸€ç‰¹æ€§å¯ä»¥ä¸ºæ¶ˆæ¯çš„å¤šå…ƒåŒ–å¤„ç†æä¾›äº†æ”¯æŒï¼Œkafkaçš„è®¾è®¡ç†å¿µä¹‹ä¸€å°±æ˜¯åŒæ—¶æä¾›ç¦»çº¿å¤„ç†å’Œå®æ—¶å¤„ç†ï¼Œå› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨Stormè¿™ç§å®æ—¶æµå¤„ç†ç³»ç»Ÿå¯¹æ¶ˆæ¯è¿›è¡Œå®æ—¶åœ¨çº¿å¤„ç†ï¼ŒåŒæ—¶ä½¿ç”¨Hadoopè¿™ç§æ‰¹å¤„ç†ç³»ç»Ÿè¿›è¡Œç¦»çº¿å¤„ç†ï¼Œè¿˜å¯ä»¥åŒæ—¶å°†æ•°æ®å®æ—¶å¤‡ä»½åˆ°å¦ä¸€ä¸ªæ•°æ®ä¸­å¿ƒï¼Œåªéœ€è¦ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œçš„æ¶ˆè´¹è€…å®ä¾‹åœ¨ä¸åŒconsumer group å³å¯</p>
<h2 id="Consumer-Rebalance"><a href="#Consumer-Rebalance" class="headerlink" title="Consumer Rebalance"></a>Consumer Rebalance</h2><p>kafkaä¿è¯äº†åŒä¸€ä¸ªæ¶ˆè´¹ç»„ä¸­åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹ä¼šæ¶ˆè´¹æŸæ¡æ¶ˆæ¯ï¼Œå®é™…ä¸Šï¼Œkafkaä¿è¯çš„æ˜¯ç¨³å®šçŠ¶æ€ä¸‹æ¯ä¸€ä¸ªæ¶ˆè´¹è€…å®ä¾‹åªä¼šæ¶ˆè´¹ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®špartitionæ•°æ®ï¼Œè€ŒæŸä¸ªpartitionçš„æ•°æ®åªä¼šè¢«æŸä¸€ç‰¹å®šçš„consumerå®ä¾‹æ¶ˆè´¹ï¼Œè¿™æ ·è®¾è®¡çš„åŠ£åŠ¿æ˜¯æ— æ³•è®©åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œçš„consumerå‡åŒ€æ¶ˆè´¹ï¼Œä¼˜åŠ¿æ˜¯æ¯ä¸ªconsumerä¸ç”¨è·Ÿå¤§é‡çš„brokeré€šä¿¡ï¼Œå‡å°‘é€šä¿¡å¼€é”€ï¼Œä¹Ÿé™ä½äº†åˆ†é…éš¾åº¦ã€‚è€Œä¸”ï¼ŒåŒä¸€ä¸ªpartitionæ•°æ®æ˜¯æœ‰åºçš„ï¼Œä¿è¯äº†æœ‰åºè¢«æ¶ˆè´¹ã€‚æ ¹æ®consumer groupä¸­çš„consumeræ•°é‡å’Œpartitionæ•°é‡ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹3ç§æƒ…å†µï¼š</p>
<ul>
<li>è‹¥consumer groupä¸­çš„consumeræ•°é‡å°‘äºpartitionæ•°é‡ï¼Œåˆ™è‡³å°‘æœ‰1ä¸ªconsumerä¼šæ¶ˆè´¹å¤šä¸ªpartitionæ•°æ®</li>
<li>è‹¥consumer groupä¸­çš„consumeræ•°é‡å¤šäºpartitionæ•°é‡ï¼Œåˆ™ä¼šæœ‰éƒ¨åˆ†consumeræ— æ³•æ¶ˆè´¹è¯¥topicä¸­ä»»ä½•ä¸€æ¡æ¶ˆæ¯</li>
<li>è‹¥consumer groupä¸­çš„consumeræ•°é‡ç­‰äºpartitionæ•°é‡ï¼Œåˆ™æ­£å¥½ä¸€ä¸ªconsumeræ¶ˆè´¹ä¸€ä¸ªpartitionæ•°æ®</li>
</ul>
<h1 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h1><p>ä»¥ä¸€ä¸ªå®ä¾‹ç»“æŸè¿™ç¯‡æ–‡ç« </p>
<p>åˆ›å»ºä¸€ä¸ª<code>kafka-topic</code>,å®ƒæœ‰4ä¸ªåˆ†ç‰‡ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --create --zookeeper zk:2181 --replication-factor 1 --partitions 4 --topic kafka-topic</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™ä¸€ä¸ª<a href="https://github.com/ejunjsh/java-code/blob/master/src/main/java/com/sky/code/kafka/CustomPartitionProducer.java" target="_blank" rel="noopener">ç”Ÿäº§è€…</a></p>
<p>è¾“å‡º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Sun Jul 22 07:17:11 UTC 2018,kafka.apache.org,192.168.14.203</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  0</span><br><span class="line">Sun Jul 22 07:17:14 UTC 2018,kafka.apache.org,192.168.14.134</span><br><span class="line">publish to partition 0</span><br><span class="line">offset  0</span><br><span class="line">Sun Jul 22 07:17:16 UTC 2018,kafka.apache.org,192.168.14.150</span><br><span class="line">publish to partition 0</span><br><span class="line">offset  1</span><br><span class="line">Sun Jul 22 07:17:18 UTC 2018,kafka.apache.org,192.168.14.49</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  1</span><br><span class="line">Sun Jul 22 07:17:20 UTC 2018,kafka.apache.org,192.168.14.55</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  2</span><br><span class="line">Sun Jul 22 07:17:22 UTC 2018,kafka.apache.org,192.168.14.172</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  3</span><br><span class="line">Sun Jul 22 07:17:24 UTC 2018,kafka.apache.org,192.168.14.122</span><br><span class="line">publish to partition 1</span><br><span class="line">offset  0</span><br><span class="line">Sun Jul 22 07:17:26 UTC 2018,kafka.apache.org,192.168.14.237</span><br><span class="line">publish to partition 3</span><br><span class="line">offset  0</span><br><span class="line">Sun Jul 22 07:17:28 UTC 2018,kafka.apache.org,192.168.14.95</span><br><span class="line">publish to partition 2</span><br><span class="line">offset  4</span><br></pre></td></tr></table></figure></p>
<p>åŸºæœ¬éƒ½å‡åŒ€å†™åˆ°ä¸åŒçš„åˆ†ç‰‡ä¸Š</p>
<p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ª<a href="https://github.com/ejunjsh/java-code/blob/master/src/main/java/com/sky/code/kafka/CustomPartitionConsumer.java" target="_blank" rel="noopener">æ¶ˆè´¹è€…</a>ï¼Œå®ƒå¯åŠ¨ä¸‰ä¸ªçº¿ç¨‹ä»£è¡¨ä¸‰ä¸ªæ¶ˆè´¹è€…å»æ¶ˆè´¹</p>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0: &#123;partition=1, offset=20, value=Sun Jul 22 07:20:12 UTC 2018,kafka.apache.org,192.168.14.141&#125;</span><br><span class="line">0: &#123;partition=0, offset=20, value=Sun Jul 22 07:20:14 UTC 2018,kafka.apache.org,192.168.14.113&#125;</span><br><span class="line">2: &#123;partition=3, offset=24, value=Sun Jul 22 07:20:16 UTC 2018,kafka.apache.org,192.168.14.173&#125;</span><br><span class="line">0: &#123;partition=0, offset=21, value=Sun Jul 22 07:20:18 UTC 2018,kafka.apache.org,192.168.14.38&#125;</span><br><span class="line">2: &#123;partition=3, offset=25, value=Sun Jul 22 07:20:20 UTC 2018,kafka.apache.org,192.168.14.222&#125;</span><br><span class="line">1: &#123;partition=2, offset=26, value=Sun Jul 22 07:20:22 UTC 2018,kafka.apache.org,192.168.14.19&#125;</span><br><span class="line">2: &#123;partition=3, offset=26, value=Sun Jul 22 07:20:24 UTC 2018,kafka.apache.org,192.168.14.227&#125;</span><br><span class="line">0: &#123;partition=1, offset=21, value=Sun Jul 22 07:20:26 UTC 2018,kafka.apache.org,192.168.14.72&#125;</span><br><span class="line">0: &#123;partition=1, offset=22, value=Sun Jul 22 07:20:28 UTC 2018,kafka.apache.org,192.168.14.68&#125;</span><br><span class="line">1: &#123;partition=2, offset=27, value=Sun Jul 22 07:20:31 UTC 2018,kafka.apache.org,192.168.14.172&#125;</span><br><span class="line">2: &#123;partition=3, offset=27, value=Sun Jul 22 07:20:33 UTC 2018,kafka.apache.org,192.168.14.45&#125;</span><br><span class="line">0: &#123;partition=1, offset=23, value=Sun Jul 22 07:20:35 UTC 2018,kafka.apache.org,192.168.14.87&#125;</span><br><span class="line">2: &#123;partition=3, offset=28, value=Sun Jul 22 07:20:37 UTC 2018,kafka.apache.org,192.168.14.160&#125;</span><br><span class="line">2: &#123;partition=3, offset=29, value=Sun Jul 22 07:20:39 UTC 2018,kafka.apache.org,192.168.14.54&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸€è¡Œå¼€å¤´çš„åºå·ä»£è¡¨çš„æ˜¯æ¶ˆè´¹è€…çš„åºå·ï¼Œå¾ˆæ˜æ˜¾0å·æ¶ˆè´¹è€…æ¶ˆè´¹äº†0å’Œ1åˆ†ç‰‡ï¼Œ1å·æ¶ˆè´¹è€…æ¶ˆè´¹2å·åˆ†ç‰‡ï¼Œ2å·æ¶ˆè´¹è€…æ¶ˆè´¹3å·åˆ†ç‰‡</p>
<p>æ¥ä¸‹æ¥è¯•ä¸‹åŠ å¤§æ¶ˆè´¹è€…ç­‰äºåˆ†ç‰‡æ•°å³4ä¸ªæ¶ˆè´¹è€…çœ‹çœ‹</p>
<p>è¾“å‡º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0: &#123;partition=0, offset=66, value=Sun Jul 22 07:27:06 UTC 2018,kafka.apache.org,192.168.14.99&#125;</span><br><span class="line">3: &#123;partition=3, offset=90, value=Sun Jul 22 07:27:08 UTC 2018,kafka.apache.org,192.168.14.222&#125;</span><br><span class="line">0: &#123;partition=0, offset=67, value=Sun Jul 22 07:27:10 UTC 2018,kafka.apache.org,192.168.14.106&#125;</span><br><span class="line">2: &#123;partition=2, offset=70, value=Sun Jul 22 07:27:12 UTC 2018,kafka.apache.org,192.168.14.175&#125;</span><br><span class="line">0: &#123;partition=0, offset=68, value=Sun Jul 22 07:27:14 UTC 2018,kafka.apache.org,192.168.14.163&#125;</span><br><span class="line">1: &#123;partition=1, offset=70, value=Sun Jul 22 07:27:16 UTC 2018,kafka.apache.org,192.168.14.176&#125;</span><br><span class="line">3: &#123;partition=3, offset=91, value=Sun Jul 22 07:27:18 UTC 2018,kafka.apache.org,192.168.14.228&#125;</span><br><span class="line">2: &#123;partition=2, offset=71, value=Sun Jul 22 07:27:20 UTC 2018,kafka.apache.org,192.168.14.55&#125;</span><br><span class="line">1: &#123;partition=1, offset=71, value=Sun Jul 22 07:27:22 UTC 2018,kafka.apache.org,192.168.14.40&#125;</span><br><span class="line">1: &#123;partition=1, offset=72, value=Sun Jul 22 07:27:24 UTC 2018,kafka.apache.org,192.168.14.135&#125;</span><br><span class="line">0: &#123;partition=0, offset=69, value=Sun Jul 22 07:27:26 UTC 2018,kafka.apache.org,192.168.14.249&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¾ˆæ˜æ˜¾ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…è·Ÿæ¯ä¸ªåˆ†ç‰‡æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚</p>
<p>å†çœ‹çœ‹æ¶ˆè´¹è€…å¤šä½™åˆ†ç‰‡çš„æƒ…å†µ,è¿™æ¬¡æŠŠæ¶ˆè´¹è€…åŠ å¤§åˆ°6ä¸ª</p>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">2: &#123;partition=2, offset=90, value=Sun Jul 22 07:29:44 UTC 2018,kafka.apache.org,192.168.14.148&#125;</span><br><span class="line">0: &#123;partition=0, offset=87, value=Sun Jul 22 07:29:46 UTC 2018,kafka.apache.org,192.168.14.18&#125;</span><br><span class="line">1: &#123;partition=1, offset=86, value=Sun Jul 22 07:29:48 UTC 2018,kafka.apache.org,192.168.14.77&#125;</span><br><span class="line">0: &#123;partition=0, offset=88, value=Sun Jul 22 07:29:50 UTC 2018,kafka.apache.org,192.168.14.21&#125;</span><br><span class="line">2: &#123;partition=2, offset=91, value=Sun Jul 22 07:29:52 UTC 2018,kafka.apache.org,192.168.14.116&#125;</span><br><span class="line">2: &#123;partition=2, offset=92, value=Sun Jul 22 07:29:54 UTC 2018,kafka.apache.org,192.168.14.92&#125;</span><br><span class="line">0: &#123;partition=0, offset=89, value=Sun Jul 22 07:29:56 UTC 2018,kafka.apache.org,192.168.14.241&#125;</span><br><span class="line">1: &#123;partition=1, offset=87, value=Sun Jul 22 07:29:58 UTC 2018,kafka.apache.org,192.168.14.207&#125;</span><br><span class="line">3: &#123;partition=3, offset=112, value=Sun Jul 22 07:30:00 UTC 2018,kafka.apache.org,192.168.14.100&#125;</span><br><span class="line">1: &#123;partition=1, offset=88, value=Sun Jul 22 07:30:02 UTC 2018,kafka.apache.org,192.168.14.77&#125;</span><br><span class="line">1: &#123;partition=1, offset=89, value=Sun Jul 22 07:30:04 UTC 2018,kafka.apache.org,192.168.14.141&#125;</span><br><span class="line">3: &#123;partition=3, offset=113, value=Sun Jul 22 07:30:06 UTC 2018,kafka.apache.org,192.168.14.36&#125;</span><br><span class="line">2: &#123;partition=2, offset=93, value=Sun Jul 22 07:30:08 UTC 2018,kafka.apache.org,192.168.14.216&#125;</span><br><span class="line">3: &#123;partition=3, offset=114, value=Sun Jul 22 07:30:10 UTC 2018,kafka.apache.org,192.168.14.205&#125;</span><br><span class="line">2: &#123;partition=2, offset=94, value=Sun Jul 22 07:30:12 UTC 2018,kafka.apache.org,192.168.14.238&#125;</span><br><span class="line">3: &#123;partition=3, offset=115, value=Sun Jul 22 07:30:14 UTC 2018,kafka.apache.org,192.168.14.118&#125;</span><br><span class="line">2: &#123;partition=2, offset=95, value=Sun Jul 22 07:30:16 UTC 2018,kafka.apache.org,192.168.14.97&#125;</span><br><span class="line">0: &#123;partition=0, offset=90, value=Sun Jul 22 07:30:18 UTC 2018,kafka.apache.org,192.168.14.169&#125;</span><br><span class="line">2: &#123;partition=2, offset=96, value=Sun Jul 22 07:30:20 UTC 2018,kafka.apache.org,192.168.14.226&#125;</span><br><span class="line">3: &#123;partition=3, offset=116, value=Sun Jul 22 07:30:22 UTC 2018,kafka.apache.org,192.168.14.34&#125;</span><br><span class="line">3: &#123;partition=3, offset=117, value=Sun Jul 22 07:30:24 UTC 2018,kafka.apache.org,192.168.14.184&#125;</span><br><span class="line">1: &#123;partition=1, offset=90, value=Sun Jul 22 07:30:26 UTC 2018,kafka.apache.org,192.168.14.207&#125;</span><br><span class="line">2: &#123;partition=2, offset=97, value=Sun Jul 22 07:30:28 UTC 2018,kafka.apache.org,192.168.14.121&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶ï¼Œåªæ˜¯çœ‹åˆ°å››ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹å››ä¸ªåˆ†ç‰‡ï¼Œå…¶ä½™æ¶ˆè´¹è€…æ²¡æœ‰å‚ä¸åˆ°æ¶ˆè´¹ä¸­å»ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>kafkaæ˜¯ä¸€ä¸ªé«˜å¯ç”¨é«˜ååçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç»„ä»¶ï¼Œå¤šåˆ†ç‰‡å¯ä»¥æä¾›å¤šæ¶ˆè´¹è€…å¤šäº§ç”Ÿè€…çš„ååï¼Œå¤šä¸ªåˆ†ç»„å¯ä»¥æ»¡è¶³å¤šä¸ªåº”ç”¨å¯¹åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨è¦æ±‚è€Œäº’ä¸å¹²æ‰°ï¼ŒåŒä¸€åˆ†ç»„æ¶ˆè´¹è€…è¿˜èƒ½åŸºæœ¬ä¿è¯æ¶ˆæ¯åªæ¶ˆè´¹ä¸€æ¬¡ã€‚</p>
<p>å‚è€ƒ <a href="https://zhuanlan.zhihu.com/p/38269875" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/38269875</a></p>
<p>ä½¿ç”¨çš„å®ä¾‹å¯åˆ°è¿™ä¸ª<a href="https://github.com/ejunjsh/java-code" target="_blank" rel="noopener">é“¾æ¥</a>è·å–ï¼Œè¿˜æä¾›<code>docker</code>è¿è¡Œç¯å¢ƒå“¦ </p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç©äº†å¾ˆä¹…çš„kafkaï¼Œç°åœ¨æ€»ç»“ä¸‹å§ï¼Œå½“ç„¶é€šè¿‡åˆ«äººçš„æ–‡ç« æ¥æ€»ç»“è¿˜æ˜¯äº‹åŠåŠŸå€çš„ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ¶æ„å›¾&quot;&gt;&lt;a href=&quot;#æ¶æ„å›¾&quot; class=&quot;headerlink&quot; title=&quot;æ¶æ„å›¾&quot;&gt;&lt;/a&gt;æ¶æ„å›¾&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;http://idiotsky.top/images3/kafka-1.jpg&quot;&gt;&lt;img src=&quot;http://idiotsky.top/images3/kafka-1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å¦‚ä¸Šå›¾ï¼Œä¸€ä¸ªkafkaæ¶æ„åŒ…æ‹¬è‹¥å¹²ä¸ªProducerï¼ˆæœåŠ¡å™¨æ—¥å¿—ã€ä¸šåŠ¡æ•°æ®ã€webå‰ç«¯äº§ç”Ÿçš„page viewç­‰ï¼‰ï¼Œè‹¥å¹²ä¸ªBrokerï¼ˆkafkaæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œä¸€èˆ¬brokeræ•°é‡è¶Šå¤šé›†ç¾¤çš„ååé‡è¶Šå¤§ï¼‰ï¼Œè‹¥å¹²ä¸ªconsumer groupï¼Œä¸€ä¸ªZookeeperé›†ç¾¤ï¼ˆkafkaé€šè¿‡Zookeeperç®¡ç†é›†ç¾¤é…ç½®ã€é€‰ä¸¾leaderã€consumer groupå‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œrebalanceï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.top/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.top/tags/java/"/>
    
      <category term="kafka" scheme="http://idiotsky.top/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨javapçœ‹ä¸€ä¸‹finalæ˜¯ä»€ä¹ˆ</title>
    <link href="http://idiotsky.top/2018/07/17/java-javap-final/"/>
    <id>http://idiotsky.top/2018/07/17/java-javap-final/</id>
    <published>2018-07-17T14:23:29.000Z</published>
    <updated>2018-07-22T05:12:32.952Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ä¸€ç›´å¾ˆå¥½å¥‡<code>final</code>çš„ç±»å­—æ®µåœ¨classæ–‡ä»¶æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„ï¼Œæ‰€ä»¥ç”¨javapçœ‹çœ‹æ€ä¹ˆå›äº‹,ä¹Ÿé¡ºä¾¿å¤ä¹ ä¸‹å­—èŠ‚ç æŒ‡ä»¤ğŸ‘¿</p>
</blockquote>
<h1 id="æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ"><a href="#æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ" class="headerlink" title="æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ"></a>æ²¡æœ‰<code>final</code>ä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ</h1><p>å®šä¹‰ä¸€ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> String str=<span class="string">"ä¸¥"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>ç¼–è¯‘æŸ¥çœ‹classæ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">javac test.java</span><br><span class="line">javap -verbose test.class</span><br><span class="line"></span><br><span class="line">//çœç•¥å¸¸é‡æ± </span><br><span class="line">&#123;</span><br><span class="line">  public static java.lang.String str;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: getstatic     #3                  // Field str:Ljava/lang/String;</span><br><span class="line">         6: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 9</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=0, args_size=0</span><br><span class="line">         0: ldc           #5                  // String ä¸¥</span><br><span class="line">         2: putstatic     #3                  // Field str:Ljava/lang/String;</span><br><span class="line">         5: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 2: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°<code>public static String str=&quot;ä¸¥&quot;;</code>ç›´æ¥ç¿»è¯‘æˆä¸€ä¸ªé™æ€å—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static &#123;&#125;;</span><br><span class="line">  flags: ACC_STATIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=1, locals=0, args_size=0</span><br><span class="line">       0: ldc           #5                  // String ä¸¥</span><br><span class="line">       2: putstatic     #3                  // Field str:Ljava/lang/String;</span><br><span class="line">       5: return</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line 2: 0</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢<code>ldc</code>çš„æŒ‡ä»¤å°±æ˜¯æŠŠå¸¸é‡ä»å¸¸é‡æ± è¯»åˆ°æ“ä½œæ•°æ ˆï¼Œ<code>putstatic</code>æŒ‡ä»¤ä»æ ˆé¡¶èµ‹å€¼ç»™ç±»çš„é™æ€å­—æ®µ<code>str</code>,è¿™ä¸ªå­—æ®µä¹‹ååœ¨<code>main</code>å‡½æ•°ä¼šè¯»å‡ºæ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">  flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=2, locals=1, args_size=1</span><br><span class="line">       0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">       3: getstatic     #3                  // Field str:Ljava/lang/String;</span><br><span class="line">       6: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">       9: return</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line 5: 0</span><br><span class="line">      line 6: 9</span><br></pre></td></tr></table></figure>
<p><code>getstatic</code>æ˜¯ç”¨æ¥è¯»å–ç±»çš„é™æ€å­—æ®µçš„ï¼Œè¿™é‡Œè¯»å‡ºæ¥æ”¾å…¥æ“ä½œæ•°æ ˆã€‚</p>
<h1 id="æœ‰finalä¿®é¥°çš„ç±»é™æ€å­—æ®µ"><a href="#æœ‰finalä¿®é¥°çš„ç±»é™æ€å­—æ®µ" class="headerlink" title="æœ‰finalä¿®é¥°çš„ç±»é™æ€å­—æ®µ"></a>æœ‰<code>final</code>ä¿®é¥°çš„ç±»é™æ€å­—æ®µ</h1><p>æ”¹ä¸€ä¸‹è¿™ä¸ªç±»ï¼ŒåŠ <code>final</code>ä¿®é¥°ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String str=<span class="string">"ä¸¥"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘æŸ¥çœ‹classæ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">javac test.java</span><br><span class="line">javap -verbose test.class</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> çœç•¥å¸¸é‡æ± </span></span><br><span class="line">&#123;</span><br><span class="line">  public static final java.lang.String str;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line">    ConstantValue: String ä¸¥</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: ldc           #3                  // String ä¸¥</span><br><span class="line">         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">         8: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 8</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°classæ–‡ä»¶æ²¡æœ‰ä¹‹å‰çš„é™æ€å—äº†ï¼Œè€Œä¸”ä¹Ÿä¸å†ç”¨<code>getstatic</code>æŒ‡ä»¤è·å–å­—æ®µçš„å€¼ï¼Œè€Œæ˜¯ç›´æ¥<code>ldc</code>æŒ‡ä»¤å–å¸¸é‡æ± çš„å€¼ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹å®ä¾‹å­—æ®µåœ¨åŠ <code>final</code>æˆ–ä¸åŠ ä¼šä¸ä¼šæœ‰ä»€ä¹ˆä¸åŒå‘¢</p>
<h1 id="ä¸åŠ finalçš„å®ä¾‹å­—æ®µ"><a href="#ä¸åŠ finalçš„å®ä¾‹å­—æ®µ" class="headerlink" title="ä¸åŠ finalçš„å®ä¾‹å­—æ®µ"></a>ä¸åŠ finalçš„å®ä¾‹å­—æ®µ</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span>  String str=<span class="string">"ä¸¥"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        test t=<span class="keyword">new</span> test();</span><br><span class="line">        System.out.println(t.str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//çœç•¥æ²¡ç”¨çš„äº†ã€‚ã€‚ã€‚</span><br><span class="line">&#123;</span><br><span class="line">  public java.lang.String str;</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: ldc           #2                  // String ä¸¥</span><br><span class="line">         7: putfield      #3                  // Field str:Ljava/lang/String;</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line">        line 2: 4</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=2, args_size=1</span><br><span class="line">         0: new           #4                  // class test</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #5                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         7: astore_1</span><br><span class="line">         8: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        11: aload_1</span><br><span class="line">        12: getfield      #3                  // Field str:Ljava/lang/String;</span><br><span class="line">        15: invokevirtual #7                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">        18: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 8</span><br><span class="line">        line 7: 18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ å‡½æ•°é‡Œé¢ç”¨<code>ldc</code>åˆå§‹åŒ–äº†å®ä¾‹å­—æ®µ<code>str</code>çš„å€¼,ç„¶ååœ¨mainå‡½æ•°é‡Œé¢ç”¨<code>getfield</code>æŒ‡ä»¤ï¼Œè·å–<code>t</code>å®ä¾‹çš„<code>str</code>çš„å€¼ã€‚</p>
<h1 id="åŠ finalçš„å®ä¾‹å­—æ®µ"><a href="#åŠ finalçš„å®ä¾‹å­—æ®µ" class="headerlink" title="åŠ finalçš„å®ä¾‹å­—æ®µ"></a>åŠ <code>final</code>çš„å®ä¾‹å­—æ®µ</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> String str=<span class="string">"ä¸¥"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        test t=<span class="keyword">new</span> test();</span><br><span class="line">        System.out.println(t.str);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">//çœç•¥æ²¡ç”¨çš„äº†ã€‚ã€‚ã€‚</span><br><span class="line">&#123;</span><br><span class="line">  public final java.lang.String str;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_FINAL</span><br><span class="line">    ConstantValue: String ä¸¥</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: aload_0</span><br><span class="line">         5: ldc           #2                  // String ä¸¥</span><br><span class="line">         7: putfield      #3                  // Field str:Ljava/lang/String;</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line">        line 2: 4</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=2, args_size=1</span><br><span class="line">         0: new           #4                  // class test</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #5                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         7: astore_1</span><br><span class="line">         8: getstatic     #6                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        11: aload_1</span><br><span class="line">        12: invokevirtual #7                  // Method java/lang/Object.getClass:()Ljava/lang/Class;</span><br><span class="line">        15: pop</span><br><span class="line">        16: ldc           #2                  // String ä¸¥</span><br><span class="line">        18: invokevirtual #8                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">        21: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 5: 0</span><br><span class="line">        line 6: 8</span><br><span class="line">        line 7: 21</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getfield</code>æŒ‡ä»¤å˜æˆäº†ç†Ÿæ‚‰çš„<code>ldc</code>,å¾ˆæ˜æ˜¾äº†ï¼ŒåŠ äº†<code>final</code>ä¹‹åå°±å»å¸¸é‡æ± å»æ‰¾ï¼Œå°±ä¸éœ€è¦ç”¨<code>getfield</code>æŒ‡ä»¤ã€‚</p>
<p>ä¸Šé¢çš„å­—æ®µæ˜¯å­—ç¬¦ä¸²ï¼Œé‚£æ¥ä¸‹æ¥çœ‹çœ‹æ•°å­—çš„å­—æ®µä¼šæ€ä¹ˆæ ·å‘¢</p>
<h1 id="æ•°å­—çš„éfinalé™æ€å­—æ®µ"><a href="#æ•°å­—çš„éfinalé™æ€å­—æ®µ" class="headerlink" title="æ•°å­—çš„éfinalé™æ€å­—æ®µ"></a>æ•°å­—çš„é<code>final</code>é™æ€å­—æ®µ</h1><p>ä¸Šä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> i=<span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>javapç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//çœç•¥å¸¸é‡æ± </span><br><span class="line">&#123;</span><br><span class="line">  public static int i;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: getstatic     #3                  // Field i:I</span><br><span class="line">         6: invokevirtual #4                  // Method java/io/PrintStream.println:(I)V</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 6: 0</span><br><span class="line">        line 7: 9</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=0, args_size=0</span><br><span class="line">         0: bipush        100</span><br><span class="line">         2: putstatic     #3                  // Field i:I</span><br><span class="line">         5: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 3: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸºæœ¬å·®ä¸å¤šï¼Œåªæ˜¯<code>ldc</code>æ¢æˆäº†<code>bipush</code>ã€‚<code>bipush</code>å°±æ˜¯æŠŠåé¢çš„æ“ä½œæ•°ï¼ˆ100ï¼‰å‹å…¥æ ˆã€‚å¦‚æœå‹å…¥çš„ä¸æ˜¯100ï¼Œè€Œæ˜¯æ›´å¤§æˆ–æ›´å°ï¼Œé‚£ä¹ˆç”¨çš„æŒ‡ä»¤å°±ä¼šä¸åŒçš„äº†ï¼Œä¾‹å¦‚<code>iconst_1</code>æŒ‡ä»¤ï¼Œå°±æ˜¯å‹å…¥1åˆ°æ ˆã€‚è‡³äºmainå‡½æ•°é‡Œé¢ï¼Œè¿˜æ˜¯ç”¨<code>getstatic</code>æŒ‡ä»¤è·å–å­—æ®µçš„å€¼ã€‚</p>
<h1 id="æ•°å­—çš„finalé™æ€å­—æ®µ"><a href="#æ•°å­—çš„finalé™æ€å­—æ®µ" class="headerlink" title="æ•°å­—çš„finalé™æ€å­—æ®µ"></a>æ•°å­—çš„<code>final</code>é™æ€å­—æ®µ</h1><p>ä¸Šä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> i=<span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>javapç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  public static final int i;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line">    ConstantValue: int 100</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: bipush        100</span><br><span class="line">         5: invokevirtual #3                  // Method java/io/PrintStream.println:(I)V</span><br><span class="line">         8: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 6: 0</span><br><span class="line">        line 7: 8</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ²¡å•¥æƒŠå–œçš„ï¼Œå°±æ˜¯é™æ€å—å»æ‰ï¼Œéœ€è¦è·å–å­—æ®µçš„å€¼çš„åœ°æ–¹ä»<code>getstatic</code>å˜æˆäº†<code>bipush</code>ã€‚</p>
<p>è‡³äºå®ä¾‹å­—æ®µæ˜¯æ€ä¹ˆæ ·çš„ï¼Œåº”è¯¥éƒ½å·®ä¸å¤šäº†ï¼Œå°±ä¸åˆ—ä¸¾äº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å­—æ®µç±»å‹æ˜¯å¼•ç”¨çš„æ˜¯æ€ä¹ˆæ ·å‘¢ã€‚</p>
<h1 id="åŠ finalçš„å¼•ç”¨ç±»å‹å­—æ®µ"><a href="#åŠ finalçš„å¼•ç”¨ç±»å‹å­—æ®µ" class="headerlink" title="åŠ finalçš„å¼•ç”¨ç±»å‹å­—æ®µ"></a>åŠ <code>final</code>çš„å¼•ç”¨ç±»å‹å­—æ®µ</h1><p>ä¸Šä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Object o=<span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(o);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>javapç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  public static final java.lang.Object o;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL</span><br><span class="line"></span><br><span class="line">  public test();</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 1: 0</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: getstatic     #3                  // Field o:Ljava/lang/Object;</span><br><span class="line">         6: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/Object;)V</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 6: 0</span><br><span class="line">        line 7: 9</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=0, args_size=0</span><br><span class="line">         0: new           #5                  // class java/lang/Object</span><br><span class="line">         3: dup</span><br><span class="line">         4: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         7: putstatic     #3                  // Field o:Ljava/lang/Object;</span><br><span class="line">        10: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 3: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç›´æ¥ä¸Š<code>final</code>çš„ç‰ˆæœ¬ï¼Œæ˜¯å› ä¸ºåŠ ä¸åŠ <code>final</code>ï¼Œå…¶å®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯æœ‰é™æ€å—ï¼Œå¼•ç”¨çš„æ—¶å€™ä¸å†æœ‰ä»€ä¹ˆå…¶ä»–æŒ‡ä»¤äº†ï¼Œè€è€å®å®çš„ç”¨<code>getstatic</code>ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¯¹äºå­—ç¬¦ä¸²æˆ–è€…æ•°å­—ç±»å‹ï¼Œä»–ä»¬éƒ½æ˜¯å±äºå­—é¢é‡ï¼Œç¼–è¯‘æ—¶å·²ç»çŸ¥é“ï¼Œä»–ä»¬è¦ä¹ˆå­˜åœ¨å¸¸é‡æ± é‡Œé¢ï¼Œè¦ä¹ˆå­˜åœ¨æŒ‡ä»¤çš„æ“ä½œæ•°é‡Œé¢ï¼Œæ‰€ä»¥åŠ <code>final</code>æ ‡è¯†çš„æƒ…å†µä¸‹ï¼Œè·å–å€¼æ—¶ä¸ç”¨å†åˆ°å…³è”çš„å¯¹è±¡åº•ä¸‹å»è·å–äº†ï¼Œå› ä¸º<code>final</code>å°±æ˜¯ä¸å˜ï¼Œç›´æ¥è°ƒç”¨ç›¸å…³æŒ‡ä»¤å»å¸¸é‡æ± ï¼Œæˆ–è€…ç›´æ¥æ“ä½œæ•°å–å°±å¥½ã€‚</p>
<p>å¯¹äºå¼•ç”¨ç±»å‹ï¼Œè¿™ä¸ªåŸºæœ¬è¦åˆ°è¿è¡Œæ—¶æ‰èƒ½ç¡®è®¤ä»–ä»¬çš„å¼•ç”¨åœ°å€ï¼Œæ‰€ä»¥åŠ ä¸åŠ <code>final</code>éƒ½æ˜¯ä¸€æ ·ã€‚</p>
<p>çœ‹æ¥å­—èŠ‚ç æ‰æ˜¯æœ€èƒ½ç¡®å®šjavaæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œæ‰€ä»¥ä¸å…¶æ‰¾ç½‘ä¸Šçš„è¯´æ³•ä¸å¦‚<code>javap</code>ä¸€ä¸‹çœ‹çœ‹ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸€ç›´å¾ˆå¥½å¥‡&lt;code&gt;final&lt;/code&gt;çš„ç±»å­—æ®µåœ¨classæ–‡ä»¶æ˜¯æ€ä¹ˆè¡¨ç¤ºçš„ï¼Œæ‰€ä»¥ç”¨javapçœ‹çœ‹æ€ä¹ˆå›äº‹,ä¹Ÿé¡ºä¾¿å¤ä¹ ä¸‹å­—èŠ‚ç æŒ‡ä»¤ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ&quot;&gt;&lt;a href=&quot;#æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ&quot; class=&quot;headerlink&quot; title=&quot;æ²¡æœ‰finalä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ&quot;&gt;&lt;/a&gt;æ²¡æœ‰&lt;code&gt;final&lt;/code&gt;ä¿®é¥°çš„ç±»çš„é™æ€å­—æ®µ&lt;/h1&gt;&lt;p&gt;å®šä¹‰ä¸€ä¸ªç±»&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;test&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String str=&lt;span class=&quot;string&quot;&gt;&quot;ä¸¥&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        System.out.println(str);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.top/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.top/tags/java/"/>
    
      <category term="javap" scheme="http://idiotsky.top/tags/javap/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°</title>
    <link href="http://idiotsky.top/2018/06/27/distributed-transaction/"/>
    <id>http://idiotsky.top/2018/06/27/distributed-transaction/</id>
    <published>2018-06-27T12:53:24.000Z</published>
    <updated>2018-07-26T01:29:54.426Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ğŸ‘¿markä¹‹</p>
</blockquote>
<p>åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¼ä¸šé›†æˆä¸­çš„ä¸€ä¸ªæŠ€æœ¯éš¾ç‚¹ï¼Œä¹Ÿæ˜¯æ¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸­éƒ½ä¼šæ¶‰åŠåˆ°çš„ä¸€ä¸ªä¸œè¥¿ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿™å‡ å¹´è¶Šæ¥è¶Šç«çš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå‡ ä¹å¯ä»¥è¯´æ˜¯æ— æ³•é¿å…ï¼Œæœ¬æ–‡å°±å›´ç»•åˆ†å¸ƒå¼äº‹åŠ¡å„æ–¹é¢ä¸å¤§å®¶è¿›è¡Œä»‹ç»ã€‚</p>
<h1 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h1><h2 id="ä»€ä¹ˆæ˜¯äº‹åŠ¡"><a href="#ä»€ä¹ˆæ˜¯äº‹åŠ¡" class="headerlink" title="ä»€ä¹ˆæ˜¯äº‹åŠ¡"></a>ä»€ä¹ˆæ˜¯äº‹åŠ¡</h2><p>æ•°æ®åº“äº‹åŠ¡ï¼ˆç®€ç§°ï¼šäº‹åŠ¡ï¼ŒTransactionï¼‰æ˜¯æŒ‡æ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œç”±ä¸€ä¸ªæœ‰é™çš„æ•°æ®åº“æ“ä½œåºåˆ—æ„æˆã€‚</p>
<p>äº‹åŠ¡æ‹¥æœ‰ä»¥ä¸‹å››ä¸ªç‰¹æ€§ï¼Œä¹ æƒ¯ä¸Šè¢«ç§°ä¸ºACIDç‰¹æ€§ï¼š</p>
<ol>
<li>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«æ‰§è¡Œï¼ŒåŒ…å«åœ¨å…¶ä¸­çš„å¯¹æ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚</li>
<li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡åº”ç¡®ä¿æ•°æ®åº“çš„çŠ¶æ€ä»ä¸€ä¸ªä¸€è‡´çŠ¶æ€è½¬å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚ä¸€è‡´çŠ¶æ€æ˜¯æŒ‡æ•°æ®åº“ä¸­çš„æ•°æ®åº”æ»¡è¶³å®Œæ•´æ€§çº¦æŸã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸€è‡´æ€§è¿˜æœ‰å¦å¤–ä¸€å±‚è¯­ä¹‰ï¼Œå°±æ˜¯äº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ä¸èƒ½è¢«è§‚å¯Ÿåˆ°ï¼ˆè¿™å±‚è¯­ä¹‰ä¹Ÿæœ‰è¯´åº”è¯¥å±äºåŸå­æ€§ï¼‰ã€‚</li>
<li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”å½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œï¼Œå¦‚åŒåªæœ‰è¿™ä¸€ä¸ªæ“ä½œåœ¨è¢«æ•°æ®åº“æ‰€æ‰§è¡Œä¸€æ ·ã€‚</li>
<li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šå·²è¢«æäº¤çš„äº‹åŠ¡å¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚åœ¨äº‹åŠ¡ç»“æŸæ—¶ï¼Œæ­¤æ“ä½œå°†ä¸å¯é€†è½¬ã€‚</li>
</ol>
<a id="more"></a>
<h2 id="æœ¬åœ°äº‹åŠ¡"><a href="#æœ¬åœ°äº‹åŠ¡" class="headerlink" title="æœ¬åœ°äº‹åŠ¡"></a>æœ¬åœ°äº‹åŠ¡</h2><p>èµ·åˆï¼Œäº‹åŠ¡ä»…é™äºå¯¹å•ä¸€æ•°æ®åº“èµ„æºçš„è®¿é—®æ§åˆ¶ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-1.jpg"><img src="http://idiotsky.top/images3/dt-1.jpg" alt=""></a></p>
<p>æ¶æ„æœåŠ¡åŒ–ä»¥åï¼Œäº‹åŠ¡çš„æ¦‚å¿µå»¶ä¼¸åˆ°äº†æœåŠ¡ä¸­ã€‚å€˜è‹¥å°†ä¸€ä¸ªå•ä¸€çš„æœåŠ¡æ“ä½œä½œä¸ºä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆæ•´ä¸ªæœåŠ¡æ“ä½œåªèƒ½æ¶‰åŠä¸€ä¸ªå•ä¸€çš„æ•°æ®åº“èµ„æºï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-2.jpg"><img src="http://idiotsky.top/images3/dt-2.jpg" alt=""></a></p>
<p>è¿™ç±»åŸºäºå•ä¸ªæœåŠ¡å•ä¸€æ•°æ®åº“èµ„æºè®¿é—®çš„äº‹åŠ¡ï¼Œè¢«ç§°ä¸ºæœ¬åœ°äº‹åŠ¡ï¼ˆLocal Transactionï¼‰ã€‚</p>
<h1 id="åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„"></a>åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„</h1><p>æœ¬åœ°äº‹åŠ¡ä¸»è¦é™åˆ¶åœ¨å•ä¸ªä¼šè¯å†…ï¼Œä¸æ¶‰åŠå¤šä¸ªæ•°æ®åº“èµ„æºã€‚ä½†æ˜¯åœ¨åŸºäºSOAï¼ˆService-Oriented Architectureï¼Œé¢å‘æœåŠ¡æ¶æ„ï¼‰çš„åˆ†å¸ƒå¼åº”ç”¨ç¯å¢ƒä¸‹ï¼Œè¶Šæ¥è¶Šå¤šçš„åº”ç”¨è¦æ±‚å¯¹å¤šä¸ªæ•°æ®åº“èµ„æºï¼Œå¤šä¸ªæœåŠ¡çš„è®¿é—®éƒ½èƒ½çº³å…¥åˆ°åŒä¸€ä¸ªäº‹åŠ¡å½“ä¸­ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡åº”è¿è€Œç”Ÿã€‚</p>
<p>æœ€æ—©çš„åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„å¾ˆç®€å•ï¼Œä¸æ¶‰åŠæœåŠ¡é—´çš„è®¿é—®è°ƒç”¨ï¼Œä»…ä»…æ˜¯æœåŠ¡å†…æ“ä½œæ¶‰åŠåˆ°å¯¹å¤šä¸ªæ•°æ®åº“èµ„æºçš„è®¿é—®ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-3.jpg"><img src="http://idiotsky.top/images3/dt-3.jpg" alt=""></a></p>
<p>å½“ä¸€ä¸ªæœåŠ¡æ“ä½œè®¿é—®ä¸åŒçš„æ•°æ®åº“èµ„æºï¼Œåˆå¸Œæœ›å¯¹å®ƒä»¬çš„è®¿é—®å…·æœ‰äº‹åŠ¡ç‰¹æ€§æ—¶ï¼Œå°±éœ€è¦é‡‡ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ¥åè°ƒæ‰€æœ‰çš„äº‹åŠ¡å‚ä¸è€…ã€‚</p>
<p>å¯¹äºä¸Šé¢ä»‹ç»çš„åˆ†å¸ƒå¼äº‹åŠ¡åº”ç”¨æ¶æ„ï¼Œå°½ç®¡ä¸€ä¸ªæœåŠ¡æ“ä½œä¼šè®¿é—®å¤šä¸ªæ•°æ®åº“èµ„æºï¼Œä½†æ˜¯æ¯•ç«Ÿæ•´ä¸ªäº‹åŠ¡è¿˜æ˜¯æ§åˆ¶åœ¨å•ä¸€æœåŠ¡çš„å†…éƒ¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡æ“ä½œéœ€è¦è°ƒç”¨å¦å¤–ä¸€ä¸ªæœåŠ¡ï¼Œè¿™æ—¶çš„äº‹åŠ¡å°±éœ€è¦è·¨è¶Šå¤šä¸ªæœåŠ¡äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œèµ·å§‹äºæŸä¸ªæœåŠ¡çš„äº‹åŠ¡åœ¨è°ƒç”¨å¦å¤–ä¸€ä¸ªæœåŠ¡çš„æ—¶å€™ï¼Œéœ€è¦ä»¥æŸç§æœºåˆ¶æµè½¬åˆ°å¦å¤–ä¸€ä¸ªæœåŠ¡ï¼Œä»è€Œä½¿è¢«è°ƒç”¨çš„æœåŠ¡è®¿é—®çš„èµ„æºä¹Ÿè‡ªåŠ¨åŠ å…¥åˆ°è¯¥äº‹åŠ¡å½“ä¸­æ¥ã€‚ä¸‹å›¾åæ˜ äº†è¿™æ ·ä¸€ä¸ªè·¨è¶Šå¤šä¸ªæœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-4.jpg"><img src="http://idiotsky.top/images3/dt-4.jpg" alt=""></a></p>
<p>å¦‚æœå°†ä¸Šé¢è¿™ä¸¤ç§åœºæ™¯ï¼ˆä¸€ä¸ªæœåŠ¡å¯ä»¥è°ƒç”¨å¤šä¸ªæ•°æ®åº“èµ„æºï¼Œä¹Ÿå¯ä»¥è°ƒç”¨å…¶ä»–æœåŠ¡ï¼‰ç»“åˆåœ¨ä¸€èµ·ï¼Œå¯¹æ­¤è¿›è¡Œå»¶ä¼¸ï¼Œæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„å‚ä¸è€…å°†ä¼šç»„æˆå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ ‘å½¢æ‹“æ‰‘ç»“æ„ã€‚åœ¨ä¸€ä¸ªè·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œäº‹åŠ¡çš„å‘èµ·è€…å’Œæäº¤å‡ç³»åŒä¸€ä¸ªï¼Œå®ƒå¯ä»¥æ˜¯æ•´ä¸ªè°ƒç”¨çš„å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯å®¢æˆ·ç«¯æœ€å…ˆè°ƒç”¨çš„é‚£ä¸ªæœåŠ¡ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-5.jpg"><img src="http://idiotsky.top/images3/dt-5.jpg" alt=""></a></p>
<p>è¾ƒä¹‹åŸºäºå•ä¸€æ•°æ®åº“èµ„æºè®¿é—®çš„æœ¬åœ°äº‹åŠ¡ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„åº”ç”¨æ¶æ„æ›´ä¸ºå¤æ‚ã€‚åœ¨ä¸åŒçš„åˆ†å¸ƒå¼åº”ç”¨æ¶æ„ä¸‹ï¼Œå®ç°ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡è¦è€ƒè™‘çš„é—®é¢˜å¹¶ä¸å®Œå…¨ä¸€æ ·ï¼Œæ¯”å¦‚å¯¹å¤šèµ„æºçš„åè°ƒã€äº‹åŠ¡çš„è·¨æœåŠ¡ä¼ æ’­ç­‰ï¼Œå®ç°æœºåˆ¶ä¹Ÿæ˜¯å¤æ‚å¤šå˜ã€‚å°½ç®¡æœ‰è¿™ä¹ˆå¤šå·¥ç¨‹ç»†èŠ‚éœ€è¦è€ƒè™‘ï¼Œä½†åˆ†å¸ƒå¼äº‹åŠ¡æœ€æ ¸å¿ƒçš„è¿˜æ˜¯å…¶ ACID ç‰¹æ€§ã€‚å› æ­¤ï¼Œæƒ³è¦äº†è§£ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå°±å…ˆä»äº†è§£å®ƒæ˜¯æ€ä¹ˆå®ç°äº‹åŠ¡ ACID ç‰¹æ€§å¼€å§‹ã€‚</p>
<p>ä¸‹æ–‡å°†ä»ä¸¤ä¸ªæœ€å¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹å…¥æ‰‹ï¼Œç€é‡åˆ†æåˆ†å¸ƒå¼äº‹åŠ¡çš„åŸºç¡€å…±é€šç‚¹ï¼Œå³å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ ACID ç‰¹æ€§ã€‚</p>
<h1 id="å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹-ACID-å®ç°åˆ†æ"><a href="#å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹-ACID-å®ç°åˆ†æ" class="headerlink" title="å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ ACID å®ç°åˆ†æ"></a>å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ ACID å®ç°åˆ†æ</h1><h2 id="X-Open-XA-åè®®"><a href="#X-Open-XA-åè®®" class="headerlink" title="X/Open XA åè®®"></a>X/Open XA åè®®</h2><p>æœ€æ—©çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹æ˜¯ X/Open å›½é™…è”ç›Ÿæå‡ºçš„ X/Open Distributed Transaction Processingï¼ˆDTPï¼‰æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶å¸¸è¯´çš„ X/Open XA åè®®ï¼Œç®€ç§°XA åè®®ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-6.jpg"><img src="http://idiotsky.top/images3/dt-6.jpg" alt=""></a></p>
<p>DTP æ¨¡å‹ä¸­åŒ…å«ä¸€ä¸ªå…¨å±€äº‹åŠ¡ç®¡ç†å™¨ï¼ˆTMï¼ŒTransaction Managerï¼‰å’Œå¤šä¸ªèµ„æºç®¡ç†å™¨ï¼ˆRMï¼ŒResource Managerï¼‰ã€‚å…¨å±€äº‹åŠ¡ç®¡ç†å™¨è´Ÿè´£ç®¡ç†å…¨å±€äº‹åŠ¡çŠ¶æ€ä¸å‚ä¸çš„èµ„æºï¼ŒååŒèµ„æºä¸€èµ·æäº¤æˆ–å›æ»šï¼›èµ„æºç®¡ç†å™¨åˆ™è´Ÿè´£å…·ä½“çš„èµ„æºæ“ä½œã€‚</p>
<p>XA åè®®æè¿°äº† TM ä¸ RM ä¹‹é—´çš„æ¥å£ï¼Œå…è®¸å¤šä¸ªèµ„æºåœ¨åŒä¸€åˆ†å¸ƒå¼äº‹åŠ¡ä¸­è®¿é—®ã€‚</p>
<p>åŸºäº DTP æ¨¡å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-7.jpg"><img src="http://idiotsky.top/images3/dt-7.jpg" alt=""></a></p>
<ol>
<li>åº”ç”¨ç¨‹åºï¼ˆAPï¼ŒApplicationï¼‰å‘ TM ç”³è¯·å¼€å§‹ä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚</li>
<li>é’ˆå¯¹è¦æ“ä½œçš„ RMï¼ŒAP ä¼šå…ˆå‘ TM æ³¨å†Œï¼ˆTM è´Ÿè´£è®°å½• AP æ“ä½œè¿‡å“ªäº› RMï¼Œå³åˆ†æ”¯äº‹åŠ¡ï¼‰ï¼ŒTM é€šè¿‡ XA æ¥å£å‡½æ•°é€šçŸ¥ç›¸åº” RM å¼€å¯åˆ†å¸ƒå¼äº‹åŠ¡çš„å­äº‹åŠ¡ï¼Œæ¥ç€ AP å°±å¯ä»¥å¯¹è¯¥ RM ç®¡ç†çš„èµ„æºè¿›è¡Œæ“ä½œã€‚</li>
<li>å½“ AP å¯¹æ‰€æœ‰ RM æ“ä½œå®Œæ¯•åï¼ŒAP æ ¹æ®æ‰§è¡Œæƒ…å†µé€šçŸ¥ TM æäº¤æˆ–å›æ»šè¯¥å…¨å±€äº‹åŠ¡ï¼ŒTM é€šè¿‡ XA æ¥å£å‡½æ•°é€šçŸ¥å„ RM å®Œæˆæ“ä½œã€‚TM ä¼šå…ˆè¦æ±‚å„ä¸ª RM åšé¢„æäº¤ï¼Œæ‰€æœ‰ RM è¿”å›æˆåŠŸåï¼Œå†è¦æ±‚å„ RM åšæ­£å¼æäº¤ï¼ŒXA åè®®è¦æ±‚ï¼Œä¸€æ—¦ RM é¢„æäº¤æˆåŠŸï¼Œåˆ™åç»­çš„æ­£å¼æäº¤ä¹Ÿå¿…é¡»èƒ½æˆåŠŸï¼›å¦‚æœä»»æ„ä¸€ä¸ª RM é¢„æäº¤å¤±è´¥ï¼Œåˆ™ TM é€šçŸ¥å„ RM å›æ»šã€‚</li>
<li>æ‰€æœ‰ RM æäº¤æˆ–å›æ»šå®Œæˆåï¼Œå…¨å±€äº‹åŠ¡ç»“æŸã€‚</li>
</ol>
<h3 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h3><p>XA åè®®ä½¿ç”¨ 2PCï¼ˆTwo Phase Commitï¼Œä¸¤é˜¶æ®µæäº¤ï¼‰åŸå­æäº¤åè®®æ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡åŸå­æ€§ã€‚</p>
<p>ä¸¤é˜¶æ®µæäº¤æ˜¯æŒ‡å°†æäº¤è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå³å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰å’Œæäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-8.jpg"><img src="http://idiotsky.top/images3/dt-8.jpg" alt=""></a></p>
<p>å‡†å¤‡é˜¶æ®µï¼š</p>
<p>TM å‘æ¯ä¸ª RM å‘é€å‡†å¤‡æ¶ˆæ¯ã€‚å¦‚æœ RM çš„æœ¬åœ°äº‹åŠ¡æ“ä½œæ‰§è¡ŒæˆåŠŸï¼Œåˆ™è¿”å›æˆåŠŸï¼›å¦‚æœ RM çš„æœ¬åœ°äº‹åŠ¡æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œåˆ™è¿”å›å¤±è´¥ã€‚</p>
<p>æäº¤é˜¶æ®µ</p>
<p>å¦‚æœ TM æ”¶åˆ°äº†æ‰€æœ‰ RM å›å¤çš„æˆåŠŸæ¶ˆæ¯ï¼Œåˆ™å‘æ¯ä¸ª RM å‘é€æäº¤æ¶ˆæ¯ï¼›å¦åˆ™å‘é€å›æ»šæ¶ˆæ¯ï¼›RM æ ¹æ® TM çš„æŒ‡ä»¤æ‰§è¡Œæäº¤æˆ–è€…å›æ»šæœ¬åœ°äº‹åŠ¡æ“ä½œï¼Œé‡Šæ”¾æ‰€æœ‰äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨çš„é”èµ„æºã€‚</p>
<h3 id="éš”ç¦»æ€§"><a href="#éš”ç¦»æ€§" class="headerlink" title="éš”ç¦»æ€§"></a>éš”ç¦»æ€§</h3><p>XA åè®®ä¸­æ²¡æœ‰æè¿°å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œä½†æ˜¯ XA åè®®è¦æ±‚DTP æ¨¡å‹ä¸­çš„æ¯ä¸ª RM éƒ½è¦å®ç°æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŸºäº XA åè®®å®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯ç”±æ¯ä¸ª RM æœ¬åœ°äº‹åŠ¡çš„éš”ç¦»æ€§æ¥ä¿è¯çš„ï¼Œå½“ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰€æœ‰å­äº‹åŠ¡éƒ½æ˜¯éš”ç¦»çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å¤©ç„¶çš„å°±å®ç°äº†éš”ç¦»æ€§ã€‚</p>
<p>ä»¥ MySQL æ¥ä¸¾ä¾‹ï¼ŒMySQL ä½¿ç”¨ 2PLï¼ˆTwo-Phase Lockingï¼Œä¸¤é˜¶æ®µé”ï¼‰æœºåˆ¶æ¥æ§åˆ¶æœ¬åœ°äº‹åŠ¡çš„å¹¶å‘ï¼Œä¿è¯éš”ç¦»æ€§ã€‚2PL ä¸ 2PC ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å°†é”æ“ä½œåˆ†ä¸ºåŠ é”å’Œè§£é”ä¸¤ä¸ªé˜¶æ®µï¼Œå¹¶ä¸”ä¿è¯ä¸¤ä¸ªé˜¶æ®µå®Œå…¨ä¸ç›¸äº¤ã€‚åŠ é”é˜¶æ®µï¼ŒåªåŠ é”ï¼Œä¸æ”¾é”ã€‚è§£é”é˜¶æ®µï¼Œåªæ”¾é”ï¼Œä¸åŠ é”ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-9.jpg"><img src="http://idiotsky.top/images3/dt-9.jpg" alt=""></a></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ï¼Œæ¯æ‰§è¡Œä¸€æ¡æ›´æ–°æ“ä½œä¹‹å‰ï¼Œéƒ½ä¼šå…ˆè·å–å¯¹åº”çš„é”èµ„æºï¼Œåªæœ‰è·å–é”èµ„æºæˆåŠŸæ‰ä¼šæ‰§è¡Œè¯¥æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦è·å–äº†é”èµ„æºå°±ä¼šæŒæœ‰è¯¥é”èµ„æºç›´åˆ°æœ¬äº‹åŠ¡æ‰§è¡Œç»“æŸã€‚</p>
<p>MySQL é€šè¿‡è¿™ç§ 2PL æœºåˆ¶ï¼Œå¯ä»¥ä¿è¯åœ¨æœ¬åœ°äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½æ“ä½œç›¸åŒèµ„æºï¼Œä»è€Œå®ç°äº†äº‹åŠ¡éš”ç¦»ã€‚</p>
<h3 id="ä¸€è‡´æ€§"><a href="#ä¸€è‡´æ€§" class="headerlink" title="ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h3><p>å‰é¢æåˆ°ä¸€è‡´æ€§æœ‰ä¸¤å±‚è¯­ä¹‰ï¼Œä¸€å±‚æ˜¯ç¡®ä¿äº‹åŠ¡æ‰§è¡Œç»“æŸåï¼Œæ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´çŠ¶æ€è½¬å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚å¦ä¸€å±‚è¯­ä¹‰æ˜¯äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€ä¸èƒ½è¢«è§‚å¯Ÿåˆ°ã€‚</p>
<p>å‰ä¸€å±‚è¯­ä¹‰çš„å®ç°å¾ˆç®€å•ï¼Œé€šè¿‡åŸå­æ€§ã€éš”ç¦»æ€§ä»¥åŠ RM è‡ªèº«ä¸€è‡´æ€§çš„å®ç°å°±å¯ä»¥ä¿è¯ã€‚è‡³äºåä¸€å±‚è¯­ä¹‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å•ä¸ª RM ä¸Šçš„æœ¬åœ°äº‹åŠ¡æ˜¯æ€ä¹ˆå®ç°çš„ã€‚è¿˜æ˜¯ä»¥ MySQL ä¸¾ä¾‹ï¼ŒMySQL é€šè¿‡ MVCCï¼ˆMulti Version Concurrency Controlï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æœºåˆ¶ï¼Œä¸ºæ¯ä¸ªä¸€è‡´æ€§çŠ¶æ€ç”Ÿæˆå¿«ç…§ï¼ˆSnapshotï¼‰ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½æ˜¯å„Snapshotå¯¹åº”çš„ä¸€è‡´æ€§çŠ¶æ€ï¼Œä»è€Œä¹Ÿå°±ä¿è¯äº†æœ¬åœ°äº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ä¸ä¼šè¢«è§‚å¯Ÿåˆ°ã€‚</p>
<p>è™½ç„¶å•ä¸ª RM ä¸Šå®ç°äº†Snapshotï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼åº”ç”¨æ¶æ„ä¸‹ï¼Œä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<p><a href="http://idiotsky.top/images3/dt-10.jpg"><img src="http://idiotsky.top/images3/dt-10.jpg" alt=""></a></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ RM1 çš„æœ¬åœ°å­äº‹åŠ¡æäº¤å®Œæ¯•åˆ° RM2 çš„æœ¬åœ°å­äº‹åŠ¡æäº¤å®Œæ¯•ä¹‹é—´ï¼Œåªèƒ½è¯»åˆ° RM1 ä¸Šå­äº‹åŠ¡æ‰§è¡Œçš„å†…å®¹ï¼Œè¯»ä¸åˆ° RM2 ä¸Šçš„å­äº‹åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶åœ¨å•ä¸ª RM ä¸Šçš„æœ¬åœ°äº‹åŠ¡æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯ä»å…¨å±€æ¥çœ‹ï¼Œä¸€ä¸ªå…¨å±€äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹çš„ä¸­é—´çŠ¶æ€è¢«è§‚å¯Ÿåˆ°äº†ï¼Œå…¨å±€ä¸€è‡´æ€§å°±è¢«ç ´åäº†ã€‚</p>
<p>XA åè®®å¹¶æ²¡æœ‰å®šä¹‰æ€ä¹ˆå®ç°å…¨å±€çš„ Snapshotï¼Œåƒ MySQL å®˜æ–¹æ–‡æ¡£é‡Œå°±å»ºè®®ä½¿ç”¨ä¸²è¡ŒåŒ–çš„éš”ç¦»çº§åˆ«æ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ï¼š â€œAs with nondistributed transactions, SERIALIZABLE may be preferred if your applications are sensitive to read phenomena. REPEATABLE READ may not be sufficient for distributed transactions.â€ï¼ˆå¯¹äºåˆ†å¸ƒå¼äº‹åŠ¡æ¥è¯´ï¼Œå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸è¶³ä»¥ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ï¼Œå¦‚æœä½ çš„ç¨‹åºæœ‰å…¨å±€ä¸€è‡´æ€§è¯»è¦æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«.ï¼‰</p>
<p>å½“ç„¶ï¼Œç”±äºä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«çš„æ€§èƒ½è¾ƒå·®ï¼Œæ‰€ä»¥å¾ˆå¤šåˆ†å¸ƒå¼æ•°æ®åº“éƒ½è‡ªå·±å®ç°äº†åˆ†å¸ƒå¼ MVCC æœºåˆ¶æ¥æä¾›å…¨å±€çš„ä¸€è‡´æ€§è¯»ã€‚ä¸€ä¸ªåŸºæœ¬æ€è·¯æ˜¯ç”¨ä¸€ä¸ªé›†ä¸­å¼æˆ–è€…é€»è¾‘ä¸Šå•è°ƒé€’å¢çš„ä¸œè¥¿æ¥æ§åˆ¶ç”Ÿæˆå…¨å±€ Snapshotï¼Œæ¯ä¸ªäº‹åŠ¡æˆ–è€…æ¯æ¡ SQL æ‰§è¡Œæ—¶éƒ½å»è·å–ä¸€æ¬¡ï¼Œä»è€Œå®ç°ä¸åŒéš”ç¦»çº§åˆ«ä¸‹çš„ä¸€è‡´æ€§ã€‚æ¯”å¦‚ Google çš„ Spanner å°±æ˜¯ç”¨ TrueTime æ¥æ§åˆ¶è®¿é—®å…¨å±€ Snapshotã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>XA åè®®é€šå¸¸å®ç°åœ¨æ•°æ®åº“èµ„æºå±‚ï¼Œç›´æ¥ä½œç”¨äºèµ„æºç®¡ç†å™¨ä¸Šã€‚å› æ­¤ï¼ŒåŸºäº XA åè®®å®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡äº§å“ï¼Œæ— è®ºæ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œå¯¹ä¸šåŠ¡å‡ ä¹éƒ½æ²¡æœ‰ä¾µå…¥ï¼Œå°±åƒä½¿ç”¨æ™®é€šæ•°æ®åº“ä¸€æ ·ã€‚</p>
<p>XA åè®®ä¸¥æ ¼ä¿éšœäº‹åŠ¡ ACID ç‰¹æ€§ï¼Œèƒ½å¤Ÿæ»¡è¶³æ‰€æœ‰ä¸šåŠ¡é¢†åŸŸçš„åŠŸèƒ½éœ€æ±‚ï¼Œä½†æ˜¯ï¼Œè¿™åŒæ ·æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚</p>
<p>ç”±äºéš”ç¦»æ€§çš„äº’æ–¥è¦æ±‚ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰çš„èµ„æºéƒ½è¢«é”å®šï¼Œåªé€‚ç”¨äºæ‰§è¡Œæ—¶é—´ç¡®å®šçš„çŸ­äº‹åŠ¡ã€‚åŒæ—¶ï¼Œæ•´ä¸ªäº‹åŠ¡æœŸé—´éƒ½æ˜¯ç‹¬å æ•°æ®ï¼Œå¯¹äºçƒ­ç‚¹æ•°æ®çš„å¹¶å‘æ€§èƒ½å¯èƒ½ä¼šå¾ˆä½ï¼Œå®ç°äº†åˆ†å¸ƒå¼ MVCC æˆ–ä¹è§‚é”ï¼ˆoptimistic lockingï¼‰ä»¥åï¼Œæ€§èƒ½å¯èƒ½ä¼šæœ‰æ‰€æå‡ã€‚</p>
<p>åŒæ—¶ï¼Œä¸ºäº†ä¿éšœä¸€è‡´æ€§ï¼Œè¦æ±‚æ‰€æœ‰ RM åŒç­‰å¯ä¿¡ã€å¯é ï¼Œè¦æ±‚æ•…éšœæ¢å¤æœºåˆ¶å¯é ã€å¿«é€Ÿï¼Œåœ¨ç½‘ç»œæ•…éšœéš”ç¦»çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡åŸºæœ¬ä¸å¯ç”¨ã€‚</p>
<h2 id="TCC-æ¨¡å‹"><a href="#TCC-æ¨¡å‹" class="headerlink" title="TCC æ¨¡å‹"></a>TCC æ¨¡å‹</h2><p>TCCï¼ˆTry-Confirm-Cancelï¼‰åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ç›¸å¯¹äº XA ç­‰ä¼ ç»Ÿæ¨¡å‹ï¼Œå…¶ç‰¹å¾åœ¨äºå®ƒä¸ä¾èµ–èµ„æºç®¡ç†å™¨ï¼ˆRMï¼‰å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æ”¯æŒï¼Œè€Œæ˜¯é€šè¿‡å¯¹ä¸šåŠ¡é€»è¾‘çš„åˆ†è§£æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<p>TCC æ¨¡å‹è®¤ä¸ºå¯¹äºä¸šåŠ¡ç³»ç»Ÿä¸­ä¸€ä¸ªç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘ï¼Œå…¶å¯¹å¤–æä¾›æœåŠ¡æ—¶ï¼Œå¿…é¡»æ¥å—ä¸€äº›ä¸ç¡®å®šæ€§ï¼Œå³å¯¹ä¸šåŠ¡é€»è¾‘åˆæ­¥æ“ä½œçš„è°ƒç”¨ä»…æ˜¯ä¸€ä¸ªä¸´æ—¶æ€§æ“ä½œï¼Œè°ƒç”¨å®ƒçš„ä¸»ä¸šåŠ¡æœåŠ¡ä¿ç•™äº†åç»­çš„å–æ¶ˆæƒã€‚å¦‚æœä¸»ä¸šåŠ¡æœåŠ¡è®¤ä¸ºå…¨å±€äº‹åŠ¡åº”è¯¥å›æ»šï¼Œå®ƒä¼šè¦æ±‚å–æ¶ˆä¹‹å‰çš„ä¸´æ—¶æ€§æ“ä½œï¼Œè¿™å°±å¯¹åº”ä»ä¸šåŠ¡æœåŠ¡çš„å–æ¶ˆæ“ä½œã€‚è€Œå½“ä¸»ä¸šåŠ¡æœåŠ¡è®¤ä¸ºå…¨å±€äº‹åŠ¡åº”è¯¥æäº¤æ—¶ï¼Œå®ƒä¼šæ”¾å¼ƒä¹‹å‰ä¸´æ—¶æ€§æ“ä½œçš„å–æ¶ˆæƒï¼Œè¿™å¯¹åº”ä»ä¸šåŠ¡æœåŠ¡çš„ç¡®è®¤æ“ä½œã€‚æ¯ä¸€ä¸ªåˆæ­¥æ“ä½œï¼Œæœ€ç»ˆéƒ½ä¼šè¢«ç¡®è®¤æˆ–å–æ¶ˆã€‚</p>
<p>å› æ­¤ï¼Œé’ˆå¯¹ä¸€ä¸ªå…·ä½“çš„ä¸šåŠ¡æœåŠ¡ï¼ŒTCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹éœ€è¦ä¸šåŠ¡ç³»ç»Ÿæä¾›ä¸‰æ®µä¸šåŠ¡é€»è¾‘ï¼š</p>
<ol>
<li>åˆæ­¥æ“ä½œ Tryï¼šå®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼Œé¢„ç•™å¿…é¡»çš„ä¸šåŠ¡èµ„æºã€‚</li>
<li>ç¡®è®¤æ“ä½œ Confirmï¼šçœŸæ­£æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸ä½œä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼Œåªä½¿ç”¨ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚å› æ­¤ï¼Œåªè¦ Try æ“ä½œæˆåŠŸï¼ŒConfirm å¿…é¡»èƒ½æˆåŠŸã€‚å¦å¤–ï¼ŒConfirm æ“ä½œéœ€æ»¡è¶³å¹‚ç­‰æ€§ï¼Œä¿è¯ä¸€ç¬”åˆ†å¸ƒå¼äº‹åŠ¡æœ‰ä¸”åªèƒ½æˆåŠŸä¸€æ¬¡ã€‚</li>
<li>å–æ¶ˆæ“ä½œ Cancelï¼šé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚åŒæ ·çš„ï¼ŒCancel æ“ä½œä¹Ÿéœ€è¦æ»¡è¶³å¹‚ç­‰æ€§ã€‚</li>
</ol>
<p><a href="http://idiotsky.top/images3/dt-11.jpg"><img src="http://idiotsky.top/images3/dt-11.jpg" alt=""></a></p>
<p>TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>ä¸»ä¸šåŠ¡æœåŠ¡ï¼šä¸»ä¸šåŠ¡æœåŠ¡ä¸ºæ•´ä¸ªä¸šåŠ¡æ´»åŠ¨çš„å‘èµ·æ–¹ï¼ŒæœåŠ¡çš„ç¼–æ’è€…ï¼Œè´Ÿè´£å‘èµ·å¹¶å®Œæˆæ•´ä¸ªä¸šåŠ¡æ´»åŠ¨ã€‚</li>
<li>ä»ä¸šåŠ¡æœåŠ¡ï¼šä»ä¸šåŠ¡æœåŠ¡æ˜¯æ•´ä¸ªä¸šåŠ¡æ´»åŠ¨çš„å‚ä¸æ–¹ï¼Œè´Ÿè´£æä¾› TCC ä¸šåŠ¡æ“ä½œï¼Œå®ç°åˆæ­¥æ“ä½œï¼ˆTryï¼‰ã€ç¡®è®¤æ“ä½œï¼ˆConfirmï¼‰ã€å–æ¶ˆæ“ä½œï¼ˆCancelï¼‰ä¸‰ä¸ªæ¥å£ï¼Œä¾›ä¸»ä¸šåŠ¡æœåŠ¡è°ƒç”¨ã€‚</li>
<li>ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ï¼šä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ç®¡ç†æ§åˆ¶æ•´ä¸ªä¸šåŠ¡æ´»åŠ¨ï¼ŒåŒ…æ‹¬è®°å½•ç»´æŠ¤ TCC å…¨å±€äº‹åŠ¡çš„äº‹åŠ¡çŠ¶æ€å’Œæ¯ä¸ªä»ä¸šåŠ¡æœåŠ¡çš„å­äº‹åŠ¡çŠ¶æ€ï¼Œå¹¶åœ¨ä¸šåŠ¡æ´»åŠ¨æäº¤æ—¶è°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Confirm æ“ä½œï¼Œåœ¨ä¸šåŠ¡æ´»åŠ¨å–æ¶ˆæ—¶è°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Cancel æ“ä½œã€‚</li>
</ol>
<p>ä¸€ä¸ªå®Œæ•´çš„ TCC åˆ†å¸ƒå¼äº‹åŠ¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä¸»ä¸šåŠ¡æœåŠ¡é¦–å…ˆå¼€å¯æœ¬åœ°äº‹åŠ¡ï¼›</li>
<li>ä¸»ä¸šåŠ¡æœåŠ¡å‘ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ç”³è¯·å¯åŠ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸»ä¸šåŠ¡æ´»åŠ¨ï¼›</li>
<li>ç„¶åé’ˆå¯¹è¦è°ƒç”¨çš„ä»ä¸šåŠ¡æœåŠ¡ï¼Œä¸»ä¸šåŠ¡æ´»åŠ¨å…ˆå‘ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨æ³¨å†Œä»ä¸šåŠ¡æ´»åŠ¨ï¼Œç„¶åè°ƒç”¨ä»ä¸šåŠ¡æœåŠ¡çš„ Try æ¥å£ï¼›</li>
<li>å½“æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Try æ¥å£è°ƒç”¨æˆåŠŸï¼Œä¸»ä¸šåŠ¡æœåŠ¡æäº¤æœ¬åœ°äº‹åŠ¡ï¼›è‹¥è°ƒç”¨å¤±è´¥ï¼Œä¸»ä¸šåŠ¡æœåŠ¡å›æ»šæœ¬åœ°äº‹åŠ¡ï¼›</li>
<li>è‹¥ä¸»ä¸šåŠ¡æœåŠ¡æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œåˆ™ TCC æ¨¡å‹åˆ†åˆ«è°ƒç”¨æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Confirm æ¥å£ï¼›è‹¥ä¸»ä¸šåŠ¡æœåŠ¡å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œåˆ™åˆ†åˆ«è°ƒç”¨ Cancel æ¥å£ï¼›</li>
<li>æ‰€æœ‰ä»ä¸šåŠ¡æœåŠ¡çš„ Confirm æˆ– Cancel æ“ä½œå®Œæˆåï¼Œå…¨å±€äº‹åŠ¡ç»“æŸã€‚</li>
</ol>
<h3 id="åŸå­æ€§-1"><a href="#åŸå­æ€§-1" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h3><p>TCC æ¨¡å‹ä¹Ÿä½¿ç”¨ 2PC åŸå­æäº¤åè®®æ¥ä¿è¯äº‹åŠ¡åŸå­æ€§ã€‚Try æ“ä½œå¯¹åº”2PC çš„ä¸€é˜¶æ®µå‡†å¤‡ï¼ˆPrepareï¼‰ï¼›Confirm å¯¹åº” 2PC çš„äºŒé˜¶æ®µæäº¤ï¼ˆCommitï¼‰ï¼ŒCancel å¯¹åº” 2PC çš„äºŒé˜¶æ®µå›æ»šï¼ˆRollbackï¼‰ï¼Œå¯ä»¥è¯´ TCC å°±æ˜¯åº”ç”¨å±‚çš„ 2PCã€‚</p>
<h3 id="éš”ç¦»æ€§-1"><a href="#éš”ç¦»æ€§-1" class="headerlink" title="éš”ç¦»æ€§"></a>éš”ç¦»æ€§</h3><p>TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ä»…æä¾›ä¸¤é˜¶æ®µåŸå­æäº¤åè®®ï¼Œä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡åŸå­æ€§ã€‚äº‹åŠ¡çš„éš”ç¦»äº¤ç»™ä¸šåŠ¡é€»è¾‘æ¥å®ç°ã€‚</p>
<p>éš”ç¦»çš„æœ¬è´¨æ˜¯æ§åˆ¶å¹¶å‘ï¼Œé˜²æ­¢å¹¶å‘äº‹åŠ¡æ“ä½œç›¸åŒèµ„æºè€Œå¼•èµ·çš„ç»“æœé”™ä¹±ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚é‡‘èè¡Œä¸šé‡Œç®¡ç†ç”¨æˆ·èµ„é‡‘ï¼Œå½“ç”¨æˆ·å‘èµ·äº¤æ˜“æ—¶ï¼Œä¸€èˆ¬ä¼šå…ˆæ£€æŸ¥ç”¨æˆ·èµ„é‡‘ï¼Œå¦‚æœèµ„é‡‘å……è¶³ï¼Œåˆ™æ‰£é™¤ç›¸åº”äº¤æ˜“é‡‘é¢ï¼Œå¢åŠ å–å®¶èµ„é‡‘ï¼Œå®Œæˆäº¤æ˜“ã€‚å¦‚æœæ²¡æœ‰äº‹åŠ¡éš”ç¦»ï¼Œç”¨æˆ·åŒæ—¶å‘èµ·ä¸¤ç¬”äº¤æ˜“ï¼Œä¸¤ç¬”äº¤æ˜“çš„æ£€æŸ¥éƒ½è®¤ä¸ºèµ„é‡‘å……è¶³ï¼Œå®é™…ä¸Šå´åªå¤Ÿæ”¯ä»˜ä¸€ç¬”äº¤æ˜“ï¼Œç»“æœä¸¤ç¬”äº¤æ˜“éƒ½æ”¯ä»˜æˆåŠŸï¼Œå¯¼è‡´èµ„æŸã€‚</p>
<p>å¯ä»¥å‘ç°ï¼Œå¹¶å‘æ§åˆ¶æ˜¯ä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ­£ç¡®çš„ä¿è¯ï¼Œä½†æ˜¯åƒä¸¤é˜¶æ®µé”è¿™æ ·çš„å¹¶å‘è®¿é—®æ§åˆ¶æŠ€æœ¯è¦æ±‚ä¸€ç›´æŒæœ‰æ•°æ®åº“èµ„æºé”ç›´åˆ°æ•´ä¸ªäº‹åŠ¡æ‰§è¡Œç»“æŸï¼Œç‰¹åˆ«æ˜¯åœ¨åˆ†å¸ƒå¼äº‹åŠ¡æ¶æ„ä¸‹ï¼Œè¦æ±‚æŒæœ‰é”åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ç¬¬äºŒé˜¶æ®µæ‰§è¡Œç»“æŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¼šåŠ é•¿èµ„æºé”çš„æŒæœ‰æ—¶é—´ï¼Œå¯¼è‡´å¹¶å‘æ€§èƒ½è¿›ä¸€æ­¥ä¸‹é™ã€‚</p>
<p>å› æ­¤ï¼ŒTCC æ¨¡å‹çš„éš”ç¦»æ€§æ€æƒ³å°±æ˜¯é€šè¿‡ä¸šåŠ¡çš„æ”¹é€ ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µç»“æŸä¹‹åï¼Œä»åº•å±‚æ•°æ®åº“èµ„æºå±‚é¢çš„åŠ é”è¿‡æ¸¡ä¸ºä¸Šå±‚ä¸šåŠ¡å±‚é¢çš„åŠ é”ï¼Œä»è€Œé‡Šæ”¾åº•å±‚æ•°æ®åº“é”èµ„æºï¼Œæ”¾å®½åˆ†å¸ƒå¼äº‹åŠ¡é”åè®®ï¼Œæé«˜ä¸šåŠ¡å¹¶å‘æ€§èƒ½ã€‚</p>
<p>è¿˜æ˜¯ä»¥ä¸Šé¢çš„ä¾‹å­ä¸¾ä¾‹ï¼š</p>
<ol>
<li>ç¬¬ä¸€é˜¶æ®µï¼šæ£€æŸ¥ç”¨æˆ·èµ„é‡‘ï¼Œå¦‚æœèµ„é‡‘å……è¶³ï¼Œå†»ç»“ç”¨æˆ·æœ¬æ¬¡äº¤æ˜“èµ„é‡‘ï¼Œè¿™ç¬”èµ„é‡‘è¢«ä¸šåŠ¡éš”ç¦»ï¼Œä¸å…è®¸é™¤æœ¬äº‹åŠ¡ä¹‹å¤–çš„å…¶å®ƒå¹¶å‘äº‹åŠ¡åŠ¨ç”¨ã€‚</li>
<li>ç¬¬äºŒé˜¶æ®µï¼šæ‰£é™¤ç¬¬ä¸€é˜¶æ®µé¢„å†»ç»“çš„ç”¨æˆ·èµ„é‡‘ï¼Œå¢åŠ å–å®¶èµ„é‡‘ï¼Œå®Œæˆäº¤æ˜“ã€‚ é‡‡ç”¨ä¸šåŠ¡åŠ é”çš„æ–¹å¼ï¼Œéš”ç¦»ç”¨æˆ·å†»ç»“èµ„é‡‘ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µç»“æŸåç›´æ¥é‡Šæ”¾åº•å±‚èµ„æºé”ï¼Œè¯¥ç”¨æˆ·å’Œå–å®¶çš„å…¶ä»–äº¤æ˜“éƒ½å¯ä»¥ç«‹åˆ»å¹¶å‘æ‰§è¡Œï¼Œè€Œä¸ç”¨ç­‰åˆ°æ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ç»“æŸï¼Œå¯ä»¥è·å¾—æ›´é«˜çš„å¹¶å‘äº¤æ˜“èƒ½åŠ›ã€‚</li>
</ol>
<h3 id="ä¸€è‡´æ€§-1"><a href="#ä¸€è‡´æ€§-1" class="headerlink" title="ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h3><p>å†æ¥çœ‹çœ‹ TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ä¸‹çš„ä¸€è‡´æ€§å®ç°ã€‚ä¸ XA åè®®å®ç°ä¸€è‡´æ€§ç¬¬ä¸€å±‚è¯­ä¹‰ç±»ä¼¼ï¼Œé€šè¿‡åŸå­æ€§ä¿è¯äº‹åŠ¡çš„åŸå­æäº¤ã€ä¸šåŠ¡éš”ç¦»æ€§æ§åˆ¶äº‹åŠ¡çš„å¹¶å‘è®¿é—®ï¼Œå®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§çŠ¶æ€è½¬å˜ã€‚</p>
<p>è‡³äºç¬¬äºŒå±‚è¯­ä¹‰ï¼šäº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ä¸èƒ½è¢«è§‚å¯Ÿåˆ°ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œåœ¨ SOAåˆ†å¸ƒå¼åº”ç”¨ç¯å¢ƒä¸‹æ˜¯å¦æ˜¯å¿…é¡»çš„ã€‚</p>
<p>è¿˜æ˜¯ä»¥è´¦åŠ¡æœåŠ¡ä¸¾ä¾‹ã€‚è½¬è´¦ä¸šåŠ¡ï¼ˆç”¨æˆ· A ïƒ  ç”¨æˆ· Bï¼‰ï¼Œç”±äº¤æ˜“æœåŠ¡å’Œè´¦åŠ¡æœåŠ¡ç»„æˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œäº¤æ˜“æœåŠ¡ä½œä¸ºä¸»ä¸šåŠ¡æœåŠ¡ï¼Œè´¦åŠ¡æœåŠ¡ä½œä¸ºä»ä¸šåŠ¡æœåŠ¡ï¼Œè´¦åŠ¡æœåŠ¡çš„ Try æ“ä½œé¢„å†»ç»“ç”¨æˆ· A çš„èµ„é‡‘ï¼›Commit æ“ä½œæ‰£é™¤ç”¨æˆ· A çš„é¢„å†»ç»“èµ„é‡‘ï¼Œå¢åŠ ç”¨æˆ· B çš„å¯ç”¨èµ„é‡‘ï¼›Cancel æ“ä½œè§£å†»ç”¨æˆ· A çš„é¢„å†»ç»“èµ„é‡‘ã€‚</p>
<p>å½“è´¦åŠ¡æœåŠ¡æ‰§è¡Œå®Œ Try é˜¶æ®µåï¼Œäº¤æ˜“ä¸»ä¸šåŠ¡å°±å¯ä»¥ Commit äº†ï¼Œç„¶åç”±TCC æ¡†æ¶è°ƒç”¨è´¦åŠ¡çš„ Commit é˜¶æ®µã€‚åœ¨è´¦åŠ¡ Commit é˜¶æ®µè¿˜æ²¡æ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œç”¨æˆ· A å¯ä»¥æŸ¥è¯¢åˆ°è‡ªå·±çš„ä½™é¢å·²æ‰£é™¤ï¼Œä½†æ˜¯ï¼Œæ­¤æ—¶ç”¨æˆ· B çš„å¯ç”¨èµ„é‡‘è¿˜æ²¡å¢åŠ ã€‚</p>
<p>ä»ç³»ç»Ÿçš„è§’åº¦æ¥çœ‹ï¼Œç¡®å®æœ‰é—®é¢˜ä¸ä¸ç¡®å®šæ€§ã€‚åœ¨ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œç»“æŸåˆ°ç¬¬äºŒé˜¶æ®µæ‰§è¡Œç»“æŸä¹‹é—´ï¼Œæœ‰ä¸€æ®µæ—¶é—´çš„å»¶æ—¶ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œçœ‹ä¼¼ä»»ä½•ç”¨æˆ·éƒ½ä¸äº«æœ‰è¿™ç¬”èµ„äº§ã€‚</p>
<p>ä½†æ˜¯ï¼Œä»ç”¨æˆ·çš„è§’åº¦æ¥è€ƒè™‘è¿™ä¸ªé—®é¢˜çš„è¯ï¼Œè¿™ä¸ªæ—¶é—´é—´éš”å¯èƒ½å°±æ— æ‰€è°“æˆ–è€…æ ¹æœ¬å°±ä¸å­˜åœ¨ã€‚ç‰¹åˆ«æ˜¯å½“è¿™ä¸ªæ—¶é—´é—´éš”ä»…ä»…æ˜¯å‡ ç§’é’Ÿï¼Œå¯¹äºå…·ä½“æ²Ÿé€šèµ„äº§è½¬ç§»çš„ç”¨æˆ·æ¥è®²ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯éšè”½çš„æˆ–ç¡®å®å¯ä»¥æ¥å—çš„ï¼Œä¸”ä¿è¯äº†ç»“æœçš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<p>å½“ç„¶ï¼Œå¯¹äºè¿™æ ·çš„ç³»ç»Ÿï¼Œå¦‚æœç¡®å®éœ€è¦æŸ¥çœ‹ç³»ç»Ÿçš„æŸä¸ªä¸€è‡´æ€§çŠ¶æ€ï¼Œå¯ä»¥é‡‡ç”¨é¢å¤–çš„æ–¹æ³•å®ç°ã€‚</p>
<p>ä¸€èˆ¬æ¥è®²ï¼ŒæœåŠ¡ä¹‹é—´çš„ä¸€è‡´æ€§æ¯”æœåŠ¡å†…éƒ¨çš„ä¸€è‡´æ€§è¦æ›´åŠ å®¹æ˜“å¼±åŒ–ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ XA ç­‰ç›´æ¥åœ¨èµ„æºå±‚é¢ä¸Šå®ç°é€šç”¨åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¨¡å‹ä¼šæ³¨é‡ä¸€è‡´æ€§çš„ä¿è¯ï¼Œè€Œå½“ä¸Šå‡åˆ°æœåŠ¡å±‚é¢ï¼ŒæœåŠ¡ä¸æœåŠ¡ä¹‹é—´å·²ç»å®ç°äº†åŠŸèƒ½çš„åˆ’åˆ†ï¼Œé€»è¾‘çš„è§£è€¦ï¼Œä¹Ÿå°±æ›´å®¹æ˜“å¼±åŒ–ä¸€è‡´æ€§ï¼Œè¿™å°±æ˜¯ SOA æ¶æ„ä¸‹ BASE ç†è®ºçš„æœ€ç»ˆä¸€è‡´æ€§æ€æƒ³ã€‚</p>
<p>BASE ç†è®ºæ˜¯æŒ‡ BAï¼ˆBasic Availabilityï¼ŒåŸºæœ¬ä¸šåŠ¡å¯ç”¨æ€§ï¼‰ï¼›Sï¼ˆSoft stateï¼ŒæŸ”æ€§çŠ¶æ€ï¼‰ï¼›Eï¼ˆEventual consistencyï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€‚è¯¥ç†è®ºè®¤ä¸ºä¸ºäº†å¯ç”¨æ€§ã€æ€§èƒ½ä¸é™çº§æœåŠ¡çš„éœ€è¦ï¼Œå¯ä»¥é€‚å½“é™ä½ä¸€ç‚¹ä¸€è‡´æ€§çš„è¦æ±‚ï¼Œå³â€œåŸºæœ¬å¯ç”¨ï¼Œæœ€ç»ˆä¸€è‡´â€ã€‚</p>
<p>ä¸šå†…é€šå¸¸æŠŠä¸¥æ ¼éµå¾ª ACID çš„äº‹åŠ¡ç§°ä¸ºåˆšæ€§äº‹åŠ¡ï¼›è€ŒåŸºäº BASE æ€æƒ³å®ç°çš„äº‹åŠ¡ç§°ä¸ºæŸ”æ€§äº‹åŠ¡ã€‚æŸ”æ€§äº‹åŠ¡å¹¶ä¸æ˜¯å®Œå…¨æ”¾å¼ƒäº† ACIDï¼Œä»…ä»…æ˜¯æ”¾å®½äº†ä¸€è‡´æ€§è¦æ±‚ï¼šäº‹åŠ¡å®Œæˆåçš„ä¸€è‡´æ€§ä¸¥æ ¼éµå¾ªï¼Œäº‹åŠ¡ä¸­çš„ä¸€è‡´æ€§å¯é€‚å½“æ”¾å®½ï¼›</p>
<h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>TCC åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹çš„ä¸šåŠ¡å®ç°ç‰¹æ€§å†³å®šäº†å…¶å¯ä»¥è·¨ DBã€è·¨æœåŠ¡å®ç°èµ„æºç®¡ç†ï¼Œå°†å¯¹ä¸åŒçš„ DB è®¿é—®ã€ä¸åŒçš„ä¸šåŠ¡æ“ä½œé€šè¿‡ TCC æ¨¡å‹åè°ƒä¸ºä¸€ä¸ªåŸå­æ“ä½œï¼Œè§£å†³äº†åˆ†å¸ƒå¼åº”ç”¨æ¶æ„åœºæ™¯ä¸‹çš„äº‹åŠ¡é—®é¢˜ã€‚</p>
<p>TCC æ¨¡å‹é€šè¿‡ 2PC åŸå­æäº¤åè®®ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„çš„åŸå­æ€§ï¼ŒæŠŠèµ„æºå±‚çš„éš”ç¦»æ€§ä¸Šå‡åˆ°ä¸šåŠ¡å±‚ï¼Œäº¤ç»™ä¸šåŠ¡é€»è¾‘æ¥å®ç°ã€‚TCC çš„æ¯ä¸ªæ“ä½œå¯¹äºèµ„æºå±‚æ¥è¯´ï¼Œå°±æ˜¯å•ä¸ªæœ¬åœ°äº‹åŠ¡çš„ä½¿ç”¨ï¼Œæ“ä½œç»“æŸåˆ™æœ¬åœ°äº‹åŠ¡ç»“æŸï¼Œè§„é¿äº†èµ„æºå±‚åœ¨ 2PC å’Œ 2PL ä¸‹å¯¹èµ„æºå ç”¨å¯¼è‡´çš„æ€§èƒ½ä½ä¸‹é—®é¢˜ã€‚</p>
<p>åŒæ—¶ï¼ŒTCC æ¨¡å‹ä¹Ÿå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œåšä¸€äº›å®šåˆ¶åŒ–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚äº¤æ˜“å¼‚æ­¥åŒ–å®ç°å‰Šå³°å¡«è°·ç­‰ã€‚</p>
<p>ä½†æ˜¯ï¼Œä¸šåŠ¡æ¥å…¥ TCC æ¨¡å‹éœ€è¦æ‹†åˆ†ä¸šåŠ¡é€»è¾‘æˆä¸¤ä¸ªé˜¶æ®µï¼Œå¹¶å®ç° Tryã€Confirmã€Cancel ä¸‰ä¸ªæ¥å£ï¼Œå®šåˆ¶åŒ–ç¨‹åº¦é«˜ï¼Œå¼€å‘æˆæœ¬é«˜ã€‚</p>
<h1 id="å…¶ä»–è§£å†³æ–¹æ¡ˆ"><a href="#å…¶ä»–è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…¶ä»–è§£å†³æ–¹æ¡ˆ"></a>å…¶ä»–è§£å†³æ–¹æ¡ˆ</h1><h2 id="æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå¼‚æ­¥ç¡®ä¿ï¼‰"><a href="#æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå¼‚æ­¥ç¡®ä¿ï¼‰" class="headerlink" title="æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå¼‚æ­¥ç¡®ä¿ï¼‰"></a>æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆå¼‚æ­¥ç¡®ä¿ï¼‰</h2><p>æœ¬åœ°æ¶ˆæ¯è¡¨è¿™ç§å®ç°æ–¹å¼åº”è¯¥æ˜¯ä¸šç•Œä½¿ç”¨æœ€å¤šçš„ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†æˆæœ¬åœ°äº‹åŠ¡è¿›è¡Œå¤„ç†ï¼Œè¿™ç§æ€è·¯æ˜¯æ¥æºäºebayã€‚æˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢çš„æµç¨‹å›¾ä¸­çœ‹å‡ºå…¶ä¸­çš„ä¸€äº›ç»†èŠ‚ï¼š</p>
<p><a href="http://idiotsky.top/images3/dt-12.png"><img src="http://idiotsky.top/images3/dt-12.png" alt=""></a></p>
<p>åŸºæœ¬æ€è·¯å°±æ˜¯ï¼š</p>
<p>æ¶ˆæ¯ç”Ÿäº§æ–¹ï¼Œéœ€è¦é¢å¤–å»ºä¸€ä¸ªæ¶ˆæ¯è¡¨ï¼Œå¹¶è®°å½•æ¶ˆæ¯å‘é€çŠ¶æ€ã€‚æ¶ˆæ¯è¡¨å’Œä¸šåŠ¡æ•°æ®è¦åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œæäº¤ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä»¬è¦åœ¨ä¸€ä¸ªæ•°æ®åº“é‡Œé¢ã€‚ç„¶åæ¶ˆæ¯ä¼šç»è¿‡MQå‘é€åˆ°æ¶ˆæ¯çš„æ¶ˆè´¹æ–¹ã€‚å¦‚æœæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œä¼šè¿›è¡Œé‡è¯•å‘é€ã€‚</p>
<p>æ¶ˆæ¯æ¶ˆè´¹æ–¹ï¼Œéœ€è¦å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œå¹¶å®Œæˆè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚æ­¤æ—¶å¦‚æœæœ¬åœ°äº‹åŠ¡å¤„ç†æˆåŠŸï¼Œè¡¨æ˜å·²ç»å¤„ç†æˆåŠŸäº†ï¼Œå¦‚æœå¤„ç†å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šé‡è¯•æ‰§è¡Œã€‚å¦‚æœæ˜¯ä¸šåŠ¡ä¸Šé¢çš„å¤±è´¥ï¼Œå¯ä»¥ç»™ç”Ÿäº§æ–¹å‘é€ä¸€ä¸ªä¸šåŠ¡è¡¥å¿æ¶ˆæ¯ï¼Œé€šçŸ¥ç”Ÿäº§æ–¹è¿›è¡Œå›æ»šç­‰æ“ä½œã€‚</p>
<p>ç”Ÿäº§æ–¹å’Œæ¶ˆè´¹æ–¹å®šæ—¶æ‰«ææœ¬åœ°æ¶ˆæ¯è¡¨ï¼ŒæŠŠè¿˜æ²¡å¤„ç†å®Œæˆçš„æ¶ˆæ¯æˆ–è€…å¤±è´¥çš„æ¶ˆæ¯å†å‘é€ä¸€éã€‚å¦‚æœæœ‰é è°±çš„è‡ªåŠ¨å¯¹è´¦è¡¥è´¦é€»è¾‘ï¼Œè¿™ç§æ–¹æ¡ˆè¿˜æ˜¯éå¸¸å®ç”¨çš„ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆéµå¾ªBASEç†è®ºï¼Œé‡‡ç”¨çš„æ˜¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œç¬”è€…è®¤ä¸ºæ˜¯è¿™å‡ ç§æ–¹æ¡ˆé‡Œé¢æ¯”è¾ƒé€‚åˆå®é™…ä¸šåŠ¡åœºæ™¯çš„ï¼Œå³ä¸ä¼šå‡ºç°åƒ2PCé‚£æ ·å¤æ‚çš„å®ç°(å½“è°ƒç”¨é“¾å¾ˆé•¿çš„æ—¶å€™ï¼Œ2PCçš„å¯ç”¨æ€§æ˜¯éå¸¸ä½çš„)ï¼Œä¹Ÿä¸ä¼šåƒTCCé‚£æ ·å¯èƒ½å‡ºç°ç¡®è®¤æˆ–è€…å›æ»šä¸äº†çš„æƒ…å†µã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼š ä¸€ç§éå¸¸ç»å…¸çš„å®ç°ï¼Œé¿å…äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå®ç°äº†æœ€ç»ˆä¸€è‡´æ€§ã€‚</li>
<li>ç¼ºç‚¹ï¼š æ¶ˆæ¯è¡¨ä¼šè€¦åˆåˆ°ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œå¦‚æœæ²¡æœ‰å°è£…å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä¼šæœ‰å¾ˆå¤šæ‚æ´»éœ€è¦å¤„ç†ã€‚</li>
</ul>
<h2 id="MQ-äº‹åŠ¡æ¶ˆæ¯"><a href="#MQ-äº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="MQ äº‹åŠ¡æ¶ˆæ¯"></a>MQ äº‹åŠ¡æ¶ˆæ¯</h2><p>æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„MQæ˜¯æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„ï¼Œæ¯”å¦‚RocketMQï¼Œä»–ä»¬æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼äºé‡‡ç”¨çš„äºŒé˜¶æ®µæäº¤ï¼Œä½†æ˜¯å¸‚é¢ä¸Šä¸€äº›ä¸»æµçš„MQéƒ½æ˜¯ä¸æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„ï¼Œæ¯”å¦‚ RabbitMQ å’Œ Kafka éƒ½ä¸æ”¯æŒã€‚</p>
<p>ä»¥é˜¿é‡Œçš„ RocketMQ ä¸­é—´ä»¶ä¸ºä¾‹ï¼Œå…¶æ€è·¯å¤§è‡´ä¸ºï¼š</p>
<p>ç¬¬ä¸€é˜¶æ®µPreparedæ¶ˆæ¯ï¼Œä¼šæ‹¿åˆ°æ¶ˆæ¯çš„åœ°å€ã€‚<br>ç¬¬äºŒé˜¶æ®µæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œç¬¬ä¸‰é˜¶æ®µé€šè¿‡ç¬¬ä¸€é˜¶æ®µæ‹¿åˆ°çš„åœ°å€å»è®¿é—®æ¶ˆæ¯ï¼Œå¹¶ä¿®æ”¹çŠ¶æ€ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸šåŠ¡æ–¹æ³•å†…è¦å‘æ¶ˆæ¯é˜Ÿåˆ—æäº¤ä¸¤æ¬¡è¯·æ±‚ï¼Œä¸€æ¬¡å‘é€æ¶ˆæ¯å’Œä¸€æ¬¡ç¡®è®¤æ¶ˆæ¯ã€‚å¦‚æœç¡®è®¤æ¶ˆæ¯å‘é€å¤±è´¥äº†RocketMQä¼šå®šæœŸæ‰«ææ¶ˆæ¯é›†ç¾¤ä¸­çš„äº‹åŠ¡æ¶ˆæ¯ï¼Œè¿™æ—¶å€™å‘ç°äº†Preparedæ¶ˆæ¯ï¼Œå®ƒä¼šå‘æ¶ˆæ¯å‘é€è€…ç¡®è®¤ï¼Œæ‰€ä»¥ç”Ÿäº§æ–¹éœ€è¦å®ç°ä¸€ä¸ªcheckæ¥å£ï¼ŒRocketMQä¼šæ ¹æ®å‘é€ç«¯è®¾ç½®çš„ç­–ç•¥æ¥å†³å®šæ˜¯å›æ»šè¿˜æ˜¯ç»§ç»­å‘é€ç¡®è®¤æ¶ˆæ¯ã€‚è¿™æ ·å°±ä¿è¯äº†æ¶ˆæ¯å‘é€ä¸æœ¬åœ°äº‹åŠ¡åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥ã€‚</p>
<p><a href="http://idiotsky.top/images3/dt-13.png"><img src="http://idiotsky.top/images3/dt-13.png" alt=""></a></p>
<ul>
<li>ä¼˜ç‚¹ï¼š å®ç°äº†æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸éœ€è¦ä¾èµ–æœ¬åœ°æ•°æ®åº“äº‹åŠ¡ã€‚</li>
<li>ç¼ºç‚¹ï¼š å®ç°éš¾åº¦å¤§ï¼Œä¸»æµMQä¸æ”¯æŒï¼ŒRocketMQäº‹åŠ¡æ¶ˆæ¯éƒ¨åˆ†ä»£ç ä¹Ÿæœªå¼€æºã€‚</li>
</ul>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡é¦–å…ˆä»‹ç»äº†å…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¶æ„åœºæ™¯ã€‚åˆ†å¸ƒå¼äº‹åŠ¡åˆšå¼€å§‹æ˜¯ä¸ºè§£å†³å•æœåŠ¡å¤šæ•°æ®åº“èµ„æºçš„åœºæ™¯è€Œè¯ç”Ÿçš„ã€‚éšç€æŠ€æœ¯çš„å‘å±•ï¼Œç‰¹åˆ«æ˜¯ SOA åˆ†å¸ƒå¼åº”ç”¨æ¶æ„ä»¥åŠå¾®æœåŠ¡æ—¶ä»£çš„åˆ°æ¥ï¼ŒæœåŠ¡å˜æˆäº†åŸºæœ¬ä¸šåŠ¡å•å…ƒã€‚å› æ­¤ï¼Œåˆäº§ç”Ÿäº†è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡éœ€æ±‚ã€‚ç„¶åä» XA å’Œ TCC ä¸¤ç§å¸¸ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹å…¥æ‰‹ï¼Œä»‹ç»äº†å…¶å®ç°æœºåˆ¶ï¼Œç€é‡åˆ†æäº†å„æ¨¡å‹æ˜¯å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ ACID ç‰¹æ€§çš„ã€‚è¿˜è®²è§£äº†ç°å®ä¸­å¸¸ç”¨çš„ä¸¤ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆï¼šæœ¬åœ°æ¶ˆæ¯è¡¨å’ŒMQ äº‹åŠ¡æ¶ˆæ¯</p>
<p>å‚è€ƒ</p>
<p><a href="https://zhuanlan.zhihu.com/p/38388143" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/38388143</a><br><a href="https://www.cnblogs.com/savorboard/p/distributed-system-transaction-consistency.html" target="_blank" rel="noopener">https://www.cnblogs.com/savorboard/p/distributed-system-transaction-consistency.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ğŸ‘¿markä¹‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¼ä¸šé›†æˆä¸­çš„ä¸€ä¸ªæŠ€æœ¯éš¾ç‚¹ï¼Œä¹Ÿæ˜¯æ¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸­éƒ½ä¼šæ¶‰åŠåˆ°çš„ä¸€ä¸ªä¸œè¥¿ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿™å‡ å¹´è¶Šæ¥è¶Šç«çš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå‡ ä¹å¯ä»¥è¯´æ˜¯æ— æ³•é¿å…ï¼Œæœ¬æ–‡å°±å›´ç»•åˆ†å¸ƒå¼äº‹åŠ¡å„æ–¹é¢ä¸å¤§å®¶è¿›è¡Œä»‹ç»ã€‚&lt;/p&gt;
&lt;h1 id=&quot;äº‹åŠ¡&quot;&gt;&lt;a href=&quot;#äº‹åŠ¡&quot; class=&quot;headerlink&quot; title=&quot;äº‹åŠ¡&quot;&gt;&lt;/a&gt;äº‹åŠ¡&lt;/h1&gt;&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯äº‹åŠ¡&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯äº‹åŠ¡&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯äº‹åŠ¡&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯äº‹åŠ¡&lt;/h2&gt;&lt;p&gt;æ•°æ®åº“äº‹åŠ¡ï¼ˆç®€ç§°ï¼šäº‹åŠ¡ï¼ŒTransactionï¼‰æ˜¯æŒ‡æ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œç”±ä¸€ä¸ªæœ‰é™çš„æ•°æ®åº“æ“ä½œåºåˆ—æ„æˆã€‚&lt;/p&gt;
&lt;p&gt;äº‹åŠ¡æ‹¥æœ‰ä»¥ä¸‹å››ä¸ªç‰¹æ€§ï¼Œä¹ æƒ¯ä¸Šè¢«ç§°ä¸ºACIDç‰¹æ€§ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«æ‰§è¡Œï¼ŒåŒ…å«åœ¨å…¶ä¸­çš„å¯¹æ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨è¢«æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚&lt;/li&gt;
&lt;li&gt;ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡åº”ç¡®ä¿æ•°æ®åº“çš„çŠ¶æ€ä»ä¸€ä¸ªä¸€è‡´çŠ¶æ€è½¬å˜ä¸ºå¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚ä¸€è‡´çŠ¶æ€æ˜¯æŒ‡æ•°æ®åº“ä¸­çš„æ•°æ®åº”æ»¡è¶³å®Œæ•´æ€§çº¦æŸã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸€è‡´æ€§è¿˜æœ‰å¦å¤–ä¸€å±‚è¯­ä¹‰ï¼Œå°±æ˜¯äº‹åŠ¡çš„ä¸­é—´çŠ¶æ€ä¸èƒ½è¢«è§‚å¯Ÿåˆ°ï¼ˆè¿™å±‚è¯­ä¹‰ä¹Ÿæœ‰è¯´åº”è¯¥å±äºåŸå­æ€§ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸åº”å½±å“å…¶ä»–äº‹åŠ¡çš„æ‰§è¡Œï¼Œå¦‚åŒåªæœ‰è¿™ä¸€ä¸ªæ“ä½œåœ¨è¢«æ•°æ®åº“æ‰€æ‰§è¡Œä¸€æ ·ã€‚&lt;/li&gt;
&lt;li&gt;æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šå·²è¢«æäº¤çš„äº‹åŠ¡å¯¹æ•°æ®åº“çš„ä¿®æ”¹åº”è¯¥æ°¸ä¹…ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚åœ¨äº‹åŠ¡ç»“æŸæ—¶ï¼Œæ­¤æ“ä½œå°†ä¸å¯é€†è½¬ã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://idiotsky.top/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="http://idiotsky.top/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>HTTP æ€»ç»“</title>
    <link href="http://idiotsky.top/2018/05/22/http-summary/"/>
    <id>http://idiotsky.top/2018/05/22/http-summary/</id>
    <published>2018-05-22T14:51:18.000Z</published>
    <updated>2018-07-26T14:18:42.395Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ğŸ‘¿ mark ï¼Œå¾ˆé•¿ ğŸ˜„</p>
</blockquote>
<h1 id="HTTP-æ¦‚è¿°"><a href="#HTTP-æ¦‚è¿°" class="headerlink" title="HTTP æ¦‚è¿°"></a>HTTP æ¦‚è¿°</h1><p>Web ä½¿ç”¨ä¸€ç§åä¸º HTTP (HyperText Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®) çš„åè®®ä½œä¸ºè§„èŒƒçš„ã€‚</p>
<blockquote>
<p>HTTP æ›´åŠ ä¸¥è°¨çš„è¯‘ååº”è¯¥æ˜¯ è¶…æ–‡æœ¬è½¬ç§»åè®®ã€‚</p>
</blockquote>
<p>HTTP äº 1990 å¹´é—®ä¸–ã€‚é‚£æ—¶çš„ HTTP å¹¶æ²¡æœ‰ä½œä¸ºæ­£å¼çš„æ ‡å‡†ï¼Œå› ä¸ºè¢«ç§°ä¸º HTTP/0.9<br>HTTP æ­£å¼ä½œä¸ºæ ‡å‡†è¢«å…¬å¸ƒæ˜¯ 1996 å¹´ 5 æœˆï¼Œç‰ˆæœ¬å‘½åä¸º HTTP/1.0ï¼Œè®°è½½äº RFC1945<br>HTTP åœ¨ 1997 å¹´ 1 æœˆå…¬å¸ƒäº†å½“å‰æœ€ä¸»æµçš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å‘½åä¸º HTTP/1.1ï¼Œè®°è½½äº RFC2616<br>HTTP/2 äº 2015 å¹´ 5 æœˆ 14 æ—¥å‘å¸ƒï¼Œå¼•å…¥äº†æœåŠ¡å™¨æ¨é€ç­‰å¤šç§åŠŸèƒ½ï¼Œæ˜¯ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬ã€‚è®°è½½äº RFC7540<br>(å®ƒä¸å« HTTP/2.0ï¼Œæ˜¯å› ä¸ºæ ‡å‡†å§”å‘˜ä¼šä¸æ‰“ç®—å†å‘å¸ƒå­ç‰ˆæœ¬äº†ï¼Œä¸‹ä¸€ä¸ªæ–°ç‰ˆæœ¬å°†æ˜¯ HTTP/3)</p>
<a id="more"></a>
<h1 id="HTTP-æ”¯æŒçš„æ–¹æ³•"><a href="#HTTP-æ”¯æŒçš„æ–¹æ³•" class="headerlink" title="HTTP æ”¯æŒçš„æ–¹æ³•"></a>HTTP æ”¯æŒçš„æ–¹æ³•</h1><p>HTTP æ˜¯ä¸€ç§ä¸ä¿å­˜çŠ¶æ€ï¼Œå³ æ— çŠ¶æ€ï¼ˆ stateless ï¼‰åè®®ã€‚HTTP åè®®è‡ªèº«ä¸å¯¹è¯·æ±‚å’Œå“åº”ä¹‹é—´çš„é€šä¿¡çŠ¶æ€è¿›è¡Œä¿å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ HTTP è¿™ä¸ªçº§åˆ«ï¼Œåè®®å¯¹äºå‘é€è¿‡çš„è¯·æ±‚æˆ–å“åº”éƒ½ä¸åšæŒä¹…åŒ–å¤„ç†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºäº†æ›´å¿«çš„å¤„ç†å¤§é‡äº‹åŠ¡ï¼Œç¡®ä¿åè®®çš„å¯ä¼¸ç¼©æ€§ã€‚</p>
<p>HTTP/1.1 è™½ç„¶æ˜¯æ— çŠ¶æ€åè®®ï¼Œä½†æ˜¯ä¸ºäº†å®ç°æœŸæœ›çš„ä¿æŒçŠ¶æ€çš„åŠŸèƒ½ï¼Œç‰¹æ„å¼•å…¥äº† Cookie æŠ€æœ¯ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ–¹æ³•å</th>
<th style="text-align:center">è¯´æ˜</th>
<th style="text-align:center">æ”¯æŒçš„ HTTP åè®®ç‰ˆæœ¬</th>
<th style="text-align:center">è¯¦ç»†è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">GET</td>
<td style="text-align:center">è·å–èµ„æº</td>
<td style="text-align:center">1.0ã€1.1</td>
<td style="text-align:center">GET æ–¹æ³•ç”¨æ¥è¯·æ±‚è®¿é—®å·²è¢« URI è¯†åˆ«çš„èµ„æºã€‚æŒ‡å®šçš„èµ„æºç»æœåŠ¡å™¨ç«¯è§£æåè¿”å›å“åº”å†…å®¹ã€‚ï¼ˆæˆ‘æƒ³è®¿é—®ä½ çš„æŸä¸ªèµ„æºï¼‰</td>
</tr>
<tr>
<td style="text-align:center">POST</td>
<td style="text-align:center">ä¼ è¾“å®ä½“ä¸»ä½“</td>
<td style="text-align:center">1.0ã€1.1</td>
<td style="text-align:center">POST æ–¹æ³•ç”¨æ¥ä¼ è¾“å®ä½“çš„ä¸»ä½“ã€‚è™½ç„¶ GET ä¹Ÿå¯ä»¥ä¼ è¾“å®ä½“çš„ä¸»ä½“ï¼Œä½†ä¸€èˆ¬ä¸ç”¨ GET è€Œç”¨ POSTï¼ŒPOST çš„ä¸»è¦ç›®çš„å¹¶ä¸æ˜¯è·å–å“åº”çš„ä¸»ä½“å†…å®¹ã€‚ï¼ˆæˆ‘æƒ³æŠŠè¿™æ¡ä¿¡æ¯å‘Šè¯‰ä½ ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">PUT</td>
<td style="text-align:center">ä¼ è¾“æ–‡ä»¶</td>
<td style="text-align:center">1.0ã€1.1</td>
<td style="text-align:center">è¦æ±‚åœ¨è¯·æ±‚æŠ¥æ–‡çš„ä¸»ä½“ä¸­åŒ…å«æ–‡ä»¶å†…å®¹ï¼Œç„¶åä¿å­˜åˆ°è¯·æ±‚ URI æŒ‡å®šä½ç½®ã€‚ï¼ˆæˆ‘æƒ³è¦æŠŠè¿™ä»½æ–‡ä»¶ä¼ ç»™ä½ ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">HEAD</td>
<td style="text-align:center">è·å–æŠ¥æ–‡é¦–éƒ¨</td>
<td style="text-align:center">1.0ã€1.1</td>
<td style="text-align:center">HEAD æ–¹æ³•å’Œ GET æ–¹æ³•ä¸€æ ·ï¼Œåªæ˜¯ä¸è¿”å›æŠ¥æ–‡ä¸»ä½“éƒ¨åˆ†ã€‚ç”¨äºç¡®è®¤ URI çš„æœ‰æ•ˆæ€§åŠèµ„æºæ›´æ–°çš„æ—¥æœŸæ—¶é—´ç­‰ç­‰ï¼ˆæˆ‘æƒ³è¦é‚£ä¸ªç›¸å…³ä¿¡æ¯ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">DELETE</td>
<td style="text-align:center">åˆ é™¤æ–‡ä»¶</td>
<td style="text-align:center">1.0ã€1.1</td>
<td style="text-align:center">ä¸ PUT ç›¸åçš„æ–¹æ³•ï¼ŒDELETE æ–¹æ³•æŒ‰è¯·æ±‚ URI åˆ é™¤æŒ‡å®šèµ„æºï¼ˆæŠŠè¿™ä»½æ–‡ä»¶åˆ æ‰å§ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">OPTIONS</td>
<td style="text-align:center">è¯¢é—®æ”¯æŒçš„æ–¹æ³•</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">OPTIONS ç”¨æ¥æŸ¥è¯¢é’ˆå¯¹è¯·æ±‚ URI æŒ‡å®šçš„èµ„æºæ”¯æŒçš„æ–¹æ³•ï¼ˆä½ æ”¯æŒå“ªäº›æ–¹æ³•ï¼Ÿï¼‰</td>
</tr>
<tr>
<td style="text-align:center">TRACE</td>
<td style="text-align:center">è¿½è¸ªè·¯å¾„</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">TRACE æ–¹æ³•æ˜¯è®© Web æœåŠ¡å™¨å°†ä¹‹å‰çš„è¯·æ±‚é€šä¿¡è¿”å›ç»™å®¢æˆ·ç«¯çš„æ–¹æ³•ï¼ŒTRACE æ–¹æ³•ä¸å¸¸ç”¨ï¼Œå¹¶ä¸”å®¹æ˜“å¼•å‘ XST ( Cross-Site-Tracing ï¼Œè·¨ç«™è¿½è¸ª)æ”»å‡»ï¼Œæ‰€ä»¥é€šå¸¸æ›´ä¸ä¼šç”¨åˆ°äº†</td>
</tr>
<tr>
<td style="text-align:center">CONNECT</td>
<td style="text-align:center">è¦æ±‚ç”¨éš§é“åè®®è¿æ¥ä»£ç†</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">CONNECT æ–¹æ³•è¦æ±‚åœ¨ä¸ä»£ç†æœåŠ¡å™¨é€šä¿¡æ—¶å»ºç«‹éš§é“ï¼Œå®ç°ç”¨éš§é“åè®®è¿›è¡Œ TCP é€šä¿¡ï¼Œä¸»è¦ä½¿ç”¨ SSL ï¼ˆ Secure Sockets Layers ï¼Œå®‰å…¨å¥—æ¥å±‚ï¼‰å’Œ TLS ï¼ˆ Transport Layer Security ï¼Œä¼ è¾“å±‚å®‰å…¨ï¼‰åè®®æŠŠé€šä¿¡å†…å®¹åŠ å¯†åç»ç½‘ç»œéš§é“ä¼ è¾“</td>
</tr>
<tr>
<td style="text-align:center">PATCH</td>
<td style="text-align:center">æ›´æ–°éƒ¨åˆ†æ–‡ä»¶å†…å®¹</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center"><strong>å½“èµ„æºå­˜åœ¨çš„æ—¶å€™</strong>ï¼ŒPATCH ç”¨äºèµ„æºçš„éƒ¨åˆ†å†…å®¹çš„æ›´æ–°ï¼Œä¾‹å¦‚æ›´æ–°æŸä¸€ä¸ªå­—æ®µã€‚å…·ä½“æ¯”å¦‚è¯´åªæ›´æ–°ç”¨æˆ·ä¿¡æ¯çš„ç”µè¯å·ç å­—æ®µï¼Œè€Œ PUT ç”¨äºæ›´æ–°æŸä¸ªèµ„æºè¾ƒå®Œæ•´çš„å†…å®¹ï¼Œæ¯”å¦‚è¯´ç”¨æˆ·è¦é‡å¡«å®Œæ•´è¡¨å•æ›´æ–°æ‰€æœ‰ä¿¡æ¯ï¼Œåå°å¤„ç†æ›´æ–°æ—¶å¯èƒ½åªæ˜¯ä¿ç•™å†…éƒ¨è®°å½• ID ä¸å˜ã€‚<br><strong>å½“èµ„æºä¸å­˜åœ¨çš„æ—¶å€™</strong>ï¼ŒPATCH æ˜¯ä¿®æ”¹åŸæ¥çš„å†…å®¹ï¼Œä¹Ÿå¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ã€‚æ¯”å¦‚å½“èµ„æºä¸å­˜åœ¨çš„æ—¶å€™ï¼ŒPATCH å¯èƒ½ä¼šå»åˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºï¼Œè¿™ä¸ªæ„ä¹‰ä¸Šåƒæ˜¯ saveOrUpdate æ“ä½œã€‚è€Œ PUT åªå¯¹å·²æœ‰èµ„æºè¿›è¡Œæ›´æ–°æ“ä½œï¼Œæ‰€ä»¥æ˜¯ update æ“ä½œ</td>
</tr>
<tr>
<td style="text-align:center">LINK</td>
<td style="text-align:center">å»ºç«‹å’Œèµ„æºä¹‹é—´çš„è”ç³»</td>
<td style="text-align:center">1.0</td>
<td style="text-align:center">âœ–ï¸æœ€æ–°ç‰ˆä¸­å·²ç»åºŸå¼ƒâœ–ï¸</td>
</tr>
<tr>
<td style="text-align:center">UNLINK</td>
<td style="text-align:center">æ–­å¼€è¿æ¥å…³ç³»</td>
<td style="text-align:center">1.0</td>
<td style="text-align:center">âœ–ï¸æœ€æ–°ç‰ˆä¸­å·²ç»åºŸå¼ƒâœ–ï¸</td>
</tr>
<tr>
<td style="text-align:center">PROPFIND</td>
<td style="text-align:center">è·å–å±æ€§</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">WebDAV è·å–å±æ€§</td>
</tr>
<tr>
<td style="text-align:center">PROPPATCH</td>
<td style="text-align:center">ä¿®æ”¹å±æ€§</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">WebDAV ä¿®æ”¹å±æ€§</td>
</tr>
<tr>
<td style="text-align:center">MKCOL</td>
<td style="text-align:center">åˆ›å»ºå±æ€§</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">WebDAV åˆ›å»ºå±æ€§</td>
</tr>
<tr>
<td style="text-align:center">COPY</td>
<td style="text-align:center">å¤åˆ¶èµ„æºåŠå±æ€§</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">WebDAV å¤åˆ¶èµ„æºåŠå±æ€§</td>
</tr>
<tr>
<td style="text-align:center">MOVE</td>
<td style="text-align:center">ç§»åŠ¨èµ„æº</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">WebDAV ç§»åŠ¨èµ„æº</td>
</tr>
<tr>
<td style="text-align:center">LOCK</td>
<td style="text-align:center">èµ„æºåŠ é”</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">WebDAV èµ„æºåŠ é”</td>
</tr>
<tr>
<td style="text-align:center">UNLOCK</td>
<td style="text-align:center">èµ„æºè§£é”</td>
<td style="text-align:center">1.1</td>
<td style="text-align:center">WebDAV èµ„æºè§£é”</td>
</tr>
</tbody>
</table>
<p>åœ¨HTTP/1.1è§„èŒƒä¸­å¹‚ç­‰æ€§çš„å®šä¹‰æ˜¯ï¼š</p>
<blockquote>
<p>Methods can also have the property of â€œidempotenceâ€ in that (aside from error or expiration issues) the side-effects of N &gt; 0 identical requests is the same as for a single request.</p>
</blockquote>
<p>ä»å®šä¹‰ä¸Šçœ‹ï¼ŒHTTP æ–¹æ³•çš„å¹‚ç­‰æ€§æ˜¯æŒ‡ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºåº”è¯¥å…·æœ‰åŒæ ·çš„å‰¯ä½œç”¨ã€‚å¹‚ç­‰æ€§å±äºè¯­ä¹‰èŒƒç•´ï¼Œæ­£å¦‚ç¼–è¯‘å™¨åªèƒ½å¸®åŠ©æ£€æŸ¥è¯­æ³•é”™è¯¯ä¸€æ ·ï¼ŒHTTP è§„èŒƒä¹Ÿæ²¡æœ‰åŠæ³•é€šè¿‡æ¶ˆæ¯æ ¼å¼ç­‰è¯­æ³•æ‰‹æ®µæ¥å®šä¹‰å®ƒï¼Œè¿™å¯èƒ½æ˜¯å®ƒä¸å¤ªå—åˆ°é‡è§†çš„åŸå› ä¹‹ä¸€ã€‚ä½†å®é™…ä¸Šï¼Œå¹‚ç­‰æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­ååˆ†é‡è¦çš„æ¦‚å¿µï¼Œè€Œ HTTP çš„åˆ†å¸ƒå¼æœ¬è´¨ä¹Ÿå†³å®šäº†å®ƒåœ¨ HTTP ä¸­å…·æœ‰é‡è¦åœ°ä½ã€‚</p>
<p>HTTP æ–¹æ³•çš„å®‰å…¨æ€§æŒ‡çš„æ˜¯ä¸ä¼šæ”¹å˜æœåŠ¡å™¨çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåªæ˜¯å¯è¯»çš„ã€‚æ‰€ä»¥åªæœ‰ OPTIONSã€GETã€HEAD æ˜¯å®‰å…¨çš„ï¼Œå…¶ä»–éƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">HTTP æ–¹æ³•</th>
<th style="text-align:center">å¹‚ç­‰æ€§</th>
<th style="text-align:center">å®‰å…¨æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">OPTIONS</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">GET</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">HEAD</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">yes</td>
</tr>
<tr>
<td style="text-align:center">PUT</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">DELETE</td>
<td style="text-align:center">yes</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">POST</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
<tr>
<td style="text-align:center">PATCH</td>
<td style="text-align:center">no</td>
<td style="text-align:center">no</td>
</tr>
</tbody>
</table>
<p><strong>POST å’Œ PATCH è¿™ä¸¤ä¸ªä¸æ˜¯å¹‚ç­‰æ€§çš„</strong>ã€‚<br>ä¸¤æ¬¡ç›¸åŒçš„POSTè¯·æ±‚ä¼šåœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºä¸¤ä»½èµ„æºï¼Œå®ƒä»¬å…·æœ‰ä¸åŒçš„URIã€‚<br>å¯¹åŒä¸€URIè¿›è¡Œå¤šæ¬¡PUTçš„å‰¯ä½œç”¨å’Œä¸€æ¬¡PUTæ˜¯ç›¸åŒçš„ã€‚  </p>
<h1 id="HTTP-çŠ¶æ€ç "><a href="#HTTP-çŠ¶æ€ç " class="headerlink" title="HTTP çŠ¶æ€ç "></a>HTTP çŠ¶æ€ç </h1><p>æœåŠ¡å™¨è¿”å›çš„  <strong>å“åº”æŠ¥æ–‡</strong>  ä¸­ç¬¬ä¸€è¡Œä¸ºçŠ¶æ€è¡Œï¼ŒåŒ…å«äº†çŠ¶æ€ç ä»¥åŠåŸå› çŸ­è¯­ï¼Œç”¨æ¥å‘ŠçŸ¥å®¢æˆ·ç«¯è¯·æ±‚çš„ç»“æœã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">çŠ¶æ€ç </th>
<th style="text-align:center">ç±»åˆ«</th>
<th style="text-align:center">åŸå› çŸ­è¯­</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1XX</td>
<td style="text-align:center">Informationalï¼ˆä¿¡æ¯æ€§çŠ¶æ€ç ï¼‰</td>
<td style="text-align:center">æ¥æ”¶çš„è¯·æ±‚æ­£åœ¨å¤„ç†</td>
</tr>
<tr>
<td style="text-align:center">2XX</td>
<td style="text-align:center">Successï¼ˆæˆåŠŸçŠ¶æ€ç ï¼‰</td>
<td style="text-align:center">è¯·æ±‚æ­£å¸¸å¤„ç†å®Œæ¯•</td>
</tr>
<tr>
<td style="text-align:center">3XX</td>
<td style="text-align:center">Redirectionï¼ˆé‡å®šå‘çŠ¶æ€ç ï¼‰</td>
<td style="text-align:center">éœ€è¦è¿›è¡Œé™„åŠ æ“ä½œä»¥å®Œæˆè¯·æ±‚</td>
</tr>
<tr>
<td style="text-align:center">4XX</td>
<td style="text-align:center">Client Errorï¼ˆå®¢æˆ·ç«¯é”™è¯¯çŠ¶æ€ç ï¼‰</td>
<td style="text-align:center">æœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚</td>
</tr>
<tr>
<td style="text-align:center">5XX</td>
<td style="text-align:center">Server Errorï¼ˆæœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç ï¼‰</td>
<td style="text-align:center">æœåŠ¡å™¨å¤„ç†è¯·æ±‚å‡ºé”™</td>
</tr>
</tbody>
</table>
<h2 id="1XX-ä¿¡æ¯"><a href="#1XX-ä¿¡æ¯" class="headerlink" title="1XX ä¿¡æ¯"></a>1XX ä¿¡æ¯</h2><ul>
<li><strong>100 Continue</strong> ï¼šè¡¨æ˜åˆ°ç›®å‰ä¸ºæ­¢éƒ½å¾ˆæ­£å¸¸ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç»§ç»­å‘é€è¯·æ±‚æˆ–è€…å¿½ç•¥è¿™ä¸ªå“åº”ã€‚</li>
</ul>
<h2 id="2XX-æˆåŠŸ"><a href="#2XX-æˆåŠŸ" class="headerlink" title="2XX æˆåŠŸ"></a>2XX æˆåŠŸ</h2><ul>
<li><p><strong>200 OK</strong> </p>
</li>
<li><p><strong>204 No Content</strong> ï¼šè¯·æ±‚å·²ç»æˆåŠŸå¤„ç†ï¼Œä½†æ˜¯è¿”å›çš„å“åº”æŠ¥æ–‡ä¸åŒ…å«å®ä½“çš„ä¸»ä½“éƒ¨åˆ†ã€‚ä¸€èˆ¬åœ¨åªéœ€è¦ä»å®¢æˆ·ç«¯å¾€æœåŠ¡å™¨å‘é€ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦è¿”å›æ•°æ®æ—¶ä½¿ç”¨ã€‚</p>
</li>
<li><p><strong>206 Partial Content</strong> ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯è¿›è¡Œäº†èŒƒå›´è¯·æ±‚ã€‚å“åº”æŠ¥æ–‡åŒ…å«ç”± Content-Range æŒ‡å®šèŒƒå›´çš„å®ä½“å†…å®¹ã€‚</p>
</li>
</ul>
<h2 id="3XX-é‡å®šå‘"><a href="#3XX-é‡å®šå‘" class="headerlink" title="3XX é‡å®šå‘"></a>3XX é‡å®šå‘</h2><ul>
<li><p><strong>301 Moved Permanently</strong> ï¼šæ°¸ä¹…æ€§é‡å®šå‘</p>
</li>
<li><p><strong>302 Found</strong> ï¼šä¸´æ—¶æ€§é‡å®šå‘</p>
</li>
<li><p><strong>303 See Other</strong> ï¼šå’Œ 302 æœ‰ç€ç›¸åŒçš„åŠŸèƒ½ï¼Œä½†æ˜¯ 303 æ˜ç¡®è¦æ±‚å®¢æˆ·ç«¯åº”è¯¥é‡‡ç”¨ GET æ–¹æ³•è·å–èµ„æºã€‚</p>
</li>
<li><p>æ³¨ï¼šè™½ç„¶ HTTP åè®®è§„å®š 301ã€302 çŠ¶æ€ä¸‹é‡å®šå‘æ—¶ä¸å…è®¸æŠŠ POST æ–¹æ³•æ”¹æˆ GET æ–¹æ³•ï¼Œä½†æ˜¯å¤§å¤šæ•°æµè§ˆå™¨éƒ½ä¼šåœ¨ 301ã€302 å’Œ 303 çŠ¶æ€ä¸‹çš„é‡å®šå‘æŠŠ POST æ–¹æ³•æ”¹æˆ GET æ–¹æ³•ã€‚</p>
</li>
<li><p><strong>304 Not Modified</strong> ï¼šå¦‚æœè¯·æ±‚æŠ¥æ–‡é¦–éƒ¨åŒ…å«ä¸€äº›æ¡ä»¶ï¼Œä¾‹å¦‚ï¼šIf-Matchï¼ŒIf-ModifiedSinceï¼ŒIf-None-Matchï¼ŒIf-Rangeï¼ŒIf-Unmodified-Sinceï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™æœåŠ¡å™¨ä¼šè¿”å› 304 çŠ¶æ€ç ã€‚</p>
</li>
<li><p><strong>307 Temporary Redirect</strong> ï¼šä¸´æ—¶é‡å®šå‘ï¼Œä¸ 302 çš„å«ä¹‰ç±»ä¼¼ï¼Œä½†æ˜¯ 307 è¦æ±‚æµè§ˆå™¨ä¸ä¼šæŠŠé‡å®šå‘è¯·æ±‚çš„ POST æ–¹æ³•æ”¹æˆ GET æ–¹æ³•ã€‚</p>
</li>
</ul>
<h2 id="4XX-å®¢æˆ·ç«¯é”™è¯¯"><a href="#4XX-å®¢æˆ·ç«¯é”™è¯¯" class="headerlink" title="4XX å®¢æˆ·ç«¯é”™è¯¯"></a>4XX å®¢æˆ·ç«¯é”™è¯¯</h2><ul>
<li><p><strong>400 Bad Request</strong> ï¼šè¯·æ±‚æŠ¥æ–‡ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯ã€‚</p>
</li>
<li><p><strong>401 Unauthorized</strong> ï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºå‘é€çš„è¯·æ±‚éœ€è¦æœ‰è®¤è¯ä¿¡æ¯ï¼ˆBASIC è®¤è¯ã€DIGEST è®¤è¯ï¼‰ã€‚å¦‚æœä¹‹å‰å·²è¿›è¡Œè¿‡ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·è®¤è¯å¤±è´¥ã€‚</p>
</li>
<li><p><strong>403 Forbidden</strong> ï¼šè¯·æ±‚è¢«æ‹’ç»ï¼ŒæœåŠ¡å™¨ç«¯æ²¡æœ‰å¿…è¦ç»™å‡ºæ‹’ç»çš„è¯¦ç»†ç†ç”±ã€‚</p>
</li>
<li><p><strong>404 Not Found</strong> </p>
</li>
</ul>
<h2 id="5XX-æœåŠ¡å™¨é”™è¯¯"><a href="#5XX-æœåŠ¡å™¨é”™è¯¯" class="headerlink" title="5XX æœåŠ¡å™¨é”™è¯¯"></a>5XX æœåŠ¡å™¨é”™è¯¯</h2><ul>
<li><p><strong>500 Internal Server Error</strong> ï¼šæœåŠ¡å™¨æ­£åœ¨æ‰§è¡Œè¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ã€‚</p>
</li>
<li><p><strong>503 Service Unavilable</strong> ï¼šæœåŠ¡å™¨æš‚æ—¶å¤„äºè¶…è´Ÿè½½æˆ–æ­£åœ¨è¿›è¡Œåœæœºç»´æŠ¤ï¼Œç°åœ¨æ— æ³•å¤„ç†è¯·æ±‚ã€‚</p>
</li>
</ul>
<h1 id="HTTP-æŠ¥æ–‡ç»“æ„"><a href="#HTTP-æŠ¥æ–‡ç»“æ„" class="headerlink" title="HTTP æŠ¥æ–‡ç»“æ„"></a>HTTP æŠ¥æ–‡ç»“æ„</h1><p><a href="http://idiotsky.top/images3/http-summary-1.png"><img src="http://idiotsky.top/images3/http-summary-1.png" alt=""></a></p>
<p><a href="http://idiotsky.top/images3/http-summary-2.png"><img src="http://idiotsky.top/images3/http-summary-2.png" alt=""></a></p>
<p><a href="http://idiotsky.top/images3/http-summary-3.png"><img src="http://idiotsky.top/images3/http-summary-3.png" alt=""></a></p>
<p><a href="http://idiotsky.top/images3/http-summary-4.png"><img src="http://idiotsky.top/images3/http-summary-4.png" alt=""></a></p>
<p>Response Headers:</p>
<p><a href="http://idiotsky.top/images3/http-summary-5.png"><img src="http://idiotsky.top/images3/http-summary-5.png" alt=""></a></p>
<p>Request Headers:</p>
<p><a href="http://idiotsky.top/images3/http-summary-6.png"><img src="http://idiotsky.top/images3/http-summary-6.png" alt=""></a></p>
<p>è¯·æ±‚æŠ¥æ–‡æ˜¯ç”±è¯·æ±‚æ–¹æ³•ï¼Œè¯·æ±‚ URIï¼Œåè®®ç‰ˆæœ¬ï¼Œå¯é€‰è¯·æ±‚é¦–éƒ¨å­—æ®µå’Œå†…å®¹å®ä½“æ„æˆçš„ã€‚</p>
<p>å“åº”æŠ¥æ–‡åŸºæœ¬ä¸Šç”±åè®®ç‰ˆæœ¬ï¼ŒçŠ¶æ€ç ï¼ˆè¡¨ç¤ºè¯·æ±‚æˆåŠŸä¸å¤±è´¥çš„æ•°å­—ä»£ç ï¼‰ï¼Œç”¨ä»¥è§£é‡ŠçŠ¶æ€ç çš„åŸå› çŸ­è¯­ï¼Œå¯é€‰çš„å“åº”é¦–éƒ¨å­—æ®µä»¥åŠå®ä½“ä¸»ä½“æ„æˆã€‚</p>
<h1 id="HTTP-ç¼“å­˜æ§åˆ¶"><a href="#HTTP-ç¼“å­˜æ§åˆ¶" class="headerlink" title="HTTP ç¼“å­˜æ§åˆ¶"></a>HTTP ç¼“å­˜æ§åˆ¶</h1><h2 id="ç¼“å­˜è§„åˆ™è§£æ"><a href="#ç¼“å­˜è§„åˆ™è§£æ" class="headerlink" title="ç¼“å­˜è§„åˆ™è§£æ"></a>ç¼“å­˜è§„åˆ™è§£æ</h2><p>ä¸ºæ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œæˆ‘ä»¬è®¤ä¸ºæµè§ˆå™¨å­˜åœ¨ä¸€ä¸ªç¼“å­˜æ•°æ®åº“,ç”¨äºå­˜å‚¨ç¼“å­˜ä¿¡æ¯ã€‚</p>
<p>åœ¨å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¯·æ±‚æ•°æ®æ—¶ï¼Œæ­¤æ—¶ç¼“å­˜æ•°æ®åº“ä¸­æ²¡æœ‰å¯¹åº”çš„ç¼“å­˜æ•°æ®ï¼Œéœ€è¦è¯·æ±‚æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è¿”å›åï¼Œå°†æ•°æ®å­˜å‚¨è‡³ç¼“å­˜æ•°æ®åº“ä¸­ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-21.png"><img src="http://idiotsky.top/images3/http-summary-21.png" alt=""></a></p>
<p>HTTPç¼“å­˜æœ‰å¤šç§è§„åˆ™ï¼Œæ ¹æ®æ˜¯å¦éœ€è¦é‡æ–°å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚æ¥åˆ†ç±»ï¼Œæˆ‘å°†å…¶åˆ†ä¸ºä¸¤å¤§ç±»(<strong>å¼ºåˆ¶ç¼“å­˜ï¼Œå¯¹æ¯”ç¼“å­˜</strong>)</p>
<p>åœ¨è¯¦ç»†ä»‹ç»è¿™ä¸¤ç§è§„åˆ™ä¹‹å‰ï¼Œå…ˆé€šè¿‡æ—¶åºå›¾çš„æ–¹å¼ï¼Œè®©å¤§å®¶å¯¹è¿™ä¸¤ç§è§„åˆ™æœ‰ä¸ªç®€å•äº†è§£ã€‚</p>
<p>å·²å­˜åœ¨ç¼“å­˜æ•°æ®æ—¶ï¼Œä»…åŸºäºå¼ºåˆ¶ç¼“å­˜ï¼Œè¯·æ±‚æ•°æ®çš„æµç¨‹å¦‚ä¸‹</p>
<p><a href="http://idiotsky.top/images3/http-summary-22.png"><img src="http://idiotsky.top/images3/http-summary-22.png" alt=""></a></p>
<p>å·²å­˜åœ¨ç¼“å­˜æ•°æ®æ—¶ï¼Œä»…åŸºäºå¯¹æ¯”ç¼“å­˜ï¼Œè¯·æ±‚æ•°æ®çš„æµç¨‹å¦‚ä¸‹</p>
<p><a href="http://idiotsky.top/images3/http-summary-23.png"><img src="http://idiotsky.top/images3/http-summary-23.png" alt=""></a></p>
<p>å¯¹ç¼“å­˜æœºåˆ¶ä¸å¤ªäº†è§£çš„åŒå­¦å¯èƒ½ä¼šé—®ï¼ŒåŸºäºå¯¹æ¯”ç¼“å­˜çš„æµç¨‹ä¸‹ï¼Œä¸ç®¡æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼Œéƒ½éœ€è¦å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œé‚£ä¹ˆè¿˜ç”¨ç¼“å­˜å¹²ä»€ä¹ˆï¼Ÿ</p>
<p>è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æš‚ä¸”æ”¾ä¸‹ï¼Œåæ–‡åœ¨è¯¦ç»†ä»‹ç»æ¯ç§ç¼“å­˜è§„åˆ™çš„æ—¶å€™ï¼Œä¼šå¸¦ç»™å¤§å®¶ç­”æ¡ˆã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ç±»ç¼“å­˜è§„åˆ™çš„ä¸åŒï¼Œå¼ºåˆ¶ç¼“å­˜å¦‚æœç”Ÿæ•ˆï¼Œä¸éœ€è¦å†å’ŒæœåŠ¡å™¨å‘ç”Ÿäº¤äº’ï¼Œè€Œå¯¹æ¯”ç¼“å­˜ä¸ç®¡æ˜¯å¦ç”Ÿæ•ˆï¼Œéƒ½éœ€è¦ä¸æœåŠ¡ç«¯å‘ç”Ÿäº¤äº’ã€‚</p>
<p>ä¸¤ç±»ç¼“å­˜è§„åˆ™å¯ä»¥åŒæ—¶å­˜åœ¨ï¼Œå¼ºåˆ¶ç¼“å­˜ä¼˜å…ˆçº§é«˜äºå¯¹æ¯”ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ‰§è¡Œå¼ºåˆ¶ç¼“å­˜çš„è§„åˆ™æ—¶ï¼Œå¦‚æœç¼“å­˜ç”Ÿæ•ˆï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œä¸å†æ‰§è¡Œå¯¹æ¯”ç¼“å­˜è§„åˆ™ã€‚</p>
<h2 id="å¼ºåˆ¶ç¼“å­˜"><a href="#å¼ºåˆ¶ç¼“å­˜" class="headerlink" title="å¼ºåˆ¶ç¼“å­˜"></a>å¼ºåˆ¶ç¼“å­˜</h2><p>ä»ä¸Šæ–‡æˆ‘ä»¬å¾—çŸ¥ï¼Œå¼ºåˆ¶ç¼“å­˜ï¼Œåœ¨ç¼“å­˜æ•°æ®æœªå¤±æ•ˆçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œé‚£ä¹ˆæµè§ˆå™¨æ˜¯å¦‚ä½•åˆ¤æ–­ç¼“å­˜æ•°æ®æ˜¯å¦å¤±æ•ˆå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ²¡æœ‰ç¼“å­˜æ•°æ®çš„æ—¶å€™ï¼Œæµè§ˆå™¨å‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®æ—¶ï¼ŒæœåŠ¡å™¨ä¼šå°†æ•°æ®å’Œç¼“å­˜è§„åˆ™ä¸€å¹¶è¿”å›ï¼Œç¼“å­˜è§„åˆ™ä¿¡æ¯åŒ…å«åœ¨å“åº”headerä¸­ã€‚</p>
<p>å¯¹äºå¼ºåˆ¶ç¼“å­˜æ¥è¯´ï¼Œå“åº”headerä¸­ä¼šæœ‰ä¸¤ä¸ªå­—æ®µæ¥æ ‡æ˜å¤±æ•ˆè§„åˆ™ï¼ˆExpires/Cache-Controlï¼‰</p>
<p>ä½¿ç”¨chromeçš„å¼€å‘è€…å·¥å…·ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°å¯¹äºå¼ºåˆ¶ç¼“å­˜ç”Ÿæ•ˆæ—¶ï¼Œç½‘ç»œè¯·æ±‚çš„æƒ…å†µ</p>
<p><a href="http://idiotsky.top/images3/http-summary-24.png"><img src="http://idiotsky.top/images3/http-summary-24.png" alt=""></a></p>
<h3 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a>Expires</h3><p>Expiresçš„å€¼ä¸ºæœåŠ¡ç«¯è¿”å›çš„åˆ°æœŸæ—¶é—´ï¼Œå³ä¸‹ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œè¯·æ±‚æ—¶é—´å°äºæœåŠ¡ç«¯è¿”å›çš„åˆ°æœŸæ—¶é—´ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®ã€‚</p>
<p>ä¸è¿‡Expires æ˜¯HTTP 1.0çš„ä¸œè¥¿ï¼Œç°åœ¨é»˜è®¤æµè§ˆå™¨å‡é»˜è®¤ä½¿ç”¨HTTP 1.1ï¼Œæ‰€ä»¥å®ƒçš„ä½œç”¨åŸºæœ¬å¿½ç•¥ã€‚</p>
<p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåˆ°æœŸæ—¶é—´æ˜¯ç”±æœåŠ¡ç«¯ç”Ÿæˆçš„ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ—¶é—´å¯èƒ½è·ŸæœåŠ¡ç«¯æ—¶é—´æœ‰è¯¯å·®ï¼Œè¿™å°±ä¼šå¯¼è‡´ç¼“å­˜å‘½ä¸­çš„è¯¯å·®ã€‚</p>
<p>æ‰€ä»¥HTTP 1.1 çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨Cache-Controlæ›¿ä»£ã€‚</p>
<h3 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h3><p>Cache-Control æ˜¯æœ€é‡è¦çš„è§„åˆ™ã€‚å¸¸è§çš„å–å€¼æœ‰privateã€publicã€no-cacheã€max-ageï¼Œno-storeï¼Œé»˜è®¤ä¸ºprivateã€‚</p>
<ul>
<li>private:å®¢æˆ·ç«¯å¯ä»¥ç¼“å­˜</li>
<li>public:å®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡å™¨éƒ½å¯ç¼“å­˜ï¼ˆå‰ç«¯çš„åŒå­¦ï¼Œå¯ä»¥è®¤ä¸ºpublicå’Œprivateæ˜¯ä¸€æ ·çš„ï¼‰</li>
<li>max-age=xxx:ç¼“å­˜çš„å†…å®¹å°†åœ¨ xxx ç§’åå¤±æ•ˆ</li>
<li>no-cache:éœ€è¦ä½¿ç”¨å¯¹æ¯”ç¼“å­˜æ¥éªŒè¯ç¼“å­˜æ•°æ®ï¼ˆåé¢ä»‹ç»ï¼‰</li>
<li>no-store:æ‰€æœ‰å†…å®¹éƒ½ä¸ä¼šç¼“å­˜ï¼Œå¼ºåˆ¶ç¼“å­˜ï¼Œå¯¹æ¯”ç¼“å­˜éƒ½ä¸ä¼šè§¦å‘ï¼ˆå¯¹äºå‰ç«¯å¼€å‘æ¥è¯´ï¼Œç¼“å­˜è¶Šå¤šè¶Šå¥½ï¼Œsoâ€¦åŸºæœ¬ä¸Šå’Œå®ƒè¯´886ï¼‰</li>
</ul>
<p>ä¸¾ä¸ªæ¿æ —</p>
<p><a href="http://idiotsky.top/images3/http-summary-25.png"><img src="http://idiotsky.top/images3/http-summary-25.png" alt=""></a></p>
<p>å›¾ä¸­Cache-Controlä»…æŒ‡å®šäº†max-ageï¼Œæ‰€ä»¥é»˜è®¤ä¸ºprivateï¼Œç¼“å­˜æ—¶é—´ä¸º31536000ç§’ï¼ˆ365å¤©ï¼‰</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨365å¤©å†…å†æ¬¡è¯·æ±‚è¿™æ¡æ•°æ®ï¼Œéƒ½ä¼šç›´æ¥è·å–ç¼“å­˜æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨ã€‚</p>
<h2 id="å¯¹æ¯”ç¼“å­˜"><a href="#å¯¹æ¯”ç¼“å­˜" class="headerlink" title="å¯¹æ¯”ç¼“å­˜"></a>å¯¹æ¯”ç¼“å­˜</h2><p>å¯¹æ¯”ç¼“å­˜ï¼Œé¡¾åæ€ä¹‰ï¼Œéœ€è¦è¿›è¡Œæ¯”è¾ƒåˆ¤æ–­æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜ã€‚</p>
<p>æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ•°æ®æ—¶ï¼ŒæœåŠ¡å™¨ä¼šå°†ç¼“å­˜æ ‡è¯†ä¸æ•°æ®ä¸€èµ·è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°†äºŒè€…å¤‡ä»½è‡³ç¼“å­˜æ•°æ®åº“ä¸­ã€‚</p>
<p>å†æ¬¡è¯·æ±‚æ•°æ®æ—¶ï¼Œå®¢æˆ·ç«¯å°†å¤‡ä»½çš„ç¼“å­˜æ ‡è¯†å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ ¹æ®ç¼“å­˜æ ‡è¯†è¿›è¡Œåˆ¤æ–­ï¼Œåˆ¤æ–­æˆåŠŸåï¼Œè¿”å›304çŠ¶æ€ç ï¼Œé€šçŸ¥å®¢æˆ·ç«¯æ¯”è¾ƒæˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜æ•°æ®ã€‚</p>
<p>ç¬¬ä¸€æ¬¡è®¿é—®ï¼š</p>
<p><a href="http://idiotsky.top/images3/http-summary-26.png"><img src="http://idiotsky.top/images3/http-summary-26.png" alt=""></a></p>
<p>å†æ¬¡è®¿é—®ï¼š</p>
<p><a href="http://idiotsky.top/images3/http-summary-27.png"><img src="http://idiotsky.top/images3/http-summary-27.png" alt=""></a></p>
<p>é€šè¿‡ä¸¤å›¾çš„å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šçš„å‘ç°ï¼Œåœ¨å¯¹æ¯”ç¼“å­˜ç”Ÿæ•ˆæ—¶ï¼ŒçŠ¶æ€ç ä¸º304ï¼Œå¹¶ä¸”æŠ¥æ–‡å¤§å°å’Œè¯·æ±‚æ—¶é—´å¤§å¤§å‡å°‘ã€‚</p>
<p>åŸå› æ˜¯ï¼ŒæœåŠ¡ç«¯åœ¨è¿›è¡Œæ ‡è¯†æ¯”è¾ƒåï¼Œåªè¿”å›headeréƒ¨åˆ†ï¼Œé€šè¿‡çŠ¶æ€ç é€šçŸ¥å®¢æˆ·ç«¯ä½¿ç”¨ç¼“å­˜ï¼Œä¸å†éœ€è¦å°†æŠ¥æ–‡ä¸»ä½“éƒ¨åˆ†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>å¯¹äºå¯¹æ¯”ç¼“å­˜æ¥è¯´ï¼Œç¼“å­˜æ ‡è¯†çš„ä¼ é€’æ˜¯æˆ‘ä»¬ç€é‡éœ€è¦ç†è§£çš„ï¼Œå®ƒåœ¨è¯·æ±‚headerå’Œå“åº”headeré—´è¿›è¡Œä¼ é€’ï¼Œ</p>
<p>ä¸€å…±åˆ†ä¸ºä¸¤ç§æ ‡è¯†ä¼ é€’ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†å¼€ä»‹ç»ã€‚</p>
<h3 id="Last-Modified-If-Modified-Since"><a href="#Last-Modified-If-Modified-Since" class="headerlink" title="Last-Modified  /  If-Modified-Since"></a>Last-Modified  /  If-Modified-Since</h3><p>Last-Modifiedï¼š</p>
<p>æœåŠ¡å™¨åœ¨å“åº”è¯·æ±‚æ—¶ï¼Œå‘Šè¯‰æµè§ˆå™¨èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-28.png"><img src="http://idiotsky.top/images3/http-summary-28.png" alt=""></a></p>
<p>If-Modified-Sinceï¼š</p>
<p>å†æ¬¡è¯·æ±‚æœåŠ¡å™¨æ—¶ï¼Œé€šè¿‡æ­¤å­—æ®µé€šçŸ¥æœåŠ¡å™¨ä¸Šæ¬¡è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨è¿”å›çš„èµ„æºæœ€åä¿®æ”¹æ—¶é—´ã€‚</p>
<p>æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åå‘ç°æœ‰å¤´If-Modified-Since åˆ™ä¸è¢«è¯·æ±‚èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´è¿›è¡Œæ¯”å¯¹ã€‚</p>
<p>è‹¥èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´å¤§äºIf-Modified-Sinceï¼Œè¯´æ˜èµ„æºåˆè¢«æ”¹åŠ¨è¿‡ï¼Œåˆ™å“åº”æ•´ç‰‡èµ„æºå†…å®¹ï¼Œè¿”å›çŠ¶æ€ç 200ï¼›</p>
<p>è‹¥èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´å°äºæˆ–ç­‰äºIf-Modified-Sinceï¼Œè¯´æ˜èµ„æºæ— æ–°ä¿®æ”¹ï¼Œåˆ™å“åº”HTTP 304ï¼Œå‘ŠçŸ¥æµè§ˆå™¨ç»§ç»­ä½¿ç”¨æ‰€ä¿å­˜çš„cacheã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-29.png"><img src="http://idiotsky.top/images3/http-summary-29.png" alt=""></a></p>
<h3 id="Etag-If-None-Match"><a href="#Etag-If-None-Match" class="headerlink" title="Etag  /  If-None-Match"></a>Etag  /  If-None-Match</h3><p>ï¼ˆä¼˜å…ˆçº§é«˜äºLast-Modified  /  If-Modified-Sinceï¼‰</p>
<p>Etagï¼š</p>
<p>æœåŠ¡å™¨å“åº”è¯·æ±‚æ—¶ï¼Œå‘Šè¯‰æµè§ˆå™¨å½“å‰èµ„æºåœ¨æœåŠ¡å™¨çš„å”¯ä¸€æ ‡è¯†ï¼ˆç”Ÿæˆè§„åˆ™ç”±æœåŠ¡å™¨å†³å®šï¼‰ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-30.png"><img src="http://idiotsky.top/images3/http-summary-30.png" alt=""></a></p>
<p>If-None-Matchï¼š</p>
<p>å†æ¬¡è¯·æ±‚æœåŠ¡å™¨æ—¶ï¼Œé€šè¿‡æ­¤å­—æ®µé€šçŸ¥æœåŠ¡å™¨å®¢æˆ·æ®µç¼“å­˜æ•°æ®çš„å”¯ä¸€æ ‡è¯†ã€‚</p>
<p>æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åå‘ç°æœ‰å¤´If-None-Match åˆ™ä¸è¢«è¯·æ±‚èµ„æºçš„å”¯ä¸€æ ‡è¯†è¿›è¡Œæ¯”å¯¹ï¼Œ</p>
<p>ä¸åŒï¼Œè¯´æ˜èµ„æºåˆè¢«æ”¹åŠ¨è¿‡ï¼Œåˆ™å“åº”æ•´ç‰‡èµ„æºå†…å®¹ï¼Œè¿”å›çŠ¶æ€ç 200ï¼›</p>
<p>ç›¸åŒï¼Œè¯´æ˜èµ„æºæ— æ–°ä¿®æ”¹ï¼Œåˆ™å“åº”HTTP 304ï¼Œå‘ŠçŸ¥æµè§ˆå™¨ç»§ç»­ä½¿ç”¨æ‰€ä¿å­˜çš„cacheã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-31.png"><img src="http://idiotsky.top/images3/http-summary-31.png" alt=""></a></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å¯¹äºå¼ºåˆ¶ç¼“å­˜ï¼ŒæœåŠ¡å™¨é€šçŸ¥æµè§ˆå™¨ä¸€ä¸ªç¼“å­˜æ—¶é—´ï¼Œåœ¨ç¼“å­˜æ—¶é—´å†…ï¼Œä¸‹æ¬¡è¯·æ±‚ï¼Œç›´æ¥ç”¨ç¼“å­˜ï¼Œä¸åœ¨æ—¶é—´å†…ï¼Œæ‰§è¡Œæ¯”è¾ƒç¼“å­˜ç­–ç•¥ã€‚</p>
<p>å¯¹äºæ¯”è¾ƒç¼“å­˜ï¼Œå°†ç¼“å­˜ä¿¡æ¯ä¸­çš„Etagå’ŒLast-Modifiedé€šè¿‡è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œç”±æœåŠ¡å™¨æ ¡éªŒï¼Œè¿”å›304çŠ¶æ€ç æ—¶ï¼Œæµè§ˆå™¨ç›´æ¥ä½¿ç”¨ç¼“å­˜ã€‚</p>
<p>æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼š</p>
<p><a href="http://idiotsky.top/images3/http-summary-32.png"><img src="http://idiotsky.top/images3/http-summary-32.png" alt=""></a></p>
<p>æµè§ˆå™¨å†æ¬¡è¯·æ±‚æ—¶ï¼š</p>
<p><a href="http://idiotsky.top/images3/http-summary-9.png"><img src="http://idiotsky.top/images3/http-summary-9.png" alt=""></a></p>
<p>è¿˜æœ‰ä¸€å¼ å›¾æ€»ç»“ä¸‹ï¼š</p>
<p><a href="http://idiotsky.top/images3/http-summary-33.jpg"><img src="http://idiotsky.top/images3/http-summary-33.jpg" alt=""></a></p>
<h1 id="æé«˜-HTTP-æ€§èƒ½"><a href="#æé«˜-HTTP-æ€§èƒ½" class="headerlink" title="æé«˜ HTTP æ€§èƒ½"></a>æé«˜ HTTP æ€§èƒ½</h1><h2 id="å¹¶è¡Œè¿æ¥"><a href="#å¹¶è¡Œè¿æ¥" class="headerlink" title="å¹¶è¡Œè¿æ¥"></a>å¹¶è¡Œè¿æ¥</h2><p>é€šè¿‡å¤šæ¡ TCP è¿æ¥å‘èµ·å¹¶å‘çš„ HTTP è¯·æ±‚ã€‚</p>
<h2 id="æŒä¹…è¿æ¥"><a href="#æŒä¹…è¿æ¥" class="headerlink" title="æŒä¹…è¿æ¥"></a>æŒä¹…è¿æ¥</h2><p>é‡ç”¨ TCP è¿æ¥ï¼Œä»¥æ¶ˆé™¤è¿æ¥åŠå…³é—­çš„æ—¶å»¶ã€‚ æŒä¹…è¿æ¥ï¼ˆHTTP Persistent Connectionsï¼‰ï¼Œä¹Ÿç§°ä¸º HTTP keep-alive æˆ–è€… HTTP connection reuse ã€‚</p>
<p>åœ¨ HTTP/1.1 ä¸­ï¼Œæ‰€æœ‰çš„è¿æ¥é»˜è®¤éƒ½æ˜¯æŒä¹…è¿æ¥ã€‚ä½†æ˜¯æœåŠ¡å™¨ç«¯ä¸ä¸€å®šéƒ½èƒ½å¤Ÿæ”¯æŒæŒä¹…è¿æ¥ï¼Œæ‰€ä»¥é™¤äº†æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿéœ€è¦æ”¯æŒæŒä¹…è¿æ¥ã€‚</p>
<h2 id="ç®¡é“åŒ–è¿æ¥"><a href="#ç®¡é“åŒ–è¿æ¥" class="headerlink" title="ç®¡é“åŒ–è¿æ¥"></a>ç®¡é“åŒ–è¿æ¥</h2><p>é€šè¿‡å…±äº«çš„ TCP è¿æ¥å‘èµ·å¹¶å‘çš„ HTTP è¯·æ±‚ã€‚</p>
<p>æŒä¹…è¿æ¥ä½¿å¾—å¤šæ•°è¯·æ±‚ä»¥ç®¡çº¿åŒ–ï¼ˆpipeliningï¼‰æ–¹å¼å‘é€æˆä¸ºå¯èƒ½ã€‚ä»¥å‰å‘é€è¯·æ±‚åéœ€è¦ç­‰å¾…å¹¶æ”¶åˆ°å“åº”ï¼Œæ‰èƒ½å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚ç®¡çº¿åŒ–æŠ€æœ¯å‡ºç°åï¼Œä¸ç”¨ç­‰å¾…å“åº”ï¼Œç›´æ¥å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚</p>
<p>æ¯”å¦‚å½“è¯·æ±‚ä¸€ä¸ªåŒ…å« 10 å¼ å›¾ç‰‡çš„ HTML Web é¡µé¢ï¼Œä¸æŒ¨ä¸ªè¿æ¥ç›¸æ¯”ï¼Œç”¨æŒä¹…è¿æ¥å¯ä»¥è®©è¯·æ±‚æ›´å¿«ç»“æŸã€‚è€Œç®¡çº¿åŒ–æŠ€æœ¯åˆ™æ¯”æŒä¹…è¿æ¥è¿˜è¦å¿«ã€‚è¯·æ±‚æ•°è¶Šå¤šï¼Œæ—¶é—´å·®å°±è¶Šæ˜æ˜¾ã€‚</p>
<h2 id="å¤ç”¨çš„è¿æ¥"><a href="#å¤ç”¨çš„è¿æ¥" class="headerlink" title="å¤ç”¨çš„è¿æ¥"></a>å¤ç”¨çš„è¿æ¥</h2><p>äº¤æ›¿ä¼ é€è¯·æ±‚å’Œå“åº”æŠ¥æ–‡ï¼ˆå®éªŒé˜¶æ®µï¼‰ã€‚</p>
<h1 id="GET-å’Œ-POST-çš„åŒºåˆ«"><a href="#GET-å’Œ-POST-çš„åŒºåˆ«" class="headerlink" title="GET å’Œ POST çš„åŒºåˆ«"></a>GET å’Œ POST çš„åŒºåˆ«</h1><h2 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h2><p>GET å’Œ POST çš„è¯·æ±‚éƒ½èƒ½ä½¿ç”¨é¢å¤–çš„å‚æ•°ï¼Œä½†æ˜¯ GET çš„å‚æ•°æ˜¯ä»¥æŸ¥è¯¢å­—ç¬¦ä¸²å‡ºç°åœ¨ URL ä¸­ï¼Œè€Œ POST çš„å‚æ•°å­˜å‚¨åœ¨å†…å®¹å®ä½“ä¸­(ä¾æ—§æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œåªæ˜¯å’Œ GET å­˜æ”¾çš„ä½ç½®ä¸åŒç½¢äº†)ã€‚</p>
<p>GET çš„ä¼ å‚æ–¹å¼ç›¸æ¯”äº POST å®‰å…¨æ€§è¾ƒå·®ï¼Œå› ä¸º GET ä¼ çš„å‚æ•°åœ¨ URL ä¸­æ˜¯å¯è§çš„ï¼Œå¯èƒ½ä¼šæ³„éœ²ç§å¯†ä¿¡æ¯ã€‚å¹¶ä¸” GET åªæ”¯æŒ ASCII å­—ç¬¦ï¼Œå¦‚æœå‚æ•°ä¸ºä¸­æ–‡åˆ™å¯èƒ½ä¼šå‡ºç°ä¹±ç ï¼Œè€Œ POST æ”¯æŒæ ‡å‡†å­—ç¬¦é›†ã€‚</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/test/demo_form.asp?name1=value1&amp;name2=value2</span> HTTP/1.1</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/test/demo_form.asp</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: w3schools.com</span><br><span class="line">name1=value1&amp;name2=value2</span><br></pre></td></tr></table></figure>
<h2 id="å®‰å…¨"><a href="#å®‰å…¨" class="headerlink" title="å®‰å…¨"></a>å®‰å…¨</h2><p>å®‰å…¨çš„ HTTP æ–¹æ³•ä¸ä¼šæ”¹å˜æœåŠ¡å™¨çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåªæ˜¯å¯è¯»çš„ã€‚</p>
<p>GET æ–¹æ³•æ˜¯å®‰å…¨çš„ï¼Œè€Œ POST å´ä¸æ˜¯ï¼Œå› ä¸º POST çš„ç›®çš„æ˜¯ä¼ é€å®ä½“ä¸»ä½“å†…å®¹ï¼Œè¿™ä¸ªå†…å®¹å¯èƒ½æ˜¯ç”¨æˆ·ä¸Šä¼ çš„è¡¨å•æ•°æ®ï¼Œä¸Šä¼ æˆåŠŸä¹‹åï¼ŒæœåŠ¡å™¨å¯èƒ½æŠŠè¿™ä¸ªæ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œå› æ­¤çŠ¶æ€ä¹Ÿå°±å‘ç”Ÿäº†æ”¹å˜ã€‚</p>
<p>å®‰å…¨çš„æ–¹æ³•é™¤äº† GET ä¹‹å¤–è¿˜æœ‰ï¼šHEADã€OPTIONSã€‚</p>
<p>ä¸å®‰å…¨çš„æ–¹æ³•é™¤äº† POST ä¹‹å¤–è¿˜æœ‰ PUTã€DELETEã€‚</p>
<h2 id="å¹‚ç­‰æ€§"><a href="#å¹‚ç­‰æ€§" class="headerlink" title="å¹‚ç­‰æ€§"></a>å¹‚ç­‰æ€§</h2><p>å¹‚ç­‰çš„ HTTP æ–¹æ³•ï¼ŒåŒæ ·çš„è¯·æ±‚è¢«æ‰§è¡Œä¸€æ¬¡ä¸è¿ç»­æ‰§è¡Œå¤šæ¬¡çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼ŒæœåŠ¡å™¨çš„çŠ¶æ€ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ¢å¥è¯è¯´å°±æ˜¯ï¼Œå¹‚ç­‰æ–¹æ³•ä¸åº”è¯¥å…·æœ‰å‰¯ä½œç”¨ï¼ˆç»Ÿè®¡ç”¨é€”é™¤å¤–ï¼‰ã€‚åœ¨æ­£ç¡®å®ç°çš„æ¡ä»¶ä¸‹ï¼ŒGETï¼ŒHEADï¼ŒPUT å’Œ DELETE ç­‰æ–¹æ³•éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œè€Œ POST æ–¹æ³•ä¸æ˜¯ã€‚æ‰€æœ‰çš„å®‰å…¨æ–¹æ³•ä¹Ÿéƒ½æ˜¯å¹‚ç­‰çš„ã€‚</p>
<p>GET /pageX HTTP/1.1 æ˜¯å¹‚ç­‰çš„ã€‚è¿ç»­è°ƒç”¨å¤šæ¬¡ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼š</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/pageX</span> HTTP/1.1</span><br><span class="line"><span class="keyword">GET</span> <span class="string">/pageX</span> HTTP/1.1</span><br><span class="line"><span class="keyword">GET</span> <span class="string">/pageX</span> HTTP/1.1</span><br><span class="line"><span class="keyword">GET</span> <span class="string">/pageX</span> HTTP/1.1</span><br></pre></td></tr></table></figure>
<p>POST /add_row HTTP/1.1 ä¸æ˜¯å¹‚ç­‰çš„ã€‚å¦‚æœè°ƒç”¨å¤šæ¬¡ï¼Œå°±ä¼šå¢åŠ å¤šè¡Œè®°å½•ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/add_row</span> HTTP/1.1</span><br><span class="line">POST /add_row HTTP/1.1   -&gt; Adds a 2nd row</span><br><span class="line">POST /add_row HTTP/1.1   -&gt; Adds a 3rd row</span><br></pre></td></tr></table></figure>
<p>DELETE /idX/delete HTTP/1.1 æ˜¯å¹‚ç­‰çš„ï¼Œå³ä¾¿æ˜¯ä¸åŒè¯·æ±‚ä¹‹é—´æ¥æ”¶åˆ°çš„çŠ¶æ€ç ä¸ä¸€æ ·ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DELETE /idX/delete HTTP/1.1   -&gt; Returns 200 if idX exists</span><br><span class="line">DELETE /idX/delete HTTP/1.1   -&gt; Returns 404 as it just got deleted</span><br><span class="line">DELETE /idX/delete HTTP/1.1   -&gt; Returns 404</span><br></pre></td></tr></table></figure>
<h2 id="å¯ç¼“å­˜"><a href="#å¯ç¼“å­˜" class="headerlink" title="å¯ç¼“å­˜"></a>å¯ç¼“å­˜</h2><p>å¦‚æœè¦å¯¹å“åº”è¿›è¡Œç¼“å­˜ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ol>
<li>è¯·æ±‚æŠ¥æ–‡çš„ HTTP æ–¹æ³•æœ¬èº«æ˜¯å¯ç¼“å­˜çš„ï¼ŒåŒ…æ‹¬ GET å’Œ HEADï¼Œä½†æ˜¯ PUT å’Œ DELETE ä¸å¯ç¼“å­˜ï¼ŒPOST åœ¨å¤šæ•°æƒ…å†µä¸‹ä¸å¯ç¼“å­˜çš„ã€‚</li>
<li>å“åº”æŠ¥æ–‡çš„çŠ¶æ€ç æ˜¯å¯ç¼“å­˜çš„ï¼ŒåŒ…æ‹¬ï¼š200, 203, 204, 206, 300, 301, 404, 405, 410, 414, and 501ã€‚</li>
<li>å“åº”æŠ¥æ–‡çš„ Cache-Control é¦–éƒ¨å­—æ®µæ²¡æœ‰æŒ‡å®šä¸è¿›è¡Œç¼“å­˜ã€‚</li>
</ol>
<h2 id="XMLHttpRequest"><a href="#XMLHttpRequest" class="headerlink" title="XMLHttpRequest"></a>XMLHttpRequest</h2><p>ä¸ºäº†é˜è¿° POST å’Œ GET çš„å¦ä¸€ä¸ªåŒºåˆ«ï¼Œéœ€è¦å…ˆäº†è§£ XMLHttpRequestï¼š</p>
<blockquote>
<p>XMLHttpRequest æ˜¯ä¸€ä¸ª APIï¼Œå®ƒä¸ºå®¢æˆ·ç«¯æä¾›äº†åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ è¾“æ•°æ®çš„åŠŸèƒ½ã€‚å®ƒæä¾›äº†ä¸€ä¸ªé€šè¿‡ URL æ¥è·å–æ•°æ®çš„ç®€å•æ–¹å¼ï¼Œå¹¶ä¸”ä¸ä¼šä½¿æ•´ä¸ªé¡µé¢åˆ·æ–°ã€‚è¿™ä½¿å¾—ç½‘é¡µåªæ›´æ–°ä¸€éƒ¨åˆ†é¡µé¢è€Œä¸ä¼šæ‰“æ‰°åˆ°ç”¨æˆ·ã€‚XMLHttpRequest åœ¨ AJAX ä¸­è¢«å¤§é‡ä½¿ç”¨ã€‚</p>
</blockquote>
<p>åœ¨ä½¿ç”¨ XMLHttpRequest çš„ POST æ–¹æ³•æ—¶ï¼Œæµè§ˆå™¨ä¼šå…ˆå‘é€ Header å†å‘é€ Dataã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨ä¼šè¿™ä¹ˆåšï¼Œä¾‹å¦‚ç«ç‹å°±ä¸ä¼šã€‚</p>
<h1 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP/2.0"></a>HTTP/2.0</h1><h2 id="HTTP-1-x-ç¼ºé™·"><a href="#HTTP-1-x-ç¼ºé™·" class="headerlink" title="HTTP/1.x ç¼ºé™·"></a>HTTP/1.x ç¼ºé™·</h2><p>HTTP/1.x å®ç°ç®€å•æ˜¯ä»¥ç‰ºç‰²åº”ç”¨æ€§èƒ½ä¸ºä»£ä»·çš„ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨å¤šä¸ªè¿æ¥æ‰èƒ½å®ç°å¹¶å‘å’Œç¼©çŸ­å»¶è¿Ÿï¼›</li>
<li>ä¸ä¼šå‹ç¼©è¯·æ±‚å’Œå“åº”é¦–éƒ¨ï¼Œä»è€Œå¯¼è‡´ä¸å¿…è¦çš„ç½‘ç»œæµé‡ï¼›</li>
<li>ä¸æ”¯æŒæœ‰æ•ˆçš„èµ„æºä¼˜å…ˆçº§ï¼Œè‡´ä½¿åº•å±‚ TCP è¿æ¥çš„åˆ©ç”¨ç‡ä½ä¸‹ã€‚</li>
</ul>
<h2 id="äºŒè¿›åˆ¶åˆ†å¸§å±‚"><a href="#äºŒè¿›åˆ¶åˆ†å¸§å±‚" class="headerlink" title="äºŒè¿›åˆ¶åˆ†å¸§å±‚"></a>äºŒè¿›åˆ¶åˆ†å¸§å±‚</h2><p>HTTP/2.0 å°†æŠ¥æ–‡åˆ†æˆ HEADERS å¸§å’Œ DATA å¸§ï¼Œå®ƒä»¬éƒ½æ˜¯äºŒè¿›åˆ¶æ ¼å¼çš„ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-52.png"><img src="http://idiotsky.top/images3/http-summary-52.png" alt=""></a></p>
<p>åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œåªä¼šæœ‰ä¸€ä¸ª TCP è¿æ¥å­˜åœ¨ï¼Œå®ƒæ‰¿è½½äº†ä»»æ„æ•°é‡çš„åŒå‘æ•°æ®æµï¼ˆStreamï¼‰ã€‚ä¸€ä¸ªæ•°æ®æµéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦å’Œå¯é€‰çš„ä¼˜å…ˆçº§ä¿¡æ¯ï¼Œç”¨äºæ‰¿è½½åŒå‘ä¿¡æ¯ã€‚æ¶ˆæ¯ï¼ˆMessageï¼‰æ˜¯ä¸é€»è¾‘è¯·æ±‚æˆ–å“åº”æ¶ˆæ¯å¯¹åº”çš„å®Œæ•´çš„ä¸€ç³»åˆ—å¸§ã€‚å¸§ï¼ˆFramï¼‰æ˜¯æœ€å°çš„é€šä¿¡å•ä½ï¼Œæ¥è‡ªä¸åŒæ•°æ®æµçš„å¸§å¯ä»¥äº¤é”™å‘é€ï¼Œç„¶åå†æ ¹æ®æ¯ä¸ªå¸§å¤´çš„æ•°æ®æµæ ‡è¯†ç¬¦é‡æ–°ç»„è£…ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-53.png"><img src="http://idiotsky.top/images3/http-summary-53.png" alt=""></a></p>
<h2 id="æœåŠ¡ç«¯æ¨é€"><a href="#æœåŠ¡ç«¯æ¨é€" class="headerlink" title="æœåŠ¡ç«¯æ¨é€"></a>æœåŠ¡ç«¯æ¨é€</h2><p>HTTP/2.0 åœ¨å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼Œä¼šæŠŠç›¸å…³çš„èµ„æºä¸€èµ·å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°±ä¸éœ€è¦å†æ¬¡å‘èµ·è¯·æ±‚äº†ã€‚ä¾‹å¦‚å®¢æˆ·ç«¯è¯·æ±‚ page.html é¡µé¢ï¼ŒæœåŠ¡ç«¯å°±æŠŠ script.js å’Œ style.css ç­‰ä¸ä¹‹ç›¸å…³çš„èµ„æºä¸€èµ·å‘ç»™å®¢æˆ·ç«¯ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-54.png"><img src="http://idiotsky.top/images3/http-summary-54.png" alt=""></a></p>
<h2 id="é¦–éƒ¨å‹ç¼©"><a href="#é¦–éƒ¨å‹ç¼©" class="headerlink" title="é¦–éƒ¨å‹ç¼©"></a>é¦–éƒ¨å‹ç¼©</h2><p>HTTP/1.1 çš„é¦–éƒ¨å¸¦æœ‰å¤§é‡ä¿¡æ¯ï¼Œè€Œä¸”æ¯æ¬¡éƒ½è¦é‡å¤å‘é€ã€‚HTTP/2.0 è¦æ±‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ—¶ç»´æŠ¤å’Œæ›´æ–°ä¸€ä¸ªåŒ…å«ä¹‹å‰è§è¿‡çš„é¦–éƒ¨å­—æ®µè¡¨ï¼Œä»è€Œé¿å…äº†é‡å¤ä¼ è¾“ã€‚ä¸ä»…å¦‚æ­¤ï¼ŒHTTP/2.0 ä¹Ÿä½¿ç”¨ Huffman ç¼–ç å¯¹é¦–éƒ¨å­—æ®µè¿›è¡Œå‹ç¼©ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-55.png"><img src="http://idiotsky.top/images3/http-summary-55.png" alt=""></a></p>
<h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><p>HTTP æœ‰ä»¥ä¸‹å®‰å…¨æ€§é—®é¢˜ï¼š</p>
<ul>
<li>ä½¿ç”¨æ˜æ–‡è¿›è¡Œé€šä¿¡ï¼Œå†…å®¹å¯èƒ½ä¼šè¢«çªƒå¬ï¼›</li>
<li>ä¸éªŒè¯é€šä¿¡æ–¹çš„èº«ä»½ï¼Œé€šä¿¡æ–¹çš„èº«ä»½æœ‰å¯èƒ½é­é‡ä¼ªè£…ï¼›</li>
<li>æ— æ³•è¯æ˜æŠ¥æ–‡çš„å®Œæ•´æ€§ï¼ŒæŠ¥æ–‡æœ‰å¯èƒ½é­ç¯¡æ”¹ã€‚</li>
</ul>
<p>HTTPs å¹¶ä¸æ˜¯æ–°åè®®ï¼Œè€Œæ˜¯è®© HTTP å…ˆå’Œ SSLï¼ˆSecure Sockets Layerï¼‰é€šä¿¡ï¼Œå†ç”± SSL å’Œ TCP é€šä¿¡ã€‚ä¹Ÿå°±æ˜¯è¯´ HTTPs ä½¿ç”¨äº†éš§é“è¿›è¡Œé€šä¿¡ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨ SSLï¼ŒHTTPs å…·æœ‰äº†åŠ å¯†ï¼ˆé˜²çªƒå¬ï¼‰ã€è®¤è¯ï¼ˆé˜²ä¼ªè£…ï¼‰å’Œå®Œæ•´æ€§ä¿æŠ¤ï¼ˆé˜²ç¯¡æ”¹ï¼‰ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-56.jpg"><img src="http://idiotsky.top/images3/http-summary-56.jpg" alt=""></a></p>
<h2 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h2><h3 id="1-å¯¹ç§°å¯†é’¥åŠ å¯†"><a href="#1-å¯¹ç§°å¯†é’¥åŠ å¯†" class="headerlink" title="1. å¯¹ç§°å¯†é’¥åŠ å¯†"></a>1. å¯¹ç§°å¯†é’¥åŠ å¯†</h3><p>å¯¹ç§°å¯†é’¥åŠ å¯†ï¼ˆSymmetric-Key Encryptionï¼‰ï¼ŒåŠ å¯†å’Œè§£å¯†ä½¿ç”¨åŒä¸€å¯†é’¥ã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šè¿ç®—é€Ÿåº¦å¿«ï¼›</li>
<li>ç¼ºç‚¹ï¼šæ— æ³•å®‰å…¨åœ°å°†å¯†é’¥ä¼ è¾“ç»™é€šä¿¡æ–¹ã€‚</li>
</ul>
<p><a href="http://idiotsky.top/images3/http-summary-57.png"><img src="http://idiotsky.top/images3/http-summary-57.png" alt=""></a></p>
<h3 id="2-éå¯¹ç§°å¯†é’¥åŠ å¯†"><a href="#2-éå¯¹ç§°å¯†é’¥åŠ å¯†" class="headerlink" title="2.éå¯¹ç§°å¯†é’¥åŠ å¯†"></a>2.éå¯¹ç§°å¯†é’¥åŠ å¯†</h3><p>éå¯¹ç§°å¯†é’¥åŠ å¯†ï¼Œåˆç§°å…¬å¼€å¯†é’¥åŠ å¯†ï¼ˆPublic-Key Encryptionï¼‰ï¼ŒåŠ å¯†å’Œè§£å¯†ä½¿ç”¨ä¸åŒçš„å¯†é’¥ã€‚</p>
<p>å…¬å¼€å¯†é’¥æ‰€æœ‰äººéƒ½å¯ä»¥è·å¾—ï¼Œé€šä¿¡å‘é€æ–¹è·å¾—æ¥æ”¶æ–¹çš„å…¬å¼€å¯†é’¥ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨å…¬å¼€å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œæ¥æ”¶æ–¹æ”¶åˆ°é€šä¿¡å†…å®¹åä½¿ç”¨ç§æœ‰å¯†é’¥è§£å¯†ã€‚</p>
<p>éå¯¹ç§°å¯†é’¥é™¤äº†ç”¨æ¥åŠ å¯†ï¼Œè¿˜å¯ä»¥ç”¨æ¥è¿›è¡Œç­¾åã€‚å› ä¸ºç§æœ‰å¯†é’¥æ— æ³•è¢«å…¶ä»–äººè·å–ï¼Œå› æ­¤é€šä¿¡å‘é€æ–¹ä½¿ç”¨å…¶ç§æœ‰å¯†é’¥è¿›è¡Œç­¾åï¼Œé€šä¿¡æ¥æ”¶æ–¹ä½¿ç”¨å‘é€æ–¹çš„å…¬å¼€å¯†é’¥å¯¹ç­¾åè¿›è¡Œè§£å¯†ï¼Œå°±èƒ½åˆ¤æ–­è¿™ä¸ªç­¾åæ˜¯å¦æ­£ç¡®ã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå¯ä»¥æ›´å®‰å…¨åœ°å°†å…¬å¼€å¯†é’¥ä¼ è¾“ç»™é€šä¿¡å‘é€æ–¹ï¼›</li>
<li>ç¼ºç‚¹ï¼šè¿ç®—é€Ÿåº¦æ…¢ã€‚</li>
</ul>
<p><a href="http://idiotsky.top/images3/http-summary-58.png"><img src="http://idiotsky.top/images3/http-summary-58.png" alt=""></a></p>
<h3 id="3-HTTPs-é‡‡ç”¨çš„åŠ å¯†æ–¹å¼"><a href="#3-HTTPs-é‡‡ç”¨çš„åŠ å¯†æ–¹å¼" class="headerlink" title="3. HTTPs é‡‡ç”¨çš„åŠ å¯†æ–¹å¼"></a>3. HTTPs é‡‡ç”¨çš„åŠ å¯†æ–¹å¼</h3><p>HTTPs é‡‡ç”¨æ··åˆçš„åŠ å¯†æœºåˆ¶ï¼Œä½¿ç”¨éå¯¹ç§°å¯†é’¥åŠ å¯†ç”¨äºä¼ è¾“å¯¹ç§°å¯†é’¥æ¥ä¿è¯å®‰å…¨æ€§ï¼Œä¹‹åä½¿ç”¨å¯¹ç§°å¯†é’¥åŠ å¯†è¿›è¡Œé€šä¿¡æ¥ä¿è¯æ•ˆç‡ã€‚ï¼ˆä¸‹å›¾ä¸­çš„ Session Key å°±æ˜¯å¯¹ç§°å¯†é’¥ï¼‰</p>
<p><a href="http://idiotsky.top/images3/http-summary-59.png"><img src="http://idiotsky.top/images3/http-summary-59.png" alt=""></a></p>
<h2 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h2><p>é€šè¿‡ä½¿ç”¨  <strong>è¯ä¹¦</strong>  æ¥å¯¹é€šä¿¡æ–¹è¿›è¡Œè®¤è¯ã€‚</p>
<p>æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ï¼ˆCAï¼ŒCertificate Authorityï¼‰æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åŒæ–¹éƒ½å¯ä¿¡èµ–çš„ç¬¬ä¸‰æ–¹æœºæ„ã€‚</p>
<p>æœåŠ¡å™¨çš„è¿è¥äººå‘˜å‘ CA æå‡ºå…¬å¼€å¯†é’¥çš„ç”³è¯·ï¼ŒCA åœ¨åˆ¤æ˜æå‡ºç”³è¯·è€…çš„èº«ä»½ä¹‹åï¼Œä¼šå¯¹å·²ç”³è¯·çš„å…¬å¼€å¯†é’¥åšæ•°å­—ç­¾åï¼Œç„¶ååˆ†é…è¿™ä¸ªå·²ç­¾åçš„å…¬å¼€å¯†é’¥ï¼Œå¹¶å°†è¯¥å…¬å¼€å¯†é’¥æ”¾å…¥å…¬å¼€å¯†é’¥è¯ä¹¦åç»‘å®šåœ¨ä¸€èµ·ã€‚</p>
<p>è¿›è¡Œ HTTPs é€šä¿¡æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæŠŠè¯ä¹¦å‘é€ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯å–å¾—å…¶ä¸­çš„å…¬å¼€å¯†é’¥ä¹‹åï¼Œå…ˆä½¿ç”¨æ•°å­—ç­¾åè¿›è¡ŒéªŒè¯ï¼Œå¦‚æœéªŒè¯é€šè¿‡ï¼Œå°±å¯ä»¥å¼€å§‹é€šä¿¡äº†ã€‚</p>
<p>é€šä¿¡å¼€å§‹æ—¶ï¼Œå®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨æœåŠ¡å™¨çš„å…¬å¼€å¯†é’¥å°†è‡ªå·±çš„ç§æœ‰å¯†é’¥ä¼ è¾“ç»™æœåŠ¡å™¨ï¼Œä¹‹åå†è¿›è¡Œå¯¹ç§°å¯†é’¥åŠ å¯†ã€‚</p>
<p><a href="http://idiotsky.top/images3/http-summary-60.png"><img src="http://idiotsky.top/images3/http-summary-60.png" alt=""></a></p>
<h2 id="å®Œæ•´æ€§ä¿æŠ¤"><a href="#å®Œæ•´æ€§ä¿æŠ¤" class="headerlink" title="å®Œæ•´æ€§ä¿æŠ¤"></a>å®Œæ•´æ€§ä¿æŠ¤</h2><p>SSL æä¾›æŠ¥æ–‡æ‘˜è¦åŠŸèƒ½æ¥è¿›è¡Œå®Œæ•´æ€§ä¿æŠ¤ã€‚</p>
<p>HTTP ä¹Ÿæä¾›äº† MD5 æŠ¥æ–‡æ‘˜è¦åŠŸèƒ½ï¼Œä½†ä¸æ˜¯å®‰å…¨çš„ã€‚ä¾‹å¦‚æŠ¥æ–‡å†…å®¹è¢«ç¯¡æ”¹ä¹‹åï¼ŒåŒæ—¶é‡æ–°è®¡ç®— MD5 çš„å€¼ï¼Œé€šä¿¡æ¥æ”¶æ–¹æ˜¯æ— æ³•æ„è¯†åˆ°å‘ç”Ÿäº†ç¯¡æ”¹ã€‚</p>
<p>HTTPs çš„æŠ¥æ–‡æ‘˜è¦åŠŸèƒ½ä¹‹æ‰€ä»¥å®‰å…¨ï¼Œæ˜¯å› ä¸ºå®ƒç»“åˆäº†åŠ å¯†å’Œè®¤è¯è¿™ä¸¤ä¸ªæ“ä½œã€‚è¯•æƒ³ä¸€ä¸‹ï¼ŒåŠ å¯†ä¹‹åçš„æŠ¥æ–‡ï¼Œé­åˆ°ç¯¡æ”¹ä¹‹åï¼Œä¹Ÿå¾ˆéš¾é‡æ–°è®¡ç®—æŠ¥æ–‡æ‘˜è¦ï¼Œå› ä¸ºæ— æ³•è½»æ˜“è·å–æ˜æ–‡ã€‚</p>
<h2 id="HTTPs-çš„ç¼ºç‚¹"><a href="#HTTPs-çš„ç¼ºç‚¹" class="headerlink" title="HTTPs çš„ç¼ºç‚¹"></a>HTTPs çš„ç¼ºç‚¹</h2><ul>
<li>å› ä¸ºéœ€è¦è¿›è¡ŒåŠ å¯†è§£å¯†ç­‰è¿‡ç¨‹ï¼Œå› æ­¤é€Ÿåº¦ä¼šæ›´æ…¢ï¼›</li>
<li>éœ€è¦æ”¯ä»˜è¯ä¹¦æˆæƒçš„é«˜è´¹ç”¨ã€‚</li>
</ul>
<h1 id="æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•"><a href="#æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•" class="headerlink" title="æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•"></a>æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•</h1><p>1995å¹´ï¼ŒåŒæºæ”¿ç­–ç”± Netscape å…¬å¸å¼•å…¥æµè§ˆå™¨ã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½å®è¡Œè¿™ä¸ªæ”¿ç­–ã€‚</p>
<p>æœ€åˆï¼Œå®ƒçš„å«ä¹‰æ˜¯æŒ‡ï¼ŒAç½‘é¡µè®¾ç½®çš„ Cookieï¼ŒBç½‘é¡µä¸èƒ½æ‰“å¼€ï¼Œé™¤éè¿™ä¸¤ä¸ªç½‘é¡µâ€åŒæºâ€ã€‚æ‰€è°“â€åŒæºâ€æŒ‡çš„æ˜¯â€ä¸‰ä¸ªç›¸åŒâ€ã€‚</p>
<ul>
<li>åè®®ç›¸åŒ</li>
<li>åŸŸåç›¸åŒ</li>
<li>ç«¯å£ç›¸åŒ</li>
</ul>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œ<a href="http://www.example.com/dir/page.html" target="_blank" rel="noopener">http://www.example.com/dir/page.html</a>  è¿™ä¸ªç½‘å€ï¼Œåè®®æ˜¯http://ï¼ŒåŸŸåæ˜¯<a href="http://www.example.comï¼Œç«¯å£æ˜¯80ï¼ˆé»˜è®¤ç«¯å£å¯ä»¥çœç•¥ï¼‰ã€‚å®ƒçš„åŒæºæƒ…å†µå¦‚ä¸‹ã€‚" target="_blank" rel="noopener">www.example.comï¼Œç«¯å£æ˜¯80ï¼ˆé»˜è®¤ç«¯å£å¯ä»¥çœç•¥ï¼‰ã€‚å®ƒçš„åŒæºæƒ…å†µå¦‚ä¸‹ã€‚</a></p>
<ul>
<li><a href="http://www.example.com/dir2/other.html" target="_blank" rel="noopener">http://www.example.com/dir2/other.html</a>  åŒæº</li>
<li><a href="http://example.com/dir/other.html" target="_blank" rel="noopener">http://example.com/dir/other.html</a> ä¸åŒæºï¼ˆåŸŸåä¸åŒï¼‰</li>
<li><a href="http://v2.www.example.com/dir/other.html" target="_blank" rel="noopener">http://v2.www.example.com/dir/other.html</a> ä¸åŒæºï¼ˆåŸŸåä¸åŒï¼‰</li>
<li><a href="http://www.example.com:81/dir/other.html" target="_blank" rel="noopener">http://www.example.com:81/dir/other.html</a> ä¸åŒæºï¼ˆç«¯å£ä¸åŒï¼‰</li>
</ul>
<p>åŒæºæ”¿ç­–çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†ä¿è¯ç”¨æˆ·ä¿¡æ¯çš„å®‰å…¨ï¼Œé˜²æ­¢æ¶æ„çš„ç½‘ç«™çªƒå–æ•°æ®ã€‚<br>è®¾æƒ³è¿™æ ·ä¸€ç§æƒ…å†µï¼šAç½‘ç«™æ˜¯ä¸€å®¶é“¶è¡Œï¼Œç”¨æˆ·ç™»å½•ä»¥åï¼Œåˆå»æµè§ˆå…¶ä»–ç½‘ç«™ã€‚å¦‚æœå…¶ä»–ç½‘ç«™å¯ä»¥è¯»å–Aç½‘ç«™çš„ Cookieï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ<br>å¾ˆæ˜¾ç„¶ï¼Œå¦‚æœ Cookie åŒ…å«éšç§ï¼ˆæ¯”å¦‚å­˜æ¬¾æ€»é¢ï¼‰ï¼Œè¿™äº›ä¿¡æ¯å°±ä¼šæ³„æ¼ã€‚æ›´å¯æ€•çš„æ˜¯ï¼ŒCookie å¾€å¾€ç”¨æ¥ä¿å­˜ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰é€€å‡ºç™»å½•ï¼Œå…¶ä»–ç½‘ç«™å°±å¯ä»¥å†’å……ç”¨æˆ·ï¼Œä¸ºæ‰€æ¬²ä¸ºã€‚å› ä¸ºæµè§ˆå™¨åŒæ—¶è¿˜è§„å®šï¼Œæäº¤è¡¨å•ä¸å—åŒæºæ”¿ç­–çš„é™åˆ¶ã€‚<br>ç”±æ­¤å¯è§ï¼Œâ€åŒæºæ”¿ç­–â€æ˜¯å¿…éœ€çš„ï¼Œå¦åˆ™ Cookie å¯ä»¥å…±äº«ï¼Œäº’è”ç½‘å°±æ¯«æ— å®‰å…¨å¯è¨€äº†ã€‚</p>
<p>éšç€äº’è”ç½‘çš„å‘å±•ï¼Œâ€åŒæºæ”¿ç­–â€è¶Šæ¥è¶Šä¸¥æ ¼ã€‚ç›®å‰ï¼Œå¦‚æœéåŒæºï¼Œå…±æœ‰ä¸‰ç§è¡Œä¸ºå—åˆ°é™åˆ¶ã€‚</p>
<ol>
<li>Cookieã€LocalStorage å’Œ IndexDB æ— æ³•è¯»å–ã€‚</li>
<li>DOM æ— æ³•è·å¾—ã€‚</li>
<li>AJAX è¯·æ±‚ä¸èƒ½å‘é€ã€‚</li>
</ol>
<p>è™½ç„¶è¿™äº›é™åˆ¶æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯æœ‰æ—¶å¾ˆä¸æ–¹ä¾¿ï¼Œåˆç†çš„ç”¨é€”ä¹Ÿå—åˆ°å½±å“ã€‚ä¸‹é¢ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»ï¼Œå¦‚ä½•è§„é¿ä¸Šé¢ä¸‰ç§é™åˆ¶ã€‚</p>
<h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><p>Cookie æ˜¯æœåŠ¡å™¨å†™å…¥æµè§ˆå™¨çš„ä¸€å°æ®µä¿¡æ¯ï¼Œåªæœ‰åŒæºçš„ç½‘é¡µæ‰èƒ½å…±äº«ã€‚ä½†æ˜¯ï¼Œä¸¤ä¸ªç½‘é¡µä¸€çº§åŸŸåç›¸åŒï¼Œåªæ˜¯äºŒçº§åŸŸåä¸åŒï¼Œæµè§ˆå™¨å…è®¸é€šè¿‡è®¾ç½®document.domainå…±äº« Cookieã€‚<br>ä¸¾ä¾‹æ¥è¯´ï¼ŒAç½‘é¡µæ˜¯<a href="http://w1.example.com/a.htmlï¼ŒBç½‘é¡µæ˜¯http://w2.example.com/b.htmlï¼Œé‚£ä¹ˆåªè¦è®¾ç½®ç›¸åŒçš„document.domainï¼Œä¸¤ä¸ªç½‘é¡µå°±å¯ä»¥å…±äº«Cookieã€‚" target="_blank" rel="noopener">http://w1.example.com/a.htmlï¼ŒBç½‘é¡µæ˜¯http://w2.example.com/b.htmlï¼Œé‚£ä¹ˆåªè¦è®¾ç½®ç›¸åŒçš„document.domainï¼Œä¸¤ä¸ªç½‘é¡µå°±å¯ä»¥å…±äº«Cookieã€‚</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.domain = &apos;example.com&apos;;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼ŒAç½‘é¡µé€šè¿‡è„šæœ¬è®¾ç½®ä¸€ä¸ª Cookieã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.cookie = &quot;test1=hello&quot;;</span><br></pre></td></tr></table></figure>
<p>Bç½‘é¡µå°±å¯ä»¥è¯»åˆ°è¿™ä¸ª Cookieã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var allCookie = document.cookie;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œè¿™ç§æ–¹æ³•åªé€‚ç”¨äº Cookie å’Œ iframe çª—å£ï¼ŒLocalStorage å’Œ IndexDB æ— æ³•é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œè§„é¿åŒæºæ”¿ç­–ï¼Œè€Œè¦ä½¿ç”¨ä¸‹æ–‡ä»‹ç»çš„PostMessage APIã€‚<br>å¦å¤–ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥åœ¨è®¾ç½®Cookieçš„æ—¶å€™ï¼ŒæŒ‡å®šCookieçš„æ‰€å±åŸŸåä¸ºä¸€çº§åŸŸåï¼Œæ¯”å¦‚.example.comã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: key=value; domain=.example.com; path=/</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çš„è¯ï¼ŒäºŒçº§åŸŸåå’Œä¸‰çº§åŸŸåä¸ç”¨åšä»»ä½•è®¾ç½®ï¼Œéƒ½å¯ä»¥è¯»å–è¿™ä¸ªCookieã€‚</p>
<h2 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h2><p>å¦‚æœä¸¤ä¸ªç½‘é¡µä¸åŒæºï¼Œå°±æ— æ³•æ‹¿åˆ°å¯¹æ–¹çš„DOMã€‚å…¸å‹çš„ä¾‹å­æ˜¯iframeçª—å£å’Œwindow.openæ–¹æ³•æ‰“å¼€çš„çª—å£ï¼Œå®ƒä»¬ä¸çˆ¶çª—å£æ— æ³•é€šä¿¡ã€‚<br>æ¯”å¦‚ï¼Œçˆ¶çª—å£è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¦‚æœiframeçª—å£ä¸æ˜¯åŒæºï¼Œå°±ä¼šæŠ¥é”™ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">document.getElementById(&quot;myIFrame&quot;).contentWindow.document</span><br><span class="line">// Uncaught DOMException: Blocked a frame from accessing a cross-origin frame.</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å‘½ä»¤ä¸­ï¼Œçˆ¶çª—å£æƒ³è·å–å­çª—å£çš„DOMï¼Œå› ä¸ºè·¨æºå¯¼è‡´æŠ¥é”™ã€‚</p>
<p>åä¹‹äº¦ç„¶ï¼Œå­çª—å£è·å–ä¸»çª—å£çš„DOMä¹Ÿä¼šæŠ¥é”™ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">window.parent.document.body</span><br><span class="line">// æŠ¥é”™</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸¤ä¸ªçª—å£ä¸€çº§åŸŸåç›¸åŒï¼Œåªæ˜¯äºŒçº§åŸŸåä¸åŒï¼Œé‚£ä¹ˆè®¾ç½®ä¸Šä¸€èŠ‚ä»‹ç»çš„document.domainå±æ€§ï¼Œå°±å¯ä»¥è§„é¿åŒæºæ”¿ç­–ï¼Œæ‹¿åˆ°DOMã€‚<br>å¯¹äºå®Œå…¨ä¸åŒæºçš„ç½‘ç«™ï¼Œç›®å‰æœ‰ä¸‰ç§æ–¹æ³•ï¼Œå¯ä»¥è§£å†³è·¨åŸŸçª—å£çš„é€šä¿¡é—®é¢˜ã€‚</p>
<ul>
<li>ç‰‡æ®µè¯†åˆ«ç¬¦ï¼ˆfragment identifierï¼‰</li>
<li>window.name</li>
<li>è·¨æ–‡æ¡£é€šä¿¡APIï¼ˆCross-document messagingï¼‰</li>
</ul>
<h3 id="ç‰‡æ®µè¯†åˆ«ç¬¦"><a href="#ç‰‡æ®µè¯†åˆ«ç¬¦" class="headerlink" title="ç‰‡æ®µè¯†åˆ«ç¬¦"></a>ç‰‡æ®µè¯†åˆ«ç¬¦</h3><p>ç‰‡æ®µæ ‡è¯†ç¬¦ï¼ˆfragment identifierï¼‰æŒ‡çš„æ˜¯ï¼ŒURLçš„#å·åé¢çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚ <a href="http://example.com/x.html#fragment" target="_blank" rel="noopener">http://example.com/x.html#fragment</a> çš„ <code>#fragment</code>ã€‚å¦‚æœåªæ˜¯æ”¹å˜ç‰‡æ®µæ ‡è¯†ç¬¦ï¼Œé¡µé¢ä¸ä¼šé‡æ–°åˆ·æ–°ã€‚</p>
<p>çˆ¶çª—å£å¯ä»¥æŠŠä¿¡æ¯ï¼Œå†™å…¥å­çª—å£çš„ç‰‡æ®µæ ‡è¯†ç¬¦ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var src = originURL + &apos;#&apos; + data;</span><br><span class="line">document.getElementById(&apos;myIFrame&apos;).src = src;</span><br></pre></td></tr></table></figure>
<p>å­çª—å£é€šè¿‡ç›‘å¬hashchangeäº‹ä»¶å¾—åˆ°é€šçŸ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">window.onhashchange = checkMessage;</span><br><span class="line"></span><br><span class="line">function checkMessage() &#123;</span><br><span class="line">  var message = window.location.hash;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·çš„ï¼Œå­çª—å£ä¹Ÿå¯ä»¥æ”¹å˜çˆ¶çª—å£çš„ç‰‡æ®µæ ‡è¯†ç¬¦ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parent.location.href= target + &quot;#&quot; + hash;</span><br></pre></td></tr></table></figure>
<h3 id="window-name"><a href="#window-name" class="headerlink" title="window.name"></a>window.name</h3><p>æµè§ˆå™¨çª—å£æœ‰window.nameå±æ€§ã€‚è¿™ä¸ªå±æ€§çš„æœ€å¤§ç‰¹ç‚¹æ˜¯ï¼Œæ— è®ºæ˜¯å¦åŒæºï¼Œåªè¦åœ¨åŒä¸€ä¸ªçª—å£é‡Œï¼Œå‰ä¸€ä¸ªç½‘é¡µè®¾ç½®äº†è¿™ä¸ªå±æ€§ï¼Œåä¸€ä¸ªç½‘é¡µå¯ä»¥è¯»å–å®ƒã€‚</p>
<p>çˆ¶çª—å£å…ˆæ‰“å¼€ä¸€ä¸ªå­çª—å£ï¼Œè½½å…¥ä¸€ä¸ªä¸åŒæºçš„ç½‘é¡µï¼Œè¯¥ç½‘é¡µå°†ä¿¡æ¯å†™å…¥window.nameå±æ€§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.name = data;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€ï¼Œå­çª—å£è·³å›ä¸€ä¸ªä¸ä¸»çª—å£åŒåŸŸçš„ç½‘å€ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location = &apos;http://parent.url.com/xxx.html&apos;;</span><br></pre></td></tr></table></figure>
<p>ç„¶åï¼Œä¸»çª—å£å°±å¯ä»¥è¯»å–å­çª—å£çš„window.nameäº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var data = document.getElementById(&apos;myFrame&apos;).contentWindow.name;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯ï¼Œwindow.nameå®¹é‡å¾ˆå¤§ï¼Œå¯ä»¥æ”¾ç½®éå¸¸é•¿çš„å­—ç¬¦ä¸²ï¼›ç¼ºç‚¹æ˜¯å¿…é¡»ç›‘å¬å­çª—å£window.nameå±æ€§çš„å˜åŒ–ï¼Œå½±å“ç½‘é¡µæ€§èƒ½ã€‚</p>
<h3 id="window-postMessage"><a href="#window-postMessage" class="headerlink" title="window.postMessage"></a>window.postMessage</h3><p>ä¸Šé¢ä¸¤ç§æ–¹æ³•éƒ½å±äºç ´è§£ï¼ŒHTML5ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†ä¸€ä¸ªå…¨æ–°çš„APIï¼šè·¨æ–‡æ¡£é€šä¿¡ APIï¼ˆCross-document messagingï¼‰ã€‚<br>è¿™ä¸ªAPIä¸ºwindowå¯¹è±¡æ–°å¢äº†ä¸€ä¸ªwindow.postMessageæ–¹æ³•ï¼Œå…è®¸è·¨çª—å£é€šä¿¡ï¼Œä¸è®ºè¿™ä¸¤ä¸ªçª—å£æ˜¯å¦åŒæºã€‚<br>ä¸¾ä¾‹æ¥è¯´ï¼Œçˆ¶çª—å£<code>http://aaa.com</code>å‘å­çª—å£<code>http://bbb.com</code>å‘æ¶ˆæ¯ï¼Œè°ƒç”¨postMessageæ–¹æ³•å°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var popup = window.open(&apos;http://bbb.com&apos;, &apos;title&apos;);</span><br><span class="line">popup.postMessage(&apos;Hello World!&apos;, &apos;http://bbb.com&apos;);</span><br></pre></td></tr></table></figure>
<p>postMessageæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å…·ä½“çš„ä¿¡æ¯å†…å®¹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ¥æ”¶æ¶ˆæ¯çš„çª—å£çš„æºï¼ˆoriginï¼‰ï¼Œå³â€åè®® + åŸŸå + ç«¯å£â€ã€‚ä¹Ÿå¯ä»¥è®¾ä¸º*ï¼Œè¡¨ç¤ºä¸é™åˆ¶åŸŸåï¼Œå‘æ‰€æœ‰çª—å£å‘é€ã€‚</p>
<p>å­çª—å£å‘çˆ¶çª—å£å‘é€æ¶ˆæ¯çš„å†™æ³•ç±»ä¼¼ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.opener.postMessage(&apos;Nice to see you&apos;, &apos;http://aaa.com&apos;);</span><br></pre></td></tr></table></figure>
<p>çˆ¶çª—å£å’Œå­çª—å£éƒ½å¯ä»¥é€šè¿‡messageäº‹ä»¶ï¼Œç›‘å¬å¯¹æ–¹çš„æ¶ˆæ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">window.addEventListener(&apos;message&apos;, function(e) &#123;</span><br><span class="line">  console.log(e.data);</span><br><span class="line">&#125;,false);</span><br></pre></td></tr></table></figure>
<p>messageäº‹ä»¶çš„äº‹ä»¶å¯¹è±¡eventï¼Œæä¾›ä»¥ä¸‹ä¸‰ä¸ªå±æ€§ã€‚</p>
<ul>
<li>event.sourceï¼šå‘é€æ¶ˆæ¯çš„çª—å£</li>
<li>event.origin: æ¶ˆæ¯å‘å‘çš„ç½‘å€</li>
<li>event.data: æ¶ˆæ¯å†…å®¹</li>
</ul>
<p>ä¸‹é¢çš„ä¾‹å­æ˜¯ï¼Œå­çª—å£é€šè¿‡event.sourceå±æ€§å¼•ç”¨çˆ¶çª—å£ï¼Œç„¶åå‘é€æ¶ˆæ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">window.addEventListener(&apos;message&apos;, receiveMessage);</span><br><span class="line">function receiveMessage(event) &#123;</span><br><span class="line">  event.source.postMessage(&apos;Nice to see you!&apos;, &apos;*&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>event.originå±æ€§å¯ä»¥è¿‡æ»¤ä¸æ˜¯å‘ç»™æœ¬çª—å£çš„æ¶ˆæ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">window.addEventListener(&apos;message&apos;, receiveMessage);</span><br><span class="line">function receiveMessage(event) &#123;</span><br><span class="line">  if (event.origin !== &apos;http://aaa.com&apos;) return;</span><br><span class="line">  if (event.data === &apos;Hello World&apos;) &#123;</span><br><span class="line">      event.source.postMessage(&apos;Hello&apos;, event.origin);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    console.log(event.data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="LocalStorage"><a href="#LocalStorage" class="headerlink" title="LocalStorage"></a>LocalStorage</h3><p>é€šè¿‡window.postMessageï¼Œè¯»å†™å…¶ä»–çª—å£çš„ LocalStorage ä¹Ÿæˆä¸ºäº†å¯èƒ½ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œä¸»çª—å£å†™å…¥iframeå­çª—å£çš„localStorageã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">window.onmessage = function(e) &#123;</span><br><span class="line">  if (e.origin !== &apos;http://bbb.com&apos;) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  var payload = JSON.parse(e.data);</span><br><span class="line">  localStorage.setItem(payload.key, JSON.stringify(payload.data));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œå­çª—å£å°†çˆ¶çª—å£å‘æ¥çš„æ¶ˆæ¯ï¼Œå†™å…¥è‡ªå·±çš„LocalStorageã€‚</p>
<p>çˆ¶çª—å£å‘é€æ¶ˆæ¯çš„ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var win = document.getElementsByTagName(&apos;iframe&apos;)[0].contentWindow;</span><br><span class="line">var obj = &#123; name: &apos;Jack&apos; &#125;;</span><br><span class="line">win.postMessage(JSON.stringify(&#123;key: &apos;storage&apos;, data: obj&#125;), &apos;http://bbb.com&apos;);</span><br></pre></td></tr></table></figure>
<p>åŠ å¼ºç‰ˆçš„å­çª—å£æ¥æ”¶æ¶ˆæ¯çš„ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">window.onmessage = function(e) &#123;</span><br><span class="line">  if (e.origin !== &apos;http://bbb.com&apos;) return;</span><br><span class="line">  var payload = JSON.parse(e.data);</span><br><span class="line">  switch (payload.method) &#123;</span><br><span class="line">    case &apos;set&apos;:</span><br><span class="line">      localStorage.setItem(payload.key, JSON.stringify(payload.data));</span><br><span class="line">      break;</span><br><span class="line">    case &apos;get&apos;:</span><br><span class="line">      var parent = window.parent;</span><br><span class="line">      var data = localStorage.getItem(payload.key);</span><br><span class="line">      parent.postMessage(data, &apos;http://aaa.com&apos;);</span><br><span class="line">      break;</span><br><span class="line">    case &apos;remove&apos;:</span><br><span class="line">      localStorage.removeItem(payload.key);</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åŠ å¼ºç‰ˆçš„çˆ¶çª—å£å‘é€æ¶ˆæ¯ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var win = document.getElementsByTagName(&apos;iframe&apos;)[0].contentWindow;</span><br><span class="line">var obj = &#123; name: &apos;Jack&apos; &#125;;</span><br><span class="line">// å­˜å…¥å¯¹è±¡</span><br><span class="line">win.postMessage(JSON.stringify(&#123;key: &apos;storage&apos;, method: &apos;set&apos;, data: obj&#125;), &apos;http://bbb.com&apos;);</span><br><span class="line">// è¯»å–å¯¹è±¡</span><br><span class="line">win.postMessage(JSON.stringify(&#123;key: &apos;storage&apos;, method: &quot;get&quot;&#125;), &quot;*&quot;);</span><br><span class="line">window.onmessage = function(e) &#123;</span><br><span class="line">  if (e.origin != &apos;http://aaa.com&apos;) return;</span><br><span class="line">  // &quot;Jack&quot;</span><br><span class="line">  console.log(JSON.parse(e.data).name);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="AJAX"><a href="#AJAX" class="headerlink" title="AJAX"></a>AJAX</h2><p>åŒæºæ”¿ç­–è§„å®šï¼ŒAJAXè¯·æ±‚åªèƒ½å‘ç»™åŒæºçš„ç½‘å€ï¼Œå¦åˆ™å°±æŠ¥é”™ã€‚</p>
<p>é™¤äº†æ¶è®¾æœåŠ¡å™¨ä»£ç†ï¼ˆæµè§ˆå™¨è¯·æ±‚åŒæºæœåŠ¡å™¨ï¼Œå†ç”±åè€…è¯·æ±‚å¤–éƒ¨æœåŠ¡ï¼‰ï¼Œæœ‰ä¸‰ç§æ–¹æ³•è§„é¿è¿™ä¸ªé™åˆ¶ã€‚</p>
<ul>
<li>JSONP</li>
<li>WebSocket</li>
<li>CORS</li>
</ul>
<h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p>JSONPæ˜¯æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯è·¨æºé€šä¿¡çš„å¸¸ç”¨æ–¹æ³•ã€‚æœ€å¤§ç‰¹ç‚¹å°±æ˜¯ç®€å•é€‚ç”¨ï¼Œè€å¼æµè§ˆå™¨å…¨éƒ¨æ”¯æŒï¼ŒæœåŠ¡å™¨æ”¹é€ éå¸¸å°ã€‚</p>
<p>å®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œç½‘é¡µé€šè¿‡æ·»åŠ ä¸€ä¸ª<code>&lt;script&gt;</code>å…ƒç´ ï¼Œå‘æœåŠ¡å™¨è¯·æ±‚JSONæ•°æ®ï¼Œè¿™ç§åšæ³•ä¸å—åŒæºæ”¿ç­–é™åˆ¶ï¼›æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œå°†æ•°æ®æ”¾åœ¨ä¸€ä¸ªæŒ‡å®šåå­—çš„å›è°ƒå‡½æ•°é‡Œä¼ å›æ¥ã€‚</p>
<p>é¦–å…ˆï¼Œç½‘é¡µåŠ¨æ€æ’å…¥<code>&lt;script&gt;</code>å…ƒç´ ï¼Œç”±å®ƒå‘è·¨æºç½‘å€å‘å‡ºè¯·æ±‚ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function addScriptTag(src) &#123;</span><br><span class="line">  var script = document.createElement(&apos;script&apos;);</span><br><span class="line">  script.setAttribute(&quot;type&quot;,&quot;text/javascript&quot;);</span><br><span class="line">  script.src = src;</span><br><span class="line">  document.body.appendChild(script);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">window.onload = function () &#123;</span><br><span class="line">  addScriptTag(&apos;http://example.com/ip?callback=foo&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function foo(data) &#123;</span><br><span class="line">  console.log(&apos;Your public IP address is: &apos; + data.ip);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç é€šè¿‡åŠ¨æ€æ·»åŠ <code>&lt;script&gt;</code>å…ƒç´ ï¼Œå‘æœåŠ¡å™¨example.comå‘å‡ºè¯·æ±‚ã€‚æ³¨æ„ï¼Œè¯¥è¯·æ±‚çš„æŸ¥è¯¢å­—ç¬¦ä¸²æœ‰ä¸€ä¸ªcallbackå‚æ•°ï¼Œç”¨æ¥æŒ‡å®šå›è°ƒå‡½æ•°çš„åå­—ï¼Œè¿™å¯¹äºJSONPæ˜¯å¿…éœ€çš„ã€‚</p>
<p>æœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ä»¥åï¼Œä¼šå°†æ•°æ®æ”¾åœ¨å›è°ƒå‡½æ•°çš„å‚æ•°ä½ç½®è¿”å›ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foo(&#123;</span><br><span class="line">  &quot;ip&quot;: &quot;8.8.8.8&quot;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>ç”±äº<code>&lt;script&gt;</code>å…ƒç´ è¯·æ±‚çš„è„šæœ¬ï¼Œç›´æ¥ä½œä¸ºä»£ç è¿è¡Œã€‚è¿™æ—¶ï¼Œåªè¦æµè§ˆå™¨å®šä¹‰äº†fooå‡½æ•°ï¼Œè¯¥å‡½æ•°å°±ä¼šç«‹å³è°ƒç”¨ã€‚ä½œä¸ºå‚æ•°çš„JSONæ•°æ®è¢«è§†ä¸ºJavaScriptå¯¹è±¡ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼Œå› æ­¤é¿å…äº†ä½¿ç”¨JSON.parseçš„æ­¥éª¤ã€‚</p>
<h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><p>WebSocketæ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œä½¿ç”¨ws://ï¼ˆéåŠ å¯†ï¼‰å’Œwss://ï¼ˆåŠ å¯†ï¼‰ä½œä¸ºåè®®å‰ç¼€ã€‚è¯¥åè®®ä¸å®è¡ŒåŒæºæ”¿ç­–ï¼Œåªè¦æœåŠ¡å™¨æ”¯æŒï¼Œå°±å¯ä»¥é€šè¿‡å®ƒè¿›è¡Œè·¨æºé€šä¿¡ã€‚<br>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæµè§ˆå™¨å‘å‡ºçš„WebSocketè¯·æ±‚çš„å¤´ä¿¡æ¯.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /chat HTTP/1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==</span><br><span class="line">Sec-WebSocket-Protocol: chat, superchat</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line">Origin: http://example.com</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œæœ‰ä¸€ä¸ªå­—æ®µæ˜¯Originï¼Œè¡¨ç¤ºè¯¥è¯·æ±‚çš„è¯·æ±‚æºï¼ˆoriginï¼‰ï¼Œå³å‘è‡ªå“ªä¸ªåŸŸåã€‚</p>
<p>æ­£æ˜¯å› ä¸ºæœ‰äº†Originè¿™ä¸ªå­—æ®µï¼Œæ‰€ä»¥WebSocketæ‰æ²¡æœ‰å®è¡ŒåŒæºæ”¿ç­–ã€‚å› ä¸ºæœåŠ¡å™¨å¯ä»¥æ ¹æ®è¿™ä¸ªå­—æ®µï¼Œåˆ¤æ–­æ˜¯å¦è®¸å¯æœ¬æ¬¡é€šä¿¡ã€‚å¦‚æœè¯¥åŸŸååœ¨ç™½åå•å†…ï¼ŒæœåŠ¡å™¨å°±ä¼šåšå‡ºå¦‚ä¸‹å›åº”ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=</span><br><span class="line">Sec-WebSocket-Protocol: chat</span><br></pre></td></tr></table></figure>
<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p>CORSæ˜¯ä¸€ä¸ªW3Cæ ‡å‡†ï¼Œå…¨ç§°æ˜¯â€è·¨åŸŸèµ„æºå…±äº«â€ï¼ˆCross-origin resource sharingï¼‰ã€‚</p>
<p>å®ƒå…è®¸æµè§ˆå™¨å‘è·¨æºæœåŠ¡å™¨ï¼Œå‘å‡ºXMLHttpRequestè¯·æ±‚ï¼Œä»è€Œå…‹æœäº†AJAXåªèƒ½åŒæºä½¿ç”¨çš„é™åˆ¶ã€‚</p>
<p>æœ¬æ–‡è¯¦ç»†ä»‹ç»CORSçš„å†…éƒ¨æœºåˆ¶ã€‚</p>
<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>CORSéœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼ŒIEæµè§ˆå™¨ä¸èƒ½ä½äºIE10ã€‚</p>
<p>æ•´ä¸ªCORSé€šä¿¡è¿‡ç¨‹ï¼Œéƒ½æ˜¯æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼ŒCORSé€šä¿¡ä¸åŒæºçš„AJAXé€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ã€‚æµè§ˆå™¨ä¸€æ—¦å‘ç°AJAXè¯·æ±‚è·¨æºï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›é™„åŠ çš„å¤´ä¿¡æ¯ï¼Œæœ‰æ—¶è¿˜ä¼šå¤šå‡ºä¸€æ¬¡é™„åŠ çš„è¯·æ±‚ï¼Œä½†ç”¨æˆ·ä¸ä¼šæœ‰æ„Ÿè§‰ã€‚</p>
<p>å› æ­¤ï¼Œå®ç°CORSé€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨ã€‚åªè¦æœåŠ¡å™¨å®ç°äº†CORSæ¥å£ï¼Œå°±å¯ä»¥è·¨æºé€šä¿¡ã€‚</p>
<h3 id="ä¸¤ç§è¯·æ±‚"><a href="#ä¸¤ç§è¯·æ±‚" class="headerlink" title="ä¸¤ç§è¯·æ±‚"></a>ä¸¤ç§è¯·æ±‚</h3><p>æµè§ˆå™¨å°†CORSè¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰å’Œéç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰ã€‚</p>
<p>åªè¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äºç®€å•è¯·æ±‚ã€‚</p>
<ol>
<li><p>è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š<br>HEAD<br>GET<br>POST</p>
</li>
<li><p>HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š<br>Accept<br>Accept-Language<br>Content-Language<br>Last-Event-ID<br>Content-Typeï¼šåªé™äºä¸‰ä¸ªå€¼application/x-www-form-urlencodedã€multipart/form-dataã€text/plain</p>
</li>
</ol>
<p>å‡¡æ˜¯ä¸åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±å±äºéç®€å•è¯·æ±‚ã€‚<br>æµè§ˆå™¨å¯¹è¿™ä¸¤ç§è¯·æ±‚çš„å¤„ç†ï¼Œæ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<h3 id="ç®€å•è¯·æ±‚"><a href="#ç®€å•è¯·æ±‚" class="headerlink" title="ç®€å•è¯·æ±‚"></a>ç®€å•è¯·æ±‚</h3><h4 id="åŸºæœ¬æµç¨‹"><a href="#åŸºæœ¬æµç¨‹" class="headerlink" title="åŸºæœ¬æµç¨‹"></a>åŸºæœ¬æµç¨‹</h4><p>å¯¹äºç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ç›´æ¥å‘å‡ºCORSè¯·æ±‚ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œå¢åŠ ä¸€ä¸ªOriginå­—æ®µã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæµè§ˆå™¨å‘ç°è¿™æ¬¡è·¨æºAJAXè¯·æ±‚æ˜¯ç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªOriginå­—æ®µã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /cors HTTP/1.1</span><br><span class="line">Origin: http://api.bob.com</span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/5.0...</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å¤´ä¿¡æ¯ä¸­ï¼ŒOriginå­—æ®µç”¨æ¥è¯´æ˜ï¼Œæœ¬æ¬¡è¯·æ±‚æ¥è‡ªå“ªä¸ªæºï¼ˆåè®® + åŸŸå + ç«¯å£ï¼‰ã€‚æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå€¼ï¼Œå†³å®šæ˜¯å¦åŒæ„è¿™æ¬¡è¯·æ±‚ã€‚</p>
<p>å¦‚æœOriginæŒ‡å®šçš„æºï¼Œä¸åœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„HTTPå›åº”ã€‚æµè§ˆå™¨å‘ç°ï¼Œè¿™ä¸ªå›åº”çš„å¤´ä¿¡æ¯æ²¡æœ‰åŒ…å«Access-Control-Allow-Originå­—æ®µï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œå°±çŸ¥é“å‡ºé”™äº†ï¼Œä»è€ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¢«XMLHttpRequestçš„onerrorå›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œè¿™ç§é”™è¯¯æ— æ³•é€šè¿‡çŠ¶æ€ç è¯†åˆ«ï¼Œå› ä¸ºHTTPå›åº”çš„çŠ¶æ€ç æœ‰å¯èƒ½æ˜¯200ã€‚</p>
<p>å¦‚æœOriginæŒ‡å®šçš„åŸŸååœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”ï¼Œä¼šå¤šå‡ºå‡ ä¸ªå¤´ä¿¡æ¯å­—æ®µã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http://api.bob.com</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Access-Control-Expose-Headers: FooBar</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œæœ‰ä¸‰ä¸ªä¸CORSè¯·æ±‚ç›¸å…³çš„å­—æ®µï¼Œéƒ½ä»¥<code>Access-Control-</code>å¼€å¤´ã€‚</p>
<ol>
<li>Access-Control-Allow-Origin<br>è¯¥å­—æ®µæ˜¯å¿…é¡»çš„ã€‚å®ƒçš„å€¼è¦ä¹ˆæ˜¯è¯·æ±‚æ—¶Originå­—æ®µçš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª*ï¼Œè¡¨ç¤ºæ¥å—ä»»æ„åŸŸåçš„è¯·æ±‚ã€‚</li>
<li>Access-Control-Allow-Credentials<br>è¯¥å­—æ®µå¯é€‰ã€‚å®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸å‘é€Cookieã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCookieä¸åŒ…æ‹¬åœ¨CORSè¯·æ±‚ä¹‹ä¸­ã€‚è®¾ä¸ºtrueï¼Œå³è¡¨ç¤ºæœåŠ¡å™¨æ˜ç¡®è®¸å¯ï¼ŒCookieå¯ä»¥åŒ…å«åœ¨è¯·æ±‚ä¸­ï¼Œä¸€èµ·å‘ç»™æœåŠ¡å™¨ã€‚è¿™ä¸ªå€¼ä¹Ÿåªèƒ½è®¾ä¸ºtrueï¼Œå¦‚æœæœåŠ¡å™¨ä¸è¦æµè§ˆå™¨å‘é€Cookieï¼Œåˆ é™¤è¯¥å­—æ®µå³å¯ã€‚</li>
<li>Access-Control-Expose-Headers<br>è¯¥å­—æ®µå¯é€‰ã€‚CORSè¯·æ±‚æ—¶ï¼ŒXMLHttpRequestå¯¹è±¡çš„getResponseHeader()æ–¹æ³•åªèƒ½æ‹¿åˆ°6ä¸ªåŸºæœ¬å­—æ®µï¼šCache-Controlã€Content-Languageã€Content-Typeã€Expiresã€Last-Modifiedã€Pragmaã€‚å¦‚æœæƒ³æ‹¿åˆ°å…¶ä»–å­—æ®µï¼Œå°±å¿…é¡»åœ¨Access-Control-Expose-Headersé‡Œé¢æŒ‡å®šã€‚ä¸Šé¢çš„ä¾‹å­æŒ‡å®šï¼ŒgetResponseHeader(â€˜FooBarâ€™)å¯ä»¥è¿”å›FooBarå­—æ®µçš„å€¼ã€‚</li>
</ol>
<h4 id="withCredentials-å±æ€§"><a href="#withCredentials-å±æ€§" class="headerlink" title="withCredentials å±æ€§"></a>withCredentials å±æ€§</h4><p>ä¸Šé¢è¯´åˆ°ï¼ŒCORSè¯·æ±‚é»˜è®¤ä¸å‘é€Cookieå’ŒHTTPè®¤è¯ä¿¡æ¯ã€‚å¦‚æœè¦æŠŠCookieå‘åˆ°æœåŠ¡å™¨ï¼Œä¸€æ–¹é¢è¦æœåŠ¡å™¨åŒæ„ï¼ŒæŒ‡å®šAccess-Control-Allow-Credentialså­—æ®µã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Credentials: true</span><br></pre></td></tr></table></figure>
<p>å¦ä¸€æ–¹é¢ï¼Œå¼€å‘è€…å¿…é¡»åœ¨AJAXè¯·æ±‚ä¸­æ‰“å¼€withCredentialså±æ€§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var xhr = new XMLHttpRequest();</span><br><span class="line">xhr.withCredentials = true;</span><br></pre></td></tr></table></figure>
<p>å¦åˆ™ï¼Œå³ä½¿æœåŠ¡å™¨åŒæ„å‘é€Cookieï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå‘é€ã€‚æˆ–è€…ï¼ŒæœåŠ¡å™¨è¦æ±‚è®¾ç½®Cookieï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå¤„ç†ã€‚<br>ä½†æ˜¯ï¼Œå¦‚æœçœç•¥withCredentialsè®¾ç½®ï¼Œæœ‰çš„æµè§ˆå™¨è¿˜æ˜¯ä¼šä¸€èµ·å‘é€Cookieã€‚è¿™æ—¶ï¼Œå¯ä»¥æ˜¾å¼å…³é—­withCredentialsã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.withCredentials = false;</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¦å‘é€Cookieï¼ŒAccess-Control-Allow-Originå°±ä¸èƒ½è®¾ä¸ºæ˜Ÿå·ï¼Œå¿…é¡»æŒ‡å®šæ˜ç¡®çš„ã€ä¸è¯·æ±‚ç½‘é¡µä¸€è‡´çš„åŸŸåã€‚åŒæ—¶ï¼ŒCookieä¾ç„¶éµå¾ªåŒæºæ”¿ç­–ï¼Œåªæœ‰ç”¨æœåŠ¡å™¨åŸŸåè®¾ç½®çš„Cookieæ‰ä¼šä¸Šä¼ ï¼Œå…¶ä»–åŸŸåçš„Cookieå¹¶ä¸ä¼šä¸Šä¼ ï¼Œä¸”ï¼ˆè·¨æºï¼‰åŸç½‘é¡µä»£ç ä¸­çš„document.cookieä¹Ÿæ— æ³•è¯»å–æœåŠ¡å™¨åŸŸåä¸‹çš„Cookieã€‚</p>
<h3 id="éç®€å•è¯·æ±‚"><a href="#éç®€å•è¯·æ±‚" class="headerlink" title="éç®€å•è¯·æ±‚"></a>éç®€å•è¯·æ±‚</h3><h4 id="é¢„æ£€è¯·æ±‚"><a href="#é¢„æ£€è¯·æ±‚" class="headerlink" title="é¢„æ£€è¯·æ±‚"></a>é¢„æ£€è¯·æ±‚</h4><p>éç®€å•è¯·æ±‚æ˜¯é‚£ç§å¯¹æœåŠ¡å™¨æœ‰ç‰¹æ®Šè¦æ±‚çš„è¯·æ±‚ï¼Œæ¯”å¦‚è¯·æ±‚æ–¹æ³•æ˜¯PUTæˆ–DELETEï¼Œæˆ–è€…Content-Typeå­—æ®µçš„ç±»å‹æ˜¯application/jsonã€‚</p>
<p>éç®€å•è¯·æ±‚çš„CORSè¯·æ±‚ï¼Œä¼šåœ¨æ­£å¼é€šä¿¡ä¹‹å‰ï¼Œå¢åŠ ä¸€æ¬¡HTTPæŸ¥è¯¢è¯·æ±‚ï¼Œç§°ä¸ºâ€é¢„æ£€â€è¯·æ±‚ï¼ˆpreflightï¼‰ã€‚</p>
<p>æµè§ˆå™¨å…ˆè¯¢é—®æœåŠ¡å™¨ï¼Œå½“å‰ç½‘é¡µæ‰€åœ¨çš„åŸŸåæ˜¯å¦åœ¨æœåŠ¡å™¨çš„è®¸å¯åå•ä¹‹ä¸­ï¼Œä»¥åŠå¯ä»¥ä½¿ç”¨å“ªäº›HTTPåŠ¨è¯å’Œå¤´ä¿¡æ¯å­—æ®µã€‚åªæœ‰å¾—åˆ°è‚¯å®šç­”å¤ï¼Œæµè§ˆå™¨æ‰ä¼šå‘å‡ºæ­£å¼çš„XMLHttpRequestè¯·æ±‚ï¼Œå¦åˆ™å°±æŠ¥é”™ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€æ®µæµè§ˆå™¨çš„JavaScriptè„šæœ¬ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var url = &apos;http://api.alice.com/cors&apos;;</span><br><span class="line">var xhr = new XMLHttpRequest();</span><br><span class="line">xhr.open(&apos;PUT&apos;, url, true);</span><br><span class="line">xhr.setRequestHeader(&apos;X-Custom-Header&apos;, &apos;value&apos;);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç ä¸­ï¼ŒHTTPè¯·æ±‚çš„æ–¹æ³•æ˜¯PUTï¼Œå¹¶ä¸”å‘é€ä¸€ä¸ªè‡ªå®šä¹‰å¤´ä¿¡æ¯X-Custom-Headerã€‚</p>
<p>æµè§ˆå™¨å‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªéç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨å‘å‡ºä¸€ä¸ªâ€é¢„æ£€â€è¯·æ±‚ï¼Œè¦æ±‚æœåŠ¡å™¨ç¡®è®¤å¯ä»¥è¿™æ ·è¯·æ±‚ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªâ€é¢„æ£€â€è¯·æ±‚çš„HTTPå¤´ä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS /cors HTTP/1.1</span><br><span class="line">Origin: http://api.bob.com</span><br><span class="line">Access-Control-Request-Method: PUT</span><br><span class="line">Access-Control-Request-Headers: X-Custom-Header</span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/5.0...</span><br></pre></td></tr></table></figure>
<p>â€œé¢„æ£€â€è¯·æ±‚ç”¨çš„è¯·æ±‚æ–¹æ³•æ˜¯OPTIONSï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ç”¨æ¥è¯¢é—®çš„ã€‚å¤´ä¿¡æ¯é‡Œé¢ï¼Œå…³é”®å­—æ®µæ˜¯Originï¼Œè¡¨ç¤ºè¯·æ±‚æ¥è‡ªå“ªä¸ªæºã€‚</p>
<p>é™¤äº†Originå­—æ®µï¼Œâ€é¢„æ£€â€è¯·æ±‚çš„å¤´ä¿¡æ¯åŒ…æ‹¬ä¸¤ä¸ªç‰¹æ®Šå­—æ®µã€‚</p>
<ol>
<li>Access-Control-Request-Method<br>è¯¥å­—æ®µæ˜¯å¿…é¡»çš„ï¼Œç”¨æ¥åˆ—å‡ºæµè§ˆå™¨çš„CORSè¯·æ±‚ä¼šç”¨åˆ°å“ªäº›HTTPæ–¹æ³•ï¼Œä¸Šä¾‹æ˜¯PUTã€‚</li>
<li>Access-Control-Request-Headers<br>è¯¥å­—æ®µæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šæµè§ˆå™¨CORSè¯·æ±‚ä¼šé¢å¤–å‘é€çš„å¤´ä¿¡æ¯å­—æ®µï¼Œä¸Šä¾‹æ˜¯X-Custom-Headerã€‚</li>
</ol>
<h4 id="é¢„æ£€è¯·æ±‚çš„å›åº”"><a href="#é¢„æ£€è¯·æ±‚çš„å›åº”" class="headerlink" title="é¢„æ£€è¯·æ±‚çš„å›åº”"></a>é¢„æ£€è¯·æ±‚çš„å›åº”</h4><p>æœåŠ¡å™¨æ”¶åˆ°â€é¢„æ£€â€è¯·æ±‚ä»¥åï¼Œæ£€æŸ¥äº†Originã€Access-Control-Request-Methodå’ŒAccess-Control-Request-Headerså­—æ®µä»¥åï¼Œç¡®è®¤å…è®¸è·¨æºè¯·æ±‚ï¼Œå°±å¯ä»¥åšå‡ºå›åº”ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 01 Dec 2008 01:15:39 GMT</span><br><span class="line">Server: Apache/2.0.61 (Unix)</span><br><span class="line">Access-Control-Allow-Origin: http://api.bob.com</span><br><span class="line">Access-Control-Allow-Methods: GET, POST, PUT</span><br><span class="line">Access-Control-Allow-Headers: X-Custom-Header</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Length: 0</span><br><span class="line">Keep-Alive: timeout=2, max=100</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: text/plain</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„HTTPå›åº”ä¸­ï¼Œå…³é”®çš„æ˜¯Access-Control-Allow-Originå­—æ®µï¼Œè¡¨ç¤º<a href="http://api.bob.comå¯ä»¥è¯·æ±‚æ•°æ®ã€‚è¯¥å­—æ®µä¹Ÿå¯ä»¥è®¾ä¸ºæ˜Ÿå·ï¼Œè¡¨ç¤ºåŒæ„ä»»æ„è·¨æºè¯·æ±‚ã€‚" target="_blank" rel="noopener">http://api.bob.comå¯ä»¥è¯·æ±‚æ•°æ®ã€‚è¯¥å­—æ®µä¹Ÿå¯ä»¥è®¾ä¸ºæ˜Ÿå·ï¼Œè¡¨ç¤ºåŒæ„ä»»æ„è·¨æºè¯·æ±‚ã€‚</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: *</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæµè§ˆå™¨å¦å®šäº†â€é¢„æ£€â€è¯·æ±‚ï¼Œä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„HTTPå›åº”ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•CORSç›¸å…³çš„å¤´ä¿¡æ¯å­—æ®µã€‚è¿™æ—¶ï¼Œæµè§ˆå™¨å°±ä¼šè®¤å®šï¼ŒæœåŠ¡å™¨ä¸åŒæ„é¢„æ£€è¯·æ±‚ï¼Œå› æ­¤è§¦å‘ä¸€ä¸ªé”™è¯¯ï¼Œè¢«XMLHttpRequestå¯¹è±¡çš„onerrorå›è°ƒå‡½æ•°æ•è·ã€‚æ§åˆ¶å°ä¼šæ‰“å°å‡ºå¦‚ä¸‹çš„æŠ¥é”™ä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">XMLHttpRequest cannot load http://api.alice.com.</span><br><span class="line">Origin http://api.bob.com is not allowed by Access-Control-Allow-Origin.</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨å›åº”çš„å…¶ä»–CORSç›¸å…³å­—æ®µå¦‚ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Methods: GET, POST, PUT</span><br><span class="line">Access-Control-Allow-Headers: X-Custom-Header</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Access-Control-Max-Age: 1728000</span><br></pre></td></tr></table></figure>
<ol>
<li>Access-Control-Allow-Methods<br>è¯¥å­—æ®µå¿…éœ€ï¼Œå®ƒçš„å€¼æ˜¯é€—å·åˆ†éš”çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰è·¨åŸŸè¯·æ±‚çš„æ–¹æ³•ã€‚æ³¨æ„ï¼Œè¿”å›çš„æ˜¯æ‰€æœ‰æ”¯æŒçš„æ–¹æ³•ï¼Œè€Œä¸å•æ˜¯æµè§ˆå™¨è¯·æ±‚çš„é‚£ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ä¸ºäº†é¿å…å¤šæ¬¡â€é¢„æ£€â€è¯·æ±‚ã€‚</li>
<li>Access-Control-Allow-Headers<br>å¦‚æœæµè§ˆå™¨è¯·æ±‚åŒ…æ‹¬Access-Control-Request-Headerså­—æ®µï¼Œåˆ™Access-Control-Allow-Headerså­—æ®µæ˜¯å¿…éœ€çš„ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µï¼Œä¸é™äºæµè§ˆå™¨åœ¨â€é¢„æ£€â€ä¸­è¯·æ±‚çš„å­—æ®µã€‚</li>
<li>Access-Control-Allow-Credentials<br>è¯¥å­—æ®µä¸ç®€å•è¯·æ±‚æ—¶çš„å«ä¹‰ç›¸åŒã€‚</li>
<li>Access-Control-Max-Age<br>è¯¥å­—æ®µå¯é€‰ï¼Œç”¨æ¥æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ã€‚ä¸Šé¢ç»“æœä¸­ï¼Œæœ‰æ•ˆæœŸæ˜¯20å¤©ï¼ˆ1728000ç§’ï¼‰ï¼Œå³å…è®¸ç¼“å­˜è¯¥æ¡å›åº”1728000ç§’ï¼ˆå³20å¤©ï¼‰ï¼Œåœ¨æ­¤æœŸé—´ï¼Œä¸ç”¨å‘å‡ºå¦ä¸€æ¡é¢„æ£€è¯·æ±‚ã€‚</li>
</ol>
<h4 id="æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº”"><a href="#æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº”" class="headerlink" title="æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº”"></a>æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº”</h4><p>ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡äº†â€é¢„æ£€â€è¯·æ±‚ï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨æ­£å¸¸çš„CORSè¯·æ±‚ï¼Œå°±éƒ½è·Ÿç®€å•è¯·æ±‚ä¸€æ ·ï¼Œä¼šæœ‰ä¸€ä¸ªOriginå¤´ä¿¡æ¯å­—æ®µã€‚æœåŠ¡å™¨çš„å›åº”ï¼Œä¹Ÿéƒ½ä¼šæœ‰ä¸€ä¸ªAccess-Control-Allow-Originå¤´ä¿¡æ¯å­—æ®µã€‚</p>
<p>ä¸‹é¢æ˜¯â€é¢„æ£€â€è¯·æ±‚ä¹‹åï¼Œæµè§ˆå™¨çš„æ­£å¸¸CORSè¯·æ±‚ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /cors HTTP/1.1</span><br><span class="line">Origin: http://api.bob.com</span><br><span class="line">Host: api.alice.com</span><br><span class="line">X-Custom-Header: value</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/5.0...</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å¤´ä¿¡æ¯çš„Originå­—æ®µæ˜¯æµè§ˆå™¨è‡ªåŠ¨æ·»åŠ çš„ã€‚</p>
<p>ä¸‹é¢æ˜¯æœåŠ¡å™¨æ­£å¸¸çš„å›åº”ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http://api.bob.com</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å¤´ä¿¡æ¯ä¸­ï¼ŒAccess-Control-Allow-Originå­—æ®µæ˜¯æ¯æ¬¡å›åº”éƒ½å¿…å®šåŒ…å«çš„ã€‚</p>
<h3 id="ä¸JSONPçš„æ¯”è¾ƒ"><a href="#ä¸JSONPçš„æ¯”è¾ƒ" class="headerlink" title="ä¸JSONPçš„æ¯”è¾ƒ"></a>ä¸JSONPçš„æ¯”è¾ƒ</h3><p>CORSä¸JSONPçš„ä½¿ç”¨ç›®çš„ç›¸åŒï¼Œä½†æ˜¯æ¯”JSONPæ›´å¼ºå¤§ã€‚</p>
<p>JSONPåªæ”¯æŒGETè¯·æ±‚ï¼ŒCORSæ”¯æŒæ‰€æœ‰ç±»å‹çš„HTTPè¯·æ±‚ã€‚JSONPçš„ä¼˜åŠ¿åœ¨äºæ”¯æŒè€å¼æµè§ˆå™¨ï¼Œä»¥åŠå¯ä»¥å‘ä¸æ”¯æŒCORSçš„ç½‘ç«™è¯·æ±‚æ•°æ®ã€‚</p>
<h1 id="ç†è§£HTTPå¹‚ç­‰æ€§"><a href="#ç†è§£HTTPå¹‚ç­‰æ€§" class="headerlink" title="ç†è§£HTTPå¹‚ç­‰æ€§"></a>ç†è§£HTTPå¹‚ç­‰æ€§</h1><p>åŸºäºHTTPåè®®çš„Web APIæ˜¯æ—¶ä¸‹æœ€ä¸ºæµè¡Œçš„ä¸€ç§åˆ†å¸ƒå¼æœåŠ¡æä¾›æ–¹å¼ã€‚æ— è®ºæ˜¯åœ¨å¤§å‹äº’è”ç½‘åº”ç”¨è¿˜æ˜¯ä¼ä¸šçº§æ¶æ„ä¸­ï¼Œæˆ‘ä»¬éƒ½è§åˆ°äº†è¶Šæ¥è¶Šå¤šçš„SOAæˆ–RESTfulçš„Web APIã€‚ä¸ºä»€ä¹ˆWeb APIå¦‚æ­¤æµè¡Œå‘¢ï¼Ÿæˆ‘è®¤ä¸ºå¾ˆå¤§ç¨‹åº¦ä¸Šåº”å½’åŠŸäºç®€å•æœ‰æ•ˆçš„HTTPåè®®ã€‚HTTPåè®®æ˜¯ä¸€ç§åˆ†å¸ƒå¼çš„é¢å‘èµ„æºçš„ç½‘ç»œåº”ç”¨å±‚åè®®ï¼Œæ— è®ºæ˜¯æœåŠ¡å™¨ç«¯æä¾›WebæœåŠ¡ï¼Œè¿˜æ˜¯å®¢æˆ·ç«¯æ¶ˆè´¹WebæœåŠ¡éƒ½éå¸¸ç®€å•ã€‚å†åŠ ä¸Šæµè§ˆå™¨ã€Javascriptã€AJAXã€JSONä»¥åŠHTML5ç­‰æŠ€æœ¯å’Œå·¥å…·çš„å‘å±•ï¼Œäº’è”ç½‘åº”ç”¨æ¶æ„è®¾è®¡è¡¨ç°å‡ºäº†ä»ä¼ ç»Ÿçš„PHPã€JSPã€ASP.NETç­‰æœåŠ¡å™¨ç«¯åŠ¨æ€ç½‘é¡µå‘Web API + RIAï¼ˆå¯Œäº’è”ç½‘åº”ç”¨ï¼‰è¿‡æ¸¡çš„è¶‹åŠ¿ã€‚Web APIä¸“æ³¨äºæä¾›ä¸šåŠ¡æœåŠ¡ï¼ŒRIAä¸“æ³¨äºç”¨æˆ·ç•Œé¢å’Œäº¤äº’è®¾è®¡ï¼Œä»æ­¤ä¸¤ä¸ªé¢†åŸŸçš„åˆ†å·¥æ›´åŠ æ˜æ™°ã€‚åœ¨è¿™ç§è¶‹åŠ¿ä¸‹ï¼ŒWeb APIè®¾è®¡å°†æˆä¸ºæœåŠ¡å™¨ç«¯ç¨‹åºå‘˜çš„å¿…ä¿®è¯¾ã€‚ç„¶è€Œï¼Œæ­£å¦‚ç®€å•çš„Javaè¯­è¨€å¹¶ä¸æ„å‘³ç€é«˜è´¨é‡çš„Javaç¨‹åºï¼Œç®€å•çš„HTTPåè®®ä¹Ÿä¸æ„å‘³ç€é«˜è´¨é‡çš„Web APIã€‚è¦æƒ³è®¾è®¡å‡ºé«˜è´¨é‡çš„Web APIï¼Œè¿˜éœ€è¦æ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»ŸåŠHTTPåè®®çš„ç‰¹æ€§ã€‚</p>
<h2 id="å¹‚ç­‰æ€§å®šä¹‰"><a href="#å¹‚ç­‰æ€§å®šä¹‰" class="headerlink" title="å¹‚ç­‰æ€§å®šä¹‰"></a>å¹‚ç­‰æ€§å®šä¹‰</h2><p>æœ¬æ–‡æ‰€è¦æ¢è®¨çš„æ­£æ˜¯HTTPåè®®æ¶‰åŠåˆ°çš„ä¸€ç§é‡è¦æ€§è´¨ï¼šå¹‚ç­‰æ€§(Idempotence)ã€‚åœ¨HTTP/1.1è§„èŒƒä¸­å¹‚ç­‰æ€§çš„å®šä¹‰æ˜¯ï¼š</p>
<blockquote>
<p>Methods can also have the property of â€œidempotenceâ€ in that (aside from error or expiration issues) the side-effects of N &gt; 0 identical requests is the same as for a single request.</p>
</blockquote>
<p>ä»å®šä¹‰ä¸Šçœ‹ï¼ŒHTTPæ–¹æ³•çš„å¹‚ç­‰æ€§æ˜¯æŒ‡ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºåº”è¯¥å…·æœ‰åŒæ ·çš„å‰¯ä½œç”¨ã€‚å¹‚ç­‰æ€§å±äºè¯­ä¹‰èŒƒç•´ï¼Œæ­£å¦‚ç¼–è¯‘å™¨åªèƒ½å¸®åŠ©æ£€æŸ¥è¯­æ³•é”™è¯¯ä¸€æ ·ï¼ŒHTTPè§„èŒƒä¹Ÿæ²¡æœ‰åŠæ³•é€šè¿‡æ¶ˆæ¯æ ¼å¼ç­‰è¯­æ³•æ‰‹æ®µæ¥å®šä¹‰å®ƒï¼Œè¿™å¯èƒ½æ˜¯å®ƒä¸å¤ªå—åˆ°é‡è§†çš„åŸå› ä¹‹ä¸€ã€‚ä½†å®é™…ä¸Šï¼Œå¹‚ç­‰æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­ååˆ†é‡è¦çš„æ¦‚å¿µï¼Œè€ŒHTTPçš„åˆ†å¸ƒå¼æœ¬è´¨ä¹Ÿå†³å®šäº†å®ƒåœ¨HTTPä¸­å…·æœ‰é‡è¦åœ°ä½ã€‚</p>
<h2 id="åˆ†å¸ƒå¼äº‹åŠ¡-vs-å¹‚ç­‰è®¾è®¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡-vs-å¹‚ç­‰è®¾è®¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡ vs å¹‚ç­‰è®¾è®¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡ vs å¹‚ç­‰è®¾è®¡</h2><p>ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§å‘¢ï¼Ÿæˆ‘ä»¬å…ˆä»ä¸€ä¸ªä¾‹å­è¯´èµ·ï¼Œå‡è®¾æœ‰ä¸€ä¸ªä»è´¦æˆ·å–é’±çš„è¿œç¨‹APIï¼ˆå¯ä»¥æ˜¯HTTPçš„ï¼Œä¹Ÿå¯ä»¥ä¸æ˜¯ï¼‰ï¼Œæˆ‘ä»¬æš‚æ—¶ç”¨ç±»å‡½æ•°çš„æ–¹å¼è®°ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool withdraw(account_id, amount)</span><br></pre></td></tr></table></figure>
<p>withdrawçš„è¯­ä¹‰æ˜¯ä»account_idå¯¹åº”çš„è´¦æˆ·ä¸­æ‰£é™¤amountæ•°é¢çš„é’±ï¼›å¦‚æœæ‰£é™¤æˆåŠŸåˆ™è¿”å›trueï¼Œè´¦æˆ·ä½™é¢å‡å°‘amountï¼›å¦‚æœæ‰£é™¤å¤±è´¥åˆ™è¿”å›falseï¼Œè´¦æˆ·ä½™é¢ä¸å˜ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå’Œæœ¬åœ°ç¯å¢ƒç›¸æ¯”ï¼Œæˆ‘ä»¬ä¸èƒ½è½»æ˜“å‡è®¾åˆ†å¸ƒå¼ç¯å¢ƒçš„å¯é æ€§ã€‚ä¸€ç§å…¸å‹çš„æƒ…å†µæ˜¯withdrawè¯·æ±‚å·²ç»è¢«æœåŠ¡å™¨ç«¯æ­£ç¡®å¤„ç†ï¼Œä½†æœåŠ¡å™¨ç«¯çš„è¿”å›ç»“æœç”±äºç½‘ç»œç­‰åŸå› è¢«æ‰ä¸¢äº†ï¼Œå¯¼è‡´å®¢æˆ·ç«¯æ— æ³•å¾—çŸ¥å¤„ç†ç»“æœã€‚å¦‚æœæ˜¯åœ¨ç½‘é¡µä¸Šï¼Œä¸€äº›ä¸æ°å½“çš„è®¾è®¡å¯èƒ½ä¼šä½¿ç”¨æˆ·è®¤ä¸ºä¸Šä¸€æ¬¡æ“ä½œå¤±è´¥äº†ï¼Œç„¶ååˆ·æ–°é¡µé¢ï¼Œè¿™å°±å¯¼è‡´äº†withdrawè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œè´¦æˆ·ä¹Ÿè¢«å¤šæ‰£äº†ä¸€æ¬¡é’±ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="http://idiotsky.top/images3/http-summary-50.png"><img src="http://idiotsky.top/images3/http-summary-50.png" alt=""></a></p>
<p>è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆä¸€æ˜¯é‡‡ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œé€šè¿‡å¼•å…¥æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸­é—´ä»¶æ¥ä¿è¯withdrawåŠŸèƒ½çš„äº‹åŠ¡æ€§ã€‚åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¼˜ç‚¹æ˜¯å¯¹äºè°ƒç”¨è€…å¾ˆç®€å•ï¼Œå¤æ‚æ€§éƒ½äº¤ç»™äº†ä¸­é—´ä»¶æ¥ç®¡ç†ã€‚ç¼ºç‚¹åˆ™æ˜¯ä¸€æ–¹é¢æ¶æ„å¤ªé‡é‡çº§ï¼Œå®¹æ˜“è¢«ç»‘åœ¨ç‰¹å®šçš„ä¸­é—´ä»¶ä¸Šï¼Œä¸åˆ©äºå¼‚æ„ç³»ç»Ÿçš„é›†æˆï¼›å¦ä¸€æ–¹é¢åˆ†å¸ƒå¼äº‹åŠ¡è™½ç„¶èƒ½ä¿è¯äº‹åŠ¡çš„ACIDæ€§è´¨ï¼Œè€Œä½†å´æ— æ³•æä¾›æ€§èƒ½å’Œå¯ç”¨æ€§çš„ä¿è¯ã€‚</p>
<p>å¦ä¸€ç§æ›´è½»é‡çº§çš„è§£å†³æ–¹æ¡ˆæ˜¯å¹‚ç­‰è®¾è®¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›æŠ€å·§æŠŠwithdrawå˜æˆå¹‚ç­‰çš„ï¼Œæ¯”å¦‚ï¼š</p>
<p>int create_ticket()<br>bool idempotent_withdraw(ticket_id, account_id, amount)<br>create_ticketçš„è¯­ä¹‰æ˜¯è·å–ä¸€ä¸ªæœåŠ¡å™¨ç«¯ç”Ÿæˆçš„å”¯ä¸€çš„å¤„ç†å·ticket_idï¼Œå®ƒå°†ç”¨äºæ ‡è¯†åç»­çš„æ“ä½œã€‚idempotent_withdrawå’Œwithdrawçš„åŒºåˆ«åœ¨äºå…³è”äº†ä¸€ä¸ªticket_idï¼Œä¸€ä¸ªticket_idè¡¨ç¤ºçš„æ“ä½œè‡³å¤šåªä¼šè¢«å¤„ç†ä¸€æ¬¡ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½å°†è¿”å›ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶çš„å¤„ç†ç»“æœã€‚è¿™æ ·ï¼Œidempotent_withdrawå°±ç¬¦åˆå¹‚ç­‰æ€§äº†ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥æ”¾å¿ƒåœ°å¤šæ¬¡è°ƒç”¨ã€‚</p>
<p>åŸºäºå¹‚ç­‰æ€§çš„è§£å†³æ–¹æ¡ˆä¸­ä¸€ä¸ªå®Œæ•´çš„å–é’±æµç¨‹è¢«åˆ†è§£æˆäº†ä¸¤ä¸ªæ­¥éª¤ï¼š1.è°ƒç”¨create_ticket()è·å–ticket_idï¼›2.è°ƒç”¨idempotent_withdraw(ticket_id, account_id, amount)ã€‚è™½ç„¶create_ticketä¸æ˜¯å¹‚ç­‰çš„ï¼Œä½†åœ¨è¿™ç§è®¾è®¡ä¸‹ï¼Œå®ƒå¯¹ç³»ç»ŸçŠ¶æ€çš„å½±å“å¯ä»¥å¿½ç•¥ï¼ŒåŠ ä¸Šidempotent_withdrawæ˜¯å¹‚ç­‰çš„ï¼Œæ‰€ä»¥ä»»ä½•ä¸€æ­¥ç”±äºç½‘ç»œç­‰åŸå› å¤±è´¥æˆ–è¶…æ—¶ï¼Œå®¢æˆ·ç«¯éƒ½å¯ä»¥é‡è¯•ï¼Œç›´åˆ°è·å¾—ç»“æœã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="http://idiotsky.top/images3/http-summary-51.png"><img src="http://idiotsky.top/images3/http-summary-51.png" alt=""></a></p>
<h2 id="HTTPçš„å¹‚ç­‰æ€§"><a href="#HTTPçš„å¹‚ç­‰æ€§" class="headerlink" title="HTTPçš„å¹‚ç­‰æ€§"></a>HTTPçš„å¹‚ç­‰æ€§</h2><p>HTTPåè®®æœ¬èº«æ˜¯ä¸€ç§é¢å‘èµ„æºçš„åº”ç”¨å±‚åè®®ï¼Œä½†å¯¹HTTPåè®®çš„ä½¿ç”¨å®é™…ä¸Šå­˜åœ¨ç€ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼šä¸€ç§æ˜¯RESTfulçš„ï¼Œå®ƒæŠŠHTTPå½“æˆåº”ç”¨å±‚åè®®ï¼Œæ¯”è¾ƒå¿ å®åœ°éµå®ˆäº†HTTPåè®®çš„å„ç§è§„å®šï¼›å¦ä¸€ç§æ˜¯SOAçš„ï¼Œå®ƒå¹¶æ²¡æœ‰å®Œå…¨æŠŠHTTPå½“æˆåº”ç”¨å±‚åè®®ï¼Œè€Œæ˜¯æŠŠHTTPåè®®ä½œä¸ºäº†ä¼ è¾“å±‚åè®®ï¼Œç„¶ååœ¨HTTPä¹‹ä¸Šå»ºç«‹äº†è‡ªå·±çš„åº”ç”¨å±‚åè®®ã€‚æœ¬æ–‡æ‰€è®¨è®ºçš„HTTPå¹‚ç­‰æ€§ä¸»è¦é’ˆå¯¹RESTfulé£æ ¼çš„ï¼Œä¸è¿‡æ­£å¦‚ä¸Šä¸€èŠ‚æ‰€çœ‹åˆ°çš„é‚£æ ·ï¼Œå¹‚ç­‰æ€§å¹¶ä¸å±äºç‰¹å®šçš„åè®®ï¼Œå®ƒæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ç§ç‰¹æ€§ï¼›æ‰€ä»¥ï¼Œä¸è®ºæ˜¯SOAè¿˜æ˜¯RESTfulçš„Web APIè®¾è®¡éƒ½åº”è¯¥è€ƒè™‘å¹‚ç­‰æ€§ã€‚ä¸‹é¢å°†ä»‹ç»HTTP GETã€DELETEã€PUTã€POSTå››ç§ä¸»è¦æ–¹æ³•çš„è¯­ä¹‰å’Œå¹‚ç­‰æ€§ã€‚</p>
<p>HTTP GETæ–¹æ³•ç”¨äºè·å–èµ„æºï¼Œä¸åº”æœ‰å‰¯ä½œç”¨ï¼Œæ‰€ä»¥æ˜¯å¹‚ç­‰çš„ã€‚æ¯”å¦‚ï¼šGET <a href="http://www.bank.com/account/123456ï¼Œä¸ä¼šæ”¹å˜èµ„æºçš„çŠ¶æ€ï¼Œä¸è®ºè°ƒç”¨ä¸€æ¬¡è¿˜æ˜¯Næ¬¡éƒ½æ²¡æœ‰å‰¯ä½œç”¨ã€‚è¯·æ³¨æ„ï¼Œè¿™é‡Œå¼ºè°ƒçš„æ˜¯ä¸€æ¬¡å’ŒNæ¬¡å…·æœ‰ç›¸åŒçš„å‰¯ä½œç”¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡GETçš„ç»“æœç›¸åŒã€‚GET" target="_blank" rel="noopener">http://www.bank.com/account/123456ï¼Œä¸ä¼šæ”¹å˜èµ„æºçš„çŠ¶æ€ï¼Œä¸è®ºè°ƒç”¨ä¸€æ¬¡è¿˜æ˜¯Næ¬¡éƒ½æ²¡æœ‰å‰¯ä½œç”¨ã€‚è¯·æ³¨æ„ï¼Œè¿™é‡Œå¼ºè°ƒçš„æ˜¯ä¸€æ¬¡å’ŒNæ¬¡å…·æœ‰ç›¸åŒçš„å‰¯ä½œç”¨ï¼Œè€Œä¸æ˜¯æ¯æ¬¡GETçš„ç»“æœç›¸åŒã€‚GET</a> <a href="http://www.news.com/latest-newsè¿™ä¸ªHTTPè¯·æ±‚å¯èƒ½ä¼šæ¯æ¬¡å¾—åˆ°ä¸åŒçš„ç»“æœï¼Œä½†å®ƒæœ¬èº«å¹¶æ²¡æœ‰äº§ç”Ÿä»»ä½•å‰¯ä½œç”¨ï¼Œå› è€Œæ˜¯æ»¡è¶³å¹‚ç­‰æ€§çš„ã€‚" target="_blank" rel="noopener">http://www.news.com/latest-newsè¿™ä¸ªHTTPè¯·æ±‚å¯èƒ½ä¼šæ¯æ¬¡å¾—åˆ°ä¸åŒçš„ç»“æœï¼Œä½†å®ƒæœ¬èº«å¹¶æ²¡æœ‰äº§ç”Ÿä»»ä½•å‰¯ä½œç”¨ï¼Œå› è€Œæ˜¯æ»¡è¶³å¹‚ç­‰æ€§çš„ã€‚</a></p>
<p>HTTP DELETEæ–¹æ³•ç”¨äºåˆ é™¤èµ„æºï¼Œæœ‰å‰¯ä½œç”¨ï¼Œä½†å®ƒåº”è¯¥æ»¡è¶³å¹‚ç­‰æ€§ã€‚æ¯”å¦‚ï¼šDELETE <a href="http://www.forum.com/article/4231ï¼Œè°ƒç”¨ä¸€æ¬¡å’ŒNæ¬¡å¯¹ç³»ç»Ÿäº§ç”Ÿçš„å‰¯ä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œå³åˆ æ‰idä¸º4231çš„å¸–å­ï¼›å› æ­¤ï¼Œè°ƒç”¨è€…å¯ä»¥å¤šæ¬¡è°ƒç”¨æˆ–åˆ·æ–°é¡µé¢è€Œä¸å¿…æ‹…å¿ƒå¼•èµ·é”™è¯¯ã€‚" target="_blank" rel="noopener">http://www.forum.com/article/4231ï¼Œè°ƒç”¨ä¸€æ¬¡å’ŒNæ¬¡å¯¹ç³»ç»Ÿäº§ç”Ÿçš„å‰¯ä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œå³åˆ æ‰idä¸º4231çš„å¸–å­ï¼›å› æ­¤ï¼Œè°ƒç”¨è€…å¯ä»¥å¤šæ¬¡è°ƒç”¨æˆ–åˆ·æ–°é¡µé¢è€Œä¸å¿…æ‹…å¿ƒå¼•èµ·é”™è¯¯ã€‚</a></p>
<p>æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„æ˜¯HTTP POSTå’ŒPUTã€‚POSTå’ŒPUTçš„åŒºåˆ«å®¹æ˜“è¢«ç®€å•åœ°è¯¯è®¤ä¸ºâ€œPOSTè¡¨ç¤ºåˆ›å»ºèµ„æºï¼ŒPUTè¡¨ç¤ºæ›´æ–°èµ„æºâ€ï¼›è€Œå®é™…ä¸Šï¼ŒäºŒè€…å‡å¯ç”¨äºåˆ›å»ºèµ„æºï¼Œæ›´ä¸ºæœ¬è´¨çš„å·®åˆ«æ˜¯åœ¨å¹‚ç­‰æ€§æ–¹é¢ã€‚åœ¨HTTPè§„èŒƒä¸­å¯¹POSTå’ŒPUTæ˜¯è¿™æ ·å®šä¹‰çš„ï¼š</p>
<blockquote>
<p>The POST method is used to request that the origin server accept the entity enclosed in the request as a new subordinate of the resource identified by the Request-URI in the Request-Line â€¦â€¦ If a resource has been created on the origin server, the response SHOULD be 201 (Created) and contain an entity which describes the status of the request and refers to the new resource, and a Location header.</p>
</blockquote>
<blockquote>
<p>The PUT method requests that the enclosed entity be stored under the supplied Request-URI. If the Request-URI refers to an already existing resource, the enclosed entity SHOULD be considered as a modified version of the one residing on the origin server. If the Request-URI does not point to an existing resource, and that URI is capable of being defined as a new resource by the requesting user agent, the origin server can create the resource with that URI.</p>
</blockquote>
<p>POSTæ‰€å¯¹åº”çš„URIå¹¶éåˆ›å»ºçš„èµ„æºæœ¬èº«ï¼Œè€Œæ˜¯èµ„æºçš„æ¥æ”¶è€…ã€‚æ¯”å¦‚ï¼šPOST <a href="http://www.forum.com/articles" target="_blank" rel="noopener">http://www.forum.com/articles</a> çš„è¯­ä¹‰æ˜¯åœ¨<a href="http://www.forum.com/articles" target="_blank" rel="noopener">http://www.forum.com/articles</a> ä¸‹åˆ›å»ºä¸€ç¯‡å¸–å­ï¼ŒHTTPå“åº”ä¸­åº”åŒ…å«å¸–å­çš„åˆ›å»ºçŠ¶æ€ä»¥åŠå¸–å­çš„URIã€‚ä¸¤æ¬¡ç›¸åŒçš„POSTè¯·æ±‚ä¼šåœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºä¸¤ä»½èµ„æºï¼Œå®ƒä»¬å…·æœ‰ä¸åŒçš„URIï¼›æ‰€ä»¥ï¼ŒPOSTæ–¹æ³•ä¸å…·å¤‡å¹‚ç­‰æ€§ã€‚è€ŒPUTæ‰€å¯¹åº”çš„URIæ˜¯è¦åˆ›å»ºæˆ–æ›´æ–°çš„èµ„æºæœ¬èº«ã€‚æ¯”å¦‚ï¼šPUT <a href="http://www.forum/articles/4231" target="_blank" rel="noopener">http://www.forum/articles/4231</a> çš„è¯­ä¹‰æ˜¯åˆ›å»ºæˆ–æ›´æ–°IDä¸º4231çš„å¸–å­ã€‚å¯¹åŒä¸€URIè¿›è¡Œå¤šæ¬¡PUTçš„å‰¯ä½œç”¨å’Œä¸€æ¬¡PUTæ˜¯ç›¸åŒçš„ï¼›å› æ­¤ï¼ŒPUTæ–¹æ³•å…·æœ‰å¹‚ç­‰æ€§ã€‚</p>
<p>åœ¨ä»‹ç»äº†å‡ ç§æ“ä½œçš„è¯­ä¹‰å’Œå¹‚ç­‰æ€§ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡Web APIçš„å½¢å¼å®ç°å‰é¢æ‰€æåˆ°çš„å–æ¬¾åŠŸèƒ½ã€‚å¾ˆç®€å•ï¼Œç”¨POST /ticketsæ¥å®ç°create_ticketï¼›ç”¨PUT /accounts/account_id/ticket_id?amount=xxxæ¥å®ç°idempotent_withdrawã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ä¸¥æ ¼æ¥è®²amountå‚æ•°ä¸åº”è¯¥ä½œä¸ºURIçš„ä¸€éƒ¨åˆ†ï¼ŒçœŸæ­£çš„URIåº”è¯¥æ˜¯/accounts/account_id/ticket_idï¼Œè€Œamountåº”è¯¥æ”¾åœ¨è¯·æ±‚çš„bodyä¸­ã€‚è¿™ç§æ¨¡å¼å¯ä»¥åº”ç”¨äºå¾ˆå¤šåœºåˆï¼Œæ¯”å¦‚ï¼šè®ºå›ç½‘ç«™ä¸­é˜²æ­¢æ„å¤–çš„é‡å¤å‘å¸–ã€‚</p>
<h2 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ä¸Šé¢ç®€å•ä»‹ç»äº†å¹‚ç­‰æ€§çš„æ¦‚å¿µï¼Œç”¨å¹‚ç­‰è®¾è®¡å–ä»£åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ³•ï¼Œä»¥åŠHTTPä¸»è¦æ–¹æ³•çš„è¯­ä¹‰å’Œå¹‚ç­‰æ€§ç‰¹å¾ã€‚å…¶å®ï¼Œå¦‚æœè¦è¿½æ ¹æº¯æºï¼Œå¹‚ç­‰æ€§æ˜¯æ•°å­¦ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œè¡¨è¾¾çš„æ˜¯Næ¬¡å˜æ¢ä¸1æ¬¡å˜æ¢çš„ç»“æœç›¸åŒï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥ä»Wikipediaä¸Šè¿›ä¸€æ­¥äº†è§£ã€‚</p>
<p>ref</p>
<p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/04/cors.html</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html</a></p>
<p><a href="https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/HTTP.md" target="_blank" rel="noopener">https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/HTTP.md</a></p>
<p><a href="https://www.cnblogs.com/chenqf/p/6386163.html" target="_blank" rel="noopener">https://www.cnblogs.com/chenqf/p/6386163.html</a></p>
<p><a href="http://www.cnblogs.com/weidagang2046/archive/2011/06/04/2063696.html" target="_blank" rel="noopener">http://www.cnblogs.com/weidagang2046/archive/2011/06/04/2063696.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ğŸ‘¿ mark ï¼Œå¾ˆé•¿ ğŸ˜„&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;HTTP-æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#HTTP-æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;HTTP æ¦‚è¿°&quot;&gt;&lt;/a&gt;HTTP æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;Web ä½¿ç”¨ä¸€ç§åä¸º HTTP (HyperText Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®) çš„åè®®ä½œä¸ºè§„èŒƒçš„ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;HTTP æ›´åŠ ä¸¥è°¨çš„è¯‘ååº”è¯¥æ˜¯ è¶…æ–‡æœ¬è½¬ç§»åè®®ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;HTTP äº 1990 å¹´é—®ä¸–ã€‚é‚£æ—¶çš„ HTTP å¹¶æ²¡æœ‰ä½œä¸ºæ­£å¼çš„æ ‡å‡†ï¼Œå› ä¸ºè¢«ç§°ä¸º HTTP/0.9&lt;br&gt;HTTP æ­£å¼ä½œä¸ºæ ‡å‡†è¢«å…¬å¸ƒæ˜¯ 1996 å¹´ 5 æœˆï¼Œç‰ˆæœ¬å‘½åä¸º HTTP/1.0ï¼Œè®°è½½äº RFC1945&lt;br&gt;HTTP åœ¨ 1997 å¹´ 1 æœˆå…¬å¸ƒäº†å½“å‰æœ€ä¸»æµçš„ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å‘½åä¸º HTTP/1.1ï¼Œè®°è½½äº RFC2616&lt;br&gt;HTTP/2 äº 2015 å¹´ 5 æœˆ 14 æ—¥å‘å¸ƒï¼Œå¼•å…¥äº†æœåŠ¡å™¨æ¨é€ç­‰å¤šç§åŠŸèƒ½ï¼Œæ˜¯ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬ã€‚è®°è½½äº RFC7540&lt;br&gt;(å®ƒä¸å« HTTP/2.0ï¼Œæ˜¯å› ä¸ºæ ‡å‡†å§”å‘˜ä¼šä¸æ‰“ç®—å†å‘å¸ƒå­ç‰ˆæœ¬äº†ï¼Œä¸‹ä¸€ä¸ªæ–°ç‰ˆæœ¬å°†æ˜¯ HTTP/3)&lt;/p&gt;
    
    </summary>
    
      <category term="protocols" scheme="http://idiotsky.top/categories/protocols/"/>
    
    
      <category term="protocols" scheme="http://idiotsky.top/tags/protocols/"/>
    
      <category term="http" scheme="http://idiotsky.top/tags/http/"/>
    
  </entry>
  
  <entry>
    <title>Unicodeå’ŒUTF-8</title>
    <link href="http://idiotsky.top/2018/03/19/unicode-utf8/"/>
    <id>http://idiotsky.top/2018/03/19/unicode-utf8/</id>
    <published>2018-03-19T15:43:59.000Z</published>
    <updated>2018-03-20T14:12:23.548Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¿™ä¸ªå¾ˆç®€å•çš„è¯´æ˜äº†unicodeå’ŒUTF-8çš„å…³ç³» ğŸ‘¿</p>
</blockquote>
<ul>
<li>Unicode æ˜¯ã€Œå­—ç¬¦é›†ã€</li>
<li>UTF-8 æ˜¯ã€Œç¼–ç è§„åˆ™ã€</li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>å­—ç¬¦é›†ï¼šä¸ºæ¯ä¸€ä¸ªã€Œå­—ç¬¦ã€åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ IDï¼ˆå­¦åä¸ºç ä½ / ç ç‚¹ / Code Pointï¼‰</li>
<li>ç¼–ç è§„åˆ™ï¼šå°†ã€Œç ä½ã€è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è§„åˆ™ï¼ˆç¼–ç /è§£ç  å¯ä»¥ç†è§£ä¸º åŠ å¯†/è§£å¯† çš„è¿‡ç¨‹ï¼‰</li>
</ul>
<a id="more"></a>
<p>å¹¿ä¹‰çš„ Unicode æ˜¯ä¸€ä¸ªæ ‡å‡†ï¼Œå®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦é›†ä»¥åŠä¸€ç³»åˆ—çš„ç¼–ç è§„åˆ™ï¼Œå³ Unicode å­—ç¬¦é›†å’Œ UTF-8ã€UTF-16ã€UTF-32 ç­‰ç­‰ç¼–ç â€¦â€¦</p>
<p>Unicode å­—ç¬¦é›†ä¸ºæ¯ä¸€ä¸ªå­—ç¬¦åˆ†é…ä¸€ä¸ªç ä½ï¼Œä¾‹å¦‚ã€ŒçŸ¥ã€çš„ç ä½æ˜¯ 30693ï¼Œè®°ä½œ U+77E5ï¼ˆ30693 çš„åå…­è¿›åˆ¶ä¸º 0x77E5ï¼‰ã€‚</p>
<p>UTF-8 é¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€å¥—ä»¥ 8 ä½ä¸ºä¸€ä¸ªç¼–ç å•ä½çš„å¯å˜é•¿ç¼–ç ã€‚ä¼šå°†ä¸€ä¸ªç ä½ç¼–ç ä¸º 1 åˆ° 4 ä¸ªå­—èŠ‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">U+ 0000 ~ U+ 007F: 0XXXXXXX</span><br><span class="line">U+ 0080 ~ U+ 07FF: 110XXXXX 10XXXXXX</span><br><span class="line">U+ 0800 ~ U+ FFFF: 1110XXXX 10XXXXXX 10XXXXXX</span><br><span class="line">U+10000 ~ U+1FFFF: 11110XXX 10XXXXXX 10XXXXXX 10XXXXXX</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä¸Šè¡¨ä¸­çš„ç¼–ç è§„åˆ™ï¼Œä¹‹å‰çš„ã€ŒçŸ¥ã€å­—çš„ç ä½ U+77E5 å±äºç¬¬ä¸‰è¡Œçš„èŒƒå›´ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">       7    7    E    5    </span><br><span class="line">    0111 0111 1110 0101    äºŒè¿›åˆ¶çš„ 77E5</span><br><span class="line">--------------------------</span><br><span class="line">    0111   011111   100101 äºŒè¿›åˆ¶çš„ 77E5</span><br><span class="line">1110XXXX 10XXXXXX 10XXXXXX æ¨¡ç‰ˆï¼ˆä¸Šè¡¨ç¬¬ä¸‰è¡Œï¼‰</span><br><span class="line">11100111 10011111 10100101 ä»£å…¥æ¨¡ç‰ˆ</span><br><span class="line">   E   7    9   F    A   5</span><br></pre></td></tr></table></figure></p>
<p>è¿™å°±æ˜¯å°† U+77E5 æŒ‰ç…§ UTF-8 ç¼–ç ä¸ºå­—èŠ‚åºåˆ— E79FA5 çš„è¿‡ç¨‹ã€‚åä¹‹äº¦ç„¶ã€‚</p>
<p>ref <a href="https://www.zhihu.com/question/23374078" target="_blank" rel="noopener">https://www.zhihu.com/question/23374078</a></p>
<p>ç™¾åº¦ç™¾ç§‘å…¶å®ä¹Ÿè¯´å¾—ä¸é”™äº†<br><a href="https://baike.baidu.com/item/Unicode/750500" target="_blank" rel="noopener">https://baike.baidu.com/item/Unicode/750500</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¿™ä¸ªå¾ˆç®€å•çš„è¯´æ˜äº†unicodeå’ŒUTF-8çš„å…³ç³» ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Unicode æ˜¯ã€Œå­—ç¬¦é›†ã€&lt;/li&gt;
&lt;li&gt;UTF-8 æ˜¯ã€Œç¼–ç è§„åˆ™ã€&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å…¶ä¸­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å­—ç¬¦é›†ï¼šä¸ºæ¯ä¸€ä¸ªã€Œå­—ç¬¦ã€åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ IDï¼ˆå­¦åä¸ºç ä½ / ç ç‚¹ / Code Pointï¼‰&lt;/li&gt;
&lt;li&gt;ç¼–ç è§„åˆ™ï¼šå°†ã€Œç ä½ã€è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è§„åˆ™ï¼ˆç¼–ç /è§£ç  å¯ä»¥ç†è§£ä¸º åŠ å¯†/è§£å¯† çš„è¿‡ç¨‹ï¼‰&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="ç¼–ç " scheme="http://idiotsky.top/categories/%E7%BC%96%E7%A0%81/"/>
    
    
      <category term="Unicode" scheme="http://idiotsky.top/tags/Unicode/"/>
    
      <category term="UTF-8" scheme="http://idiotsky.top/tags/UTF-8/"/>
    
  </entry>
  
  <entry>
    <title>linuxçš„å†™æ—¶å¤åˆ¶</title>
    <link href="http://idiotsky.top/2018/03/13/linux-copy-on-write/"/>
    <id>http://idiotsky.top/2018/03/13/linux-copy-on-write/</id>
    <published>2018-03-13T15:32:23.000Z</published>
    <updated>2018-07-17T11:39:16.529Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>å‰é¢ä¸€ç¯‡æ–‡ç« åˆç»™è‡ªå·±æŒ–å‘ï¼Œæ‰€ä»¥å¿…é¡»å†markä¸€ç¯‡ï¼Œè¿™ç¯‡æ–‡ç« å¾ˆå¥½çš„è¯´äº†å…³äºå†™æ—¶å¤åˆ¶çš„åŸç†ã€‚</p>
</blockquote>
<p>å½“è°ƒç”¨fork()ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼ŒLinuxå¹¶ä¸ä¼šä¸ºå­è¿›ç¨‹åˆ›å»ºæ–°çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯å…¬ç”¨çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ã€‚è¿™æ˜¯å› ä¸ºLinuxçš„å†…æ ¸å¼€å‘è€…è§‰å¾—ï¼Œè°ƒç”¨è€…è°ƒç”¨fork()ç³»ç»Ÿè°ƒç”¨åä¼šç«‹åˆ»è°ƒç”¨exec()ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæ–°çš„ç¨‹åºï¼Œè¿™æ ·æ—§çš„ç‰©ç†å†…å­˜å†…å®¹å°±æ²¡æœ‰ä»€ä¹ˆä½œç”¨äº†ï¼ˆå› ä¸ºæ–°çš„ç¨‹åºä¸æ—§çš„ç¨‹åºå®Œå…¨æ²¡æœ‰å…³è”ï¼‰ï¼Œæ‰€ä»¥ä¸ºå­è¿›ç¨‹å¤åˆ¶çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜å†…å®¹æ˜¯ä¸€ä»¶å¾’åŠ³æ— åŠŸçš„äº‹æƒ…ã€‚</p>
<p>æ‰€ä»¥Linuxçš„åšæ³•å°±æ˜¯ï¼šçˆ¶å­è¿›ç¨‹å…±ç”¨åŒä¸€ç‰©ç†å†…å­˜ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images2/linux-copy-on-write-1.png"><img src="http://idiotsky.top/images2/linux-copy-on-write-1.png" alt=""></a><br><a id="more"></a></p>
<p>ä½†æ“ä½œç³»ç»Ÿçš„è¦æ±‚æ˜¯ï¼šè¿›ç¨‹ä¹‹é—´çš„å†…å­˜åº”è¯¥è¦ç‹¬ç«‹ï¼Œå°±æ˜¯è¯»å†™Aè¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸åº”è¯¥å½±å“Bè¿›ç¨‹çš„å†…å­˜å†…å®¹ã€‚è¯»æ“ä½œæ˜¯ä¸ä¼šæ”¹å˜å†…å­˜ä¸­çš„å†…å®¹ï¼Œæ‰€ä»¥å¯¹äºè¯»æ“ä½œæ¥è¯´ï¼Œå…±äº«ç‰©ç†å†…å­˜æ˜¯å®‰å…¨çš„ã€‚ä½†æ˜¯å¯¹äºå†™æ“ä½œå°±ä¸ä¸€æ ·ï¼Œå¦‚æœçˆ¶å­è¿›ç¨‹å…±ç”¨äº†ç›¸åŒçš„ç‰©ç†å†…å­˜ï¼Œé‚£ä¹ˆå¯¹å­è¿›ç¨‹çš„å†…å­˜è¿›è¡Œå†™æ“ä½œåŒæ—¶ä¼šå½±å“åˆ°çˆ¶è¿›ç¨‹ï¼Œæ‰€ä»¥è¿åäº†æ“ä½œç³»ç»Ÿçš„è¦æ±‚ã€‚</p>
<p>Linuxçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šæŠŠå…±ç”¨çš„ç‰©ç†å†…å­˜è®¾ç½®ä¸ºåªè¯»ï¼Œå› ä¸ºè¯»æ“ä½œä¸ä¼šæ”¹å˜å†…å­˜çš„å†…å®¹ï¼Œæ‰€ä»¥å¯¹äºçˆ¶å­è¿›ç¨‹éƒ½æ˜¯å…è®¸çš„ã€‚è€Œå½“çˆ¶å­è¿›ç¨‹å…¶ä¸­ä¸€ä¸ªè¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå› ä¸ºå†…å­˜è¢«è®¾ç½®ä¸ºåªè¯»ï¼Œæ‰€ä»¥CPUä¼šè§¦å‘ â€œpage faultâ€ çš„é”™è¯¯ï¼Œä»è€Œè°ƒç”¨å†…æ ¸çš„<code>do_page_fault()</code>å‡½æ•°ã€‚è€Œ<code>do_page_fault()</code>å‡½æ•°åˆä¼šè°ƒç”¨<code>do_wp_page()</code>å‡½æ•°å»è¿›è¡Œå¤åˆ¶çˆ¶è¿›ç¨‹å†…å­˜çš„å†…å®¹ã€‚</p>
<p><code>do_wp_page()</code>å‡½æ•°å…ˆè¿›è¡Œä¸€äº›å®‰å…¨ç›‘æµ‹ï¼Œç„¶åè°ƒç”¨<code>__do_wp_page()</code>å‡½æ•°åšæœ€åçš„å¤åˆ¶æ“ä½œã€‚å»æ‰ä¸€äº›ç›‘æµ‹åï¼Œ<code>__do_wp_page()</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images2/linux-copy-on-write-3.jpg"><img src="http://idiotsky.top/images2/linux-copy-on-write-3.jpg" alt=""></a> </p>
<p><code>__do_wp_page()</code>é¦–å…ˆä¼šç”³è¯·ä¸€å—æ–°çš„ç‰©ç†å†…å­˜ï¼Œç„¶åå¤åˆ¶æ—§çš„ç‰©ç†å†…å­˜é¡µçš„å†…å®¹åˆ°æ–°çš„ç‰©ç†å†…å­˜ä¹Ÿä¸­ï¼Œç„¶åè®¾ç½®è™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»ã€‚æœ€åæŠŠçˆ¶å­è¿›ç¨‹çš„ç‰©ç†å†…å­˜è®¾ç½®å¯è¯»å†™ï¼Œè¿™æ ·çˆ¶å­è¿›ç¨‹ç›¸åŒçš„è™šæ‹Ÿå†…å­˜éƒ½æŒ‡å‘ä¸åŒçš„ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥è¾¾åˆ°è¿›ç¨‹ä¹‹é—´å†…å­˜éš”ç¦»çš„ç›®çš„ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images2/linux-copy-on-write-2.png"><img src="http://idiotsky.top/images2/linux-copy-on-write-2.png" alt=""></a> </p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å‰é¢ä¸€ç¯‡æ–‡ç« åˆç»™è‡ªå·±æŒ–å‘ï¼Œæ‰€ä»¥å¿…é¡»å†markä¸€ç¯‡ï¼Œè¿™ç¯‡æ–‡ç« å¾ˆå¥½çš„è¯´äº†å…³äºå†™æ—¶å¤åˆ¶çš„åŸç†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å½“è°ƒç”¨fork()ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼ŒLinuxå¹¶ä¸ä¼šä¸ºå­è¿›ç¨‹åˆ›å»ºæ–°çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯å…¬ç”¨çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ã€‚è¿™æ˜¯å› ä¸ºLinuxçš„å†…æ ¸å¼€å‘è€…è§‰å¾—ï¼Œè°ƒç”¨è€…è°ƒç”¨fork()ç³»ç»Ÿè°ƒç”¨åä¼šç«‹åˆ»è°ƒç”¨exec()ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæ–°çš„ç¨‹åºï¼Œè¿™æ ·æ—§çš„ç‰©ç†å†…å­˜å†…å®¹å°±æ²¡æœ‰ä»€ä¹ˆä½œç”¨äº†ï¼ˆå› ä¸ºæ–°çš„ç¨‹åºä¸æ—§çš„ç¨‹åºå®Œå…¨æ²¡æœ‰å…³è”ï¼‰ï¼Œæ‰€ä»¥ä¸ºå­è¿›ç¨‹å¤åˆ¶çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜å†…å®¹æ˜¯ä¸€ä»¶å¾’åŠ³æ— åŠŸçš„äº‹æƒ…ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥Linuxçš„åšæ³•å°±æ˜¯ï¼šçˆ¶å­è¿›ç¨‹å…±ç”¨åŒä¸€ç‰©ç†å†…å­˜ã€‚å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://idiotsky.top/images2/linux-copy-on-write-1.png&quot;&gt;&lt;img src=&quot;http://idiotsky.top/images2/linux-copy-on-write-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="linux" scheme="http://idiotsky.top/categories/linux/"/>
    
    
      <category term="linux" scheme="http://idiotsky.top/tags/linux/"/>
    
      <category term="linuxå†…æ ¸" scheme="http://idiotsky.top/tags/linux%E5%86%85%E6%A0%B8/"/>
    
  </entry>
  
  <entry>
    <title>linuxçš„é›¶æ‹·è´æŠ€æœ¯</title>
    <link href="http://idiotsky.top/2018/03/13/linux-zero-copy/"/>
    <id>http://idiotsky.top/2018/03/13/linux-zero-copy/</id>
    <published>2018-03-13T14:01:39.000Z</published>
    <updated>2018-07-17T11:39:16.530Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ğŸ‘¿ linuxå†…æ ¸é‡Œé¢ä¸ºæ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦å»ºç«‹ç¼“å­˜çš„ï¼Œè€Œç”¨æˆ·å±‚ä¹Ÿæœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œé‚£æ ·æ¯æ¬¡readå’Œwriteç­‰ç›¸å…³ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ä½†æœ‰å¯èƒ½ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œä¸”è¿˜è¦ä¸æ–­ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€æˆ–è€…ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ã€‚å¦‚æœæœ‰äº›æ•°æ®ä¸ç”¨ç»è¿‡ç”¨æˆ·å±‚çš„è¯ï¼ˆä¾‹å¦‚ç½‘ç»œä»£ç†æœåŠ¡ï¼‰ï¼Œå¯ä»¥ä¸ç”¨è¿™ç§æ‹·è´æ¥æµªè´¹èµ„æºï¼Œæ‰€ä»¥Linuxçš„ç³»ç»Ÿè°ƒç”¨å°±æœ‰äº†å‡ ä¸ªé›¶æ‹·è´çš„å‡½æ•°æ¥è§£å†³è¿™ç§é—®é¢˜ã€‚ï¼ˆè™½è¯´é›¶æ‹·è´ï¼Œä½†å…¶å®ä¹Ÿåªæ˜¯å‡å°‘äº†ç”¨æˆ·æ€æ‹·è´ï¼ŒæŠŠæ‰€æœ‰æ‹·è´éƒ½åœ¨å†…æ ¸é‡Œé¢å¤„ç†äº†ï¼‰</p>
</blockquote>
<h1 id="å¼•æ–‡"><a href="#å¼•æ–‡" class="headerlink" title="å¼•æ–‡"></a>å¼•æ–‡</h1><p>åœ¨å†™ä¸€ä¸ªæœåŠ¡ç«¯ç¨‹åºæ—¶ï¼ˆWeb Serveræˆ–è€…æ–‡ä»¶æœåŠ¡å™¨ï¼‰ï¼Œæ–‡ä»¶ä¸‹è½½æ˜¯ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½ã€‚è¿™æ—¶å€™æœåŠ¡ç«¯çš„ä»»åŠ¡æ˜¯ï¼š<strong>å°†æœåŠ¡ç«¯ä¸»æœºç£ç›˜ä¸­çš„æ–‡ä»¶ä¸åšä¿®æ”¹åœ°ä»å·²è¿æ¥çš„socketå‘å‡ºå»</strong>ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨ä¸‹é¢çš„ä»£ç å®Œæˆï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>((n = read(diskfd, buf, BUF_SIZE)) &gt; <span class="number">0</span>)</span><br><span class="line">    write(sockfd, buf , n);</span><br></pre></td></tr></table></figure></p>
<p>åŸºæœ¬æ“ä½œå°±æ˜¯å¾ªç¯çš„ä»ç£ç›˜è¯»å…¥æ–‡ä»¶å†…å®¹åˆ°ç¼“å†²åŒºï¼Œå†å°†ç¼“å†²åŒºçš„å†…å®¹å‘é€åˆ°socketã€‚ä½†æ˜¯ç”±äºLinuxçš„I/Oæ“ä½œé»˜è®¤æ˜¯ç¼“å†²I/Oã€‚è¿™é‡Œé¢ä¸»è¦ä½¿ç”¨çš„ä¹Ÿå°±æ˜¯readå’Œwriteä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“æ“ä½œç³»ç»Ÿåœ¨å…¶ä¸­åšäº†ä»€ä¹ˆã€‚å®é™…ä¸Šåœ¨ä»¥ä¸ŠI/Oæ“ä½œä¸­ï¼Œå‘ç”Ÿäº†å¤šæ¬¡çš„æ•°æ®æ‹·è´ã€‚<br><a id="more"></a></p>
<p>å½“åº”ç”¨ç¨‹åºè®¿é—®æŸå—æ•°æ®æ—¶ï¼Œæ“ä½œç³»ç»Ÿé¦–å…ˆä¼šæ£€æŸ¥ï¼Œæ˜¯ä¸æ˜¯æœ€è¿‘è®¿é—®è¿‡æ­¤æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯å¦ç¼“å­˜åœ¨å†…æ ¸ç¼“å†²åŒºï¼Œå¦‚æœæ˜¯ï¼Œæ“ä½œç³»ç»Ÿåˆ™ç›´æ¥æ ¹æ®readç³»ç»Ÿè°ƒç”¨æä¾›çš„bufåœ°å€ï¼Œå°†å†…æ ¸ç¼“å†²åŒºçš„å†…å®¹æ‹·è´åˆ°bufæ‰€æŒ‡å®šçš„ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºä¸­å»ã€‚å¦‚æœä¸æ˜¯ï¼Œæ“ä½œç³»ç»Ÿåˆ™é¦–å…ˆå°†ç£ç›˜ä¸Šçš„æ•°æ®æ‹·è´çš„å†…æ ¸ç¼“å†²åŒºï¼Œè¿™ä¸€æ­¥ç›®å‰ä¸»è¦ä¾é DMAæ¥ä¼ è¾“ï¼Œç„¶åå†æŠŠå†…æ ¸ç¼“å†²åŒºä¸Šçš„å†…å®¹æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºä¸­ã€‚<br>æ¥ä¸‹æ¥ï¼Œwriteç³»ç»Ÿè°ƒç”¨å†æŠŠç”¨æˆ·ç¼“å†²åŒºçš„å†…å®¹æ‹·è´åˆ°ç½‘ç»œå †æ ˆç›¸å…³çš„å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œæœ€åsocketå†æŠŠå†…æ ¸ç¼“å†²åŒºçš„å†…å®¹å‘é€åˆ°ç½‘å¡ä¸Šã€‚<br>è¯´äº†è¿™ä¹ˆå¤šï¼Œä¸å¦‚çœ‹å›¾æ¸…æ¥šï¼š</p>
<p><a href="http://idiotsky.top/images2/linux-zero-copy-1.png"><img src="http://idiotsky.top/images2/linux-zero-copy-1.png" alt=""></a> </p>
<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå…±äº§ç”Ÿäº†å››æ¬¡æ•°æ®æ‹·è´ï¼Œå³ä½¿ä½¿ç”¨äº†DMAæ¥å¤„ç†äº†ä¸ç¡¬ä»¶çš„é€šè®¯ï¼ŒCPUä»ç„¶éœ€è¦å¤„ç†ä¸¤æ¬¡æ•°æ®æ‹·è´ï¼Œä¸æ­¤åŒæ—¶ï¼Œåœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹Ÿå‘ç”Ÿäº†å¤šæ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ— ç–‘ä¹ŸåŠ é‡äº†CPUè´Ÿæ‹…ã€‚<br>åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰å¯¹æ–‡ä»¶å†…å®¹åšä»»ä½•ä¿®æ”¹ï¼Œé‚£ä¹ˆåœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´æ¥å›æ‹·è´æ•°æ®æ— ç–‘å°±æ˜¯ä¸€ç§æµªè´¹ï¼Œè€Œé›¶æ‹·è´ä¸»è¦å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§ä½æ•ˆæ€§ã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯é›¶æ‹·è´æŠ€æœ¯ï¼ˆzero-copyï¼‰ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯é›¶æ‹·è´æŠ€æœ¯ï¼ˆzero-copyï¼‰ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯é›¶æ‹·è´æŠ€æœ¯ï¼ˆzero-copyï¼‰ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯é›¶æ‹·è´æŠ€æœ¯ï¼ˆzero-copyï¼‰ï¼Ÿ</h1><p>é›¶æ‹·è´ä¸»è¦çš„ä»»åŠ¡å°±æ˜¯é¿å…CPUå°†æ•°æ®ä»ä¸€å—å­˜å‚¨æ‹·è´åˆ°å¦å¤–ä¸€å—å­˜å‚¨ï¼Œä¸»è¦å°±æ˜¯åˆ©ç”¨å„ç§é›¶æ‹·è´æŠ€æœ¯ï¼Œé¿å…è®©CPUåšå¤§é‡çš„æ•°æ®æ‹·è´ä»»åŠ¡ï¼Œå‡å°‘ä¸å¿…è¦çš„æ‹·è´ï¼Œæˆ–è€…è®©åˆ«çš„ç»„ä»¶æ¥åšè¿™ä¸€ç±»ç®€å•çš„æ•°æ®ä¼ è¾“ä»»åŠ¡ï¼Œè®©CPUè§£è„±å‡ºæ¥ä¸“æ³¨äºåˆ«çš„ä»»åŠ¡ã€‚è¿™æ ·å°±å¯ä»¥è®©ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨æ›´åŠ æœ‰æ•ˆã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­å›åˆ°å¼•æ–‡ä¸­çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¦‚ä½•å‡å°‘æ•°æ®æ‹·è´çš„æ¬¡æ•°å‘¢ï¼Ÿä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ç€åŠ›ç‚¹å°±æ˜¯å‡å°‘æ•°æ®åœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´æ¥å›æ‹·è´ï¼Œè¿™ä¹Ÿå¼•å…¥äº†é›¶æ‹·è´çš„ä¸€ä¸ªç±»å‹ï¼š</p>
<h2 id="ä½¿ç”¨mmap"><a href="#ä½¿ç”¨mmap" class="headerlink" title="ä½¿ç”¨mmap"></a>ä½¿ç”¨mmap</h2><p>æˆ‘ä»¬å‡å°‘æ‹·è´æ¬¡æ•°çš„ä¸€ç§æ–¹æ³•æ˜¯è°ƒç”¨mmap()æ¥ä»£æ›¿readè°ƒç”¨ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buf = mmap(diskfd, len);</span><br><span class="line">write(sockfd, buf, len);</span><br></pre></td></tr></table></figure></p>
<p>åº”ç”¨ç¨‹åºè°ƒç”¨mmap()ï¼Œç£ç›˜ä¸Šçš„æ•°æ®ä¼šé€šè¿‡DMAè¢«æ‹·è´çš„å†…æ ¸ç¼“å†²åŒºï¼Œæ¥ç€æ“ä½œç³»ç»Ÿä¼šæŠŠè¿™æ®µå†…æ ¸ç¼“å†²åŒºä¸åº”ç”¨ç¨‹åºå…±äº«ï¼Œè¿™æ ·å°±ä¸éœ€è¦æŠŠå†…æ ¸ç¼“å†²åŒºçš„å†…å®¹å¾€ç”¨æˆ·ç©ºé—´æ‹·è´ã€‚åº”ç”¨ç¨‹åºå†è°ƒç”¨write(),æ“ä½œç³»ç»Ÿç›´æ¥å°†å†…æ ¸ç¼“å†²åŒºçš„å†…å®¹æ‹·è´åˆ°socketç¼“å†²åŒºä¸­ï¼Œè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œæœ€åï¼Œsocketç¼“å†²åŒºå†æŠŠæ•°æ®å‘åˆ°ç½‘å¡å»ã€‚<br>åŒæ ·çš„ï¼Œçœ‹å›¾å¾ˆç®€å•ï¼š</p>
<p><a href="http://idiotsky.top/images2/linux-zero-copy-2.png"><img src="http://idiotsky.top/images2/linux-zero-copy-2.png" alt=""></a> </p>
<p>ä½¿ç”¨mmapæ›¿ä»£readå¾ˆæ˜æ˜¾å‡å°‘äº†ä¸€æ¬¡æ‹·è´ï¼Œå½“æ‹·è´æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œæ— ç–‘æå‡äº†æ•ˆç‡ã€‚ä½†æ˜¯ä½¿ç”¨mmapæ˜¯æœ‰ä»£ä»·çš„ã€‚å½“ä½ ä½¿ç”¨mmapæ—¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°ä¸€äº›éšè—çš„é™·é˜±ã€‚ä¾‹å¦‚ï¼Œå½“ä½ çš„ç¨‹åºmapäº†ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯å½“è¿™ä¸ªæ–‡ä»¶è¢«å¦ä¸€ä¸ªè¿›ç¨‹æˆªæ–­(truncate)æ—¶, writeç³»ç»Ÿè°ƒç”¨ä¼šå› ä¸ºè®¿é—®éæ³•åœ°å€è€Œè¢«SIGBUSä¿¡å·ç»ˆæ­¢ã€‚SIGBUSä¿¡å·é»˜è®¤ä¼šæ€æ­»ä½ çš„è¿›ç¨‹å¹¶äº§ç”Ÿä¸€ä¸ªcoredump,å¦‚æœä½ çš„æœåŠ¡å™¨è¿™æ ·è¢«ä¸­æ­¢äº†ï¼Œé‚£ä¼šäº§ç”Ÿä¸€ç¬”æŸå¤±ã€‚</p>
<p>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹è§£å†³æ–¹æ¡ˆé¿å…è¿™ç§é—®é¢˜ï¼š</p>
<ol>
<li>ä¸ºSIGBUSä¿¡å·å»ºç«‹ä¿¡å·å¤„ç†ç¨‹åº<br>å½“é‡åˆ°SIGBUSä¿¡å·æ—¶ï¼Œä¿¡å·å¤„ç†ç¨‹åºç®€å•åœ°è¿”å›ï¼Œwriteç³»ç»Ÿè°ƒç”¨åœ¨è¢«ä¸­æ–­ä¹‹å‰ä¼šè¿”å›å·²ç»å†™å…¥çš„å­—èŠ‚æ•°ï¼Œå¹¶ä¸”errnoä¼šè¢«è®¾ç½®æˆsuccess,ä½†æ˜¯è¿™æ˜¯ä¸€ç§ç³Ÿç³•çš„å¤„ç†åŠæ³•ï¼Œå› ä¸ºä½ å¹¶æ²¡æœ‰è§£å†³é—®é¢˜çš„å®è´¨æ ¸å¿ƒã€‚</li>
<li>ä½¿ç”¨æ–‡ä»¶ç§Ÿå€Ÿé”<br>é€šå¸¸æˆ‘ä»¬ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œåœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šä½¿ç”¨ç§Ÿå€Ÿé”ï¼Œæˆ‘ä»¬ä¸ºæ–‡ä»¶å‘å†…æ ¸ç”³è¯·ä¸€ä¸ªç§Ÿå€Ÿé”ï¼Œå½“å…¶å®ƒè¿›ç¨‹æƒ³è¦æˆªæ–­è¿™ä¸ªæ–‡ä»¶æ—¶ï¼Œå†…æ ¸ä¼šå‘æˆ‘ä»¬å‘é€ä¸€ä¸ªå®æ—¶çš„RT_SIGNAL_LEASEä¿¡å·ï¼Œå‘Šè¯‰æˆ‘ä»¬å†…æ ¸æ­£åœ¨ç ´åä½ åŠ æŒåœ¨æ–‡ä»¶ä¸Šçš„è¯»å†™é”ã€‚è¿™æ ·åœ¨ç¨‹åºè®¿é—®éæ³•å†…å­˜å¹¶ä¸”è¢«SIGBUSæ€æ­»ä¹‹å‰ï¼Œä½ çš„writeç³»ç»Ÿè°ƒç”¨ä¼šè¢«ä¸­æ–­ã€‚writeä¼šè¿”å›å·²ç»å†™å…¥çš„å­—èŠ‚æ•°ï¼Œå¹¶ä¸”ç½®errnoä¸ºsuccessã€‚</li>
</ol>
<p>æˆ‘ä»¬åº”è¯¥åœ¨mmapæ–‡ä»¶ä¹‹å‰åŠ é”ï¼Œå¹¶ä¸”åœ¨æ“ä½œå®Œæ–‡ä»¶åè§£é”ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(fcntl(diskfd, F_SETSIG, RT_SIGNAL_LEASE) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">"kernel lease set signal"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* l_type can be F_RDLCK F_WRLCK  åŠ é”*/</span></span><br><span class="line"><span class="comment">/* l_type can be  F_UNLCK è§£é”*/</span></span><br><span class="line"><span class="keyword">if</span>(fcntl(diskfd, F_SETLEASE, l_type))&#123;</span><br><span class="line">    perror(<span class="string">"kernel lease set type"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="ä½¿ç”¨sendfile"><a href="#ä½¿ç”¨sendfile" class="headerlink" title="ä½¿ç”¨sendfile"></a>ä½¿ç”¨sendfile</h2><p>ä»2.1ç‰ˆå†…æ ¸å¼€å§‹ï¼ŒLinuxå¼•å…¥äº†sendfileæ¥ç®€åŒ–æ“ä½œ:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"><span class="keyword">ssize_t</span> sendfile(<span class="keyword">int</span> out_fd, <span class="keyword">int</span> in_fd, <span class="keyword">off_t</span> *offset, <span class="keyword">size_t</span> count);</span><br></pre></td></tr></table></figure></p>
<p>ç³»ç»Ÿè°ƒç”¨sendfile()åœ¨ä»£è¡¨è¾“å…¥æ–‡ä»¶çš„æè¿°ç¬¦in_fdå’Œä»£è¡¨è¾“å‡ºæ–‡ä»¶çš„æè¿°ç¬¦out_fdä¹‹é—´ä¼ é€æ–‡ä»¶å†…å®¹ï¼ˆå­—èŠ‚ï¼‰ã€‚æè¿°ç¬¦out_fdå¿…é¡»æŒ‡å‘ä¸€ä¸ªå¥—æ¥å­—ï¼Œè€Œin_fdæŒ‡å‘çš„æ–‡ä»¶å¿…é¡»æ˜¯å¯ä»¥mmapçš„ã€‚è¿™äº›å±€é™é™åˆ¶äº†sendfileçš„ä½¿ç”¨ï¼Œä½¿sendfileåªèƒ½å°†æ•°æ®ä»æ–‡ä»¶ä¼ é€’åˆ°å¥—æ¥å­—ä¸Šï¼Œåä¹‹åˆ™ä¸è¡Œã€‚<br>ä½¿ç”¨sendfileä¸ä»…å‡å°‘äº†æ•°æ®æ‹·è´çš„æ¬¡æ•°ï¼Œè¿˜å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ•°æ®ä¼ é€å§‹ç»ˆåªå‘ç”Ÿåœ¨kernel spaceã€‚</p>
<p><a href="http://idiotsky.top/images2/linux-zero-copy-3.png"><img src="http://idiotsky.top/images2/linux-zero-copy-3.png" alt=""></a> </p>
<p>åœ¨æˆ‘ä»¬è°ƒç”¨sendfileæ—¶ï¼Œå¦‚æœæœ‰å…¶å®ƒè¿›ç¨‹æˆªæ–­äº†æ–‡ä»¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿå‡è®¾æˆ‘ä»¬æ²¡æœ‰è®¾ç½®ä»»ä½•ä¿¡å·å¤„ç†ç¨‹åºï¼Œsendfileè°ƒç”¨ä»…ä»…è¿”å›å®ƒåœ¨è¢«ä¸­æ–­ä¹‹å‰å·²ç»ä¼ è¾“çš„å­—èŠ‚æ•°ï¼Œerrnoä¼šè¢«ç½®ä¸ºsuccessã€‚å¦‚æœæˆ‘ä»¬åœ¨è°ƒç”¨sendfileä¹‹å‰ç»™æ–‡ä»¶åŠ äº†é”ï¼Œsendfileçš„è¡Œä¸ºä»ç„¶å’Œä¹‹å‰ç›¸åŒï¼Œæˆ‘ä»¬è¿˜ä¼šæ”¶åˆ°RT_SIGNAL_LEASEçš„ä¿¡å·ã€‚</p>
<p>ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å‡å°‘äº†æ•°æ®æ‹·è´çš„æ¬¡æ•°äº†ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨ä¸€æ¬¡æ‹·è´ï¼Œå°±æ˜¯é¡µç¼“å­˜åˆ°socketç¼“å­˜çš„æ‹·è´ã€‚é‚£ä¹ˆèƒ½ä¸èƒ½æŠŠè¿™ä¸ªæ‹·è´ä¹Ÿçœç•¥å‘¢ï¼Ÿ</p>
<p>å€ŸåŠ©äºç¡¬ä»¶ä¸Šçš„å¸®åŠ©ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥åŠåˆ°çš„ã€‚ä¹‹å‰æˆ‘ä»¬æ˜¯æŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´åˆ°socketç¼“å­˜ä¸­ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬ä»…ä»…éœ€è¦æŠŠç¼“å†²åŒºæè¿°ç¬¦ä¼ åˆ°socketç¼“å†²åŒºï¼Œå†æŠŠæ•°æ®é•¿åº¦ä¼ è¿‡å»ï¼Œè¿™æ ·DMAæ§åˆ¶å™¨ç›´æ¥å°†é¡µç¼“å­˜ä¸­çš„æ•°æ®æ‰“åŒ…å‘é€åˆ°ç½‘ç»œä¸­å°±å¯ä»¥äº†ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œsendfileç³»ç»Ÿè°ƒç”¨åˆ©ç”¨DMAå¼•æ“å°†æ–‡ä»¶å†…å®¹æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºå»ï¼Œç„¶åå°†å¸¦æœ‰æ–‡ä»¶ä½ç½®å’Œé•¿åº¦ä¿¡æ¯çš„ç¼“å†²åŒºæè¿°ç¬¦æ·»åŠ socketç¼“å†²åŒºå»ï¼Œè¿™ä¸€æ­¥ä¸ä¼šå°†å†…æ ¸ä¸­çš„æ•°æ®æ‹·è´åˆ°socketç¼“å†²åŒºä¸­ï¼ŒDMAå¼•æ“ä¼šå°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°åè®®å¼•æ“ä¸­å»ï¼Œé¿å…äº†æœ€åä¸€æ¬¡æ‹·è´ã€‚</p>
<p><a href="http://idiotsky.top/images2/linux-zero-copy-4.png"><img src="http://idiotsky.top/images2/linux-zero-copy-4.png" alt=""></a> </p>
<p>ä¸è¿‡è¿™ä¸€ç§æ”¶é›†æ‹·è´åŠŸèƒ½æ˜¯éœ€è¦ç¡¬ä»¶ä»¥åŠé©±åŠ¨ç¨‹åºæ”¯æŒçš„ã€‚</p>
<h2 id="ä½¿ç”¨splice"><a href="#ä½¿ç”¨splice" class="headerlink" title="ä½¿ç”¨splice"></a>ä½¿ç”¨splice</h2><p>sendfileåªé€‚ç”¨äºå°†æ•°æ®ä»æ–‡ä»¶æ‹·è´åˆ°å¥—æ¥å­—ä¸Šï¼Œé™å®šäº†å®ƒçš„ä½¿ç”¨èŒƒå›´ã€‚Linuxåœ¨2.6.17ç‰ˆæœ¬å¼•å…¥spliceç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­ç§»åŠ¨æ•°æ®ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE         <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="keyword">ssize_t</span> splice(<span class="keyword">int</span> fd_in, <span class="keyword">loff_t</span> *off_in, <span class="keyword">int</span> fd_out, <span class="keyword">loff_t</span> *off_out, <span class="keyword">size_t</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags);</span><br></pre></td></tr></table></figure></p>
<p>spliceè°ƒç”¨åœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œè€Œä¸éœ€è¦æ•°æ®åœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´æ¥å›æ‹·è´ã€‚ä»–ä»fd_inæ‹·è´lené•¿åº¦çš„æ•°æ®åˆ°fd_outï¼Œä½†æ˜¯æœ‰ä¸€æ–¹å¿…é¡»æ˜¯ç®¡é“è®¾å¤‡ï¼Œè¿™ä¹Ÿæ˜¯ç›®å‰spliceçš„ä¸€äº›å±€é™æ€§ã€‚flagså‚æ•°æœ‰ä»¥ä¸‹å‡ ç§å–å€¼ï¼š</p>
<ul>
<li>SPLICE_F_MOVE ï¼šå°è¯•å»ç§»åŠ¨æ•°æ®è€Œä¸æ˜¯æ‹·è´æ•°æ®ã€‚è¿™ä»…ä»…æ˜¯å¯¹å†…æ ¸çš„ä¸€ä¸ªå°æç¤ºï¼šå¦‚æœå†…æ ¸ä¸èƒ½ä»pipeç§»åŠ¨æ•°æ®æˆ–è€…pipeçš„ç¼“å­˜ä¸æ˜¯ä¸€ä¸ªæ•´é¡µé¢ï¼Œä»ç„¶éœ€è¦æ‹·è´æ•°æ®ã€‚Linuxæœ€åˆçš„å®ç°æœ‰äº›é—®é¢˜ï¼Œæ‰€ä»¥ä»2.6.21å¼€å§‹è¿™ä¸ªé€‰é¡¹ä¸èµ·ä½œç”¨ï¼Œåé¢çš„Linuxç‰ˆæœ¬åº”è¯¥ä¼šå®ç°ã€‚</li>
<li>SPLICE_F_NONBLOCK ï¼šsplice æ“ä½œä¸ä¼šè¢«é˜»å¡ã€‚ç„¶è€Œï¼Œå¦‚æœæ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰è¢«è®¾ç½®ä¸ºä¸å¯è¢«é˜»å¡æ–¹å¼çš„ I/O ï¼Œé‚£ä¹ˆè°ƒç”¨ splice æœ‰å¯èƒ½ä»ç„¶è¢«é˜»å¡ã€‚</li>
<li>SPLICE_F_MORE ï¼š åé¢çš„spliceè°ƒç”¨ä¼šæœ‰æ›´å¤šçš„æ•°æ®ã€‚</li>
</ul>
<p>spliceè°ƒç”¨åˆ©ç”¨äº†Linuxæå‡ºçš„ç®¡é“ç¼“å†²åŒºæœºåˆ¶ï¼Œ æ‰€ä»¥è‡³å°‘ä¸€ä¸ªæè¿°ç¬¦è¦ä¸ºç®¡é“ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå‡ ç§é›¶æ‹·è´æŠ€æœ¯éƒ½æ˜¯å‡å°‘æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´æŠ€æœ¯å®ç°çš„ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™ï¼Œæ•°æ®å¿…é¡»åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´æ‹·è´ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬åªèƒ½é’ˆå¯¹æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´çš„æ—¶æœºä¸Šä¸‹åŠŸå¤«äº†ã€‚Linuxé€šå¸¸åˆ©ç”¨å†™æ—¶å¤åˆ¶(copy on write)æ¥å‡å°‘ç³»ç»Ÿå¼€é”€ï¼Œè¿™ä¸ªæŠ€æœ¯åˆæ—¶å¸¸ç§°ä½œCOWã€‚</p>
<p>ç”±äºç¯‡å¹…åŸå› ï¼Œæœ¬æ–‡ä¸è¯¦ç»†ä»‹ç»å†™æ—¶å¤åˆ¶ã€‚å¤§æ¦‚æè¿°ä¸‹å°±æ˜¯ï¼šå¦‚æœå¤šä¸ªç¨‹åºåŒæ—¶è®¿é—®åŒä¸€å—æ•°æ®ï¼Œé‚£ä¹ˆæ¯ä¸ªç¨‹åºéƒ½æ‹¥æœ‰æŒ‡å‘è¿™å—æ•°æ®çš„æŒ‡é’ˆï¼Œåœ¨æ¯ä¸ªç¨‹åºçœ‹æ¥ï¼Œè‡ªå·±éƒ½æ˜¯ç‹¬ç«‹æ‹¥æœ‰è¿™å—æ•°æ®çš„ï¼Œåªæœ‰å½“ç¨‹åºéœ€è¦å¯¹æ•°æ®å†…å®¹è¿›è¡Œä¿®æ”¹æ—¶ï¼Œæ‰ä¼šæŠŠæ•°æ®å†…å®¹æ‹·è´åˆ°ç¨‹åºè‡ªå·±çš„åº”ç”¨ç©ºé—´é‡Œå»ï¼Œè¿™æ—¶å€™ï¼Œæ•°æ®æ‰æˆä¸ºè¯¥ç¨‹åºçš„ç§æœ‰æ•°æ®ã€‚å¦‚æœç¨‹åºä¸éœ€è¦å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆæ°¸è¿œéƒ½ä¸éœ€è¦æ‹·è´æ•°æ®åˆ°è‡ªå·±çš„åº”ç”¨ç©ºé—´é‡Œã€‚è¿™æ ·å°±å‡å°‘äº†æ•°æ®çš„æ‹·è´</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›é›¶æ‹·è´æŠ€æœ¯ï¼Œæ¯”å¦‚ä¼ ç»Ÿçš„Linux I/Oä¸­åŠ ä¸ŠO_DIRECTæ ‡è®°å¯ä»¥ç›´æ¥I/Oï¼Œé¿å…äº†è‡ªåŠ¨ç¼“å­˜ï¼Œè¿˜æœ‰å°šæœªæˆç†Ÿçš„fbufsæŠ€æœ¯ï¼Œæœ¬æ–‡å°šæœªè¦†ç›–æ‰€æœ‰é›¶æ‹·è´æŠ€æœ¯ï¼Œåªæ˜¯ä»‹ç»å¸¸è§çš„ä¸€äº›ï¼Œå¦‚æœ‰å…´è¶£ï¼Œå¯ä»¥è‡ªè¡Œç ”ç©¶ï¼Œä¸€èˆ¬æˆç†Ÿçš„æœåŠ¡ç«¯é¡¹ç›®ä¹Ÿä¼šè‡ªå·±æ”¹é€ å†…æ ¸ä¸­æœ‰å…³I/Oçš„éƒ¨åˆ†ï¼Œæé«˜è‡ªå·±çš„æ•°æ®ä¼ è¾“é€Ÿç‡ã€‚</p>
<p>ref <a href="https://www.jianshu.com/p/fad3339e3448" target="_blank" rel="noopener">https://www.jianshu.com/p/fad3339e3448</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ğŸ‘¿ linuxå†…æ ¸é‡Œé¢ä¸ºæ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦å»ºç«‹ç¼“å­˜çš„ï¼Œè€Œç”¨æˆ·å±‚ä¹Ÿæœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œé‚£æ ·æ¯æ¬¡readå’Œwriteç­‰ç›¸å…³ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ä½†æœ‰å¯èƒ½ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè€Œä¸”è¿˜è¦ä¸æ–­ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€æˆ–è€…ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ã€‚å¦‚æœæœ‰äº›æ•°æ®ä¸ç”¨ç»è¿‡ç”¨æˆ·å±‚çš„è¯ï¼ˆä¾‹å¦‚ç½‘ç»œä»£ç†æœåŠ¡ï¼‰ï¼Œå¯ä»¥ä¸ç”¨è¿™ç§æ‹·è´æ¥æµªè´¹èµ„æºï¼Œæ‰€ä»¥Linuxçš„ç³»ç»Ÿè°ƒç”¨å°±æœ‰äº†å‡ ä¸ªé›¶æ‹·è´çš„å‡½æ•°æ¥è§£å†³è¿™ç§é—®é¢˜ã€‚ï¼ˆè™½è¯´é›¶æ‹·è´ï¼Œä½†å…¶å®ä¹Ÿåªæ˜¯å‡å°‘äº†ç”¨æˆ·æ€æ‹·è´ï¼ŒæŠŠæ‰€æœ‰æ‹·è´éƒ½åœ¨å†…æ ¸é‡Œé¢å¤„ç†äº†ï¼‰&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;å¼•æ–‡&quot;&gt;&lt;a href=&quot;#å¼•æ–‡&quot; class=&quot;headerlink&quot; title=&quot;å¼•æ–‡&quot;&gt;&lt;/a&gt;å¼•æ–‡&lt;/h1&gt;&lt;p&gt;åœ¨å†™ä¸€ä¸ªæœåŠ¡ç«¯ç¨‹åºæ—¶ï¼ˆWeb Serveræˆ–è€…æ–‡ä»¶æœåŠ¡å™¨ï¼‰ï¼Œæ–‡ä»¶ä¸‹è½½æ˜¯ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½ã€‚è¿™æ—¶å€™æœåŠ¡ç«¯çš„ä»»åŠ¡æ˜¯ï¼š&lt;strong&gt;å°†æœåŠ¡ç«¯ä¸»æœºç£ç›˜ä¸­çš„æ–‡ä»¶ä¸åšä¿®æ”¹åœ°ä»å·²è¿æ¥çš„socketå‘å‡ºå»&lt;/strong&gt;ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨ä¸‹é¢çš„ä»£ç å®Œæˆï¼š&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt;((n = read(diskfd, buf, BUF_SIZE)) &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    write(sockfd, buf , n);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åŸºæœ¬æ“ä½œå°±æ˜¯å¾ªç¯çš„ä»ç£ç›˜è¯»å…¥æ–‡ä»¶å†…å®¹åˆ°ç¼“å†²åŒºï¼Œå†å°†ç¼“å†²åŒºçš„å†…å®¹å‘é€åˆ°socketã€‚ä½†æ˜¯ç”±äºLinuxçš„I/Oæ“ä½œé»˜è®¤æ˜¯ç¼“å†²I/Oã€‚è¿™é‡Œé¢ä¸»è¦ä½¿ç”¨çš„ä¹Ÿå°±æ˜¯readå’Œwriteä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“æ“ä½œç³»ç»Ÿåœ¨å…¶ä¸­åšäº†ä»€ä¹ˆã€‚å®é™…ä¸Šåœ¨ä»¥ä¸ŠI/Oæ“ä½œä¸­ï¼Œå‘ç”Ÿäº†å¤šæ¬¡çš„æ•°æ®æ‹·è´ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="linux" scheme="http://idiotsky.top/categories/linux/"/>
    
    
      <category term="linux" scheme="http://idiotsky.top/tags/linux/"/>
    
      <category term="sendfile" scheme="http://idiotsky.top/tags/sendfile/"/>
    
      <category term="mmap" scheme="http://idiotsky.top/tags/mmap/"/>
    
      <category term="splice" scheme="http://idiotsky.top/tags/splice/"/>
    
  </entry>
  
  <entry>
    <title>linuxçš„é˜»å¡å’Œéé˜»å¡socketçš„åŒºåˆ«</title>
    <link href="http://idiotsky.top/2018/03/12/linux-non-blocking-io/"/>
    <id>http://idiotsky.top/2018/03/12/linux-non-blocking-io/</id>
    <published>2018-03-12T15:44:11.000Z</published>
    <updated>2018-03-13T13:59:01.326Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ‰æåˆ°éé˜»å¡socketï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« å°±çœ‹çœ‹è¿™ä¸ªæ˜¯ä»€ä¹ˆä¸œä¸œğŸ‘¿</p>
</blockquote>
<h1 id="è¯»æ“ä½œ"><a href="#è¯»æ“ä½œ" class="headerlink" title="è¯»æ“ä½œ"></a>è¯»æ“ä½œ</h1><p>å¯¹äºé˜»å¡çš„socket,å½“socketçš„æ¥æ”¶ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œreadè°ƒç”¨ä¼šä¸€ç›´é˜»å¡ä½ï¼Œç›´åˆ°æœ‰æ•°æ®åˆ°æ¥æ‰è¿”å›ã€‚å½“socketç¼“å†²åŒºä¸­çš„æ•°æ®é‡å°äºæœŸæœ›è¯»å–çš„æ•°æ®é‡æ—¶ï¼Œè¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ã€‚å½“socktçš„æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®å¤§äºæœŸæœ›è¯»å–çš„å­—èŠ‚æ•°æ—¶ï¼Œè¯»å–æœŸæœ›è¯»å–çš„å­—èŠ‚æ•°ï¼Œè¿”å›å®é™…è¯»å–çš„é•¿åº¦ã€‚</p>
<p>å¯¹äºéé˜»å¡socketè€Œè¨€ï¼Œsocketçš„æ¥æ”¶ç¼“å†²åŒºä¸­æœ‰æ²¡æœ‰æ•°æ®ï¼Œreadè°ƒç”¨éƒ½ä¼šç«‹åˆ»è¿”å›ã€‚æ¥æ”¶ç¼“å†²åŒºä¸­æœ‰æ•°æ®æ—¶ï¼Œä¸é˜»å¡socketæœ‰æ•°æ®çš„æƒ…å†µæ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœæ¥æ”¶ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™è¿”å›é”™è¯¯å·ä¸ºEWOULDBLOCK,è¡¨ç¤ºè¯¥æ“ä½œæœ¬æ¥åº”è¯¥é˜»å¡çš„ï¼Œä½†æ˜¯ç”±äºæœ¬socketä¸ºéé˜»å¡çš„socketï¼Œå› æ­¤ç«‹åˆ»è¿”å›ï¼Œé‡åˆ°è¿™æ ·çš„æƒ…å†µï¼Œå¯ä»¥åœ¨ä¸‹æ¬¡æ¥ç€å»å°è¯•è¯»å–ã€‚å¦‚æœè¿”å›å€¼æ˜¯å…¶å®ƒè´Ÿå€¼ï¼Œåˆ™è¡¨æ˜è¯»å–é”™è¯¯ã€‚</p>
<p>å› æ­¤ï¼Œéé˜»å¡çš„reaè°ƒç”¨ä¸€èˆ¬è¿™æ ·å†™:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((nread = read(sock_fd, buffer, len)) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span> (errno == EWOULDBLOCK)</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//è¡¨ç¤ºæ²¡æœ‰è¯»åˆ°æ•°æ®</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">   <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">//è¡¨ç¤ºè¯»å–å¤±è´¥</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">   <span class="keyword">return</span> nread;è¯»åˆ°æ•°æ®é•¿åº¦</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<h1 id="å†™æ“ä½œ"><a href="#å†™æ“ä½œ" class="headerlink" title="å†™æ“ä½œ"></a>å†™æ“ä½œ</h1><p>å¯¹äºå†™æ“ä½œwrite,åŸç†æ˜¯ç±»ä¼¼çš„ï¼Œéé˜»å¡socketåœ¨å‘é€ç¼“å†²åŒºæ²¡æœ‰ç©ºé—´æ—¶ä¼šç›´æ¥è¿”å›é”™è¯¯å·EWOULDBLOCK,è¡¨ç¤ºæ²¡æœ‰ç©ºé—´å¯å†™æ•°æ®ï¼Œå¦‚æœé”™è¯¯å·æ˜¯åˆ«çš„å€¼ï¼Œåˆ™è¡¨æ˜å‘é€å¤±è´¥ã€‚å¦‚æœå‘é€ç¼“å†²åŒºä¸­æœ‰è¶³å¤Ÿç©ºé—´æˆ–è€…æ˜¯ä¸è¶³ä»¥æ‹·è´æ‰€æœ‰å¾…å‘é€æ•°æ®çš„ç©ºé—´çš„è¯ï¼Œåˆ™æ‹·è´å‰é¢Nä¸ªèƒ½å¤Ÿå®¹çº³çš„æ•°æ®ï¼Œè¿”å›å®é™…æ‹·è´çš„å­—èŠ‚æ•°ã€‚</p>
<p>è€Œå¯¹äºé˜»å¡Socketè€Œè¨€ï¼Œå¦‚æœå‘é€ç¼“å†²åŒºæ²¡æœ‰ç©ºé—´æˆ–è€…ç©ºé—´ä¸è¶³çš„è¯ï¼Œwriteæ“ä½œä¼šç›´æ¥é˜»å¡ä½ï¼Œå¦‚æœæœ‰è¶³å¤Ÿç©ºé—´ï¼Œåˆ™æ‹·è´æ‰€æœ‰æ•°æ®åˆ°å‘é€ç¼“å†²åŒºï¼Œç„¶åè¿”å›.</p>
<p>éé˜»å¡çš„writeæ“ä½œä¸€èˆ¬å†™æ³•æ˜¯:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> write_pos = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> nLeft = nLen;</span><br><span class="line"><span class="keyword">while</span> (nLeft &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">int</span> nWrite = <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">if</span> ((nWrite = write(sock_fd, data + write_pos, nLeft)) &lt;= <span class="number">0</span>)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">if</span> (errno == EWOULDBLOCK)</span><br><span class="line">  &#123;</span><br><span class="line">    nWrite = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">//è¡¨ç¤ºå†™å¤±è´¥</span></span><br><span class="line"> &#125;</span><br><span class="line"> nLeft -= nWrite;</span><br><span class="line"> write_pos += nWrite;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> nLen;</span><br></pre></td></tr></table></figure></p>
<h1 id="å»ºç«‹è¿æ¥"><a href="#å»ºç«‹è¿æ¥" class="headerlink" title="å»ºç«‹è¿æ¥"></a>å»ºç«‹è¿æ¥</h1><p>é˜»å¡æ–¹å¼ä¸‹ï¼Œconnecté¦–å…ˆå‘é€SYNè¯·æ±‚é“æœåŠ¡å™¨ï¼Œå½“å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„SYNçš„ç¡®è®¤æ—¶ï¼Œåˆ™connectè¿”å›.å¦åˆ™çš„è¯ä¸€ç›´é˜»å¡.</p>
<p>éé˜»å¡æ–¹å¼ï¼Œconnectå°†å¯ç”¨TCPåè®®çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œä½†æ˜¯connectå‡½æ•°å¹¶ä¸ç­‰å¾…è¿æ¥å»ºç«‹å¥½æ‰è¿”å›ï¼Œè€Œæ˜¯ç«‹å³è¿”å›ã€‚è¿”å›çš„é”™è¯¯ç ä¸ºEINPROGRESS,è¡¨ç¤ºæ­£åœ¨è¿›è¡ŒæŸç§è¿‡ç¨‹.</p>
<h1 id="æ¥æ”¶è¿æ¥"><a href="#æ¥æ”¶è¿æ¥" class="headerlink" title="æ¥æ”¶è¿æ¥"></a>æ¥æ”¶è¿æ¥</h1><p>å¯¹äºé˜»å¡æ–¹å¼çš„å€¾å¬socket,acceptåœ¨è¿æ¥é˜Ÿåˆ—ä¸­æ²¡æœ‰å»ºç«‹å¥½çš„è¿æ¥æ—¶å°†é˜»å¡ï¼Œç›´åˆ°æœ‰å¯ç”¨çš„è¿æ¥ï¼Œæ‰è¿”å›ã€‚</p>
<p>éé˜»å¡å€¾å¬socket,åœ¨æœ‰æ²¡æœ‰è¿æ¥æ—¶éƒ½ç«‹å³è¿”å›ï¼Œæ²¡æœ‰è¿æ¥æ—¶ï¼Œè¿”å›çš„é”™è¯¯ç ä¸ºEWOULDBLOCK,è¡¨ç¤ºæœ¬æ¥åº”è¯¥é˜»å¡ã€‚</p>
<h1 id="æ— é˜»å¡çš„è®¾ç½®æ–¹æ³•"><a href="#æ— é˜»å¡çš„è®¾ç½®æ–¹æ³•" class="headerlink" title="æ— é˜»å¡çš„è®¾ç½®æ–¹æ³•"></a>æ— é˜»å¡çš„è®¾ç½®æ–¹æ³•</h1><p>æ–¹æ³•ä¸€:fcntl<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> flag;</span><br><span class="line"><span class="keyword">if</span> (flag = fcntl(fd, F_GETFL, <span class="number">0</span>) &lt;<span class="number">0</span>) perror(<span class="string">"get flag"</span>);</span><br><span class="line">flag |= O_NONBLOCK;</span><br><span class="line"><span class="keyword">if</span> (fcntl(fd, F_SETFL, flag) &lt; <span class="number">0</span>)</span><br><span class="line">perror(<span class="string">"set flag"</span>);</span><br></pre></td></tr></table></figure></p>
<p>æ–¹æ³•äºŒ:ioctl<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int b_on = 1;</span><br><span class="line">ioctl (fd, FIONBIO, &amp;b_on);</span><br></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>éé˜»å¡socketå¯ä»¥é€šè¿‡ä¸æ–­è½®è¯¢æ¥å®ç°ç±»ä¼¼ioå¤ç”¨çš„æ•ˆæœï¼Œä½†æ˜¯ä¸å»ºè®®ï¼Œå› ä¸ºä¼šé€ æˆcpuçš„ç©ºè½¬ï¼ˆå¦‚æœä¸€ç›´æ²¡æ•°æ®è¯»å†™çš„è¯ï¼‰ã€‚æ„Ÿè§‰è·Ÿjavaçš„nioä¸Šè®¾ç½®channelä¸ºéé˜»å¡æœ‰ç‚¹å…³ç³»å§ğŸ‘¿</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æœ‰æåˆ°éé˜»å¡socketï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« å°±çœ‹çœ‹è¿™ä¸ªæ˜¯ä»€ä¹ˆä¸œä¸œğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;è¯»æ“ä½œ&quot;&gt;&lt;a href=&quot;#è¯»æ“ä½œ&quot; class=&quot;headerlink&quot; title=&quot;è¯»æ“ä½œ&quot;&gt;&lt;/a&gt;è¯»æ“ä½œ&lt;/h1&gt;&lt;p&gt;å¯¹äºé˜»å¡çš„socket,å½“socketçš„æ¥æ”¶ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œreadè°ƒç”¨ä¼šä¸€ç›´é˜»å¡ä½ï¼Œç›´åˆ°æœ‰æ•°æ®åˆ°æ¥æ‰è¿”å›ã€‚å½“socketç¼“å†²åŒºä¸­çš„æ•°æ®é‡å°äºæœŸæœ›è¯»å–çš„æ•°æ®é‡æ—¶ï¼Œè¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ã€‚å½“socktçš„æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®å¤§äºæœŸæœ›è¯»å–çš„å­—èŠ‚æ•°æ—¶ï¼Œè¯»å–æœŸæœ›è¯»å–çš„å­—èŠ‚æ•°ï¼Œè¿”å›å®é™…è¯»å–çš„é•¿åº¦ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºéé˜»å¡socketè€Œè¨€ï¼Œsocketçš„æ¥æ”¶ç¼“å†²åŒºä¸­æœ‰æ²¡æœ‰æ•°æ®ï¼Œreadè°ƒç”¨éƒ½ä¼šç«‹åˆ»è¿”å›ã€‚æ¥æ”¶ç¼“å†²åŒºä¸­æœ‰æ•°æ®æ—¶ï¼Œä¸é˜»å¡socketæœ‰æ•°æ®çš„æƒ…å†µæ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœæ¥æ”¶ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™è¿”å›é”™è¯¯å·ä¸ºEWOULDBLOCK,è¡¨ç¤ºè¯¥æ“ä½œæœ¬æ¥åº”è¯¥é˜»å¡çš„ï¼Œä½†æ˜¯ç”±äºæœ¬socketä¸ºéé˜»å¡çš„socketï¼Œå› æ­¤ç«‹åˆ»è¿”å›ï¼Œé‡åˆ°è¿™æ ·çš„æƒ…å†µï¼Œå¯ä»¥åœ¨ä¸‹æ¬¡æ¥ç€å»å°è¯•è¯»å–ã€‚å¦‚æœè¿”å›å€¼æ˜¯å…¶å®ƒè´Ÿå€¼ï¼Œåˆ™è¡¨æ˜è¯»å–é”™è¯¯ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤ï¼Œéé˜»å¡çš„reaè°ƒç”¨ä¸€èˆ¬è¿™æ ·å†™:&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((nread = read(sock_fd, buffer, len)) &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (errno == EWOULDBLOCK)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;//è¡¨ç¤ºæ²¡æœ‰è¯»åˆ°æ•°æ®&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;; &lt;span class=&quot;comment&quot;&gt;//è¡¨ç¤ºè¯»å–å¤±è´¥&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; nread;è¯»åˆ°æ•°æ®é•¿åº¦&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="linux" scheme="http://idiotsky.top/categories/linux/"/>
    
    
      <category term="linux" scheme="http://idiotsky.top/tags/linux/"/>
    
      <category term="nio" scheme="http://idiotsky.top/tags/nio/"/>
    
      <category term="éé˜»å¡socket" scheme="http://idiotsky.top/tags/%E9%9D%9E%E9%98%BB%E5%A1%9Esocket/"/>
    
      <category term="é˜»å¡socket" scheme="http://idiotsky.top/tags/%E9%98%BB%E5%A1%9Esocket/"/>
    
  </entry>
  
  <entry>
    <title>linux epollé€šä¿—ç†è§£</title>
    <link href="http://idiotsky.top/2018/03/12/epoll-easy-understanding/"/>
    <id>http://idiotsky.top/2018/03/12/epoll-easy-understanding/</id>
    <published>2018-03-12T14:39:46.000Z</published>
    <updated>2018-03-12T15:43:50.651Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ä¸€ä¸ªepollé€šä¿—ç®€å•ç†è§£çš„æ–‡ç« ï¼ŒmarkğŸ‘¿</p>
</blockquote>
<p>é¦–å…ˆæˆ‘ä»¬æ¥å®šä¹‰æµçš„æ¦‚å¿µï¼Œä¸€ä¸ªæµå¯ä»¥æ˜¯æ–‡ä»¶ï¼Œsocketï¼Œpipeç­‰ç­‰å¯ä»¥è¿›è¡ŒI/Oæ“ä½œçš„å†…æ ¸å¯¹è±¡ã€‚<br>ä¸ç®¡æ˜¯æ–‡ä»¶ï¼Œè¿˜æ˜¯å¥—æ¥å­—ï¼Œè¿˜æ˜¯ç®¡é“ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æŠŠä»–ä»¬çœ‹ä½œæµã€‚<br>ä¹‹åæˆ‘ä»¬æ¥è®¨è®ºI/Oçš„æ“ä½œï¼Œé€šè¿‡readï¼Œæˆ‘ä»¬å¯ä»¥ä»æµä¸­è¯»å…¥æ•°æ®ï¼›é€šè¿‡writeï¼Œæˆ‘ä»¬å¯ä»¥å¾€æµå†™å…¥æ•°æ®ã€‚ç°åœ¨å‡å®šä¸€ä¸ªæƒ…å½¢ï¼Œæˆ‘ä»¬éœ€è¦ä»æµä¸­è¯»æ•°æ®ï¼Œä½†æ˜¯æµä¸­è¿˜æ²¡æœ‰æ•°æ®ï¼Œï¼ˆå…¸å‹çš„ä¾‹å­ä¸ºï¼Œå®¢æˆ·ç«¯è¦ä»socketè¯»å¦‚æ•°æ®ï¼Œä½†æ˜¯æœåŠ¡å™¨è¿˜æ²¡æœ‰æŠŠæ•°æ®ä¼ å›æ¥ï¼‰ï¼Œè¿™æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<ul>
<li>é˜»å¡ã€‚é˜»å¡æ˜¯ä¸ªä»€ä¹ˆæ¦‚å¿µå‘¢ï¼Ÿæ¯”å¦‚æŸä¸ªæ—¶å€™ä½ åœ¨ç­‰å¿«é€’ï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“å¿«é€’ä»€ä¹ˆæ—¶å€™è¿‡æ¥ï¼Œè€Œä¸”ä½ æ²¡æœ‰åˆ«çš„äº‹å¯ä»¥å¹²ï¼ˆæˆ–è€…è¯´æ¥ä¸‹æ¥çš„äº‹è¦ç­‰å¿«é€’æ¥äº†æ‰èƒ½åšï¼‰ï¼›é‚£ä¹ˆä½ å¯ä»¥å»ç¡è§‰äº†ï¼Œå› ä¸ºä½ çŸ¥é“å¿«é€’æŠŠè´§é€æ¥æ—¶ä¸€å®šä¼šç»™ä½ æ‰“ä¸ªç”µè¯ï¼ˆå‡å®šä¸€å®šèƒ½å«é†’ä½ ï¼‰ã€‚</li>
<li>éé˜»å¡å¿™è½®è¯¢ã€‚æ¥ç€ä¸Šé¢ç­‰å¿«é€’çš„ä¾‹å­ï¼Œå¦‚æœç”¨å¿™è½®è¯¢çš„æ–¹æ³•ï¼Œé‚£ä¹ˆä½ éœ€è¦çŸ¥é“å¿«é€’å‘˜çš„æ‰‹æœºå·ï¼Œç„¶åæ¯åˆ†é’Ÿç»™ä»–æŒ‚ä¸ªç”µè¯ï¼šâ€œä½ åˆ°äº†æ²¡ï¼Ÿâ€</li>
</ul>
<a id="more"></a>
<p>å¾ˆæ˜æ˜¾ä¸€èˆ¬äººä¸ä¼šç”¨ç¬¬äºŒç§åšæ³•ï¼Œä¸ä»…æ˜¾å¾ˆæ— è„‘ï¼Œæµªè´¹è¯è´¹ä¸è¯´ï¼Œè¿˜å ç”¨äº†å¿«é€’å‘˜å¤§é‡çš„æ—¶é—´ã€‚<br>å¤§éƒ¨åˆ†ç¨‹åºä¹Ÿä¸ä¼šç”¨ç¬¬äºŒç§åšæ³•ï¼Œå› ä¸ºç¬¬ä¸€ç§æ–¹æ³•ç»æµè€Œç®€å•ï¼Œç»æµæ˜¯æŒ‡æ¶ˆè€—å¾ˆå°‘çš„CPUæ—¶é—´ï¼Œå¦‚æœçº¿ç¨‹ç¡çœ äº†ï¼Œå°±æ‰å‡ºäº†ç³»ç»Ÿçš„è°ƒåº¦é˜Ÿåˆ—ï¼Œæš‚æ—¶ä¸ä¼šå»ç“œåˆ†CPUå®è´µçš„æ—¶é—´ç‰‡äº†ã€‚</p>
<p>ä¸ºäº†äº†è§£é˜»å¡æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Œæˆ‘ä»¬æ¥è®¨è®ºç¼“å†²åŒºï¼Œä»¥åŠå†…æ ¸ç¼“å†²åŒºï¼Œæœ€ç»ˆæŠŠI/Oäº‹ä»¶è§£é‡Šæ¸…æ¥šã€‚ç¼“å†²åŒºçš„å¼•å…¥æ˜¯ä¸ºäº†å‡å°‘é¢‘ç¹I/Oæ“ä½œè€Œå¼•èµ·é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆä½ çŸ¥é“å®ƒå¾ˆæ…¢çš„ï¼‰ï¼Œå½“ä½ æ“ä½œä¸€ä¸ªæµæ—¶ï¼Œæ›´å¤šçš„æ˜¯ä»¥ç¼“å†²åŒºä¸ºå•ä½è¿›è¡Œæ“ä½œï¼Œè¿™æ˜¯ç›¸å¯¹äºç”¨æˆ·ç©ºé—´è€Œè¨€ã€‚å¯¹äºå†…æ ¸æ¥è¯´ï¼Œä¹Ÿéœ€è¦ç¼“å†²åŒºã€‚<br>å‡è®¾æœ‰ä¸€ä¸ªç®¡é“ï¼Œè¿›ç¨‹Aä¸ºç®¡é“çš„å†™å…¥æ–¹ï¼Œï¼¢ä¸ºç®¡é“çš„è¯»å‡ºæ–¹ã€‚</p>
<ol>
<li>å‡è®¾ä¸€å¼€å§‹å†…æ ¸ç¼“å†²åŒºæ˜¯ç©ºçš„ï¼ŒBä½œä¸ºè¯»å‡ºæ–¹ï¼Œè¢«é˜»å¡ç€ã€‚ç„¶åé¦–å…ˆAå¾€ç®¡é“å†™å…¥ï¼Œè¿™æ—¶å€™å†…æ ¸ç¼“å†²åŒºç”±ç©ºçš„çŠ¶æ€å˜åˆ°éç©ºçŠ¶æ€ï¼Œå†…æ ¸å°±ä¼šäº§ç”Ÿä¸€ä¸ªäº‹ä»¶å‘Šè¯‰ï¼¢è¯¥é†’æ¥äº†ï¼Œè¿™ä¸ªäº‹ä»¶å§‘ä¸”ç§°ä¹‹ä¸ºâ€œç¼“å†²åŒºéç©ºâ€ã€‚</li>
<li>ä½†æ˜¯â€œç¼“å†²åŒºéç©ºâ€äº‹ä»¶é€šçŸ¥Båï¼ŒBå´è¿˜æ²¡æœ‰è¯»å‡ºæ•°æ®ï¼›ä¸”å†…æ ¸è®¸è¯ºäº†ä¸èƒ½æŠŠå†™å…¥ç®¡é“ä¸­çš„æ•°æ®ä¸¢æ‰è¿™ä¸ªæ—¶å€™ï¼Œï¼¡å†™å…¥çš„æ•°æ®ä¼šæ»ç•™åœ¨å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œå¦‚æœå†…æ ¸ä¹Ÿç¼“å†²åŒºæ»¡äº†ï¼ŒBä»æœªå¼€å§‹è¯»æ•°æ®ï¼Œæœ€ç»ˆå†…æ ¸ç¼“å†²åŒºä¼šè¢«å¡«æ»¡ï¼Œè¿™ä¸ªæ—¶å€™ä¼šäº§ç”Ÿä¸€ä¸ªI/Oäº‹ä»¶ï¼Œå‘Šè¯‰è¿›ç¨‹Aï¼Œä½ è¯¥ç­‰ç­‰ï¼ˆé˜»å¡ï¼‰äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªäº‹ä»¶å®šä¹‰ä¸ºâ€œç¼“å†²åŒºæ»¡â€ã€‚</li>
<li>å‡è®¾åæ¥ï¼¢ç»ˆäºå¼€å§‹è¯»æ•°æ®äº†ï¼Œäºæ˜¯å†…æ ¸çš„ç¼“å†²åŒºç©ºäº†å‡ºæ¥ï¼Œè¿™æ—¶å€™å†…æ ¸ä¼šå‘Šè¯‰Aï¼Œå†…æ ¸ç¼“å†²åŒºæœ‰ç©ºä½äº†ï¼Œä½ å¯ä»¥ä»é•¿çœ ä¸­é†’æ¥äº†ï¼Œç»§ç»­å†™æ•°æ®äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªäº‹ä»¶å«åšâ€œç¼“å†²åŒºéæ»¡â€</li>
<li>ä¹Ÿè®¸åƒ3é‚£æ ·å·²ç»é€šçŸ¥äº†Aï¼Œä½†æ˜¯Aä¹Ÿæ²¡æœ‰æ•°æ®å†™å…¥äº†ï¼Œè€Œï¼¢ç»§ç»­è¯»å‡ºæ•°æ®ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºç©ºäº†ã€‚è¿™ä¸ªæ—¶å€™å†…æ ¸å°±å‘Šè¯‰Bï¼Œä½ éœ€è¦é˜»å¡äº†ï¼ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ—¶é—´å®šä¸ºâ€œç¼“å†²åŒºç©ºâ€ã€‚</li>
</ol>
<p>è¿™å››ä¸ªæƒ…å½¢æ¶µç›–äº†å››ä¸ªI/Oäº‹ä»¶ï¼Œç¼“å†²åŒºæ»¡ï¼Œç¼“å†²åŒºç©ºï¼Œç¼“å†²åŒºéç©ºï¼Œç¼“å†²åŒºéæ»¡ï¼ˆæ³¨éƒ½æ˜¯è¯´çš„å†…æ ¸ç¼“å†²åŒºï¼Œä¸”è¿™å››ä¸ªæœ¯è¯­éƒ½æ˜¯æˆ‘ç”Ÿé€ çš„ï¼Œä»…ä¸ºè§£é‡Šå…¶åŸç†è€Œé€ ï¼‰ã€‚è¿™å››ä¸ªI/Oäº‹ä»¶æ˜¯è¿›è¡Œé˜»å¡åŒæ­¥çš„æ ¹æœ¬ã€‚ï¼ˆå¦‚æœä¸èƒ½ç†è§£â€œåŒæ­¥â€æ˜¯ä»€ä¹ˆæ¦‚å¿µï¼Œè¯·å­¦ä¹ æ“ä½œç³»ç»Ÿçš„é”ï¼Œä¿¡å·é‡ï¼Œæ¡ä»¶å˜é‡ç­‰ä»»åŠ¡åŒæ­¥æ–¹é¢çš„ç›¸å…³çŸ¥è¯†ï¼‰ã€‚</p>
<p>ç„¶åæˆ‘ä»¬æ¥è¯´è¯´é˜»å¡I/Oçš„ç¼ºç‚¹ã€‚ä½†æ˜¯é˜»å¡I/Oæ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªæµçš„I/Oäº‹ä»¶ã€‚å¦‚æœæƒ³è¦åŒæ—¶å¤„ç†å¤šä¸ªæµï¼Œè¦ä¹ˆå¤šè¿›ç¨‹(fork)ï¼Œè¦ä¹ˆå¤šçº¿ç¨‹(pthread_create)ï¼Œå¾ˆä¸å¹¸è¿™ä¸¤ç§æ–¹æ³•æ•ˆç‡éƒ½ä¸é«˜ã€‚<br>äºæ˜¯å†æ¥è€ƒè™‘éé˜»å¡å¿™è½®è¯¢çš„I/Oæ–¹å¼ï¼Œæˆ‘ä»¬å‘ç°æˆ‘ä»¬å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªæµäº†ï¼ˆæŠŠä¸€ä¸ªæµä»é˜»å¡æ¨¡å¼åˆ‡æ¢åˆ°éé˜»å¡æ¨¡å¼å†æ­¤ä¸äºˆè®¨è®ºï¼‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while true &#123;</span><br><span class="line">for i in stream[]; &#123;</span><br><span class="line">if i has data</span><br><span class="line">read until unavailable</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬åªè¦ä¸åœçš„æŠŠæ‰€æœ‰æµä»å¤´åˆ°å°¾é—®ä¸€éï¼Œåˆä»å¤´å¼€å§‹ã€‚è¿™æ ·å°±å¯ä»¥å¤„ç†å¤šä¸ªæµäº†ï¼Œä½†è¿™æ ·çš„åšæ³•æ˜¾ç„¶ä¸å¥½ï¼Œå› ä¸ºå¦‚æœæ‰€æœ‰çš„æµéƒ½æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆåªä¼šç™½ç™½æµªè´¹CPUã€‚è¿™é‡Œè¦è¡¥å……ä¸€ç‚¹ï¼Œé˜»å¡æ¨¡å¼ä¸‹ï¼Œå†…æ ¸å¯¹äºI/Oäº‹ä»¶çš„å¤„ç†æ˜¯é˜»å¡æˆ–è€…å”¤é†’ï¼Œè€Œéé˜»å¡æ¨¡å¼ä¸‹åˆ™æŠŠI/Oäº‹ä»¶äº¤ç»™å…¶ä»–å¯¹è±¡ï¼ˆåæ–‡ä»‹ç»çš„selectä»¥åŠepollï¼‰å¤„ç†ç”šè‡³ç›´æ¥å¿½ç•¥ã€‚</p>
<p>ä¸ºäº†é¿å…CPUç©ºè½¬ï¼Œå¯ä»¥å¼•è¿›äº†ä¸€ä¸ªä»£ç†ï¼ˆä¸€å¼€å§‹æœ‰ä¸€ä½å«åšselectçš„ä»£ç†ï¼Œåæ¥åˆæœ‰ä¸€ä½å«åšpollçš„ä»£ç†ï¼Œä¸è¿‡ä¸¤è€…çš„æœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼‰ã€‚è¿™ä¸ªä»£ç†æ¯”è¾ƒå‰å®³ï¼Œå¯ä»¥åŒæ—¶è§‚å¯Ÿè®¸å¤šæµçš„I/Oäº‹ä»¶ï¼Œåœ¨ç©ºé—²çš„æ—¶å€™ï¼Œä¼šæŠŠå½“å‰çº¿ç¨‹é˜»å¡æ‰ï¼Œå½“æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæµæœ‰I/Oäº‹ä»¶æ—¶ï¼Œå°±ä»é˜»å¡æ€ä¸­é†’æ¥ï¼Œäºæ˜¯æˆ‘ä»¬çš„ç¨‹åºå°±ä¼šè½®è¯¢ä¸€éæ‰€æœ‰çš„æµï¼ˆäºæ˜¯æˆ‘ä»¬å¯ä»¥æŠŠâ€œå¿™â€å­—å»æ‰äº†ï¼‰ã€‚ä»£ç é•¿è¿™æ ·:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">while true &#123;</span><br><span class="line">select(streams[])</span><br><span class="line">for i in streams[] &#123;</span><br><span class="line">if i has data</span><br><span class="line">read until unavailable</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>äºæ˜¯ï¼Œå¦‚æœæ²¡æœ‰I/Oäº‹ä»¶äº§ç”Ÿï¼Œæˆ‘ä»¬çš„ç¨‹åºå°±ä¼šé˜»å¡åœ¨selectå¤„ã€‚ä½†æ˜¯ä¾ç„¶æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä»selecté‚£é‡Œä»…ä»…çŸ¥é“äº†ï¼Œæœ‰I/Oäº‹ä»¶å‘ç”Ÿäº†ï¼Œä½†å´å¹¶ä¸çŸ¥é“æ˜¯é‚£å‡ ä¸ªæµï¼ˆå¯èƒ½æœ‰ä¸€ä¸ªï¼Œå¤šä¸ªï¼Œç”šè‡³å…¨éƒ¨ï¼‰ï¼Œæˆ‘ä»¬åªèƒ½æ— å·®åˆ«è½®è¯¢æ‰€æœ‰æµï¼Œæ‰¾å‡ºèƒ½è¯»å‡ºæ•°æ®ï¼Œæˆ–è€…å†™å…¥æ•°æ®çš„æµï¼Œå¯¹ä»–ä»¬è¿›è¡Œæ“ä½œã€‚<br>ä½†æ˜¯ä½¿ç”¨selectï¼Œæˆ‘ä»¬æœ‰O(n)çš„æ— å·®åˆ«è½®è¯¢å¤æ‚åº¦ï¼ŒåŒæ—¶å¤„ç†çš„æµè¶Šå¤šï¼Œæ¯ä¸€æ¬¡æ— å·®åˆ«è½®è¯¢æ—¶é—´å°±è¶Šé•¿ã€‚å†æ¬¡</p>
<p><strong>è¯´äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºèƒ½å¥½å¥½è§£é‡Šepolläº†</strong></p>
<p>epollå¯ä»¥ç†è§£ä¸ºevent pollï¼Œä¸åŒäºå¿™è½®è¯¢å’Œæ— å·®åˆ«è½®è¯¢ï¼Œepollä¹‹ä¼šæŠŠå“ªä¸ªæµå‘ç”Ÿäº†æ€æ ·çš„I/Oäº‹ä»¶é€šçŸ¥æˆ‘ä»¬ã€‚æ­¤æ—¶æˆ‘ä»¬å¯¹è¿™äº›æµçš„æ“ä½œéƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚ï¼ˆå¤æ‚åº¦é™ä½åˆ°äº†O(k)ï¼Œkä¸ºäº§ç”ŸI/Oäº‹ä»¶çš„æµçš„ä¸ªæ•°)<br>åœ¨è®¨è®ºepollçš„å®ç°ç»†èŠ‚ä¹‹å‰ï¼Œå…ˆæŠŠepollçš„ç›¸å…³æ“ä½œåˆ—å‡ºï¼š<br>epoll_create åˆ›å»ºä¸€ä¸ªepollå¯¹è±¡ï¼Œä¸€èˆ¬epollfd = epoll_create()<br>epoll_ctl ï¼ˆepoll_add/epoll_delçš„åˆä½“ï¼‰ï¼Œå¾€epollå¯¹è±¡ä¸­å¢åŠ /åˆ é™¤æŸä¸€ä¸ªæµçš„æŸä¸€ä¸ªäº‹ä»¶<br>æ¯”å¦‚<br>epoll_ctl(epollfd, EPOLL_CTL_ADD, socket, EPOLLIN);//æœ‰ç¼“å†²åŒºå†…æœ‰æ•°æ®æ—¶epoll_waitè¿”å›<br>epoll_ctl(epollfd, EPOLL_CTL_ADD, socket, EPOLLOUT);//ç¼“å†²åŒºå¯å†™å…¥æ—¶epoll_waitè¿”å›<br>epoll_wait(epollfd,â€¦)ç­‰å¾…ç›´åˆ°æ³¨å†Œçš„äº‹ä»¶å‘ç”Ÿ<br>ï¼ˆæ³¨ï¼šå½“å¯¹ä¸€ä¸ªéé˜»å¡æµçš„è¯»å†™å‘ç”Ÿç¼“å†²åŒºæ»¡æˆ–ç¼“å†²åŒºç©ºï¼Œwrite/readä¼šè¿”å›-1ï¼Œå¹¶è®¾ç½®errno=EAGAINã€‚è€Œepollåªå…³å¿ƒç¼“å†²åŒºéæ»¡å’Œç¼“å†²åŒºéç©ºäº‹ä»¶ï¼‰ã€‚<br>ä¸€ä¸ªepollæ¨¡å¼çš„ä»£ç å¤§æ¦‚çš„æ ·å­æ˜¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while true &#123;</span><br><span class="line">active_stream[] = epoll_wait(epollfd)</span><br><span class="line">for i in active_stream[] &#123;</span><br><span class="line">read or write till unavailable</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é™äºç¯‡å¹…ï¼Œæˆ‘åªè¯´è¿™ä¹ˆå¤šï¼Œä»¥æ­ç¤ºåŸç†æ€§çš„ä¸œè¥¿ï¼Œè‡³äºepollçš„ä½¿ç”¨ç»†èŠ‚ï¼Œè¯·å‚è€ƒmanå’Œgoogleï¼Œå®ç°ç»†èŠ‚ï¼Œè¯·å‚é˜…linux kernel sourceã€‚</p>
<p>ref <a href="https://www.zhihu.com/question/20122137" target="_blank" rel="noopener">https://www.zhihu.com/question/20122137</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¸€ä¸ªepollé€šä¿—ç®€å•ç†è§£çš„æ–‡ç« ï¼ŒmarkğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;é¦–å…ˆæˆ‘ä»¬æ¥å®šä¹‰æµçš„æ¦‚å¿µï¼Œä¸€ä¸ªæµå¯ä»¥æ˜¯æ–‡ä»¶ï¼Œsocketï¼Œpipeç­‰ç­‰å¯ä»¥è¿›è¡ŒI/Oæ“ä½œçš„å†…æ ¸å¯¹è±¡ã€‚&lt;br&gt;ä¸ç®¡æ˜¯æ–‡ä»¶ï¼Œè¿˜æ˜¯å¥—æ¥å­—ï¼Œè¿˜æ˜¯ç®¡é“ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æŠŠä»–ä»¬çœ‹ä½œæµã€‚&lt;br&gt;ä¹‹åæˆ‘ä»¬æ¥è®¨è®ºI/Oçš„æ“ä½œï¼Œé€šè¿‡readï¼Œæˆ‘ä»¬å¯ä»¥ä»æµä¸­è¯»å…¥æ•°æ®ï¼›é€šè¿‡writeï¼Œæˆ‘ä»¬å¯ä»¥å¾€æµå†™å…¥æ•°æ®ã€‚ç°åœ¨å‡å®šä¸€ä¸ªæƒ…å½¢ï¼Œæˆ‘ä»¬éœ€è¦ä»æµä¸­è¯»æ•°æ®ï¼Œä½†æ˜¯æµä¸­è¿˜æ²¡æœ‰æ•°æ®ï¼Œï¼ˆå…¸å‹çš„ä¾‹å­ä¸ºï¼Œå®¢æˆ·ç«¯è¦ä»socketè¯»å¦‚æ•°æ®ï¼Œä½†æ˜¯æœåŠ¡å™¨è¿˜æ²¡æœ‰æŠŠæ•°æ®ä¼ å›æ¥ï¼‰ï¼Œè¿™æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é˜»å¡ã€‚é˜»å¡æ˜¯ä¸ªä»€ä¹ˆæ¦‚å¿µå‘¢ï¼Ÿæ¯”å¦‚æŸä¸ªæ—¶å€™ä½ åœ¨ç­‰å¿«é€’ï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“å¿«é€’ä»€ä¹ˆæ—¶å€™è¿‡æ¥ï¼Œè€Œä¸”ä½ æ²¡æœ‰åˆ«çš„äº‹å¯ä»¥å¹²ï¼ˆæˆ–è€…è¯´æ¥ä¸‹æ¥çš„äº‹è¦ç­‰å¿«é€’æ¥äº†æ‰èƒ½åšï¼‰ï¼›é‚£ä¹ˆä½ å¯ä»¥å»ç¡è§‰äº†ï¼Œå› ä¸ºä½ çŸ¥é“å¿«é€’æŠŠè´§é€æ¥æ—¶ä¸€å®šä¼šç»™ä½ æ‰“ä¸ªç”µè¯ï¼ˆå‡å®šä¸€å®šèƒ½å«é†’ä½ ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;éé˜»å¡å¿™è½®è¯¢ã€‚æ¥ç€ä¸Šé¢ç­‰å¿«é€’çš„ä¾‹å­ï¼Œå¦‚æœç”¨å¿™è½®è¯¢çš„æ–¹æ³•ï¼Œé‚£ä¹ˆä½ éœ€è¦çŸ¥é“å¿«é€’å‘˜çš„æ‰‹æœºå·ï¼Œç„¶åæ¯åˆ†é’Ÿç»™ä»–æŒ‚ä¸ªç”µè¯ï¼šâ€œä½ åˆ°äº†æ²¡ï¼Ÿâ€&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="linux" scheme="http://idiotsky.top/categories/linux/"/>
    
    
      <category term="linux" scheme="http://idiotsky.top/tags/linux/"/>
    
      <category term="nio" scheme="http://idiotsky.top/tags/nio/"/>
    
      <category term="epoll" scheme="http://idiotsky.top/tags/epoll/"/>
    
      <category term="select" scheme="http://idiotsky.top/tags/select/"/>
    
  </entry>
  
  <entry>
    <title>MySQLç´¢å¼•èƒŒåçš„æ•°æ®ç»“æ„åŠç®—æ³•åŸç†</title>
    <link href="http://idiotsky.top/2018/03/04/b-tree/"/>
    <id>http://idiotsky.top/2018/03/04/b-tree/</id>
    <published>2018-03-04T14:23:29.000Z</published>
    <updated>2018-07-17T11:39:16.532Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è½¬ä¸€ä¸ªä¸é”™çš„æ–‡ç« ï¼Œé‡Œé¢çš„å¹²è´§è¿˜æ˜¯å¾ˆå¤šçš„ï¼ŒåŒ…æ‹¬å±€éƒ¨æ€§ï¼Œç¡¬ç›˜ç­‰æ•°æ®åº“ä»¥å¤–çš„ä¸œè¥¿ï¼ŒMarkä¹‹ğŸ‘¿</p>
</blockquote>
<h1 id="æ•°æ®ç»“æ„åŠç®—æ³•åŸºç¡€"><a href="#æ•°æ®ç»“æ„åŠç®—æ³•åŸºç¡€" class="headerlink" title="æ•°æ®ç»“æ„åŠç®—æ³•åŸºç¡€"></a>æ•°æ®ç»“æ„åŠç®—æ³•åŸºç¡€</h1><h2 id="ç´¢å¼•çš„æœ¬è´¨"><a href="#ç´¢å¼•çš„æœ¬è´¨" class="headerlink" title="ç´¢å¼•çš„æœ¬è´¨"></a>ç´¢å¼•çš„æœ¬è´¨</h2><p>MySQLå®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•ï¼ˆIndexï¼‰æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ã€‚æå–å¥å­ä¸»å¹²ï¼Œå°±å¯ä»¥å¾—åˆ°ç´¢å¼•çš„æœ¬è´¨ï¼šç´¢å¼•æ˜¯æ•°æ®ç»“æ„ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ•°æ®åº“æŸ¥è¯¢æ˜¯æ•°æ®åº“çš„æœ€ä¸»è¦åŠŸèƒ½ä¹‹ä¸€ã€‚æˆ‘ä»¬éƒ½å¸Œæœ›æŸ¥è¯¢æ•°æ®çš„é€Ÿåº¦èƒ½å°½å¯èƒ½çš„å¿«ï¼Œå› æ­¤æ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡è€…ä¼šä»æŸ¥è¯¢ç®—æ³•çš„è§’åº¦è¿›è¡Œä¼˜åŒ–ã€‚æœ€åŸºæœ¬çš„æŸ¥è¯¢ç®—æ³•å½“ç„¶æ˜¯<a href="http://en.wikipedia.org/wiki/Linear_search" target="_blank" rel="noopener">é¡ºåºæŸ¥æ‰¾</a>ï¼ˆlinear searchï¼‰ï¼Œè¿™ç§å¤æ‚åº¦ä¸ºO(n)çš„ç®—æ³•åœ¨æ•°æ®é‡å¾ˆå¤§æ—¶æ˜¾ç„¶æ˜¯ç³Ÿç³•çš„ï¼Œå¥½åœ¨è®¡ç®—æœºç§‘å­¦çš„å‘å±•æä¾›äº†å¾ˆå¤šæ›´ä¼˜ç§€çš„æŸ¥æ‰¾ç®—æ³•ï¼Œä¾‹å¦‚<a href="http://en.wikipedia.org/wiki/Binary_search_algorithm" target="_blank" rel="noopener">äºŒåˆ†æŸ¥æ‰¾</a>ï¼ˆbinary searchï¼‰ã€<a href="http://en.wikipedia.org/wiki/Binary_search_tree" target="_blank" rel="noopener">äºŒå‰æ ‘æŸ¥æ‰¾æ ‘</a>ï¼ˆbinary tree searchï¼‰ç­‰ã€‚å¦‚æœç¨å¾®åˆ†æä¸€ä¸‹ä¼šå‘ç°ï¼Œæ¯ç§æŸ¥æ‰¾ç®—æ³•éƒ½åªèƒ½åº”ç”¨äºç‰¹å®šçš„æ•°æ®ç»“æ„ä¹‹ä¸Šï¼Œä¾‹å¦‚äºŒåˆ†æŸ¥æ‰¾è¦æ±‚è¢«æ£€ç´¢æ•°æ®æœ‰åºï¼Œè€ŒäºŒå‰æ ‘æŸ¥æ‰¾åªèƒ½åº”ç”¨äº<a href="http://en.wikipedia.org/wiki/Binary_search_tree" target="_blank" rel="noopener">äºŒå‰æŸ¥æ‰¾æ ‘</a>ä¸Šï¼Œä½†æ˜¯æ•°æ®æœ¬èº«çš„ç»„ç»‡ç»“æ„ä¸å¯èƒ½å®Œå…¨æ»¡è¶³å„ç§æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚ï¼Œç†è®ºä¸Šä¸å¯èƒ½åŒæ—¶å°†ä¸¤åˆ—éƒ½æŒ‰é¡ºåºè¿›è¡Œç»„ç»‡ï¼‰ï¼Œæ‰€ä»¥ï¼Œåœ¨æ•°æ®ä¹‹å¤–ï¼Œæ•°æ®åº“ç³»ç»Ÿè¿˜ç»´æŠ¤ç€æ»¡è¶³ç‰¹å®šæŸ¥æ‰¾ç®—æ³•çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼å¼•ç”¨ï¼ˆæŒ‡å‘ï¼‰æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„ä¸Šå®ç°é«˜çº§æŸ¥æ‰¾ç®—æ³•ã€‚è¿™ç§æ•°æ®ç»“æ„ï¼Œå°±æ˜¯ç´¢å¼•ã€‚</p>
<p>çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<p><a href="http://idiotsky.top/images2/b-tree-1.png"><img src="http://idiotsky.top/images2/b-tree-1.png" alt=""></a></p>
<a id="more"></a>
<p>ä¸Šå›¾å±•ç¤ºäº†ä¸€ç§å¯èƒ½çš„ç´¢å¼•æ–¹å¼ã€‚å·¦è¾¹æ˜¯æ•°æ®è¡¨ï¼Œä¸€å…±æœ‰ä¸¤åˆ—ä¸ƒæ¡è®°å½•ï¼Œæœ€å·¦è¾¹çš„æ˜¯æ•°æ®è®°å½•çš„ç‰©ç†åœ°å€ï¼ˆæ³¨æ„é€»è¾‘ä¸Šç›¸é‚»çš„è®°å½•åœ¨ç£ç›˜ä¸Šä¹Ÿå¹¶ä¸æ˜¯ä¸€å®šç‰©ç†ç›¸é‚»çš„ï¼‰ã€‚ä¸ºäº†åŠ å¿«Col2çš„æŸ¥æ‰¾ï¼Œå¯ä»¥ç»´æŠ¤ä¸€ä¸ªå³è¾¹æ‰€ç¤ºçš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†åˆ«åŒ…å«ç´¢å¼•é”®å€¼å’Œä¸€ä¸ªæŒ‡å‘å¯¹åº”æ•°æ®è®°å½•ç‰©ç†åœ°å€çš„æŒ‡é’ˆï¼Œè¿™æ ·å°±å¯ä»¥è¿ç”¨äºŒå‰æŸ¥æ‰¾åœ¨O(log2n)<br>çš„å¤æ‚åº¦å†…è·å–åˆ°ç›¸åº”æ•°æ®ã€‚</p>
<p>è™½ç„¶è¿™æ˜¯ä¸€ä¸ªè´§çœŸä»·å®çš„ç´¢å¼•ï¼Œä½†æ˜¯å®é™…çš„æ•°æ®åº“ç³»ç»Ÿå‡ ä¹æ²¡æœ‰ä½¿ç”¨äºŒå‰æŸ¥æ‰¾æ ‘æˆ–å…¶è¿›åŒ–å“ç§<a href="http://en.wikipedia.org/wiki/Red-black_tree" target="_blank" rel="noopener">çº¢é»‘æ ‘</a>ï¼ˆred-black treeï¼‰å®ç°çš„ï¼ŒåŸå› ä¼šåœ¨ä¸‹æ–‡ä»‹ç»ã€‚</p>
<h2 id="B-Treeå’ŒB-Tree"><a href="#B-Treeå’ŒB-Tree" class="headerlink" title="B-Treeå’ŒB+Tree"></a>B-Treeå’ŒB+Tree</h2><p>ç›®å‰å¤§éƒ¨åˆ†æ•°æ®åº“ç³»ç»ŸåŠæ–‡ä»¶ç³»ç»Ÿéƒ½é‡‡ç”¨B-Treeæˆ–å…¶å˜ç§B+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œåœ¨æœ¬æ–‡çš„ä¸‹ä¸€èŠ‚ä¼šç»“åˆå­˜å‚¨å™¨åŸç†åŠè®¡ç®—æœºå­˜å–åŸç†è®¨è®ºä¸ºä»€ä¹ˆB-Treeå’ŒB+Treeåœ¨è¢«å¦‚æ­¤å¹¿æ³›ç”¨äºç´¢å¼•ï¼Œè¿™ä¸€èŠ‚å…ˆå•çº¯ä»æ•°æ®ç»“æ„è§’åº¦æè¿°å®ƒä»¬ã€‚</p>
<h3 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B-Tree"></a>B-Tree</h3><p>ä¸ºäº†æè¿°B-Treeï¼Œé¦–å…ˆå®šä¹‰ä¸€æ¡æ•°æ®è®°å½•ä¸ºä¸€ä¸ªäºŒå…ƒç»„[key, data]ï¼Œkeyä¸ºè®°å½•çš„é”®å€¼ï¼Œå¯¹äºä¸åŒæ•°æ®è®°å½•ï¼Œkeyæ˜¯äº’ä¸ç›¸åŒçš„ï¼›dataä¸ºæ•°æ®è®°å½•é™¤keyå¤–çš„æ•°æ®ã€‚é‚£ä¹ˆB-Treeæ˜¯æ»¡è¶³ä¸‹åˆ—æ¡ä»¶çš„æ•°æ®ç»“æ„ï¼š</p>
<p>dä¸ºå¤§äº1çš„ä¸€ä¸ªæ­£æ•´æ•°ï¼Œç§°ä¸ºB-Treeçš„åº¦ã€‚</p>
<p>hä¸ºä¸€ä¸ªæ­£æ•´æ•°ï¼Œç§°ä¸ºB-Treeçš„é«˜åº¦ã€‚</p>
<p>æ¯ä¸ªéå¶å­èŠ‚ç‚¹ç”±n-1ä¸ªkeyå’Œnä¸ªæŒ‡é’ˆç»„æˆï¼Œå…¶ä¸­d&lt;=n&lt;=2dã€‚</p>
<p>æ¯ä¸ªå¶å­èŠ‚ç‚¹æœ€å°‘åŒ…å«ä¸€ä¸ªkeyå’Œä¸¤ä¸ªæŒ‡é’ˆï¼Œæœ€å¤šåŒ…å«2d-1ä¸ªkeyå’Œ2dä¸ªæŒ‡é’ˆï¼Œå¶èŠ‚ç‚¹çš„æŒ‡é’ˆå‡ä¸ºnull ã€‚</p>
<p>æ‰€æœ‰å¶èŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„æ·±åº¦ï¼Œç­‰äºæ ‘é«˜hã€‚</p>
<p>keyå’ŒæŒ‡é’ˆäº’ç›¸é—´éš”ï¼ŒèŠ‚ç‚¹ä¸¤ç«¯æ˜¯æŒ‡é’ˆã€‚</p>
<p>ä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„keyä»å·¦åˆ°å³éé€’å‡æ’åˆ—ã€‚</p>
<p>æ‰€æœ‰èŠ‚ç‚¹ç»„æˆæ ‘ç»“æ„ã€‚</p>
<p>æ¯ä¸ªæŒ‡é’ˆè¦ä¹ˆä¸ºnullï¼Œè¦ä¹ˆæŒ‡å‘å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>å¦‚æœæŸä¸ªæŒ‡é’ˆåœ¨èŠ‚ç‚¹nodeæœ€å·¦è¾¹ä¸”ä¸ä¸ºnullï¼Œåˆ™å…¶æŒ‡å‘èŠ‚ç‚¹çš„æ‰€æœ‰keyå°äºkey[1]ï¼Œå…¶ä¸­key[1]ä¸ºnodeçš„ç¬¬ä¸€ä¸ªkeyçš„å€¼ã€‚</p>
<p>å¦‚æœæŸä¸ªæŒ‡é’ˆåœ¨èŠ‚ç‚¹nodeæœ€å³è¾¹ä¸”ä¸ä¸ºnullï¼Œåˆ™å…¶æŒ‡å‘èŠ‚ç‚¹çš„æ‰€æœ‰keyå¤§äºkey[m]ï¼Œå…¶ä¸­key[m]ä¸ºnodeçš„æœ€åä¸€ä¸ªkeyçš„å€¼ã€‚</p>
<p>å¦‚æœæŸä¸ªæŒ‡é’ˆåœ¨èŠ‚ç‚¹nodeçš„å·¦å³ç›¸é‚»keyåˆ†åˆ«æ˜¯key[i]å’Œkey[i+1]ä¸”ä¸ä¸ºnullï¼Œåˆ™å…¶æŒ‡å‘èŠ‚ç‚¹çš„æ‰€æœ‰keyå°äºkey[i+1]ä¸”å¤§äºkey[i].</p>
<p>ä¸‹å›¾æ˜¯ä¸€ä¸ªd=2çš„B-Treeç¤ºæ„å›¾ã€‚</p>
<p><a href="http://idiotsky.top/images2/b-tree-2.png"><img src="http://idiotsky.top/images2/b-tree-2.png" alt=""></a></p>
<p>ç”±äºB-Treeçš„ç‰¹æ€§ï¼Œåœ¨B-Treeä¸­æŒ‰keyæ£€ç´¢æ•°æ®çš„ç®—æ³•éå¸¸ç›´è§‚ï¼šé¦–å…ˆä»æ ¹èŠ‚ç‚¹è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°åˆ™è¿”å›å¯¹åº”èŠ‚ç‚¹çš„dataï¼Œå¦åˆ™å¯¹ç›¸åº”åŒºé—´çš„æŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹é€’å½’è¿›è¡ŒæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°èŠ‚ç‚¹æˆ–æ‰¾åˆ°nullæŒ‡é’ˆï¼Œå‰è€…æŸ¥æ‰¾æˆåŠŸï¼Œåè€…æŸ¥æ‰¾å¤±è´¥ã€‚B-Treeä¸ŠæŸ¥æ‰¾ç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BTree_Search(node, key) &#123;</span><br><span class="line">    <span class="keyword">if</span>(node == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    foreach(node.key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(node.key[i] == key) <span class="keyword">return</span> node.data[i];</span><br><span class="line">            <span class="keyword">if</span>(node.key[i] &gt; key) <span class="keyword">return</span> BTree_Search(point[i]-&gt;node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BTree_Search(point[i+<span class="number">1</span>]-&gt;node);</span><br><span class="line">&#125;</span><br><span class="line">data = BTree_Search(root, my_key);</span><br></pre></td></tr></table></figure>
<p>å…³äºB-Treeæœ‰ä¸€ç³»åˆ—æœ‰è¶£çš„æ€§è´¨ï¼Œä¾‹å¦‚ä¸€ä¸ªåº¦ä¸ºdçš„B-Treeï¼Œè®¾å…¶ç´¢å¼•Nä¸ªkeyï¼Œåˆ™å…¶æ ‘é«˜hçš„ä¸Šé™ä¸ºlogd((N+1)/2)ï¼Œæ£€ç´¢ä¸€ä¸ªkeyï¼Œå…¶æŸ¥æ‰¾èŠ‚ç‚¹ä¸ªæ•°çš„æ¸è¿›å¤æ‚åº¦ä¸ºO(logdN)ã€‚ä»è¿™ç‚¹å¯ä»¥çœ‹å‡ºï¼ŒB-Treeæ˜¯ä¸€ä¸ªéå¸¸æœ‰æ•ˆç‡çš„ç´¢å¼•æ•°æ®ç»“æ„ã€‚</p>
<p>å¦å¤–ï¼Œç”±äºæ’å…¥åˆ é™¤æ–°çš„æ•°æ®è®°å½•ä¼šç ´åB-Treeçš„æ€§è´¨ï¼Œå› æ­¤åœ¨æ’å…¥åˆ é™¤æ—¶ï¼Œéœ€è¦å¯¹æ ‘è¿›è¡Œä¸€ä¸ªåˆ†è£‚ã€åˆå¹¶ã€è½¬ç§»ç­‰æ“ä½œä»¥ä¿æŒB-Treeæ€§è´¨ï¼Œæœ¬æ–‡ä¸æ‰“ç®—å®Œæ•´è®¨è®ºB-Treeè¿™äº›å†…å®¹ï¼Œå› ä¸ºå·²ç»æœ‰è®¸å¤šèµ„æ–™è¯¦ç»†è¯´æ˜äº†B-Treeçš„æ•°å­¦æ€§è´¨åŠæ’å…¥åˆ é™¤ç®—æ³•ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥æ‰¾ç™¾åº¦è°·æ­Œç»´åŸºè¿›è¡Œé˜…è¯»ã€‚</p>
<h3 id="B-Tree-1"><a href="#B-Tree-1" class="headerlink" title="B+Tree"></a>B+Tree</h3><p>B-Treeæœ‰è®¸å¤šå˜ç§ï¼Œå…¶ä¸­æœ€å¸¸è§çš„æ˜¯B+Treeï¼Œä¾‹å¦‚MySQLå°±æ™®éä½¿ç”¨B+Treeå®ç°å…¶ç´¢å¼•ç»“æ„ã€‚</p>
<p>ä¸B-Treeç›¸æ¯”ï¼ŒB+Treeæœ‰ä»¥ä¸‹ä¸åŒç‚¹ï¼š</p>
<p>æ¯ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆä¸Šé™ä¸º2dè€Œä¸æ˜¯2d+1ã€‚</p>
<p>å†…èŠ‚ç‚¹ä¸å­˜å‚¨dataï¼Œåªå­˜å‚¨keyï¼›å¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æŒ‡é’ˆã€‚</p>
<p>ä¸‹å›¾æ˜¯ä¸€ä¸ªç®€å•çš„B+Treeç¤ºæ„ã€‚</p>
<p><a href="http://idiotsky.top/images2/b-tree-3.png"><img src="http://idiotsky.top/images2/b-tree-3.png" alt=""></a></p>
<p>ç”±äºå¹¶ä¸æ˜¯æ‰€æœ‰èŠ‚ç‚¹éƒ½å…·æœ‰ç›¸åŒçš„åŸŸï¼Œå› æ­¤B+Treeä¸­å¶èŠ‚ç‚¹å’Œå†…èŠ‚ç‚¹ä¸€èˆ¬å¤§å°ä¸åŒã€‚è¿™ç‚¹ä¸B-Treeä¸åŒï¼Œè™½ç„¶B-Treeä¸­ä¸åŒèŠ‚ç‚¹å­˜æ”¾çš„keyå’ŒæŒ‡é’ˆå¯èƒ½æ•°é‡ä¸ä¸€è‡´ï¼Œä½†æ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„åŸŸå’Œä¸Šé™æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥åœ¨å®ç°ä¸­B-Treeå¾€å¾€å¯¹æ¯ä¸ªèŠ‚ç‚¹ç”³è¯·åŒç­‰å¤§å°çš„ç©ºé—´ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼ŒB+Treeæ¯”B-Treeæ›´é€‚åˆå®ç°å¤–å­˜å‚¨ç´¢å¼•ç»“æ„ï¼Œå…·ä½“åŸå› ä¸å¤–å­˜å‚¨å™¨åŸç†åŠè®¡ç®—æœºå­˜å–åŸç†æœ‰å…³ï¼Œå°†åœ¨ä¸‹é¢è®¨è®ºã€‚</p>
<h3 id="å¸¦æœ‰é¡ºåºè®¿é—®æŒ‡é’ˆçš„B-Tree"><a href="#å¸¦æœ‰é¡ºåºè®¿é—®æŒ‡é’ˆçš„B-Tree" class="headerlink" title="å¸¦æœ‰é¡ºåºè®¿é—®æŒ‡é’ˆçš„B+Tree"></a>å¸¦æœ‰é¡ºåºè®¿é—®æŒ‡é’ˆçš„B+Tree</h3><p>ä¸€èˆ¬åœ¨æ•°æ®åº“ç³»ç»Ÿæˆ–æ–‡ä»¶ç³»ç»Ÿä¸­ä½¿ç”¨çš„B+Treeç»“æ„éƒ½åœ¨ç»å…¸B+Treeçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¢åŠ äº†é¡ºåºè®¿é—®æŒ‡é’ˆã€‚</p>
<p><a href="http://idiotsky.top/images2/b-tree-4.png"><img src="http://idiotsky.top/images2/b-tree-4.png" alt=""></a></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨B+Treeçš„æ¯ä¸ªå¶å­èŠ‚ç‚¹å¢åŠ ä¸€ä¸ªæŒ‡å‘ç›¸é‚»å¶å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå°±å½¢æˆäº†å¸¦æœ‰é¡ºåºè®¿é—®æŒ‡é’ˆçš„B+Treeã€‚åšè¿™ä¸ªä¼˜åŒ–çš„ç›®çš„æ˜¯ä¸ºäº†æé«˜åŒºé—´è®¿é—®çš„æ€§èƒ½ï¼Œä¾‹å¦‚å›¾4ä¸­å¦‚æœè¦æŸ¥è¯¢keyä¸ºä»18åˆ°49çš„æ‰€æœ‰æ•°æ®è®°å½•ï¼Œå½“æ‰¾åˆ°18åï¼Œåªéœ€é¡ºç€èŠ‚ç‚¹å’ŒæŒ‡é’ˆé¡ºåºéå†å°±å¯ä»¥ä¸€æ¬¡æ€§è®¿é—®åˆ°æ‰€æœ‰æ•°æ®èŠ‚ç‚¹ï¼Œæå¤§æåˆ°äº†åŒºé—´æŸ¥è¯¢æ•ˆç‡ã€‚</p>
<p>è¿™ä¸€èŠ‚å¯¹B-Treeå’ŒB+Treeè¿›è¡Œäº†ä¸€ä¸ªç®€å•çš„ä»‹ç»ï¼Œä¸‹ä¸€èŠ‚ç»“åˆå­˜å‚¨å™¨å­˜å–åŸç†ä»‹ç»ä¸ºä»€ä¹ˆç›®å‰B+Treeæ˜¯æ•°æ®åº“ç³»ç»Ÿå®ç°ç´¢å¼•çš„é¦–é€‰æ•°æ®ç»“æ„ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨B-Treeï¼ˆB-Treeï¼‰"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨B-Treeï¼ˆB-Treeï¼‰" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨B-Treeï¼ˆB+Treeï¼‰"></a>ä¸ºä»€ä¹ˆä½¿ç”¨B-Treeï¼ˆB+Treeï¼‰</h2><p>ä¸Šæ–‡è¯´è¿‡ï¼Œçº¢é»‘æ ‘ç­‰æ•°æ®ç»“æ„ä¹Ÿå¯ä»¥ç”¨æ¥å®ç°ç´¢å¼•ï¼Œä½†æ˜¯æ–‡ä»¶ç³»ç»ŸåŠæ•°æ®åº“ç³»ç»Ÿæ™®éé‡‡ç”¨B-/+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œè¿™ä¸€èŠ‚å°†ç»“åˆè®¡ç®—æœºç»„æˆåŸç†ç›¸å…³çŸ¥è¯†è®¨è®ºB-/+Treeä½œä¸ºç´¢å¼•çš„ç†è®ºåŸºç¡€ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œç´¢å¼•æœ¬èº«ä¹Ÿå¾ˆå¤§ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ç£ç›˜ä¸Šã€‚è¿™æ ·çš„è¯ï¼Œç´¢å¼•æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¦äº§ç”Ÿç£ç›˜I/Oæ¶ˆè€—ï¼Œç›¸å¯¹äºå†…å­˜å­˜å–ï¼ŒI/Oå­˜å–çš„æ¶ˆè€—è¦é«˜å‡ ä¸ªæ•°é‡çº§ï¼Œæ‰€ä»¥è¯„ä»·ä¸€ä¸ªæ•°æ®ç»“æ„ä½œä¸ºç´¢å¼•çš„ä¼˜åŠ£æœ€é‡è¦çš„æŒ‡æ ‡å°±æ˜¯åœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­ç£ç›˜I/Oæ“ä½œæ¬¡æ•°çš„æ¸è¿›å¤æ‚åº¦ã€‚æ¢å¥è¯è¯´ï¼Œç´¢å¼•çš„ç»“æ„ç»„ç»‡è¦å°½é‡å‡å°‘æŸ¥æ‰¾è¿‡ç¨‹ä¸­ç£ç›˜I/Oçš„å­˜å–æ¬¡æ•°ã€‚ä¸‹é¢å…ˆä»‹ç»å†…å­˜å’Œç£ç›˜å­˜å–åŸç†ï¼Œç„¶åå†ç»“åˆè¿™äº›åŸç†åˆ†æB-/+Treeä½œä¸ºç´¢å¼•çš„æ•ˆç‡ã€‚</p>
<h3 id="ä¸»å­˜å­˜å–åŸç†"><a href="#ä¸»å­˜å­˜å–åŸç†" class="headerlink" title="ä¸»å­˜å­˜å–åŸç†"></a>ä¸»å­˜å­˜å–åŸç†</h3><p>ç›®å‰è®¡ç®—æœºä½¿ç”¨çš„ä¸»å­˜åŸºæœ¬éƒ½æ˜¯éšæœºè¯»å†™å­˜å‚¨å™¨ï¼ˆRAMï¼‰ï¼Œç°ä»£RAMçš„ç»“æ„å’Œå­˜å–åŸç†æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæœ¬æ–‡æŠ›å´å…·ä½“å·®åˆ«ï¼ŒæŠ½è±¡å‡ºä¸€ä¸ªååˆ†ç®€å•çš„å­˜å–æ¨¡å‹æ¥è¯´æ˜RAMçš„å·¥ä½œåŸç†ã€‚</p>
<p><a href="http://idiotsky.top/images2/b-tree-5.png"><img src="http://idiotsky.top/images2/b-tree-5.png" alt=""></a></p>
<p>ä»æŠ½è±¡è§’åº¦çœ‹ï¼Œä¸»å­˜æ˜¯ä¸€ç³»åˆ—çš„å­˜å‚¨å•å…ƒç»„æˆçš„çŸ©é˜µï¼Œæ¯ä¸ªå­˜å‚¨å•å…ƒå­˜å‚¨å›ºå®šå¤§å°çš„æ•°æ®ã€‚æ¯ä¸ªå­˜å‚¨å•å…ƒæœ‰å”¯ä¸€çš„åœ°å€ï¼Œç°ä»£ä¸»å­˜çš„ç¼–å€è§„åˆ™æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œå°†å…¶ç®€åŒ–æˆä¸€ä¸ªäºŒç»´åœ°å€ï¼šé€šè¿‡ä¸€ä¸ªè¡Œåœ°å€å’Œä¸€ä¸ªåˆ—åœ°å€å¯ä»¥å”¯ä¸€å®šä½åˆ°ä¸€ä¸ªå­˜å‚¨å•å…ƒã€‚ä¸Šå›¾å±•ç¤ºäº†ä¸€ä¸ª4 x 4çš„ä¸»å­˜æ¨¡å‹ã€‚</p>
<p>ä¸»å­˜çš„å­˜å–è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>å½“ç³»ç»Ÿéœ€è¦è¯»å–ä¸»å­˜æ—¶ï¼Œåˆ™å°†åœ°å€ä¿¡å·æ”¾åˆ°åœ°å€æ€»çº¿ä¸Šä¼ ç»™ä¸»å­˜ï¼Œä¸»å­˜è¯»åˆ°åœ°å€ä¿¡å·åï¼Œè§£æä¿¡å·å¹¶å®šä½åˆ°æŒ‡å®šå­˜å‚¨å•å…ƒï¼Œç„¶åå°†æ­¤å­˜å‚¨å•å…ƒæ•°æ®æ”¾åˆ°æ•°æ®æ€»çº¿ä¸Šï¼Œä¾›å…¶å®ƒéƒ¨ä»¶è¯»å–ã€‚</p>
<p>å†™ä¸»å­˜çš„è¿‡ç¨‹ç±»ä¼¼ï¼Œç³»ç»Ÿå°†è¦å†™å…¥å•å…ƒåœ°å€å’Œæ•°æ®åˆ†åˆ«æ”¾åœ¨åœ°å€æ€»çº¿å’Œæ•°æ®æ€»çº¿ä¸Šï¼Œä¸»å­˜è¯»å–ä¸¤ä¸ªæ€»çº¿çš„å†…å®¹ï¼Œåšç›¸åº”çš„å†™æ“ä½œã€‚</p>
<p>è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œä¸»å­˜å­˜å–çš„æ—¶é—´ä»…ä¸å­˜å–æ¬¡æ•°å‘ˆçº¿æ€§å…³ç³»ï¼Œå› ä¸ºä¸å­˜åœ¨æœºæ¢°æ“ä½œï¼Œä¸¤æ¬¡å­˜å–çš„æ•°æ®çš„â€œè·ç¦»â€ä¸ä¼šå¯¹æ—¶é—´æœ‰ä»»ä½•å½±å“ï¼Œä¾‹å¦‚ï¼Œå…ˆå–A0å†å–A1å’Œå…ˆå–A0å†å–D3çš„æ—¶é—´æ¶ˆè€—æ˜¯ä¸€æ ·çš„ã€‚</p>
<h3 id="ç£ç›˜å­˜å–åŸç†"><a href="#ç£ç›˜å­˜å–åŸç†" class="headerlink" title="ç£ç›˜å­˜å–åŸç†"></a>ç£ç›˜å­˜å–åŸç†</h3><p>ä¸Šæ–‡è¯´è¿‡ï¼Œç´¢å¼•ä¸€èˆ¬ä»¥æ–‡ä»¶å½¢å¼å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œç´¢å¼•æ£€ç´¢éœ€è¦ç£ç›˜I/Oæ“ä½œã€‚ä¸ä¸»å­˜ä¸åŒï¼Œç£ç›˜I/Oå­˜åœ¨æœºæ¢°è¿åŠ¨è€—è´¹ï¼Œå› æ­¤ç£ç›˜I/Oçš„æ—¶é—´æ¶ˆè€—æ˜¯å·¨å¤§çš„ã€‚</p>
<p>ä¸‹å›¾æ˜¯ç£ç›˜çš„æ•´ä½“ç»“æ„ç¤ºæ„å›¾ã€‚</p>
<p><a href="http://idiotsky.top/images2/b-tree-6.png"><img src="http://idiotsky.top/images2/b-tree-6.png" alt=""></a></p>
<p>ä¸€ä¸ªç£ç›˜ç”±å¤§å°ç›¸åŒä¸”åŒè½´çš„åœ†å½¢ç›˜ç‰‡ç»„æˆï¼Œç£ç›˜å¯ä»¥è½¬åŠ¨ï¼ˆå„ä¸ªç£ç›˜å¿…é¡»åŒæ­¥è½¬åŠ¨ï¼‰ã€‚åœ¨ç£ç›˜çš„ä¸€ä¾§æœ‰ç£å¤´æ”¯æ¶ï¼Œç£å¤´æ”¯æ¶å›ºå®šäº†ä¸€ç»„ç£å¤´ï¼Œæ¯ä¸ªç£å¤´è´Ÿè´£å­˜å–ä¸€ä¸ªç£ç›˜çš„å†…å®¹ã€‚ç£å¤´ä¸èƒ½è½¬åŠ¨ï¼Œä½†æ˜¯å¯ä»¥æ²¿ç£ç›˜åŠå¾„æ–¹å‘è¿åŠ¨ï¼ˆå®é™…æ˜¯æ–œåˆ‡å‘è¿åŠ¨ï¼‰ï¼Œæ¯ä¸ªç£å¤´åŒä¸€æ—¶åˆ»ä¹Ÿå¿…é¡»æ˜¯åŒè½´çš„ï¼Œå³ä»æ­£ä¸Šæ–¹å‘ä¸‹çœ‹ï¼Œæ‰€æœ‰ç£å¤´ä»»ä½•æ—¶å€™éƒ½æ˜¯é‡å çš„ï¼ˆä¸è¿‡ç›®å‰å·²ç»æœ‰å¤šç£å¤´ç‹¬ç«‹æŠ€æœ¯ï¼Œå¯ä¸å—æ­¤é™åˆ¶ï¼‰ã€‚</p>
<p>ä¸‹å›¾æ˜¯ç£ç›˜ç»“æ„çš„ç¤ºæ„å›¾ã€‚</p>
<p><a href="http://idiotsky.top/images2/b-tree-7.png"><img src="http://idiotsky.top/images2/b-tree-7.png" alt=""></a></p>
<p>ç›˜ç‰‡è¢«åˆ’åˆ†æˆä¸€ç³»åˆ—åŒå¿ƒç¯ï¼Œåœ†å¿ƒæ˜¯ç›˜ç‰‡ä¸­å¿ƒï¼Œæ¯ä¸ªåŒå¿ƒç¯å«åšä¸€ä¸ªç£é“ï¼Œæ‰€æœ‰åŠå¾„ç›¸åŒçš„ç£é“ç»„æˆä¸€ä¸ªæŸ±é¢ã€‚ç£é“è¢«æ²¿åŠå¾„çº¿åˆ’åˆ†æˆä¸€ä¸ªä¸ªå°çš„æ®µï¼Œæ¯ä¸ªæ®µå«åšä¸€ä¸ªæ‰‡åŒºï¼Œæ¯ä¸ªæ‰‡åŒºæ˜¯ç£ç›˜çš„æœ€å°å­˜å‚¨å•å…ƒã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä¸‹é¢å‡è®¾ç£ç›˜åªæœ‰ä¸€ä¸ªç›˜ç‰‡å’Œä¸€ä¸ªç£å¤´ã€‚</p>
<p>å½“éœ€è¦ä»ç£ç›˜è¯»å–æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šå°†æ•°æ®é€»è¾‘åœ°å€ä¼ ç»™ç£ç›˜ï¼Œç£ç›˜çš„æ§åˆ¶ç”µè·¯æŒ‰ç…§å¯»å€é€»è¾‘å°†é€»è¾‘åœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼Œå³ç¡®å®šè¦è¯»çš„æ•°æ®åœ¨å“ªä¸ªç£é“ï¼Œå“ªä¸ªæ‰‡åŒºã€‚ä¸ºäº†è¯»å–è¿™ä¸ªæ‰‡åŒºçš„æ•°æ®ï¼Œéœ€è¦å°†ç£å¤´æ”¾åˆ°è¿™ä¸ªæ‰‡åŒºä¸Šæ–¹ï¼Œä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œç£å¤´éœ€è¦ç§»åŠ¨å¯¹å‡†ç›¸åº”ç£é“ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšå¯»é“ï¼Œæ‰€è€—è´¹æ—¶é—´å«åšå¯»é“æ—¶é—´ï¼Œç„¶åç£ç›˜æ—‹è½¬å°†ç›®æ ‡æ‰‡åŒºæ—‹è½¬åˆ°ç£å¤´ä¸‹ï¼Œè¿™ä¸ªè¿‡ç¨‹è€—è´¹çš„æ—¶é—´å«åšæ—‹è½¬æ—¶é—´ã€‚</p>
<h3 id="å±€éƒ¨æ€§åŸç†ä¸ç£ç›˜é¢„è¯»"><a href="#å±€éƒ¨æ€§åŸç†ä¸ç£ç›˜é¢„è¯»" class="headerlink" title="å±€éƒ¨æ€§åŸç†ä¸ç£ç›˜é¢„è¯»"></a>å±€éƒ¨æ€§åŸç†ä¸ç£ç›˜é¢„è¯»</h3><p>ç”±äºå­˜å‚¨ä»‹è´¨çš„ç‰¹æ€§ï¼Œç£ç›˜æœ¬èº«å­˜å–å°±æ¯”ä¸»å­˜æ…¢å¾ˆå¤šï¼Œå†åŠ ä¸Šæœºæ¢°è¿åŠ¨è€—è´¹ï¼Œç£ç›˜çš„å­˜å–é€Ÿåº¦å¾€å¾€æ˜¯ä¸»å­˜çš„å‡ ç™¾åˆ†åˆ†ä¹‹ä¸€ï¼Œå› æ­¤ä¸ºäº†æé«˜æ•ˆç‡ï¼Œè¦å°½é‡å‡å°‘ç£ç›˜I/Oã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œç£ç›˜å¾€å¾€ä¸æ˜¯ä¸¥æ ¼æŒ‰éœ€è¯»å–ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šé¢„è¯»ï¼Œå³ä½¿åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œç£ç›˜ä¹Ÿä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹ï¼Œé¡ºåºå‘åè¯»å–ä¸€å®šé•¿åº¦çš„æ•°æ®æ”¾å…¥å†…å­˜ã€‚è¿™æ ·åšçš„ç†è®ºä¾æ®æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­è‘—åçš„å±€éƒ¨æ€§åŸç†ï¼š</p>
<p>å½“ä¸€ä¸ªæ•°æ®è¢«ç”¨åˆ°æ—¶ï¼Œå…¶é™„è¿‘çš„æ•°æ®ä¹Ÿé€šå¸¸ä¼šé©¬ä¸Šè¢«ä½¿ç”¨ã€‚</p>
<p>ç¨‹åºè¿è¡ŒæœŸé—´æ‰€éœ€è¦çš„æ•°æ®é€šå¸¸æ¯”è¾ƒé›†ä¸­ã€‚</p>
<p>ç”±äºç£ç›˜é¡ºåºè¯»å–çš„æ•ˆç‡å¾ˆé«˜ï¼ˆä¸éœ€è¦å¯»é“æ—¶é—´ï¼Œåªéœ€å¾ˆå°‘çš„æ—‹è½¬æ—¶é—´ï¼‰ï¼Œå› æ­¤å¯¹äºå…·æœ‰å±€éƒ¨æ€§çš„ç¨‹åºæ¥è¯´ï¼Œé¢„è¯»å¯ä»¥æé«˜I/Oæ•ˆç‡ã€‚</p>
<p>é¢„è¯»çš„é•¿åº¦ä¸€èˆ¬ä¸ºé¡µï¼ˆpageï¼‰çš„æ•´å€æ•°ã€‚é¡µæ˜¯è®¡ç®—æœºç®¡ç†å­˜å‚¨å™¨çš„é€»è¾‘å—ï¼Œç¡¬ä»¶åŠæ“ä½œç³»ç»Ÿå¾€å¾€å°†ä¸»å­˜å’Œç£ç›˜å­˜å‚¨åŒºåˆ†å‰²ä¸ºè¿ç»­çš„å¤§å°ç›¸ç­‰çš„å—ï¼Œæ¯ä¸ªå­˜å‚¨å—ç§°ä¸ºä¸€é¡µï¼ˆåœ¨è®¸å¤šæ“ä½œç³»ç»Ÿä¸­ï¼Œé¡µå¾—å¤§å°é€šå¸¸ä¸º4kï¼‰ï¼Œä¸»å­˜å’Œç£ç›˜ä»¥é¡µä¸ºå•ä½äº¤æ¢æ•°æ®ã€‚å½“ç¨‹åºè¦è¯»å–çš„æ•°æ®ä¸åœ¨ä¸»å­˜ä¸­æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šå‘ç£ç›˜å‘å‡ºè¯»ç›˜ä¿¡å·ï¼Œç£ç›˜ä¼šæ‰¾åˆ°æ•°æ®çš„èµ·å§‹ä½ç½®å¹¶å‘åè¿ç»­è¯»å–ä¸€é¡µæˆ–å‡ é¡µè½½å…¥å†…å­˜ä¸­ï¼Œç„¶åå¼‚å¸¸è¿”å›ï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚</p>
<h3 id="B-Treeç´¢å¼•çš„æ€§èƒ½åˆ†æ"><a href="#B-Treeç´¢å¼•çš„æ€§èƒ½åˆ†æ" class="headerlink" title="B-/+Treeç´¢å¼•çš„æ€§èƒ½åˆ†æ"></a>B-/+Treeç´¢å¼•çš„æ€§èƒ½åˆ†æ</h3><p>åˆ°è¿™é‡Œç»ˆäºå¯ä»¥åˆ†æB-/+Treeç´¢å¼•çš„æ€§èƒ½äº†ã€‚</p>
<p>ä¸Šæ–‡è¯´è¿‡ä¸€èˆ¬ä½¿ç”¨ç£ç›˜I/Oæ¬¡æ•°è¯„ä»·ç´¢å¼•ç»“æ„çš„ä¼˜åŠ£ã€‚å…ˆä»B-Treeåˆ†æï¼Œæ ¹æ®B-Treeçš„å®šä¹‰ï¼Œå¯çŸ¥æ£€ç´¢ä¸€æ¬¡æœ€å¤šéœ€è¦è®¿é—®hä¸ªèŠ‚ç‚¹ã€‚æ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡è€…å·§å¦™åˆ©ç”¨äº†ç£ç›˜é¢„è¯»åŸç†ï¼Œå°†ä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ä¸ºç­‰äºä¸€ä¸ªé¡µï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦ä¸€æ¬¡I/Oå°±å¯ä»¥å®Œå…¨è½½å…¥ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œåœ¨å®é™…å®ç°B-Treeè¿˜éœ€è¦ä½¿ç”¨å¦‚ä¸‹æŠ€å·§ï¼š</p>
<p>æ¯æ¬¡æ–°å»ºèŠ‚ç‚¹æ—¶ï¼Œç›´æ¥ç”³è¯·ä¸€ä¸ªé¡µçš„ç©ºé—´ï¼Œè¿™æ ·å°±ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ç‰©ç†ä¸Šä¹Ÿå­˜å‚¨åœ¨ä¸€ä¸ªé¡µé‡Œï¼ŒåŠ ä¹‹è®¡ç®—æœºå­˜å‚¨åˆ†é…éƒ½æ˜¯æŒ‰é¡µå¯¹é½çš„ï¼Œå°±å®ç°äº†ä¸€ä¸ªnodeåªéœ€ä¸€æ¬¡I/Oã€‚</p>
<p>B-Treeä¸­ä¸€æ¬¡æ£€ç´¢æœ€å¤šéœ€è¦h-1æ¬¡I/Oï¼ˆæ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜ï¼‰ï¼Œæ¸è¿›å¤æ‚åº¦ä¸ºO(h)=O(logdN)ã€‚ä¸€èˆ¬å®é™…åº”ç”¨ä¸­ï¼Œå‡ºåº¦dæ˜¯éå¸¸å¤§çš„æ•°å­—ï¼Œé€šå¸¸è¶…è¿‡100ï¼Œå› æ­¤héå¸¸å°ï¼ˆé€šå¸¸ä¸è¶…è¿‡3ï¼‰ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œç”¨B-Treeä½œä¸ºç´¢å¼•ç»“æ„æ•ˆç‡æ˜¯éå¸¸é«˜çš„ã€‚</p>
<p>è€Œçº¢é»‘æ ‘è¿™ç§ç»“æ„ï¼Œhæ˜æ˜¾è¦æ·±çš„å¤šã€‚ç”±äºé€»è¾‘ä¸Šå¾ˆè¿‘çš„èŠ‚ç‚¹ï¼ˆçˆ¶å­ï¼‰ç‰©ç†ä¸Šå¯èƒ½å¾ˆè¿œï¼Œæ— æ³•åˆ©ç”¨å±€éƒ¨æ€§ï¼Œæ‰€ä»¥çº¢é»‘æ ‘çš„I/Oæ¸è¿›å¤æ‚åº¦ä¹Ÿä¸ºO(h)ï¼Œæ•ˆç‡æ˜æ˜¾æ¯”B-Treeå·®å¾ˆå¤šã€‚</p>
<p>ä¸Šæ–‡è¿˜è¯´è¿‡ï¼ŒB+Treeæ›´é€‚åˆå¤–å­˜ç´¢å¼•ï¼ŒåŸå› å’Œå†…èŠ‚ç‚¹å‡ºåº¦dæœ‰å…³ã€‚ä»ä¸Šé¢åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œdè¶Šå¤§ç´¢å¼•çš„æ€§èƒ½è¶Šå¥½ï¼Œè€Œå‡ºåº¦çš„ä¸Šé™å–å†³äºèŠ‚ç‚¹å†…keyå’Œdataçš„å¤§å°ï¼š</p>
<p>dmax=floor(pagesize/(keysize+datasize+pointsize)) floorè¡¨ç¤ºå‘ä¸‹å–æ•´ã€‚ç”±äºB+Treeå†…èŠ‚ç‚¹å»æ‰äº†dataåŸŸï¼Œå› æ­¤å¯ä»¥æ‹¥æœ‰æ›´å¤§çš„å‡ºåº¦ï¼Œæ‹¥æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p>è¿™ä¸€ç« ä»ç†è®ºè§’åº¦è®¨è®ºäº†ä¸ç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„ä¸ç®—æ³•é—®é¢˜ï¼Œä¸‹ä¸€ç« å°†è®¨è®ºB+Treeæ˜¯å¦‚ä½•å…·ä½“å®ç°ä¸ºMySQLä¸­ç´¢å¼•ï¼ŒåŒæ—¶å°†ç»“åˆMyISAMå’ŒInnDBå­˜å‚¨å¼•æ“ä»‹ç»éèšé›†ç´¢å¼•å’Œèšé›†ç´¢å¼•ä¸¤ç§ä¸åŒçš„ç´¢å¼•å®ç°å½¢å¼ã€‚</p>
<h1 id="MySQLç´¢å¼•å®ç°"><a href="#MySQLç´¢å¼•å®ç°" class="headerlink" title="MySQLç´¢å¼•å®ç°"></a>MySQLç´¢å¼•å®ç°</h1><p>åœ¨MySQLä¸­ï¼Œç´¢å¼•å±äºå­˜å‚¨å¼•æ“çº§åˆ«çš„æ¦‚å¿µï¼Œä¸åŒå­˜å‚¨å¼•æ“å¯¹ç´¢å¼•çš„å®ç°æ–¹å¼æ˜¯ä¸åŒçš„ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºMyISAMå’ŒInnoDBä¸¤ä¸ªå­˜å‚¨å¼•æ“çš„ç´¢å¼•å®ç°æ–¹å¼ã€‚</p>
<h2 id="MyISAMç´¢å¼•å®ç°"><a href="#MyISAMç´¢å¼•å®ç°" class="headerlink" title="MyISAMç´¢å¼•å®ç°"></a>MyISAMç´¢å¼•å®ç°</h2><p>MyISAMå¼•æ“ä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¶èŠ‚ç‚¹çš„dataåŸŸå­˜æ”¾çš„æ˜¯æ•°æ®è®°å½•çš„åœ°å€ã€‚ä¸‹å›¾æ˜¯MyISAMç´¢å¼•çš„åŸç†å›¾ï¼š</p>
<p><a href="http://idiotsky.top/images2/b-tree-8.png"><img src="http://idiotsky.top/images2/b-tree-8.png" alt=""></a></p>
<p>è¿™é‡Œè®¾è¡¨ä¸€å…±æœ‰ä¸‰åˆ—ï¼Œå‡è®¾æˆ‘ä»¬ä»¥Col1ä¸ºä¸»é”®ï¼Œåˆ™ä¸Šå›¾æ˜¯ä¸€ä¸ªMyISAMè¡¨çš„ä¸»ç´¢å¼•ï¼ˆPrimary keyï¼‰ç¤ºæ„ã€‚å¯ä»¥çœ‹å‡ºMyISAMçš„ç´¢å¼•æ–‡ä»¶ä»…ä»…ä¿å­˜æ•°æ®è®°å½•çš„åœ°å€ã€‚åœ¨MyISAMä¸­ï¼Œä¸»ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•ï¼ˆSecondary keyï¼‰åœ¨ç»“æ„ä¸Šæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œåªæ˜¯ä¸»ç´¢å¼•è¦æ±‚keyæ˜¯å”¯ä¸€çš„ï¼Œè€Œè¾…åŠ©ç´¢å¼•çš„keyå¯ä»¥é‡å¤ã€‚å¦‚æœæˆ‘ä»¬åœ¨Col2ä¸Šå»ºç«‹ä¸€ä¸ªè¾…åŠ©ç´¢å¼•ï¼Œåˆ™æ­¤ç´¢å¼•çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="http://idiotsky.top/images2/b-tree-9.png"><img src="http://idiotsky.top/images2/b-tree-9.png" alt=""></a></p>
<p>åŒæ ·ä¹Ÿæ˜¯ä¸€é¢—B+Treeï¼ŒdataåŸŸä¿å­˜æ•°æ®è®°å½•çš„åœ°å€ã€‚å› æ­¤ï¼ŒMyISAMä¸­ç´¢å¼•æ£€ç´¢çš„ç®—æ³•ä¸ºé¦–å…ˆæŒ‰ç…§B+Treeæœç´¢ç®—æ³•æœç´¢ç´¢å¼•ï¼Œå¦‚æœæŒ‡å®šçš„Keyå­˜åœ¨ï¼Œåˆ™å–å‡ºå…¶dataåŸŸçš„å€¼ï¼Œç„¶åä»¥dataåŸŸçš„å€¼ä¸ºåœ°å€ï¼Œè¯»å–ç›¸åº”æ•°æ®è®°å½•ã€‚</p>
<p>MyISAMçš„ç´¢å¼•æ–¹å¼ä¹Ÿå«åšâ€œéèšé›†â€çš„ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆç§°å‘¼æ˜¯ä¸ºäº†ä¸InnoDBçš„èšé›†ç´¢å¼•åŒºåˆ†ã€‚</p>
<h2 id="InnoDBç´¢å¼•å®ç°"><a href="#InnoDBç´¢å¼•å®ç°" class="headerlink" title="InnoDBç´¢å¼•å®ç°"></a>InnoDBç´¢å¼•å®ç°</h2><p>è™½ç„¶InnoDBä¹Ÿä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä½†å…·ä½“å®ç°æ–¹å¼å´ä¸MyISAMæˆªç„¶ä¸åŒã€‚</p>
<p>ç¬¬ä¸€ä¸ªé‡å¤§åŒºåˆ«æ˜¯InnoDBçš„æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ç´¢å¼•æ–‡ä»¶ã€‚ä»ä¸Šæ–‡çŸ¥é“ï¼ŒMyISAMç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œç´¢å¼•æ–‡ä»¶ä»…ä¿å­˜æ•°æ®è®°å½•çš„åœ°å€ã€‚è€Œåœ¨InnoDBä¸­ï¼Œè¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰B+Treeç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œè¿™æ£µæ ‘çš„å¶èŠ‚ç‚¹dataåŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚è¿™ä¸ªç´¢å¼•çš„keyæ˜¯æ•°æ®è¡¨çš„ä¸»é”®ï¼Œå› æ­¤InnoDBè¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ä¸»ç´¢å¼•ã€‚</p>
<p><a href="http://idiotsky.top/images2/b-tree-10.png"><img src="http://idiotsky.top/images2/b-tree-10.png" alt=""></a></p>
<p>ä¸Šå›¾æ˜¯InnoDBä¸»ç´¢å¼•ï¼ˆåŒæ—¶ä¹Ÿæ˜¯æ•°æ®æ–‡ä»¶ï¼‰çš„ç¤ºæ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°å¶èŠ‚ç‚¹åŒ…å«äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚è¿™ç§ç´¢å¼•å«åšèšé›†ç´¢å¼•ã€‚å› ä¸ºInnoDBçš„æ•°æ®æ–‡ä»¶æœ¬èº«è¦æŒ‰ä¸»é”®èšé›†ï¼Œæ‰€ä»¥InnoDBè¦æ±‚è¡¨å¿…é¡»æœ‰ä¸»é”®ï¼ˆMyISAMå¯ä»¥æ²¡æœ‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šï¼Œåˆ™MySQLç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªå¯ä»¥å”¯ä¸€æ ‡è¯†æ•°æ®è®°å½•çš„åˆ—ä½œä¸ºä¸»é”®ï¼Œå¦‚æœä¸å­˜åœ¨è¿™ç§åˆ—ï¼Œåˆ™MySQLè‡ªåŠ¨ä¸ºInnoDBè¡¨ç”Ÿæˆä¸€ä¸ªéšå«å­—æ®µä½œä¸ºä¸»é”®ï¼Œè¿™ä¸ªå­—æ®µé•¿åº¦ä¸º6ä¸ªå­—èŠ‚ï¼Œç±»å‹ä¸ºé•¿æ•´å½¢ã€‚</p>
<p>ç¬¬äºŒä¸ªä¸MyISAMç´¢å¼•çš„ä¸åŒæ˜¯InnoDBçš„è¾…åŠ©ç´¢å¼•dataåŸŸå­˜å‚¨ç›¸åº”è®°å½•ä¸»é”®çš„å€¼è€Œä¸æ˜¯åœ°å€ã€‚æ¢å¥è¯è¯´ï¼ŒInnoDBçš„æ‰€æœ‰è¾…åŠ©ç´¢å¼•éƒ½å¼•ç”¨ä¸»é”®ä½œä¸ºdataåŸŸã€‚ä¾‹å¦‚ï¼Œä¸‹å›¾ä¸ºå®šä¹‰åœ¨Col3ä¸Šçš„ä¸€ä¸ªè¾…åŠ©ç´¢å¼•ï¼š</p>
<p><a href="http://idiotsky.top/images2/b-tree-11.png"><img src="http://idiotsky.top/images2/b-tree-11.png" alt=""></a></p>
<p>è¿™é‡Œä»¥è‹±æ–‡å­—ç¬¦çš„ASCIIç ä½œä¸ºæ¯”è¾ƒå‡†åˆ™ã€‚èšé›†ç´¢å¼•è¿™ç§å®ç°æ–¹å¼ä½¿å¾—æŒ‰ä¸»é”®çš„æœç´¢ååˆ†é«˜æ•ˆï¼Œä½†æ˜¯è¾…åŠ©ç´¢å¼•æœç´¢éœ€è¦æ£€ç´¢ä¸¤éç´¢å¼•ï¼šé¦–å…ˆæ£€ç´¢è¾…åŠ©ç´¢å¼•è·å¾—ä¸»é”®ï¼Œç„¶åç”¨ä¸»é”®åˆ°ä¸»ç´¢å¼•ä¸­æ£€ç´¢è·å¾—è®°å½•ã€‚</p>
<p>äº†è§£ä¸åŒå­˜å‚¨å¼•æ“çš„ç´¢å¼•å®ç°æ–¹å¼å¯¹äºæ­£ç¡®ä½¿ç”¨å’Œä¼˜åŒ–ç´¢å¼•éƒ½éå¸¸æœ‰å¸®åŠ©ï¼Œä¾‹å¦‚çŸ¥é“äº†InnoDBçš„ç´¢å¼•å®ç°åï¼Œå°±å¾ˆå®¹æ˜“æ˜ç™½ä¸ºä»€ä¹ˆä¸å»ºè®®ä½¿ç”¨è¿‡é•¿çš„å­—æ®µä½œä¸ºä¸»é”®ï¼Œå› ä¸ºæ‰€æœ‰è¾…åŠ©ç´¢å¼•éƒ½å¼•ç”¨ä¸»ç´¢å¼•ï¼Œè¿‡é•¿çš„ä¸»ç´¢å¼•ä¼šä»¤è¾…åŠ©ç´¢å¼•å˜å¾—è¿‡å¤§ã€‚å†ä¾‹å¦‚ï¼Œç”¨éå•è°ƒçš„å­—æ®µä½œä¸ºä¸»é”®åœ¨InnoDBä¸­ä¸æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œå› ä¸ºInnoDBæ•°æ®æ–‡ä»¶æœ¬èº«æ˜¯ä¸€é¢—B+Treeï¼Œéå•è°ƒçš„ä¸»é”®ä¼šé€ æˆåœ¨æ’å…¥æ–°è®°å½•æ—¶æ•°æ®æ–‡ä»¶ä¸ºäº†ç»´æŒB+Treeçš„ç‰¹æ€§è€Œé¢‘ç¹çš„åˆ†è£‚è°ƒæ•´ï¼Œååˆ†ä½æ•ˆï¼Œè€Œä½¿ç”¨è‡ªå¢å­—æ®µä½œä¸ºä¸»é”®åˆ™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
<p>ä¸‹ä¸€ç« å°†å…·ä½“è®¨è®ºè¿™äº›ä¸ç´¢å¼•æœ‰å…³çš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<h1 id="ç´¢å¼•ä½¿ç”¨ç­–ç•¥åŠä¼˜åŒ–"><a href="#ç´¢å¼•ä½¿ç”¨ç­–ç•¥åŠä¼˜åŒ–" class="headerlink" title="ç´¢å¼•ä½¿ç”¨ç­–ç•¥åŠä¼˜åŒ–"></a>ç´¢å¼•ä½¿ç”¨ç­–ç•¥åŠä¼˜åŒ–</h1><p>MySQLçš„ä¼˜åŒ–ä¸»è¦åˆ†ä¸ºç»“æ„ä¼˜åŒ–ï¼ˆScheme optimizationï¼‰å’ŒæŸ¥è¯¢ä¼˜åŒ–ï¼ˆQuery optimizationï¼‰ã€‚æœ¬ç« è®¨è®ºçš„é«˜æ€§èƒ½ç´¢å¼•ç­–ç•¥ä¸»è¦å±äºç»“æ„ä¼˜åŒ–èŒƒç•´ã€‚æœ¬ç« çš„å†…å®¹å®Œå…¨åŸºäºä¸Šæ–‡çš„ç†è®ºåŸºç¡€ï¼Œå®é™…ä¸Šä¸€æ—¦ç†è§£äº†ç´¢å¼•èƒŒåçš„æœºåˆ¶ï¼Œé‚£ä¹ˆé€‰æ‹©é«˜æ€§èƒ½çš„ç­–ç•¥å°±å˜æˆäº†çº¯ç²¹çš„æ¨ç†ï¼Œå¹¶ä¸”å¯ä»¥ç†è§£è¿™äº›ç­–ç•¥èƒŒåçš„é€»è¾‘ã€‚</p>
<h2 id="ç¤ºä¾‹æ•°æ®åº“"><a href="#ç¤ºä¾‹æ•°æ®åº“" class="headerlink" title="ç¤ºä¾‹æ•°æ®åº“"></a>ç¤ºä¾‹æ•°æ®åº“</h2><p>ä¸ºäº†è®¨è®ºç´¢å¼•ç­–ç•¥ï¼Œéœ€è¦ä¸€ä¸ªæ•°æ®é‡ä¸ç®—å°çš„æ•°æ®åº“ä½œä¸ºç¤ºä¾‹ã€‚æœ¬æ–‡é€‰ç”¨MySQLå®˜æ–¹æ–‡æ¡£ä¸­æä¾›çš„ç¤ºä¾‹æ•°æ®åº“ä¹‹ä¸€ï¼šemployeesã€‚è¿™ä¸ªæ•°æ®åº“å…³ç³»å¤æ‚åº¦é€‚ä¸­ï¼Œä¸”æ•°æ®é‡è¾ƒå¤§ã€‚ä¸‹å›¾æ˜¯è¿™ä¸ªæ•°æ®åº“çš„E-Rå…³ç³»å›¾ï¼ˆå¼•ç”¨è‡ªMySQLå®˜æ–¹æ‰‹å†Œï¼‰ï¼š</p>
<p><a href="http://idiotsky.top/images2/b-tree-12.png"><img src="http://idiotsky.top/images2/b-tree-12.png" alt=""></a></p>
<h2 id="æœ€å·¦å‰ç¼€åŸç†ä¸ç›¸å…³ä¼˜åŒ–"><a href="#æœ€å·¦å‰ç¼€åŸç†ä¸ç›¸å…³ä¼˜åŒ–" class="headerlink" title="æœ€å·¦å‰ç¼€åŸç†ä¸ç›¸å…³ä¼˜åŒ–"></a>æœ€å·¦å‰ç¼€åŸç†ä¸ç›¸å…³ä¼˜åŒ–</h2><p>é«˜æ•ˆä½¿ç”¨ç´¢å¼•çš„é¦–è¦æ¡ä»¶æ˜¯çŸ¥é“ä»€ä¹ˆæ ·çš„æŸ¥è¯¢ä¼šä½¿ç”¨åˆ°ç´¢å¼•ï¼Œè¿™ä¸ªé—®é¢˜å’ŒB+Treeä¸­çš„â€œæœ€å·¦å‰ç¼€åŸç†â€æœ‰å…³ï¼Œä¸‹é¢é€šè¿‡ä¾‹å­è¯´æ˜æœ€å·¦å‰ç¼€åŸç†ã€‚</p>
<p>è¿™é‡Œå…ˆè¯´ä¸€ä¸‹è”åˆç´¢å¼•çš„æ¦‚å¿µã€‚åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬éƒ½æ˜¯å‡è®¾ç´¢å¼•åªå¼•ç”¨äº†å•ä¸ªçš„åˆ—ï¼Œå®é™…ä¸Šï¼ŒMySQLä¸­çš„ç´¢å¼•å¯ä»¥ä»¥ä¸€å®šé¡ºåºå¼•ç”¨å¤šä¸ªåˆ—ï¼Œè¿™ç§ç´¢å¼•å«åšè”åˆç´¢å¼•ï¼Œä¸€èˆ¬çš„ï¼Œä¸€ä¸ªè”åˆç´¢å¼•æ˜¯ä¸€ä¸ªæœ‰åºå…ƒç»„<code>&lt;a1, a2, â€¦, an&gt;</code>ï¼Œå…¶ä¸­å„ä¸ªå…ƒç´ å‡ä¸ºæ•°æ®è¡¨çš„ä¸€åˆ—ï¼Œå®é™…ä¸Šè¦ä¸¥æ ¼å®šä¹‰ç´¢å¼•éœ€è¦ç”¨åˆ°å…³ç³»ä»£æ•°ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä¸æƒ³è®¨è®ºå¤ªå¤šå…³ç³»ä»£æ•°çš„è¯é¢˜ï¼Œå› ä¸ºé‚£æ ·ä¼šæ˜¾å¾—å¾ˆæ¯ç‡¥ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å†åšä¸¥æ ¼å®šä¹‰ã€‚å¦å¤–ï¼Œå•åˆ—ç´¢å¼•å¯ä»¥çœ‹æˆè”åˆç´¢å¼•å…ƒç´ æ•°ä¸º1çš„ç‰¹ä¾‹ã€‚</p>
<p>ä»¥employees.titlesè¡¨ä¸ºä¾‹ï¼Œä¸‹é¢å…ˆæŸ¥çœ‹å…¶ä¸Šéƒ½æœ‰å“ªäº›ç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SHOW INDEX FROM employees.titles;</span><br><span class="line">+--------+------------+----------+--------------+-------------+-----------+-------------+------+------------+</span><br><span class="line">| Table  | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Null | Index_type |</span><br><span class="line">+--------+------------+----------+--------------+-------------+-----------+-------------+------+------------+</span><br><span class="line">| titles |          0 | PRIMARY  |            1 | emp_no      | A         |        NULL |      | BTREE      |</span><br><span class="line">| titles |          0 | PRIMARY  |            2 | title       | A         |        NULL |      | BTREE      |</span><br><span class="line">| titles |          0 | PRIMARY  |            3 | from_date   | A         |      443308 |      | BTREE      |</span><br><span class="line">| titles |          1 | emp_no   |            1 | emp_no      | A         |      443308 |      | BTREE      |</span><br><span class="line">+--------+------------+----------+--------------+-------------+-----------+-------------+------+------------+</span><br></pre></td></tr></table></figure>
<p>ä»ç»“æœä¸­å¯ä»¥åˆ°titlesè¡¨çš„ä¸»ç´¢å¼•ä¸º<code>&lt;emp_no, title, from_date&gt;</code>ï¼Œè¿˜æœ‰ä¸€ä¸ªè¾…åŠ©ç´¢å¼•<code>&lt;emp_no&gt;</code>ã€‚ä¸ºäº†é¿å…å¤šä¸ªç´¢å¼•ä½¿äº‹æƒ…å˜å¤æ‚ï¼ˆMySQLçš„SQLä¼˜åŒ–å™¨åœ¨å¤šç´¢å¼•æ—¶è¡Œä¸ºæ¯”è¾ƒå¤æ‚ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å°†è¾…åŠ©ç´¢å¼•dropæ‰ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> employees.titles <span class="keyword">DROP</span> <span class="keyword">INDEX</span> emp_no;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥ä¸“å¿ƒåˆ†æç´¢å¼•PRIMARYçš„è¡Œä¸ºäº†ã€‚</p>
<h3 id="æƒ…å†µä¸€ï¼šå…¨åˆ—åŒ¹é…ã€‚"><a href="#æƒ…å†µä¸€ï¼šå…¨åˆ—åŒ¹é…ã€‚" class="headerlink" title="æƒ…å†µä¸€ï¼šå…¨åˆ—åŒ¹é…ã€‚"></a>æƒ…å†µä¸€ï¼šå…¨åˆ—åŒ¹é…ã€‚</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE emp_no=&apos;10001&apos; AND title=&apos;Senior Engineer&apos; AND from_date=&apos;1986-06-26&apos;;</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+-------------------+------+-------+</span><br><span class="line">| id | select_type | table  | type  | possible_keys | key     | key_len | ref               | rows | Extra |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+-------------------+------+-------+</span><br><span class="line">|  1 | SIMPLE      | titles | const | PRIMARY       | PRIMARY | 59      | const,const,const |    1 |       |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+-------------------+------+-------+</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ï¼Œå½“æŒ‰ç…§ç´¢å¼•ä¸­æ‰€æœ‰åˆ—è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼ˆè¿™é‡Œç²¾ç¡®åŒ¹é…æŒ‡â€œ=â€æˆ–â€œINâ€åŒ¹é…ï¼‰æ—¶ï¼Œç´¢å¼•å¯ä»¥è¢«ç”¨åˆ°ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œç†è®ºä¸Šç´¢å¼•å¯¹é¡ºåºæ˜¯æ•æ„Ÿçš„ï¼Œä½†æ˜¯ç”±äºMySQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨è°ƒæ•´whereå­å¥çš„æ¡ä»¶é¡ºåºä»¥ä½¿ç”¨é€‚åˆçš„ç´¢å¼•ï¼Œä¾‹å¦‚æˆ‘ä»¬å°†whereä¸­çš„æ¡ä»¶é¡ºåºé¢ å€’ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE from_date=&apos;1986-06-26&apos; AND emp_no=&apos;10001&apos; AND title=&apos;Senior Engineer&apos;;</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+-------------------+------+-------+</span><br><span class="line">| id | select_type | table  | type  | possible_keys | key     | key_len | ref               | rows | Extra |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+-------------------+------+-------+</span><br><span class="line">|  1 | SIMPLE      | titles | const | PRIMARY       | PRIMARY | 59      | const,const,const |    1 |       |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+-------------------+------+-------+</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>
<h3 id="æƒ…å†µäºŒï¼šæœ€å·¦å‰ç¼€åŒ¹é…ã€‚"><a href="#æƒ…å†µäºŒï¼šæœ€å·¦å‰ç¼€åŒ¹é…ã€‚" class="headerlink" title="æƒ…å†µäºŒï¼šæœ€å·¦å‰ç¼€åŒ¹é…ã€‚"></a>æƒ…å†µäºŒï¼šæœ€å·¦å‰ç¼€åŒ¹é…ã€‚</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE emp_no=&apos;10001&apos;;</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------+</span><br><span class="line">| id | select_type | table  | type | possible_keys | key     | key_len | ref   | rows | Extra |</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------+</span><br><span class="line">|  1 | SIMPLE      | titles | ref  | PRIMARY       | PRIMARY | 4       | const |    1 |       |</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------+</span><br></pre></td></tr></table></figure>
<p>å½“æŸ¥è¯¢æ¡ä»¶ç²¾ç¡®åŒ¹é…ç´¢å¼•çš„å·¦è¾¹è¿ç»­ä¸€ä¸ªæˆ–å‡ ä¸ªåˆ—æ—¶ï¼Œå¦‚<code>&lt;emp_no&gt;</code>æˆ–<code>&lt;emp_no, title&gt;</code>ï¼Œæ‰€ä»¥å¯ä»¥è¢«ç”¨åˆ°ï¼Œä½†æ˜¯åªèƒ½ç”¨åˆ°ä¸€éƒ¨åˆ†ï¼Œå³æ¡ä»¶æ‰€ç»„æˆçš„æœ€å·¦å‰ç¼€ã€‚ä¸Šé¢çš„æŸ¥è¯¢ä»åˆ†æç»“æœçœ‹ç”¨åˆ°äº†PRIMARYç´¢å¼•ï¼Œä½†æ˜¯key_lenä¸º4ï¼Œè¯´æ˜åªç”¨åˆ°äº†ç´¢å¼•çš„ç¬¬ä¸€åˆ—å‰ç¼€ã€‚</p>
<h3 id="æƒ…å†µä¸‰ï¼šæŸ¥è¯¢æ¡ä»¶ç”¨åˆ°äº†ç´¢å¼•ä¸­åˆ—çš„ç²¾ç¡®åŒ¹é…ï¼Œä½†æ˜¯ä¸­é—´æŸä¸ªæ¡ä»¶æœªæä¾›ã€‚"><a href="#æƒ…å†µä¸‰ï¼šæŸ¥è¯¢æ¡ä»¶ç”¨åˆ°äº†ç´¢å¼•ä¸­åˆ—çš„ç²¾ç¡®åŒ¹é…ï¼Œä½†æ˜¯ä¸­é—´æŸä¸ªæ¡ä»¶æœªæä¾›ã€‚" class="headerlink" title="æƒ…å†µä¸‰ï¼šæŸ¥è¯¢æ¡ä»¶ç”¨åˆ°äº†ç´¢å¼•ä¸­åˆ—çš„ç²¾ç¡®åŒ¹é…ï¼Œä½†æ˜¯ä¸­é—´æŸä¸ªæ¡ä»¶æœªæä¾›ã€‚"></a>æƒ…å†µä¸‰ï¼šæŸ¥è¯¢æ¡ä»¶ç”¨åˆ°äº†ç´¢å¼•ä¸­åˆ—çš„ç²¾ç¡®åŒ¹é…ï¼Œä½†æ˜¯ä¸­é—´æŸä¸ªæ¡ä»¶æœªæä¾›ã€‚</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE emp_no=&apos;10001&apos; AND from_date=&apos;1986-06-26&apos;;</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------------+</span><br><span class="line">| id | select_type | table  | type | possible_keys | key     | key_len | ref   | rows | Extra       |</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | ref  | PRIMARY       | PRIMARY | 4       | const |    1 | Using where |</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------------+</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ç´¢å¼•ä½¿ç”¨æƒ…å†µå’Œæƒ…å†µäºŒç›¸åŒï¼Œå› ä¸ºtitleæœªæä¾›ï¼Œæ‰€ä»¥æŸ¥è¯¢åªç”¨åˆ°äº†ç´¢å¼•çš„ç¬¬ä¸€åˆ—ï¼Œè€Œåé¢çš„from_dateè™½ç„¶ä¹Ÿåœ¨ç´¢å¼•ä¸­ï¼Œä½†æ˜¯ç”±äºtitleä¸å­˜åœ¨è€Œæ— æ³•å’Œå·¦å‰ç¼€è¿æ¥ï¼Œå› æ­¤éœ€è¦å¯¹ç»“æœè¿›è¡Œæ‰«æè¿‡æ»¤from_dateï¼ˆè¿™é‡Œç”±äºemp_noå”¯ä¸€ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ‰«æï¼‰ã€‚å¦‚æœæƒ³è®©from_dateä¹Ÿä½¿ç”¨ç´¢å¼•è€Œä¸æ˜¯whereè¿‡æ»¤ï¼Œå¯ä»¥å¢åŠ ä¸€ä¸ªè¾…åŠ©ç´¢å¼•<code>&lt;emp_no, from_date&gt;</code>ï¼Œæ­¤æ—¶ä¸Šé¢çš„æŸ¥è¯¢ä¼šä½¿ç”¨è¿™ä¸ªç´¢å¼•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä¸€ç§ç§°ä¹‹ä¸ºâ€œéš”ç¦»åˆ—â€çš„ä¼˜åŒ–æ–¹æ³•ï¼Œå°†emp_noä¸from_dateä¹‹é—´çš„â€œå‘â€å¡«ä¸Šã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹titleä¸€å…±æœ‰å‡ ç§ä¸åŒçš„å€¼ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT(title) FROM employees.titles;</span><br><span class="line">+--------------------+</span><br><span class="line">| title              |</span><br><span class="line">+--------------------+</span><br><span class="line">| Senior Engineer    |</span><br><span class="line">| Staff              |</span><br><span class="line">| Engineer           |</span><br><span class="line">| Senior Staff       |</span><br><span class="line">| Assistant Engineer |</span><br><span class="line">| Technique Leader   |</span><br><span class="line">| Manager            |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure></p>
<p>åªæœ‰7ç§ã€‚åœ¨è¿™ç§æˆä¸ºâ€œå‘â€çš„åˆ—å€¼æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘ç”¨â€œINâ€æ¥å¡«è¡¥è¿™ä¸ªâ€œå‘â€ä»è€Œå½¢æˆæœ€å·¦å‰ç¼€ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles</span><br><span class="line">WHERE emp_no=&apos;10001&apos;</span><br><span class="line">AND title IN (&apos;Senior Engineer&apos;, &apos;Staff&apos;, &apos;Engineer&apos;, &apos;Senior Staff&apos;, &apos;Assistant Engineer&apos;, &apos;Technique Leader&apos;, &apos;Manager&apos;)</span><br><span class="line">AND from_date=&apos;1986-06-26&apos;;</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table  | type  | possible_keys | key     | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | range | PRIMARY       | PRIMARY | 59      | NULL |    7 | Using where |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ¬¡key_lenä¸º59ï¼Œè¯´æ˜ç´¢å¼•è¢«ç”¨å…¨äº†ï¼Œä½†æ˜¯ä»typeå’Œrowsçœ‹å‡ºINå®é™…ä¸Šæ‰§è¡Œäº†ä¸€ä¸ªrangeæŸ¥è¯¢ï¼Œè¿™é‡Œæ£€æŸ¥äº†7ä¸ªkeyã€‚çœ‹ä¸‹ä¸¤ç§æŸ¥è¯¢çš„æ€§èƒ½æ¯”è¾ƒï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROFILES;</span><br><span class="line">+----------+------------+-------------------------------------------------------------------------------+</span><br><span class="line">| Query_ID | Duration   | Query                                                                         |</span><br><span class="line">+----------+------------+-------------------------------------------------------------------------------+</span><br><span class="line">|       10 | 0.00058000 | SELECT * FROM employees.titles WHERE emp_no=&apos;10001&apos; AND from_date=&apos;1986-06-26&apos;|</span><br><span class="line">|       11 | 0.00052500 | SELECT * FROM employees.titles WHERE emp_no=&apos;10001&apos; AND title IN ...          |</span><br><span class="line">+----------+------------+-------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure></p>
<p>â€œå¡«å‘â€åæ€§èƒ½æå‡äº†ä¸€ç‚¹ã€‚å¦‚æœç»è¿‡emp_noç­›é€‰åä½™ä¸‹å¾ˆå¤šæ•°æ®ï¼Œåˆ™åè€…æ€§èƒ½ä¼˜åŠ¿ä¼šæ›´åŠ æ˜æ˜¾ã€‚å½“ç„¶ï¼Œå¦‚æœtitleçš„å€¼å¾ˆå¤šï¼Œç”¨å¡«å‘å°±ä¸åˆé€‚äº†ï¼Œå¿…é¡»å»ºç«‹è¾…åŠ©ç´¢å¼•ã€‚</p>
<h3 id="æƒ…å†µå››ï¼šæŸ¥è¯¢æ¡ä»¶æ²¡æœ‰æŒ‡å®šç´¢å¼•ç¬¬ä¸€åˆ—ã€‚"><a href="#æƒ…å†µå››ï¼šæŸ¥è¯¢æ¡ä»¶æ²¡æœ‰æŒ‡å®šç´¢å¼•ç¬¬ä¸€åˆ—ã€‚" class="headerlink" title="æƒ…å†µå››ï¼šæŸ¥è¯¢æ¡ä»¶æ²¡æœ‰æŒ‡å®šç´¢å¼•ç¬¬ä¸€åˆ—ã€‚"></a>æƒ…å†µå››ï¼šæŸ¥è¯¢æ¡ä»¶æ²¡æœ‰æŒ‡å®šç´¢å¼•ç¬¬ä¸€åˆ—ã€‚</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE from_date=&apos;1986-06-26&apos;;</span><br><span class="line">+----+-------------+--------+------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows   | Extra       |</span><br><span class="line">+----+-------------+--------+------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | ALL  | NULL          | NULL | NULL    | NULL | 443308 | Using where |</span><br><span class="line">+----+-------------+--------+------+---------------+------+---------+------+--------+-------------+</span><br></pre></td></tr></table></figure>
<p>ç”±äºä¸æ˜¯æœ€å·¦å‰ç¼€ï¼Œç´¢å¼•è¿™æ ·çš„æŸ¥è¯¢æ˜¾ç„¶ç”¨ä¸åˆ°ç´¢å¼•ã€‚</p>
<h3 id="æƒ…å†µäº”ï¼šåŒ¹é…æŸåˆ—çš„å‰ç¼€å­—ç¬¦ä¸²ã€‚"><a href="#æƒ…å†µäº”ï¼šåŒ¹é…æŸåˆ—çš„å‰ç¼€å­—ç¬¦ä¸²ã€‚" class="headerlink" title="æƒ…å†µäº”ï¼šåŒ¹é…æŸåˆ—çš„å‰ç¼€å­—ç¬¦ä¸²ã€‚"></a>æƒ…å†µäº”ï¼šåŒ¹é…æŸåˆ—çš„å‰ç¼€å­—ç¬¦ä¸²ã€‚</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE emp_no=&apos;10001&apos; AND title LIKE &apos;Senior%&apos;;</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table  | type  | possible_keys | key     | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | range | PRIMARY       | PRIMARY | 56      | NULL |    1 | Using where |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br></pre></td></tr></table></figure>
<p>å¦‚æœé€šé…ç¬¦%ä¸å‡ºç°åœ¨å¼€å¤´ï¼Œåˆ™å¯ä»¥ç”¨åˆ°ç´¢å¼•ï¼Œä½†æ ¹æ®å…·ä½“æƒ…å†µä¸åŒå¯èƒ½åªä¼šç”¨å…¶ä¸­ä¸€ä¸ªå‰ç¼€.</p>
<h3 id="æƒ…å†µå…­ï¼šèŒƒå›´æŸ¥è¯¢ã€‚"><a href="#æƒ…å†µå…­ï¼šèŒƒå›´æŸ¥è¯¢ã€‚" class="headerlink" title="æƒ…å†µå…­ï¼šèŒƒå›´æŸ¥è¯¢ã€‚"></a>æƒ…å†µå…­ï¼šèŒƒå›´æŸ¥è¯¢ã€‚</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE emp_no &lt; &apos;10010&apos; and title=&apos;Senior Engineer&apos;;</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table  | type  | possible_keys | key     | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | range | PRIMARY       | PRIMARY | 4       | NULL |   16 | Using where |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br></pre></td></tr></table></figure>
<p>èŒƒå›´åˆ—å¯ä»¥ç”¨åˆ°ç´¢å¼•ï¼ˆå¿…é¡»æ˜¯æœ€å·¦å‰ç¼€ï¼‰ï¼Œä½†æ˜¯èŒƒå›´åˆ—åé¢çš„åˆ—æ— æ³•ç”¨åˆ°ç´¢å¼•ã€‚åŒæ—¶ï¼Œç´¢å¼•æœ€å¤šç”¨äºä¸€ä¸ªèŒƒå›´åˆ—ï¼Œå› æ­¤å¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸­æœ‰ä¸¤ä¸ªèŒƒå›´åˆ—åˆ™æ— æ³•å…¨ç”¨åˆ°ç´¢å¼•ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles</span><br><span class="line">WHERE emp_no &lt; &apos;10010&apos;</span><br><span class="line">AND title=&apos;Senior Engineer&apos;</span><br><span class="line">AND from_date BETWEEN &apos;1986-01-01&apos; AND &apos;1986-12-31&apos;;</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table  | type  | possible_keys | key     | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | range | PRIMARY       | PRIMARY | 4       | NULL |   16 | Using where |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ç´¢å¼•å¯¹ç¬¬äºŒä¸ªèŒƒå›´ç´¢å¼•æ— èƒ½ä¸ºåŠ›ã€‚è¿™é‡Œç‰¹åˆ«è¦è¯´æ˜MySQLä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹ï¼Œé‚£å°±æ˜¯ä»…ç”¨explainå¯èƒ½æ— æ³•åŒºåˆ†èŒƒå›´ç´¢å¼•å’Œå¤šå€¼åŒ¹é…ï¼Œå› ä¸ºåœ¨typeä¸­è¿™ä¸¤è€…éƒ½æ˜¾ç¤ºä¸ºrangeã€‚åŒæ—¶ï¼Œç”¨äº†â€œbetweenâ€å¹¶ä¸æ„å‘³ç€å°±æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œä¾‹å¦‚ä¸‹é¢çš„æŸ¥è¯¢ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles</span><br><span class="line">WHERE emp_no BETWEEN &apos;10001&apos; AND &apos;10010&apos;</span><br><span class="line">AND title=&apos;Senior Engineer&apos;</span><br><span class="line">AND from_date BETWEEN &apos;1986-01-01&apos; AND &apos;1986-12-31&apos;;</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">| id | select_type | table  | type  | possible_keys | key     | key_len | ref  | rows | Extra       |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | range | PRIMARY       | PRIMARY | 59      | NULL |   16 | Using where |</span><br><span class="line">+----+-------------+--------+-------+---------------+---------+---------+------+------+-------------+</span><br></pre></td></tr></table></figure></p>
<p>çœ‹èµ·æ¥æ˜¯ç”¨äº†ä¸¤ä¸ªèŒƒå›´æŸ¥è¯¢ï¼Œä½†ä½œç”¨äºemp_noä¸Šçš„â€œBETWEENâ€å®é™…ä¸Šç›¸å½“äºâ€œINâ€ï¼Œä¹Ÿå°±æ˜¯è¯´emp_noå®é™…æ˜¯å¤šå€¼ç²¾ç¡®åŒ¹é…ã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªæŸ¥è¯¢ç”¨åˆ°äº†ç´¢å¼•å…¨éƒ¨ä¸‰ä¸ªåˆ—ã€‚å› æ­¤åœ¨MySQLä¸­è¦è°¨æ…åœ°åŒºåˆ†å¤šå€¼åŒ¹é…å’ŒèŒƒå›´åŒ¹é…ï¼Œå¦åˆ™ä¼šå¯¹MySQLçš„è¡Œä¸ºäº§ç”Ÿå›°æƒ‘ã€‚</p>
<h3 id="æƒ…å†µä¸ƒï¼šæŸ¥è¯¢æ¡ä»¶ä¸­å«æœ‰å‡½æ•°æˆ–è¡¨è¾¾å¼ã€‚"><a href="#æƒ…å†µä¸ƒï¼šæŸ¥è¯¢æ¡ä»¶ä¸­å«æœ‰å‡½æ•°æˆ–è¡¨è¾¾å¼ã€‚" class="headerlink" title="æƒ…å†µä¸ƒï¼šæŸ¥è¯¢æ¡ä»¶ä¸­å«æœ‰å‡½æ•°æˆ–è¡¨è¾¾å¼ã€‚"></a>æƒ…å†µä¸ƒï¼šæŸ¥è¯¢æ¡ä»¶ä¸­å«æœ‰å‡½æ•°æˆ–è¡¨è¾¾å¼ã€‚</h3><p>å¾ˆä¸å¹¸ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸­å«æœ‰å‡½æ•°æˆ–è¡¨è¾¾å¼ï¼Œåˆ™MySQLä¸ä¼šä¸ºè¿™åˆ—ä½¿ç”¨ç´¢å¼•ï¼ˆè™½ç„¶æŸäº›åœ¨æ•°å­¦æ„ä¹‰ä¸Šå¯ä»¥ä½¿ç”¨ï¼‰ã€‚ä¾‹å¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE emp_no=&apos;10001&apos; AND left(title, 6)=&apos;Senior&apos;;</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------------+</span><br><span class="line">| id | select_type | table  | type | possible_keys | key     | key_len | ref   | rows | Extra       |</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | ref  | PRIMARY       | PRIMARY | 4       | const |    1 | Using where |</span><br><span class="line">+----+-------------+--------+------+---------------+---------+---------+-------+------+-------------+</span><br></pre></td></tr></table></figure></p>
<p>è™½ç„¶è¿™ä¸ªæŸ¥è¯¢å’Œæƒ…å†µäº”ä¸­åŠŸèƒ½ç›¸åŒï¼Œä½†æ˜¯ç”±äºä½¿ç”¨äº†å‡½æ•°leftï¼Œåˆ™æ— æ³•ä¸ºtitleåˆ—åº”ç”¨ç´¢å¼•ï¼Œè€Œæƒ…å†µäº”ä¸­ç”¨LIKEåˆ™å¯ä»¥ã€‚å†å¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.titles WHERE emp_no - 1=&apos;10000&apos;;</span><br><span class="line">+----+-------------+--------+------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows   | Extra       |</span><br><span class="line">+----+-------------+--------+------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | titles | ALL  | NULL          | NULL | NULL    | NULL | 443308 | Using where |</span><br><span class="line">+----+-------------+--------+------+---------------+------+---------+------+--------+-------------+</span><br></pre></td></tr></table></figure></p>
<p>æ˜¾ç„¶è¿™ä¸ªæŸ¥è¯¢ç­‰ä»·äºæŸ¥è¯¢emp_noä¸º10001çš„å‡½æ•°ï¼Œä½†æ˜¯ç”±äºæŸ¥è¯¢æ¡ä»¶æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼ŒMySQLæ— æ³•ä¸ºå…¶ä½¿ç”¨ç´¢å¼•ã€‚çœ‹æ¥MySQLè¿˜æ²¡æœ‰æ™ºèƒ½åˆ°è‡ªåŠ¨ä¼˜åŒ–å¸¸é‡è¡¨è¾¾å¼çš„ç¨‹åº¦ï¼Œå› æ­¤åœ¨å†™æŸ¥è¯¢è¯­å¥æ—¶å°½é‡é¿å…è¡¨è¾¾å¼å‡ºç°åœ¨æŸ¥è¯¢ä¸­ï¼Œè€Œæ˜¯å…ˆæ‰‹å·¥ç§ä¸‹ä»£æ•°è¿ç®—ï¼Œè½¬æ¢ä¸ºæ— è¡¨è¾¾å¼çš„æŸ¥è¯¢è¯­å¥ã€‚</p>
<h2 id="ç´¢å¼•é€‰æ‹©æ€§ä¸å‰ç¼€ç´¢å¼•"><a href="#ç´¢å¼•é€‰æ‹©æ€§ä¸å‰ç¼€ç´¢å¼•" class="headerlink" title="ç´¢å¼•é€‰æ‹©æ€§ä¸å‰ç¼€ç´¢å¼•"></a>ç´¢å¼•é€‰æ‹©æ€§ä¸å‰ç¼€ç´¢å¼•</h2><p>æ—¢ç„¶ç´¢å¼•å¯ä»¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯åªè¦æ˜¯æŸ¥è¯¢è¯­å¥éœ€è¦ï¼Œå°±å»ºä¸Šç´¢å¼•ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚å› ä¸ºç´¢å¼•è™½ç„¶åŠ å¿«äº†æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†ç´¢å¼•ä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ï¼šç´¢å¼•æ–‡ä»¶æœ¬èº«è¦æ¶ˆè€—å­˜å‚¨ç©ºé—´ï¼ŒåŒæ—¶ç´¢å¼•ä¼šåŠ é‡æ’å…¥ã€åˆ é™¤å’Œä¿®æ”¹è®°å½•æ—¶çš„è´Ÿæ‹…ï¼Œå¦å¤–ï¼ŒMySQLåœ¨è¿è¡Œæ—¶ä¹Ÿè¦æ¶ˆè€—èµ„æºç»´æŠ¤ç´¢å¼•ï¼Œå› æ­¤ç´¢å¼•å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ã€‚ä¸€èˆ¬ä¸¤ç§æƒ…å†µä¸‹ä¸å»ºè®®å»ºç´¢å¼•ã€‚</p>
<p>ç¬¬ä¸€ç§æƒ…å†µæ˜¯è¡¨è®°å½•æ¯”è¾ƒå°‘ï¼Œä¾‹å¦‚ä¸€ä¸¤åƒæ¡ç”šè‡³åªæœ‰å‡ ç™¾æ¡è®°å½•çš„è¡¨ï¼Œæ²¡å¿…è¦å»ºç´¢å¼•ï¼Œè®©æŸ¥è¯¢åšå…¨è¡¨æ‰«æå°±å¥½äº†ã€‚è‡³äºå¤šå°‘æ¡è®°å½•æ‰ç®—å¤šï¼Œè¿™ä¸ªä¸ªäººæœ‰ä¸ªäººçš„çœ‹æ³•ï¼Œæˆ‘ä¸ªäººçš„ç»éªŒæ˜¯ä»¥2000ä½œä¸ºåˆ†ç•Œçº¿ï¼Œè®°å½•æ•°ä¸è¶…è¿‡ 2000å¯ä»¥è€ƒè™‘ä¸å»ºç´¢å¼•ï¼Œè¶…è¿‡2000æ¡å¯ä»¥é…Œæƒ…è€ƒè™‘ç´¢å¼•ã€‚</p>
<p>å¦ä¸€ç§ä¸å»ºè®®å»ºç´¢å¼•çš„æƒ…å†µæ˜¯ç´¢å¼•çš„é€‰æ‹©æ€§è¾ƒä½ã€‚æ‰€è°“ç´¢å¼•çš„é€‰æ‹©æ€§ï¼ˆSelectivityï¼‰ï¼Œæ˜¯æŒ‡ä¸é‡å¤çš„ç´¢å¼•å€¼ï¼ˆä¹Ÿå«åŸºæ•°ï¼ŒCardinalityï¼‰ä¸è¡¨è®°å½•æ•°ï¼ˆ#Tï¼‰çš„æ¯”å€¼ï¼š</p>
<p>Index Selectivity = Cardinality / #T</p>
<p>æ˜¾ç„¶é€‰æ‹©æ€§çš„å–å€¼èŒƒå›´ä¸º(0, 1]ï¼Œé€‰æ‹©æ€§è¶Šé«˜çš„ç´¢å¼•ä»·å€¼è¶Šå¤§ï¼Œè¿™æ˜¯ç”±B+Treeçš„æ€§è´¨å†³å®šçš„ã€‚ä¾‹å¦‚ï¼Œä¸Šæ–‡ç”¨åˆ°çš„employees.titlesè¡¨ï¼Œå¦‚æœtitleå­—æ®µç»å¸¸è¢«å•ç‹¬æŸ¥è¯¢ï¼Œæ˜¯å¦éœ€è¦å»ºç´¢å¼•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„é€‰æ‹©æ€§ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(<span class="keyword">DISTINCT</span>(title))/<span class="keyword">count</span>(*) <span class="keyword">AS</span> Selectivity <span class="keyword">FROM</span> employees.titles;</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">| Selectivity |</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">|      0.0000 |</span><br><span class="line">+<span class="comment">-------------+</span></span><br></pre></td></tr></table></figure></p>
<p>titleçš„é€‰æ‹©æ€§ä¸è¶³0.0001ï¼ˆç²¾ç¡®å€¼ä¸º0.00001579ï¼‰ï¼Œæ‰€ä»¥å®åœ¨æ²¡æœ‰ä»€ä¹ˆå¿…è¦ä¸ºå…¶å•ç‹¬å»ºç´¢å¼•ã€‚</p>
<p>æœ‰ä¸€ç§ä¸ç´¢å¼•é€‰æ‹©æ€§æœ‰å…³çš„ç´¢å¼•ä¼˜åŒ–ç­–ç•¥å«åšå‰ç¼€ç´¢å¼•ï¼Œå°±æ˜¯ç”¨åˆ—çš„å‰ç¼€ä»£æ›¿æ•´ä¸ªåˆ—ä½œä¸ºç´¢å¼•keyï¼Œå½“å‰ç¼€é•¿åº¦åˆé€‚æ—¶ï¼Œå¯ä»¥åšåˆ°æ—¢ä½¿å¾—å‰ç¼€ç´¢å¼•çš„é€‰æ‹©æ€§æ¥è¿‘å…¨åˆ—ç´¢å¼•ï¼ŒåŒæ—¶å› ä¸ºç´¢å¼•keyå˜çŸ­è€Œå‡å°‘äº†ç´¢å¼•æ–‡ä»¶çš„å¤§å°å’Œç»´æŠ¤å¼€é”€ã€‚ä¸‹é¢ä»¥employees.employeesè¡¨ä¸ºä¾‹ä»‹ç»å‰ç¼€ç´¢å¼•çš„é€‰æ‹©å’Œä½¿ç”¨ã€‚</p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°employeesè¡¨åªæœ‰ä¸€ä¸ªç´¢å¼•<code>&lt;emp_no&gt;</code>ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³æŒ‰åå­—æœç´¢ä¸€ä¸ªäººï¼Œå°±åªèƒ½å…¨è¡¨æ‰«æäº†ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM employees.employees WHERE first_name=&apos;Eric&apos; AND last_name=&apos;Anido&apos;;</span><br><span class="line">+----+-------------+-----------+------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">| id | select_type | table     | type | possible_keys | key  | key_len | ref  | rows   | Extra       |</span><br><span class="line">+----+-------------+-----------+------+---------------+------+---------+------+--------+-------------+</span><br><span class="line">|  1 | SIMPLE      | employees | ALL  | NULL          | NULL | NULL    | NULL | 300024 | Using where |</span><br><span class="line">+----+-------------+-----------+------+---------------+------+---------+------+--------+-------------+</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœé¢‘ç¹æŒ‰åå­—æœç´¢å‘˜å·¥ï¼Œè¿™æ ·æ˜¾ç„¶æ•ˆç‡å¾ˆä½ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘å»ºç´¢å¼•ã€‚æœ‰ä¸¤ç§é€‰æ‹©ï¼Œå»º<code>&lt;first_name&gt;</code>æˆ–<code>&lt;first_name, last_name&gt;</code>ï¼Œçœ‹ä¸‹ä¸¤ä¸ªç´¢å¼•çš„é€‰æ‹©æ€§ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(<span class="keyword">DISTINCT</span>(first_name))/<span class="keyword">count</span>(*) <span class="keyword">AS</span> Selectivity <span class="keyword">FROM</span> employees.employees;</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">| Selectivity |</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">|      0.0042 |</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(<span class="keyword">DISTINCT</span>(<span class="keyword">concat</span>(first_name, last_name)))/<span class="keyword">count</span>(*) <span class="keyword">AS</span> Selectivity <span class="keyword">FROM</span> employees.employees;</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">| Selectivity |</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">|      0.9313 |</span><br><span class="line">+<span class="comment">-------------+</span></span><br></pre></td></tr></table></figure></p>
<p><code>&lt;first_name&gt;</code>æ˜¾ç„¶é€‰æ‹©æ€§å¤ªä½ï¼Œ<code>&lt;first_name, last_name&gt;</code>é€‰æ‹©æ€§å¾ˆå¥½ï¼Œä½†æ˜¯first_nameå’Œlast_nameåŠ èµ·æ¥é•¿åº¦ä¸º30ï¼Œæœ‰æ²¡æœ‰å…¼é¡¾é•¿åº¦å’Œé€‰æ‹©æ€§çš„åŠæ³•ï¼Ÿå¯ä»¥è€ƒè™‘ç”¨first_nameå’Œlast_nameçš„å‰å‡ ä¸ªå­—ç¬¦å»ºç«‹ç´¢å¼•ï¼Œä¾‹å¦‚<code>&lt;first_name, left(last_name, 3)&gt;</code>ï¼Œçœ‹çœ‹å…¶é€‰æ‹©æ€§ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(<span class="keyword">DISTINCT</span>(<span class="keyword">concat</span>(first_name, <span class="keyword">left</span>(last_name, <span class="number">3</span>))))/<span class="keyword">count</span>(*) <span class="keyword">AS</span> Selectivity <span class="keyword">FROM</span> employees.employees;</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">| Selectivity |</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">|      0.7879 |</span><br><span class="line">+<span class="comment">-------------+</span></span><br></pre></td></tr></table></figure></p>
<p>é€‰æ‹©æ€§è¿˜ä¸é”™ï¼Œä½†ç¦»0.9313è¿˜æ˜¯æœ‰ç‚¹è·ç¦»ï¼Œé‚£ä¹ˆæŠŠlast_nameå‰ç¼€åŠ åˆ°4ï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(<span class="keyword">DISTINCT</span>(<span class="keyword">concat</span>(first_name, <span class="keyword">left</span>(last_name, <span class="number">4</span>))))/<span class="keyword">count</span>(*) <span class="keyword">AS</span> Selectivity <span class="keyword">FROM</span> employees.employees;</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">| Selectivity |</span><br><span class="line">+<span class="comment">-------------+</span></span><br><span class="line">|      0.9007 |</span><br><span class="line">+<span class="comment">-------------+</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™æ—¶é€‰æ‹©æ€§å·²ç»å¾ˆç†æƒ³äº†ï¼Œè€Œè¿™ä¸ªç´¢å¼•çš„é•¿åº¦åªæœ‰18ï¼Œæ¯”<code>&lt;first_name, last_name&gt;</code>çŸ­äº†æ¥è¿‘ä¸€åŠï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå‰ç¼€ç´¢å¼• å»ºä¸Šï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> employees.employees</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">INDEX</span> <span class="string">`first_name_last_name4`</span> (first_name, last_name(<span class="number">4</span>));</span><br></pre></td></tr></table></figure></p>
<p>æ­¤æ—¶å†æ‰§è¡Œä¸€éæŒ‰åå­—æŸ¥è¯¢ï¼Œæ¯”è¾ƒåˆ†æä¸€ä¸‹ä¸å»ºç´¢å¼•å‰çš„ç»“æœï¼š<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROFILES</span>;</span><br><span class="line">+<span class="comment">----------+------------+---------------------------------------------------------------------------------+</span></span><br><span class="line">| Query_ID | Duration   | Query                                                                           |</span><br><span class="line">+<span class="comment">----------+------------+---------------------------------------------------------------------------------+</span></span><br><span class="line">|       87 | 0.11941700 | <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> employees.employees <span class="keyword">WHERE</span> first_name=<span class="string">'Eric'</span> <span class="keyword">AND</span> last_name=<span class="string">'Anido'</span> |</span><br><span class="line">|       <span class="number">90</span> | <span class="number">0.00092400</span> | <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> employees.employees <span class="keyword">WHERE</span> first_name=<span class="string">'Eric'</span> <span class="keyword">AND</span> last_name=<span class="string">'Anido'</span> |</span><br><span class="line">+<span class="comment">----------+------------+---------------------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure></p>
<p>æ€§èƒ½çš„æå‡æ˜¯æ˜¾è‘—çš„ï¼ŒæŸ¥è¯¢é€Ÿåº¦æé«˜äº†120å¤šå€ã€‚</p>
<p>å‰ç¼€ç´¢å¼•å…¼é¡¾ç´¢å¼•å¤§å°å’ŒæŸ¥è¯¢é€Ÿåº¦ï¼Œä½†æ˜¯å…¶ç¼ºç‚¹æ˜¯ä¸èƒ½ç”¨äºORDER BYå’ŒGROUP BYæ“ä½œï¼Œä¹Ÿä¸èƒ½ç”¨äºCovering indexï¼ˆå³å½“ç´¢å¼•æœ¬èº«åŒ…å«æŸ¥è¯¢æ‰€éœ€å…¨éƒ¨æ•°æ®æ—¶ï¼Œä¸å†è®¿é—®æ•°æ®æ–‡ä»¶æœ¬èº«ï¼‰ã€‚</p>
<h2 id="InnoDBçš„ä¸»é”®é€‰æ‹©ä¸æ’å…¥ä¼˜åŒ–"><a href="#InnoDBçš„ä¸»é”®é€‰æ‹©ä¸æ’å…¥ä¼˜åŒ–" class="headerlink" title="InnoDBçš„ä¸»é”®é€‰æ‹©ä¸æ’å…¥ä¼˜åŒ–"></a>InnoDBçš„ä¸»é”®é€‰æ‹©ä¸æ’å…¥ä¼˜åŒ–</h2><p>åœ¨ä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„éœ€è¦ï¼Œè¯·æ°¸è¿œä½¿ç”¨ä¸€ä¸ªä¸ä¸šåŠ¡æ— å…³çš„è‡ªå¢å­—æ®µä½œä¸ºä¸»é”®ã€‚</p>
<p>ç»å¸¸çœ‹åˆ°æœ‰å¸–å­æˆ–åšå®¢è®¨è®ºä¸»é”®é€‰æ‹©é—®é¢˜ï¼Œæœ‰äººå»ºè®®ä½¿ç”¨ä¸šåŠ¡æ— å…³çš„è‡ªå¢ä¸»é”®ï¼Œæœ‰äººè§‰å¾—æ²¡æœ‰å¿…è¦ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨å¦‚å­¦å·æˆ–èº«ä»½è¯å·è¿™ç§å”¯ä¸€å­—æ®µä½œä¸ºä¸»é”®ã€‚ä¸è®ºæ”¯æŒå“ªç§è®ºç‚¹ï¼Œå¤§å¤šæ•°è®ºæ®éƒ½æ˜¯ä¸šåŠ¡å±‚é¢çš„ã€‚å¦‚æœä»æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–è§’åº¦çœ‹ï¼Œä½¿ç”¨InnoDBå¼•æ“è€Œä¸ä½¿ç”¨è‡ªå¢ä¸»é”®ç»å¯¹æ˜¯ä¸€ä¸ªç³Ÿç³•çš„ä¸»æ„ã€‚</p>
<p>ä¸Šæ–‡è®¨è®ºè¿‡InnoDBçš„ç´¢å¼•å®ç°ï¼ŒInnoDBä½¿ç”¨èšé›†ç´¢å¼•ï¼Œæ•°æ®è®°å½•æœ¬èº«è¢«å­˜äºä¸»ç´¢å¼•ï¼ˆä¸€é¢—B+Treeï¼‰çš„å¶å­èŠ‚ç‚¹ä¸Šã€‚è¿™å°±è¦æ±‚åŒä¸€ä¸ªå¶å­èŠ‚ç‚¹å†…ï¼ˆå¤§å°ä¸ºä¸€ä¸ªå†…å­˜é¡µæˆ–ç£ç›˜é¡µï¼‰çš„å„æ¡æ•°æ®è®°å½•æŒ‰ä¸»é”®é¡ºåºå­˜æ”¾ï¼Œå› æ­¤æ¯å½“æœ‰ä¸€æ¡æ–°çš„è®°å½•æ’å…¥æ—¶ï¼ŒMySQLä¼šæ ¹æ®å…¶ä¸»é”®å°†å…¶æ’å…¥é€‚å½“çš„èŠ‚ç‚¹å’Œä½ç½®ï¼Œå¦‚æœé¡µé¢è¾¾åˆ°è£…è½½å› å­ï¼ˆInnoDBé»˜è®¤ä¸º15/16ï¼‰ï¼Œåˆ™å¼€è¾Ÿä¸€ä¸ªæ–°çš„é¡µï¼ˆèŠ‚ç‚¹ï¼‰ã€‚</p>
<p>å¦‚æœè¡¨ä½¿ç”¨è‡ªå¢ä¸»é”®ï¼Œé‚£ä¹ˆæ¯æ¬¡æ’å…¥æ–°çš„è®°å½•ï¼Œè®°å½•å°±ä¼šé¡ºåºæ·»åŠ åˆ°å½“å‰ç´¢å¼•èŠ‚ç‚¹çš„åç»­ä½ç½®ï¼Œå½“ä¸€é¡µå†™æ»¡ï¼Œå°±ä¼šè‡ªåŠ¨å¼€è¾Ÿä¸€ä¸ªæ–°çš„é¡µã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="http://idiotsky.top/images2/b-tree-13.png"><img src="http://idiotsky.top/images2/b-tree-13.png" alt=""></a></p>
<p>è¿™æ ·å°±ä¼šå½¢æˆä¸€ä¸ªç´§å‡‘çš„ç´¢å¼•ç»“æ„ï¼Œè¿‘ä¼¼é¡ºåºå¡«æ»¡ã€‚ç”±äºæ¯æ¬¡æ’å…¥æ—¶ä¹Ÿä¸éœ€è¦ç§»åŠ¨å·²æœ‰æ•°æ®ï¼Œå› æ­¤æ•ˆç‡å¾ˆé«˜ï¼Œä¹Ÿä¸ä¼šå¢åŠ å¾ˆå¤šå¼€é”€åœ¨ç»´æŠ¤ç´¢å¼•ä¸Šã€‚</p>
<p>å¦‚æœä½¿ç”¨éè‡ªå¢ä¸»é”®ï¼ˆå¦‚æœèº«ä»½è¯å·æˆ–å­¦å·ç­‰ï¼‰ï¼Œç”±äºæ¯æ¬¡æ’å…¥ä¸»é”®çš„å€¼è¿‘ä¼¼äºéšæœºï¼Œå› æ­¤æ¯æ¬¡æ–°çºªå½•éƒ½è¦è¢«æ’åˆ°ç°æœ‰ç´¢å¼•é¡µå¾—ä¸­é—´æŸä¸ªä½ç½®ï¼š</p>
<p><a href="http://idiotsky.top/images2/b-tree-14.png"><img src="http://idiotsky.top/images2/b-tree-14.png" alt=""></a></p>
<p>æ­¤æ—¶MySQLä¸å¾—ä¸ä¸ºäº†å°†æ–°è®°å½•æ’åˆ°åˆé€‚ä½ç½®è€Œç§»åŠ¨æ•°æ®ï¼Œç”šè‡³ç›®æ ‡é¡µé¢å¯èƒ½å·²ç»è¢«å›å†™åˆ°ç£ç›˜ä¸Šè€Œä»ç¼“å­˜ä¸­æ¸…æ‰ï¼Œæ­¤æ—¶åˆè¦ä»ç£ç›˜ä¸Šè¯»å›æ¥ï¼Œè¿™å¢åŠ äº†å¾ˆå¤šå¼€é”€ï¼ŒåŒæ—¶é¢‘ç¹çš„ç§»åŠ¨ã€åˆ†é¡µæ“ä½œé€ æˆäº†å¤§é‡çš„ç¢ç‰‡ï¼Œå¾—åˆ°äº†ä¸å¤Ÿç´§å‡‘çš„ç´¢å¼•ç»“æ„ï¼Œåç»­ä¸å¾—ä¸é€šè¿‡OPTIMIZE TABLEæ¥é‡å»ºè¡¨å¹¶ä¼˜åŒ–å¡«å……é¡µé¢ã€‚</p>
<p>å› æ­¤ï¼Œåªè¦å¯ä»¥ï¼Œè¯·å°½é‡åœ¨InnoDBä¸Šé‡‡ç”¨è‡ªå¢å­—æ®µåšä¸»é”®ã€‚</p>
<p>from <a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html" target="_blank" rel="noopener">http://blog.codinglabs.org/articles/theory-of-mysql-index.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è½¬ä¸€ä¸ªä¸é”™çš„æ–‡ç« ï¼Œé‡Œé¢çš„å¹²è´§è¿˜æ˜¯å¾ˆå¤šçš„ï¼ŒåŒ…æ‹¬å±€éƒ¨æ€§ï¼Œç¡¬ç›˜ç­‰æ•°æ®åº“ä»¥å¤–çš„ä¸œè¥¿ï¼ŒMarkä¹‹ğŸ‘¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;æ•°æ®ç»“æ„åŠç®—æ³•åŸºç¡€&quot;&gt;&lt;a href=&quot;#æ•°æ®ç»“æ„åŠç®—æ³•åŸºç¡€&quot; class=&quot;headerlink&quot; title=&quot;æ•°æ®ç»“æ„åŠç®—æ³•åŸºç¡€&quot;&gt;&lt;/a&gt;æ•°æ®ç»“æ„åŠç®—æ³•åŸºç¡€&lt;/h1&gt;&lt;h2 id=&quot;ç´¢å¼•çš„æœ¬è´¨&quot;&gt;&lt;a href=&quot;#ç´¢å¼•çš„æœ¬è´¨&quot; class=&quot;headerlink&quot; title=&quot;ç´¢å¼•çš„æœ¬è´¨&quot;&gt;&lt;/a&gt;ç´¢å¼•çš„æœ¬è´¨&lt;/h2&gt;&lt;p&gt;MySQLå®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•ï¼ˆIndexï¼‰æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ã€‚æå–å¥å­ä¸»å¹²ï¼Œå°±å¯ä»¥å¾—åˆ°ç´¢å¼•çš„æœ¬è´¨ï¼šç´¢å¼•æ˜¯æ•°æ®ç»“æ„ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬çŸ¥é“ï¼Œæ•°æ®åº“æŸ¥è¯¢æ˜¯æ•°æ®åº“çš„æœ€ä¸»è¦åŠŸèƒ½ä¹‹ä¸€ã€‚æˆ‘ä»¬éƒ½å¸Œæœ›æŸ¥è¯¢æ•°æ®çš„é€Ÿåº¦èƒ½å°½å¯èƒ½çš„å¿«ï¼Œå› æ­¤æ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡è€…ä¼šä»æŸ¥è¯¢ç®—æ³•çš„è§’åº¦è¿›è¡Œä¼˜åŒ–ã€‚æœ€åŸºæœ¬çš„æŸ¥è¯¢ç®—æ³•å½“ç„¶æ˜¯&lt;a href=&quot;http://en.wikipedia.org/wiki/Linear_search&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;é¡ºåºæŸ¥æ‰¾&lt;/a&gt;ï¼ˆlinear searchï¼‰ï¼Œè¿™ç§å¤æ‚åº¦ä¸ºO(n)çš„ç®—æ³•åœ¨æ•°æ®é‡å¾ˆå¤§æ—¶æ˜¾ç„¶æ˜¯ç³Ÿç³•çš„ï¼Œå¥½åœ¨è®¡ç®—æœºç§‘å­¦çš„å‘å±•æä¾›äº†å¾ˆå¤šæ›´ä¼˜ç§€çš„æŸ¥æ‰¾ç®—æ³•ï¼Œä¾‹å¦‚&lt;a href=&quot;http://en.wikipedia.org/wiki/Binary_search_algorithm&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;äºŒåˆ†æŸ¥æ‰¾&lt;/a&gt;ï¼ˆbinary searchï¼‰ã€&lt;a href=&quot;http://en.wikipedia.org/wiki/Binary_search_tree&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;äºŒå‰æ ‘æŸ¥æ‰¾æ ‘&lt;/a&gt;ï¼ˆbinary tree searchï¼‰ç­‰ã€‚å¦‚æœç¨å¾®åˆ†æä¸€ä¸‹ä¼šå‘ç°ï¼Œæ¯ç§æŸ¥æ‰¾ç®—æ³•éƒ½åªèƒ½åº”ç”¨äºç‰¹å®šçš„æ•°æ®ç»“æ„ä¹‹ä¸Šï¼Œä¾‹å¦‚äºŒåˆ†æŸ¥æ‰¾è¦æ±‚è¢«æ£€ç´¢æ•°æ®æœ‰åºï¼Œè€ŒäºŒå‰æ ‘æŸ¥æ‰¾åªèƒ½åº”ç”¨äº&lt;a href=&quot;http://en.wikipedia.org/wiki/Binary_search_tree&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;äºŒå‰æŸ¥æ‰¾æ ‘&lt;/a&gt;ä¸Šï¼Œä½†æ˜¯æ•°æ®æœ¬èº«çš„ç»„ç»‡ç»“æ„ä¸å¯èƒ½å®Œå…¨æ»¡è¶³å„ç§æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚ï¼Œç†è®ºä¸Šä¸å¯èƒ½åŒæ—¶å°†ä¸¤åˆ—éƒ½æŒ‰é¡ºåºè¿›è¡Œç»„ç»‡ï¼‰ï¼Œæ‰€ä»¥ï¼Œåœ¨æ•°æ®ä¹‹å¤–ï¼Œæ•°æ®åº“ç³»ç»Ÿè¿˜ç»´æŠ¤ç€æ»¡è¶³ç‰¹å®šæŸ¥æ‰¾ç®—æ³•çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼å¼•ç”¨ï¼ˆæŒ‡å‘ï¼‰æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„ä¸Šå®ç°é«˜çº§æŸ¥æ‰¾ç®—æ³•ã€‚è¿™ç§æ•°æ®ç»“æ„ï¼Œå°±æ˜¯ç´¢å¼•ã€‚&lt;/p&gt;
&lt;p&gt;çœ‹ä¸€ä¸ªä¾‹å­ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://idiotsky.top/images2/b-tree-1.png&quot;&gt;&lt;img src=&quot;http://idiotsky.top/images2/b-tree-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="http://idiotsky.top/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://idiotsky.top/tags/mysql/"/>
    
      <category term="Bæ ‘" scheme="http://idiotsky.top/tags/B%E6%A0%91/"/>
    
      <category term="B+æ ‘" scheme="http://idiotsky.top/tags/B-%E6%A0%91/"/>
    
  </entry>
  
</feed>
