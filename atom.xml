<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>IdiotSky</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://idiotsky.me/"/>
  <updated>2017-08-20T08:44:22.000Z</updated>
  <id>http://idiotsky.me/</id>
  
  <author>
    <name>ejunjsh</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>openstackå®‰è£…å‡†å¤‡(ä¸€)</title>
    <link href="http://idiotsky.me/2017/08/18/openstack-install-prepare-1/"/>
    <id>http://idiotsky.me/2017/08/18/openstack-install-prepare-1/</id>
    <published>2017-08-18T14:50:07.000Z</published>
    <updated>2017-08-20T08:44:22.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>æ­£åœ¨å†™ã€‚ã€‚ã€‚</p>
</blockquote>
<h1 id="å‡†å¤‡VMware"><a href="#å‡†å¤‡VMware" class="headerlink" title="å‡†å¤‡VMware"></a>å‡†å¤‡VMware</h1><p>ç”±äºæˆ‘æ˜¯ä¹ æƒ¯äº†macä¸Šåšå®éªŒï¼Œæ‰€ä»¥ç”¨VMware fusionï¼Œéšä¾¿ä¸‹ä¸ªç ´è§£ç‰ˆå³å¯ã€‚</p>
<h1 id="å‡†å¤‡Ubuntu"><a href="#å‡†å¤‡Ubuntu" class="headerlink" title="å‡†å¤‡Ubuntu"></a>å‡†å¤‡Ubuntu</h1><p>Ubuntuå»å®˜ç½‘ä¸‹è½½16.04çš„æœåŠ¡å™¨ç‰ˆæœ¬çš„ISOå³å¯ã€‚</p>
<a id="more"></a>
<h1 id="å‡†å¤‡ç½‘ç»œ"><a href="#å‡†å¤‡ç½‘ç»œ" class="headerlink" title="å‡†å¤‡ç½‘ç»œ"></a>å‡†å¤‡ç½‘ç»œ</h1><p>è¿™æ¬¡å®éªŒç”¨åˆ°ä¸¤å°è™šæ‹Ÿæœºï¼š controller,compute<br>hostname:controller</p>
<table>
<thead>
<tr>
<th>æ¥å£</th>
<th>ip</th>
<th>æ¨¡å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>ens33</td>
<td>192.168.199.10</td>
<td>æ¡¥æ¥</td>
</tr>
<tr>
<td>ens34</td>
<td>192.168.5.10</td>
<td>ç§æœ‰</td>
</tr>
<tr>
<td>ens35</td>
<td>192.168.112.10</td>
<td>nat</td>
</tr>
</tbody>
</table>
<p>hostname:compute</p>
<table>
<thead>
<tr>
<th>æ¥å£</th>
<th>ip</th>
<th>æ¨¡å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>ens33</td>
<td>192.168.199.11</td>
<td>æ¡¥æ¥</td>
</tr>
<tr>
<td>ens34</td>
<td>192.168.5.11</td>
<td>ç§æœ‰</td>
</tr>
</tbody>
</table>
<p>PS:<br>æ¡¥æ¥æ¨¡å¼æ˜¯è™šæ‹Ÿæœºå¯ä»¥æ›´ç‰©ç†æœºæ‰€åœ¨ç½‘ç»œå…±äº«ä¸€å¥—ç½‘ç»œï¼Œä¾‹å¦‚è·Ÿç‰©ç†æœºåŒä¸€ä¸ªWiFié‡Œé¢çš„è®¾å¤‡éƒ½å¯ä»¥è®¿é—®ç‰©ç†æœºé‡Œé¢çš„è™šæ‹Ÿæœºã€‚ä¸€èˆ¬ç”¨æ¥åšç®¡ç†èŠ‚ç‚¹çš„ç½‘ç»œã€‚<br>ç§æœ‰æ¨¡å¼ä»£è¡¨è™šæ‹Ÿæœºåªèƒ½è·Ÿç‰©ç†æœºä½œä¸ºä¸€ä¸ªç½‘ç»œï¼Œå…¶ä»–è®¾å¤‡è®¿é—®ä¸äº†ï¼Œä¸€èˆ¬å¯ä»¥ç”¨æ¥åšå†…éƒ¨ç½‘ç»œ<br>natæ¨¡å¼ç”¨æ¥ç»™è™šæ‹Ÿæœºè®¿é—®äº’è”ç½‘ç”¨</p>
<p>ä¸Šé¢ç½‘ç»œé…ç½®å¥½åï¼Œå¯ä»¥å¼€æäº†ï¼Œè‡³äºæ€ä¹ˆå®‰è£…è™šæ‹Ÿæœºå’Œé…ç½®ç½‘ç»œï¼Œå¯ä»¥æœç´¢ç›¸å…³æ–‡ç« ğŸ˜ˆã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æ­£åœ¨å†™ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;å‡†å¤‡VMware&quot;&gt;&lt;a href=&quot;#å‡†å¤‡VMware&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡VMware&quot;&gt;&lt;/a&gt;å‡†å¤‡VMware&lt;/h1&gt;&lt;p&gt;ç”±äºæˆ‘æ˜¯ä¹ æƒ¯äº†macä¸Šåšå®éªŒï¼Œæ‰€ä»¥ç”¨VMware fusionï¼Œéšä¾¿ä¸‹ä¸ªç ´è§£ç‰ˆå³å¯ã€‚&lt;/p&gt;
&lt;h1 id=&quot;å‡†å¤‡Ubuntu&quot;&gt;&lt;a href=&quot;#å‡†å¤‡Ubuntu&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡Ubuntu&quot;&gt;&lt;/a&gt;å‡†å¤‡Ubuntu&lt;/h1&gt;&lt;p&gt;Ubuntuå»å®˜ç½‘ä¸‹è½½16.04çš„æœåŠ¡å™¨ç‰ˆæœ¬çš„ISOå³å¯ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="openstack" scheme="http://idiotsky.me/categories/openstack/"/>
    
    
      <category term="openstack" scheme="http://idiotsky.me/tags/openstack/"/>
    
      <category term="ubuntu" scheme="http://idiotsky.me/tags/ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>openstackå®‰è£…ç´¢å¼•</title>
    <link href="http://idiotsky.me/2017/08/16/openstack-install-index/"/>
    <id>http://idiotsky.me/2017/08/16/openstack-install-index/</id>
    <published>2017-08-15T17:58:47.000Z</published>
    <updated>2017-08-18T14:52:18.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ç´¢å¼•é¡µ</p>
</blockquote>
<p><a href="/2017/08/18/openstack-install-prepare-1/">openstackå®‰è£…å‡†å¤‡(ä¸€)</a><br><a id="more"></a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç´¢å¼•é¡µ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;/2017/08/18/openstack-install-prepare-1/&quot;&gt;openstackå®‰è£…å‡†å¤‡(ä¸€)&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="openstack" scheme="http://idiotsky.me/categories/openstack/"/>
    
    
      <category term="openstack" scheme="http://idiotsky.me/tags/openstack/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€å¼ å›¾äº†è§£ä¸‰è‰²æ ‡è®°æ³•</title>
    <link href="http://idiotsky.me/2017/08/16/gc-three-color/"/>
    <id>http://idiotsky.me/2017/08/16/gc-three-color/</id>
    <published>2017-08-15T17:02:35.000Z</published>
    <updated>2017-08-20T03:32:45.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/images/gc-1.gif"><img src="/images/gc-1.gif" alt=""></a><br><a id="more"></a><br>ä¸‰è‰²æ ‡è®°æ³•æ˜¯ä¼ ç»Ÿ Mark-Sweep çš„ä¸€ä¸ªæ”¹è¿›ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¹¶å‘çš„ GC ç®—æ³•ã€‚<br>åŸç†å¦‚ä¸‹ï¼Œ</p>
<ol>
<li>é¦–å…ˆåˆ›å»ºä¸‰ä¸ªé›†åˆï¼šç™½ã€ç°ã€é»‘ã€‚</li>
<li>å°†æ‰€æœ‰å¯¹è±¡æ”¾å…¥ç™½è‰²é›†åˆä¸­ã€‚</li>
<li>ç„¶åä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†æ‰€æœ‰å¯¹è±¡ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸<strong>é€’å½’éå†</strong>ï¼‰ï¼ŒæŠŠéå†åˆ°çš„å¯¹è±¡ä»ç™½è‰²é›†åˆæ”¾å…¥ç°è‰²é›†åˆã€‚</li>
<li>ä¹‹åéå†ç°è‰²é›†åˆï¼Œå°†ç°è‰²å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ä»ç™½è‰²é›†åˆæ”¾å…¥ç°è‰²é›†åˆï¼Œä¹‹åå°†æ­¤ç°è‰²å¯¹è±¡æ”¾å…¥é»‘è‰²é›†åˆ</li>
<li>é‡å¤ 4 ç›´åˆ°ç°è‰²ä¸­æ— ä»»ä½•å¯¹è±¡</li>
<li>é€šè¿‡write-barrieræ£€æµ‹å¯¹è±¡æœ‰å˜åŒ–ï¼Œé‡å¤ä»¥ä¸Šæ“ä½œ</li>
<li>æ”¶é›†æ‰€æœ‰ç™½è‰²å¯¹è±¡ï¼ˆåƒåœ¾ï¼‰</li>
</ol>
<p>è¿™ä¸ªç®—æ³•å¯ä»¥å®ç° â€œon-the-flyâ€ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¨‹åºæ‰§è¡Œçš„åŒæ—¶è¿›è¡Œæ”¶é›†ï¼Œå¹¶ä¸éœ€è¦æš‚åœæ•´ä¸ªç¨‹åºã€‚<br>ä½†æ˜¯ä¹Ÿä¼šæœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå¯èƒ½ç¨‹åºä¸­çš„åƒåœ¾äº§ç”Ÿçš„é€Ÿåº¦ä¼šå¤§äºåƒåœ¾æ”¶é›†çš„é€Ÿåº¦ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç¨‹åºä¸­çš„åƒåœ¾è¶Šæ¥è¶Šå¤šæ— æ³•è¢«æ”¶é›†æ‰ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/images/gc-1.gif&quot;&gt;&lt;img src=&quot;/images/gc-1.gif&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.me/categories/go/"/>
    
    
      <category term="gc" scheme="http://idiotsky.me/tags/gc/"/>
    
      <category term="go" scheme="http://idiotsky.me/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€å¼ å›¾äº†è§£æ ‡è®°æ¸…é™¤ç®—æ³•</title>
    <link href="http://idiotsky.me/2017/08/16/gc-mark-sweep/"/>
    <id>http://idiotsky.me/2017/08/16/gc-mark-sweep/</id>
    <published>2017-08-15T17:02:21.000Z</published>
    <updated>2017-08-15T17:06:32.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/images/gc.gif"><img src="/images/gc.gif" alt=""></a><br><a id="more"></a><br>è¿™ä¸ªç®—æ³•åˆ†ä¸ºä¸¤æ­¥ï¼Œæ ‡è®°å’Œæ¸…é™¤ã€‚</p>
<ul>
<li>æ ‡è®°ï¼šä»ç¨‹åºçš„æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œ é€’å½’åœ° éå†æ‰€æœ‰å¯¹è±¡ï¼Œå°†èƒ½éå†åˆ°çš„å¯¹è±¡æ‰“ä¸Šæ ‡è®°ã€‚</li>
<li>æ¸…é™¤ï¼šè®²æ‰€æœ‰æœªæ ‡è®°çš„çš„å¯¹è±¡å½“ä½œåƒåœ¾é”€æ¯ã€‚</li>
</ul>
<p>ä½†æ˜¯è¿™ä¸ªç®—æ³•ä¹Ÿæœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå°±æ˜¯äººä»¬å¸¸å¸¸è¯´çš„ STW é—®é¢˜ï¼ˆStop The Worldï¼‰ã€‚å› ä¸ºç®—æ³•åœ¨æ ‡è®°æ—¶å¿…é¡»æš‚åœæ•´ä¸ªç¨‹åºï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹çš„ä»£ç å¯èƒ½ä¼šæ”¹å˜å¯¹è±¡çŠ¶æ€ï¼Œä»è€Œå¯èƒ½æŠŠä¸åº”è¯¥å›æ”¶çš„å¯¹è±¡å½“åšåƒåœ¾æ”¶é›†æ‰ã€‚<br>å½“ç¨‹åºä¸­çš„å¯¹è±¡é€æ¸å¢å¤šæ—¶ï¼Œé€’å½’éå†æ•´ä¸ªå¯¹è±¡æ ‘ä¼šæ¶ˆè€—å¾ˆå¤šçš„æ—¶é—´ï¼Œåœ¨å¤§å‹ç¨‹åºä¸­è¿™ä¸ªæ—¶é—´å¯èƒ½ä¼šæ˜¯æ¯«ç§’çº§åˆ«çš„ã€‚è®©æ‰€æœ‰çš„ç”¨æˆ·ç­‰å¾…å‡ ç™¾æ¯«ç§’çš„ GC æ—¶é—´è¿™æ˜¯ä¸èƒ½å®¹å¿çš„ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/images/gc.gif&quot;&gt;&lt;img src=&quot;/images/gc.gif&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="gc" scheme="http://idiotsky.me/tags/gc/"/>
    
  </entry>
  
  <entry>
    <title>postmançš„å‡ ç§bodyçš„ä½¿ç”¨ä»‹ç»</title>
    <link href="http://idiotsky.me/2017/08/10/postman/"/>
    <id>http://idiotsky.me/2017/08/10/postman/</id>
    <published>2017-08-10T12:11:55.000Z</published>
    <updated>2017-08-15T16:51:07.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>postman,ç”¨æ¥æ¨¡æ‹Ÿå‘é€httpè¯·æ±‚çš„å·¥å…·ï¼Œé‡Œé¢æ¶‰åŠçš„è¯·æ±‚bodyæœ‰ä»¥ä¸‹å‡ ä¸ªç±»å‹ï¼Œæ‰€ä»¥è®°ä¸‹ï¼Œè€Œä¸”ä¹Ÿèƒ½ç†è§£http bodyçš„å‡ ç§æ ¼å¼ï¼Œåˆ†äº«ä¹‹ã€‚ã€‚</p>
</blockquote>
<a id="more"></a>
<h1 id="form-data"><a href="#form-data" class="headerlink" title="form-data"></a>form-data</h1><p>å°±æ˜¯httpè¯·æ±‚ä¸­çš„multipart/form-data,å®ƒä¼šå°†è¡¨å•çš„æ•°æ®å¤„ç†ä¸ºä¸€æ¡æ¶ˆæ¯ï¼Œä»¥æ ‡ç­¾ä¸ºå•å…ƒï¼Œç”¨åˆ†éš”ç¬¦åˆ†å¼€ã€‚æ—¢å¯ä»¥ä¸Šä¼ é”®å€¼å¯¹ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚å½“ä¸Šä¼ çš„å­—æ®µæ˜¯æ–‡ä»¶æ—¶ï¼Œä¼šæœ‰Content-Typeæ¥è¡¨åæ–‡ä»¶ç±»å‹ï¼›content-dispositionï¼Œç”¨æ¥è¯´æ˜å­—æ®µçš„ä¸€äº›ä¿¡æ¯ï¼›<br>ç”±äºæœ‰boundaryéš”ç¦»ï¼Œæ‰€ä»¥multipart/form-dataæ—¢å¯ä»¥ä¸Šä¼ æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ é”®å€¼å¯¹ï¼Œå®ƒé‡‡ç”¨äº†é”®å€¼å¯¹çš„æ–¹å¼ï¼Œæ‰€ä»¥å¯ä»¥ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ã€‚</p>
<p><a href="/images/postman-1.png"><img src="/images/postman-1.png" alt=""></a><br>å†…å®¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">POST /login HTTP/1.1</div><div class="line">Host: 10.170.56.67</div><div class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW</div><div class="line">Cache-Control: no-cache</div><div class="line">Postman-Token: 9843651a-5bf9-0544-03c1-fcc2a16f484b</div><div class="line"></div><div class="line">------WebKitFormBoundary7MA4YWxkTrZu0gW</div><div class="line">Content-Disposition: form-data; name=&quot;username&quot;</div><div class="line"></div><div class="line">admin</div><div class="line">------WebKitFormBoundary7MA4YWxkTrZu0gW</div><div class="line">Content-Disposition: form-data; name=&quot;password&quot;</div><div class="line"></div><div class="line">admin123</div><div class="line">------WebKitFormBoundary7MA4YWxkTrZu0gW</div><div class="line">Content-Disposition: form-data; name=&quot;abc&quot;; filename=&quot;&quot;</div><div class="line">Content-Type: </div><div class="line"></div><div class="line"></div><div class="line">------WebKitFormBoundary7MA4YWxkTrZu0gW</div><div class="line">Content-Disposition: form-data; name=&quot;tttt&quot;; filename=&quot;&quot;</div><div class="line">Content-Type: </div><div class="line"></div><div class="line"></div><div class="line">------WebKitFormBoundary7MA4YWxkTrZu0gW--</div></pre></td></tr></table></figure></p>
<h1 id="x-www-form-urlencoded"><a href="#x-www-form-urlencoded" class="headerlink" title="x-www-form-urlencoded"></a>x-www-form-urlencoded</h1><p>å°±æ˜¯application/x-www-from-urlencoded,ä¼šå°†è¡¨å•å†…çš„æ•°æ®è½¬æ¢ä¸ºé”®å€¼å¯¹ï¼Œå¹¶ä»¥urlencodeä¸ºæ ¼å¼<br><a href="/images/postman-2.png"><img src="/images/postman-2.png" alt=""></a><br>å†…å®¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">POST /login HTTP/1.1</div><div class="line">Host: 10.170.56.67</div><div class="line">Content-Type: application/x-www-form-urlencoded</div><div class="line">Cache-Control: no-cache</div><div class="line">Postman-Token: e6887900-a46e-2ff4-8232-de878b75f5fd</div><div class="line"></div><div class="line">username=admin&amp;password=admin123</div></pre></td></tr></table></figure></p>
<h1 id="raw"><a href="#raw" class="headerlink" title="raw"></a>raw</h1><p>å¯ä»¥ä¸Šä¼ ä»»æ„æ ¼å¼çš„æ–‡æœ¬ï¼Œå¯ä»¥ä¸Šä¼ textã€jsonã€xmlã€htmlç­‰<br><a href="/images/postman-3.png"><img src="/images/postman-3.png" alt=""></a><br>å†…å®¹ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">POST /login HTTP/1.1</div><div class="line">Host: 10.170.56.67</div><div class="line">Content-Type: application/json</div><div class="line">Cache-Control: no-cache</div><div class="line">Postman-Token: 233df0e0-c6d9-98c7-4d7e-736329322683</div><div class="line"></div><div class="line">&#123;</div><div class="line">  &quot;abc&quot;:&quot;cba&quot;,</div><div class="line">  &quot;cba&quot;:&quot;abc&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»å›¾ç‰‡å’Œå†…å®¹å¯¹æ¯”ï¼Œå¯ä»¥å‘ç°ï¼ŒåŸºæœ¬ï¼Œç²˜ä»€ä¹ˆï¼Œå°±å‘ä»€ä¹ˆï¼Œä¸ä¼šè¿›è¡Œä»»ä½•è½¬æ„ã€‚</p>
<h1 id="binary"><a href="#binary" class="headerlink" title="binary"></a>binary</h1><p>ç›¸å½“äºContent-Type:application/octet-stream,ä»å­—é¢æ„æ€å¾—çŸ¥ï¼Œåªå¯ä»¥ä¸Šä¼ äºŒè¿›åˆ¶æ•°æ®ï¼Œé€šå¸¸ç”¨æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œç”±äºæ²¡æœ‰é”®å€¼ï¼Œæ‰€ä»¥ï¼Œä¸€æ¬¡åªèƒ½ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ã€‚</p>
<h1 id="multipart-form-dataä¸x-www-form-urlencodedåŒºåˆ«"><a href="#multipart-form-dataä¸x-www-form-urlencodedåŒºåˆ«" class="headerlink" title="multipart/form-dataä¸x-www-form-urlencodedåŒºåˆ«"></a>multipart/form-dataä¸x-www-form-urlencodedåŒºåˆ«</h1><ul>
<li>multipart/form-dataï¼šæ—¢å¯ä»¥ä¸Šä¼ æ–‡ä»¶ç­‰äºŒè¿›åˆ¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ è¡¨å•é”®å€¼å¯¹ï¼Œåªæ˜¯æœ€åä¼šè½¬åŒ–ä¸ºä¸€æ¡ä¿¡æ¯ï¼›</li>
<li>x-www-form-urlencodedï¼šåªèƒ½ä¸Šä¼ é”®å€¼å¯¹ï¼Œå¹¶ä¸”é”®å€¼å¯¹éƒ½æ˜¯é—´éš”åˆ†å¼€çš„</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;postman,ç”¨æ¥æ¨¡æ‹Ÿå‘é€httpè¯·æ±‚çš„å·¥å…·ï¼Œé‡Œé¢æ¶‰åŠçš„è¯·æ±‚bodyæœ‰ä»¥ä¸‹å‡ ä¸ªç±»å‹ï¼Œæ‰€ä»¥è®°ä¸‹ï¼Œè€Œä¸”ä¹Ÿèƒ½ç†è§£http bodyçš„å‡ ç§æ ¼å¼ï¼Œåˆ†äº«ä¹‹ã€‚ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="http" scheme="http://idiotsky.me/categories/http/"/>
    
    
      <category term="postman" scheme="http://idiotsky.me/tags/postman/"/>
    
  </entry>
  
  <entry>
    <title>goçš„æ˜¯å¦éœ€è¦ç”¨goroutine poolï¼Ÿ</title>
    <link href="http://idiotsky.me/2017/08/03/go-worker-pool-if-need/"/>
    <id>http://idiotsky.me/2017/08/03/go-worker-pool-if-need/</id>
    <published>2017-08-03T15:10:02.000Z</published>
    <updated>2017-08-05T14:21:00.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¿™å‡ å¤©æ— èŠï¼Œæƒ³åˆ°javaæœ‰è‡ªå·±çš„çº¿ç¨‹æ± ï¼Œæ˜¯å¦å¯¹åº”goä¹Ÿæœ‰å®ƒçš„goroutine poolå‘¢ï¼Œæ‰€ä»¥æœäº†ä¸‹ï¼Œæ ‡å‡†åº“æ²¡æœ‰ï¼Œgithubæœ‰ï¼Œä½†éƒ½å¤§åŒå°å¼‚ï¼Œæ‰€ä»¥è‡ªå·±å®ç°äº†ä¸€ä¸ªã€‚</p>
</blockquote>
<a id="more"></a>
<h1 id="ä¸€ä¸ªç®€å•çš„goroutine-pool"><a href="#ä¸€ä¸ªç®€å•çš„goroutine-pool" class="headerlink" title="ä¸€ä¸ªç®€å•çš„goroutine pool"></a>ä¸€ä¸ªç®€å•çš„goroutine pool</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> workerpool</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"sync"</span></div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> task <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"></div><div class="line"><span class="title">type</span> <span class="title">worker</span> <span class="title">struct</span> &#123;</div><div class="line">	stopC <span class="keyword">chan</span> <span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> WorkerPool <span class="keyword">struct</span> &#123;</div><div class="line">	num <span class="keyword">int</span></div><div class="line">	sync.Mutex</div><div class="line">	taskQ <span class="keyword">chan</span> task</div><div class="line">	workers []*worker</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWorkerPool</span><span class="params">(workerNum <span class="keyword">int</span>,queueCap <span class="keyword">int</span>)</span> *<span class="title">WorkerPool</span></span>&#123;</div><div class="line">	<span class="keyword">return</span> &amp;WorkerPool&#123;num:workerNum,taskQ:<span class="built_in">make</span>(<span class="keyword">chan</span> task,queueCap),workers:<span class="built_in">make</span>([]*worker,workerNum)&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wp *WorkerPool)</span> <span class="title">Execute</span><span class="params">(t task)</span></span>&#123;</div><div class="line">	wp.taskQ&lt;-t</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wp *WorkerPool)</span> <span class="title">Start</span><span class="params">()</span> *<span class="title">WorkerPool</span></span>&#123;</div><div class="line">	<span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;wp.num;i++&#123;</div><div class="line">		wp.workers[i]=&amp;worker&#123; <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)&#125;</div><div class="line">		w:=wp.workers[i]</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">			<span class="keyword">for</span> &#123;</div><div class="line">				    stop:=<span class="literal">false</span></div><div class="line">					<span class="keyword">select</span> &#123;</div><div class="line">					    <span class="keyword">case</span> f:=&lt;-wp.taskQ:</div><div class="line">							f()</div><div class="line">					    <span class="keyword">case</span> stop=&lt;-w.stopC:</div><div class="line">						     <span class="keyword">break</span></div><div class="line"></div><div class="line">					&#125;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> stop&#123;</div><div class="line">					<span class="keyword">break</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			fmt.Println(<span class="string">"stop"</span>)</div><div class="line">		&#125;(i)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> wp</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wp *WorkerPool)</span> <span class="title">Stop</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">for</span> _,w:=<span class="keyword">range</span> wp.workers&#123;</div><div class="line">		w.stopC&lt;- <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯<code>NewWorkerPool</code>ä¸€ä¸ªæ± å­çš„æ—¶å€™è®¾ç½®goroutineçš„æ•°é‡å’Œä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°ã€‚<code>Start</code>åå°±åˆ›å»ºé‚£ä¹ˆå¤šgoroutineå»ä»»åŠ¡é˜Ÿåˆ—å–ä»»åŠ¡æ‰§è¡Œï¼Œå–ä¸åˆ°ä»»åŠ¡å°±è‡ªå¾ªã€‚<code>Execute</code>æ–¹æ³•æ˜¯æŠŠä»»åŠ¡å‹è¿›é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†å°±é˜»å¡ã€‚</p>
<h1 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h1><p>è¦æµ‹è¯•æ€§èƒ½ï¼Œè‚¯å®šè¦æœ‰å¯¹æ¯”ï¼Œä»¥ä¸‹æ˜¯æ²¡æœ‰ä½¿ç”¨pool:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">nopool</span><span class="params">()</span></span> &#123;</div><div class="line">	wg := <span class="built_in">new</span>(sync.WaitGroup)</div><div class="line">    <span class="comment">//æ‰§è¡Œ1000000æ¬¡ï¼Œæ¯æ¬¡éƒ½å¯åŠ¨ä¸€ä¸ªgoroutine</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++ &#123;</div><div class="line">		wg.Add(<span class="number">1</span>)</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">			<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">100000</span>; j++ &#123;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">defer</span> wg.Done()</div><div class="line">		&#125;(i)</div><div class="line">	&#125;</div><div class="line">	wg.Wait()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸‹æ˜¯ç®€å•ç‰ˆçš„åªæ˜¯å•çº¯é™åˆ¶goroutineæ•°é‡å’Œä»»åŠ¡é˜Ÿåˆ—çš„ä»£ç ï¼Œæ²¡æœ‰ä»»ä½•å°è£…çš„:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">gopool</span><span class="params">()</span></span> &#123;</div><div class="line">	wg := <span class="built_in">new</span>(sync.WaitGroup)</div><div class="line">    <span class="comment">//é˜Ÿåˆ—100</span></div><div class="line">	data := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>)</div><div class="line"></div><div class="line">    <span class="comment">//goroutine æ•°é‡10ä¸ª</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">		wg.Add(<span class="number">1</span>)</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">			<span class="keyword">defer</span> wg.Done()</div><div class="line">			<span class="keyword">for</span> _ = <span class="keyword">range</span> data &#123;</div><div class="line">				<span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">					<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">100000</span>; j++ &#123;</div><div class="line"></div><div class="line">					&#125;</div><div class="line">				&#125;()</div><div class="line"></div><div class="line">			&#125;</div><div class="line">		&#125;(i)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="comment">//æ‰§è¡Œ1000000ä¸ªä»»åŠ¡</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++ &#123;</div><div class="line">		data &lt;- i</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">close</span>(data)</div><div class="line">	wg.Wait()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç„¶åæ˜¯ä¸»è§’:<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">workerpool</span><span class="params">()</span></span> &#123;</div><div class="line">	wg := <span class="built_in">new</span>(sync.WaitGroup)</div><div class="line">    <span class="comment">//åä¸ªgoroutineï¼Œé˜Ÿåˆ—å®¹é‡100</span></div><div class="line">	wp:=NewWorkerPool(<span class="number">10</span>,<span class="number">100</span>)</div><div class="line">	wp.Start()</div><div class="line">    <span class="comment">//æäº¤1000000ä»»åŠ¡</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++ &#123;</div><div class="line">		wg.Add(<span class="number">1</span>)</div><div class="line">		wp.Execute(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">100000</span>; j++ &#123;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">			wg.Done()</div><div class="line">		&#125;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	wg.Wait()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢ä»£ç åŸºæœ¬éƒ½æ˜¯åšåŒæ ·ä¸€ä»¶äº‹ï¼Œä½†æ˜¯åä¸¤ä¸ªåªå¼€10ä¸ªgoroutineï¼Œç¬¬ä¸€ä¸ªå°±å¼€äº†1000000ä¸ªï¼Œç»“æœï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BenchmarkNopool-8                      1        7966900091 ns/op</div><div class="line">BenchmarkGopool-8                      1        7949844269 ns/op</div><div class="line">BenchmarkWorkerPool-8                  1        7997732135 ns/op</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ²¡æœ‰åŒºåˆ«ï¼Œé‡æ–°runå‡ æ¬¡åŸºæœ¬æ²¡æœ‰å¤šå¤§å˜åŒ–ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ç”±äºgoæœ¬èº«æœ‰å¯¹goroutineæœ‰è°ƒåº¦ï¼Œæ‰€ä»¥è‡ªå·±å®ç°çš„æ± å­æ¥è°ƒåº¦å…¶å®å¥½åƒæ²¡æœ‰ä»€ä¹ˆç”¨ã€‚è¿˜æœ‰å¯èƒ½æˆ‘è‡ªå·±èƒ½åŠ›å®ç°ä¸å¥½ï¼Œæ²¡å‘æŒ¥æ± å­çš„ä½œç”¨ğŸ˜€ã€‚<br>ä½†æ˜¯ç”¨æ›´å°‘çš„goroutineèƒ½å®ŒæˆåŒæ ·çš„äº‹æƒ…ï¼Œåº”è¯¥æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œè€Œä¸”è¿™é‡Œçš„goroutineæ‰§è¡Œéƒ½æ˜¯ç®€å•çš„å¾ªç¯ï¼Œæ²¡æœ‰å¤æ‚çš„ä¸šåŠ¡ï¼Œä¸€æ—¦ä¸šåŠ¡å¤æ‚ï¼Œæ›´å°‘goroutineèƒ½å¤Ÿå‡å°‘å†…å­˜å’Œgoroutineåˆ‡æ¢æ—¶çš„cpuèµ„æºï¼Œæœ‰å¯èƒ½ä¸Šé¢æ€§èƒ½çš„æ¯”è¾ƒä¼šæ‹‰å¼€ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¿™å‡ å¤©æ— èŠï¼Œæƒ³åˆ°javaæœ‰è‡ªå·±çš„çº¿ç¨‹æ± ï¼Œæ˜¯å¦å¯¹åº”goä¹Ÿæœ‰å®ƒçš„goroutine poolå‘¢ï¼Œæ‰€ä»¥æœäº†ä¸‹ï¼Œæ ‡å‡†åº“æ²¡æœ‰ï¼Œgithubæœ‰ï¼Œä½†éƒ½å¤§åŒå°å¼‚ï¼Œæ‰€ä»¥è‡ªå·±å®ç°äº†ä¸€ä¸ªã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.me/categories/go/"/>
    
    
      <category term="go" scheme="http://idiotsky.me/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>åˆ©ç”¨æ ‘è“æ´¾æ­å»ºä¸€ä¸ªç®€æ˜“çš„NAS</title>
    <link href="http://idiotsky.me/2017/07/20/raspberry-nas/"/>
    <id>http://idiotsky.me/2017/07/20/raspberry-nas/</id>
    <published>2017-07-20T14:39:35.000Z</published>
    <updated>2017-08-09T16:13:49.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><ul>
<li>raspberry pi 3</li>
<li>ç¡¬ç›˜ï¼ˆæ ¼å¼åŒ–è¿‡ext4çš„ï¼‰</li>
<li>è¿æ¥raspberryç”¨çš„ç»ˆç«¯</li>
</ul>
<a id="more"></a>
<h1 id="å®‰è£…samba"><a href="#å®‰è£…samba" class="headerlink" title="å®‰è£…samba"></a>å®‰è£…samba</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install samba samba-common-bin</div></pre></td></tr></table></figure>
<h1 id="é…ç½®samba"><a href="#é…ç½®samba" class="headerlink" title="é…ç½®samba"></a>é…ç½®samba</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.back</div><div class="line">sudo vim /etc/samba/smb.conf</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># åœ¨æœ«å°¾åŠ å…¥å¦‚ä¸‹å†…å®¹</span></div><div class="line"><span class="comment"># åˆ†äº«åç§°</span></div><div class="line">[MyNAS]</div><div class="line"><span class="comment"># è¯´æ˜ä¿¡æ¯</span></div><div class="line">comment = NAS Storage</div><div class="line"><span class="comment"># å¯ä»¥è®¿é—®çš„ç”¨æˆ·</span></div><div class="line">valid users = pi,root</div><div class="line"><span class="comment"># å…±äº«æ–‡ä»¶çš„è·¯å¾„,raspberry pi ä¼šè‡ªåŠ¨å°†è¿æ¥åˆ°å…¶ä¸Šçš„å¤–æ¥å­˜å‚¨è®¾å¤‡æŒ‚è½½åˆ°/media/pi/ç›®å½•ä¸‹ã€‚</span></div><div class="line">path = /media/pi/</div><div class="line"><span class="comment"># å¯è¢«å…¶ä»–äººçœ‹åˆ°èµ„æºåç§°ï¼ˆéå†…å®¹ï¼‰</span></div><div class="line">browseable = yes</div><div class="line"><span class="comment"># å¯å†™</span></div><div class="line">writable = yes</div><div class="line"><span class="comment"># æ–°å»ºæ–‡ä»¶çš„æƒé™ä¸º 664</span></div><div class="line">create mask = 0664</div><div class="line"><span class="comment"># æ–°å»ºç›®å½•çš„æƒé™ä¸º 775</span></div><div class="line">directory mask = 0775</div></pre></td></tr></table></figure>
<p>å¯ä»¥æŠŠé…ç½®æ–‡ä»¶ä¸­ä½ ä¸éœ€è¦çš„åˆ†äº«åç§°åˆ é™¤ï¼Œä¾‹å¦‚ [homes], [printers] ç­‰ã€‚<br>æµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰é”™è¯¯ï¼Œæ ¹æ®æç¤ºåšç›¸åº”ä¿®æ”¹<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">testparm</div></pre></td></tr></table></figure></p>
<p>æ·»åŠ ç™»é™†è´¦æˆ·å¹¶åˆ›å»ºå¯†ç ï¼Œå¿…é¡»æ˜¯ linux å·²å­˜åœ¨çš„ç”¨æˆ·<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo smbpasswd -a pi</div></pre></td></tr></table></figure></p>
<p>é‡å¯ samba æœåŠ¡<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo /etc/init.d/samba restart</div></pre></td></tr></table></figure></p>
<h1 id="è¿æ¥"><a href="#è¿æ¥" class="headerlink" title="è¿æ¥"></a>è¿æ¥</h1><p>ä¸€èˆ¬æ ‘è“æ´¾è·Ÿä½ çš„WiFiç›¸è¿çš„è¯ï¼Œä½ çš„ç½‘ç»œå°±èƒ½çœ‹åˆ°è·Ÿä¸Šé¢é…ç½®ä¸€æ ·çš„åˆ†äº«åç§°ï¼Œå¦‚macä¸Šé¢è¿™æ ·çš„æ˜¾ç¤ºï¼š<br><a href="/images/nas-screenshot.png"><img src="/images/nas-screenshot.png" alt=""></a><br>å¦‚æœæ˜¾ç¤ºæ²¡æƒé™ï¼Œå¯ä»¥æ–­å¼€è¿æ¥ï¼Œç”¨ä½ ä¸Šé¢æ·»åŠ çš„è´¦å·ç™»å½•ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å‡†å¤‡&quot;&gt;&lt;a href=&quot;#å‡†å¤‡&quot; class=&quot;headerlink&quot; title=&quot;å‡†å¤‡&quot;&gt;&lt;/a&gt;å‡†å¤‡&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;raspberry pi 3&lt;/li&gt;
&lt;li&gt;ç¡¬ç›˜ï¼ˆæ ¼å¼åŒ–è¿‡ext4çš„ï¼‰&lt;/li&gt;
&lt;li&gt;è¿æ¥raspberryç”¨çš„ç»ˆç«¯&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="raspberrypi" scheme="http://idiotsky.me/categories/raspberrypi/"/>
    
    
      <category term="python" scheme="http://idiotsky.me/tags/python/"/>
    
      <category term="raspberrypi" scheme="http://idiotsky.me/tags/raspberrypi/"/>
    
      <category term="NAS" scheme="http://idiotsky.me/tags/NAS/"/>
    
  </entry>
  
  <entry>
    <title>åˆ©ç”¨æ ‘è“æ´¾å®ç°ä¸€ä¸ªèƒ½æ’­æ”¾å¤©æ°”çš„é—¹é’Ÿ</title>
    <link href="http://idiotsky.me/2017/07/18/raspberry-weather-clock/"/>
    <id>http://idiotsky.me/2017/07/18/raspberry-weather-clock/</id>
    <published>2017-07-17T17:12:25.000Z</published>
    <updated>2017-08-10T12:26:28.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h1><p>ä½ è¦æœ‰ä¸ªpiğŸ˜„<br><a id="more"></a></p>
<h1 id="è·å–å¤©æ°”æ¥å£"><a href="#è·å–å¤©æ°”æ¥å£" class="headerlink" title="è·å–å¤©æ°”æ¥å£"></a>è·å–å¤©æ°”æ¥å£</h1><p>è¿™é‡Œæˆ‘æ˜¯ç”¨å›¾çµæœºå™¨äººæ¥è·å–å¤©æ°”çš„æ¥å£ï¼Œä½ å¯ä»¥è‡ªå·±ä¸Šå»æ³¨å†Œä¸€ä¸ªï¼Œä¸‹é¢ä»£ç URLçš„Keyæ˜¯æˆ‘æ³¨å†Œçš„æœºå™¨äººç»™çš„ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getWeatherText</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        response = requests.get(</div><div class="line">            <span class="string">"http://www.tuling123.com/openapi/api?key=652ae4a714794fe6b01faa990d7a981f&amp;info=%s"</span> % <span class="string">"å¹¿å·ä»Šæ—¥å¤©æ°”"</span>)</div><div class="line">        json = response.json()</div><div class="line">        <span class="keyword">if</span> json[<span class="string">"code"</span>] == <span class="number">100000</span>:</div><div class="line">            <span class="keyword">return</span> json[<span class="string">"text"</span>]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> <span class="string">""</span></div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span></div></pre></td></tr></table></figure></p>
<h1 id="æ’­æ”¾æ–‡å­—"><a href="#æ’­æ”¾æ–‡å­—" class="headerlink" title="æ’­æ”¾æ–‡å­—"></a>æ’­æ”¾æ–‡å­—</h1><p>åˆ©ç”¨ç™¾åº¦çš„æ¥å£å¯ä»¥è½¬æ¢æ–‡æœ¬ä¸ºè¯­éŸ³ã€‚é»˜è®¤åªæœ‰å¥³å£°<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">text2voice</span><span class="params">(text)</span>:</span></div><div class="line">    url = <span class="string">'http://tts.baidu.com/text2audio?idx=1&amp;tex=&#123;0&#125;&amp;cuid=baidu_speech_'</span> \</div><div class="line">          <span class="string">'demo&amp;cod=2&amp;lan=zh&amp;ctp=1&amp;pdt=1&amp;spd=4&amp;per=4&amp;vol=5&amp;pit=5'</span>.format(text)</div><div class="line">    <span class="comment"># ç”¨mplayeræ’­æ”¾è¯­éŸ³</span></div><div class="line">    os.system(<span class="string">'mplayer "%s"'</span> % url)</div></pre></td></tr></table></figure></p>
<h1 id="å®‰è£…æ’­æ”¾åª’ä½“è½¯ä»¶"><a href="#å®‰è£…æ’­æ”¾åª’ä½“è½¯ä»¶" class="headerlink" title="å®‰è£…æ’­æ”¾åª’ä½“è½¯ä»¶"></a>å®‰è£…æ’­æ”¾åª’ä½“è½¯ä»¶</h1><p>ä¸Šé¢ä»£ç ä½ çœ‹åˆ°çš„<code>mplayer</code>,å°±æ˜¯ç”¨æ¥æ’­æ”¾è¯­éŸ³çš„ï¼Œä¼ ä¸ªurlä½œä¸ºå‚æ•°<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install mplayer</div><div class="line">usage: mplayer [url]</div></pre></td></tr></table></figure></p>
<h1 id="æ’­æ”¾éŸ³ä¹"><a href="#æ’­æ”¾éŸ³ä¹" class="headerlink" title="æ’­æ”¾éŸ³ä¹"></a>æ’­æ”¾éŸ³ä¹</h1><p>æœ‰äº†ä¸Šé¢è¿™ä¸ªç¥å™¨ï¼Œä½ å¯ä»¥ç»™æ’­æŠ¥è¯­éŸ³å‰ååŠ ä¸€é¦–éŸ³ä¹ğŸ˜„<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">playMusic</span><span class="params">(path)</span>:</span></div><div class="line">    os.system(<span class="string">'mplayer %s'</span> % path)</div></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åˆ©ç”¨ä¸Šé¢çš„ä¸œä¸œï¼Œå¯ä»¥ç»„åˆäº›å¥½ç©çš„ä¸œè¥¿äº†ï¼Œè‡³äºé—¹é’Ÿçš„å”¤é†’ï¼Œå¯ä»¥crob job åšï¼Œä¹Ÿå¯ä»¥ä»£ç é‡Œé¢å®ç°ï¼Œenjoyâ€¦ğŸ˜„<br>å…¨éƒ¨ä»£ç åœ°å€ <a href="https://github.com/ejunjsh/raspberrypi-code/blob/master/clock/weather.py" target="_blank" rel="external">https://github.com/ejunjsh/raspberrypi-code/blob/master/clock/weather.py</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å‰æ&quot;&gt;&lt;a href=&quot;#å‰æ&quot; class=&quot;headerlink&quot; title=&quot;å‰æ&quot;&gt;&lt;/a&gt;å‰æ&lt;/h1&gt;&lt;p&gt;ä½ è¦æœ‰ä¸ªpiğŸ˜„&lt;br&gt;
    
    </summary>
    
      <category term="raspberrypi" scheme="http://idiotsky.me/categories/raspberrypi/"/>
    
    
      <category term="python" scheme="http://idiotsky.me/tags/python/"/>
    
      <category term="raspberrypi" scheme="http://idiotsky.me/tags/raspberrypi/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨goå®ç°ä¸€ä¸ªç®€å•çš„restfulæ¥å£</title>
    <link href="http://idiotsky.me/2017/07/18/go-first-rest/"/>
    <id>http://idiotsky.me/2017/07/18/go-first-rest/</id>
    <published>2017-07-17T17:01:18.000Z</published>
    <updated>2017-07-22T08:00:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>goçš„æ ‡å‡†åº“<code>http</code>å·²ç»å°è£…å¥½å¾ˆå¤šæ¥å£ï¼Œå¯ä»¥å¾ˆç®€å•å®ç°ä¸€ä¸ªwebæœåŠ¡å™¨ã€‚<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å®šä¹‰ handler</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloServer</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</div><div class="line">    io.WriteString(w, <span class="string">"hello, world!\n"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">//ç»‘å®špatternå’Œhandler</span></div><div class="line">    http.HandleFunc(<span class="string">"/hello"</span>, HelloServer)</div><div class="line">    err := http.ListenAndServe(<span class="string">":12345"</span>, <span class="literal">nil</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"ListenAndServe: "</span>, err)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åŸºäºä¸Šé¢ä¾‹å­å¯ä»¥å°è£…ä¸€ä¸ªrestfulæ¥å£ï¼Œä¸æ˜¯éš¾äº‹ã€‚<br><a id="more"></a></p>
<h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><p>ä»ä¸Šé¢ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªurl patternå¯¹åº”ä¸€ä¸ªhandlerï¼Œå³å¯¹åº”ä¸€ä¸ªå¤„ç†ï¼Œå°±å¯ä»¥å¤„ç†httpè¯·æ±‚äº†ï¼Œæ‰€ä»¥ä¸‹é¢çš„å®ç°æ˜¯åŸºäºå¯¹è¿™ä¸¤ä¸ªä¸œè¥¿çš„å°è£…å¼€å§‹</p>
<h2 id="å°è£…ä¸€ä¸ªrestful-app-ç»“æ„"><a href="#å°è£…ä¸€ä¸ªrestful-app-ç»“æ„" class="headerlink" title="å°è£…ä¸€ä¸ªrestful app ç»“æ„"></a>å°è£…ä¸€ä¸ªrestful app ç»“æ„</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> App <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="comment">//ä¸€ä¸ªmapï¼Œkeyæ˜¯patternï¼Œvalueæ˜¯handler</span></div><div class="line">	handlers <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(r *HttpRequest,w HttpResponse)</span><span class="title">error</span></span></div><div class="line">    //<span class="title">pattern</span>æ•°ç»„ï¼Œç”¨æ¥ä¿è¯åŠ å…¥<span class="title">pattern</span>çš„é¡ºåºï¼Œå› ä¸ºä¸Šé¢çš„<span class="title">map</span>æ˜¯æ— é¡ºåºçš„</div><div class="line">	<span class="title">patterns</span> []<span class="title">string</span></div><div class="line">    //ä¸€ä¸ª<span class="title">map</span>ï¼Œ<span class="title">key</span>æ˜¯<span class="title">pattern</span>ï¼Œ<span class="title">value</span>æ˜¯<span class="title">http</span> <span class="title">method</span></div><div class="line">	<span class="title">methods</span> <span class="title">map</span>[<span class="title">string</span>]<span class="title">string</span></div><div class="line">    //ç”¨æ¥å®ç°åœ¨<span class="title">url</span> <span class="title">path</span>å–å‡ºå‚æ•°çš„ã€‚</div><div class="line">	<span class="title">regexps</span> <span class="title">map</span>[<span class="title">string</span>]*<span class="title">regexp</span>.<span class="title">Regexp</span></div><div class="line">	<span class="title">pathparamanmes</span> <span class="title">map</span>[<span class="title">string</span>][]<span class="title">string</span></div><div class="line">    //ç”¨æ¥å¤„ç†å¼‚å¸¸çš„<span class="title">handler</span></div><div class="line">	<span class="title">errHandler</span> <span class="title">func</span><span class="params">( err error, r *HttpRequest,w HttpResponse)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–å‡½æ•°<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewApp</span><span class="params">()</span> *<span class="title">App</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;App&#123;</div><div class="line">		handlers: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(r *HttpRequest,w HttpResponse)</span><span class="title">error</span>),</span></div><div class="line">		<span class="title">patterns</span>:<span class="title">make</span><span class="params">([]<span class="keyword">string</span>,0)</span>,</div><div class="line">		<span class="title">methods</span>:<span class="title">make</span><span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span>,</div><div class="line">		<span class="title">regexps</span>:<span class="title">make</span><span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>]*regexp.Regexp)</span>,</div><div class="line">		<span class="title">pathparamanmes</span>:<span class="title">make</span><span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>)</span>,</div><div class="line">        //ä¸€ä¸ªé»˜è®¤çš„å¼‚å¸¸å¤„ç†ï¼Œç›´æ¥è¿”å›å¼‚å¸¸å†…å®¹</div><div class="line">		<span class="title">errHandler</span>: <span class="title">func</span><span class="params">(err error, r *HttpRequest, w HttpResponse)</span> &#123;</div><div class="line">			w.Write( []<span class="keyword">byte</span>(err.Error()))</div><div class="line">		&#125;,</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="æ˜ å°„ç»‘å®š"><a href="#æ˜ å°„ç»‘å®š" class="headerlink" title="æ˜ å°„ç»‘å®š"></a>æ˜ å°„ç»‘å®š</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span><span class="params">(a *App)</span> <span class="title">handle</span><span class="params">(method <span class="keyword">string</span>,pattern <span class="keyword">string</span>, handler <span class="keyword">func</span>(r *HttpRequest,w HttpResponse)</span> <span class="title">error</span>)</span>&#123;</div><div class="line">    <span class="comment">//ç»‘å®špatternå’Œhandler</span></div><div class="line">	a.handlers[pattern]=handler</div><div class="line">    <span class="comment">//ç»‘å®špatternå’Œmethod</span></div><div class="line">	a.methods[pattern]=method</div><div class="line">    <span class="comment">//ç»‘å®špattern æ­£åˆ™ï¼Œç”¨æ¥åŒ¹é…url pattern,å’Œè·å–url path å‚æ•°</span></div><div class="line">	a.regexps[pattern],a.pathparamanmes[pattern]=convertPatterntoRegex(pattern)</div><div class="line">	<span class="keyword">for</span> _,s:=<span class="keyword">range</span> a.patterns&#123;</div><div class="line">		<span class="keyword">if</span> s==pattern&#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">    <span class="comment">//åŠ å…¥æ•°ç»„ï¼Œæ–¹ä¾¿ç”¨æ­¤æ•°ç»„ç¡®å®šé¡ºåº</span></div><div class="line">	a.patterns=<span class="built_in">append</span>(a.patterns,pattern)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ç»‘å®šGET</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *App)</span> <span class="title">Get</span><span class="params">(pattern <span class="keyword">string</span>, handler <span class="keyword">func</span>(r *HttpRequest,w HttpResponse)</span><span class="title">error</span>)</span>  &#123;</div><div class="line">	a.handle(<span class="string">"GET"</span>,pattern,handler)</div><div class="line">&#125;</div><div class="line"><span class="comment">//ç»‘å®šPOST</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *App)</span> <span class="title">Post</span><span class="params">(pattern <span class="keyword">string</span>, handler <span class="keyword">func</span>(r *HttpRequest,w HttpResponse)</span><span class="title">error</span>)</span>  &#123;</div><div class="line">	a.handle(<span class="string">"POST"</span>,pattern,handler)</div><div class="line">&#125;</div><div class="line"><span class="comment">//ç»‘å®šDELETE</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *App)</span> <span class="title">Delete</span><span class="params">(pattern <span class="keyword">string</span>, handler <span class="keyword">func</span>(r *HttpRequest,w HttpResponse)</span><span class="title">error</span>)</span>  &#123;</div><div class="line">	a.handle(<span class="string">"DELETE"</span>,pattern,handler)</div><div class="line">&#125;</div><div class="line"><span class="comment">//ç»‘å®šPUT</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *App)</span> <span class="title">Put</span><span class="params">(pattern <span class="keyword">string</span>, handler <span class="keyword">func</span>(r *HttpRequest,w HttpResponse)</span> <span class="title">error</span>)</span>  &#123;</div><div class="line">	a.handle(<span class="string">"PUT"</span>,pattern,handler)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *App)</span> <span class="title">Error</span><span class="params">(handler <span class="keyword">func</span>(err error,r *HttpRequest,w HttpResponse)</span>)</span>  &#123;</div><div class="line">	a.errHandler=handler</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ‰äº†Restfulæ¥å£çš„å››ä¸ªæ–¹æ³•æ˜ å°„ç»‘å®šï¼Œå‰©ä¸‹çš„å°±è¦è¯·æ±‚èƒ½è¿›åˆ°æ¥ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è¦å†™ä¸ªå…¥å£æ‰è¡Œã€‚</p>
<h2 id="ç¼–å†™httpå…¥å£"><a href="#ç¼–å†™httpå…¥å£" class="headerlink" title="ç¼–å†™httpå…¥å£"></a>ç¼–å†™httpå…¥å£</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//http å…¥å£</span></div><div class="line"><span class="function"><span class="keyword">func</span><span class="params">(a *App)</span> <span class="title">Run</span><span class="params">(address <span class="keyword">string</span>)</span> <span class="title">error</span></span>&#123;</div><div class="line">	fmt.Printf(<span class="string">"Server listens on %s"</span>,address)</div><div class="line">	err:=http.ListenAndServe(address,&amp;hodler&#123;app:a&#125;)</div><div class="line">	<span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//https å…¥å£</span></div><div class="line"><span class="function"><span class="keyword">func</span><span class="params">(a *App)</span> <span class="title">RunTls</span><span class="params">(address <span class="keyword">string</span>,cert <span class="keyword">string</span>,key <span class="keyword">string</span>)</span> <span class="title">error</span></span>&#123;</div><div class="line">	fmt.Printf(<span class="string">"Server listens on %s"</span>,address)</div><div class="line">	err:=http.ListenAndServeTLS(address,cert,key,&amp;hodler&#123;app:a&#125;)</div><div class="line">	<span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¥å£å‡½æ•°ä¸»è¦è°ƒç”¨<code>http</code>åº“æ¥å¯åŠ¨httpæœåŠ¡ï¼Œç„¶åæŠŠè¯·æ±‚å¤„ç†å‡½æ•°ä½œä¸º<code>ListenAndServe</code>ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ã€‚è¿™é‡Œç”±<code>holder</code>æ¥å®ç°è¿™ä¸ªå¤„ç†å‡½æ•°ã€‚<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *hodler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span>&#123;</div><div class="line">	<span class="comment">//å°è£…ä¸€ä¸‹ï¼Œé™„åŠ æ›´å¤šåŠŸèƒ½</span></div><div class="line">    request:= newHttpRequest(r)</div><div class="line">	response:=newHttpResponse(w)</div><div class="line">	<span class="comment">//æ•è·panicï¼Œå¹¶è®©errhandlerå¤„ç†è¿”å›ã€‚</span></div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> err:=<span class="built_in">recover</span>();err!=<span class="literal">nil</span>&#123;</div><div class="line">			<span class="keyword">if</span> e,ok:=err.(error);ok&#123;</div><div class="line">				h.app.errHandler(InternalError&#123;e,<span class="string">""</span>&#125;,request,response)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> e,ok:=err.(<span class="keyword">string</span>);ok&#123;</div><div class="line">				h.app.errHandler(InternalError&#123;<span class="literal">nil</span>,e&#125;,request,response)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">    <span class="comment">//æ ¹æ®patternçš„æ·»åŠ é¡ºåºï¼Œå¾ªç¯åˆ¤æ–­</span></div><div class="line">   <span class="keyword">for</span> _,p:=<span class="keyword">range</span> h.app.patterns&#123;</div><div class="line">       <span class="keyword">if</span> reg,ok:= h.app.regexps[p];ok&#123;</div><div class="line">           <span class="comment">//åŒ¹é…method</span></div><div class="line">		   <span class="keyword">if</span> method,ok:=h.app.methods[p];ok&amp;&amp;r.Method==method&#123;</div><div class="line">              <span class="comment">//åŒ¹é…pattern</span></div><div class="line">			   <span class="keyword">if</span> reg.Match([]<span class="keyword">byte</span>(r.URL.Path)) &#123;</div><div class="line">                   <span class="comment">//æŠ½å–url path parameters</span></div><div class="line">				   matchers:=reg.FindSubmatch([]<span class="keyword">byte</span>(r.URL.Path))</div><div class="line">				   pathParamMap:=<span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</div><div class="line">				   <span class="keyword">if</span> <span class="built_in">len</span>(matchers)&gt;<span class="number">1</span>&#123;</div><div class="line">                       <span class="keyword">if</span> pathParamNames,ok:=h.app.pathparamanmes[p];ok&#123;</div><div class="line">						   <span class="keyword">for</span> i:=<span class="number">1</span>;i&lt;<span class="built_in">len</span>(matchers);i++&#123;</div><div class="line">							   pathParamMap[pathParamNames[i]]=<span class="keyword">string</span>(matchers[i])</div><div class="line">						   &#125;</div><div class="line">					   &#125;</div><div class="line">				   &#125;</div><div class="line">                   <span class="comment">//PathParamsæ˜¯å°è£…åçš„requestç‹¬æœ‰çš„å±æ€§</span></div><div class="line">				   request.PathParams=pathParamMap</div><div class="line">				   <span class="keyword">if</span> handler,ok:=h.app.handlers[p];ok&#123;</div><div class="line">                       <span class="comment">//æ‰§è¡Œhandler</span></div><div class="line">					   err:=handler(request,response)</div><div class="line">					   <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</div><div class="line">                           <span class="comment">//æ‰§è¡Œerrhandler</span></div><div class="line">						   h.app.errHandler(err,request,response)</div><div class="line">					   &#125;</div><div class="line">					   <span class="keyword">return</span></div><div class="line">				   &#125;</div><div class="line">			   &#125;</div><div class="line">		   &#125;</div><div class="line">	   &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//æ‰§è¡Œno found errhandler</span></div><div class="line">	h.app.errHandler(NoFoundError&#123;&#125;,request,response)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åŸºæœ¬ä¸€ä¸ªè¯·æ±‚çš„æµç¨‹å¦‚ä¸‹ï¼š<br>requset-&gt;ServeHTTP()-&gt;åŒ¹é…url pattern-&gt;åŒ¹é…method-&gt;åŒ¹é…åˆ°ä½ çš„handler-&gt;æ‰§è¡Œä½ çš„handler-&gt;ä½ çš„handlerè¿”å›ç»“æœ</p>
<h2 id="è¿”å›ç»“æœ"><a href="#è¿”å›ç»“æœ" class="headerlink" title="è¿”å›ç»“æœ"></a>è¿”å›ç»“æœ</h2><p>ç”±äºè¿”å›ç»“æœå¯ä»¥æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥å°è£…äº†<code>http</code>åº“çš„<code>http.ResponseWriter</code>æ¥å®ç°<code>WriteString,WriteJson,WriteXml,WriteFile</code>ç­‰æ–¹æ³•ã€‚<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å°è£…requestï¼Œé™„ä»¶ä¸€ä¸ªPathParamsæ¥ä¿å­˜url path parameters.</span></div><div class="line"><span class="keyword">type</span> HttpRequest <span class="keyword">struct</span> &#123;</div><div class="line">	*http.Request</div><div class="line">	PathParams <span class="keyword">map</span>[<span class="keyword">string</span>] <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> HttpResponse <span class="keyword">struct</span> &#123;</div><div class="line">	http.ResponseWriter</div><div class="line">&#125;</div><div class="line"><span class="comment">//ç”¨æ¥è¿”å›å­—ç¬¦</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(response *HttpResponse)</span> <span class="title">WriteString</span><span class="params">(str <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	...</div><div class="line">&#125;</div><div class="line"><span class="comment">//è¿”å›JSON</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(response *HttpResponse)</span> <span class="title">WriteJson</span><span class="params">(jsonObj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	...</div><div class="line">&#125;</div><div class="line"><span class="comment">//è¿”å›XML</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(response *HttpResponse)</span> <span class="title">WriteXml</span><span class="params">(xmlObj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	...</div><div class="line">&#125;</div><div class="line"><span class="comment">//è¿”å›æ–‡ä»¶</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(response *HttpResponse)</span> <span class="title">WriteFile</span><span class="params">(filepath <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="comment">//è¿”å›ä¸€ä¸ªæ¨¡æ¿html</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(response *HttpResponse)</span> <span class="title">WriteTemplates</span><span class="params">(data <span class="keyword">interface</span>&#123;&#125;,tplPath ...<span class="keyword">string</span>)</span> <span class="title">error</span></span>  &#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="comment">//new ä¸€ä¸ªrestfulæ¥å£</span></div><div class="line">	app:=gorest.NewApp()</div><div class="line">    <span class="comment">//ç»‘å®š</span></div><div class="line">	app.Get(<span class="string">"/json"</span>, <span class="function"><span class="keyword">func</span><span class="params">(r *gorest.HttpRequest, w gorest.HttpResponse)</span> <span class="title">error</span></span> &#123;</div><div class="line">		a:= <span class="keyword">struct</span> &#123;</div><div class="line">			Abc <span class="keyword">string</span> <span class="string">`json:"abc"`</span></div><div class="line">			Cba <span class="keyword">string</span> <span class="string">`json:"cba"`</span></div><div class="line">		&#125;&#123;<span class="string">"123"</span>,<span class="string">"321"</span>&#125;</div><div class="line">        <span class="comment">//è¿”å›jsonä½œä¸ºç»“æœ</span></div><div class="line">		<span class="keyword">return</span> w.WriteJson(a)</div><div class="line">	&#125;)</div><div class="line">	app.Error(<span class="function"><span class="keyword">func</span><span class="params">(err error, r *gorest.HttpRequest, w gorest.HttpResponse)</span></span>&#123;</div><div class="line">		<span class="keyword">if</span> e,ok:=err.(gorest.NoFoundError);ok &#123;</div><div class="line">			w.Write([]<span class="keyword">byte</span>(e.Error()))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> e,ok:=err.(gorest.InternalError);ok &#123;</div><div class="line">			w.Write([]<span class="keyword">byte</span>(e.Error()))</div><div class="line">		&#125;</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">    <span class="comment">//å¯åŠ¨</span></div><div class="line">	app.Run(<span class="string">":8081"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ”¶å·¥ğŸ˜„</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>goçš„æ ‡å‡†åº“å°è£…äº†å¾ˆå¤šäº†ï¼Œæ‰€ä»¥å®ç°è¿™ä¸ªå…¶å®è¿˜æ˜¯æ¯”è¾ƒè½»æ¾çš„ğŸ˜„<br>è¯¦ç»†ä»£ç è§<a href="https://github.com/ejunjsh/gorest" target="_blank" rel="external">https://github.com/ejunjsh/gorest</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;goçš„æ ‡å‡†åº“&lt;code&gt;http&lt;/code&gt;å·²ç»å°è£…å¥½å¾ˆå¤šæ¥å£ï¼Œå¯ä»¥å¾ˆç®€å•å®ç°ä¸€ä¸ªwebæœåŠ¡å™¨ã€‚&lt;br&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// å®šä¹‰ handler&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;HelloServer&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(w http.ResponseWriter, req *http.Request)&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    io.WriteString(w, &lt;span class=&quot;string&quot;&gt;&quot;hello, world!\n&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//ç»‘å®špatternå’Œhandler&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    http.HandleFunc(&lt;span class=&quot;string&quot;&gt;&quot;/hello&quot;&lt;/span&gt;, HelloServer)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    err := http.ListenAndServe(&lt;span class=&quot;string&quot;&gt;&quot;:12345&quot;&lt;/span&gt;, &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        log.Fatal(&lt;span class=&quot;string&quot;&gt;&quot;ListenAndServe: &quot;&lt;/span&gt;, err)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;åŸºäºä¸Šé¢ä¾‹å­å¯ä»¥å°è£…ä¸€ä¸ªrestfulæ¥å£ï¼Œä¸æ˜¯éš¾äº‹ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="go" scheme="http://idiotsky.me/categories/go/"/>
    
    
      <category term="go" scheme="http://idiotsky.me/tags/go/"/>
    
      <category term="restful" scheme="http://idiotsky.me/tags/restful/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€å¼ å›¾äº†è§£ä¸€è‡´æ€§hash</title>
    <link href="http://idiotsky.me/2017/07/16/consistent-hash/"/>
    <id>http://idiotsky.me/2017/07/16/consistent-hash/</id>
    <published>2017-07-16T12:39:20.000Z</published>
    <updated>2017-07-19T12:39:16.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/images/consistent-hash.png"><img src="/images/consistent-hash.png" alt="one image describes how consistent-hash works"></a><br><a id="more"></a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/images/consistent-hash.png&quot;&gt;&lt;img src=&quot;/images/consistent-hash.png&quot; alt=&quot;one image describes how consistent-hash works&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€å¼ å›¾äº†è§£hashmap</title>
    <link href="http://idiotsky.me/2017/07/15/hashmap/"/>
    <id>http://idiotsky.me/2017/07/15/hashmap/</id>
    <published>2017-07-15T10:03:15.000Z</published>
    <updated>2017-08-12T06:50:03.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/images/hashmap.png"><img src="/images/hashmap.png" alt="one image describes how hashmap works"></a><br><a id="more"></a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/images/hashmap.png&quot;&gt;&lt;img src=&quot;/images/hashmap.png&quot; alt=&quot;one image describes how hashmap works&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>SELECT * ...... FOR UPDATE é”æœºåˆ¶</title>
    <link href="http://idiotsky.me/2016/12/19/mysql-select-for-update/"/>
    <id>http://idiotsky.me/2016/12/19/mysql-select-for-update/</id>
    <published>2016-12-19T12:35:56.000Z</published>
    <updated>2017-08-19T12:45:17.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ç”±äºInnoDBé¢„è®¾æ˜¯Row-Level Lockï¼ŒInnoDBè¡Œé”æ˜¯é€šè¿‡ç»™ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„ï¼Œè¿™ä¸€ç‚¹MySQLä¸Oracleä¸åŒï¼Œåè€…æ˜¯é€šè¿‡åœ¨æ•°æ®å—ä¸­å¯¹ç›¸åº”æ•°æ®è¡ŒåŠ é”æ¥å®ç°çš„ã€‚InnoDBè¿™ç§è¡Œé”å®ç°ç‰¹ç‚¹æ„å‘³ç€ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ï¼ </p>
</blockquote>
<a id="more"></a>
<p>ä¸¾ä¸ªä¾‹å­:<br>å‡è®¾æœ‰ä¸ªè¡¨å•products ï¼Œé‡Œé¢æœ‰idè·ŸnameäºŒä¸ªæ ä½ï¼Œidæ˜¯ä¸»é”®ã€‚<br>ä¾‹1: (æ˜ç¡®æŒ‡å®šä¸»é”®ï¼Œå¹¶ä¸”æœ‰æ­¤ç¬”èµ„æ–™ï¼Œrow lock)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="string">'3'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="string">'3'</span> <span class="keyword">and</span> <span class="keyword">type</span>=<span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</div></pre></td></tr></table></figure></p>
<p>ä¾‹2: (æ˜ç¡®æŒ‡å®šä¸»é”®ï¼Œè‹¥æŸ¥æ— æ­¤ç¬”èµ„æ–™ï¼Œæ— lock)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="string">'-1'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</div></pre></td></tr></table></figure></p>
<p>ä¾‹3: (æ— ä¸»é”®ï¼Œtable lock)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">name</span>=<span class="string">'Mouse'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</div></pre></td></tr></table></figure></p>
<p>ä¾‹4: (ä¸»é”®ä¸æ˜ç¡®ï¼Œtable lock)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">id</span>&lt;&gt;<span class="string">'3'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</div></pre></td></tr></table></figure></p>
<p>ä¾‹5: (ä¸»é”®ä¸æ˜ç¡®ï¼Œtable lock)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> products <span class="keyword">WHERE</span> <span class="keyword">id</span> <span class="keyword">LIKE</span> <span class="string">'3'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</div></pre></td></tr></table></figure></p>
<p>æ³¨1: FOR UPDATEä»…é€‚ç”¨äºInnoDBï¼Œä¸”å¿…é¡»åœ¨äº¤æ˜“åŒºå—(BEGIN/COMMIT)ä¸­æ‰èƒ½ç”Ÿæ•ˆã€‚<br>æ³¨2: è¦æµ‹è¯•é”å®šçš„çŠ¶å†µï¼Œå¯ä»¥åˆ©ç”¨mysqlçš„Command Mode ï¼Œå¼€äºŒä¸ªè§†çª—æ¥åšæµ‹è¯•ã€‚</p>
<p>åœ¨MySql 5.0ä¸­æµ‹è¯•ç¡®å®æ˜¯è¿™æ ·çš„<br>å¦å¤–ï¼šMyAsim åªæ”¯æŒè¡¨çº§é”ï¼ŒInnerDBæ”¯æŒè¡Œçº§é”<br>æ·»åŠ äº†(è¡Œçº§é”/è¡¨çº§é”)é”çš„æ•°æ®ä¸èƒ½è¢«å…¶å®ƒäº‹åŠ¡å†é”å®šï¼Œä¹Ÿä¸è¢«å…¶å®ƒäº‹åŠ¡ä¿®æ”¹ï¼ˆä¿®æ”¹ã€åˆ é™¤ï¼‰<br>æ˜¯è¡¨çº§é”æ—¶ï¼Œä¸ç®¡æ˜¯å¦æŸ¥è¯¢åˆ°è®°å½•ï¼Œéƒ½ä¼šé”å®šè¡¨</p>
<p>æ­¤å¤–ï¼Œå¦‚æœAä¸Béƒ½å¯¹è¡¨idè¿›è¡ŒæŸ¥è¯¢ä½†æŸ¥è¯¢ä¸åˆ°è®°å½•ï¼Œåˆ™Aä¸Båœ¨æŸ¥è¯¢ä¸Šä¸ä¼šè¿›è¡Œrowé”ï¼Œä½†Aä¸Béƒ½ä¼šè·å–æ’å®ƒé”ï¼Œæ­¤æ—¶Aå†æ’å…¥ä¸€æ¡è®°å½•çš„è¯åˆ™ä¼šå› ä¸ºBå·²ç»æœ‰é”è€Œå¤„äºç­‰å¾…ä¸­ï¼Œæ­¤æ—¶Bå†æ’å…¥ä¸€æ¡åŒæ ·çš„æ•°æ®åˆ™ä¼šæŠ›å‡ºDeadlock found when trying to get lock; try restarting transactionç„¶åé‡Šæ”¾é”ï¼Œæ­¤æ—¶Aå°±è·å¾—äº†é”è€Œæ’å…¥æˆåŠŸ</p>
<p>ä¸Šé¢ä»‹ç»è¿‡SELECT â€¦ FOR UPDATE çš„ç”¨æ³•ï¼Œä¸è¿‡é”å®š(Lock)çš„æ•°æ®æ˜¯åˆ¤åˆ«å°±å¾—è¦æ³¨æ„ä¸€ä¸‹äº†ã€‚ç”±äºInnoDB é¢„è®¾æ˜¯Row-Level Lockï¼Œæ‰€ä»¥åªæœ‰ã€Œæ˜ç¡®ã€çš„æŒ‡å®šä¸»é”®ï¼ŒMySQL æ‰ä¼šæ‰§è¡ŒRow lock (åªé”ä½è¢«é€‰å–çš„æ•°æ®) ï¼Œå¦åˆ™MySQL å°†ä¼šæ‰§è¡ŒTable Lock (å°†æ•´ä¸ªæ•°æ®è¡¨å•ç»™é”ä½)ã€‚</p>
<p>è½¬è½½ <a href="http://www.cnblogs.com/chenwenbiao/archive/2012/06/06/2537508.html" target="_blank" rel="external">http://www.cnblogs.com/chenwenbiao/archive/2012/06/06/2537508.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç”±äºInnoDBé¢„è®¾æ˜¯Row-Level Lockï¼ŒInnoDBè¡Œé”æ˜¯é€šè¿‡ç»™ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„ï¼Œè¿™ä¸€ç‚¹MySQLä¸Oracleä¸åŒï¼Œåè€…æ˜¯é€šè¿‡åœ¨æ•°æ®å—ä¸­å¯¹ç›¸åº”æ•°æ®è¡ŒåŠ é”æ¥å®ç°çš„ã€‚InnoDBè¿™ç§è¡Œé”å®ç°ç‰¹ç‚¹æ„å‘³ç€ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ï¼ &lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="mysql" scheme="http://idiotsky.me/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://idiotsky.me/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>ç®€å•ç†è§£Java GCä¸å¹½çµå¼•ç”¨</title>
    <link href="http://idiotsky.me/2016/09/11/java-gc-reference/"/>
    <id>http://idiotsky.me/2016/09/11/java-gc-reference/</id>
    <published>2016-09-11T14:41:24.000Z</published>
    <updated>2017-08-11T15:03:08.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>Javaä¸­ä¸€å…±æœ‰4ç§ç±»å‹çš„å¼•ç”¨:StrongReferenceã€SoftReferenceã€WeakReferenceä»¥åŠPhantomReference (å¹½çµå¼•ç”¨), è¿™ 4 ç§ç±»å‹çš„å¼•ç”¨ä¸Java GCæœ‰ç€å¯†åˆ‡çš„å…³ç³», è®©æˆ‘ä»¬é€ä¸€æ¥çœ‹å®ƒä»¬çš„å®šä¹‰å’Œä½¿ç”¨åœºæ™¯ã€‚</p>
</blockquote>
<a id="more"></a>
<h1 id="Strong-Reference"><a href="#Strong-Reference" class="headerlink" title="Strong Reference"></a>Strong Reference</h1><p>StrongReference æ˜¯ Java çš„é»˜è®¤å¼•ç”¨å®ç°,å®ƒä¼šå°½å¯èƒ½é•¿æ—¶é—´çš„å­˜æ´»äº JVM å†…ï¼Œ å½“æ²¡æœ‰ä»»ä½•å¯¹è±¡æŒ‡å‘å®ƒæ—¶Java GC æ‰§è¡Œåå°†ä¼šè¢«å›æ”¶<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strongReference</span><span class="params">()</span> </span>&#123;   </div><div class="line">Object referent = <span class="keyword">new</span> Object();   </div><div class="line">   </div><div class="line"><span class="comment">/**  </span></div><div class="line"> * é€šè¿‡èµ‹å€¼åˆ›å»º StrongReference   </div><div class="line"> */  </div><div class="line">Object strongReference = referent;   </div><div class="line">   </div><div class="line">assertSame(referent, strongReference);   </div><div class="line">   </div><div class="line">referent = <span class="keyword">null</span>;   </div><div class="line">System.gc();   </div><div class="line">   </div><div class="line"><span class="comment">/**  </span></div><div class="line"> * StrongReference åœ¨ GC åä¸ä¼šè¢«å›æ”¶  </div><div class="line"> */  </div><div class="line">assertNotNull(strongReference);   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="WeakReference-amp-WeakHashMap"><a href="#WeakReference-amp-WeakHashMap" class="headerlink" title="WeakReference &amp; WeakHashMap"></a>WeakReference &amp; WeakHashMap</h1><p>WeakReferenceï¼Œ é¡¾åæ€ä¹‰,æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨,å½“æ‰€å¼•ç”¨çš„å¯¹è±¡åœ¨ JVM å†…ä¸å†æœ‰å¼ºå¼•ç”¨æ—¶, Java GC å weak reference å°†ä¼šè¢«è‡ªåŠ¨å›æ”¶<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">weakReference</span><span class="params">()</span> </span>&#123;   </div><div class="line">Object referent = <span class="keyword">new</span> Object();   </div><div class="line">WeakReference&lt;Object&gt; weakRerference = <span class="keyword">new</span> WeakReference&lt;Object&gt;(referent);   </div><div class="line"> </div><div class="line">assertSame(referent, weakRerference.get());   </div><div class="line">   </div><div class="line">referent = <span class="keyword">null</span>;   </div><div class="line">System.gc();   </div><div class="line">   </div><div class="line"><span class="comment">/**  </span></div><div class="line"> * ä¸€æ—¦æ²¡æœ‰æŒ‡å‘ referent çš„å¼ºå¼•ç”¨, weak reference åœ¨ GC åä¼šè¢«è‡ªåŠ¨å›æ”¶  </div><div class="line"> */  </div><div class="line">assertNull(weakRerference.get());   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>WeakHashMap ä½¿ç”¨ WeakReference ä½œä¸º keyï¼Œ ä¸€æ—¦æ²¡æœ‰æŒ‡å‘ key çš„å¼ºå¼•ç”¨, WeakHashMap åœ¨Java GC åå°†è‡ªåŠ¨åˆ é™¤ç›¸å…³çš„ entry<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">weakHashMap</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;   </div><div class="line">Map&lt;Object, Object&gt; weakHashMap = <span class="keyword">new</span> WeakHashMap&lt;Object, Object&gt;();   </div><div class="line">Object key = <span class="keyword">new</span> Object();   </div><div class="line">Object value = <span class="keyword">new</span> Object();   </div><div class="line">weakHashMap.put(key, value);   </div><div class="line"> </div><div class="line">assertTrue(weakHashMap.containsValue(value));   </div><div class="line">   </div><div class="line">key = <span class="keyword">null</span>;   </div><div class="line">System.gc();   </div><div class="line">   </div><div class="line"><span class="comment">/**  </span></div><div class="line"> * ç­‰å¾…æ— æ•ˆ entries è¿›å…¥ ReferenceQueue ä»¥ä¾¿ä¸‹ä¸€æ¬¡è°ƒç”¨ getTable æ—¶è¢«æ¸…ç†  </div><div class="line"> */  </div><div class="line">Thread.sleep(<span class="number">1000</span>);   </div><div class="line">   </div><div class="line"><span class="comment">/**  </span></div><div class="line"> * ä¸€æ—¦æ²¡æœ‰æŒ‡å‘ key çš„å¼ºå¼•ç”¨, WeakHashMap åœ¨ GC åå°†è‡ªåŠ¨åˆ é™¤ç›¸å…³çš„ entry  </div><div class="line"> */  </div><div class="line">assertFalse(weakHashMap.containsValue(value));   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="SoftReference"><a href="#SoftReference" class="headerlink" title="SoftReference"></a>SoftReference</h1><p>SoftReference äº WeakReference çš„ç‰¹æ€§åŸºæœ¬ä¸€è‡´ï¼Œ æœ€å¤§çš„åŒºåˆ«åœ¨äº SoftReference ä¼šå°½å¯èƒ½é•¿çš„ä¿ç•™å¼•ç”¨ç›´åˆ° JVM å†…å­˜ä¸è¶³æ—¶æ‰ä¼šè¢«å›æ”¶(è™šæ‹Ÿæœºä¿è¯), è¿™ä¸€ç‰¹æ€§ä½¿å¾— SoftReference éå¸¸é€‚åˆç¼“å­˜åº”ç”¨<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">softReference</span><span class="params">()</span> </span>&#123;   </div><div class="line">Object referent = <span class="keyword">new</span> Object();   </div><div class="line">SoftReference&lt;Object&gt; softRerference = <span class="keyword">new</span> SoftReference&lt;Object&gt;(referent);   </div><div class="line"> </div><div class="line">assertNotNull(softRerference.get());   </div><div class="line">   </div><div class="line">referent = <span class="keyword">null</span>;   </div><div class="line">System.gc();   </div><div class="line">   </div><div class="line"><span class="comment">/**  </span></div><div class="line"> *soft references åªæœ‰åœ¨ jvm OutOfMemory ä¹‹å‰æ‰ä¼šè¢«å›æ”¶, æ‰€ä»¥å®ƒéå¸¸é€‚åˆç¼“å­˜åº”ç”¨  </div><div class="line"> */  </div><div class="line">assertNotNull(softRerference.get());   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Phantom-Reference"><a href="#Phantom-Reference" class="headerlink" title="Phantom Reference"></a>Phantom Reference</h1><p>ä½œä¸ºæœ¬æ–‡ä¸»è§’ï¼Œ Phantom Reference(å¹½çµå¼•ç”¨) ä¸ WeakReference å’Œ SoftReference æœ‰å¾ˆå¤§çš„ä¸åŒ,å› ä¸ºå®ƒçš„ get() æ–¹æ³•æ°¸è¿œè¿”å› null, è¿™ä¹Ÿæ­£æ˜¯å®ƒåå­—çš„ç”±æ¥<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">phantomReferenceAlwaysNull</span><span class="params">()</span> </span>&#123;   </div><div class="line">Object referent = <span class="keyword">new</span> Object();   </div><div class="line">PhantomReference&lt;Object&gt; phantomReference = <span class="keyword">new</span> PhantomReference&lt;Object&gt;(referent, <span class="keyword">new</span> ReferenceQueue&lt;Object&gt;());   </div><div class="line">   </div><div class="line"><span class="comment">/**  </span></div><div class="line"> * phantom reference çš„ get æ–¹æ³•æ°¸è¿œè¿”å› null   </div><div class="line"> */  </div><div class="line">assertNull(phantomReference.get());   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¯¸ä½å¯èƒ½è¦é—®, ä¸€ä¸ªæ°¸è¿œè¿”å› null çš„ reference è¦æ¥ä½•ç”¨,è¯·æ³¨æ„æ„é€  PhantomReference æ—¶çš„ç¬¬äºŒä¸ªå‚æ•° ReferenceQueue(äº‹å®ä¸Š WeakReference &amp; SoftReference ä¹Ÿå¯ä»¥æœ‰è¿™ä¸ªå‚æ•°)ï¼Œ<br>PhantomReference å”¯ä¸€çš„ç”¨å¤„å°±æ˜¯è·Ÿè¸ª referentä½•æ—¶è¢« enqueue åˆ° ReferenceQueue ä¸­.</p>
<h1 id="RererenceQueue"><a href="#RererenceQueue" class="headerlink" title="RererenceQueue"></a>RererenceQueue</h1><p>å½“ä¸€ä¸ª WeakReference å¼€å§‹è¿”å› null æ—¶ï¼Œ å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡å·²ç»å‡†å¤‡è¢«å›æ”¶ï¼Œ è¿™æ—¶å¯ä»¥åšä¸€äº›åˆé€‚çš„æ¸…ç†å·¥ä½œ. å°†ä¸€ä¸ª ReferenceQueue ä¼ ç»™ä¸€ä¸ª Reference çš„æ„é€ å‡½æ•°ï¼Œ å½“å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œ è™šæ‹Ÿæœºä¼šè‡ªåŠ¨å°†è¿™ä¸ªå¯¹è±¡æ’å…¥åˆ° ReferenceQueue ä¸­ï¼Œ WeakHashMap å°±æ˜¯åˆ©ç”¨ ReferenceQueue æ¥æ¸…é™¤ key å·²ç»æ²¡æœ‰å¼ºå¼•ç”¨çš„ entries.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">referenceQueue</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;   </div><div class="line">Object referent = <span class="keyword">new</span> Object();  </div><div class="line">ReferenceQueue&lt;Object&gt; referenceQueue = <span class="keyword">new</span> ReferenceQueue&lt;Object&gt;();   </div><div class="line">WeakReference&lt;Object&gt; weakReference = <span class="keyword">new</span> WeakReference&lt;Object&gt;(referent, referenceQueue);   </div><div class="line">   </div><div class="line">assertFalse(weakReference.isEnqueued());   </div><div class="line">Reference&lt;? extends Object&gt; polled = referenceQueue.poll();   </div><div class="line">assertNull(polled);   </div><div class="line">   </div><div class="line">referent = <span class="keyword">null</span>;   </div><div class="line">System.gc();   </div><div class="line"> </div><div class="line">assertTrue(weakReference.isEnqueued());   </div><div class="line">Reference&lt;? extends Object&gt; removed = referenceQueue.remove();   </div><div class="line">assertNotNull(removed);   </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Phantom-Reference-vs-Weak-Reference"><a href="#Phantom-Reference-vs-Weak-Reference" class="headerlink" title="Phantom Reference vs Weak Reference"></a>Phantom Reference vs Weak Reference</h1><p>PhantomReferenceæœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œ å…¶ä¸€ï¼Œ å®ƒå¯ä»¥è®©æˆ‘ä»¬å‡†ç¡®åœ°çŸ¥é“å¯¹è±¡ä½•æ—¶è¢«ä»å†…å­˜ä¸­åˆ é™¤ï¼Œ è¿™ä¸ªç‰¹æ€§å¯ä»¥è¢«ç”¨äºä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ä¸­(ä¾‹å¦‚ Distributed GCï¼ŒXWork å’Œ google-guice ä¸­ä¹Ÿä½¿ç”¨ PhantomReference åšäº†ä¸€äº›æ¸…ç†æ€§å·¥ä½œ).</p>
<p>å…¶äºŒï¼Œ å®ƒå¯ä»¥é¿å… finalization å¸¦æ¥çš„ä¸€äº›æ ¹æœ¬æ€§é—®é¢˜, ä¸Šæ–‡æåˆ° PhantomReference çš„å”¯ä¸€ä½œç”¨å°±æ˜¯è·Ÿè¸ª referent ä½•æ—¶è¢« enqueue åˆ° ReferenceQueue ä¸­,ä½†æ˜¯ WeakReference ä¹Ÿæœ‰å¯¹åº”çš„åŠŸèƒ½, ä¸¤è€…çš„åŒºåˆ«åˆ°åº•åœ¨å“ªå‘¢ ?<br>è¿™å°±è¦è¯´åˆ° Object çš„ finalize æ–¹æ³•, æ­¤æ–¹æ³•å°†åœ¨ gc æ‰§è¡Œå‰è¢«è°ƒç”¨, å¦‚æœæŸä¸ªå¯¹è±¡é‡è½½äº† finalize æ–¹æ³•å¹¶æ•…æ„åœ¨æ–¹æ³•å†…åˆ›å»ºæœ¬èº«çš„å¼ºå¼•ç”¨,è¿™å°†å¯¼è‡´è¿™ä¸€è½®çš„ GC æ— æ³•å›æ”¶è¿™ä¸ªå¯¹è±¡å¹¶æœ‰å¯èƒ½<br>å¼•èµ·ä»»æ„æ¬¡ GCï¼Œ æœ€åçš„ç»“æœå°±æ˜¯æ˜æ˜ JVM å†…æœ‰å¾ˆå¤š Garbage å´ OutOfMemoryï¼Œ ä½¿ç”¨ PhantomReference å°±å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œ å› ä¸º PhantomReference æ˜¯åœ¨ finalize æ–¹æ³•æ‰§è¡Œåå›æ”¶çš„ï¼Œä¹Ÿå°±æ„å‘³ç€æ­¤æ—¶å·²ç»ä¸å¯èƒ½æ‹¿åˆ°åŸæ¥çš„å¼•ç”¨,ä¹Ÿå°±ä¸ä¼šå‡ºç°ä¸Šè¿°é—®é¢˜,å½“ç„¶è¿™æ˜¯ä¸€ä¸ªå¾ˆæç«¯çš„ä¾‹å­, ä¸€èˆ¬ä¸ä¼šå‡ºç°.</p>
<h1 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h1><p><strong>Soft vs Weak vs Phantom References</strong></p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Purpose</th>
<th>Use</th>
<th>When GCed</th>
<th>Implementing Class</th>
</tr>
</thead>
<tbody>
<tr>
<td>Strong Reference</td>
<td>An ordinary reference. Keeps objects alive as long as they are referenced.</td>
<td>normal reference.</td>
<td>Any object not pointed to can be reclaimed.</td>
<td>default</td>
</tr>
<tr>
<td>Soft Reference</td>
<td>Keeps objects alive provided thereâ€™s enough memory.</td>
<td>to keep objects alive even after clients have removed their references (memory-sensitive caches), in case clients start asking for them again by key.</td>
<td>After a first gc pass, the JVM decides it still needs to reclaim more space.</td>
<td>java.lang.ref.SoftReference</td>
</tr>
<tr>
<td>Weak Reference</td>
<td>Keeps objects alive only while theyâ€™re in use (reachable) by clients.</td>
<td>Containers that automatically delete objects no longer in use.</td>
<td>After gc determines the object is only weakly reachable</td>
<td>java.lang.ref.WeakReference java.util.WeakHashMap</td>
</tr>
<tr>
<td>Phantom Reference</td>
<td>Lets you clean up after finalization but before the space is reclaimed (replaces or augments the use offinalize())</td>
<td>Special clean up processing</td>
<td>After finalization.</td>
<td>java.lang.ref.PhantomReference</td>
</tr>
</tbody>
</table>
<h1 id="Java-GCå°ç»“"><a href="#Java-GCå°ç»“" class="headerlink" title="Java GCå°ç»“"></a>Java GCå°ç»“</h1><p>ä¸€èˆ¬çš„åº”ç”¨ç¨‹åºä¸ä¼šæ¶‰åŠåˆ° Reference ç¼–ç¨‹ï¼Œ ä½†æ˜¯äº†è§£è¿™äº›çŸ¥è¯†ä¼šå¯¹ç†è§£Java GC çš„å·¥ä½œåŸç†ä»¥åŠæ€§èƒ½è°ƒä¼˜æœ‰ä¸€å®šå¸®åŠ©, åœ¨å®ç°ä¸€äº›åŸºç¡€æ€§è®¾æ–½æ¯”å¦‚ç¼“å­˜æ—¶ä¹Ÿå¯èƒ½ä¼šç”¨åˆ°ï¼Œ å¸Œæœ›æœ¬æ–‡èƒ½æœ‰æ‰€å¸®åŠ©.</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Javaä¸­ä¸€å…±æœ‰4ç§ç±»å‹çš„å¼•ç”¨:StrongReferenceã€SoftReferenceã€WeakReferenceä»¥åŠPhantomReference (å¹½çµå¼•ç”¨), è¿™ 4 ç§ç±»å‹çš„å¼•ç”¨ä¸Java GCæœ‰ç€å¯†åˆ‡çš„å…³ç³», è®©æˆ‘ä»¬é€ä¸€æ¥çœ‹å®ƒä»¬çš„å®šä¹‰å’Œä½¿ç”¨åœºæ™¯ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="gc" scheme="http://idiotsky.me/tags/gc/"/>
    
  </entry>
  
  <entry>
    <title>redisçš„äº‹åŠ¡å’Œwatch</title>
    <link href="http://idiotsky.me/2016/09/03/redis-transaction-watch/"/>
    <id>http://idiotsky.me/2016/09/03/redis-transaction-watch/</id>
    <published>2016-09-03T14:43:12.000Z</published>
    <updated>2017-08-03T14:55:56.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="redisçš„äº‹åŠ¡"><a href="#redisçš„äº‹åŠ¡" class="headerlink" title="redisçš„äº‹åŠ¡"></a>redisçš„äº‹åŠ¡</h1><p>ä¸¥æ ¼æ„ä¹‰æ¥è®²,redisçš„äº‹åŠ¡å’Œæˆ‘ä»¬ç†è§£çš„ä¼ ç»Ÿæ•°æ®åº“(å¦‚mysql)çš„äº‹åŠ¡æ˜¯ä¸ä¸€æ ·çš„ã€‚<br><a id="more"></a></p>
<h2 id="redisä¸­çš„äº‹åŠ¡å®šä¹‰"><a href="#redisä¸­çš„äº‹åŠ¡å®šä¹‰" class="headerlink" title="redisä¸­çš„äº‹åŠ¡å®šä¹‰"></a>redisä¸­çš„äº‹åŠ¡å®šä¹‰</h2><p>Redisä¸­çš„äº‹åŠ¡ï¼ˆtransactionï¼‰æ˜¯ä¸€ç»„å‘½ä»¤çš„é›†åˆã€‚</p>
<p>äº‹åŠ¡åŒå‘½ä»¤ä¸€æ ·éƒ½æ˜¯Redisçš„æœ€å°æ‰§è¡Œå•ä½ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­çš„å‘½ä»¤è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚<br>äº‹åŠ¡çš„åŸç†æ˜¯å…ˆå°†å±äºä¸€ä¸ªäº‹åŠ¡çš„å‘½ä»¤å‘é€ç»™Redisï¼Œç„¶åå†è®©Redisä¾æ¬¡æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚</p>
<blockquote>
<p>Redisä¿è¯ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚å¦‚æœåœ¨å‘é€EXECå‘½ä»¤å‰å®¢æˆ·ç«¯æ–­çº¿äº†ï¼Œåˆ™Redisä¼šæ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—ï¼Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œã€‚è€Œä¸€æ—¦å®¢æˆ·ç«¯å‘é€äº†EXECå‘½ä»¤ï¼Œæ‰€æœ‰çš„å‘½ä»¤å°±éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå³ä½¿æ­¤åå®¢æˆ·ç«¯æ–­çº¿ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºRedisä¸­å·²ç»è®°å½•äº†æ‰€æœ‰è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼ŒRedisçš„äº‹åŠ¡è¿˜èƒ½ä¿è¯ä¸€ä¸ªäº‹åŠ¡å†…çš„å‘½ä»¤ä¾æ¬¡æ‰§è¡Œè€Œä¸è¢«å…¶ä»–å‘½ä»¤æ’å…¥ã€‚è¯•æƒ³å®¢æˆ·ç«¯Aéœ€è¦æ‰§è¡Œå‡ æ¡å‘½ä»¤ï¼ŒåŒæ—¶å®¢æˆ·ç«¯Bå‘é€äº†ä¸€æ¡å‘½ä»¤ï¼Œå¦‚æœä¸ä½¿ç”¨äº‹åŠ¡ï¼Œåˆ™å®¢æˆ·ç«¯Bçš„å‘½ä»¤å¯èƒ½ä¼šæ’å…¥åˆ°å®¢æˆ·ç«¯Açš„å‡ æ¡å‘½ä»¤ä¸­æ‰§è¡Œã€‚å¦‚æœä¸å¸Œæœ›å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äº‹åŠ¡ã€‚</p>
</blockquote>
<h2 id="äº‹åŠ¡çš„åº”ç”¨"><a href="#äº‹åŠ¡çš„åº”ç”¨" class="headerlink" title="äº‹åŠ¡çš„åº”ç”¨"></a>äº‹åŠ¡çš„åº”ç”¨</h2><blockquote>
<p>äº‹åŠ¡çš„åº”ç”¨éå¸¸æ™®éï¼Œå¦‚é“¶è¡Œè½¬è´¦è¿‡ç¨‹ä¸­Aç»™Bæ±‡æ¬¾ï¼Œé¦–å…ˆç³»ç»Ÿä»Açš„è´¦æˆ·ä¸­å°†é’±åˆ’èµ°ï¼Œç„¶åå‘Bçš„è´¦æˆ·å¢åŠ ç›¸åº”çš„é‡‘é¢ã€‚è¿™ä¸¤ä¸ªæ­¥éª¤å¿…é¡»å±äºåŒä¸€ä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚å¦åˆ™åªæ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œé’±å°±å‡­ç©ºæ¶ˆå¤±äº†ï¼Œè¿™æ˜¾ç„¶è®©äººæ— æ³•æ¥å—ã€‚</p>
</blockquote>
<h2 id="å’Œä¼ ç»Ÿçš„äº‹åŠ¡ä¸åŒ"><a href="#å’Œä¼ ç»Ÿçš„äº‹åŠ¡ä¸åŒ" class="headerlink" title="å’Œä¼ ç»Ÿçš„äº‹åŠ¡ä¸åŒ"></a>å’Œä¼ ç»Ÿçš„äº‹åŠ¡ä¸åŒ</h2><blockquote>
<p>å’Œä¼ ç»Ÿçš„mysqläº‹åŠ¡ä¸åŒçš„äº‹ï¼Œå³ä½¿æˆ‘ä»¬çš„åŠ é’±æ“ä½œå¤±è´¥,æˆ‘ä»¬ä¹Ÿæ— æ³•åœ¨è¿™ä¸€ç»„å‘½ä»¤ä¸­è®©æ•´ä¸ªçŠ¶æ€å›æ»šåˆ°æ“ä½œä¹‹å‰</p>
</blockquote>
<h2 id="äº‹åŠ¡çš„é”™è¯¯å¤„ç†"><a href="#äº‹åŠ¡çš„é”™è¯¯å¤„ç†" class="headerlink" title="äº‹åŠ¡çš„é”™è¯¯å¤„ç†"></a>äº‹åŠ¡çš„é”™è¯¯å¤„ç†</h2><p>å¦‚æœä¸€ä¸ªäº‹åŠ¡ä¸­çš„æŸä¸ªå‘½ä»¤æ‰§è¡Œå‡ºé”™ï¼ŒRedisä¼šæ€æ ·å¤„ç†å‘¢ï¼Ÿè¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä»€ä¹ˆåŸå› ä¼šå¯¼è‡´å‘½ä»¤æ‰§è¡Œå‡ºé”™ã€‚</p>
<h3 id="è¯­æ³•é”™è¯¯"><a href="#è¯­æ³•é”™è¯¯" class="headerlink" title="è¯­æ³•é”™è¯¯"></a>è¯­æ³•é”™è¯¯</h3><p>è¯­æ³•é”™è¯¯æŒ‡å‘½ä»¤ä¸å­˜åœ¨æˆ–è€…å‘½ä»¤å‚æ•°çš„ä¸ªæ•°ä¸å¯¹ã€‚æ¯”å¦‚ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">redisï¼MULTI</div><div class="line">OK</div><div class="line">redisï¼SET key value</div><div class="line">QUEUED</div><div class="line">redisï¼SET key</div><div class="line">(error)ERR wrong number of arguments <span class="keyword">for</span> <span class="string">'set'</span> <span class="built_in">command</span></div><div class="line">redisï¼ errorCOMMAND key</div><div class="line">(error) ERR unknown <span class="built_in">command</span> <span class="string">'errorCOMMAND'</span></div><div class="line">redisï¼ EXEC</div><div class="line">(error) EXECABORT Transaction discarded because of previous errors.</div></pre></td></tr></table></figure></p>
<p>è·Ÿåœ¨MULTIå‘½ä»¤åæ‰§è¡Œäº†3ä¸ªå‘½ä»¤ï¼šä¸€ä¸ªæ˜¯æ­£ç¡®çš„å‘½ä»¤ï¼ŒæˆåŠŸåœ°åŠ å…¥äº‹åŠ¡é˜Ÿåˆ—ï¼›å…¶ä½™ä¸¤ä¸ªå‘½ä»¤éƒ½æœ‰è¯­æ³•é”™è¯¯ã€‚è€Œåªè¦æœ‰ä¸€ä¸ªå‘½ä»¤æœ‰è¯­æ³•é”™è¯¯ï¼Œæ‰§è¡ŒEXECå‘½ä»¤åRediså°±ä¼šç›´æ¥è¿”å›é”™è¯¯ï¼Œè¿è¯­æ³•æ­£ç¡®çš„å‘½ä»¤ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚</p>
<h4 id="è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š"><a href="#è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š" class="headerlink" title="è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š"></a>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š</h4><p>Redis 2.6.5ä¹‹å‰çš„ç‰ˆæœ¬ä¼šå¿½ç•¥æœ‰è¯­æ³•é”™è¯¯çš„å‘½ä»¤ï¼Œç„¶åæ‰§è¡Œäº‹åŠ¡ä¸­å…¶ä»–è¯­æ³•æ­£ç¡®çš„å‘½ä»¤ã€‚å°±æ­¤ä¾‹è€Œè¨€ï¼ŒSET key valueä¼šè¢«æ‰§è¡Œï¼ŒEXECå‘½ä»¤ä¼šè¿”å›ä¸€ä¸ªç»“æœï¼š1) OKã€‚</p>
<h3 id="è¿è¡Œé”™è¯¯"><a href="#è¿è¡Œé”™è¯¯" class="headerlink" title="è¿è¡Œé”™è¯¯"></a>è¿è¡Œé”™è¯¯</h3><p>è¿è¡Œé”™è¯¯æŒ‡åœ¨å‘½ä»¤æ‰§è¡Œæ—¶å‡ºç°çš„é”™è¯¯ï¼Œæ¯”å¦‚ä½¿ç”¨æ•£åˆ—ç±»å‹çš„å‘½ä»¤æ“ä½œé›†åˆç±»å‹çš„é”®ï¼Œè¿™ç§é”™è¯¯åœ¨å®é™…æ‰§è¡Œä¹‹å‰Redisæ˜¯æ— æ³•å‘ç°çš„ï¼Œæ‰€ä»¥åœ¨äº‹åŠ¡é‡Œè¿™æ ·çš„å‘½ä»¤æ˜¯ä¼šè¢«Redisæ¥å—å¹¶æ‰§è¡Œçš„ã€‚å¦‚æœäº‹åŠ¡é‡Œçš„ä¸€æ¡å‘½ä»¤å‡ºç°äº†è¿è¡Œé”™è¯¯ï¼Œäº‹åŠ¡é‡Œå…¶ä»–çš„å‘½ä»¤ä¾ç„¶ä¼šç»§ç»­æ‰§è¡Œï¼ˆåŒ…æ‹¬å‡ºé”™å‘½ä»¤ä¹‹åçš„å‘½ä»¤ï¼‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">redisï¼MULTI</div><div class="line">OK</div><div class="line">redisï¼SET key 1</div><div class="line">QUEUED</div><div class="line">redisï¼SADD key 2</div><div class="line">QUEUED</div><div class="line">redisï¼SET key 3</div><div class="line">QUEUED</div><div class="line">redisï¼EXEC</div><div class="line">1) OK</div><div class="line">2) (error) ERR Operation against a key holding the wrong kind of value</div><div class="line">3) OK</div><div class="line">redisï¼GET key</div><div class="line"><span class="string">"3"</span></div></pre></td></tr></table></figure></p>
<p>å¯è§è™½ç„¶SADD key 2å‡ºç°äº†é”™è¯¯ï¼Œä½†æ˜¯SET key 3ä¾ç„¶æ‰§è¡Œäº†ã€‚</p>
<p>Redisçš„äº‹åŠ¡æ²¡æœ‰å…³ç³»æ•°æ®åº“äº‹åŠ¡æä¾›çš„å›æ»šï¼ˆrollbackï¼‰åŠŸèƒ½ã€‚ä¸ºæ­¤å¼€å‘è€…å¿…é¡»åœ¨äº‹åŠ¡æ‰§è¡Œå‡ºé”™åè‡ªå·±æ”¶æ‹¾å‰©ä¸‹çš„æ‘Šå­ï¼ˆå°†æ•°æ®åº“å¤åŸå›äº‹åŠ¡æ‰§è¡Œå‰çš„çŠ¶æ€ç­‰,è¿™é‡Œæˆ‘ä»¬ä¸€èˆ¬é‡‡å–æ—¥å¿—è®°å½•ç„¶åä¸šåŠ¡è¡¥å¿çš„æ–¹å¼æ¥å¤„ç†ï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨redisåšçš„æ“ä½œä¸åº”è¯¥æœ‰è¿™ç§å¼ºä¸€è‡´æ€§è¦æ±‚çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ç§éœ€æ±‚ä¸ºä¸åˆç†çš„è®¾è®¡ï¼‰ã€‚</p>
<h1 id="Watchå‘½ä»¤"><a href="#Watchå‘½ä»¤" class="headerlink" title="Watchå‘½ä»¤"></a>Watchå‘½ä»¤</h1><p>å¤§å®¶å¯èƒ½çŸ¥é“redisæä¾›äº†åŸºäºincrå‘½ä»¤æ¥æ“ä½œä¸€ä¸ªæ•´æ•°å‹æ•°å€¼çš„åŸå­é€’å¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‡è®¾å¦‚æœredisæ²¡æœ‰è¿™ä¸ªincrå‘½ä»¤ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆå®ç°è¿™ä¸ªincrçš„æ“ä½œå‘¢ï¼Ÿ</p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¸‹é¢çš„æ­£ä¸»<code>watch</code>å°±è¦ä¸Šåœºäº†ã€‚</p>
<h2 id="å¦‚ä½•ä½¿ç”¨watchå‘½ä»¤"><a href="#å¦‚ä½•ä½¿ç”¨watchå‘½ä»¤" class="headerlink" title="å¦‚ä½•ä½¿ç”¨watchå‘½ä»¤"></a>å¦‚ä½•ä½¿ç”¨watchå‘½ä»¤</h2><p>æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬æƒ³è¦å¯¹ä¸€ä¸ªæ•´å½¢æ•°å€¼åšä¿®æ”¹æ˜¯è¿™ä¹ˆåšçš„(ä¼ªä»£ç å®ç°)ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">val = GET mykey</div><div class="line">val = val + 1</div><div class="line">SET mykey <span class="variable">$val</span></div></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯ä¸Šè¿°çš„ä»£ç ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜,å› ä¸ºä¸Šé¢å§æ­£å¸¸çš„ä¸€ä¸ªincr(åŸå­é€’å¢æ“ä½œ)åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†,é‚£ä¹ˆåœ¨å¤šçº¿ç¨‹(åˆ†å¸ƒå¼)ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªæ“ä½œå°±æœ‰å¯èƒ½ä¸å†å…·æœ‰åŸå­æ€§äº†ã€‚</p>
<p>ç ”ç©¶è¿‡javaçš„jucåŒ…çš„äººåº”è¯¥éƒ½çŸ¥é“casï¼Œé‚£ä¹ˆredisä¹Ÿæä¾›äº†è¿™æ ·çš„ä¸€ä¸ªæœºåˆ¶ï¼Œå°±æ˜¯åˆ©ç”¨watchå‘½ä»¤æ¥å®ç°çš„ã€‚</p>
<h2 id="watchå‘½ä»¤æè¿°"><a href="#watchå‘½ä»¤æè¿°" class="headerlink" title="watchå‘½ä»¤æè¿°"></a>watchå‘½ä»¤æè¿°</h2><blockquote>
<p>WATCHå‘½ä»¤å¯ä»¥ç›‘æ§ä¸€ä¸ªæˆ–å¤šä¸ªé”®ï¼Œä¸€æ—¦å…¶ä¸­æœ‰ä¸€ä¸ªé”®è¢«ä¿®æ”¹ï¼ˆæˆ–åˆ é™¤ï¼‰ï¼Œä¹‹åçš„äº‹åŠ¡å°±ä¸ä¼šæ‰§è¡Œã€‚ç›‘æ§ä¸€ç›´æŒç»­åˆ°EXECå‘½ä»¤ï¼ˆäº‹åŠ¡ä¸­çš„å‘½ä»¤æ˜¯åœ¨EXECä¹‹åæ‰æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åœ¨MULTIå‘½ä»¤åå¯ä»¥ä¿®æ”¹WATCHç›‘æ§çš„é”®å€¼ï¼‰</p>
</blockquote>
<h2 id="åˆ©ç”¨watchå®ç°incr"><a href="#åˆ©ç”¨watchå®ç°incr" class="headerlink" title="åˆ©ç”¨watchå®ç°incr"></a>åˆ©ç”¨watchå®ç°incr</h2><p>å…·ä½“åšæ³•å¦‚ä¸‹:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">WATCH mykey</div><div class="line">val = GET mykey</div><div class="line">val = val + 1</div><div class="line">MULTI</div><div class="line">SET mykey <span class="variable">$val</span></div><div class="line">EXEC</div></pre></td></tr></table></figure></p>
<p>å’Œæ­¤å‰ä»£ç ä¸åŒçš„æ˜¯ï¼Œæ–°ä»£ç åœ¨è·å–mykeyçš„å€¼ä¹‹å‰å…ˆé€šè¿‡WATCHå‘½ä»¤ç›‘æ§äº†è¯¥é”®ï¼Œæ­¤ååˆå°†setå‘½ä»¤åŒ…å›´åœ¨äº‹åŠ¡ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆçš„ä¿è¯æ¯ä¸ªè¿æ¥åœ¨æ‰§è¡ŒEXECä¹‹å‰ï¼Œå¦‚æœå½“å‰è¿æ¥è·å–çš„mykeyçš„å€¼è¢«å…¶å®ƒè¿æ¥çš„å®¢æˆ·ç«¯ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“å‰è¿æ¥çš„EXECå‘½ä»¤å°†æ‰§è¡Œå¤±è´¥ã€‚è¿™æ ·è°ƒç”¨è€…åœ¨åˆ¤æ–­è¿”å›å€¼åå°±å¯ä»¥è·æ‚‰valæ˜¯å¦è¢«é‡æ–°è®¾ç½®æˆåŠŸã€‚</p>
<h2 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h2><p>ç”±äºWATCHå‘½ä»¤çš„ä½œç”¨åªæ˜¯å½“è¢«ç›‘æ§çš„é”®å€¼è¢«ä¿®æ”¹åé˜»æ­¢ä¹‹åä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œï¼Œè€Œä¸èƒ½ä¿è¯å…¶ä»–å®¢æˆ·ç«¯ä¸ä¿®æ”¹è¿™ä¸€é”®å€¼ï¼Œæ‰€ä»¥åœ¨ä¸€èˆ¬çš„æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦åœ¨EXECæ‰§è¡Œå¤±è´¥åé‡æ–°æ‰§è¡Œæ•´ä¸ªå‡½æ•°ã€‚</p>
<p>æ‰§è¡ŒEXECå‘½ä»¤åä¼šå–æ¶ˆå¯¹æ‰€æœ‰é”®çš„ç›‘æ§ï¼Œå¦‚æœä¸æƒ³æ‰§è¡Œäº‹åŠ¡ä¸­çš„å‘½ä»¤ä¹Ÿå¯ä»¥ä½¿ç”¨UNWATCHå‘½ä»¤æ¥å–æ¶ˆç›‘æ§ã€‚</p>
<h2 id="å®ç°ä¸€ä¸ªhsetNXå‡½æ•°"><a href="#å®ç°ä¸€ä¸ªhsetNXå‡½æ•°" class="headerlink" title="å®ç°ä¸€ä¸ªhsetNXå‡½æ•°"></a>å®ç°ä¸€ä¸ªhsetNXå‡½æ•°</h2><p>æˆ‘ä»¬å®ç°çš„hsetNXè¿™ä¸ªåŠŸèƒ½æ˜¯ï¼šä»…å½“å­—æ®µå­˜åœ¨æ—¶æ‰èµ‹å€¼ã€‚</p>
<p>ä¸ºäº†é¿å…ç«æ€æ¡ä»¶æˆ‘ä»¬ä½¿ç”¨watchå’Œäº‹åŠ¡æ¥å®Œæˆè¿™ä¸€åŠŸèƒ½ï¼ˆä¼ªä»£ç ï¼‰ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">WATCH key  </div><div class="line">isFieldExists = HEXISTS key, field  </div><div class="line"><span class="keyword">if</span> isFieldExists is 1  </div><div class="line">MULTI  </div><div class="line">HSET key, field, value  </div><div class="line">EXEC  </div><div class="line"><span class="keyword">else</span>  </div><div class="line">UNWATCH  </div><div class="line"><span class="built_in">return</span> isFieldExists</div></pre></td></tr></table></figure></p>
<p>åœ¨ä»£ç ä¸­ä¼šåˆ¤æ–­è¦èµ‹å€¼çš„å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­—æ®µä¸å­˜åœ¨çš„è¯å°±ä¸æ‰§è¡Œäº‹åŠ¡ä¸­çš„å‘½ä»¤ï¼Œä½†éœ€è¦ä½¿ç”¨UNWATCHå‘½ä»¤æ¥ä¿è¯ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸ä¼šå—åˆ°å½±å“ã€‚</p>
<p>åŸæ–‡åœ°å€ <a href="http://www.jianshu.com/p/361cb9cd13d5" target="_blank" rel="external">http://www.jianshu.com/p/361cb9cd13d5</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;redisçš„äº‹åŠ¡&quot;&gt;&lt;a href=&quot;#redisçš„äº‹åŠ¡&quot; class=&quot;headerlink&quot; title=&quot;redisçš„äº‹åŠ¡&quot;&gt;&lt;/a&gt;redisçš„äº‹åŠ¡&lt;/h1&gt;&lt;p&gt;ä¸¥æ ¼æ„ä¹‰æ¥è®²,redisçš„äº‹åŠ¡å’Œæˆ‘ä»¬ç†è§£çš„ä¼ ç»Ÿæ•°æ®åº“(å¦‚mysql)çš„äº‹åŠ¡æ˜¯ä¸ä¸€æ ·çš„ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="redis" scheme="http://idiotsky.me/categories/redis/"/>
    
    
      <category term="redis" scheme="http://idiotsky.me/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¤šçº¿ç¨‹(äºŒ) åŒæ­¥å’Œé”</title>
    <link href="http://idiotsky.me/2016/08/20/java-thread-2-md/"/>
    <id>http://idiotsky.me/2016/08/20/java-thread-2-md/</id>
    <published>2016-08-20T14:55:34.000Z</published>
    <updated>2017-08-20T08:06:57.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è®°å½•ï¼Œæ±‡æ€»</p>
</blockquote>
<a id="more"></a>
<h1 id="çº¿ç¨‹åŒæ­¥é—®é¢˜çš„äº§ç”Ÿ"><a href="#çº¿ç¨‹åŒæ­¥é—®é¢˜çš„äº§ç”Ÿ" class="headerlink" title="çº¿ç¨‹åŒæ­¥é—®é¢˜çš„äº§ç”Ÿ"></a>çº¿ç¨‹åŒæ­¥é—®é¢˜çš„äº§ç”Ÿ</h1><p>ä»€ä¹ˆæ˜¯çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µå–ç¥¨ç³»ç»Ÿçš„ä»£ç ï¼Œç„¶åå†åˆ†æè¿™ä¸ªé—®é¢˜ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketSeller</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span>  <span class="keyword">int</span> num = <span class="number">100</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span>(num&gt;<span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">try</span>&#123;</div><div class="line">                    Thread.sleep(<span class="number">10</span>);</div><div class="line">                &#125;<span class="keyword">catch</span> (InterruptedException e)</div><div class="line">                &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//è¾“å‡ºå–ç¥¨ä¿¡æ¯</span></div><div class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">".....sale...."</span>+num--);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢æ˜¯å–ç¥¨çº¿ç¨‹ç±»ï¼Œä¸‹æ¥å†æ¥çœ‹çœ‹æ‰§è¡Œç±»ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TickeDemo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">    &#123;</div><div class="line">        TicketSeller t = <span class="keyword">new</span> TicketSeller();<span class="comment">//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡å¯¹è±¡ã€‚</span></div><div class="line"></div><div class="line">        <span class="comment">//åˆ›å»º4ä¸ªçº¿ç¨‹åŒæ—¶å–ç¥¨</span></div><div class="line">        Thread t1 = <span class="keyword">new</span> Thread(t);</div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(t);</div><div class="line">        Thread t3 = <span class="keyword">new</span> Thread(t);</div><div class="line">        Thread t4 = <span class="keyword">new</span> Thread(t);</div><div class="line">        <span class="comment">//å¯åŠ¨çº¿ç¨‹</span></div><div class="line">        t1.start();</div><div class="line">        t2.start();</div><div class="line">        t3.start();</div><div class="line">        t4.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œç¨‹åºç»“æœå¦‚ä¸‹ï¼ˆä»…æˆªå–éƒ¨åˆ†æ•°æ®ï¼‰ï¼š<br><a href="/images/java-thread-2-1.png"><img src="/images/java-thread-2-1.png" alt=""></a><br>ä»è¿è¡Œç»“æœï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæˆ‘ä»¬3ä¸ªå”®ç¥¨çª—å£åŒæ—¶å–å‡ºäº†96å·ç¥¨ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆé€»è¾‘çš„ï¼Œå…¶å®è¿™ä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è¯´çš„çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚ä¸åŒçš„çº¿ç¨‹éƒ½å¯¹åŒä¸€ä¸ªæ•°æ®è¿›äº†æ“ä½œè¿™å°±å®¹æ˜“å¯¼è‡´æ•°æ®é”™ä¹±çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ä¸åŒæ­¥ã€‚é‚£ä¹ˆè¿™ä¸ªé—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿåœ¨ç»™å‡ºè§£å†³æ€è·¯ä¹‹å‰æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹è¿™ä¸ªé—®é¢˜æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ï¼Ÿæˆ‘ä»¬å£°æ˜ä¸€ä¸ªçº¿ç¨‹ç±»TicketSellerï¼Œåœ¨è¿™ä¸ªç±»ä¸­æˆ‘ä»¬åˆå£°æ˜äº†ä¸€ä¸ªæˆå‘˜å˜é‡numä¹Ÿå°±æ˜¯ç¥¨çš„æ•°é‡ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡runæ–¹æ³•ä¸æ–­çš„å»è·å–ç¥¨æ•°å¹¶è¾“å‡ºï¼Œæœ€åæˆ‘ä»¬åœ¨å¤–éƒ¨ç±»TicketDemoä¸­åˆ›å»ºäº†å››ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œè¿™ä¸ªæ•°æ®ï¼Œè¿è¡Œåå°±å‡ºç°æˆ‘ä»¬åˆšæ‰æ‰€è¯´çš„çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºäº§ç”Ÿçº¿ç¨‹åŒæ­¥(çº¿ç¨‹å®‰å…¨)é—®é¢˜çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š1.å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œå…±äº«çš„æ•°æ®ï¼ˆnumï¼‰ï¼Œ2.æ“ä½œå…±äº«æ•°æ®çš„çº¿ç¨‹ä»£ç æœ‰å¤šæ¡ï¼ˆ4æ¡çº¿ç¨‹ï¼‰ï¼›æ—¢ç„¶åŸå› çŸ¥é“äº†ï¼Œé‚£è¯¥æ€ä¹ˆè§£å†³ï¼Ÿ</p>
<blockquote>
<p>è§£å†³æ€è·¯ï¼šå°†å¤šæ¡æ“ä½œå…±äº«æ•°æ®çš„çº¿ç¨‹ä»£ç å°è£…èµ·æ¥ï¼Œå½“æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œè¿™äº›ä»£ç çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹æ—¶ä¸å¯ä»¥å‚ä¸è¿ç®—çš„ã€‚å¿…é¡»è¦å½“å‰çº¿ç¨‹æŠŠè¿™äº›ä»£ç éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œå…¶ä»–çº¿ç¨‹æ‰å¯ä»¥å‚ä¸è¿ç®—ã€‚ å¥½äº†ï¼Œæ€è·¯çŸ¥é“äº†ï¼Œæˆ‘ä»¬å°±ç”¨javaä»£ç çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
</blockquote>
<h1 id="è§£å†³çº¿ç¨‹åŒæ­¥çš„ä¸¤ç§å…¸å‹æ–¹æ¡ˆ"><a href="#è§£å†³çº¿ç¨‹åŒæ­¥çš„ä¸¤ç§å…¸å‹æ–¹æ¡ˆ" class="headerlink" title="è§£å†³çº¿ç¨‹åŒæ­¥çš„ä¸¤ç§å…¸å‹æ–¹æ¡ˆ"></a>è§£å†³çº¿ç¨‹åŒæ­¥çš„ä¸¤ç§å…¸å‹æ–¹æ¡ˆ</h1><p>åœ¨javaä¸­æœ‰ä¸¤ç§æœºåˆ¶å¯ä»¥é˜²æ­¢çº¿ç¨‹å®‰å…¨çš„å‘ç”Ÿï¼ŒJavaè¯­è¨€æä¾›äº†ä¸€ä¸ªsynchronizedå…³é”®å­—æ¥è§£å†³è¿™é—®é¢˜ï¼ŒåŒæ—¶åœ¨Java SE5.0å¼•å…¥äº†Locké”å¯¹è±¡çš„ç›¸å…³ç±»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«ä»‹ç»è¿™ä¸¤ç§æ–¹æ³•</p>
<h2 id="é€šè¿‡é”ï¼ˆLockï¼‰å¯¹è±¡çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#é€šè¿‡é”ï¼ˆLockï¼‰å¯¹è±¡çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="é€šè¿‡é”ï¼ˆLockï¼‰å¯¹è±¡çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜"></a>é€šè¿‡é”ï¼ˆLockï¼‰å¯¹è±¡çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜</h2><p>åœ¨ç»™å‡ºè§£å†³ä»£ç å‰æˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šLockï¼Œé”å¯¹è±¡ã€‚åœ¨javaä¸­é”æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼ˆä½†æœ‰çš„é”å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«èµ„æºï¼Œæ¯”å¦‚è¯»å†™é”ï¼Œåé¢æˆ‘ä»¬ä¼šåˆ†æï¼‰ã€‚åœ¨Lockæ¥å£å‡ºç°ä¹‹å‰ï¼Œjavaç¨‹åºæ˜¯é synchronizedå…³é”®å­—ï¼ˆåé¢åˆ†æï¼‰å®ç°é”åŠŸèƒ½çš„ï¼Œè€ŒJAVA SE5.0ä¹‹åå¹¶å‘åŒ…ä¸­æ–°å¢äº†Lockæ¥å£ç”¨æ¥å®ç°é”çš„åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸synchronizedå…³é”®å­—ç±»ä¼¼çš„åŒæ­¥åŠŸèƒ½ï¼Œåªæ˜¯åœ¨ä½¿ç”¨æ—¶éœ€è¦æ˜¾å¼åœ°è·å–å’Œé‡Šæ”¾é”ï¼Œç¼ºç‚¹å°±æ˜¯ç¼ºå°‘åƒsynchronizedé‚£æ ·éšå¼è·å–é‡Šæ”¾é”çš„ä¾¿æ·æ€§ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†é”è·å–ä¸é‡Šæ”¾çš„å¯æ“ä½œæ€§ï¼Œå¯ä¸­æ–­çš„è·å–é”ä»¥åŠè¶…æ—¶è·å–é”ç­‰å¤šç§synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„åŒæ­¥ç‰¹æ€§ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ä»‹ç»Lockæ¥å£çš„ä¸»è¦APIæ–¹ä¾¿æˆ‘ä»¬å­¦ä¹ </p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç›¸å…³æè¿°å†…å®¹ </th>
</tr>
</thead>
<tbody>
<tr>
<td>void lock()</td>
<td>è·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å½“å‰çº¿ç¨‹ä¼šè·å–é”ï¼Œå½“è·å–é”åã€‚ä»è¯¥æ–¹æ³•è¿”å›</td>
</tr>
<tr>
<td>void lockInterruptibly() throws InterruptedException</td>
<td>å¯ä¸­æ–­è·å–é”å’Œlock()æ–¹æ³•ä¸åŒçš„æ˜¯è¯¥æ–¹æ³•ä¼šå“åº”ä¸­æ–­ï¼Œå³åœ¨è·å–é”ä¸­å¯ä»¥ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚ä¾‹å¦‚æŸä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ä¸€ä¸ªé”çš„æ§åˆ¶æƒçš„è¿™æ®µæ—¶é—´éœ€è¦ä¸­æ–­ã€‚</td>
</tr>
<tr>
<td>boolean tryLock()</td>
<td>å°è¯•éé˜»å¡è·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•åç«‹å³è¿”å›ï¼Œå¦‚æœèƒ½å¤Ÿè·å–é”åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</td>
</tr>
<tr>
<td>boolean tryLock(long time,TimeUnit unit) throws  InterruptedException</td>
<td>è¶…æ—¶è·å–é”ï¼Œå½“å‰çº¿ç¨‹åœ¨ä»¥ä¸‹3ç§æƒ…å†µè¿”å›ï¼š1.å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è·å–äº†é”2.å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´è¢«ä¸­æ–­3.å½“å‰çº¿ç¨‹è¶…æ—¶æ—¶é—´ç»“æŸï¼Œè¿”å›false</td>
</tr>
<tr>
<td>void unlock()</td>
<td>é‡Šæ”¾é”</td>
</tr>
<tr>
<td>Condition newCondition()</td>
<td>æ¡ä»¶å¯¹è±¡ï¼Œè·å–ç­‰å¾…é€šçŸ¥ç»„ä»¶ã€‚è¯¥ç»„ä»¶å’Œå½“å‰çš„é”ç»‘å®šï¼Œå½“å‰çº¿ç¨‹åªæœ‰è·å–äº†é”ï¼Œæ‰èƒ½è°ƒç”¨è¯¥ç»„ä»¶çš„await()æ–¹æ³•ï¼Œè€Œè°ƒç”¨åï¼Œå½“å‰çº¿ç¨‹å°†é‡Šæ”¾é”ã€‚</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œå…ˆä»‹ç»ä¸€ä¸‹APIï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ç»“åˆLockæ¥å£çš„å®ç°å­ç±»ReentrantLockæ¥è®²è§£ä¸‹ä»–çš„å‡ ä¸ªæ–¹æ³•ã€‚</p>
<h3 id="ReentrantLockï¼ˆé‡å…¥é”"><a href="#ReentrantLockï¼ˆé‡å…¥é”" class="headerlink" title="ReentrantLockï¼ˆé‡å…¥é”)"></a>ReentrantLockï¼ˆé‡å…¥é”)</h3><p>é‡å…¥é”ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æ”¯æŒé‡æ–°è¿›å…¥çš„é”ï¼Œå®ƒè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è°ƒç”¨lock()æ–¹æ³•æ—¶ï¼Œå·²ç»è·å–åˆ°é”çš„çº¿ç¨‹ï¼Œèƒ½å¤Ÿå†æ¬¡è°ƒç”¨lock()æ–¹æ³•è·å–é”è€Œä¸è¢«é˜»å¡ï¼ŒåŒæ—¶è¿˜æ”¯æŒè·å–é”çš„å…¬å¹³æ€§å’Œéå…¬å¹³æ€§ã€‚è¿™é‡Œçš„å…¬å¹³æ˜¯åœ¨ç»å¯¹æ—¶é—´ä¸Šï¼Œå…ˆå¯¹é”è¿›è¡Œè·å–çš„è¯·æ±‚ä¸€å®šå…ˆè¢«æ»¡è¶³ï¼Œé‚£ä¹ˆè¿™ä¸ªé”æ˜¯å…¬å¹³é”ï¼Œåä¹‹ï¼Œæ˜¯ä¸å…¬å¹³çš„(ä½†æ˜¯å¦‚æœä¸æ˜¯éœ€è¦ï¼Œå»ºè®®ä¸è¦ç”¨å…¬å¹³é”ï¼Œå› ä¸ºä¼šé€ æˆä¸€äº›èµ„æºçš„æ²¡å¿…è¦ç­‰å¾…ï¼Œæµªè´¹æ€§èƒ½)ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿçœ‹èŒƒä¾‹ä»£ç ï¼š<br>1.åŒæ­¥æ‰§è¡Œçš„ä»£ç è·Ÿsynchronizedç±»ä¼¼åŠŸèƒ½ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(); <span class="comment">//å‚æ•°é»˜è®¤falseï¼Œä¸å…¬å¹³é”    </span></div><div class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>); <span class="comment">//å…¬å¹³é”    </span></div><div class="line">    </div><div class="line">lock.lock(); <span class="comment">//å¦‚æœè¢«å…¶å®ƒèµ„æºé”å®šï¼Œä¼šåœ¨æ­¤ç­‰å¾…é”é‡Šæ”¾ï¼Œè¾¾åˆ°æš‚åœçš„æ•ˆæœ    </span></div><div class="line"><span class="keyword">try</span> &#123;    </div><div class="line">    <span class="comment">//æ“ä½œ    </span></div><div class="line">&#125; <span class="keyword">finally</span> &#123;    </div><div class="line">    lock.unlock();  <span class="comment">//é‡Šæ”¾é”  </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>2.é˜²æ­¢é‡å¤æ‰§è¡Œä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();    </div><div class="line"><span class="keyword">if</span> (lock.tryLock()) &#123;  <span class="comment">//å¦‚æœå·²ç»è¢«lockï¼Œåˆ™ç«‹å³è¿”å›falseä¸ä¼šç­‰å¾…ï¼Œè¾¾åˆ°å¿½ç•¥æ“ä½œçš„æ•ˆæœ     </span></div><div class="line">    <span class="keyword">try</span> &#123;    </div><div class="line">        <span class="comment">//æ“ä½œ    </span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;    </div><div class="line">        lock.unlock();    </div><div class="line">   &#125;    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3.å°è¯•ç­‰å¾…æ‰§è¡Œçš„ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>); <span class="comment">//å…¬å¹³é”    </span></div><div class="line"><span class="keyword">try</span> &#123;    </div><div class="line">    <span class="keyword">if</span> (lock.tryLock(<span class="number">5</span>, TimeUnit.SECONDS)) &#123;        </div><div class="line">        <span class="comment">//å¦‚æœå·²ç»è¢«lockï¼Œå°è¯•ç­‰å¾…5sï¼Œçœ‹æ˜¯å¦å¯ä»¥è·å¾—é”ï¼Œå¦‚æœ5såä»ç„¶æ— æ³•è·å¾—é”åˆ™è¿”å›falseç»§ç»­æ‰§è¡Œ    </span></div><div class="line">       <span class="keyword">try</span> &#123;    </div><div class="line">            <span class="comment">//æ“ä½œ    </span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;    </div><div class="line">            lock.unlock();    </div><div class="line">        &#125;    </div><div class="line">    &#125;    </div><div class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;    </div><div class="line">    e.printStackTrace(); <span class="comment">//å½“å‰çº¿ç¨‹è¢«ä¸­æ–­æ—¶(interrupt)ï¼Œä¼šæŠ›InterruptedException                     </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œæœ‰ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ï¼ŒæŠŠè§£é”æ“ä½œæ”¾åœ¨finallyä»£ç å—å†…è¿™ä¸ªååˆ†é‡è¦ã€‚å¦‚æœåœ¨ä¸´ç•ŒåŒºçš„ä»£ç æŠ›å‡ºå¼‚å¸¸ï¼Œé”å¿…é¡»è¢«é‡Šæ”¾ã€‚å¦åˆ™ï¼Œå…¶ä»–çº¿ç¨‹å°†æ°¸è¿œé˜»å¡ã€‚å¥½äº†ï¼ŒReentrantLockæˆ‘ä»¬å°±ç®€å•ä»‹ç»åˆ°è¿™é‡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ReentrantLockæ¥è§£å†³å‰é¢å–ç¥¨çº¿ç¨‹çš„çº¿ç¨‹åŒæ­¥ï¼ˆå®‰å…¨ï¼‰é—®é¢˜ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketSellerWithLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºé”å¯¹è±¡</span></div><div class="line">    <span class="keyword">private</span> Lock ticketLock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºé”å¯¹è±¡(å…¬å¹³é”)</span></div><div class="line">    <span class="comment">//private Lock ticketLock = new ReentrantLock(true);</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span>  <span class="keyword">int</span> num = <span class="number">100</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</div><div class="line">        &#123;</div><div class="line">            ticketLock.lock();<span class="comment">//è·å–é”</span></div><div class="line">            <span class="keyword">if</span>(num&gt;<span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">try</span>&#123;</div><div class="line">                    Thread.sleep(<span class="number">10</span>);</div><div class="line">                    <span class="comment">//è¾“å‡ºå–ç¥¨ä¿¡æ¯</span></div><div class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">".....sale...."</span>+num--);</div><div class="line">                &#125;<span class="keyword">catch</span> (InterruptedException e)</div><div class="line">                &#123;</div><div class="line">                    Thread.currentThread().interrupt();<span class="comment">//ç»§ç»­ä¸­æ–­å¼‚å¸¸</span></div><div class="line">                &#125;<span class="keyword">finally</span> &#123;</div><div class="line">                    ticketLock.unlock();<span class="comment">//é‡Šæ”¾é”</span></div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                ticketLock.unlock();<span class="comment">//é‡Šæ”¾é”</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TicketDemoç±»æ— éœ€å˜åŒ–ï¼Œçº¿ç¨‹å®‰å…¨é—®é¢˜å°±æ­¤è§£å†³ã€‚<br>ä½†æ˜¯è¿˜æ˜¯è¦è¯´ä¸€ä¸‹å…¬å¹³é”çš„é—®é¢˜ï¼Œä¸Šé¢ä¾‹å­ï¼Œä¸å¼€å…¬å¹³é”çš„ç»“æœå¦‚ä¸‹ï¼š<br><a href="/images/java-thread-2-2.png"><img src="/images/java-thread-2-2.png" alt=""></a><br>å¼€å…¬å¹³é”çš„ç»“æœå¦‚ä¸‹ï¼š<br><a href="/images/java-thread-2-3.png"><img src="/images/java-thread-2-3.png" alt=""></a><br><em>ä½ ä¼šå‘ç°ä¸å¼€å…¬å¹³é”ï¼Œcpué’Ÿçˆ±ç”¨ç¬¬ä¸€ä¸ªçº¿ç¨‹åšäº‹æƒ…ï¼Œè€Œå¼€äº†å…¬å¹³é”åï¼ŒåŸºæœ¬æ˜¯å„ä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚ä¸Šé¢æåˆ°å…¬å¹³é”æ˜¯ä¼šæ¶ˆè€—æ€§èƒ½çš„ï¼Œå¦‚æœCPUè°ƒåº¦çš„æ—¶å€™é€‰æ‹©çš„ä¸æ˜¯å…¬å¹³è°ƒåº¦çš„é‚£ä¸ªçº¿ç¨‹ï¼ŒCPUä¼šæ”¾å¼ƒæœ¬æ¬¡è°ƒåº¦ï¼Œå¹²åˆ«çš„äº‹æƒ…ï¼Œå¦‚æœè€æ˜¯è°ƒåº¦ä¸åˆ°çš„è¯ï¼Œæ˜¯æµªè´¹CPUè°ƒåº¦çš„ã€‚</em></p>
<h2 id="é€šè¿‡synchroniedå…³é”®å­—çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#é€šè¿‡synchroniedå…³é”®å­—çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="é€šè¿‡synchroniedå…³é”®å­—çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜"></a>é€šè¿‡synchroniedå…³é”®å­—çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜</h2><p>åœ¨Javaä¸­å†…ç½®äº†è¯­è¨€çº§çš„åŒæ­¥åŸè¯­ï¼synchronizedï¼Œè¿™ä¸ªå¯ä»¥å¤§å¤§ç®€åŒ–äº†Javaä¸­å¤šçº¿ç¨‹åŒæ­¥çš„ä½¿ç”¨ã€‚ä»JAVA SE1.0å¼€å§‹ï¼Œjavaä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå†…éƒ¨é”ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•ä½¿ç”¨synchronizedå…³é”®å­—è¿›è¡Œå£°æ˜ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¿æŠ¤æ•´ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨è¯¥æ–¹æ³•çº¿ç¨‹å¿…é¡»è·å¾—å†…éƒ¨çš„å¯¹è±¡é”ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> method&#123;  </div><div class="line">  <span class="comment">//method body  </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç­‰ä»·äº<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Lock ticketLock = <span class="keyword">new</span> ReentrantLock();  </div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> method&#123;  </div><div class="line"> ticketLock.lock();  </div><div class="line"> <span class="keyword">try</span>&#123;  </div><div class="line">  <span class="comment">//.......  </span></div><div class="line"> &#125;<span class="keyword">finally</span>&#123;  </div><div class="line">   ticketLock.unlock();  </div><div class="line"> &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºä½¿ç”¨synchronizedå…³é”®å­—æ¥ç¼–å†™ä»£ç è¦ç®€æ´å¾—å¤šäº†ã€‚å½“ç„¶ï¼Œè¦ç†è§£è¿™ä¸€ä»£ç ï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå†…éƒ¨é”ï¼Œå¹¶ä¸”è¯¥é”æœ‰ä¸€ä¸ªå†…éƒ¨æ¡ä»¶ã€‚ç”±é”æ¥ç®¡ç†é‚£äº›è¯•å›¾è¿›å…¥synchronizedæ–¹æ³•çš„çº¿ç¨‹ï¼Œç”±æ¡ä»¶æ¥ç®¡é‚£äº›è°ƒç”¨waitçš„çº¿ç¨‹(wait()/notifyAll/notify())ã€‚åŒæ—¶æˆ‘ä»¬å¿…é¡»æ˜ç™½ä¸€æ—¦æœ‰ä¸€ä¸ªçº¿ç¨‹é€šè¿‡synchroniedæ–¹æ³•è·å–åˆ°å†…éƒ¨é”ï¼Œè¯¥ç±»çš„æ‰€æœ‰synchroniedæ–¹æ³•æˆ–è€…ä»£ç å—éƒ½æ— æ³•è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ç›´åˆ°å½“å‰çº¿ç¨‹é‡Šæ”¾äº†å†…éƒ¨é”ã€‚åˆšæ‰ä¸Šé¢è¯´çš„æ˜¯åŒæ­¥æ–¹æ³•ï¼Œsynchronizedè¿˜æœ‰ä¸€ç§åŒæ­¥ä»£ç å—çš„å®ç°æ–¹å¼ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Object obj = <span class="keyword">new</span> Object();  </div><div class="line"><span class="keyword">synchronized</span>(obj)&#123;  </div><div class="line">  <span class="comment">//éœ€è¦åŒæ­¥çš„ä»£ç   </span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­objæ˜¯å¯¹è±¡é”ï¼Œå¯ä»¥æ˜¯ä»»æ„å¯¹è±¡ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±é€šè¿‡å…¶ä¸­çš„ä¸€ä¸ªæ–¹æ³•æ¥è§£å†³å”®ç¥¨ç³»ç»Ÿçš„çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ticket</span> <span class="keyword">implements</span> <span class="title">Runnable</span>  </span></div><div class="line">&#123;  </div><div class="line">    <span class="keyword">private</span>  <span class="keyword">int</span> num = <span class="number">100</span>;  </div><div class="line">    Object obj = <span class="keyword">new</span> Object();  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span>  </span></div><div class="line">    &#123;  </div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)  </div><div class="line">        &#123;  </div><div class="line">            <span class="keyword">synchronized</span>(obj)  </div><div class="line">            &#123;  </div><div class="line">                <span class="keyword">if</span>(num&gt;<span class="number">0</span>)  </div><div class="line">                &#123;  </div><div class="line">                    <span class="keyword">try</span>&#123;Thread.sleep(<span class="number">10</span>);&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;&#125;  </div><div class="line">                      </div><div class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">".....sale...."</span>+num--);  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å—¯ï¼ŒåŒæ­¥ä»£ç å—è§£å†³ï¼Œè¿è¡Œç»“æœä¹Ÿæ­£å¸¸ã€‚åˆ°æ­¤åŒæ­¥é—®é¢˜ä¹Ÿå°±è§£å†³äº†ï¼Œå½“ç„¶ä»£ç åŒæ­¥ä¹Ÿæ˜¯è¦ç‰ºç‰²æ•ˆç‡ä¸ºå‰æçš„ï¼š<br>åŒæ­¥çš„å¥½å¤„ï¼šè§£å†³äº†çº¿ç¨‹çš„å®‰å…¨é—®é¢˜ã€‚<br>åŒæ­¥çš„å¼Šç«¯ï¼šç›¸å¯¹é™ä½äº†æ•ˆç‡ï¼Œå› ä¸ºåŒæ­¥å¤–çš„çº¿ç¨‹çš„éƒ½ä¼šåˆ¤æ–­åŒæ­¥é”ã€‚<br>åŒæ­¥çš„å‰æï¼šåŒæ­¥ä¸­å¿…é¡»æœ‰å¤šä¸ªçº¿ç¨‹å¹¶ä½¿ç”¨åŒä¸€ä¸ªé”ã€‚</p>
<h1 id="çº¿ç¨‹é—´çš„é€šä¿¡æœºåˆ¶"><a href="#çº¿ç¨‹é—´çš„é€šä¿¡æœºåˆ¶" class="headerlink" title="çº¿ç¨‹é—´çš„é€šä¿¡æœºåˆ¶"></a>çº¿ç¨‹é—´çš„é€šä¿¡æœºåˆ¶</h1><p>çº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œæ‹¥æœ‰è‡ªå·±çš„æ ˆç©ºé—´ï¼Œä½†æ˜¯å¦‚æœæ¯ä¸ªè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå¦‚æœä»…ä»…æ˜¯å­¤ç«‹åœ°è¿è¡Œï¼Œé‚£ä¹ˆæ²¡æœ‰ä¸€ç‚¹å„¿ä»·å€¼ï¼Œæˆ–è€…æ˜¯ä»·å€¼å¾ˆå°ï¼Œå¦‚æœå¤šçº¿ç¨‹èƒ½å¤Ÿç›¸äº’é…åˆå®Œæˆå·¥ä½œçš„è¯ï¼Œè¿™å°†å¸¦æ¥å·¨å¤§çš„ä»·å€¼ï¼Œè¿™ä¹Ÿå°±æ˜¯çº¿ç¨‹é—´çš„é€šä¿¡å•¦ã€‚åœ¨javaä¸­å¤šçº¿ç¨‹é—´çš„é€šä¿¡ä½¿ç”¨çš„æ˜¯ç­‰å¾…/é€šçŸ¥æœºåˆ¶æ¥å®ç°çš„ã€‚</p>
<h2 id="synchroniedå…³é”®å­—ç­‰å¾…-é€šçŸ¥æœºåˆ¶"><a href="#synchroniedå…³é”®å­—ç­‰å¾…-é€šçŸ¥æœºåˆ¶" class="headerlink" title="synchroniedå…³é”®å­—ç­‰å¾…/é€šçŸ¥æœºåˆ¶"></a>synchroniedå…³é”®å­—ç­‰å¾…/é€šçŸ¥æœºåˆ¶</h2><p>æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨äº†å¯¹è±¡Oçš„wait()æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹Bè°ƒç”¨äº†å¯¹è±¡Oçš„notify()æˆ–è€…notifyAll()æ–¹æ³•ï¼Œçº¿ç¨‹Aæ”¶åˆ°é€šçŸ¥åä»å¯¹è±¡Oçš„wait()æ–¹æ³•è¿”å›ï¼Œè¿›è€Œæ‰§è¡Œåç»­æ“ä½œã€‚ä¸Šè¿°çš„ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡å¯¹è±¡Oæ¥å®Œæˆäº¤äº’ï¼Œè€Œå¯¹è±¡ä¸Šçš„wait()å’Œnotify()/notifyAll()çš„å…³ç³»å°±å¦‚åŒå¼€å…³ä¿¡å·ä¸€æ ·ï¼Œç”¨æ¥å®Œæˆç­‰å¾…æ–¹å’Œé€šçŸ¥æ–¹ä¹‹é—´çš„äº¤äº’å·¥ä½œã€‚<br>ç­‰å¾…/é€šçŸ¥æœºåˆ¶ä¸»è¦æ˜¯ç”¨åˆ°çš„å‡½æ•°æ–¹æ³•æ˜¯notify()/notifyAll(),wait()/wait(long),wait(long,int),è¿™äº›æ–¹æ³•åœ¨ä¸Šä¸€ç¯‡æ–‡ç« éƒ½æœ‰è¯´æ˜è¿‡ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚å½“ç„¶è¿™æ˜¯é’ˆå¯¹synchroniedå…³é”®å­—ä¿®é¥°çš„å‡½æ•°æˆ–ä»£ç å—ï¼Œå› ä¸ºè¦ä½¿ç”¨notify()/notifyAll(),wait()/wait(long),wait(long,int)è¿™äº›æ–¹æ³•çš„å‰ææ˜¯å¯¹è°ƒç”¨å¯¹è±¡åŠ é”ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½åœ¨åŒæ­¥å‡½æ•°æˆ–è€…åŒæ­¥ä»£ç å—ä¸­ä½¿ç”¨ã€‚</p>
<h2 id="æ¡ä»¶å¯¹è±¡çš„ç­‰å¾…-é€šçŸ¥æœºåˆ¶"><a href="#æ¡ä»¶å¯¹è±¡çš„ç­‰å¾…-é€šçŸ¥æœºåˆ¶" class="headerlink" title="æ¡ä»¶å¯¹è±¡çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶"></a>æ¡ä»¶å¯¹è±¡çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶</h2><p>æ‰€è°“çš„æ¡ä»¶å¯¹è±¡ä¹Ÿå°±æ˜¯é…åˆå‰é¢æˆ‘ä»¬åˆ†æçš„Locké”å¯¹è±¡ï¼Œé€šè¿‡é”å¯¹è±¡çš„æ¡ä»¶å¯¹è±¡æ¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚é‚£ä¹ˆæ¡ä»¶å¯¹è±¡æ˜¯æ€ä¹ˆåˆ›å»ºçš„å‘¢ï¼Ÿ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//åˆ›å»ºæ¡ä»¶å¯¹è±¡  </span></div><div class="line">Condition conditionObj=ticketLock.newCondition();</div></pre></td></tr></table></figure></p>
<p>å°±è¿™æ ·æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ¡ä»¶å¯¹è±¡ã€‚æ³¨æ„è¿™é‡Œè¿”å›çš„å¯¹è±¡æ˜¯ä¸è¯¥é”ï¼ˆticketLockï¼‰ç›¸å…³çš„æ¡ä»¶å¯¹è±¡ã€‚ä¸‹é¢æ˜¯æ¡ä»¶å¯¹è±¡çš„APIï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å‡½æ•°æ–¹æ³•å¯¹åº”çš„æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>void await()</td>
<td>å°†è¯¥çº¿ç¨‹æ”¾åˆ°æ¡ä»¶ç­‰å¾…æ± ä¸­ï¼ˆå¯¹åº”wait()æ–¹æ³•ï¼‰</td>
</tr>
<tr>
<td>void signalAll()</td>
<td>è§£é™¤è¯¥æ¡ä»¶ç­‰å¾…æ± ä¸­æ‰€æœ‰çº¿ç¨‹çš„é˜»å¡çŠ¶æ€ï¼ˆå¯¹åº”notifyAll()æ–¹æ³•ï¼‰</td>
</tr>
<tr>
<td>void signal()</td>
<td>ä»è¯¥æ¡ä»¶çš„ç­‰å¾…æ± ä¸­éšæœºåœ°é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ï¼Œè§£é™¤å…¶é˜»å¡çŠ¶æ€ï¼ˆå¯¹åº”notify()æ–¹æ³•ï¼‰</td>
</tr>
</tbody>
</table>
<p>ä¸Šè¿°æ–¹æ³•çš„è¿‡ç¨‹åˆ†æï¼šä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨äº†æ¡ä»¶å¯¹è±¡çš„await()æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹Bè°ƒç”¨äº†æ¡ä»¶å¯¹è±¡çš„signal()æˆ–è€…signalAll()æ–¹æ³•ï¼Œçº¿ç¨‹Aæ”¶åˆ°é€šçŸ¥åä»æ¡ä»¶å¯¹è±¡çš„await()æ–¹æ³•è¿”å›ï¼Œè¿›è€Œæ‰§è¡Œåç»­æ“ä½œã€‚ä¸Šè¿°çš„ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡æ¡ä»¶å¯¹è±¡æ¥å®Œæˆäº¤äº’ï¼Œè€Œå¯¹è±¡ä¸Šçš„await()å’Œsignal()/signalAll()çš„å…³ç³»å°±å¦‚åŒå¼€å…³ä¿¡å·ä¸€æ ·ï¼Œç”¨æ¥å®Œæˆç­‰å¾…æ–¹å’Œé€šçŸ¥æ–¹ä¹‹é—´çš„äº¤äº’å·¥ä½œã€‚å½“ç„¶è¿™æ ·çš„æ“ä½œéƒ½æ˜¯å¿…é¡»åŸºäºæ¡ä»¶å¯¹è±¡çš„é”çš„ï¼Œå½“å‰çº¿ç¨‹åªæœ‰è·å–äº†é”ï¼Œæ‰èƒ½è°ƒç”¨è¯¥æ¡ä»¶å¯¹è±¡çš„await()æ–¹æ³•ï¼Œè€Œè°ƒç”¨åï¼Œå½“å‰çº¿ç¨‹å°†é‡Šæ”¾é”ã€‚</p>
<p>è¿™é‡Œæœ‰ç‚¹è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°ä¸¤ç§ç­‰å¾…/é€šçŸ¥æœºåˆ¶ä¸­ï¼Œæ— è®ºæ˜¯è°ƒç”¨äº†signal()/signalAll()æ–¹æ³•è¿˜æ˜¯è°ƒç”¨äº†notify()/notifyAll()æ–¹æ³•å¹¶ä¸ä¼šç«‹å³æ¿€æ´»ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚å®ƒä»¬ä»…ä»…éƒ½åªæ˜¯è§£é™¤ç­‰å¾…çº¿ç¨‹çš„é˜»å¡çŠ¶æ€ï¼Œä»¥ä¾¿è¿™äº›çº¿ç¨‹å¯ä»¥åœ¨å½“å‰çº¿ç¨‹è§£é”æˆ–è€…é€€å‡ºåŒæ­¥æ–¹æ³•åï¼Œé€šè¿‡äº‰å¤ºCPUæ‰§è¡Œæƒå®ç°å¯¹å¯¹è±¡çš„è®¿é—®ã€‚åˆ°æ­¤ï¼Œçº¿ç¨‹é€šä¿¡æœºåˆ¶çš„æ¦‚å¿µåˆ†æå®Œï¼Œæˆ‘ä»¬ä¸‹é¢é€šè¿‡ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼æ¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚</p>
<h1 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</h1><h2 id="å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼"><a href="#å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼"></a>å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼</h2><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹ï¼Œä¸€ä¸ªçº¿ç¨‹ç”Ÿäº§ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç­‰å¾…/é€šçŸ¥æœºåˆ¶ä¸‹çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼šæˆ‘ä»¬å‡è®¾è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬æ˜¯å–åŒ—äº¬çƒ¤é¸­åº—é“ºï¼Œæˆ‘ä»¬ç°åœ¨åªæœ‰ä¸€æ¡ç”Ÿäº§çº¿ä¹Ÿåªæœ‰ä¸€æ¡æ¶ˆè´¹çº¿ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½ç”Ÿäº§çº¿ç¨‹ç”Ÿäº§å®Œäº†ï¼Œå†é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹æ‰èƒ½å»å–ï¼Œå¦‚æœæ¶ˆè´¹çº¿ç¨‹æ²¡çƒ¤é¸­äº†ï¼Œå°±å¿…é¡»é€šçŸ¥ç”Ÿäº§çº¿ç¨‹å»ç”Ÿäº§ï¼Œæ­¤æ—¶æ¶ˆè´¹çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚åœ¨è¿™æ ·çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¸ä»…è¦ä¿è¯å…±äº«æ•°æ®ï¼ˆçƒ¤é¸­æ•°é‡ï¼‰çš„çº¿ç¨‹å®‰å…¨ï¼Œè€Œä¸”è¿˜è¦ä¿è¯çƒ¤é¸­æ•°é‡åœ¨æ¶ˆè´¹ä¹‹å‰å¿…é¡»æœ‰çƒ¤é¸­ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡javaä»£ç æ¥å®ç°ï¼š<br>åŒ—äº¬çƒ¤é¸­ç”Ÿäº§èµ„æºç±»KaoYaResourceï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KaoYaResource</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">1</span>;<span class="comment">//çƒ¤é¸­çš„åˆå§‹æ•°é‡  </span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;<span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦çº¿ç¨‹ç­‰å¾…çš„æ ‡å¿—  </span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç”Ÿäº§çƒ¤é¸­ </div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">product</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(flag)&#123;</div><div class="line">            <span class="comment">//æ­¤æ—¶æœ‰çƒ¤é¸­ï¼Œç­‰å¾…  </span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">this</span>.wait();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace()</div><div class="line">                ;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.name=name+count;<span class="comment">//è®¾ç½®çƒ¤é¸­çš„åç§°  </span></div><div class="line">        count++;</div><div class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">"...ç”Ÿäº§è€…..."</span>+<span class="keyword">this</span>.name);</div><div class="line">        flag=<span class="keyword">true</span>;<span class="comment">//æœ‰çƒ¤é¸­åæ”¹å˜æ ‡å¿—  </span></div><div class="line">        notifyAll();<span class="comment">//é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯ä»¥æ¶ˆè´¹äº†  </span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¶ˆè´¹çƒ¤é¸­ </div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(!flag)&#123;<span class="comment">//å¦‚æœæ²¡æœ‰çƒ¤é¸­å°±ç­‰å¾…  </span></div><div class="line">            <span class="keyword">try</span>&#123;</div><div class="line">                <span class="keyword">this</span>.wait();</div><div class="line">            &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</div><div class="line">                </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">"...æ¶ˆè´¹è€…........"</span>+<span class="keyword">this</span>.name);<span class="comment">//æ¶ˆè´¹çƒ¤é¸­1  </span></div><div class="line">        flag = <span class="keyword">false</span>;</div><div class="line">        notifyAll();<span class="comment">//é€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§çƒ¤é¸­  </span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨è¿™ä¸ªç±»ä¸­æˆ‘ä»¬æœ‰ä¸¤ä¸ªsynchronizedçš„åŒæ­¥æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ç”Ÿäº§çƒ¤é¸­çš„ï¼Œä¸€ä¸ªæ˜¯æ¶ˆè´¹çƒ¤é¸­çš„ï¼Œä¹‹æ‰€ä»¥éœ€è¦åŒæ­¥æ˜¯å› ä¸ºæˆ‘ä»¬æ“ä½œäº†å…±äº«æ•°æ®countï¼ŒåŒæ—¶ä¸ºäº†ä¿è¯ç”Ÿäº§çƒ¤é¸­åæ‰èƒ½æ¶ˆè´¹ä¹Ÿå°±æ˜¯ç”Ÿäº§ä¸€åªçƒ¤é¸­åæ‰èƒ½æ¶ˆè´¹ä¸€åªçƒ¤é¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œwait()å’Œnotify()ã€‚å½“ç¬¬ä¸€æ¬¡è¿è¡Œç”Ÿäº§ç°åœºæ—¶è°ƒç”¨ç”Ÿäº§çš„æ–¹æ³•ï¼Œæ­¤æ—¶æœ‰ä¸€åªçƒ¤é¸­ï¼Œå³flag=falseï¼Œæ— éœ€ç­‰å¾…ï¼Œå› æ­¤æˆ‘ä»¬è®¾ç½®å¯æ¶ˆè´¹çš„çƒ¤é¸­åç§°ç„¶åæ”¹å˜flag=trueï¼ŒåŒæ—¶é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯ä»¥æ¶ˆè´¹çƒ¤é¸­äº†ï¼Œå³ä½¿æ­¤æ—¶ç”Ÿäº§çº¿ç¨‹å†æ¬¡æŠ¢åˆ°æ‰§è¡Œæƒï¼Œå› ä¸ºflag=trueï¼Œæ‰€ä»¥ç”Ÿäº§çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…é˜»å¡çŠ¶æ€ï¼Œæ¶ˆè´¹çº¿ç¨‹è¢«å”¤é†’åå°±è¿›å…¥æ¶ˆè´¹æ–¹æ³•ï¼Œæ¶ˆè´¹å®Œæˆåï¼Œåˆæ”¹å˜æ ‡å¿—flag=falseï¼Œé€šçŸ¥ç”Ÿäº§çº¿ç¨‹å¯ä»¥ç”Ÿäº§çƒ¤é¸­äº†â€¦â€¦â€¦ä»¥æ­¤å¾ªç¯ã€‚<br>ç”Ÿäº§æ¶ˆè´¹æ‰§è¡Œç±»Single_Producer_Consumer.java:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Single_Producer_Consumer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">    &#123;</div><div class="line">        KaoYaResource r = <span class="keyword">new</span> KaoYaResource();</div><div class="line">        Producer pro = <span class="keyword">new</span> Producer(r);</div><div class="line">        Consumer con = <span class="keyword">new</span> Consumer(r);</div><div class="line">        <span class="comment">//ç”Ÿäº§è€…çº¿ç¨‹</span></div><div class="line">        Thread t0 = <span class="keyword">new</span> Thread(pro);</div><div class="line">        <span class="comment">//æ¶ˆè´¹è€…çº¿ç¨‹</span></div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(con);</div><div class="line">        <span class="comment">//å¯åŠ¨çº¿ç¨‹</span></div><div class="line">        t0.start();</div><div class="line">        t2.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> KaoYaResource r;</div><div class="line">    Producer(KaoYaResource r)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.r = r;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</div><div class="line">        &#123;</div><div class="line">            r.product(<span class="string">"åŒ—äº¬çƒ¤é¸­"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">100</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> KaoYaResource r;</div><div class="line">    Consumer(KaoYaResource r)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.r = r;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</div><div class="line">        &#123;</div><div class="line">            r.consume();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">100</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨è¿™ä¸ªç±»ä¸­æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯ç”Ÿäº§è€…çº¿ç¨‹ï¼Œæˆ‘ä»¬åˆ†åˆ«å¼€å¯è¿™ä¸¤ä¸ªçº¿ç¨‹ç”¨äºä¸æ–­çš„ç”Ÿäº§æ¶ˆè´¹ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">hread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­1</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­1</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­2</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­2</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­3</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­3</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­4</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­4</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­5</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­5</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­6</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­6</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­7</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­7</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­8</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­8</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­9</div><div class="line">Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­9</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>å¾ˆæ˜¾ç„¶çš„æƒ…å†µå°±æ˜¯ç”Ÿäº§ä¸€åªçƒ¤é¸­ç„¶åå°±æ¶ˆè´¹ä¸€åªçƒ¤é¸­ã€‚è¿è¡Œæƒ…å†µå®Œå…¨æ­£å¸¸ï¼Œå—¯ï¼Œè¿™å°±æ˜¯å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼ã€‚ä¸Šé¢ä½¿ç”¨çš„æ˜¯synchronizedå…³é”®å­—çš„æ–¹å¼å®ç°çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨å¯¹è±¡é”çš„æ–¹å¼å®ç°ï¼šKaoYaResourceByLock.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KaoYaResourceByLock</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">1</span>;<span class="comment">//çƒ¤é¸­çš„åˆå§‹æ•°é‡</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;<span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦çº¿ç¨‹ç­‰å¾…çš„æ ‡å¿—</span></div><div class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡</span></div><div class="line">    <span class="keyword">private</span> Lock resourceLock=<span class="keyword">new</span> ReentrantLock();</div><div class="line">    <span class="comment">//åˆ›å»ºæ¡ä»¶å¯¹è±¡</span></div><div class="line">    <span class="keyword">private</span> Condition condition= resourceLock.newCondition();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç”Ÿäº§çƒ¤é¸­</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">product</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        resourceLock.lock();<span class="comment">//å…ˆè·å–é”</span></div><div class="line">        <span class="keyword">try</span>&#123;</div><div class="line">            <span class="keyword">if</span>(flag)&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    condition.await();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">this</span>.name=name+count;<span class="comment">//è®¾ç½®çƒ¤é¸­çš„åç§°</span></div><div class="line">            count++;</div><div class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">"...ç”Ÿäº§è€…..."</span>+<span class="keyword">this</span>.name);</div><div class="line">            flag=<span class="keyword">true</span>;<span class="comment">//æœ‰çƒ¤é¸­åæ”¹å˜æ ‡å¿—</span></div><div class="line">            condition.signalAll();<span class="comment">//é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯ä»¥æ¶ˆè´¹äº†</span></div><div class="line">        &#125;<span class="keyword">finally</span>&#123;</div><div class="line">            resourceLock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¶ˆè´¹çƒ¤é¸­</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span></span>&#123;</div><div class="line">        resourceLock.lock();</div><div class="line">        <span class="keyword">try</span>&#123;</div><div class="line">            <span class="keyword">if</span>(!flag)&#123;<span class="comment">//å¦‚æœæ²¡æœ‰çƒ¤é¸­å°±ç­‰å¾…</span></div><div class="line">                <span class="keyword">try</span>&#123;</div><div class="line">                    condition.await();</div><div class="line">                &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">"...æ¶ˆè´¹è€…........"</span>+<span class="keyword">this</span>.name);<span class="comment">//æ¶ˆè´¹çƒ¤é¸­1</span></div><div class="line">            flag = <span class="keyword">false</span>;</div><div class="line">            condition.signalAll();<span class="comment">//é€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§çƒ¤é¸­</span></div><div class="line">        &#125;<span class="keyword">finally</span>&#123;</div><div class="line">            resourceLock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»£ç å˜åŒ–ä¸å¤§ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹è±¡é”çš„æ–¹å¼å»å®ç°ï¼Œé¦–å…ˆè¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡é”ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„é‡å…¥é”ReestrantLockç±»ï¼Œç„¶åé€šè¿‡æ‰‹åŠ¨è®¾ç½®lock()å’Œunlock()çš„æ–¹å¼å»è·å–é”ä»¥åŠé‡Šæ”¾é”ã€‚ä¸ºäº†å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»é€šè¿‡é”å¯¹è±¡å»åˆ›å»ºä¸€ä¸ªæ¡ä»¶å¯¹è±¡Conditionï¼Œç„¶åé€šè¿‡é”å¯¹è±¡çš„await()å’ŒsignalAll()æ–¹æ³•å»å®ç°ç­‰å¾…ä»¥åŠé€šçŸ¥æ“ä½œã€‚Single_Producer_Consumer.javaä»£ç æ›¿æ¢ä¸€ä¸‹èµ„æºç±»å³å¯,è¿è¡Œç»“æœä¸€æ ·ã€‚</p>
<h2 id="å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼"><a href="#å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼"></a>å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼</h2><p>åˆ†æå®Œäº†å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼ï¼Œæˆ‘ä»¬å†æ¥èŠèŠå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å¤šæ¡ç”Ÿäº§çº¿ç¨‹é…åˆå¤šæ¡æ¶ˆè´¹çº¿ç¨‹ã€‚æ—¢ç„¶è¿™æ ·çš„è¯æˆ‘ä»¬å…ˆæŠŠä¸Šé¢çš„ä»£ç Single_Producer_Consumer.javaç±»ä¿®æ”¹æˆæ–°ç±»ï¼Œå¤§éƒ¨åˆ†ä»£ç ä¸å˜ï¼Œä»…æ–°å¢2æ¡çº¿ç¨‹å»è·‘ï¼Œä¸€æ¡t1çš„ç”Ÿäº§  å…±äº«èµ„æºç±»KaoYaResourceä¸ä½œæ›´æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mutil_Producer_Consumer</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">    &#123;</div><div class="line">        KaoYaResource r = <span class="keyword">new</span> KaoYaResource();</div><div class="line">        Mutil_Producer pro = <span class="keyword">new</span> Mutil_Producer(r);</div><div class="line">        Mutil_Consumer con = <span class="keyword">new</span> Mutil_Consumer(r);</div><div class="line">        <span class="comment">//ç”Ÿäº§è€…çº¿ç¨‹</span></div><div class="line">        Thread t0 = <span class="keyword">new</span> Thread(pro);</div><div class="line">        Thread t1 = <span class="keyword">new</span> Thread(pro);</div><div class="line">        <span class="comment">//æ¶ˆè´¹è€…çº¿ç¨‹</span></div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(con);</div><div class="line">        Thread t3 = <span class="keyword">new</span> Thread(con);</div><div class="line">        <span class="comment">//å¯åŠ¨çº¿ç¨‹</span></div><div class="line">        t0.start();</div><div class="line">        t1.start();</div><div class="line">        t2.start();</div><div class="line">        t3.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mutil_Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> KaoYaResource r;</div><div class="line">    Mutil_Producer(KaoYaResource r)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.r = r;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</div><div class="line">        &#123;</div><div class="line">            r.product(<span class="string">"åŒ—äº¬çƒ¤é¸­"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">100</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mutil_Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">private</span> KaoYaResource r;</div><div class="line">    Mutil_Consumer(KaoYaResource r)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.r = r;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</div><div class="line">        &#123;</div><div class="line">            r.consume();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">100</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å°±å¤šäº†ä¸¤æ¡çº¿ç¨‹ï¼Œæˆ‘ä»¬è¿è¡Œä»£ç çœ‹çœ‹ï¼Œç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­63</div><div class="line">Thread-2...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­63</div><div class="line">Thread-3...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­63  <span class="comment">#æ¶ˆè´¹ä¸¤æ¬¡äº†</span></div><div class="line">......</div><div class="line">......</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­67     <span class="comment">#æ²¡æœ‰è¢«æ¶ˆè´¹</span></div><div class="line">Thread-1...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­68     </div><div class="line">Thread-2...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­68</div><div class="line">Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­69</div></pre></td></tr></table></figure></p>
<p>ä¸å¯¹å‘€ï¼Œæˆ‘ä»¬æ‰ç”Ÿäº§ä¸€åªçƒ¤é¸­ï¼Œæ€ä¹ˆå°±è¢«æ¶ˆè´¹äº†2æ¬¡å•Šï¼Œæœ‰çš„çƒ¤é¸­ç”Ÿäº§äº†ä¹Ÿæ²¡æœ‰è¢«æ¶ˆè´¹å•Šï¼Ÿéš¾é“å…±äº«æ•°æ®æºæ²¡æœ‰è¿›è¡Œçº¿ç¨‹åŒæ­¥ï¼Ÿå›é¡¾ä¸‹KaoYaResource.java<br>å…±äº«æ•°æ®countçš„è·å–æ–¹æ³•éƒ½è¿›è¡Œsynchronizedå…³é”®å­—åŒæ­¥äº†å‘€ï¼é‚£æ€ä¹ˆè¿˜ä¼šå‡ºç°æ•°æ®æ··ä¹±çš„ç°è±¡å•Šï¼Ÿ<br>åˆ†æï¼šç¡®å®ï¼Œæˆ‘ä»¬å¯¹å…±äº«æ•°æ®ä¹Ÿé‡‡ç”¨äº†åŒæ­¥æªæ–½ï¼Œè€Œä¸”ä¹Ÿåº”ç”¨äº†ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œä½†æ˜¯è¿™æ ·çš„æªæ–½åªåœ¨å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…çš„æƒ…å†µä¸‹æ‰èƒ½æ­£ç¡®åº”ç”¨ï¼Œä½†ä»è¿è¡Œç»“æœæ¥çœ‹ï¼Œæˆ‘ä»¬ä¹‹å‰çš„å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…å®‰å…¨å¤„ç†æªæ–½å°±ä¸å¤ªé€‚åˆå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…çš„æƒ…å†µäº†ã€‚é‚£ä¹ˆé—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿå¯ä»¥æ˜ç¡®çš„å‘Šè¯‰å¤§å®¶ï¼Œè‚¯å®šæ˜¯åœ¨èµ„æºå…±äº«ç±»ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æé—®é¢˜æ˜¯å¦‚ä½•å‡ºç°ï¼Œåˆè¯¥å¦‚ä½•è§£å†³ï¼Ÿç›´æ¥ä¸Šå›¾<br><a href="/images/java-thread-2-4.png"><img src="/images/java-thread-2-4.png" alt=""></a></p>
<p>è§£å†³åçš„èµ„æºä»£ç å¦‚ä¸‹åªå°†ifæ”¹ä¸ºäº†whileï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KaoYaResourceByMulti</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">1</span>;<span class="comment">//çƒ¤é¸­çš„åˆå§‹æ•°é‡</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;<span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦çº¿ç¨‹ç­‰å¾…çš„æ ‡å¿—</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç”Ÿäº§çƒ¤é¸­</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">product</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">while</span> (flag)&#123;</div><div class="line">            <span class="comment">//æ­¤æ—¶æœ‰çƒ¤é¸­ï¼Œç­‰å¾…</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">this</span>.wait();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace()</div><div class="line">                ;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.name=name+count;<span class="comment">//è®¾ç½®çƒ¤é¸­çš„åç§°</span></div><div class="line">        count++;</div><div class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">"...ç”Ÿäº§è€…..."</span>+<span class="keyword">this</span>.name);</div><div class="line">        flag=<span class="keyword">true</span>;<span class="comment">//æœ‰çƒ¤é¸­åæ”¹å˜æ ‡å¿—</span></div><div class="line">        notifyAll();<span class="comment">//é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯ä»¥æ¶ˆè´¹äº†</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¶ˆè´¹çƒ¤é¸­</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">while</span> (!flag)&#123;<span class="comment">//å¦‚æœæ²¡æœ‰çƒ¤é¸­å°±ç­‰å¾…</span></div><div class="line">            <span class="keyword">try</span>&#123;</div><div class="line">                <span class="keyword">this</span>.wait();</div><div class="line">            &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">"...æ¶ˆè´¹è€…........"</span>+<span class="keyword">this</span>.name);<span class="comment">//æ¶ˆè´¹çƒ¤é¸­1</span></div><div class="line">        flag = <span class="keyword">false</span>;</div><div class="line">        notifyAll();<span class="comment">//é€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§çƒ¤é¸­</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œç»“æœè·Ÿå•çº¿ç¨‹é‚£ä¸ªä¸€è‡´ï¼Œå°±ä¸è´´äº†ã€‚<br>åˆ°æ­¤ï¼Œå¤šæ¶ˆè´¹è€…å¤šç”Ÿäº§è€…æ¨¡å¼ä¹Ÿå®Œæˆï¼Œä¸è¿‡ä¸Šé¢ç”¨çš„æ˜¯synchroniedå…³é”®å­—å®ç°çš„ï¼Œè€Œé”å¯¹è±¡çš„è§£å†³æ–¹æ³•ä¹Ÿä¸€æ ·å°†ä¹‹å‰å•æ¶ˆè´¹è€…å•ç”Ÿäº§è€…çš„èµ„æºç±»ä¸­çš„ifåˆ¤æ–­æ”¹ä¸ºwhileåˆ¤æ–­å³å¯ä»£ç å°±ä¸è´´äº†å“ˆã€‚ä¸è¿‡ä¸‹é¢æˆ‘ä»¬å°†ä»‹ç»ä¸€ç§æ›´æœ‰æ•ˆçš„é”å¯¹è±¡è§£å†³æ–¹æ³•ï¼Œæˆ‘ä»¬å‡†å¤‡ä½¿ç”¨ä¸¤ç»„æ¡ä»¶å¯¹è±¡ï¼ˆConditionä¹Ÿç§°ä¸ºç›‘è§†å™¨ï¼‰æ¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡å·²æœ‰çš„é”è·å–ä¸¤ç»„ç›‘è§†å™¨ï¼Œä¸€ç»„ç›‘è§†ç”Ÿäº§è€…ï¼Œä¸€ç»„ç›‘è§†æ¶ˆè´¹è€…ã€‚æœ‰äº†å‰é¢çš„åˆ†æè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä¸Šä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceBy2Condition</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡ã€‚  </span></div><div class="line">    Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"></div><div class="line">    <span class="comment">//é€šè¿‡å·²æœ‰çš„é”è·å–ä¸¤ç»„ç›‘è§†å™¨ï¼Œä¸€ç»„ç›‘è§†ç”Ÿäº§è€…ï¼Œä¸€ç»„ç›‘è§†æ¶ˆè´¹è€…ã€‚  </span></div><div class="line">    Condition producer_con = lock.newCondition();</div><div class="line">    Condition consumer_con = lock.newCondition();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç”Ÿäº§ </div><div class="line">     * <span class="doctag">@param</span> name</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">product</span><span class="params">(String name)</span></span></div><div class="line">    &#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">while</span>(flag)&#123;</div><div class="line">                <span class="keyword">try</span>&#123;producer_con.await();&#125;<span class="keyword">catch</span>(InterruptedException e)&#123;&#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">this</span>.name = name + count;</div><div class="line">            count++;</div><div class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">"...ç”Ÿäº§è€…5.0..."</span>+<span class="keyword">this</span>.name);</div><div class="line">            flag = <span class="keyword">true</span>;</div><div class="line"><span class="comment">//          notifyAll();  </span></div><div class="line"><span class="comment">//          con.signalAll();  </span></div><div class="line">            consumer_con.signal();<span class="comment">//ç›´æ¥å”¤é†’æ¶ˆè´¹çº¿ç¨‹  </span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">finally</span></div><div class="line">        &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¶ˆè´¹ </div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">while</span>(!flag)&#123;</div><div class="line">                <span class="keyword">try</span>&#123;consumer_con.await();&#125;<span class="keyword">catch</span>(InterruptedException e)&#123;&#125;</div><div class="line">            &#125;</div><div class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">"...æ¶ˆè´¹è€….5.0......."</span>+<span class="keyword">this</span>.name);<span class="comment">//æ¶ˆè´¹çƒ¤é¸­1  </span></div><div class="line">            flag = <span class="keyword">false</span>;</div><div class="line"><span class="comment">//          notifyAll();  </span></div><div class="line"><span class="comment">//          con.signalAll();  </span></div><div class="line">            producer_con.signal();<span class="comment">//ç›´æ¥å”¤é†’ç”Ÿäº§çº¿ç¨‹  </span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">finally</span></div><div class="line">        &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åˆ›å»ºäº†producer_con å’Œconsumer_conä¸¤ä¸ªæ¡ä»¶å¯¹è±¡ï¼Œåˆ†åˆ«ç”¨äºç›‘å¬ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œåœ¨product()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è·å–åˆ°é”åï¼Œ<br>å¦‚æœæ­¤æ—¶flagä¸ºtrueçš„è¯ï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶è¿˜æœ‰çƒ¤é¸­æœªè¢«æ¶ˆè´¹ï¼Œå› æ­¤ç”Ÿäº§çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨ç”Ÿäº§çº¿ç¨‹çš„ç›‘æ§å™¨producer_conçš„<br>await()çš„æ–¹æ³•è¿›å…¥é˜»å¡ç­‰å¾…æ± ï¼›ä½†å¦‚æœæ­¤æ—¶çš„flagä¸ºfalseçš„è¯ï¼Œå°±è¯´æ˜çƒ¤é¸­å·²ç»æ¶ˆè´¹å®Œï¼Œéœ€è¦ç”Ÿäº§çº¿ç¨‹å»ç”Ÿäº§çƒ¤é¸­ï¼Œé‚£ä¹ˆç”Ÿäº§çº¿ç¨‹å°†è¿›è¡Œçƒ¤<br>é¸­ç”Ÿäº§å¹¶é€šè¿‡æ¶ˆè´¹çº¿ç¨‹çš„ç›‘æ§å™¨consumer_conçš„signal()æ–¹æ³•å»é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯¹çƒ¤é¸­è¿›è¡Œæ¶ˆè´¹ã€‚consume()æ–¹æ³•ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œè¿™é‡Œå°±ä¸<br>è¿‡å¤šåˆ†æäº†ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ç§æ–¹æ³•æ¯”æˆ‘ä»¬ä¹‹å‰çš„synchronizedåŒæ­¥æ–¹æ³•æˆ–è€…æ˜¯å•ç›‘è§†å™¨çš„é”å¯¹è±¡éƒ½æ¥å¾—é«˜æ•ˆå’Œæ–¹ä¾¿äº›ï¼Œä¹‹å‰éƒ½æ˜¯ä½¿ç”¨<br>notifyAll()å’ŒsignalAll()æ–¹æ³•å»å”¤é†’æ± ä¸­çš„çº¿ç¨‹ï¼Œç„¶åè®©æ± ä¸­çš„çº¿ç¨‹åˆè¿›å…¥ ç«äº‰é˜Ÿåˆ—å»æŠ¢å CPUèµ„æºï¼Œè¿™æ ·ä¸ä»…å”¤é†’äº†æ— å…³çš„çº¿ç¨‹è€Œä¸”åˆè®©å…¨<br>éƒ¨çº¿ç¨‹è¿›å…¥äº†ç«äº‰é˜Ÿåˆ—ä¸­ï¼Œè€Œæˆ‘ä»¬æœ€åä½¿ç”¨ä¸¤ç§ç›‘å¬å™¨åˆ†åˆ«ç›‘å¬ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œè¿™æ ·çš„æ–¹å¼æ°å¥½è§£å†³å‰é¢ä¸¤ç§æ–¹å¼çš„é—®é¢˜æ‰€åœ¨ï¼Œ<br>æˆ‘ä»¬æ¯æ¬¡å”¤é†’éƒ½åªæ˜¯ç”Ÿäº§è€…çº¿ç¨‹æˆ–è€…æ˜¯æ¶ˆè´¹è€…çº¿ç¨‹è€Œä¸ä¼šè®©ä¸¤è€…åŒæ—¶å”¤é†’ï¼Œè¿™æ ·ä¸å°±èƒ½æ›´é«˜æ•ˆå¾—å»æ‰§è¡Œç¨‹åºäº†å—ï¼Ÿå¥½äº†ï¼Œåˆ°æ­¤å¤šç”Ÿäº§è€…å¤šæ¶ˆ<br>è´¹è€…æ¨¡å¼ä¹Ÿåˆ†æå®Œæ¯•ã€‚</p>
<h1 id="çº¿ç¨‹æ­»é”"><a href="#çº¿ç¨‹æ­»é”" class="headerlink" title="çº¿ç¨‹æ­»é”"></a>çº¿ç¨‹æ­»é”</h1><p>ç°åœ¨æˆ‘ä»¬å†æ¥è®¨è®ºä¸€ä¸‹çº¿ç¨‹æ­»é”é—®é¢˜ï¼Œä»ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“é”æ˜¯ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œè¿ç”¨çš„åœºæ™¯éå¸¸å¤šï¼Œå› ä¸ºå®ƒä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œè€Œ<br>ä¸”æ˜“äºç†è§£ã€‚ä½†åŒæ—¶å®ƒä¹Ÿä¼šå¸¦æ¥ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦ï¼Œé‚£å°±æ˜¯å¯èƒ½ä¼šå¼•èµ·æ­»é”ï¼Œä¸€æ—¦äº§ç”Ÿæ­»é”ï¼Œå°±ä¼šé€ æˆç³»ç»ŸåŠŸèƒ½ä¸å¯ç”¨ã€‚æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªä¾‹<br>å­æ¥åˆ†æï¼Œè¿™ä¸ªä¾‹å­ä¼šå¼•èµ·æ­»é”ï¼Œä½¿å¾—çº¿ç¨‹t1å’Œçº¿ç¨‹t2äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLockDemo</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String A=<span class="string">"A"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String B=<span class="string">"B"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        DeadLockDemo deadLock=<span class="keyword">new</span> DeadLockDemo();</div><div class="line"></div><div class="line">        deadLock.deadLock();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deadLock</span><span class="params">()</span></span>&#123;</div><div class="line">        Thread t1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</div><div class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"static-access"</span>)</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">synchronized</span> (A) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.currentThread().sleep(<span class="number">2000</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">synchronized</span> (B) &#123;</div><div class="line">                        System.out.println(<span class="string">"1"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        Thread t2 =<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">synchronized</span> (B) &#123;</div><div class="line">                    <span class="keyword">synchronized</span> (A) &#123;</div><div class="line">                        System.out.println(<span class="string">"2"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">//å¯åŠ¨çº¿ç¨‹</span></div><div class="line">        t1.start();</div><div class="line">        t2.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢ä»£ç è¿è¡ŒåŸºæœ¬æ²¡æœ‰è¾“å‡ºï¼Œä¸€ç›´å¡ç€ã€‚<br>åŒæ­¥åµŒå¥—æ˜¯äº§ç”Ÿæ­»é”çš„å¸¸è§æƒ…æ™¯ï¼Œä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå½“t1çº¿ç¨‹æ‹¿åˆ°é”Aåï¼Œç¡çœ 2ç§’ï¼Œæ­¤æ—¶çº¿ç¨‹t2åˆšå¥½æ‹¿åˆ°äº†Bé”ï¼Œæ¥ç€è¦è·å–Aé”ï¼Œä½†æ˜¯æ­¤æ—¶Aé”æ­£å¥½è¢«t1çº¿ç¨‹æŒæœ‰ï¼Œå› æ­¤åªèƒ½ç­‰å¾…t1çº¿ç¨‹é‡Šæ”¾é”Aï¼Œä½†é—æ†¾çš„æ˜¯åœ¨t1çº¿ç¨‹å†…åˆè¦æ±‚è·å–åˆ°Bé”ï¼Œè€ŒBé”æ­¤æ—¶åˆè¢«t2çº¿ç¨‹æŒæœ‰ï¼Œåˆ°æ­¤ç»“æœå°±æ˜¯t1çº¿ç¨‹æ‹¿åˆ°äº†é”AåŒæ—¶åœ¨ç­‰å¾…t2çº¿ç¨‹é‡Šæ”¾é”Bï¼Œè€Œt2çº¿ç¨‹è·å–åˆ°äº†é”Bä¹ŸåŒæ—¶åœ¨ç­‰å¾…t1çº¿ç¨‹é‡Šæ”¾é”Aï¼Œå½¼æ­¤ç­‰å¾…ä¹Ÿå°±é€ æˆäº†çº¿ç¨‹æ­»é”é—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬ç°å®ä¸­ä¸€èˆ¬ä¸ä¼šå‘ä¸Šé¢é‚£ä¹ˆå†™å‡ºé‚£æ ·çš„ä»£ç ï¼Œä½†æ˜¯æœ‰äº›æ›´ä¸ºå¤æ‚çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚t1æ‹¿äº†é”ä¹‹åï¼Œå› ä¸ºä¸€äº›å¼‚å¸¸æƒ…å†µæ²¡æœ‰é‡Šæ”¾é”ï¼ˆæ­»å¾ªç¯ï¼‰ï¼Œä¹Ÿå¯èƒ½t1æ‹¿åˆ°ä¸€ä¸ªæ•°æ®åº“é”ï¼Œé‡Šæ”¾é”çš„æ—¶å€™æŠ›å‡ºäº†å¼‚å¸¸ï¼Œæ²¡æœ‰é‡Šæ”¾ç­‰ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨å†™ä»£ç çš„æ—¶å€™å¤šè€ƒè™‘æ­»é”çš„æƒ…å†µï¼Œè¿™æ ·æ‰èƒ½æœ‰æ•ˆé¢„é˜²æ­»é”ç¨‹åºçš„å‡ºç°ã€‚ä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹é¿å…æ­»é”çš„å‡ ä¸ªå¸¸è§æ–¹æ³•ï¼š</p>
<ol>
<li>é¿å…ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è·å–å¤šä¸ªé”ã€‚</li>
<li>é¿å…åœ¨ä¸€ä¸ªèµ„æºå†…å ç”¨å¤šä¸ª èµ„æºï¼Œå°½é‡ä¿è¯æ¯ä¸ªé”åªå ç”¨ä¸€ä¸ªèµ„æºã€‚</li>
<li>å°è¯•ä½¿ç”¨å®šæ—¶é”ï¼Œä½¿ç”¨tryLock(timeout)æ¥ä»£æ›¿ä½¿ç”¨å†…éƒ¨é”æœºåˆ¶ã€‚</li>
<li>å¯¹äºæ•°æ®åº“é”ï¼ŒåŠ é”å’Œè§£é”å¿…é¡»åœ¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥é‡Œï¼Œå¦åˆ™ä¼šå‡ºç°è§£é”å¤±è´¥çš„æƒ…å†µã€‚</li>
<li>é¿å…åŒæ­¥åµŒå¥—çš„å‘ç”Ÿ</li>
</ol>
<h1 id="Thread-join"><a href="#Thread-join" class="headerlink" title="Thread.join()"></a>Thread.join()</h1><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹Aæ‰§è¡Œäº†thread.join()è¯­å¥ï¼Œå…¶å«ä¹‰æ˜¯ï¼šå½“å‰çº¿ç¨‹Aç­‰å¾…threadçº¿ç¨‹ç»ˆæ­¢ä¹‹åæ‰èƒ½ä»thread.join()è¿”å›ã€‚çº¿ç¨‹Threadé™¤äº†æä¾›join()æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æä¾›äº†join(long millis)å’Œjoin(long millis,int nanos)ä¸¤ä¸ªå…·å¤‡è¶…æ—¶ç‰¹æ€§çš„æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªè¶…æ—¶çš„æ–¹æ³•è¡¨ç¤ºï¼Œå¦‚æœçº¿ç¨‹åœ¨ç»™å®šçš„è¶…æ—¶æ—¶é—´é‡Œæ²¡æœ‰ç»ˆæ­¢ï¼Œé‚£ä¹ˆå°†ä¼šä»è¯¥è¶…æ—¶æ–¹æ³•ä¸­è¿”å›ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼Œåˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œç¼–å·0~9ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨å‰ä¸€ä¸ªçº¿ç¨‹çš„join()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹0ç»“æŸäº†ï¼Œçº¿ç¨‹1æ‰èƒ½ä»join()æ–¹æ³•ä¸­è¿”å›ï¼Œè€Œ0éœ€è¦ç­‰å¾…mainçº¿ç¨‹ç»“æŸã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinDemo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Thread previous = Thread.currentThread();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</div><div class="line">            <span class="comment">//æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å‰ä¸€ä¸ªçº¿ç¨‹çš„å¼•ç”¨ã€‚éœ€è¦ç­‰å¾…å‰ä¸€ä¸ªçº¿ç¨‹ç»ˆæ­¢ï¼Œæ‰èƒ½ä»ç­‰å¾…ä¸­è¿”å›</span></div><div class="line">            Thread thread=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Domino(previous),String.valueOf(i));</div><div class="line">            thread.start();</div><div class="line">            previous=thread;</div><div class="line">        &#125;</div><div class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" çº¿ç¨‹ç»“æŸ"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Domino</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Thread thread;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Domino</span><span class="params">(Thread thread)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.thread=thread;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            thread.join();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">" çº¿ç¨‹ç»“æŸ"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œç»“æœï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">main çº¿ç¨‹ç»“æŸ</div><div class="line">0 çº¿ç¨‹ç»“æŸ</div><div class="line">1 çº¿ç¨‹ç»“æŸ</div><div class="line">2 çº¿ç¨‹ç»“æŸ</div><div class="line">3 çº¿ç¨‹ç»“æŸ</div><div class="line">4 çº¿ç¨‹ç»“æŸ</div><div class="line">5 çº¿ç¨‹ç»“æŸ</div><div class="line">6 çº¿ç¨‹ç»“æŸ</div><div class="line">7 çº¿ç¨‹ç»“æŸ</div><div class="line">8 çº¿ç¨‹ç»“æŸ</div><div class="line">9 çº¿ç¨‹ç»“æŸ</div></pre></td></tr></table></figure></p>
<blockquote>
<p>ç»“æŸ</p>
</blockquote>
<p>å‚è€ƒ <a href="http://blog.csdn.net/javazejian/article/details/50878665" target="_blank" rel="external">http://blog.csdn.net/javazejian/article/details/50878665</a><br>æ‰€æœ‰ä»£ç åœ¨ <a href="https://github.com/ejunjsh/java-code/tree/master/com/sky/code/thread" target="_blank" rel="external">https://github.com/ejunjsh/java-code/tree/master/com/sky/code/thread</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è®°å½•ï¼Œæ±‡æ€»&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Javaå¤šçº¿ç¨‹(ä¸€)åŸºç¡€</title>
    <link href="http://idiotsky.me/2016/08/08/java-thread-1-md/"/>
    <id>http://idiotsky.me/2016/08/08/java-thread-1-md/</id>
    <published>2016-08-08T14:06:08.000Z</published>
    <updated>2017-08-20T08:07:30.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>å¯¹å¤šçº¿ç¨‹å¤ä¹ ä¸‹ï¼Œæ±‡æ€»ä¸€ä¸‹</p>
</blockquote>
<a id="more"></a>
<h1 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä»¥åŠå¤šçº¿ç¨‹ä¸è¿›ç¨‹çš„åŒºåˆ«"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹ä»¥åŠå¤šçº¿ç¨‹ä¸è¿›ç¨‹çš„åŒºåˆ«" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä»¥åŠå¤šçº¿ç¨‹ä¸è¿›ç¨‹çš„åŒºåˆ«"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹ä»¥åŠå¤šçº¿ç¨‹ä¸è¿›ç¨‹çš„åŒºåˆ«</h1><p>åœ¨ç°ä»£æ“ä½œåœ¨è¿è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚ä¾‹å¦‚å¯åŠ¨ä¸€ä¸ªQQç¨‹åºï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚è€Œæ“ä½œç³»ç»Ÿä¸­è°ƒåº¦çš„æœ€å°å•ä½å…ƒæ˜¯çº¿ç¨‹ï¼Œä¹Ÿå«è½»é‡çº§è¿›ç¨‹ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œå¯ä»¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹éƒ½æ‹¥æœ‰å„è‡ªçš„è®¡æ•°å™¨ï¼Œå †æ ˆå’Œå±€éƒ¨å˜é‡ç­‰å±æ€§ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¿é—®å…±äº«çš„å†…å­˜å˜é‡ã€‚å¤„ç†å™¨åœ¨è¿™äº›çº¿ç¨‹ä¸Šé«˜é€Ÿåˆ‡æ¢ï¼Œè®©ä½¿ç”¨è€…æ„Ÿè§‰åˆ°è¿™äº›çº¿ç¨‹åœ¨åŒæ—¶æ‰§è¡Œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£ï¼š<br>è¿›ç¨‹ï¼šæ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œæ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒç”¨çš„ç‹¬ç«‹å•ä½ã€‚æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„å†…å­˜ç©ºé—´å’Œç³»ç»Ÿèµ„æºã€‚<br>çº¿ç¨‹ï¼šæ˜¯è¿›ç¨‹ä¸­çš„å•ä¸ªé¡ºåºæ§åˆ¶æµï¼Œæ˜¯ä¸€æ¡æ‰§è¡Œè·¯å¾„ä¸€ä¸ªè¿›ç¨‹å¦‚æœåªæœ‰ä¸€æ¡æ‰§è¡Œè·¯å¾„ï¼Œåˆ™ç§°ä¸ºå•çº¿ç¨‹ç¨‹åºã€‚ä¸€ä¸ªè¿›ç¨‹å¦‚æœæœ‰å¤šæ¡æ‰§è¡Œè·¯å¾„ï¼Œåˆ™ç§°ä¸ºå¤šçº¿ç¨‹ç¨‹åºã€‚</p>
<h1 id="å¤šçº¿ç¨‹çš„åˆ›å»ºä¸å¯åŠ¨"><a href="#å¤šçº¿ç¨‹çš„åˆ›å»ºä¸å¯åŠ¨" class="headerlink" title="å¤šçº¿ç¨‹çš„åˆ›å»ºä¸å¯åŠ¨"></a>å¤šçº¿ç¨‹çš„åˆ›å»ºä¸å¯åŠ¨</h1><p>åˆ›å»ºå¤šçº¿ç¨‹æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯å®ç°Runnableæ¥å£é‡å†™runæ–¹æ³•ã€‚<br>ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«ç»™å‡ºä»£ç ç¤ºä¾‹ï¼Œç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"I'm a thread that extends Thread!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®ç°Runnableæ¥å£é‡å†™runæ–¹æ³•:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"I'm a thread that implements Runnable !"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ€ä¹ˆå¯åŠ¨çº¿ç¨‹ï¼Ÿ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartThread</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        </div><div class="line">        NewThread t1=<span class="keyword">new</span> NewThread();</div><div class="line">        t1.start();</div><div class="line"></div><div class="line">        NewRunnable r=<span class="keyword">new</span> NewRunnable();</div><div class="line">        Thread t2=<span class="keyword">new</span> Thread(r);</div><div class="line">        t2.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œç»“æœï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">I&apos;m a thread that extends Thread!</div><div class="line">I&apos;m a thread that implements Runnable !</div></pre></td></tr></table></figure></p>
<p>ä»£ç ç›¸å½“ç®€å•ï¼Œä¸è¿‡å¤šè§£é‡Šã€‚è¿™é‡Œæœ‰ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯è°ƒç”¨start()æ–¹æ³•åå¹¶ä¸æ˜¯æ˜¯ç«‹å³çš„æ‰§è¡Œå¤šçº¿ç¨‹çš„ä»£ç ï¼Œè€Œæ˜¯ä½¿è¯¥çº¿ç¨‹å˜ä¸ºå¯è¿è¡Œæ€ï¼Œä»€ä¹ˆæ—¶å€™è¿è¡Œå¤šçº¿ç¨‹ä»£ç æ˜¯ç”±æ“ä½œç³»ç»Ÿå†³å®šçš„ã€‚</p>
<h1 id="ä¸­æ–­çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹ä»¥åŠçº¿ç¨‹ä¼˜å…ˆçº§"><a href="#ä¸­æ–­çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹ä»¥åŠçº¿ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="ä¸­æ–­çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹ä»¥åŠçº¿ç¨‹ä¼˜å…ˆçº§"></a>ä¸­æ–­çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹ä»¥åŠçº¿ç¨‹ä¼˜å…ˆçº§</h1><h2 id="ä»€ä¹ˆæ˜¯ä¸­æ–­çº¿ç¨‹ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ä¸­æ–­çº¿ç¨‹ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸­æ–­çº¿ç¨‹ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ä¸­æ–­çº¿ç¨‹ï¼Ÿ</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸­æ–­çº¿ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ(è¯¥è§£é‡Šæ¥è‡ªjavaæ ¸å¿ƒæŠ€æœ¯ä¸€ä¹¦ï¼Œæˆ‘å¯¹å…¶è¿›è¡Œç¨å¾®ç®€åŒ–)ï¼Œå½“çº¿ç¨‹çš„run()æ–¹æ³•æ‰§è¡Œæ–¹æ³•ä½“ä¸­çš„æœ€åä¸€æ¡è¯­å¥åï¼Œå¹¶ç»ç”±æ‰§è¡Œreturnè¯­å¥è¿”å›æ—¶ï¼Œæˆ–è€…å‡ºç°åœ¨æ–¹æ³•ä¸­æ²¡æœ‰æ•è·çš„å¼‚å¸¸æ—¶çº¿ç¨‹å°†ç»ˆæ­¢ã€‚åœ¨javaæ—©æœŸç‰ˆæœ¬ä¸­æœ‰ä¸€ä¸ªstopæ–¹æ³•ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è°ƒç”¨å®ƒç»ˆæ­¢çº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•ç°åœ¨å·²ç»è¢«å¼ƒç”¨äº†ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¼šé€ æˆä¸€äº›çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸­æ–­ç†è§£ä¸ºä¸€ä¸ªæ ‡è¯†ä½çš„å±æ€§ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªè¿è¡Œä¸­çš„çº¿ç¨‹æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­æ“ä½œï¼Œè€Œä¸­æ–­å°±å¥½æ¯”å…¶ä»–çº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æ‰“å¯ä¸ªæ‹›å‘¼ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡è°ƒç”¨è¯¥çº¿ç¨‹çš„interruptæ–¹æ³•å¯¹å…¶è¿›è¡Œä¸­æ–­æ“ä½œï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨interruptæ–¹æ³•æ—¶ï¼Œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼ˆæ ‡è¯†ä½ï¼‰å°†è¢«ç½®ä½ï¼ˆæ”¹å˜ï¼‰ï¼Œè¿™æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½å…·æœ‰çš„booleanæ ‡å¿—ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åº”è¯¥ä¸æ—¶çš„æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ï¼Œæ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ã€‚è€Œè¦åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç <br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Thread.currentThread().isInterrupted()</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span>(!Thread.currentThread().isInterrupted())&#123;  </div><div class="line">    <span class="keyword">do</span> something  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯å¦‚æœæ­¤æ—¶çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼ˆsleepæˆ–è€…waitï¼‰ï¼Œå°±æ— æ³•æ£€æŸ¥ä¸­æ–­çŠ¶æ€ï¼Œæ­¤æ—¶ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚å¦‚æœæ¯æ¬¡è¿­ä»£ä¹‹åéƒ½è°ƒç”¨sleepæ–¹æ³•ï¼ˆæˆ–è€…å…¶ä»–å¯ä¸­æ–­çš„æ–¹æ³•ï¼‰ï¼ŒisInterruptedæ£€æµ‹å°±æ²¡å¿…è¦ä¹Ÿæ²¡ç”¨å¤„äº†ï¼Œå¦‚æœåœ¨ä¸­æ–­çŠ¶æ€è¢«ç½®ä½æ—¶è°ƒç”¨sleepæ–¹æ³•ï¼Œå®ƒä¸ä¼šä¼‘çœ åè€Œä¼šæ¸…é™¤è¿™ä¸€ä¼‘çœ çŠ¶æ€å¹¶æŠ›å‡ºInterruptedExceptionã€‚æ‰€ä»¥å¦‚æœåœ¨å¾ªç¯ä¸­è°ƒç”¨sleep,ä¸è¦å»æ£€æµ‹ä¸­æ–­çŠ¶æ€ï¼Œåªéœ€æ•è·InterruptedExceptionã€‚ä»£ç èŒƒä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;  </div><div class="line">        <span class="keyword">while</span>(more work to <span class="keyword">do</span> )&#123;  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                Thread.sleep(<span class="number">5000</span>);  </div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </div><div class="line">                <span class="comment">//thread was interrupted during sleep  </span></div><div class="line">                e.printStackTrace();  </div><div class="line">            &#125;<span class="keyword">finally</span>&#123;  </div><div class="line">                <span class="comment">//clean up , if required  </span></div><div class="line">            &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸å¦¥çš„å¤„ç†æ–¹å¼ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">myTask</span><span class="params">()</span></span>&#123;  </div><div class="line">    ...  </div><div class="line">   <span class="keyword">try</span>&#123;  </div><div class="line">       sleep(<span class="number">50</span>)  </div><div class="line">      &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;  </div><div class="line">   ...  </div><div class="line">   &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ­£ç¡®çš„å¤„ç†æ–¹å¼ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">myTask</span><span class="params">()</span>throw InterruptedException</span>&#123;  </div><div class="line">    sleep(<span class="number">50</span>)  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æˆ–è€…<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">myTask</span><span class="params">()</span></span>&#123;  </div><div class="line">    ...  </div><div class="line">    <span class="keyword">try</span>&#123;  </div><div class="line">    sleep(<span class="number">50</span>)  </div><div class="line">    &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;  </div><div class="line">     Thread.currentThread().interrupt();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æœ€åå…³äºä¸­æ–­çº¿ç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œç»™å‡ºä¸­æ–­çº¿ç¨‹çš„ä¸€äº›ä¸»è¦æ–¹æ³•ï¼š<br>void interrupt()ï¼šå‘çº¿ç¨‹å‘é€ä¸­æ–­è¯·æ±‚ï¼Œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å°†ä¼šè¢«è®¾ç½®ä¸ºtrueï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸€ä¸ªsleepè°ƒç”¨é˜»å¡ï¼Œé‚£ä¹ˆå°†ä¼šæŠ›å‡ºinterrupedExceptionå¼‚å¸¸ã€‚<br>static boolean interrupted()ï¼šæµ‹è¯•å½“å‰çº¿ç¨‹ï¼ˆå½“å‰æ­£åœ¨æ‰§è¡Œå‘½ä»¤çš„è¿™ä¸ªçº¿ç¨‹ï¼‰æ˜¯å¦è¢«ä¸­æ–­ã€‚æ³¨æ„è¿™æ˜¯ä¸ªé™æ€æ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼šäº§ç”Ÿä¸€ä¸ªå‰¯ä½œç”¨é‚£å°±æ˜¯å®ƒä¼šå°†å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€é‡ç½®ä¸ºfalseã€‚<br>boolean isInterrupted()ï¼šåˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨å³ä¸æ”¹å˜çº¿ç¨‹çš„å½“å‰ä¸­æ–­çŠ¶æ€ã€‚<br>static Thread currentThread() : è¿”å›ä»£è¡¨å½“å‰æ‰§è¡Œçº¿ç¨‹çš„Threadå¯¹è±¡ã€‚</p>
<p><strong>è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œä¸ºå•¥ä¸Šé¢çš„ä»£ç ï¼Œåœ¨catchä¹‹åè¿˜è¦åœ¨ä¸­æ–­ä¸€æ¬¡ï¼Œå› ä¸ºcatchä¼šæŠŠå½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—é‡ç½®ä¸ºfalseï¼Œè¿™é‡Œä¸é‡æ–°ä¸­æ–­ä¸€æ¬¡ï¼Œä¸Šå±‚ä»£ç å°±ä¸çŸ¥é“ä¸­æ–­äº†ï¼Œç¨‹åºå°±ä¸çŸ¥é“æœ‰ä¸­æ–­çš„å‘ç”Ÿï¼Œä¸‹é¢ä»£ç å¯ä»¥è¯´æ˜è¿™ä¸ª</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by ejunjsh on 8/10/2017.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInterrupt</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">    &#123;</div><div class="line">        Thread t= <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">5000</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">                    <span class="comment">//catch å¼‚å¸¸ä¹‹åï¼Œè¾“å‡ºæ˜¯false</span></div><div class="line">                    System.out.println(<span class="string">"1.current interrupted flag is "</span> +Thread.currentThread().isInterrupted());</div><div class="line">                    Thread.currentThread().interrupt();</div><div class="line">                    System.out.println(<span class="string">"2.current interrupted flag is "</span> +Thread.currentThread().isInterrupted());</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">5000</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">                    System.out.println(<span class="string">"3.current interrupted flag is "</span> +Thread.currentThread().isInterrupted());</div><div class="line">                    Thread.currentThread().interrupt();</div><div class="line">                    System.out.println(<span class="string">"4.current interrupted flag is "</span> +Thread.currentThread().isInterrupted());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        t.start();</div><div class="line">        <span class="comment">//å¼€å§‹ä¸­æ–­</span></div><div class="line">        t.interrupt();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            t.join();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"5.current state is "</span> +t.getState());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœ:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1.current interrupted flag is false</div><div class="line">2.current interrupted flag is true</div><div class="line">3.current interrupted flag is false</div><div class="line">4.current interrupted flag is true</div><div class="line">5.current state is TERMINATED</div></pre></td></tr></table></figure></p>
<p>å¾ˆæ˜æ˜¾ï¼Œ<code>å¼€å§‹ä¸­æ–­</code>åï¼Œcatchçš„æ ‡å¿—ä½è¢«é‡ç½®äº†ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Ÿ</h2><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡t.setDaemon(true)çš„æ–¹æ³•å°†çº¿ç¨‹è½¬åŒ–ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚è€Œå®ˆæŠ¤çº¿ç¨‹çš„å”¯ä¸€ä½œç”¨å°±æ˜¯ä¸ºå…¶ä»–çº¿ç¨‹æä¾›æœåŠ¡ã€‚è®¡æ—¶çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œå®ƒå®šæ—¶åœ°å‘é€â€œè®¡æ—¶å™¨æ»´ç­”â€ä¿¡å·å‘Šè¯‰å…¶ä»–çº¿ç¨‹å»æ‰§è¡ŒæŸé¡¹ä»»åŠ¡ã€‚å½“åªå‰©ä¸‹å®ˆæŠ¤çº¿ç¨‹æ—¶ï¼Œè™šæ‹Ÿæœºå°±é€€å‡ºäº†ï¼Œå› ä¸ºå¦‚æœåªå‰©ä¸‹å®ˆæŠ¤çº¿ç¨‹ï¼Œç¨‹åºå°±æ²¡æœ‰å¿…è¦æ‰§è¡Œäº†ã€‚å¦å¤–JVMçš„åƒåœ¾å›æ”¶ã€å†…å­˜ç®¡ç†ç­‰çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚è¿˜æœ‰å°±æ˜¯åœ¨åšæ•°æ®åº“åº”ç”¨æ—¶å€™ï¼Œä½¿ç”¨çš„æ•°æ®åº“è¿æ¥æ± ï¼Œè¿æ¥æ± æœ¬èº«ä¹ŸåŒ…å«ç€å¾ˆå¤šåå°çº¿ç¨‹ï¼Œç›‘æ§è¿æ¥ä¸ªæ•°ã€è¶…æ—¶æ—¶é—´ã€çŠ¶æ€ç­‰ç­‰ã€‚æœ€åè¿˜æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯åœ¨javaè™šæ‹Ÿæœºé€€å‡ºæ—¶Daemonçº¿ç¨‹ä¸­çš„finallyä»£ç å—å¹¶ä¸ä¸€å®šä¼šæ‰§è¡Œå“¦ï¼Œä»£ç ç¤ºä¾‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sky.code.thread;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Deamon</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Thread deamon = <span class="keyword">new</span> Thread(<span class="keyword">new</span> DaemonRunner(),<span class="string">"DaemonRunner"</span>);</div><div class="line">        <span class="comment">//è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹</span></div><div class="line">        deamon.setDaemon(<span class="keyword">true</span>);</div><div class="line">        deamon.start();<span class="comment">//å¯åŠ¨çº¿ç¨‹</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">500</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;<span class="keyword">finally</span>&#123;</div><div class="line">                System.out.println(<span class="string">"è¿™é‡Œçš„ä»£ç åœ¨javaè™šæ‹Ÿæœºé€€å‡ºæ—¶å¹¶ä¸ä¸€å®šä¼šæ‰§è¡Œå“¦ï¼"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å› æ­¤åœ¨æ„å»ºDaemonçº¿ç¨‹æ—¶ï¼Œä¸èƒ½ä¾é finallyä»£ç å—ä¸­çš„å†…å®¹æ¥ç¡®ä¿æ‰§è¡Œå…³é—­æˆ–æ¸…ç†èµ„æºçš„é€»è¾‘ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¼˜å…ˆçº§"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¼˜å…ˆçº§"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¼˜å…ˆçº§</h2><p>åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­åŸºæœ¬é‡‡ç”¨æ—¶åˆ†çš„å½¢å¼è°ƒåº¦è¿è¡Œçš„çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†å‡ºä¸€ä¸ªä¸ªæ—¶é—´ç‰‡ï¼Œçº¿ç¨‹ä¼šåˆ†é…åˆ°è‹¥å¹²æ—¶é—´ç‰‡ï¼Œå½“çº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œäº†å°±ä¼šå‘ç”Ÿçº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ç­‰å¾…ç€ä¸‹ä¸€æ¬¡åˆ†é…ã€‚çº¿ç¨‹åˆ†é…åˆ°çš„æ—¶é—´ç‰‡å¤šå°‘ä¹Ÿå†³å®šäº†çº¿ç¨‹ä½¿ç”¨å¤„ç†å™¨èµ„æºçš„å¤šå°‘ï¼Œè€Œçº¿ç¨‹ä¼˜å…ˆçº§å°±æ˜¯å†³å®šçº¿ç¨‹éœ€è¦å¤šæˆ–è€…å°‘åˆ†é…ä¸€äº›å¤„ç†å™¨èµ„æºçš„çº¿ç¨‹å±æ€§ã€‚åœ¨javaçº¿ç¨‹ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªæ•´å‹çš„æˆå‘˜å˜é‡Priorityæ¥æ§åˆ¶çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹ç»§æ‰¿å®ƒçˆ¶ç±»çš„ä¼˜å…ˆçº§ã€‚å¯ä»¥ç”¨setPriorityæ–¹æ³•æé«˜æˆ–é™ä½ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¼˜å…ˆçº§ã€‚å¯ä»¥å°†ä¼˜å…ˆçº§è®¾ç½®åœ¨MIN_PRIORITYï¼ˆåœ¨Threadç±»å®šä¹‰ä¸º1ï¼‰ä¸MAX_PRIORITYï¼ˆåœ¨Threadç±»å®šä¹‰ä¸º10ï¼‰ä¹‹é—´çš„ä»»ä½•å€¼ã€‚çº¿ç¨‹çš„é»˜è®¤ä¼˜å…ˆçº§ä¸ºNORM_PRIORITYï¼ˆåœ¨Threadç±»å®šä¹‰ä¸º5ï¼‰ã€‚å°½é‡ä¸è¦ä¾èµ–ä¼˜å…ˆçº§ï¼Œå¦‚æœç¡®å®è¦ç”¨ï¼Œåº”è¯¥é¿å…åˆå­¦è€…å¸¸çŠ¯çš„ä¸€ä¸ªé”™è¯¯ã€‚å¦‚æœæœ‰å‡ ä¸ªé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æ²¡æœ‰è¿›å…¥éæ´»åŠ¨çŠ¶æ€ï¼Œä½ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½æ°¸è¿œä¹Ÿä¸èƒ½æ‰§è¡Œã€‚æ¯å½“è°ƒåº¦å™¨å†³å®šè¿è¡Œä¸€ä¸ªæ–°çº¿ç¨‹æ—¶ï¼Œé¦–å…ˆä¼šåœ¨å…·æœ‰é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¸­è¿›è¡Œé€‰æ‹©ï¼Œå°½ç®¡è¿™æ ·ä¼šä½¿ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹å¯èƒ½æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œåˆ°ã€‚å› æ­¤æˆ‘ä»¬åœ¨è®¾ç½®ä¼˜å…ˆçº§æ—¶ï¼Œé’ˆå¯¹é¢‘ç¹é˜»å¡ï¼ˆä¼‘çœ æˆ–è€…I/Oæ“ä½œï¼‰çš„çº¿ç¨‹éœ€è¦è®¾ç½®è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œè€Œåé‡è®¡ç®—ï¼ˆéœ€è¦è¾ƒå¤šCPUæ—¶é—´æˆ–è€…è¿ç®—ï¼‰çš„çº¿ç¨‹åˆ™è®¾ç½®è¾ƒä½çš„ä¼˜å…ˆçº§ï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿å¤„ç†å™¨ä¸ä¼šè¢«é•¿ä¹…ç‹¬å ã€‚å½“ç„¶è¿˜æœ‰è¦æ³¨æ„å°±æ˜¯åœ¨ä¸åŒçš„JVMä»¥åŠæ“ä½œç³»ç»Ÿä¸Šçº¿ç¨‹çš„è§„åˆ’å­˜åœ¨å·®å¼‚ï¼Œæœ‰äº›æ“ä½œç³»ç»Ÿç”šè‡³ä¼šå¿½ç•¥å¯¹çº¿ç¨‹ä¼˜å…ˆçº§çš„è®¾å®šï¼Œå¦‚mac osç³»ç»Ÿæˆ–è€…Ubuntuç³»ç»Ÿâ€¦â€¦..</p>
<h1 id="çº¿ç¨‹çš„çŠ¶æ€è½¬åŒ–å…³ç³»"><a href="#çº¿ç¨‹çš„çŠ¶æ€è½¬åŒ–å…³ç³»" class="headerlink" title="çº¿ç¨‹çš„çŠ¶æ€è½¬åŒ–å…³ç³»"></a>çº¿ç¨‹çš„çŠ¶æ€è½¬åŒ–å…³ç³»</h1><p>1.æ–°å»ºçŠ¶æ€ï¼ˆNewï¼‰ï¼šæ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ã€‚<br>2.å°±ç»ªçŠ¶æ€ï¼ˆRunnableï¼‰ï¼šçº¿ç¨‹å¯¹è±¡åˆ›å»ºåï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨äº†è¯¥å¯¹è±¡çš„start()æ–¹æ³•ã€‚è¯¥çŠ¶æ€çš„çº¿ç¨‹ä½äºå¯è¿è¡Œçº¿ç¨‹æ± ä¸­ï¼Œå˜å¾—å¯è¿è¡Œï¼Œç­‰å¾…è·å–CPUçš„ä½¿ç”¨æƒã€‚<br>3.è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰ï¼šå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹è·å–äº†CPUï¼Œæ‰§è¡Œç¨‹åºä»£ç ã€‚<br>4.é˜»å¡çŠ¶æ€ï¼ˆBlockedï¼‰ï¼šé˜»å¡çŠ¶æ€æ˜¯çº¿ç¨‹å› ä¸ºæŸç§åŸå› æ”¾å¼ƒCPUä½¿ç”¨æƒï¼Œæš‚æ—¶åœæ­¢è¿è¡Œã€‚ç›´åˆ°çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œæ‰æœ‰æœºä¼šè½¬åˆ°è¿è¡ŒçŠ¶æ€ã€‚é˜»å¡çš„æƒ…å†µåˆ†ä¸‰ç§ï¼š</p>
<ul>
<li>ç­‰å¾…é˜»å¡ï¼ˆWAITINGï¼‰ï¼šè¿è¡Œçš„çº¿ç¨‹æ‰§è¡Œwait()æ–¹æ³•ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥ç­‰å¾…æ± ä¸­ã€‚</li>
<li>åŒæ­¥é˜»å¡ï¼ˆBlockedï¼‰ï¼šè¿è¡Œçš„çº¿ç¨‹åœ¨è·å–å¯¹è±¡çš„åŒæ­¥é”æ—¶ï¼Œè‹¥è¯¥åŒæ­¥é”è¢«åˆ«çš„çº¿ç¨‹å ç”¨ï¼Œåˆ™JVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥é”æ± ä¸­ã€‚</li>
<li>è¶…æ—¶é˜»å¡ï¼ˆTIME_WAITINGï¼‰ï¼šè¿è¡Œçš„çº¿ç¨‹æ‰§è¡Œsleep(long)æˆ–join(long)æ–¹æ³•ï¼Œæˆ–è€…å‘å‡ºäº†I/Oè¯·æ±‚æ—¶ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹ç½®ä¸ºé˜»å¡çŠ¶æ€ã€‚</li>
</ul>
<p>5.æ­»äº¡çŠ¶æ€ï¼ˆDeadï¼‰ï¼šçº¿ç¨‹æ‰§è¡Œå®Œäº†æˆ–è€…å› å¼‚å¸¸é€€å‡ºäº†run()æ–¹æ³•ï¼Œè¯¥çº¿ç¨‹ç»“æŸç”Ÿå‘½å‘¨æœŸã€‚<br><a href="/images/java-thread-1-1.png"><img src="/images/java-thread-1-1.png" alt=""></a><br>å›¾ä¸­çš„æ–¹æ³•è§£æå¦‚ä¸‹ï¼š<br>Thread.sleep()ï¼šåœ¨æŒ‡å®šæ—¶é—´å†…è®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æš‚åœæ‰§è¡Œï¼Œä½†ä¸ä¼šé‡Šæ”¾â€é”æ ‡å¿—â€ã€‚ä¸æ¨èä½¿ç”¨ã€‚<br>Thread.sleep(long)ï¼šä½¿å½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…ä¸ä¼šæ‰§è¡Œã€‚<br>Object.wait()å’ŒObject.wait(long)ï¼šåœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨å¯¹è±¡çš„notifyæˆ–notifyAllæ–¹æ³•å‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ã€‚çº¿ç¨‹ä¼šé‡Šæ”¾æ‰å®ƒæ‰€å æœ‰çš„â€é”æ ‡å¿—â€ï¼Œä»è€Œä½¿åˆ«çš„çº¿ç¨‹æœ‰æœºä¼šæŠ¢å è¯¥é”ã€‚ å½“å‰çº¿ç¨‹å¿…é¡»æ‹¥æœ‰å½“å‰å¯¹è±¡é”ã€‚å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æ­¤é”çš„æ‹¥æœ‰è€…ï¼Œä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ã€‚ å”¤é†’å½“å‰å¯¹è±¡é”çš„ç­‰å¾…çº¿ç¨‹ä½¿ç”¨notifyæˆ–notifyAllæ–¹æ³•ï¼Œä¹Ÿå¿…é¡»æ‹¥æœ‰ç›¸åŒçš„å¯¹è±¡é”ï¼Œå¦åˆ™ä¹Ÿä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ï¼Œwaite()å’Œnotify()å¿…é¡»åœ¨synchronizedå‡½æ•°æˆ–synchronizedä¸­è¿›è¡Œè°ƒç”¨ã€‚å¦‚æœåœ¨non-synchronizedå‡½æ•°æˆ–non-synchronizedä¸­è¿›è¡Œè°ƒç”¨,è™½ç„¶èƒ½ç¼–è¯‘é€šè¿‡ï¼Œä½†åœ¨è¿è¡Œæ—¶ä¼šå‘ç”ŸIllegalMonitorStateExceptionçš„å¼‚å¸¸ã€‚<br>Object.notifyAll()ï¼šåˆ™ä»å¯¹è±¡ç­‰å¾…æ± ä¸­å”¤é†’æ‰€æœ‰ç­‰å¾…ç­‰å¾…çº¿ç¨‹<br>Object.notify()ï¼šåˆ™ä»å¯¹è±¡ç­‰å¾…æ± ä¸­å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ã€‚<br>Thread.yield()æ–¹æ³• æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å¯¹è±¡ï¼Œyield()åªæ˜¯ä½¿å½“å‰çº¿ç¨‹é‡æ–°å›åˆ°å¯æ‰§è¡ŒçŠ¶æ€ï¼Œæ‰€ä»¥æ‰§è¡Œyield()çš„çº¿ç¨‹æœ‰å¯èƒ½åœ¨è¿›å…¥åˆ°å¯æ‰§è¡ŒçŠ¶æ€åé©¬ä¸Šåˆè¢«æ‰§è¡Œï¼Œyield()åªèƒ½ä½¿åŒä¼˜å…ˆçº§æˆ–æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æœ‰æ‰§è¡Œçš„æœºä¼šã€‚<br>Thread.Join()ï¼šæŠŠæŒ‡å®šçš„çº¿ç¨‹åŠ å…¥åˆ°å½“å‰çº¿ç¨‹ï¼Œå¯ä»¥å°†ä¸¤ä¸ªäº¤æ›¿æ‰§è¡Œçš„çº¿ç¨‹åˆå¹¶ä¸ºé¡ºåºæ‰§è¡Œçš„çº¿ç¨‹ã€‚æ¯”å¦‚åœ¨çº¿ç¨‹Bä¸­è°ƒç”¨äº†çº¿ç¨‹Açš„Join()æ–¹æ³•ï¼Œç›´åˆ°çº¿ç¨‹Aæ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œçº¿ç¨‹Bã€‚<br>å¥½äº†ã€‚æœ¬ç¯‡çº¿ç¨‹åŸºç¡€çŸ¥è¯†ä»‹ç»åˆ°æ­¤ç»“æŸã€‚</p>
<p>å‚è€ƒ <a href="http://blog.csdn.net/javazejian/article/details/50878598" target="_blank" rel="external">http://blog.csdn.net/javazejian/article/details/50878598</a><br>æ‰€æœ‰ä»£ç åœ¨ <a href="https://github.com/ejunjsh/java-code/tree/master/com/sky/code/thread" target="_blank" rel="external">https://github.com/ejunjsh/java-code/tree/master/com/sky/code/thread</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å¯¹å¤šçº¿ç¨‹å¤ä¹ ä¸‹ï¼Œæ±‡æ€»ä¸€ä¸‹&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>é€šè¿‡åç¼–è¯‘æ·±å…¥ç†è§£Java StringåŠintern</title>
    <link href="http://idiotsky.me/2016/07/29/java-string-intern/"/>
    <id>http://idiotsky.me/2016/07/29/java-string-intern/</id>
    <published>2016-07-29T12:11:55.000Z</published>
    <updated>2017-07-30T14:31:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å­—ç¬¦ä¸²é—®é¢˜"><a href="#å­—ç¬¦ä¸²é—®é¢˜" class="headerlink" title="å­—ç¬¦ä¸²é—®é¢˜"></a>å­—ç¬¦ä¸²é—®é¢˜</h1><p>å­—ç¬¦ä¸²åœ¨æˆ‘ä»¬å¹³æ—¶çš„ç¼–ç å·¥ä½œä¸­å…¶å®ç”¨çš„éå¸¸å¤šï¼Œå¹¶ä¸”ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥å¾ˆå°‘æœ‰äººå¯¹å…¶åšç‰¹åˆ«æ·±å…¥çš„ç ”ç©¶ã€‚å€’æ˜¯é¢è¯•æˆ–è€…ç¬”è¯•çš„æ—¶å€™ï¼Œå¾€å¾€ä¼šæ¶‰åŠæ¯”è¾ƒæ·±å…¥å’Œéš¾åº¦å¤§ä¸€ç‚¹çš„é—®é¢˜ã€‚æˆ‘åœ¨æ‹›è˜çš„æ—¶å€™ä¹Ÿå¶å°”ä¼šé—®åº”è˜è€…ç›¸å…³çš„é—®é¢˜ï¼Œå€’ä¸æ˜¯è¯´ä¸€å®šè¦å›ç­”çš„ç‰¹åˆ«æ­£ç¡®å’Œæ·±å…¥ï¼Œé€šå¸¸é—®è¿™äº›é—®é¢˜çš„ç›®çš„æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€æ˜¯è€ƒå¯Ÿå¯¹ JAVA åŸºç¡€çŸ¥è¯†çš„äº†è§£ç¨‹åº¦ï¼Œç¬¬äºŒæ˜¯è€ƒå¯Ÿåº”è˜è€…å¯¹æŠ€æœ¯çš„æ€åº¦ã€‚<br><a id="more"></a><br>ã€€ã€€æˆ‘ä»¬çœ‹çœ‹ä»¥ä¸‹ç¨‹åºä¼šè¾“å‡ºä»€ä¹ˆç»“æœï¼Ÿå¦‚æœä½ èƒ½æ­£ç¡®çš„å›ç­”æ¯ä¸€é“é¢˜ï¼Œå¹¶ä¸”æ¸…æ¥šå…¶åŸå› ï¼Œé‚£æœ¬æ–‡å¯¹ä½ å°±æ²¡ä»€ä¹ˆå¤ªå¤§çš„æ„ä¹‰ã€‚å¦‚æœå›ç­”ä¸æ­£ç¡®æˆ–è€…ä¸æ˜¯å¾ˆæ¸…æ¥šå…¶åŸç†ï¼Œé‚£å°±ä»”ç»†çœ‹çœ‹ä»¥ä¸‹çš„åˆ†æï¼Œæœ¬æ–‡åº”è¯¥èƒ½å¸®åŠ©ä½ æ¸…æ¥šçš„ç†è§£æ¯æ®µç¨‹åºçš„ç»“æœåŠè¾“å‡ºè¯¥ç»“æœçš„æ·±å±‚æ¬¡åŸå› ã€‚</p>
<p>ä»£ç æ®µä¸€ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.string;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        String str1 = <span class="string">"string"</span>;</div><div class="line">        String str2 = <span class="keyword">new</span> String(<span class="string">"string"</span>);</div><div class="line">        String str3 = str2.intern();</div><div class="line"> </div><div class="line">        System.out.println(str1==str2);<span class="comment">//#1</span></div><div class="line">        System.out.println(str1==str3);<span class="comment">//#2</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»£ç æ®µäºŒï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">package</span> com.paddx.test.string;</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTest01</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        String baseStr = <span class="string">"baseStr"</span>;</div><div class="line">        <span class="keyword">final</span> String baseFinalStr = <span class="string">"baseStr"</span>;</div><div class="line"> </div><div class="line">        String str1 = <span class="string">"baseStr01"</span>;</div><div class="line">        String str2 = <span class="string">"baseStr"</span>+<span class="string">"01"</span>;</div><div class="line">        String str3 = baseStr + <span class="string">"01"</span>;</div><div class="line">        String str4 = baseFinalStr+<span class="string">"01"</span>;</div><div class="line">        String str5 = <span class="keyword">new</span> String(<span class="string">"baseStr01"</span>).intern();</div><div class="line"> </div><div class="line">        System.out.println(str1 == str2);<span class="comment">//#3</span></div><div class="line">        System.out.println(str1 == str3);<span class="comment">//#4</span></div><div class="line">        System.out.println(str1 == str4);<span class="comment">//#5</span></div><div class="line">        System.out.println(str1 == str5);<span class="comment">//#6</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»£ç æ®µä¸‰ï¼ˆ1ï¼‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.string;&lt;br&gt;ã€€ã€€</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InternTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"> </div><div class="line">        String str2 = <span class="keyword">new</span> String(<span class="string">"str"</span>)+<span class="keyword">new</span> String(<span class="string">"01"</span>);</div><div class="line">        str2.intern();</div><div class="line">        String str1 = <span class="string">"str01"</span>;</div><div class="line">        System.out.println(str2==str1);<span class="comment">//#7</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»£ç æ®µä¸‰ï¼ˆ2ï¼‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">package</span> com.paddx.test.string;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InternTest01</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        String str1 = <span class="string">"str01"</span>;</div><div class="line">        String str2 = <span class="keyword">new</span> String(<span class="string">"str"</span>)+<span class="keyword">new</span> String(<span class="string">"01"</span>);</div><div class="line">        str2.intern();</div><div class="line">        System.out.println(str2 == str1);<span class="comment">//#8</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘å¯¹ä¸Šè¿°ä»£ç çš„è¾“å‡ºç»“æœç”±#1~#8è¿›è¡Œäº†ç¼–ç ï¼Œä¸‹æ–‡ä¸­è“è‰²å­—ä½“éƒ¨åˆ†å³ä¸ºç»“æœã€‚</p>
<h1 id="å­—ç¬¦ä¸²æ·±å…¥åˆ†æ"><a href="#å­—ç¬¦ä¸²æ·±å…¥åˆ†æ" class="headerlink" title="å­—ç¬¦ä¸²æ·±å…¥åˆ†æ"></a>å­—ç¬¦ä¸²æ·±å…¥åˆ†æ</h1><h2 id="ä»£ç æ®µä¸€åˆ†æ"><a href="#ä»£ç æ®µä¸€åˆ†æ" class="headerlink" title="ä»£ç æ®µä¸€åˆ†æ"></a>ä»£ç æ®µä¸€åˆ†æ</h2><p>å­—ç¬¦ä¸²ä¸å±äºåŸºæœ¬ç±»å‹ï¼Œä½†æ˜¯å¯ä»¥åƒåŸºæœ¬ç±»å‹ä¸€æ ·ï¼Œç›´æ¥é€šè¿‡å­—é¢é‡èµ‹å€¼ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡newæ¥ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ã€‚ä¸è¿‡é€šè¿‡å­—é¢é‡èµ‹å€¼çš„æ–¹å¼å’Œnewçš„æ–¹å¼ç”Ÿæˆå­—ç¬¦ä¸²æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼š<br><a href="/images/java-string-intern-1.jpg"><img src="/images/java-string-intern-1.jpg" alt=""></a> </p>
<p>é€šè¿‡å­—é¢é‡èµ‹å€¼åˆ›å»ºå­—ç¬¦ä¸²æ—¶ï¼Œä¼šä¼˜å…ˆåœ¨å¸¸é‡æ± ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œå€˜è‹¥å·²ç»å­˜åœ¨ï¼Œæ ˆä¸­çš„å¼•ç”¨ç›´æ¥æŒ‡å‘è¯¥å­—ç¬¦ä¸²ï¼›å€˜è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå†å°†æ ˆä¸­çš„å¼•ç”¨æŒ‡å‘è¯¥å­—ç¬¦ä¸²ã€‚è€Œé€šè¿‡newçš„æ–¹å¼åˆ›å»ºå­—ç¬¦ä¸²æ—¶ï¼Œå°±ç›´æ¥åœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²çš„å¯¹è±¡ï¼ˆå¤‡æ³¨ï¼ŒJDK 7 ä»¥åï¼ŒHotSpot å·²å°†å¸¸é‡æ± ä»æ°¸ä¹…ä»£è½¬ç§»åˆ°äº†å †ä¸­ã€‚è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒã€Š<a href="/2016/07/26/java8-permgen-metaspace/">JDK8å†…å­˜æ¨¡å‹-æ¶ˆå¤±çš„PermGen</a>ã€‹ä¸€æ–‡ï¼‰ï¼Œæ ˆä¸­çš„å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡ã€‚å¯¹äºå †ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ intern() æ–¹æ³•æ¥å°†å­—ç¬¦ä¸²æ·»åŠ çš„å¸¸é‡æ± ä¸­ï¼Œå¹¶è¿”å›æŒ‡å‘è¯¥å¸¸é‡çš„å¼•ç”¨ã€‚<br>ç°åœ¨æˆ‘ä»¬åº”è¯¥èƒ½å¾ˆæ¸…æ¥šä»£ç æ®µä¸€çš„ç»“æœäº†ï¼š</p>
<font color="blue">ç»“æœ #1ï¼šå› ä¸ºstr1æŒ‡å‘çš„æ˜¯å­—ç¬¦ä¸²ä¸­çš„å¸¸é‡ï¼Œstr2æ˜¯åœ¨å †ä¸­ç”Ÿæˆçš„å¯¹è±¡ï¼Œæ‰€ä»¥str1==str2è¿”å›falseã€‚<br>ç»“æœ #2ï¼šstr2è°ƒç”¨internæ–¹æ³•ï¼Œä¼šå°†str2ä¸­å€¼ï¼ˆâ€œstringâ€ï¼‰å¤åˆ¶åˆ°å¸¸é‡æ± ä¸­ï¼Œä½†æ˜¯å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨è¯¥å­—ç¬¦ä¸²ï¼ˆå³str1æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›è¯¥å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼Œå› æ­¤str1==str2è¿”å›trueã€‚</font>

<p>ä»¥ä¸‹è¿è¡Œä»£ç æ®µä¸€çš„ä»£ç çš„ç»“æœï¼š<br><a href="/images/java-string-intern-2.jpg"><img src="/images/java-string-intern-2.jpg" alt=""></a> </p>
<h2 id="ä»£ç æ®µäºŒåˆ†æ"><a href="#ä»£ç æ®µäºŒåˆ†æ" class="headerlink" title="ä»£ç æ®µäºŒåˆ†æ"></a>ä»£ç æ®µäºŒåˆ†æ</h2><p>å¯¹äºä»£ç æ®µäºŒçš„ç»“æœï¼Œè¿˜æ˜¯é€šè¿‡åç¼–è¯‘StringTest01.classæ–‡ä»¶æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼š<br>å¸¸é‡æ± å†…å®¹ï¼ˆéƒ¨åˆ†ï¼‰ï¼š<br><a href="/images/java-string-intern-3.jpg"><img src="/images/java-string-intern-3.jpg" alt=""></a><br>æ‰§è¡ŒæŒ‡ä»¤ï¼ˆéƒ¨åˆ†ï¼Œç¬¬äºŒåˆ—#+åºæ•°å¯¹åº”å¸¸é‡æ± ä¸­çš„é¡¹ï¼‰ï¼š<br><a href="/images/java-string-intern-4.jpg"><img src="/images/java-string-intern-4.jpg" alt=""></a><br>åœ¨è§£é‡Šä¸Šè¿°æ‰§è¡Œè¿‡ç¨‹ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸¤æ¡æŒ‡ä»¤ï¼š</p>
<p>ldcï¼šPush item from run-time constant poolï¼Œä»å¸¸é‡æ± ä¸­åŠ è½½æŒ‡å®šé¡¹çš„å¼•ç”¨åˆ°æ ˆã€‚</p>
<p>astore_<n>ï¼šStore reference into local variableï¼Œå°†å¼•ç”¨èµ‹å€¼ç»™ç¬¬nä¸ªå±€éƒ¨å˜é‡ã€‚</n></p>
<p>ç°åœ¨æˆ‘ä»¬å¼€å§‹è§£é‡Šä»£ç æ®µäºŒçš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<p>0: ldc           #2ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬äºŒé¡¹ï¼ˆâ€baseStrâ€ï¼‰åˆ°æ ˆä¸­ã€‚</p>
<p>2: astore_1      ï¼šå°†1ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå³String baseStr = â€œbaseStrâ€ï¼›</p>
<p>3: ldc           #2ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬äºŒé¡¹ï¼ˆâ€baseStrâ€ï¼‰åˆ°æ ˆä¸­ã€‚</p>
<p>5: astore_2      ï¼šå°†3ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬äºŒä¸ªå±€éƒ¨å˜é‡ï¼Œå³ final String baseFinalStr=â€baseStrâ€ï¼› </p>
<p>6: ldc           #3ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼ˆâ€baseStr01â€ï¼‰åˆ°æ ˆä¸­ã€‚</p>
<p>8: astore_3     ï¼šå°†6ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬ä¸‰ä¸ªå±€éƒ¨å˜é‡ï¼Œå³String str1=â€baseStr01â€;</p>
<p>9: ldc           #3ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼ˆâ€baseStr01â€ï¼‰åˆ°æ ˆä¸­ã€‚</p>
<p>11: astore        4ï¼šå°†9ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬å››ä¸ªå±€éƒ¨å˜é‡ï¼šå³String str2=â€baseStr01â€ï¼›</p>
<font color="blue"><br>ç»“æœ#3ï¼šstr1==str2 è‚¯å®šä¼šè¿”å›trueï¼Œå› ä¸ºstr1å’Œstr2éƒ½æŒ‡å‘å¸¸é‡æ± ä¸­çš„åŒä¸€å¼•ç”¨åœ°å€ã€‚æ‰€ä»¥å…¶å®åœ¨JAVA 1.6ä¹‹åï¼Œå¸¸é‡å­—ç¬¦ä¸²çš„â€œ+â€æ“ä½œï¼Œç¼–è¯‘é˜¶æ®µç›´æ¥ä¼šåˆæˆä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</font><br>13: new           #4ï¼šç”ŸæˆStringBuilderçš„å®ä¾‹ã€‚<br><br>16: dup ã€€ã€€ã€€ã€€   ï¼šå¤åˆ¶13ç”Ÿæˆå¯¹è±¡çš„å¼•ç”¨å¹¶å‹å…¥æ ˆä¸­ã€‚<br><br>17: invokespecial #5ï¼šè°ƒç”¨å¸¸é‡æ± ä¸­çš„ç¬¬äº”é¡¹ï¼Œå³StringBuilder.<init>æ–¹æ³•ã€‚<br><br>ä»¥ä¸Šä¸‰æ¡æŒ‡ä»¤çš„ä½œç”¨æ˜¯ç”Ÿæˆä¸€ä¸ªStringBuilderçš„å¯¹è±¡ã€‚<br><br>20: aload_1ã€€ã€€ï¼šåŠ è½½ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼ï¼Œå³â€baseStrâ€<br><br>21: invokevirtual #6 ï¼šè°ƒç”¨StringBuilderå¯¹è±¡çš„appendæ–¹æ³•ã€‚<br><br>24: ldc           #7ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸ƒé¡¹ï¼ˆâ€01â€ï¼‰åˆ°æ ˆä¸­ã€‚<br><br>26: invokevirtual #6ï¼šè°ƒç”¨StringBuilder.appendæ–¹æ³•ã€‚<br><br>29: invokevirtual #8ï¼šè°ƒç”¨StringBuilder.toStringæ–¹æ³•ã€‚<br><br>32: astore        5ï¼šå°†29ä¸­çš„ç»“æœå¼•ç”¨èµ‹å€¼æ”¹ç¬¬äº”ä¸ªå±€éƒ¨å˜é‡ï¼Œå³å¯¹å˜é‡str3çš„èµ‹å€¼ã€‚<br><font color="blue"><br>ç»“æœ #4ï¼šå› ä¸ºstr3å®é™…ä¸Šæ˜¯stringBuilder.append()ç”Ÿæˆçš„ç»“æœï¼Œæ‰€ä»¥ä¸str1ä¸ç›¸ç­‰ï¼Œç»“æœè¿”å›falseã€‚</font><br>34: ldc           #3ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼ˆâ€baseStr01â€ï¼‰åˆ°æ ˆä¸­ã€‚<br><br>36: astore        6ï¼šå°†34ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬å…­ä¸ªå±€éƒ¨å˜é‡ï¼Œå³str4=â€baseStr01â€;<br><font color="blue"><br>ç»“æœ #5 ï¼šå› ä¸ºstr1å’Œstr4æŒ‡å‘çš„éƒ½æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼Œæ‰€ä»¥str1==str4è¿”å›trueã€‚è¿™é‡Œæˆ‘ä»¬è¿˜èƒ½å‘ç°ä¸€ä¸ªç°è±¡ï¼Œå¯¹äºfinalå­—æ®µï¼Œç¼–è¯‘æœŸç›´æ¥è¿›è¡Œäº†å¸¸é‡æ›¿æ¢ï¼Œè€Œå¯¹äºéfinalå­—æ®µåˆ™æ˜¯åœ¨è¿è¡ŒæœŸè¿›è¡Œèµ‹å€¼å¤„ç†çš„ã€‚</font><br>38: new           #9ï¼šåˆ›å»ºStringå¯¹è±¡<br><br>41: dup               ï¼šå¤åˆ¶å¼•ç”¨å¹¶å‹å¦‚æ ˆä¸­ã€‚<br><br>42: ldc           #3ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼ˆâ€baseStr01â€ï¼‰åˆ°æ ˆä¸­ã€‚<br><br>44: invokespecial #10ï¼šè°ƒç”¨String.â€<init>â€œæ–¹æ³•ï¼Œå¹¶ä¼ 42æ­¥éª¤ä¸­çš„å¼•ç”¨ä½œä¸ºå‚æ•°ä¼ å…¥è¯¥æ–¹æ³•ã€‚<br><br>47: invokevirtual #11ï¼šè°ƒç”¨String.internæ–¹æ³•ã€‚<br><br>ä»38åˆ°41çš„å¯¹åº”çš„æºç å°±æ˜¯new String(â€œbaseStr01â€).intern()ã€‚<br><br>50: astore        7ï¼šå°†47æ­¥è¿”å›çš„ç»“æœèµ‹å€¼ç»™å˜é‡7ï¼Œå³str5æŒ‡å‘baseStr01åœ¨å¸¸é‡æ± ä¸­çš„ä½ç½®ã€‚<br><font color="blue"><br>ç»“æœ #6 ï¼šå› ä¸ºstr5å’Œstr1éƒ½æŒ‡å‘çš„éƒ½æ˜¯å¸¸é‡æ± ä¸­çš„åŒä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥str1==str5è¿”å›trueã€‚</font><br>è¿è¡Œä»£ç æ®µäºŒï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š<br><a href="/images/java-string-intern-5.jpg"><img src="/images/java-string-intern-5.jpg" alt=""></a><br><br>## ä»£ç æ®µä¸‰è§£æï¼š<br>å¯¹äºä»£ç æ®µä¸‰ï¼Œåœ¨ JDK 1.6 å’Œ JDK 1.7ä¸­çš„è¿è¡Œç»“æœä¸åŒã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼Œç„¶åå†æ¥è§£é‡Šå…¶åŸå› ï¼š<br><br>JDK 1.6 ä¸‹çš„è¿è¡Œç»“æœï¼š<br><a href="/images/java-string-intern-6.jpg"><img src="/images/java-string-intern-6.jpg" alt=""></a><br>JDK 1.7 ä¸‹çš„è¿è¡Œç»“æœï¼š<br><a href="/images/java-string-intern-7.jpg"><img src="/images/java-string-intern-7.jpg" alt=""></a><br><br>æ ¹æ®å¯¹ä»£ç æ®µä¸€çš„åˆ†æï¼Œåº”è¯¥å¯ä»¥å¾ˆç®€å•å¾—å‡º JDK 1.6 çš„ç»“æœï¼Œå› ä¸º str2 å’Œ str1æœ¬æ¥å°±æ˜¯æŒ‡å‘ä¸åŒçš„ä½ç½®ï¼Œç†åº”è¿”å›falseã€‚<br><br>æ¯”è¾ƒå¥‡æ€ªçš„é—®é¢˜åœ¨äºJDK 1.7åï¼Œå¯¹äºç¬¬ä¸€ç§æƒ…å†µè¿”å›trueï¼Œä½†æ˜¯è°ƒæ¢äº†ä¸€ä¸‹ä½ç½®è¿”å›çš„ç»“æœå°±å˜æˆäº†falseã€‚è¿™ä¸ªåŸå› ä¸»è¦æ˜¯ä»JDK 1.7åï¼ŒHotSpot å°†å¸¸é‡æ± ä»æ°¸ä¹…ä»£ç§»åˆ°äº†å…ƒç©ºé—´ï¼Œæ­£å› ä¸ºå¦‚æ­¤ï¼ŒJDK 1.7 åçš„internæ–¹æ³•åœ¨å®ç°ä¸Šå‘ç”Ÿäº†æ¯”è¾ƒå¤§çš„æ”¹å˜ï¼ŒJDK 1.7åï¼Œinternæ–¹æ³•è¿˜æ˜¯ä¼šå…ˆå»æŸ¥è¯¢å¸¸é‡æ± ä¸­æ˜¯å¦æœ‰å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›å¸¸é‡æ± ä¸­çš„å¼•ç”¨ï¼Œè¿™ä¸€ç‚¹ä¸ä¹‹å‰æ²¡æœ‰åŒºåˆ«ï¼ŒåŒºåˆ«åœ¨äºï¼Œå¦‚æœåœ¨å¸¸é‡æ± æ‰¾ä¸åˆ°å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œåˆ™ä¸ä¼šå†å°†å­—ç¬¦ä¸²æ‹·è´åˆ°å¸¸é‡æ± ï¼Œè€Œåªæ˜¯åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆä¸€ä¸ªå¯¹åŸå­—ç¬¦ä¸²çš„å¼•ç”¨ã€‚æ‰€ä»¥:<br><font color="blue"><br>ç»“æœ #7ï¼šåœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œå› ä¸ºå¸¸é‡æ± ä¸­æ²¡æœ‰â€œstr01â€è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¼šåœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆä¸€ä¸ªå¯¹å †ä¸­çš„â€œstr01â€çš„å¼•ç”¨ï¼Œè€Œåœ¨è¿›è¡Œå­—é¢é‡èµ‹å€¼çš„æ—¶å€™ï¼Œå¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›è¯¥å¼•ç”¨å³å¯ï¼Œå› æ­¤str1å’Œstr2éƒ½æŒ‡å‘å †ä¸­çš„å­—ç¬¦ä¸²ï¼Œè¿”å›trueã€‚<br><br>ç»“æœ #8ï¼šè°ƒæ¢ä½ç½®ä»¥åï¼Œå› ä¸ºåœ¨è¿›è¡Œå­—é¢é‡èµ‹å€¼ï¼ˆString str1 = â€œstr01â€ï¼‰çš„æ—¶å€™ï¼Œå¸¸é‡æ± ä¸­ä¸å­˜åœ¨ï¼Œæ‰€ä»¥str1æŒ‡å‘çš„å¸¸é‡æ± ä¸­çš„ä½ç½®ï¼Œè€Œstr2æŒ‡å‘çš„æ˜¯å †ä¸­çš„å¯¹è±¡ï¼Œå†è¿›è¡Œinternæ–¹æ³•æ—¶ï¼Œå¯¹str1å’Œstr2å·²ç»æ²¡æœ‰å½±å“äº†ï¼Œæ‰€ä»¥è¿”å›falseã€‚</font>

<h1 id="å¸¸è§é¢è¯•é¢˜è§£ç­”"><a href="#å¸¸è§é¢è¯•é¢˜è§£ç­”" class="headerlink" title="å¸¸è§é¢è¯•é¢˜è§£ç­”"></a>å¸¸è§é¢è¯•é¢˜è§£ç­”</h1><p>æœ‰äº†å¯¹ä»¥ä¸Šçš„çŸ¥è¯†çš„äº†è§£ï¼Œæˆ‘ä»¬ç°åœ¨å†æ¥çœ‹å¸¸è§çš„é¢è¯•æˆ–ç¬”è¯•é¢˜å°±å¾ˆç®€å•äº†ï¼š</p>
<p>Qï¼šString s = new String(â€œxyzâ€)ï¼Œåˆ›å»ºäº†å‡ ä¸ªString Object? </p>
<p>Aï¼šä¸¤ä¸ªï¼Œå¸¸é‡æ± ä¸­çš„â€xyzâ€å’Œå †ä¸­å¯¹è±¡ã€‚</p>
<p>Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æœï¼š</p>
<p>String s1 = â€œabcâ€;<br>String s2 = â€œabcâ€;<br>System.out.println(s1 == s2);</p>
<p>Aï¼štrueï¼Œå‡æŒ‡å‘å¸¸é‡æ± ä¸­å¯¹è±¡ã€‚</p>
<p>Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æœï¼š</p>
<p>String s1 = new String(â€œabcâ€);<br>String s2 = new String(â€œabcâ€);<br>System.out.println(s1 == s2);</p>
<p>Aï¼šfalseï¼Œä¸¤ä¸ªå¼•ç”¨æŒ‡å‘å †ä¸­çš„ä¸åŒå¯¹è±¡ã€‚</p>
<p>Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æœï¼š</p>
<p>String s1 = â€œabcâ€;<br>String s2 = â€œaâ€;<br>String s3 = â€œbcâ€;<br>String s4 = s2 + s3;<br>System.out.println(s1 == s4);</p>
<p>Aï¼šfalseï¼Œå› ä¸ºs2+s3å®é™…ä¸Šæ˜¯ä½¿ç”¨StringBuilder.appendæ¥å®Œæˆï¼Œä¼šç”Ÿæˆä¸åŒçš„å¯¹è±¡ã€‚</p>
<p>Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æœï¼š</p>
<p>String s1 = â€œabcâ€;<br>final String s2 = â€œaâ€;<br>final String s3 = â€œbcâ€;<br>String s4 = s2 + s3;<br>System.out.println(s1 == s4);</p>
<p>Aï¼štrueï¼Œå› ä¸ºfinalå˜é‡åœ¨ç¼–è¯‘åä¼šç›´æ¥æ›¿æ¢æˆå¯¹åº”çš„å€¼ï¼Œæ‰€ä»¥å®é™…ä¸Šç­‰äºs4=â€aâ€+â€bcâ€ï¼Œè€Œè¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥åˆå¹¶ä¸ºs4=â€abcâ€ï¼Œæ‰€ä»¥æœ€ç»ˆs1==s4ã€‚</p>
<p>Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æœï¼š</p>
<p>String s = new String(â€œabcâ€);<br>String s1 = â€œabcâ€;<br>String s2 = new String(â€œabcâ€);</p>
<p>System.out.println(s == s1.intern());<br>System.out.println(s == s2.intern());<br>System.out.println(s1 == s2.intern());</p>
<p>Aï¼šfalseï¼Œfalseï¼Œtrueï¼Œå…·ä½“åŸå› å‚è€ƒç¬¬äºŒéƒ¨åˆ†å†…å®¹ã€‚</p>
<p>åŸæ–‡åœ°å€ <a href="http://www.cnblogs.com/paddix/p/5326863.html" target="_blank" rel="external">http://www.cnblogs.com/paddix/p/5326863.html</a></p>
</init></init>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;å­—ç¬¦ä¸²é—®é¢˜&quot;&gt;&lt;a href=&quot;#å­—ç¬¦ä¸²é—®é¢˜&quot; class=&quot;headerlink&quot; title=&quot;å­—ç¬¦ä¸²é—®é¢˜&quot;&gt;&lt;/a&gt;å­—ç¬¦ä¸²é—®é¢˜&lt;/h1&gt;&lt;p&gt;å­—ç¬¦ä¸²åœ¨æˆ‘ä»¬å¹³æ—¶çš„ç¼–ç å·¥ä½œä¸­å…¶å®ç”¨çš„éå¸¸å¤šï¼Œå¹¶ä¸”ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥å¾ˆå°‘æœ‰äººå¯¹å…¶åšç‰¹åˆ«æ·±å…¥çš„ç ”ç©¶ã€‚å€’æ˜¯é¢è¯•æˆ–è€…ç¬”è¯•çš„æ—¶å€™ï¼Œå¾€å¾€ä¼šæ¶‰åŠæ¯”è¾ƒæ·±å…¥å’Œéš¾åº¦å¤§ä¸€ç‚¹çš„é—®é¢˜ã€‚æˆ‘åœ¨æ‹›è˜çš„æ—¶å€™ä¹Ÿå¶å°”ä¼šé—®åº”è˜è€…ç›¸å…³çš„é—®é¢˜ï¼Œå€’ä¸æ˜¯è¯´ä¸€å®šè¦å›ç­”çš„ç‰¹åˆ«æ­£ç¡®å’Œæ·±å…¥ï¼Œé€šå¸¸é—®è¿™äº›é—®é¢˜çš„ç›®çš„æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€æ˜¯è€ƒå¯Ÿå¯¹ JAVA åŸºç¡€çŸ¥è¯†çš„äº†è§£ç¨‹åº¦ï¼Œç¬¬äºŒæ˜¯è€ƒå¯Ÿåº”è˜è€…å¯¹æŠ€æœ¯çš„æ€åº¦ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="jvm" scheme="http://idiotsky.me/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>Java8å†…å­˜æ¨¡å‹â€”æ°¸ä¹…ä»£(PermGen)å’Œå…ƒç©ºé—´(Metaspace)</title>
    <link href="http://idiotsky.me/2016/07/26/java8-permgen-metaspace/"/>
    <id>http://idiotsky.me/2016/07/26/java8-permgen-metaspace/</id>
    <published>2016-07-26T12:28:09.000Z</published>
    <updated>2017-07-29T12:24:40.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="JVM-å†…å­˜æ¨¡å‹"><a href="#JVM-å†…å­˜æ¨¡å‹" class="headerlink" title="JVM å†…å­˜æ¨¡å‹"></a>JVM å†…å­˜æ¨¡å‹</h1><p>æ ¹æ® JVM è§„èŒƒï¼ŒJVM å†…å­˜å…±åˆ†ä¸ºè™šæ‹Ÿæœºæ ˆã€å †ã€æ–¹æ³•åŒºã€ç¨‹åºè®¡æ•°å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆäº”ä¸ªéƒ¨åˆ†ã€‚<br><a href="/images/java8-permgen-metaspace-1.png"><img src="/images/java8-permgen-metaspace-1.png" alt=""></a><br><a id="more"></a></p>
<h2 id="è™šæ‹Ÿæœºæ ˆ"><a href="#è™šæ‹Ÿæœºæ ˆ" class="headerlink" title="è™šæ‹Ÿæœºæ ˆ"></a>è™šæ‹Ÿæœºæ ˆ</h2><p>æ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªç§æœ‰çš„æ ˆï¼Œéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºã€‚æ ˆé‡Œé¢å­˜ç€çš„æ˜¯ä¸€ç§å«â€œæ ˆå¸§â€çš„ä¸œè¥¿ï¼Œæ¯ä¸ªæ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ ˆå¸§ä¸­å­˜æ”¾äº†å±€éƒ¨å˜é‡è¡¨ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡å¼•ç”¨ï¼‰ã€æ“ä½œæ•°æ ˆã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ ˆçš„å¤§å°å¯ä»¥å›ºå®šä¹Ÿå¯ä»¥åŠ¨æ€æ‰©å±•ã€‚å½“æ ˆè°ƒç”¨æ·±åº¦å¤§äºJVMæ‰€å…è®¸çš„èŒƒå›´ï¼Œä¼šæŠ›å‡ºStackOverflowErrorçš„é”™è¯¯ï¼Œä¸è¿‡è¿™ä¸ªæ·±åº¦èŒƒå›´ä¸æ˜¯ä¸€ä¸ªæ’å®šçš„å€¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™æ®µç¨‹åºå¯ä»¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªç»“æœï¼š<br>æ ˆæº¢å‡ºæµ‹è¯•æºç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.memory;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StackErrorMock</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> index = <span class="number">1</span>;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span></span>&#123;</div><div class="line">        index++;</div><div class="line">        call();</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        StackErrorMock mock = <span class="keyword">new</span> StackErrorMock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mock.call();</div><div class="line">        &#125;<span class="keyword">catch</span> (Throwable e)&#123;</div><div class="line">            System.out.println(<span class="string">"Stack deep : "</span>+index);</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»£ç æ®µ1</p>
<p>è¿è¡Œä¸‰æ¬¡ï¼Œå¯ä»¥çœ‹å‡ºæ¯æ¬¡æ ˆçš„æ·±åº¦éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ã€‚<br><a href="/images/java8-permgen-metaspace-2.png"><img src="/images/java8-permgen-metaspace-2.png" alt=""></a><br>è‡³äºçº¢è‰²æ¡†é‡Œçš„å€¼æ˜¯æ€ä¹ˆå‡ºæ¥çš„ï¼Œå°±éœ€è¦æ·±å…¥åˆ° JVM çš„æºç ä¸­æ‰èƒ½æ¢è®¨ï¼Œè¿™é‡Œä¸ä½œè¯¦ç»†é˜è¿°ã€‚</p>
<p>è™šæ‹Ÿæœºæ ˆé™¤äº†ä¸Šè¿°é”™è¯¯å¤–ï¼Œè¿˜æœ‰å¦ä¸€ç§é”™è¯¯ï¼Œé‚£å°±æ˜¯å½“ç”³è¯·ä¸åˆ°ç©ºé—´æ—¶ï¼Œä¼šæŠ›å‡º OutOfMemoryErrorã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œcatch æ•è·çš„æ˜¯ Throwableï¼Œè€Œä¸æ˜¯ Exceptionã€‚å› ä¸º StackOverflowError å’Œ OutOfMemoryError éƒ½ä¸å±äº Exception çš„å­ç±»ã€‚</p>
<h2 id="æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="æœ¬åœ°æ–¹æ³•æ ˆ"></a>æœ¬åœ°æ–¹æ³•æ ˆ</h2><p>è¿™éƒ¨åˆ†ä¸»è¦ä¸è™šæ‹Ÿæœºç”¨åˆ°çš„ Native æ–¹æ³•ç›¸å…³ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ Java åº”ç”¨ç¨‹åºå‘˜å¹¶ä¸éœ€è¦å…³å¿ƒè¿™éƒ¨åˆ†çš„å†…å®¹</p>
<h2 id="PC-å¯„å­˜å™¨"><a href="#PC-å¯„å­˜å™¨" class="headerlink" title="PC å¯„å­˜å™¨"></a>PC å¯„å­˜å™¨</h2><p>PC å¯„å­˜å™¨ï¼Œä¹Ÿå«ç¨‹åºè®¡æ•°å™¨ã€‚JVMæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ã€‚å€˜è‹¥å½“å‰æ‰§è¡Œçš„æ˜¯ JVM çš„æ–¹æ³•ï¼Œåˆ™è¯¥å¯„å­˜å™¨ä¸­ä¿å­˜å½“å‰æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ï¼›å€˜è‹¥æ‰§è¡Œçš„æ˜¯native æ–¹æ³•ï¼Œåˆ™PCå¯„å­˜å™¨ä¸­ä¸ºç©ºã€‚</p>
<h2 id="å †"><a href="#å †" class="headerlink" title="å †"></a>å †</h2><p>å †å†…å­˜æ˜¯ JVM æ‰€æœ‰çº¿ç¨‹å…±äº«çš„éƒ¨åˆ†ï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™å°±å·²ç»åˆ›å»ºã€‚æ‰€æœ‰çš„å¯¹è±¡å’Œæ•°ç»„éƒ½åœ¨å †ä¸Šè¿›è¡Œåˆ†é…ã€‚è¿™éƒ¨åˆ†ç©ºé—´å¯é€šè¿‡ GC è¿›è¡Œå›æ”¶ã€‚å½“ç”³è¯·ä¸åˆ°ç©ºé—´æ—¶ä¼šæŠ›å‡º OutOfMemoryErrorã€‚ä¸‹é¢æˆ‘ä»¬ç®€å•çš„æ¨¡æ‹Ÿä¸€ä¸ªå †å†…å­˜æº¢å‡ºçš„æƒ…å†µï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.memory;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeapOomMock</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        List&lt;<span class="keyword">byte</span>[]&gt; list = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">byte</span>[]&gt;();</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">while</span> (flag)&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                i++;</div><div class="line">                list.add(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>]);<span class="comment">//æ¯æ¬¡å¢åŠ ä¸€ä¸ª1Må¤§å°çš„æ•°ç»„å¯¹è±¡</span></div><div class="line">            &#125;<span class="keyword">catch</span> (Throwable e)&#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                flag = <span class="keyword">false</span>;</div><div class="line">                System.out.println(<span class="string">"count="</span>+i);<span class="comment">//è®°å½•è¿è¡Œçš„æ¬¡æ•°</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»£ç æ®µ2</p>
<p>è¿è¡Œä¸Šè¿°ä»£ç ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼šã€€<br><a href="/images/java8-permgen-metaspace-3.png"><img src="/images/java8-permgen-metaspace-3.png" alt=""></a><br><em>æ³¨æ„ï¼Œè¿™é‡Œæˆ‘æŒ‡å®šäº†å †å†…å­˜çš„å¤§å°ä¸º16Mï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹æ˜¾ç¤ºçš„count=14ï¼ˆè¿™ä¸ªæ•°å­—ä¸æ˜¯å›ºå®šçš„ï¼‰ï¼Œè‡³äºä¸ºä»€ä¹ˆä¼šæ˜¯14æˆ–å…¶ä»–æ•°å­—ï¼Œéœ€è¦æ ¹æ® GC æ—¥å¿—æ¥åˆ¤æ–­</em></p>
<h2 id="æ–¹æ³•åŒº"><a href="#æ–¹æ³•åŒº" class="headerlink" title="æ–¹æ³•åŒº"></a>æ–¹æ³•åŒº</h2><p>ã€€ã€€æ–¹æ³•åŒºä¹Ÿæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«ã€‚ä¸»è¦ç”¨äºå­˜å‚¨ç±»çš„ä¿¡æ¯ã€å¸¸é‡æ± ã€æ–¹æ³•æ•°æ®ã€æ–¹æ³•ä»£ç ç­‰ã€‚æ–¹æ³•åŒºé€»è¾‘ä¸Šå±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä¸ºäº†ä¸å †è¿›è¡ŒåŒºåˆ†ï¼Œé€šå¸¸åˆå«â€œéå †â€ã€‚ å…³äºæ–¹æ³•åŒºå†…å­˜æº¢å‡ºçš„é—®é¢˜ä¼šåœ¨ä¸‹æ–‡ä¸­è¯¦ç»†æ¢è®¨ã€‚</p>
<h1 id="PermGenï¼ˆæ°¸ä¹…ä»£ï¼‰"><a href="#PermGenï¼ˆæ°¸ä¹…ä»£ï¼‰" class="headerlink" title="PermGenï¼ˆæ°¸ä¹…ä»£ï¼‰"></a>PermGenï¼ˆæ°¸ä¹…ä»£ï¼‰</h1><p>ç»å¤§éƒ¨åˆ† Java ç¨‹åºå‘˜åº”è¯¥éƒ½è§è¿‡ â€œjava.lang.OutOfMemoryError: PermGen space â€œè¿™ä¸ªå¼‚å¸¸ã€‚è¿™é‡Œçš„ â€œPermGen spaceâ€å…¶å®æŒ‡çš„å°±æ˜¯æ–¹æ³•åŒºã€‚ä¸è¿‡æ–¹æ³•åŒºå’Œâ€œPermGen spaceâ€åˆæœ‰ç€æœ¬è´¨çš„åŒºåˆ«ã€‚å‰è€…æ˜¯ JVM çš„è§„èŒƒï¼Œè€Œåè€…åˆ™æ˜¯ JVM è§„èŒƒçš„ä¸€ç§å®ç°ï¼Œå¹¶ä¸”åªæœ‰ HotSpot æ‰æœ‰ â€œPermGen spaceâ€ï¼Œè€Œå¯¹äºå…¶ä»–ç±»å‹çš„è™šæ‹Ÿæœºï¼Œå¦‚ JRockitï¼ˆOracleï¼‰ã€J9ï¼ˆIBMï¼‰ å¹¶æ²¡æœ‰â€œPermGen spaceâ€ã€‚ç”±äºæ–¹æ³•åŒºä¸»è¦å­˜å‚¨ç±»çš„ç›¸å…³ä¿¡æ¯ï¼Œæ‰€ä»¥å¯¹äºåŠ¨æ€ç”Ÿæˆç±»çš„æƒ…å†µæ¯”è¾ƒå®¹æ˜“å‡ºç°æ°¸ä¹…ä»£çš„å†…å­˜æº¢å‡ºã€‚æœ€å…¸å‹çš„åœºæ™¯å°±æ˜¯ï¼Œåœ¨ jsp é¡µé¢æ¯”è¾ƒå¤šçš„æƒ…å†µï¼Œå®¹æ˜“å‡ºç°æ°¸ä¹…ä»£å†…å­˜æº¢å‡ºã€‚æˆ‘ä»¬ç°åœ¨é€šè¿‡åŠ¨æ€ç”Ÿæˆç±»æ¥æ¨¡æ‹Ÿ â€œPermGen spaceâ€çš„å†…å­˜æº¢å‡ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.memory;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.memory;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.net.URL;</div><div class="line"><span class="keyword">import</span> java.net.URLClassLoader;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermGenOomMock</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        URL url = <span class="keyword">null</span>;</div><div class="line">        List&lt;ClassLoader&gt; classLoaderList = <span class="keyword">new</span> ArrayList&lt;ClassLoader&gt;();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            url = <span class="keyword">new</span> File(<span class="string">"/tmp"</span>).toURI().toURL();</div><div class="line">            URL[] urls = &#123;url&#125;;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</div><div class="line">                ClassLoader loader = <span class="keyword">new</span> URLClassLoader(urls);</div><div class="line">                classLoaderList.add(loader);</div><div class="line">                loader.loadClass(<span class="string">"com.paddx.test.memory.Test"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç æ®µ3</p>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br><a href="/images/java8-permgen-metaspace-4.png"><img src="/images/java8-permgen-metaspace-4.png" alt=""></a><br>ã€€ã€€æœ¬ä¾‹ä¸­ä½¿ç”¨çš„ JDK ç‰ˆæœ¬æ˜¯ 1.7ï¼ŒæŒ‡å®šçš„ PermGen åŒºçš„å¤§å°ä¸º 8Mã€‚é€šè¿‡æ¯æ¬¡ç”Ÿæˆä¸åŒURLClassLoaderå¯¹è±¡æ¥åŠ è½½Testç±»ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„ç±»å¯¹è±¡ï¼Œè¿™æ ·å°±èƒ½çœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„ â€œjava.lang.OutOfMemoryError: PermGen space â€œ å¼‚å¸¸äº†ã€‚è¿™é‡Œä¹‹æ‰€ä»¥é‡‡ç”¨ JDK 1.7ï¼Œæ˜¯å› ä¸ºåœ¨ JDK 1.8 ä¸­ï¼Œ HotSpot å·²ç»æ²¡æœ‰ â€œPermGen spaceâ€è¿™ä¸ªåŒºé—´äº†ï¼Œå–è€Œä»£ä¹‹æ˜¯ä¸€ä¸ªå«åš Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰ çš„ä¸œè¥¿ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ Metaspace ä¸ PermGen space çš„åŒºåˆ«ã€‚</p>
<h1 id="Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰"><a href="#Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰" class="headerlink" title="Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰"></a>Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰</h1><p>å…¶å®ï¼Œç§»é™¤æ°¸ä¹…ä»£çš„å·¥ä½œä»JDK1.7å°±å¼€å§‹äº†ã€‚JDK1.7ä¸­ï¼Œå­˜å‚¨åœ¨æ°¸ä¹…ä»£çš„éƒ¨åˆ†æ•°æ®å°±å·²ç»è½¬ç§»åˆ°äº†Java Heapæˆ–è€…æ˜¯ Native Heapã€‚ä½†æ°¸ä¹…ä»£ä»å­˜åœ¨äºJDK1.7ä¸­ï¼Œå¹¶æ²¡å®Œå…¨ç§»é™¤ï¼Œè­¬å¦‚ç¬¦å·å¼•ç”¨(Symbols)è½¬ç§»åˆ°äº†native heapï¼›å­—é¢é‡(interned strings)è½¬ç§»åˆ°äº†java heapï¼›ç±»çš„é™æ€å˜é‡(class statics)è½¬ç§»åˆ°äº†java heapã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€æ®µç¨‹åºæ¥æ¯”è¾ƒ JDK 1.6 ä¸ JDK 1.7åŠ JDK 1.8 çš„åŒºåˆ«ï¼Œä»¥å­—ç¬¦ä¸²å¸¸é‡ä¸ºä¾‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.memory;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringOomMock</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> String  base = <span class="string">"string"</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt; Integer.MAX_VALUE;i++)&#123;</div><div class="line">            String str = base + base;</div><div class="line">            base = str;</div><div class="line">            list.add(str.intern());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»£ç æ®µ4</p>
<p>è¿™æ®µç¨‹åºä»¥2çš„æŒ‡æ•°çº§ä¸æ–­çš„ç”Ÿæˆæ–°çš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·å¯ä»¥æ¯”è¾ƒå¿«é€Ÿçš„æ¶ˆè€—å†…å­˜ã€‚æˆ‘ä»¬é€šè¿‡ JDK 1.6ã€JDK 1.7 å’Œ JDK 1.8 åˆ†åˆ«è¿è¡Œï¼š<br>JDK 1.6 çš„è¿è¡Œç»“æœï¼š<br><a href="/images/java8-permgen-metaspace-5.png"><img src="/images/java8-permgen-metaspace-5.png" alt=""></a><br>JDK 1.7çš„è¿è¡Œç»“æœï¼š<br><a href="/images/java8-permgen-metaspace-6.png"><img src="/images/java8-permgen-metaspace-6.png" alt=""></a><br>JDK 1.8çš„è¿è¡Œç»“æœï¼š<br><a href="/images/java8-permgen-metaspace-7.png"><img src="/images/java8-permgen-metaspace-7.png" alt=""></a><br>ä»ä¸Šè¿°ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒJDK 1.6ä¸‹ï¼Œä¼šå‡ºç°â€œPermGen Spaceâ€çš„å†…å­˜æº¢å‡ºï¼Œè€Œåœ¨ JDK 1.7å’Œ JDK 1.8 ä¸­ï¼Œä¼šå‡ºç°å †å†…å­˜æº¢å‡ºï¼Œå¹¶ä¸” JDK 1.8ä¸­ PermSize å’Œ MaxPermGen å·²ç»æ— æ•ˆã€‚å› æ­¤ï¼Œå¯ä»¥å¤§è‡´éªŒè¯ JDK 1.7 å’Œ 1.8 å°†å­—ç¬¦ä¸²å¸¸é‡ç”±æ°¸ä¹…ä»£è½¬ç§»åˆ°å †ä¸­ï¼Œå¹¶ä¸” JDK 1.8 ä¸­å·²ç»ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„ç»“è®ºã€‚ç°åœ¨æˆ‘ä»¬çœ‹çœ‹å…ƒç©ºé—´åˆ°åº•æ˜¯ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ</p>
<p>ã€€ã€€å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹å‚æ•°æ¥æŒ‡å®šå…ƒç©ºé—´çš„å¤§å°ï¼š</p>
<p>ã€€ã€€-XX:MetaspaceSizeï¼Œåˆå§‹ç©ºé—´å¤§å°ï¼Œè¾¾åˆ°è¯¥å€¼å°±ä¼šè§¦å‘åƒåœ¾æ”¶é›†è¿›è¡Œç±»å‹å¸è½½ï¼ŒåŒæ—¶GCä¼šå¯¹è¯¥å€¼è¿›è¡Œè°ƒæ•´ï¼šå¦‚æœé‡Šæ”¾äº†å¤§é‡çš„ç©ºé—´ï¼Œå°±é€‚å½“é™ä½è¯¥å€¼ï¼›å¦‚æœé‡Šæ”¾äº†å¾ˆå°‘çš„ç©ºé—´ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡MaxMetaspaceSizeæ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ã€‚<br>ã€€ã€€-XX:MaxMetaspaceSizeï¼Œæœ€å¤§ç©ºé—´ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰é™åˆ¶çš„ã€‚</p>
<p>ã€€ã€€é™¤äº†ä¸Šé¢ä¸¤ä¸ªæŒ‡å®šå¤§å°çš„é€‰é¡¹ä»¥å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªä¸ GC ç›¸å…³çš„å±æ€§ï¼š<br>ã€€ã€€-XX:MinMetaspaceFreeRatioï¼Œåœ¨GCä¹‹åï¼Œæœ€å°çš„Metaspaceå‰©ä½™ç©ºé—´å®¹é‡çš„ç™¾åˆ†æ¯”ï¼Œå‡å°‘ä¸ºåˆ†é…ç©ºé—´æ‰€å¯¼è‡´çš„åƒåœ¾æ”¶é›†<br>ã€€ã€€-XX:MaxMetaspaceFreeRatioï¼Œåœ¨GCä¹‹åï¼Œæœ€å¤§çš„Metaspaceå‰©ä½™ç©ºé—´å®¹é‡çš„ç™¾åˆ†æ¯”ï¼Œå‡å°‘ä¸ºé‡Šæ”¾ç©ºé—´æ‰€å¯¼è‡´çš„åƒåœ¾æ”¶é›†</p>
<p>ç°åœ¨æˆ‘ä»¬åœ¨ JDK 8ä¸‹é‡æ–°è¿è¡Œä¸€ä¸‹ä»£ç æ®µ3ï¼Œä¸è¿‡è¿™æ¬¡ä¸å†æŒ‡å®š PermSize å’Œ MaxPermSizeã€‚è€Œæ˜¯æŒ‡å®š MetaSpaceSize å’Œ MaxMetaSpaceSizeçš„å¤§å°ã€‚è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š<br><a href="/images/java8-permgen-metaspace-8.png"><img src="/images/java8-permgen-metaspace-8.png" alt=""></a><br>ä»è¾“å‡ºç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™æ¬¡ä¸å†å‡ºç°æ°¸ä¹…ä»£æº¢å‡ºï¼Œè€Œæ˜¯å‡ºç°äº†å…ƒç©ºé—´çš„æº¢å‡ºã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ã€€ã€€é€šè¿‡ä¸Šé¢åˆ†æï¼Œå¤§å®¶åº”è¯¥å¤§è‡´äº†è§£äº† JVM çš„å†…å­˜åˆ’åˆ†ï¼Œä¹Ÿæ¸…æ¥šäº† JDK 8 ä¸­æ°¸ä¹…ä»£å‘å…ƒç©ºé—´çš„è½¬æ¢ã€‚ä¸è¿‡å¤§å®¶åº”è¯¥éƒ½æœ‰ä¸€ä¸ªç–‘é—®ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªè½¬æ¢ï¼Ÿæ‰€ä»¥ï¼Œæœ€åç»™å¤§å®¶æ€»ç»“ä»¥ä¸‹å‡ ç‚¹åŸå› ï¼š</p>
<ul>
<li>å­—ç¬¦ä¸²å­˜åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œå®¹æ˜“å‡ºç°æ€§èƒ½é—®é¢˜å’Œå†…å­˜æº¢å‡ºã€‚</li>
<li>ç±»åŠæ–¹æ³•çš„ä¿¡æ¯ç­‰æ¯”è¾ƒéš¾ç¡®å®šå…¶å¤§å°ï¼Œå› æ­¤å¯¹äºæ°¸ä¹…ä»£çš„å¤§å°æŒ‡å®šæ¯”è¾ƒå›°éš¾ï¼Œå¤ªå°å®¹æ˜“å‡ºç°æ°¸ä¹…ä»£æº¢å‡ºï¼Œå¤ªå¤§åˆ™å®¹æ˜“å¯¼è‡´è€å¹´ä»£æº¢å‡ºã€‚</li>
<li>æ°¸ä¹…ä»£ä¼šä¸º GC å¸¦æ¥ä¸å¿…è¦çš„å¤æ‚åº¦ï¼Œå¹¶ä¸”å›æ”¶æ•ˆç‡åä½ã€‚</li>
<li>Oracle å¯èƒ½ä¼šå°†HotSpot ä¸ JRockit åˆäºŒä¸ºä¸€ã€‚</li>
</ul>
<p>åŸæ–‡åœ°å€ <a href="http://www.cnblogs.com/paddix/p/5309550.html" target="_blank" rel="external">http://www.cnblogs.com/paddix/p/5309550.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;JVM-å†…å­˜æ¨¡å‹&quot;&gt;&lt;a href=&quot;#JVM-å†…å­˜æ¨¡å‹&quot; class=&quot;headerlink&quot; title=&quot;JVM å†…å­˜æ¨¡å‹&quot;&gt;&lt;/a&gt;JVM å†…å­˜æ¨¡å‹&lt;/h1&gt;&lt;p&gt;æ ¹æ® JVM è§„èŒƒï¼ŒJVM å†…å­˜å…±åˆ†ä¸ºè™šæ‹Ÿæœºæ ˆã€å †ã€æ–¹æ³•åŒºã€ç¨‹åºè®¡æ•°å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆäº”ä¸ªéƒ¨åˆ†ã€‚&lt;br&gt;&lt;a href=&quot;/images/java8-permgen-metaspace-1.png&quot;&gt;&lt;img src=&quot;/images/java8-permgen-metaspace-1.png&quot; alt=&quot;&quot;&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="jvm" scheme="http://idiotsky.me/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>ä»å­—èŠ‚ç å±‚é¢çœ‹â€œHelloWorldâ€</title>
    <link href="http://idiotsky.me/2016/07/23/bytecode-hello-world/"/>
    <id>http://idiotsky.me/2016/07/23/bytecode-hello-world/</id>
    <published>2016-07-23T12:28:09.000Z</published>
    <updated>2017-07-27T16:09:06.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HelloWorld-å­—èŠ‚ç ç”Ÿæˆ"><a href="#HelloWorld-å­—èŠ‚ç ç”Ÿæˆ" class="headerlink" title="HelloWorld å­—èŠ‚ç ç”Ÿæˆ"></a>HelloWorld å­—èŠ‚ç ç”Ÿæˆ</h1><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒJava ç¨‹åºæ˜¯åœ¨ JVM ä¸Šè¿è¡Œçš„ï¼Œä¸è¿‡ JVM è¿è¡Œçš„å…¶å®ä¸æ˜¯ Java è¯­è¨€æœ¬èº«ï¼Œè€Œæ˜¯ Java ç¨‹åºç¼–è¯‘æˆçš„å­—èŠ‚ç æ–‡ä»¶ã€‚å¯èƒ½ä¸€å¼€å§‹ JVM æ˜¯ä¸º Java è¯­è¨€æœåŠ¡çš„ï¼Œä¸è¿‡éšç€ç¼–è¯‘æŠ€æœ¯å’Œ JVM è‡ªèº«çš„ä¸æ–­å‘å±•å’Œæˆç†Ÿï¼ŒJVM å·²ç»ä¸ä»…ä»…åªè¿è¡Œ Java ç¨‹åºã€‚ä»»ä½•èƒ½ç¼–è¯‘æˆä¸ºç¬¦åˆ JVM å­—èŠ‚ç è§„èŒƒçš„è¯­è¨€éƒ½å¯ä»¥åœ¨ JVM ä¸Šè¿è¡Œï¼Œæ¯”è¾ƒå¸¸è§çš„ Scalaã€Grooveã€JRubyç­‰ã€‚ä»Šå¤©ï¼Œæˆ‘å°±ä»å¤§å®¶æœ€ç†Ÿæ‚‰çš„ç¨‹åºâ€œHelloWorldâ€ç¨‹åºå…¥æ‰‹ï¼Œåˆ†ææ•´ä¸ª Class æ–‡ä»¶çš„ç»“æ„ã€‚è™½ç„¶è¿™ä¸ªç¨‹åºæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åŸºæœ¬ä¸ŠåŒ…å«äº†å­—èŠ‚ç è§„èŒƒä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œå› æ­¤å³ä½¿ä»¥åè¦åˆ†ææ›´å¤æ‚çš„ç¨‹åºï¼Œé‚£ä¹Ÿåªæ˜¯â€œé‡â€ä¸Šçš„å˜åŒ–ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ã€‚<br><a id="more"></a><br>ã€€ã€€æˆ‘ä»¬å…ˆç›´è§‚çš„çœ‹ä¸‹æºç ä¸å­—èŠ‚ç ä¹‹é—´çš„å¯¹åº”å…³ç³»:<br>HelloWorldçš„æºç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.asm;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Hello,World!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘å™¨é‡‡ç”¨JDK 1.7ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘ä»¥åçš„å­—èŠ‚ç æ–‡ä»¶ï¼ˆä½¿ç”¨UltraEditçš„16è¿›åˆ¶æ¨¡å¼æ‰“å¼€ï¼‰ï¼š<br><a href="/images/bytecode-hello-world-1.jpg"><img src="/images/bytecode-hello-world-1.jpg" alt=""></a><br>çº¢è‰²æ¡†å†…çš„éƒ¨åˆ†å°±æ˜¯HelloWorld.classçš„å†…å®¹ï¼Œå…¶ä»–éƒ¨åˆ†æ˜¯UltraEditè‡ªåŠ¨ç”Ÿæˆçš„ï¼šçº¢è‰²æ¡†é¡¶éƒ¨çš„0~fä»£è¡¨åˆ—å·ï¼Œå·¦è¾¹éƒ¨åˆ†ä»£è¡¨è¡Œå·ï¼Œå³ä¾§éƒ¨åˆ†æ˜¯äºŒè¿›åˆ¶ç å¯¹åº”çš„å­—ç¬¦ï¼ˆutf-8ç¼–ç ï¼‰ã€‚</p>
<h1 id="å­—èŠ‚ç è§£æ"><a href="#å­—èŠ‚ç è§£æ" class="headerlink" title="å­—èŠ‚ç è§£æ"></a>å­—èŠ‚ç è§£æ</h1><p>è¦å¼„æ˜ç™½ HelloWorld.java å’Œ HelloWorld.class æ–‡ä»¶æ˜¯å¦‚ä½•å¯¹åº”çš„ï¼Œæˆ‘ä»¬å¿…é¡»å¯¹ JVM çš„å­—èŠ‚ç è§„èŒƒæœ‰æ‰€äº†è§£ã€‚å­—èŠ‚ç æ–‡ä»¶çš„ç»“æ„éå¸¸ç´§å‡‘ï¼Œæ²¡æœ‰ä»»ä½•å†—ä½™çš„ä¿¡æ¯ï¼Œè¿åˆ†éš”ç¬¦éƒ½æ²¡æœ‰ï¼Œå®ƒé‡‡ç”¨çš„æ˜¯å›ºå®šçš„æ–‡ä»¶ç»“æ„å’Œæ•°æ®ç±»å‹æ¥å®ç°å¯¹å†…å®¹çš„åˆ†å‰²çš„ã€‚å­—èŠ‚ç ä¸­åŒ…æ‹¬ä¸¤ç§æ•°æ®ç±»å‹ï¼šæ— ç¬¦å·æ•°å’Œè¡¨ã€‚æ— ç¬¦å·æ•°åˆåŒ…æ‹¬ u1ï¼Œu2ï¼Œu4ï¼Œu8å››ç§ï¼Œåˆ†åˆ«ä»£è¡¨1ä¸ªå­—èŠ‚ã€2ä¸ªå­—èŠ‚ã€4ä¸ªå­—èŠ‚å’Œ8ä¸ªå­—èŠ‚ã€‚è€Œè¡¨ç»“æ„åˆ™æ˜¯ç”±æ— ç¬¦å·æ•°æ®ç»„æˆçš„ã€‚</p>
<p>å­—èŠ‚ç æ–‡ä»¶çš„æ ¼å¼å›ºå®šå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>type</th>
<th>descriptor</th>
</tr>
</thead>
<tbody>
<tr>
<td>u4</td>
<td>magic</td>
</tr>
<tr>
<td>u2</td>
<td>minor_version</td>
</tr>
<tr>
<td>u2</td>
<td>major_version</td>
</tr>
<tr>
<td>u2</td>
<td>constant_pool_count</td>
</tr>
<tr>
<td>cp_info</td>
<td>constant_pool[cosntant_pool_count â€“ 1]</td>
</tr>
<tr>
<td>u2</td>
<td>access_flags</td>
</tr>
<tr>
<td>u2</td>
<td>this_class</td>
</tr>
<tr>
<td>u2</td>
<td>super_class</td>
</tr>
<tr>
<td>u2</td>
<td>interfaces_count</td>
</tr>
<tr>
<td>u2</td>
<td>interfaces[interfaces_count]</td>
</tr>
<tr>
<td>u2</td>
<td>fields_count</td>
</tr>
<tr>
<td>field_info</td>
<td>fields[fields_count]</td>
</tr>
<tr>
<td>u2</td>
<td>methods_count</td>
</tr>
<tr>
<td>method_info</td>
<td>methods[methods_count]</td>
</tr>
<tr>
<td>u2</td>
<td>attributes_count</td>
</tr>
<tr>
<td>attribute_info</td>
<td>attributes[attributes_count]</td>
</tr>
</tbody>
</table>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±æŒ‰è¿™ä¸ªæ ¼å¼å¯¹ä¸Šè¿°HelloWorld.classæ–‡ä»¶è¿›è¡Œåˆ†æï¼š</p>
<p>magicï¼ˆu4ï¼‰ï¼šCA FE BA BE ï¼Œä»£è¡¨è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ï¼Œæˆ‘ä»¬å¹³æ—¶åŒºåˆ†æ–‡ä»¶ç±»å‹éƒ½æ˜¯é€šè¿‡åç¼€åæ¥åŒºåˆ†çš„ï¼Œä¸è¿‡åç¼€åæ˜¯å¯ä»¥éšä¾¿ä¿®æ”¹çš„ï¼Œæ‰€ä»¥ä»…é åç¼€åä¸èƒ½çœŸæ­£åŒºåˆ†ä¸€ä¸ªæ–‡ä»¶çš„ç±»å‹ã€‚åŒºåˆ†æ–‡ä»¶ç±»å‹çš„å¦ä¸ªåŠæ³•å°±æ˜¯magicæ•°å­—ï¼ŒJVM å°±æ˜¯é€šè¿‡ CA FE BA BE æ¥åˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯ä¸æ˜¯classæ–‡ä»¶ã€‚</p>
<p>minor_versionï¼ˆu2ï¼‰ï¼š00 00ï¼Œå°ç‰ˆæœ¬å·ï¼Œå› ä¸ºæˆ‘è¿™é‡Œé‡‡ç”¨çš„1.7ï¼Œæ‰€ä»¥å°ç‰ˆæœ¬å·ä¸º0.</p>
<p>major_versionï¼ˆu2ï¼‰ï¼š00 33ï¼Œå¤§ç‰ˆæœ¬å·ï¼Œx033è½¬æ¢ä¸ºåè¿›åˆ¶ä¸º51ï¼Œä¸‹è¡¨æ˜¯jdk 1.6 ä»¥åå¯¹åº”æ”¯æŒçš„ Class æ–‡ä»¶ç‰ˆæœ¬å·ï¼š</p>
<table>
<thead>
<tr>
<th>ç¼–è¯‘å™¨ç‰ˆæœ¬</th>
<th>-targetå‚æ•°</th>
<th>åå…­è¿›åˆ¶ç‰ˆæœ¬</th>
<th>åè¿›åˆ¶ç‰ˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>JDK 1.6.0_01</td>
<td>ä¸å¸¦ï¼ˆé»˜è®¤ -target 1.6ï¼‰</td>
<td>00 00 00 32</td>
<td>50.0</td>
</tr>
<tr>
<td>JDK 1.6.0_01</td>
<td>-target 1.5</td>
<td>00 00 00 31</td>
<td>49.0</td>
</tr>
<tr>
<td>JDK 1.6.0_01</td>
<td>-target 1.4 -source 1.4</td>
<td>00 00 00 30</td>
<td>48.0</td>
</tr>
<tr>
<td>JDK 1.7.0</td>
<td>ä¸å¸¦ï¼ˆé»˜è®¤ -target 1.7ï¼‰</td>
<td>00 00 00 33</td>
<td>51.0</td>
</tr>
<tr>
<td>JDK 1.7.0</td>
<td>-target 1.6</td>
<td>00 00 00 32</td>
<td>50.0</td>
</tr>
<tr>
<td>JDK 1.7.0</td>
<td>-target 1.4 -source 1.4</td>
<td>00 00 00 30</td>
<td>48.0</td>
</tr>
<tr>
<td>JDK 1.8.0</td>
<td>ä¸å¸¦ï¼ˆé»˜è®¤ -target 1.8ï¼‰</td>
<td>00 00 00 34</td>
<td>52.0</td>
</tr>
</tbody>
</table>
<p>constant_pool_countï¼ˆu2ï¼‰ï¼š00 22ï¼Œå¸¸é‡æ± æ•°é‡ï¼Œè½¬æ¢ä¸ºåè¿›åˆ¶åä¸º34ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­—èŠ‚ç çš„å¸¸é‡æ± æ˜¯ä»1å¼€å§‹è®¡æ•°çš„ï¼Œæ‰€ä»¥34è¡¨ç¤ºä¸ºï¼ˆ34-1ï¼‰=33é¡¹ã€‚</p>
<p>TAGï¼ˆu1ï¼‰ï¼š0Aï¼Œå¸¸é‡æ± çš„æ•°æ®ç±»å‹æ˜¯è¡¨ï¼Œæ¯ä¸€é¡¹çš„å¼€å§‹éƒ½æœ‰ä¸€ä¸ªtagï¼ˆu1ï¼‰ï¼Œè¡¨ç¤ºå¸¸é‡çš„ç±»å‹ï¼Œå¸¸é‡æ± çš„è¡¨çš„ç±»å‹åŒ…æ‹¬å¦‚ä¸‹14ç§ï¼Œè¿™é‡ŒAï¼ˆ10ï¼‰è¡¨ç¤ºCONSTANT_Methodrefï¼Œä»£è¡¨æ–¹æ³•å¼•ç”¨ã€‚</p>
<table>
<thead>
<tr>
<th>å¸¸é‡ç±»å‹</th>
<th>å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>CONSTANT_Utf8_info</td>
<td>1</td>
</tr>
<tr>
<td>CONSTANT_Integer_info</td>
<td>3</td>
</tr>
<tr>
<td>CONSTANT_Float_info</td>
<td>4</td>
</tr>
<tr>
<td>CONSTANT_Long_info</td>
<td>5</td>
</tr>
<tr>
<td>CONSTANT_Double_info</td>
<td>6</td>
</tr>
<tr>
<td>CONSTANT_Class_info</td>
<td>7</td>
</tr>
<tr>
<td>CONSTANT_String_info</td>
<td>8</td>
</tr>
<tr>
<td>CONSTANT_Fieldref_info</td>
<td>9</td>
</tr>
<tr>
<td>CONSTANT_Methodref_info</td>
<td>10</td>
</tr>
<tr>
<td>CONSTANT_InterfaceMethodref_info</td>
<td>11</td>
</tr>
<tr>
<td>CONSTANT_NameAndType_info</td>
<td>12</td>
</tr>
<tr>
<td>CONSTANT_MethodHandle_info</td>
<td>15</td>
</tr>
<tr>
<td>CONSTANT_MethodType_info</td>
<td>16</td>
</tr>
<tr>
<td>CONSTANT_InvokeDynamic_info</td>
<td>18</td>
</tr>
</tbody>
</table>
<p>æ¯ç§å¸¸é‡ç±»å‹å¯¹åº”è¡¨ç»“æ„ï¼š</p>
<table>
<thead>
<tr>
<th>å¸¸é‡</th>
<th style="text-align:right">é¡¹ç›®</th>
<th style="text-align:right">ç±»å‹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>CONSTANT_Utf8_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>1</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">length</td>
<td style="text-align:right">u2</td>
<td>å­—èŠ‚æ•°</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">bytes</td>
<td style="text-align:right">u1</td>
<td>utf-8ç¼–ç çš„å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>CONSTANT_Integer_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>3</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">bytes</td>
<td style="text-align:right">u4</td>
<td>intå€¼</td>
</tr>
<tr>
<td>CONSTANT_Float_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u4</td>
<td>4</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">bytes</td>
<td style="text-align:right">u1</td>
<td>floatå€¼</td>
</tr>
<tr>
<td>CONSTANT_Long_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>5</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">bytes</td>
<td style="text-align:right">u8</td>
<td>longå€¼</td>
</tr>
<tr>
<td>CONSTANT_Double_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>6</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">bytes</td>
<td style="text-align:right">u8</td>
<td>doubleå€¼</td>
</tr>
<tr>
<td>CONSTANT_Class_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>7</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘å…¨é™å®šåå¸¸é‡é¡¹çš„ç´¢å¼•</td>
</tr>
<tr>
<td>CONSTANT_String_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>8</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡çš„ç´¢å¼•</td>
</tr>
<tr>
<td>CONSTANT_Fieldref_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>9</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘å£°æ˜å­—æ®µçš„ç±»æˆ–æ¥å£æè¿°ç¬¦CONSTANT_Class_infoçš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘CONSTANT_NameAndType_infoçš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td>CONSTANT_Methodref_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>10</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘å£°æ˜æ–¹æ³•çš„ç±»æè¿°ç¬¦CONSTANT_Class_infoçš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘CONSTANT_NameAndType_infoçš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td>CONSTANT_InterfaceMethodref_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>11</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘å£°æ˜æ–¹æ³•çš„æ¥å£æè¿°ç¬¦CONSTANT_Class_infoçš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘CONSTANT_NameAndType_infoçš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td>CONSTANT_NameAndType_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>12</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘è¯¥å­—æ®µæˆ–æ–¹æ³•åç§°å¸¸é‡çš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">index</td>
<td style="text-align:right">u2</td>
<td>æŒ‡å‘è¯¥å­—æ®µæˆ–æ–¹æ³•æè¿°ç¬¦å¸¸é‡çš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td>CONSTANT_MethodHandle_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>15</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">reference_kind</td>
<td style="text-align:right">u1</td>
<td>å€¼å¿…é¡»1~9ï¼Œå®ƒå†³å®šäº†æ–¹æ³•å¥æŸ„çš„çš„ç±»å‹</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">reference_index</td>
<td style="text-align:right">u2</td>
<td>å¯¹å¸¸é‡æ± çš„ç´¢å¼•</td>
</tr>
<tr>
<td>CONSTANT_MethodType_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>16</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">description_index</td>
<td style="text-align:right">u2</td>
<td>å¯¹å¸¸é‡æ± ä¸­æ–¹æ³•æè¿°ç¬¦çš„ç´¢å¼•</td>
</tr>
<tr>
<td>CONSTANT_InvokeDynamic_info</td>
<td style="text-align:right">tag</td>
<td style="text-align:right">u1</td>
<td>18</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">bootstap_method_attr_index</td>
<td style="text-align:right">u2</td>
<td>å¯¹å¼•å¯¼æ–¹æ³•è¡¨çš„ç´¢å¼•</td>
</tr>
<tr>
<td></td>
<td style="text-align:right">name_and_type_index</td>
<td style="text-align:right">u2</td>
<td>å¯¹CONSTANT_NameAndType_infoçš„ç´¢å¼•</td>
</tr>
</tbody>
</table>
<p>CONSTANT_Methodref_infoï¼ˆu2):00 06ï¼Œå› ä¸ºtagä¸ºAï¼Œä»£è¡¨ä¸€ä¸ªæ–¹æ³•å¼•ç”¨è¡¨ï¼ˆCONSTANT_Methodref_infoï¼‰ï¼Œæ‰€ä»¥ç¬¬äºŒé¡¹ï¼ˆu2ï¼‰åº”è¯¥æ˜¯æŒ‡å‘å¸¸é‡æ± çš„ä½ç½®ï¼Œå³å¸¸é‡æ± çš„ç¬¬å…­é¡¹ï¼Œè¡¨ç¤ºä¸€ä¸ªCONSTANT_Class_infoè¡¨çš„ç´¢å¼•ï¼Œç”¨ç±»ä¼¼çš„æ–¹æ³•å¾€ä¸‹åˆ†æï¼Œå¯ä»¥å‘ç°å¸¸é‡æ± çš„ç¬¬å…­é¡¹å¦‚ä¸‹ï¼Œtagç±»å‹ä¸º07ï¼ŒæŸ¥è¯¢ä¸Šè¡¨å¯çŸ¥é“å…¶å³ä¸ºCONSTANT_Class_infoã€‚<br><a href="/images/bytecode-hello-world-2.jpg"><img src="/images/bytecode-hello-world-2.jpg" alt=""></a><br> 07ä¹‹åçš„00 1Bè¡¨ç¤ºå¯¹å¸¸é‡æ± åœ°27é¡¹ï¼ˆCONSTANT_Utf8_infoï¼‰çš„å¼•ç”¨ï¼ŒæŸ¥çœ‹ç¬¬27é¡¹å¦‚ä¸‹å›¾ï¼Œå³ï¼ˆjava/lang/Objectï¼‰ï¼š<br> <a href="/images/bytecode-hello-world-3.jpg"><img src="/images/bytecode-hello-world-3.jpg" alt=""></a><br> CONSTANT_NameAndType_infoï¼ˆu2ï¼‰ï¼š00 14,æ–¹æ³•å¼•ç”¨è¡¨çš„ç¬¬ä¸‰é¡¹ï¼ˆu2ï¼‰ï¼Œå¸¸é‡æ± ç´¢å¼•ï¼ŒæŒ‡å‘ç¬¬20é¡¹ã€‚</p>
<p>CONSTANT_Fieldref_infoï¼ˆu1ï¼‰ï¼štagä¸º09ã€‚</p>
<p>â€¦..</p>
<p>å¸¸é‡æ± çš„åˆ†æéƒ½ç±»ä¼¼ï¼Œå…¶ä»–çš„åˆ†æç”±äºç¯‡å¹…é—®é¢˜å°±ä¸åœ¨æ­¤ä¸€ä¸€è®²è¿°äº†ã€‚è·³è¿‡å¸¸é‡æ± å°±åˆ°äº†è®¿é—®æ ‡è¯†ï¼ˆu2ï¼‰ï¼š<br> <a href="/images/bytecode-hello-world-4.jpg"><img src="/images/bytecode-hello-world-4.jpg" alt=""></a><br>  JVM å¯¹è®¿é—®æ ‡ç¤ºç¬¦çš„è§„èŒƒå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>Flag Name</th>
<th>Value</th>
<th>Remarks</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>pubilc</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>final</td>
</tr>
<tr>
<td>ACC_SUPER</td>
<td>0x0020</td>
<td>ç”¨äºå…¼å®¹æ—©æœŸç¼–è¯‘å™¨ï¼Œæ–°ç¼–è¯‘å™¨éƒ½è®¾ç½®è¯¥æ ‡è®°ï¼Œä»¥åœ¨ä½¿ç”¨ invokespecialæŒ‡ä»¤æ—¶å¯¹å­ç±»æ–¹æ³•åšç‰¹å®šå¤„ç†ã€‚</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x0200</td>
<td>æ¥å£ï¼ŒåŒæ—¶éœ€è¦è®¾ç½®ï¼šACC_ABSTRACTã€‚ä¸å¯åŒæ—¶è®¾ç½®ï¼šACC_FINALã€ACC_SUPERã€ACC_ENUM</td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x0400</td>
<td>æŠ½è±¡ç±»ï¼Œæ— æ³•å®ä¾‹åŒ–ã€‚ä¸å¯ä¸ACC_FINALåŒæ—¶è®¾ç½®ã€‚</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>syntheticï¼Œç”±ç¼–è¯‘å™¨äº§ç”Ÿï¼Œä¸å­˜åœ¨äºæºä»£ç ä¸­ã€‚</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
<td>æ³¨è§£ç±»å‹ï¼ˆannotationï¼‰ï¼Œéœ€åŒæ—¶è®¾ç½®ï¼šACC_INTERFACEã€ACC_ABSTRACT</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>æšä¸¾ç±»å‹</td>
</tr>
</tbody>
</table>
<p> è¿™ä¸ªè¡¨é‡Œé¢æ— æ³•ç›´æ¥æŸ¥è¯¢åˆ°0021è¿™ä¸ªå€¼ï¼ŒåŸå› æ˜¯0021=0020+0001ï¼Œå³public+invokespecialæŒ‡ä»¤ï¼Œæºç ä¸­çš„æ–¹æ³•mainæ˜¯publicçš„ï¼Œè€Œinvokespecialæ˜¯ç°åœ¨çš„ç‰ˆæœ¬éƒ½æœ‰çš„ï¼Œæ‰€ä»¥å€¼ä¸º0021ã€‚</p>
<p>æ¥ç€å¾€ä¸‹æ˜¯this_classï¼ˆu2ï¼‰ï¼šæ˜¯æŒ‡å‘constant poolçš„ç´¢å¼•å€¼ï¼Œè¯¥å€¼å¿…é¡»æ˜¯CONSTANT_Class_infoç±»å‹ï¼Œå€¼ä¸º00 05ï¼Œå³æŒ‡å‘å¸¸é‡æ± ä¸­çš„ç¬¬äº”é¡¹ï¼Œç¬¬äº”é¡¹æŒ‡å‘å¸¸é‡æ± ä¸­çš„ç¬¬26é¡¹ï¼Œå³com/paddx/test/asm/HelloWorldï¼š<br> <a href="/images/bytecode-hello-world-5.jpg"><img src="/images/bytecode-hello-world-5.jpg" alt=""></a></p>
<p>super_class(u2)ï¼‰ï¼šsuper_classæ˜¯æŒ‡å‘constant poolçš„ç´¢å¼•å€¼ï¼Œè¯¥å€¼å¿…é¡»æ˜¯CONSTANT_Class_infoç±»å‹ï¼ŒæŒ‡å®šå½“å‰å­—èŠ‚ç å®šä¹‰çš„ç±»æˆ–æ¥å£çš„ç›´æ¥çˆ¶ç±»ã€‚è¿™é‡Œçš„å–å€¼ä¸º00 06ï¼Œæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œå¯¹åº”çš„æŒ‡å‘çš„å…¨é™å®šæ€§ç±»åä¸ºjava/lang/objectï¼Œå³å½“å‰ç±»çš„çˆ¶ç±»ä¸ºObjectç±»ã€‚</p>
<p>interfaces_countï¼ˆu2ï¼‰ï¼šæ¥å£çš„æ•°é‡ï¼Œå› ä¸ºè¿™é‡Œæ²¡æœ‰å®ç°æ¥å£ï¼Œæ‰€ä»¥å€¼ä¸º 00 00ã€‚</p>
<p>interfaces[interfaces_count]ï¼šå› ä¸ºæ²¡æœ‰æ¥å£ï¼Œæ‰€ä»¥å°±ä¸å­˜åœ¨interfcesé€‰é¡¹ã€‚</p>
<p>field_countï¼šå±æ€§æ•°é‡ï¼Œ00 00ã€‚</p>
<p>field_infoï¼šå› ä¸ºæ²¡æœ‰å±æ€§ï¼Œæ‰€ä»¥ä¸å­˜åœ¨è¿™ä¸ªé€‰é¡¹ã€‚</p>
<p>method_countï¼š00 02ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ªæ–¹æ³•å‘¢ï¼Ÿæˆ‘ä»¬æ˜æ˜åªå†™äº†ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºJVM ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª <init>çš„æ–¹æ³•ã€‚</init></p>
<p>method_infoï¼šæ–¹æ³•è¡¨ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Descriptor</th>
</tr>
</thead>
<tbody>
<tr>
<td>u2</td>
<td>access_flag</td>
</tr>
<tr>
<td>u2</td>
<td>name_index</td>
</tr>
<tr>
<td>u2</td>
<td>descriptor_index</td>
</tr>
<tr>
<td>u2</td>
<td>attributes_count</td>
</tr>
<tr>
<td>attribute_info</td>
<td>attribute_info[attributes_count]</td>
</tr>
</tbody>
</table>
<p>HelloWorld.classæ–‡ä»¶ä¸­å¯¹åº”çš„æ•°æ®ï¼š<br> <a href="/images/bytecode-hello-world-6.jpg"><img src="/images/bytecode-hello-world-6.jpg" alt=""></a></p>
<p> access_flagï¼ˆu2ï¼‰: 00 01</p>
<p>name_indexï¼ˆu2ï¼‰:00 07</p>
<p>descriptor_indexï¼ˆu2ï¼‰:00 08</p>
<p>å¯ä»¥çœ‹çœ‹ 07ã€08å¯¹åº”çš„å¸¸é‡æ± é‡Œé¢çš„å€¼ï¼š<br> <a href="/images/bytecode-hello-world-7.jpg"><img src="/images/bytecode-hello-world-7.jpg" alt=""></a></p>
<p>å³ 07 å¯¹åº”çš„æ˜¯ &#60;init&#62;ï¼Œ08 å¯¹åº”çš„æ˜¯()ï¼›</p>
<p>attributes_count:00 01ï¼Œè¡¨ç¤ºåŒ…å«ä¸€ä¸ªå±æ€§</p>
<p>attribute_infoï¼šå±æ€§è¡¨ï¼Œè¯¥è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Descriptor</th>
</tr>
</thead>
<tbody>
<tr>
<td>u2</td>
<td>attribute_name_index</td>
</tr>
<tr>
<td>u4</td>
<td>attribute_length</td>
</tr>
<tr>
<td>u1</td>
<td>bytes</td>
</tr>
</tbody>
</table>
<p> <a href="/images/bytecode-hello-world-8.jpg"><img src="/images/bytecode-hello-world-8.jpg" alt=""></a></p>
<p>attribute_name_indexï¼ˆu2ï¼‰: 00 09ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­çš„ç´¢å¼•ã€‚</p>
<p>attribute_lengthï¼ˆu4ï¼‰ï¼š00 00 00 2Fï¼Œå±æ€§çš„é•¿åº¦47ã€‚</p>
<p>attribute_info:å…·ä½“å±æ€§çš„åˆ†æä¸ä¸Šé¢ç±»ä¼¼ï¼Œå¤§å®¶å¯ä»¥å¯¹ç€JVMçš„è§„èŒƒè‡ªå·±å°è¯•åˆ†æä¸€ä¸‹ã€‚</p>
<p>ç¬¬ä¸€ä¸ªæ–¹æ³•ç»“æŸåï¼Œæ¥ç€è¿›å…¥ç¬¬äºŒä¸ªæ–¹æ³•ï¼š<br> <a href="/images/bytecode-hello-world-9.jpg"><img src="/images/bytecode-hello-world-9.jpg" alt=""></a><br> ç¬¬äºŒä¸ªæ–¹æ³•çš„å±æ€§é•¿åº¦ä¸ºx037ï¼Œè½¬æ¢ä¸ºåè¿›åˆ¶ä¸º55ä¸ªå­—èŠ‚ã€‚ä¸¤ä¸ªæ–¹æ³•ä¹‹åç´§è·Ÿç€çš„æ˜¯attribute_countå’Œattributesï¼š<br>  <a href="/images/bytecode-hello-world-10.jpg"><img src="/images/bytecode-hello-world-10.jpg" alt=""></a><br>attribute_countï¼ˆu2ï¼‰:å€¼ä¸º 00 01ï¼Œå³æœ‰ä¸€ä¸ªå±æ€§ã€‚</p>
<p>attribute_name_indexï¼ˆu2ï¼‰ï¼šæŒ‡å‘å¸¸é‡æ± ä¸­çš„ç¬¬åäºŒé¡¹ã€‚</p>
<p>attribute_lengthï¼ˆu4ï¼‰ï¼š00 00 00 02ï¼Œé•¿åº¦ä¸º2ã€‚</p>
<p>åˆ†æå®Œæ¯•ï¼</p>
<h1 id="åŸºäºå­—èŠ‚ç çš„æ“ä½œ"><a href="#åŸºäºå­—èŠ‚ç çš„æ“ä½œ" class="headerlink" title="åŸºäºå­—èŠ‚ç çš„æ“ä½œ"></a>åŸºäºå­—èŠ‚ç çš„æ“ä½œ</h1><p>ã€€ã€€é€šè¿‡å¯¹HelloWorldè¿™ä¸ªç¨‹åºçš„å­—èŠ‚ç åˆ†æï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿæ¯”è¾ƒæ¸…æ¥šçš„è®¤è¯†åˆ°æ•´ä¸ªå­—èŠ‚ç çš„ç»“æ„ã€‚é‚£æˆ‘ä»¬é€šè¿‡å­—èŠ‚ç ï¼Œå¯ä»¥åšäº›ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®é€šè¿‡å­—èŠ‚ç èƒ½åšå¾ˆå¤šå¹³æ—¶æˆ‘ä»¬æ— æ³•å®Œæˆçš„å·¥ä½œã€‚æ¯”å¦‚ï¼Œåœ¨ç±»åŠ è½½ä¹‹å‰æ·»åŠ æŸäº›æ“ä½œæˆ–è€…ç›´æ¥åŠ¨æ€çš„ç”Ÿæˆå­—èŠ‚ç ï¼ŒCGlibå°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å®ç°åŠ¨æ€ä»£ç†çš„ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥å®Œæˆå¦ä¸€ä¸ªç‰ˆæœ¬çš„HelloWorldï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.asm;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</div><div class="line"> </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æœ‰ä¸ªç©ºçš„æ–¹æ³• sayHello()ï¼Œç°åœ¨è¦å®ç°è°ƒè¯¥æ–¹æ³•çš„æ—¶å€™æ‰“å°å‡ºâ€œHelloWorldâ€ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿå¦‚æœæˆ‘ä»¬æ‰‹åŠ¨å»ä¿®æ”¹å­—èŠ‚ç æ–‡ä»¶ï¼Œå°†æ‰“å°â€œHelloWorldâ€çš„ä»£ç æ’å…¥åˆ°sayHelloæ–¹æ³•ä¸­ï¼ŒåŸç†ä¸Šè‚¯å®šæ²¡é—®é¢˜ï¼Œä¸è¿‡æ“ä½œè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚Java çš„æœ€å¤§ä¼˜åŠ¿å°±åœ¨äºåªè¦ä½ èƒ½æƒ³åˆ°çš„åŠŸèƒ½ï¼ŒåŸºæœ¬ä¸Šå°±æœ‰ç¬¬ä¸‰æ–¹å¼€æºçš„åº“å®ç°è¿‡ã€‚å­—èŠ‚ç æ“ä½œçš„å¼€æºåº“ä¹Ÿæ¯”è¾ƒå¤šï¼Œè¿™é‡Œæˆ‘å°±ç”¨ ASM 4.0æ¥å®ç°è¯¥åŠŸèƒ½ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.paddx.test.asm;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> org.objectweb.asm.*;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsmDemo</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, IllegalAccessException, InstantiationException, InvocationTargetException </span>&#123;</div><div class="line">        ClassReader classReader = <span class="keyword">new</span> ClassReader(<span class="string">"com.paddx.test.asm.HelloWorld2"</span>);</div><div class="line">        ClassWriter cw=<span class="keyword">new</span> ClassWriter(ClassWriter.COMPUTE_MAXS);</div><div class="line">        CustomVisitor myv=<span class="keyword">new</span> CustomVisitor(Opcodes.ASM4,cw);</div><div class="line">        classReader.accept(myv, <span class="number">0</span>);</div><div class="line"> </div><div class="line">        <span class="keyword">byte</span>[] code=cw.toByteArray();</div><div class="line"> </div><div class="line">        AsmDemo loader=<span class="keyword">new</span> AsmDemo();</div><div class="line">        Class&lt;?&gt; appClass=loader.defineClass(<span class="keyword">null</span>, code, <span class="number">0</span>,code.length);</div><div class="line">        appClass.getMethods()[<span class="number">0</span>].invoke(appClass.newInstance(), <span class="keyword">new</span> Object[]&#123;&#125;);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomVisitor</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> <span class="keyword">implements</span> <span class="title">Opcodes</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomVisitor</span><span class="params">(<span class="keyword">int</span> api, ClassVisitor cv)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(api, cv);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String desc, String signature, String[] exceptions)</span> </span>&#123;</div><div class="line">        MethodVisitor mv = <span class="keyword">super</span>.visitMethod(access, name, desc, signature, exceptions);</div><div class="line">        <span class="keyword">if</span> (name.equals(<span class="string">"sayHello"</span>)) &#123;</div><div class="line">            mv.visitFieldInsn(GETSTATIC, <span class="string">"java/lang/System"</span>, <span class="string">"out"</span>, <span class="string">"Ljava/io/PrintStream;"</span>);</div><div class="line">            mv.visitLdcInsn(<span class="string">"HelloWorld!"</span>);</div><div class="line">            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">"java/io/PrintStream"</span>, <span class="string">"println"</span>, <span class="string">"(Ljava/lang/String;)V"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mv;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br>  <a href="/images/bytecode-hello-world-11.jpg"><img src="/images/bytecode-hello-world-11.jpg" alt=""></a></p>
<p>å…³äº ASM 4çš„æ“ä½œåœ¨è¿™å°±ä¸ç»†è¯´äº†ã€‚æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸€ä¸‹ï¼Œæœ‰æœºä¼šï¼Œæˆ‘ä¹Ÿå¯ä»¥å†åç»­çš„åšæ–‡ä¸­è·Ÿå¤§å®¶åˆ†äº«ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ã€€ã€€æœ¬æ–‡é€šè¿‡HelloWorldè¿™æ ·ä¸€ä¸ªå¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰çš„ä¾‹å­ï¼Œæ·±å…¥çš„åˆ†æäº†å­—èŠ‚ç æ–‡ä»¶çš„ç»“æ„ã€‚åˆ©ç”¨è¿™äº›ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å®Œæˆä¸€äº›ç›¸å¯¹é«˜çº§çš„åŠŸèƒ½ï¼Œå¦‚åŠ¨æ€ä»£ç†ç­‰ã€‚è¿™äº›ä¾‹å­è™½ç„¶éƒ½å¾ˆç®€å•ï¼Œä½†æ˜¯â€œéº»é›€è™½å°äº”è„ä¿±å…¨â€ï¼Œå³ä½¿å†å¤æ‚çš„ç¨‹åºä¹Ÿé€ƒç¦»ä¸äº†è¿™äº›æœ€åŸºæœ¬çš„ä¸œè¥¿ã€‚æŠ€æœ¯å±‚é¢çš„ä¸œè¥¿å°±æ˜¯è¿™æ ·å­ï¼Œåªè¦ä½ èƒ½äº†è§£ä¸€ä¸ªç®€å•çš„ç¨‹åºçš„åŸç†ï¼Œä¸¾ä¸€åä¸‰ï¼Œå°±èƒ½å¾ˆå®¹æ˜“çš„ç†è§£æ›´å¤æ‚çš„ç¨‹åºï¼Œè¿™å°±æ˜¯æŠ€æœ¯â€œæ˜“â€çš„æ–¹é¢ã€‚åŒæ—¶ï¼Œåè¿‡æ¥è¯´ï¼Œå³ä½¿â€œHelloWorldâ€è¿™æ ·ä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œå¦‚æœæˆ‘ä»¬æ·±å…¥æ¢ç©¶ï¼Œä¹Ÿä¸ä¸€å®šèƒ½ç‰¹åˆ«ç†è§£å…¶åŸç†ï¼Œè¿™å°±æ˜¯æŠ€æœ¯â€œéš¾â€çš„æ–¹é¢ã€‚æ€»ä¹‹ï¼ŒæŠ€æœ¯è¿™ç§ä¸œè¥¿åªè¦ä½ ç”¨å¿ƒæ·±å…¥åœ°å»ç ”ç©¶ï¼Œæ€»æ˜¯èƒ½å¸¦ç»™ä½ æ„æƒ³ä¸åˆ°çš„æƒŠå–œ~</p>
<p>åŸæ–‡åœ°å€ <a href="http://www.cnblogs.com/paddix/p/5282004.html" target="_blank" rel="external">http://www.cnblogs.com/paddix/p/5282004.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;HelloWorld-å­—èŠ‚ç ç”Ÿæˆ&quot;&gt;&lt;a href=&quot;#HelloWorld-å­—èŠ‚ç ç”Ÿæˆ&quot; class=&quot;headerlink&quot; title=&quot;HelloWorld å­—èŠ‚ç ç”Ÿæˆ&quot;&gt;&lt;/a&gt;HelloWorld å­—èŠ‚ç ç”Ÿæˆ&lt;/h1&gt;&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼ŒJava ç¨‹åºæ˜¯åœ¨ JVM ä¸Šè¿è¡Œçš„ï¼Œä¸è¿‡ JVM è¿è¡Œçš„å…¶å®ä¸æ˜¯ Java è¯­è¨€æœ¬èº«ï¼Œè€Œæ˜¯ Java ç¨‹åºç¼–è¯‘æˆçš„å­—èŠ‚ç æ–‡ä»¶ã€‚å¯èƒ½ä¸€å¼€å§‹ JVM æ˜¯ä¸º Java è¯­è¨€æœåŠ¡çš„ï¼Œä¸è¿‡éšç€ç¼–è¯‘æŠ€æœ¯å’Œ JVM è‡ªèº«çš„ä¸æ–­å‘å±•å’Œæˆç†Ÿï¼ŒJVM å·²ç»ä¸ä»…ä»…åªè¿è¡Œ Java ç¨‹åºã€‚ä»»ä½•èƒ½ç¼–è¯‘æˆä¸ºç¬¦åˆ JVM å­—èŠ‚ç è§„èŒƒçš„è¯­è¨€éƒ½å¯ä»¥åœ¨ JVM ä¸Šè¿è¡Œï¼Œæ¯”è¾ƒå¸¸è§çš„ Scalaã€Grooveã€JRubyç­‰ã€‚ä»Šå¤©ï¼Œæˆ‘å°±ä»å¤§å®¶æœ€ç†Ÿæ‚‰çš„ç¨‹åºâ€œHelloWorldâ€ç¨‹åºå…¥æ‰‹ï¼Œåˆ†ææ•´ä¸ª Class æ–‡ä»¶çš„ç»“æ„ã€‚è™½ç„¶è¿™ä¸ªç¨‹åºæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åŸºæœ¬ä¸ŠåŒ…å«äº†å­—èŠ‚ç è§„èŒƒä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œå› æ­¤å³ä½¿ä»¥åè¦åˆ†ææ›´å¤æ‚çš„ç¨‹åºï¼Œé‚£ä¹Ÿåªæ˜¯â€œé‡â€ä¸Šçš„å˜åŒ–ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://idiotsky.me/categories/java/"/>
    
    
      <category term="java" scheme="http://idiotsky.me/tags/java/"/>
    
      <category term="jvm" scheme="http://idiotsky.me/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>redis clusterç®¡ç†å·¥å…·redis-trib.rbè¯¦è§£</title>
    <link href="http://idiotsky.me/2016/04/22/redis-trib/"/>
    <id>http://idiotsky.me/2016/04/22/redis-trib/</id>
    <published>2016-04-22T15:40:47.000Z</published>
    <updated>2017-07-22T16:05:20.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>redis-trib.rbæ˜¯rediså®˜æ–¹æ¨å‡ºçš„ç®¡ç†redisé›†ç¾¤çš„å·¥å…·ï¼Œé›†æˆåœ¨redisçš„æºç srcç›®å½•ä¸‹ï¼Œæ˜¯åŸºäºredisæä¾›çš„é›†ç¾¤å‘½ä»¤å°è£…æˆç®€å•ã€ä¾¿æ·ã€å®ç”¨çš„æ“ä½œå·¥å…·ã€‚redis-trib.rbæ˜¯redisä½œè€…ç”¨rubyå®Œæˆçš„ã€‚ä¸ºäº†çœ‹æ‡‚redis-trib.rbï¼Œæˆ‘ç‰¹æ„èŠ±äº†ä¸€ä¸ªæ˜ŸæœŸå­¦ä¹ äº†rubyï¼Œä¹Ÿè¢«rubyçš„ç®€æ´ã€æ˜äº†æ‰€å¸å¼•ã€‚rubyæ˜¯é—¨éå¸¸çµæ´»çš„è¯­è¨€ï¼Œredis-trib.rbåªç”¨äº†1600è¡Œå·¦å³çš„ä»£ç ï¼Œå°±å®ç°äº†å¼ºå¤§çš„é›†ç¾¤æ“ä½œã€‚æœ¬æ–‡å¯¹redis-trib.rbçš„ä»‹ç»æ˜¯åŸºäºredis 3.0.6ç‰ˆæœ¬çš„æºç ã€‚é˜…è¯»æœ¬æ–‡éœ€è¦å¯¹redisé›†ç¾¤åŠŸèƒ½æœ‰ä¸€å®šçš„äº†è§£ã€‚å…³äºredisé›†ç¾¤åŠŸèƒ½çš„ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒæœ¬äººçš„å¦ä¸€ç¯‡æ–‡ç« ã€Šredis3.0 clusteråŠŸèƒ½ä»‹ç»ã€‹ã€‚</p>
</blockquote>
<a id="more"></a>
<h1 id="help-ä¿¡æ¯"><a href="#help-ä¿¡æ¯" class="headerlink" title="help ä¿¡æ¯"></a>help ä¿¡æ¯</h1><p>å…ˆä»redis-trib.rbçš„helpä¿¡æ¯ï¼Œçœ‹ä¸‹redis-trib.rbæä¾›äº†å“ªäº›åŠŸèƒ½ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb <span class="built_in">help</span></div><div class="line">Usage: redis-trib &lt;<span class="built_in">command</span>&gt; &lt;options&gt; &lt;arguments ...&gt;</div><div class="line"></div><div class="line">  create          host1:port1 ... hostN:portN</div><div class="line">                  --replicas &lt;arg&gt;</div><div class="line">  check           host:port</div><div class="line">  info            host:port</div><div class="line">  fix             host:port</div><div class="line">                  --timeout &lt;arg&gt;</div><div class="line">  reshard         host:port</div><div class="line">                  --from &lt;arg&gt;</div><div class="line">                  --to &lt;arg&gt;</div><div class="line">                  --slots &lt;arg&gt;</div><div class="line">                  --yes</div><div class="line">                  --timeout &lt;arg&gt;</div><div class="line">                  --pipeline &lt;arg&gt;</div><div class="line">  rebalance       host:port</div><div class="line">                  --weight &lt;arg&gt;</div><div class="line">                  --auto-weights</div><div class="line">                  --threshold &lt;arg&gt;</div><div class="line">                  --use-empty-masters</div><div class="line">                  --timeout &lt;arg&gt;</div><div class="line">                  --simulate</div><div class="line">                  --pipeline &lt;arg&gt;</div><div class="line">  add-node        new_host:new_port existing_host:existing_port</div><div class="line">                  --slave</div><div class="line">                  --master-id &lt;arg&gt;</div><div class="line">  del-node        host:port node_id</div><div class="line">  <span class="built_in">set</span>-timeout     host:port milliseconds</div><div class="line">  call            host:port <span class="built_in">command</span> arg arg .. arg</div><div class="line">  import          host:port</div><div class="line">                  --from &lt;arg&gt;</div><div class="line">                  --copy</div><div class="line">                  --replace</div><div class="line">  <span class="built_in">help</span>            (show this <span class="built_in">help</span>)</div><div class="line"></div><div class="line">For check, fix, reshard, del-node, <span class="built_in">set</span>-timeout you can specify the host and port of any working node <span class="keyword">in</span> the cluster.</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°redis-trib.rbå…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š<br>1ã€createï¼šåˆ›å»ºé›†ç¾¤<br>2ã€checkï¼šæ£€æŸ¥é›†ç¾¤<br>3ã€infoï¼šæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯<br>4ã€fixï¼šä¿®å¤é›†ç¾¤<br>5ã€reshardï¼šåœ¨çº¿è¿ç§»slot<br>6ã€rebalanceï¼šå¹³è¡¡é›†ç¾¤èŠ‚ç‚¹slotæ•°é‡<br>7ã€add-nodeï¼šå°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤<br>8ã€del-nodeï¼šä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹<br>9ã€set-timeoutï¼šè®¾ç½®é›†ç¾¤èŠ‚ç‚¹é—´å¿ƒè·³è¿æ¥çš„è¶…æ—¶æ—¶é—´<br>10ã€callï¼šåœ¨é›†ç¾¤å…¨éƒ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤<br>11ã€importï¼šå°†å¤–éƒ¨redisæ•°æ®å¯¼å…¥é›†ç¾¤<br>ä¸‹é¢ä»redis-trib.rbä½¿ç”¨å’Œæºç çš„è§’åº¦è¯¦ç»†ä»‹ç»redis-trib.rbçš„æ¯ä¸ªåŠŸèƒ½ã€‚</p>
<p>redis-trib.rbä¸»è¦æœ‰ä¸¤ä¸ªç±»ï¼šClusterNodeå’ŒRedisTribã€‚ClusterNodeä¿å­˜äº†æ¯ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ŒRedisTribåˆ™æ˜¯redis-trib.rbå„ä¸ªåŠŸèƒ½çš„å®ç°ã€‚</p>
<h1 id="ClusterNodeå¯¹è±¡"><a href="#ClusterNodeå¯¹è±¡" class="headerlink" title="ClusterNodeå¯¹è±¡"></a>ClusterNodeå¯¹è±¡</h1><p>å…ˆåˆ†æClusterNodeæºç ã€‚ClusterNodeæœ‰ä¸‹é¢å‡ ä¸ªæˆå‘˜å˜é‡ï¼ˆrubyçš„ç±»æˆå‘˜å˜é‡æ˜¯ä»¥@å¼€å¤´çš„ï¼‰ï¼š<br>@rï¼šæ‰§è¡Œrediså‘½ä»¤çš„å®¢æˆ·ç«¯å¯¹è±¡ã€‚<br>@infoï¼šä¿å­˜äº†è¯¥èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬cluster nodeså‘½ä»¤ä¸­è‡ªå·±è¿™è¡Œçš„ä¿¡æ¯å’Œcluster infoçš„ä¿¡æ¯ã€‚<br>@dirtyï¼šèŠ‚ç‚¹ä¿¡æ¯æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¦‚æœä¸ºtrueï¼Œæˆ‘ä»¬éœ€è¦æŠŠå†…å­˜çš„èŠ‚ç‚¹æ›´æ–°ä¿¡æ¯åˆ°èŠ‚ç‚¹ä¸Šã€‚<br>@friendsï¼šä¿å­˜äº†é›†ç¾¤å…¶ä»–èŠ‚ç‚¹çš„infoä¿¡æ¯ã€‚å…¶ä¿¡æ¯ä¸ºé€šè¿‡cluster nodeså‘½ä»¤è·å¾—çš„å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯ã€‚<br>ClusterNodeæœ‰ä¸‹é¢ä¸€äº›æˆå‘˜æ–¹æ³•ï¼š<br>initializeï¼šClusterNodeçš„æ„é€ æ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥èŠ‚ç‚¹çš„åœ°å€ä¿¡æ¯ã€‚<br>friendsï¼šè¿”å›@friendså¯¹è±¡ã€‚<br>slotsï¼šè¿”å›è¯¥èŠ‚ç‚¹è´Ÿè´£çš„slotsä¿¡æ¯ã€‚<br>has_flag?ï¼šåˆ¤æ–­èŠ‚ç‚¹infoä¿¡æ¯çš„çš„flagsä¸­æ˜¯å¦æœ‰ç»™å®šçš„flagã€‚<br>to_sï¼šç±»ä¼¼javaçš„toStringæ–¹æ³•ï¼Œè¿”å›èŠ‚ç‚¹çš„åœ°å€ä¿¡æ¯ã€‚<br>connectï¼šè¿æ¥redisèŠ‚ç‚¹ã€‚<br>assert_clusterï¼šåˆ¤æ–­èŠ‚ç‚¹å¼€å¯äº†é›†ç¾¤é…ç½®ã€‚<br>assert_emptyï¼šç¡®å®šèŠ‚ç‚¹ç›®å‰æ²¡æœ‰è·Ÿä»»ä½•å…¶ä»–èŠ‚ç‚¹æ¡æ‰‹ï¼ŒåŒæ—¶è‡ªå·±çš„dbæ•°æ®ä¸ºç©ºã€‚<br>load_infoï¼šé€šè¿‡cluster infoå’Œcluster nodeså¯¼å…¥èŠ‚ç‚¹ä¿¡æ¯ã€‚<br>add_slotsï¼šç»™èŠ‚ç‚¹å¢åŠ slotï¼Œè¯¥æ“ä½œåªæ˜¯åœ¨å†…å­˜ä¸­ä¿®æ”¹ï¼Œå¹¶æŠŠdirtyè®¾ç½®æˆtrueï¼Œç­‰å¾…flush_node_configå°†å†…å­˜ä¸­çš„æ•°æ®åŒæ­¥åœ¨èŠ‚ç‚¹æ‰§è¡Œã€‚<br>set_as_replicaï¼šslaveè®¾ç½®å¤åˆ¶çš„masteråœ°å€ã€‚dirtyè®¾ç½®æˆtrueã€‚<br>flush_node_configï¼šå°†å†…å­˜çš„æ•°æ®ä¿®æ”¹åŒæ­¥åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­æ‰§è¡Œã€‚<br>info_stringï¼šç®€å•çš„infoä¿¡æ¯ã€‚<br>get_config_signatureï¼šç”¨æ¥éªŒè¯é›†ç¾¤èŠ‚ç‚¹è§çš„cluster nodesä¿¡æ¯æ˜¯å¦ä¸€è‡´ã€‚è¯¥æ–¹æ³•è¿”å›èŠ‚ç‚¹çš„ç­¾åä¿¡æ¯ã€‚<br>infoï¼šè¿”å›@infoå¯¹è±¡ï¼ŒåŒ…å«è¯¦ç»†çš„infoä¿¡æ¯ã€‚<br>is_dirty?ï¼šåˆ¤æ–­@dirtyã€‚<br>rï¼šè¿”å›æ‰§è¡Œrediså‘½ä»¤çš„å®¢æˆ·ç«¯å¯¹è±¡ã€‚</p>
<p>æœ‰äº†ClusterNodeå¯¹è±¡ï¼Œåœ¨å¤„ç†é›†ç¾¤æ“ä½œçš„æ—¶å€™ï¼Œå°±è·å¾—äº†é›†ç¾¤çš„ä¿¡æ¯ï¼Œå¯ä»¥è¿›è¡Œé›†ç¾¤ç›¸å…³æ“ä½œã€‚åœ¨æ­¤å…ˆç®€å•ä»‹ç»ä¸‹redis-trib.rbè„šæœ¬çš„ä½¿ç”¨ï¼Œä»¥createä¸ºä¾‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">create host1:port1 ... hostN:portN</div><div class="line">       --replicas &lt;arg&gt;</div></pre></td></tr></table></figure></p>
<p>host1:port1 â€¦ hostN:portNè¡¨ç¤ºå­å‚æ•°ï¼Œè¿™ä¸ªå¿…é¡»åœ¨å¯é€‰å‚æ•°ä¹‹åï¼Œâ€“replicas <arg>æ˜¯å¯é€‰å‚æ•°ï¼Œå¸¦çš„è¡¨ç¤ºåé¢å¿…é¡»å¡«å†™ä¸€ä¸ªå‚æ•°ï¼Œåƒâ€“slaveè¿™æ ·ï¼Œåé¢å°±ä¸å¸¦å‚æ•°ï¼ŒæŒæ¡äº†è¿™ä¸ªåŸºæœ¬è§„åˆ™ï¼Œå°±èƒ½ä»helpå‘½ä»¤ä¸­è·å¾—redis-trib.rbçš„ä½¿ç”¨æ–¹æ³•ã€‚</arg></p>
<p>å…¶ä»–å‘½ä»¤å¤§éƒ½éœ€è¦ä¼ é€’host:portï¼Œè¿™æ˜¯redis-trib.rbä¸ºäº†è¿æ¥é›†ç¾¤ï¼Œéœ€è¦é€‰æ‹©é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åé€šè¿‡è¯¥èŠ‚ç‚¹è·å¾—æ•´ä¸ªé›†ç¾¤çš„ä¿¡æ¯ã€‚</p>
<p>ä¸‹é¢å°±ä¸€ä¸€è¯¦ç»†ä»‹ç»redis-trib.rbçš„æ¯ä¸ªåŠŸèƒ½ã€‚</p>
<h1 id="createåˆ›å»ºé›†ç¾¤"><a href="#createåˆ›å»ºé›†ç¾¤" class="headerlink" title="createåˆ›å»ºé›†ç¾¤"></a>createåˆ›å»ºé›†ç¾¤</h1><p>createå‘½ä»¤å¯é€‰replicaså‚æ•°ï¼Œreplicasè¡¨ç¤ºéœ€è¦æœ‰å‡ ä¸ªslaveã€‚æœ€ç®€å•å‘½ä»¤ä½¿ç”¨å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb create 10.180.157.199:6379 10.180.157.200:6379 10.180.157.201:6379</div></pre></td></tr></table></figure></p>
<p>æœ‰ä¸€ä¸ªslaveçš„åˆ›å»ºå‘½ä»¤å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb create --replicas 1 10.180.157.199:6379 10.180.157.200:6379 10.180.157.201:6379 10.180.157.202:6379  10.180.157.205:6379  10.180.157.208:6379</div></pre></td></tr></table></figure></p>
<p>åˆ›å»ºæµç¨‹å¦‚ä¸‹ï¼š<br>1ã€é¦–å…ˆä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºClusterNodeå¯¹è±¡ï¼ŒåŒ…æ‹¬è¿æ¥æ¯ä¸ªèŠ‚ç‚¹ã€‚æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºç‹¬ç«‹ä¸”dbä¸ºç©ºçš„èŠ‚ç‚¹ã€‚æ‰§è¡Œload_infoæ–¹æ³•å¯¼å…¥èŠ‚ç‚¹ä¿¡æ¯ã€‚<br>2ã€æ£€æŸ¥ä¼ å…¥çš„masterèŠ‚ç‚¹æ•°é‡æ˜¯å¦å¤§äºç­‰äº3ä¸ªã€‚åªæœ‰å¤§äº3ä¸ªèŠ‚ç‚¹æ‰èƒ½ç»„æˆé›†ç¾¤ã€‚<br>3ã€è®¡ç®—æ¯ä¸ªmasteréœ€è¦åˆ†é…çš„slotæ•°é‡ï¼Œä»¥åŠç»™masteråˆ†é…slaveã€‚åˆ†é…çš„ç®—æ³•å¤§è‡´å¦‚ä¸‹ï¼š<br>å…ˆæŠŠèŠ‚ç‚¹æŒ‰ç…§hoståˆ†ç±»ï¼Œè¿™æ ·ä¿è¯masterèŠ‚ç‚¹èƒ½åˆ†é…åˆ°æ›´å¤šçš„ä¸»æœºä¸­ã€‚<br>ä¸åœéå†éå†hoståˆ—è¡¨ï¼Œä»æ¯ä¸ªhoståˆ—è¡¨ä¸­å¼¹å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ”¾å…¥interleavedæ•°ç»„ã€‚ç›´åˆ°æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å¼¹å‡ºä¸ºæ­¢ã€‚<br>masterèŠ‚ç‚¹åˆ—è¡¨å°±æ˜¯interleavedå‰é¢çš„masteræ•°é‡çš„èŠ‚ç‚¹åˆ—è¡¨ã€‚ä¿å­˜åœ¨mastersæ•°ç»„ã€‚<br>è®¡ç®—æ¯ä¸ªmasterèŠ‚ç‚¹è´Ÿè´£çš„slotæ•°é‡ï¼Œä¿å­˜åœ¨slots_per_nodeå¯¹è±¡ï¼Œç”¨slotæ€»æ•°é™¤ä»¥masteræ•°é‡å–æ•´å³å¯ã€‚<br>éå†mastersæ•°ç»„ï¼Œæ¯ä¸ªmasteråˆ†é…slots_per_nodeä¸ªslotï¼Œæœ€åä¸€ä¸ªmasterï¼Œåˆ†é…åˆ°16384ä¸ªslotä¸ºæ­¢ã€‚<br>æ¥ä¸‹æ¥ä¸ºmasteråˆ†é…slaveï¼Œåˆ†é…ç®—æ³•ä¼šå°½é‡ä¿è¯masterå’ŒslaveèŠ‚ç‚¹ä¸åœ¨åŒä¸€å°ä¸»æœºä¸Šã€‚å¯¹äºåˆ†é…å®ŒæŒ‡å®šslaveæ•°é‡çš„èŠ‚ç‚¹ï¼Œè¿˜æœ‰å¤šä½™çš„èŠ‚ç‚¹ï¼Œä¹Ÿä¼šä¸ºè¿™äº›èŠ‚ç‚¹å¯»æ‰¾masterã€‚åˆ†é…ç®—æ³•ä¼šéå†ä¸¤æ¬¡mastersæ•°ç»„ã€‚<br>ç¬¬ä¸€æ¬¡éå†mastersæ•°ç»„ï¼Œåœ¨ä½™ä¸‹çš„èŠ‚ç‚¹åˆ—è¡¨æ‰¾åˆ°replicasæ•°é‡ä¸ªslaveã€‚æ¯ä¸ªslaveä¸ºç¬¬ä¸€ä¸ªå’ŒmasterèŠ‚ç‚¹hostä¸ä¸€æ ·çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰ä¸ä¸€æ ·çš„èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥å–å‡ºä½™ä¸‹åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚<br>ç¬¬äºŒæ¬¡éå†æ˜¯åœ¨å¯¹äºèŠ‚ç‚¹æ•°é™¤ä»¥replicasä¸ä¸ºæ•´æ•°ï¼Œåˆ™ä¼šå¤šä½™ä¸€éƒ¨åˆ†èŠ‚ç‚¹ã€‚éå†çš„æ–¹å¼è·Ÿç¬¬ä¸€æ¬¡ä¸€æ ·ï¼Œåªæ˜¯ç¬¬ä¸€æ¬¡ä¼šä¸€æ¬¡æ€§ç»™masteråˆ†é…replicasæ•°é‡ä¸ªslaveï¼Œè€Œç¬¬äºŒæ¬¡éå†åªåˆ†é…ä¸€ä¸ªï¼Œç›´åˆ°ä½™ä¸‹çš„èŠ‚ç‚¹è¢«å…¨éƒ¨åˆ†é…å‡ºå»ã€‚<br>4ã€æ‰“å°å‡ºåˆ†é…ä¿¡æ¯ï¼Œå¹¶æç¤ºç”¨æˆ·è¾“å…¥â€œyesâ€ç¡®è®¤æ˜¯å¦æŒ‰ç…§æ‰“å°å‡ºæ¥çš„åˆ†é…æ–¹å¼åˆ›å»ºé›†ç¾¤ã€‚<br>5ã€è¾“å…¥â€œyesâ€åï¼Œä¼šæ‰§è¡Œflush_nodes_configæ“ä½œï¼Œè¯¥æ“ä½œæ‰§è¡Œå‰é¢çš„åˆ†é…ç»“æœï¼Œç»™masteråˆ†é…slotï¼Œè®©slaveå¤åˆ¶masterï¼Œå¯¹äºè¿˜æ²¡æœ‰æ¡æ‰‹ï¼ˆcluster meetï¼‰çš„èŠ‚ç‚¹ï¼Œslaveå¤åˆ¶æ“ä½œæ— æ³•å®Œæˆï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œflush_nodes_configæ“ä½œå‡ºç°å¼‚å¸¸ä¼šå¾ˆå¿«è¿”å›ï¼Œåç»­æ¡æ‰‹åä¼šå†æ¬¡æ‰§è¡Œflush_nodes_configã€‚<br>6ã€ç»™æ¯ä¸ªèŠ‚ç‚¹åˆ†é…epochï¼Œéå†èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„epochæ¯”ä¹‹å‰èŠ‚ç‚¹å¤§1ã€‚<br>7ã€èŠ‚ç‚¹é—´å¼€å§‹ç›¸äº’æ¡æ‰‹ï¼Œæ¡æ‰‹çš„æ–¹å¼ä¸ºèŠ‚ç‚¹åˆ—è¡¨çš„å…¶ä»–èŠ‚ç‚¹è·Ÿç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ¡æ‰‹ã€‚<br>8ã€ç„¶åæ¯éš”1ç§’æ£€æŸ¥ä¸€æ¬¡å„ä¸ªèŠ‚ç‚¹æ˜¯å¦å·²ç»æ¶ˆæ¯åŒæ­¥å®Œæˆï¼Œä½¿ç”¨ClusterNodeçš„get_config_signatureæ–¹æ³•ï¼Œæ£€æŸ¥çš„ç®—æ³•ä¸ºè·å–æ¯ä¸ªèŠ‚ç‚¹cluster nodesä¿¡æ¯ï¼Œæ’åºæ¯ä¸ªèŠ‚ç‚¹ï¼Œç»„è£…æˆnode_id1:slots|node_id2:slot2|â€¦çš„å­—ç¬¦ä¸²ã€‚å¦‚æœæ¯ä¸ªèŠ‚ç‚¹è·å¾—å­—ç¬¦ä¸²éƒ½ç›¸åŒï¼Œå³è®¤ä¸ºæ¡æ‰‹æˆåŠŸã€‚<br>9ã€æ­¤åä¼šå†æ‰§è¡Œä¸€æ¬¡flush_nodes_configï¼Œè¿™æ¬¡ä¸»è¦æ˜¯ä¸ºäº†å®Œæˆslaveå¤åˆ¶æ“ä½œã€‚<br>10ã€æœ€åå†æ‰§è¡Œcheck_clusterï¼Œå…¨é¢æ£€æŸ¥ä¸€æ¬¡é›†ç¾¤çŠ¶æ€ã€‚åŒ…æ‹¬å’Œå‰é¢æ¡æ‰‹æ—¶æ£€æŸ¥ä¸€æ ·çš„æ–¹å¼å†æ£€æŸ¥ä¸€éã€‚ç¡®è®¤æ²¡æœ‰è¿ç§»çš„èŠ‚ç‚¹ã€‚ç¡®è®¤æ‰€æœ‰çš„slotéƒ½è¢«åˆ†é…å‡ºå»äº†ã€‚<br>11ã€è‡³æ­¤å®Œæˆäº†æ•´ä¸ªåˆ›å»ºæµç¨‹ï¼Œè¿”å›[OK] All 16384 slots covered.ã€‚</p>
<h1 id="checkæ£€æŸ¥é›†ç¾¤"><a href="#checkæ£€æŸ¥é›†ç¾¤" class="headerlink" title="checkæ£€æŸ¥é›†ç¾¤"></a>checkæ£€æŸ¥é›†ç¾¤</h1><p>æ£€æŸ¥é›†ç¾¤çŠ¶æ€çš„å‘½ä»¤ï¼Œæ²¡æœ‰å…¶ä»–å‚æ•°ï¼Œåªéœ€è¦é€‰æ‹©ä¸€ä¸ªé›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å³å¯ã€‚æ‰§è¡Œå‘½ä»¤ä»¥åŠç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb check 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)</div><div class="line">M: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">S: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates b2506515b38e6bbd3034d540599f4cd2a5279ad1</div><div class="line">M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">[OK] All nodes agree about slots configuration.</div><div class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</div><div class="line">&gt;&gt;&gt; Check slots coverage...</div><div class="line">[OK] All 16384 slots covered.</div></pre></td></tr></table></figure></p>
<p>æ£€æŸ¥å‰ä¼šå…ˆæ‰§è¡Œload_cluster_info_from_nodeæ–¹æ³•ï¼ŒæŠŠæ‰€æœ‰èŠ‚ç‚¹æ•°æ®loadè¿›æ¥ã€‚loadçš„æ–¹å¼ä¸ºé€šè¿‡è‡ªå·±çš„cluster nodeså‘ç°å…¶ä»–èŠ‚ç‚¹ï¼Œç„¶åè¿æ¥æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥nodesæ•°ç»„ã€‚æ¥ç€ç”ŸæˆèŠ‚ç‚¹é—´çš„å¤åˆ¶å…³ç³»ã€‚</p>
<p>loadå®Œæ•°æ®åï¼Œå¼€å§‹æ£€æŸ¥æ•°æ®ï¼Œæ£€æŸ¥çš„æ–¹å¼ä¹Ÿæ˜¯è°ƒç”¨åˆ›å»ºæ—¶å€™ä½¿ç”¨çš„check_clusterã€‚</p>
<h1 id="infoæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯"><a href="#infoæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯" class="headerlink" title="infoæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯"></a>infoæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯</h1><p>infoå‘½ä»¤ç”¨æ¥æŸ¥çœ‹é›†ç¾¤çš„ä¿¡æ¯ã€‚infoå‘½ä»¤ä¹Ÿæ˜¯å…ˆæ‰§è¡Œload_cluster_info_from_nodeè·å–å®Œæ•´çš„é›†ç¾¤ä¿¡æ¯ã€‚ç„¶åæ˜¾ç¤ºClusterNodeçš„info_stringç»“æœï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb info 10.180.157.199:6379</div><div class="line">10.180.157.199:6379 (b2506515...) -&gt; 0 keys | 5461 slots | 1 slaves.</div><div class="line">10.180.157.201:6379 (15126fb3...) -&gt; 0 keys | 5461 slots | 1 slaves.</div><div class="line">10.180.157.200:6379 (e36c46db...) -&gt; 0 keys | 5462 slots | 1 slaves.</div><div class="line">[OK] 0 keys <span class="keyword">in</span> 3 masters.</div><div class="line">0.00 keys per slot on average.</div></pre></td></tr></table></figure></p>
<h1 id="fixä¿®å¤é›†ç¾¤"><a href="#fixä¿®å¤é›†ç¾¤" class="headerlink" title="fixä¿®å¤é›†ç¾¤"></a>fixä¿®å¤é›†ç¾¤</h1><p>fixå‘½ä»¤çš„æµç¨‹è·Ÿcheckçš„æµç¨‹å¾ˆåƒï¼Œæ˜¾ç¤ºåŠ è½½é›†ç¾¤ä¿¡æ¯ï¼Œç„¶ååœ¨check_clusteræ–¹æ³•å†…ä¼ å…¥fixä¸º<br>trueçš„å˜é‡ï¼Œä¼šåœ¨é›†ç¾¤æ£€æŸ¥å‡ºç°å¼‚å¸¸çš„æ—¶å€™æ‰§è¡Œä¿®å¤æµç¨‹ã€‚ç›®å‰fixå‘½ä»¤èƒ½ä¿®å¤ä¸¤ç§å¼‚å¸¸ï¼Œä¸€ç§æ˜¯é›†ç¾¤æœ‰å¤„äºè¿ç§»ä¸­çš„slotçš„èŠ‚ç‚¹ï¼Œä¸€ç§æ˜¯slotæœªå®Œå…¨åˆ†é…çš„å¼‚å¸¸ã€‚</p>
<p>fix_open_slotæ–¹æ³•æ˜¯ä¿®å¤é›†ç¾¤æœ‰å¤„äºè¿ç§»ä¸­çš„slotçš„èŠ‚ç‚¹å¼‚å¸¸ã€‚<br>1ã€å…ˆæ£€æŸ¥è¯¥slotæ˜¯è°è´Ÿè´£çš„ï¼Œè¿ç§»çš„æºèŠ‚ç‚¹å¦‚æœæ²¡å®Œæˆè¿ç§»ï¼Œownerè¿˜æ˜¯è¯¥èŠ‚ç‚¹ã€‚æ²¡æœ‰ownerçš„slotæ— æ³•å®Œæˆä¿®å¤åŠŸèƒ½ã€‚<br>2ã€éå†æ¯ä¸ªèŠ‚ç‚¹ï¼Œè·å–å“ªäº›èŠ‚ç‚¹æ ‡è®°è¯¥slotä¸ºmigratingçŠ¶æ€ï¼Œå“ªäº›èŠ‚ç‚¹æ ‡è®°è¯¥slotä¸ºimportingçŠ¶æ€ã€‚å¯¹äºownerä¸æ˜¯è¯¥èŠ‚ç‚¹ï¼Œä½†æ˜¯é€šè¿‡cluster countkeysinslotè·å–åˆ°è¯¥èŠ‚ç‚¹æœ‰æ•°æ®çš„æƒ…å†µï¼Œä¹Ÿè®¤ä¸ºè¯¥èŠ‚ç‚¹ä¸ºimportingçŠ¶æ€ã€‚<br>3ã€å¦‚æœmigratingå’ŒimportingçŠ¶æ€çš„èŠ‚ç‚¹å‡åªæœ‰1ä¸ªï¼Œè¿™å¯èƒ½æ˜¯è¿ç§»è¿‡ç¨‹ä¸­redis-trib.rbè¢«ä¸­æ–­æ‰€è‡´ï¼Œç›´æ¥æ‰§è¡Œmove_slotç»§ç»­å®Œæˆè¿ç§»ä»»åŠ¡å³å¯ã€‚ä¼ é€’dotså’Œfixä¸ºtrueã€‚<br>4ã€å¦‚æœmigratingä¸ºç©ºï¼ŒimportingçŠ¶æ€çš„èŠ‚ç‚¹å¤§äº0ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µæ‰§è¡Œå›æ»šæµç¨‹ï¼Œå°†importingçŠ¶æ€çš„èŠ‚ç‚¹æ•°æ®é€šè¿‡move_slotæ–¹æ³•å¯¼ç»™slotçš„ownerèŠ‚ç‚¹ï¼Œä¼ é€’dotsã€fixå’Œcoldä¸ºtrueã€‚æ¥ç€å¯¹importingçš„èŠ‚ç‚¹æ‰§è¡Œcluster stableå‘½ä»¤æ¢å¤ç¨³å®šã€‚<br>5ã€å¦‚æœimportingçŠ¶æ€çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œæœ‰ä¸€ä¸ªmigratingçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œè€Œä¸”è¯¥èŠ‚ç‚¹åœ¨å½“å‰slotæ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æŠŠè¿™ä¸ªslotè®¾ä¸ºstableã€‚<br>6ã€å¦‚æœmigratingå’ŒimportingçŠ¶æ€ä¸æ˜¯ä¸Šè¿°æƒ…å†µï¼Œç›®å‰redis-trib.rbå·¥å…·æ— æ³•ä¿®å¤ï¼Œä¸Šè¿°çš„ä¸‰ç§æƒ…å†µä¹Ÿå·²ç»è¦†ç›–äº†é€šè¿‡redis-trib.rbå·¥å…·è¿ç§»å‡ºç°å¼‚å¸¸çš„å„ä¸ªæ–¹é¢ï¼Œäººä¸ºçš„å¼‚å¸¸æƒ…å½¢å¤ªå¤šï¼Œå¾ˆéš¾è€ƒè™‘å®Œå…¨ã€‚</p>
<p>fix_slots_coverageæ–¹æ³•èƒ½ä¿®å¤slotæœªå®Œå…¨åˆ†é…çš„å¼‚å¸¸ã€‚æœªåˆ†é…çš„slotæœ‰ä¸‰ç§çŠ¶æ€ã€‚<br>1ã€æ‰€æœ‰èŠ‚ç‚¹çš„è¯¥slotéƒ½æ²¡æœ‰æ•°æ®ã€‚è¯¥çŠ¶æ€redis-trib.rbå·¥å…·ç›´æ¥é‡‡ç”¨éšæœºåˆ†é…çš„æ–¹å¼ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘èŠ‚ç‚¹çš„å‡è¡¡ã€‚æœ¬äººå°è¯•å¯¹æ²¡æœ‰åˆ†é…slotçš„é›†ç¾¤é€šè¿‡fixä¿®å¤é›†ç¾¤ï¼Œç»“æœslotè¿˜æ˜¯èƒ½æ¯”è¾ƒå¹³å‡çš„åˆ†é…ï¼Œä½†æ˜¯æ²¡æœ‰äº†è¿ç»­æ€§ï¼Œæ‰“å°çš„slotä¿¡æ¯éå¸¸ç¦»æ•£ã€‚<br>2ã€æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„è¯¥slotæœ‰æ•°æ®ã€‚è¯¥çŠ¶æ€ä¸‹ï¼Œç›´æ¥æŠŠslotåˆ†é…ç»™è¯¥slotæœ‰æ•°æ®çš„èŠ‚ç‚¹ã€‚<br>3ã€æœ‰å¤šä¸ªèŠ‚ç‚¹çš„è¯¥slotæœ‰æ•°æ®ã€‚æ­¤ç§æƒ…å†µç›®å‰è¿˜å¤„äºTODOçŠ¶æ€ï¼Œä¸è¿‡redisä½œè€…åˆ—å‡ºäº†ä¿®å¤çš„æ­¥éª¤ï¼Œå¯¹è¿™äº›èŠ‚ç‚¹ï¼Œé™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰§è¡Œcluster migratingå‘½ä»¤ï¼Œç„¶åæŠŠè¿™äº›èŠ‚ç‚¹çš„æ•°æ®è¿ç§»åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚æ¸…é™¤migratingçŠ¶æ€ï¼Œç„¶åæŠŠslotåˆ†é…ç»™ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<h1 id="reshardåœ¨çº¿è¿ç§»slot"><a href="#reshardåœ¨çº¿è¿ç§»slot" class="headerlink" title="reshardåœ¨çº¿è¿ç§»slot"></a>reshardåœ¨çº¿è¿ç§»slot</h1><p>reshardå‘½ä»¤å¯ä»¥åœ¨çº¿æŠŠé›†ç¾¤çš„ä¸€äº›slotä»é›†ç¾¤åŸæ¥slotè´Ÿè´£èŠ‚ç‚¹è¿ç§»åˆ°æ–°çš„èŠ‚ç‚¹ï¼Œåˆ©ç”¨reshardå¯ä»¥å®Œæˆé›†ç¾¤çš„åœ¨çº¿æ¨ªå‘æ‰©å®¹å’Œç¼©å®¹ã€‚<br>reshardçš„å‚æ•°å¾ˆå¤šï¼Œä¸‹é¢æ¥ä¸€ä¸€è§£é‡Šä¸€ç•ªï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">reshard         host:port</div><div class="line">                --from &lt;arg&gt;</div><div class="line">                --to &lt;arg&gt;</div><div class="line">                --slots &lt;arg&gt;</div><div class="line">                --yes</div><div class="line">                --timeout &lt;arg&gt;</div><div class="line">                --pipeline &lt;arg&gt;</div></pre></td></tr></table></figure></p>
<p>host:portï¼šè¿™ä¸ªæ˜¯å¿…ä¼ å‚æ•°ï¼Œç”¨æ¥ä»ä¸€ä¸ªèŠ‚ç‚¹è·å–æ•´ä¸ªé›†ç¾¤ä¿¡æ¯ï¼Œç›¸å½“äºè·å–é›†ç¾¤ä¿¡æ¯çš„å…¥å£ã€‚<br>â€“from <arg>ï¼šéœ€è¦ä»å“ªäº›æºèŠ‚ç‚¹ä¸Šè¿ç§»slotï¼Œå¯ä»å¤šä¸ªæºèŠ‚ç‚¹å®Œæˆè¿ç§»ï¼Œä»¥é€—å·éš”å¼€ï¼Œä¼ é€’çš„æ˜¯èŠ‚ç‚¹çš„node idï¼Œè¿˜å¯ä»¥ç›´æ¥ä¼ é€’â€“from allï¼Œè¿™æ ·æºèŠ‚ç‚¹å°±æ˜¯é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¸ä¼ é€’è¯¥å‚æ•°çš„è¯ï¼Œåˆ™ä¼šåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚<br>â€“to <arg>ï¼šslotéœ€è¦è¿ç§»çš„ç›®çš„èŠ‚ç‚¹çš„node idï¼Œç›®çš„èŠ‚ç‚¹åªèƒ½å¡«å†™ä¸€ä¸ªï¼Œä¸ä¼ é€’è¯¥å‚æ•°çš„è¯ï¼Œåˆ™ä¼šåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚<br>â€“slots <arg>ï¼šéœ€è¦è¿ç§»çš„slotæ•°é‡ï¼Œä¸ä¼ é€’è¯¥å‚æ•°çš„è¯ï¼Œåˆ™ä¼šåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚<br>â€“yesï¼šè®¾ç½®è¯¥å‚æ•°ï¼Œå¯ä»¥åœ¨æ‰“å°æ‰§è¡Œreshardè®¡åˆ’çš„æ—¶å€™ï¼Œæç¤ºç”¨æˆ·è¾“å…¥yesç¡®è®¤åå†æ‰§è¡Œreshardã€‚<br>â€“timeout <arg>ï¼šè®¾ç½®migrateå‘½ä»¤çš„è¶…æ—¶æ—¶é—´ã€‚<br>â€“pipeline <arg>ï¼šå®šä¹‰cluster getkeysinslotå‘½ä»¤ä¸€æ¬¡å–å‡ºçš„keyæ•°é‡ï¼Œä¸ä¼ çš„è¯ä½¿ç”¨é»˜è®¤å€¼ä¸º10ã€‚</arg></arg></arg></arg></arg></p>
<p>è¿ç§»çš„æµç¨‹å¦‚ä¸‹ï¼š<br>1ã€é€šè¿‡load_cluster_info_from_nodeæ–¹æ³•è£…è½½é›†ç¾¤ä¿¡æ¯ã€‚<br>2ã€æ‰§è¡Œcheck_clusteræ–¹æ³•æ£€æŸ¥é›†ç¾¤æ˜¯å¦å¥åº·ã€‚åªæœ‰å¥åº·çš„é›†ç¾¤æ‰èƒ½è¿›è¡Œè¿ç§»ã€‚<br>3ã€è·å–éœ€è¦è¿ç§»çš„slotæ•°é‡ï¼Œç”¨æˆ·æ²¡ä¼ é€’â€“slotså‚æ•°ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ã€‚<br>4ã€è·å–è¿ç§»çš„ç›®çš„èŠ‚ç‚¹ï¼Œç”¨æˆ·æ²¡ä¼ é€’â€“toå‚æ•°ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ã€‚æ­¤å¤„ä¼šæ£€æŸ¥ç›®çš„èŠ‚ç‚¹å¿…é¡»ä¸ºmasterèŠ‚ç‚¹ã€‚<br>5ã€è·å–è¿ç§»çš„æºèŠ‚ç‚¹ï¼Œç”¨æˆ·æ²¡ä¼ é€’â€“fromå‚æ•°ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ã€‚æ­¤å¤„ä¼šæ£€æŸ¥æºèŠ‚ç‚¹å¿…é¡»ä¸ºmasterèŠ‚ç‚¹ã€‚â€“from allçš„è¯ï¼ŒæºèŠ‚ç‚¹å°±æ˜¯é™¤äº†ç›®çš„èŠ‚ç‚¹å¤–çš„å…¨éƒ¨masterèŠ‚ç‚¹ã€‚è¿™é‡Œä¸ºäº†ä¿è¯é›†ç¾¤slotåˆ†é…çš„å¹³å‡ï¼Œå»ºè®®ä¼ é€’â€“from allã€‚<br>6ã€æ‰§è¡Œcompute_reshard_tableæ–¹æ³•ï¼Œè®¡ç®—éœ€è¦è¿ç§»çš„slotæ•°é‡å¦‚ä½•åˆ†é…åˆ°æºèŠ‚ç‚¹åˆ—è¡¨ï¼Œé‡‡ç”¨çš„ç®—æ³•æ˜¯æŒ‰ç…§èŠ‚ç‚¹è´Ÿè´£slotæ•°é‡ç”±å¤šåˆ°å°‘æ’åºï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹éœ€è¦è¿ç§»çš„slotçš„æ–¹æ³•ä¸ºï¼šè¿ç§»slotæ•°é‡ * (è¯¥æºèŠ‚ç‚¹è´Ÿè´£çš„slotæ•°é‡ / æºèŠ‚ç‚¹åˆ—è¡¨è´Ÿè´£çš„slotæ€»æ•°)ã€‚è¿™æ ·ç®—å‡ºçš„æ•°é‡å¯èƒ½ä¸ä¸ºæ•´æ•°ï¼Œè¿™é‡Œä»£ç ç”¨äº†ä¸‹é¢çš„æ–¹å¼å¤„ç†ï¼š<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">n = (numslots/source_tot_slots*s.slots.length)</div><div class="line"><span class="keyword">if</span> i == <span class="number">0</span></div><div class="line">    n = n.ceil</div><div class="line"><span class="keyword">else</span></div><div class="line">    n = n.floor</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·çš„å¤„ç†æ–¹å¼ä¼šå¸¦æ¥æœ€ç»ˆåˆ†é…çš„slotä¸è¯·æ±‚è¿ç§»çš„slotæ•°é‡ä¸ä¸€è‡´ï¼Œè¿™ä¸ªBUGå·²ç»åœ¨githubä¸Šæç»™ä½œè€…ï¼Œ<a href="https://github.com/antirez/redis/issues/2990ã€‚" target="_blank" rel="external">https://github.com/antirez/redis/issues/2990ã€‚</a><br>7ã€æ‰“å°å‡ºreshardè®¡åˆ’ï¼Œå¦‚æœç”¨æˆ·æ²¡ä¼ â€“yesï¼Œå°±æç¤ºç”¨æˆ·ç¡®è®¤è®¡åˆ’ã€‚<br>8ã€æ ¹æ®reshardè®¡åˆ’ï¼Œä¸€ä¸ªä¸ªslotçš„è¿ç§»åˆ°æ–°èŠ‚ç‚¹ä¸Šï¼Œè¿ç§»ä½¿ç”¨move_slotæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¢«å¾ˆå¤šå‘½ä»¤ä½¿ç”¨ï¼Œå…·ä½“å¯ä»¥å‚è§ä¸‹é¢çš„è¿ç§»æµç¨‹ã€‚move_slotæ–¹æ³•ä¼ é€’dotsä¸ºtrueå’Œpipelineæ•°é‡ã€‚<br>9ã€è‡³æ­¤ï¼Œå°±å®Œæˆäº†å…¨éƒ¨çš„è¿ç§»ä»»åŠ¡ã€‚<br>ä¸‹é¢çœ‹ä¸‹ä¸€æ¬¡reshardçš„æ‰§è¡Œç»“æœï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb reshard --from all --to 80b661ecca260c89e3d8ea9b98f77edaeef43dcd --slots 11 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)</div><div class="line">S: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates 460b3a11e296aafb2615043291b7dd98274bb351</div><div class="line">S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379</div><div class="line">   slots: (0 slots) slave</div><div class="line">   replicates 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">M: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">M: 80b661ecca260c89e3d8ea9b98f77edaeef43dcd 10.180.157.200:6380</div><div class="line">   slots: (0 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">[OK] All nodes agree about slots configuration.</div><div class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</div><div class="line">&gt;&gt;&gt; Check slots coverage...</div><div class="line">[OK] All 16384 slots covered.</div><div class="line"></div><div class="line">Ready to move 11 slots.</div><div class="line">  Source nodes:</div><div class="line">    M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">    M: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">    M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   1 additional replica(s)</div><div class="line">  Destination node:</div><div class="line">    M: 80b661ecca260c89e3d8ea9b98f77edaeef43dcd 10.180.157.200:6380</div><div class="line">   slots: (0 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">  Resharding plan:</div><div class="line">    Moving slot 5461 from e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">    Moving slot 5462 from e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">    Moving slot 5463 from e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">    Moving slot 5464 from e36c46dbe90960f30861af00786d4c2064e63df2</div><div class="line">    Moving slot 0 from 460b3a11e296aafb2615043291b7dd98274bb351</div><div class="line">    Moving slot 1 from 460b3a11e296aafb2615043291b7dd98274bb351</div><div class="line">    Moving slot 2 from 460b3a11e296aafb2615043291b7dd98274bb351</div><div class="line">    Moving slot 10923 from 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">    Moving slot 10924 from 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">    Moving slot 10925 from 15126fb33796c2c26ea89e553418946f7443d5a5</div><div class="line">Do you want to proceed with the proposed reshard plan (yes/no)? yes</div><div class="line">Moving slot 5461 from 10.180.157.200:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 5462 from 10.180.157.200:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 5463 from 10.180.157.200:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 5464 from 10.180.157.200:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 0 from 10.180.157.202:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 1 from 10.180.157.202:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 2 from 10.180.157.202:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 10923 from 10.180.157.201:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 10924 from 10.180.157.201:6379 to 10.180.157.200:6380:</div><div class="line">Moving slot 10925 from 10.180.157.201:6379 to 10.180.157.200:6380:</div></pre></td></tr></table></figure></p>
<p>move_slotæ–¹æ³•å¯ä»¥åœ¨çº¿å°†ä¸€ä¸ªslotçš„å…¨éƒ¨æ•°æ®ä»æºèŠ‚ç‚¹è¿ç§»åˆ°ç›®çš„èŠ‚ç‚¹ï¼Œfixã€reshardã€rebalanceéƒ½éœ€è¦è°ƒç”¨è¯¥æ–¹æ³•è¿ç§»slotã€‚<br>move_slotæ¥å—ä¸‹é¢å‡ ä¸ªå‚æ•°ï¼Œ<br>1ã€pipelineï¼šè®¾ç½®ä¸€æ¬¡ä»slotä¸Šè·å–å¤šå°‘ä¸ªkeyã€‚<br>2ã€quietï¼šè¿ç§»ä¼šæ‰“å°ç›¸å…³ä¿¡æ¯ï¼Œè®¾ç½®quietå‚æ•°ï¼Œå¯ä»¥ä¸ç”¨æ‰“å°è¿™äº›ä¿¡æ¯ã€‚<br>3ã€coldï¼šè®¾ç½®coldï¼Œä¼šå¿½ç•¥æ‰§è¡Œimportingå’Œmigratingã€‚<br>4ã€dotsï¼šè®¾ç½®dotsï¼Œåˆ™ä¼šåœ¨è¿ç§»è¿‡ç¨‹æ‰“å°è¿ç§»keyæ•°é‡çš„è¿›åº¦ã€‚<br>5ã€updateï¼šè®¾ç½®updateï¼Œåˆ™ä¼šæ›´æ–°å†…å­˜ä¿¡æ¯ï¼Œæ–¹ä¾¿ä»¥åçš„æ“ä½œã€‚</p>
<p>move_slotæµç¨‹å¦‚ä¸‹ï¼š<br>1ã€å¦‚æœæ²¡æœ‰è®¾ç½®coldï¼Œåˆ™å¯¹æºèŠ‚ç‚¹æ‰§è¡Œcluster importingå‘½ä»¤ï¼Œå¯¹ç›®çš„èŠ‚ç‚¹æ‰§è¡Œmigratingå‘½ä»¤ã€‚fixçš„æ—¶å€™æœ‰å¯èƒ½importingå’Œmigratingå·²ç»æ‰§è¡Œè¿‡æ¥ï¼Œæ‰€ä»¥æ­¤ç§åœºæ™¯ä¼šè®¾ç½®coldã€‚<br>2ã€é€šè¿‡cluster getkeysinslotå‘½ä»¤ï¼Œä¸€æ¬¡æ€§è·å–è¿œèŠ‚ç‚¹è¿ç§»slotçš„pipelineä¸ªkeyçš„æ•°é‡.<br>3ã€å¯¹è¿™äº›keyæ‰§è¡Œmigrateå‘½ä»¤ï¼Œå°†æ•°æ®ä»æºèŠ‚ç‚¹è¿ç§»åˆ°ç›®çš„èŠ‚ç‚¹ã€‚<br>4ã€å¦‚æœmigrateå‡ºç°å¼‚å¸¸ï¼Œåœ¨fixæ¨¡å¼ä¸‹ï¼ŒBUSYKEYçš„å¼‚å¸¸ï¼Œä¼šä½¿ç”¨migrateçš„replaceæ¨¡å¼å†æ‰§è¡Œä¸€æ¬¡ï¼ŒBUSYKEYè¡¨ç¤ºç›®çš„èŠ‚ç‚¹å·²ç»æœ‰è¯¥keyäº†ï¼Œreplaceæ¨¡å¼å¯ä»¥å¼ºåˆ¶æ›¿æ¢ç›®çš„èŠ‚ç‚¹çš„keyã€‚ä¸æ˜¯fixæ¨¡å¼å°±ç›´æ¥è¿”å›é”™è¯¯äº†ã€‚<br>5ã€å¾ªç¯æ‰§è¡Œcluster getkeysinslotå‘½ä»¤ï¼Œç›´åˆ°è¿”å›çš„keyæ•°é‡ä¸º0ï¼Œå°±é€€å‡ºå¾ªç¯ã€‚<br>6ã€å¦‚æœæ²¡æœ‰è®¾ç½®coldï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œcluster setslotå‘½ä»¤ï¼ŒæŠŠslotèµ‹ç»™ç›®çš„èŠ‚ç‚¹ã€‚<br>7ã€å¦‚æœè®¾ç½®updateï¼Œåˆ™ä¿®æ”¹æºèŠ‚ç‚¹å’Œç›®çš„èŠ‚ç‚¹çš„slotä¿¡æ¯ã€‚<br>8ã€è‡³æ­¤å®Œæˆäº†è¿ç§»slotçš„æµç¨‹ã€‚</p>
<h1 id="rebalanceå¹³è¡¡é›†ç¾¤èŠ‚ç‚¹slotæ•°é‡"><a href="#rebalanceå¹³è¡¡é›†ç¾¤èŠ‚ç‚¹slotæ•°é‡" class="headerlink" title="rebalanceå¹³è¡¡é›†ç¾¤èŠ‚ç‚¹slotæ•°é‡"></a>rebalanceå¹³è¡¡é›†ç¾¤èŠ‚ç‚¹slotæ•°é‡</h1><p>rebalanceå‘½ä»¤å¯ä»¥æ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å‚æ•°å¹³è¡¡é›†ç¾¤èŠ‚ç‚¹çš„slotæ•°é‡ï¼ŒrebalanceåŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œå¯ä»¥ä¼ å…¥çš„å‚æ•°å¾ˆå¤šï¼Œä»¥ä¸‹æ˜¯rebalanceçš„å‚æ•°åˆ—è¡¨å’Œå‘½ä»¤ç¤ºä¾‹ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">rebalance       host:port</div><div class="line">                --weight &lt;arg&gt;</div><div class="line">                --auto-weights</div><div class="line">                --threshold &lt;arg&gt;</div><div class="line">                --use-empty-masters</div><div class="line">                --timeout &lt;arg&gt;</div><div class="line">                --simulate</div><div class="line">                --pipeline &lt;arg&gt;</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb rebalance --threshold 1 --weight b31e3a2e=5 --weight 60b8e3a1=5 --use-empty-masters  --simulate 10.180.157.199:6379</div></pre></td></tr></table></figure>
<p>ä¸‹é¢ä¹Ÿå…ˆä¸€ä¸€è§£é‡Šä¸‹æ¯ä¸ªå‚æ•°çš„ç”¨æ³•ï¼š<br>host:portï¼šè¿™ä¸ªæ˜¯å¿…ä¼ å‚æ•°ï¼Œç”¨æ¥ä»ä¸€ä¸ªèŠ‚ç‚¹è·å–æ•´ä¸ªé›†ç¾¤ä¿¡æ¯ï¼Œç›¸å½“äºè·å–é›†ç¾¤ä¿¡æ¯çš„å…¥å£ã€‚<br>â€“weight <arg>ï¼šèŠ‚ç‚¹çš„æƒé‡ï¼Œæ ¼å¼ä¸ºnode_id=weightï¼Œå¦‚æœéœ€è¦ä¸ºå¤šä¸ªèŠ‚ç‚¹åˆ†é…æƒé‡çš„è¯ï¼Œéœ€è¦æ·»åŠ å¤šä¸ªâ€“weight <arg>å‚æ•°ï¼Œå³â€“weight b31e3a2e=5 â€“weight 60b8e3a1=5ï¼Œnode_idå¯ä¸ºèŠ‚ç‚¹åç§°çš„å‰ç¼€ï¼Œåªè¦ä¿è¯å‰ç¼€ä½æ•°èƒ½å”¯ä¸€åŒºåˆ†è¯¥èŠ‚ç‚¹å³å¯ã€‚æ²¡æœ‰ä¼ é€’â€“weightçš„èŠ‚ç‚¹çš„æƒé‡é»˜è®¤ä¸º1ã€‚<br>â€“auto-weightsï¼šè¿™ä¸ªå‚æ•°åœ¨rebalanceæµç¨‹ä¸­å¹¶æœªç”¨åˆ°ã€‚<br>â€“threshold <arg>ï¼šåªæœ‰èŠ‚ç‚¹éœ€è¦è¿ç§»çš„sloté˜ˆå€¼è¶…è¿‡thresholdï¼Œæ‰ä¼šæ‰§è¡Œrebalanceæ“ä½œã€‚å…·ä½“è®¡ç®—æ–¹æ³•å¯ä»¥å‚è€ƒä¸‹é¢çš„rebalanceå‘½ä»¤æµç¨‹çš„ç¬¬å››æ­¥ã€‚<br>â€“use-empty-mastersï¼šrebalanceæ˜¯å¦è€ƒè™‘æ²¡æœ‰èŠ‚ç‚¹çš„masterï¼Œé»˜è®¤æ²¡æœ‰åˆ†é…slotèŠ‚ç‚¹çš„masteræ˜¯ä¸å‚ä¸rebalanceçš„ï¼Œè®¾ç½®â€“use-empty-masterså¯ä»¥è®©æ²¡æœ‰åˆ†é…slotçš„èŠ‚ç‚¹å‚ä¸rebalanceã€‚<br>â€“timeout <arg>ï¼šè®¾ç½®migrateå‘½ä»¤çš„è¶…æ—¶æ—¶é—´ã€‚<br>â€“simulateï¼šè®¾ç½®è¯¥å‚æ•°ï¼Œå¯ä»¥æ¨¡æ‹Ÿrebalanceæ“ä½œï¼Œæç¤ºç”¨æˆ·ä¼šè¿ç§»å“ªäº›slotsï¼Œè€Œä¸ä¼šçœŸæ­£æ‰§è¡Œè¿ç§»æ“ä½œã€‚<br>â€“pipeline <arg>ï¼šä¸resharçš„pipelineå‚æ•°ä¸€æ ·ï¼Œå®šä¹‰cluster getkeysinslotå‘½ä»¤ä¸€æ¬¡å–å‡ºçš„keyæ•°é‡ï¼Œä¸ä¼ çš„è¯ä½¿ç”¨é»˜è®¤å€¼ä¸º10ã€‚</arg></arg></arg></arg></arg></p>
<p>rebalanceå‘½ä»¤æµç¨‹å¦‚ä¸‹ï¼š<br>1ã€load_cluster_info_from_nodeæ–¹æ³•å…ˆåŠ è½½é›†ç¾¤ä¿¡æ¯ã€‚<br>2ã€è®¡ç®—æ¯ä¸ªmasterçš„æƒé‡ï¼Œæ ¹æ®å‚æ•°â€“weight <arg>ï¼Œä¸ºæ¯ä¸ªè®¾ç½®çš„èŠ‚ç‚¹åˆ†é…æƒé‡ï¼Œæ²¡æœ‰è®¾ç½®çš„èŠ‚ç‚¹ï¼Œåˆ™æƒé‡é»˜è®¤ä¸º1ã€‚<br>3ã€æ ¹æ®æ¯ä¸ªmasterçš„æƒé‡ï¼Œä»¥åŠæ€»çš„æƒé‡ï¼Œè®¡ç®—è‡ªå·±æœŸæœ›è¢«åˆ†é…å¤šå°‘ä¸ªslotã€‚è®¡ç®—çš„æ–¹å¼ä¸ºï¼šæ€»slotæ•°é‡ <em> ï¼ˆè‡ªå·±çš„æƒé‡ / æ€»æƒé‡ï¼‰ã€‚<br>4ã€è®¡ç®—æ¯ä¸ªmasteræœŸæœ›åˆ†é…çš„slotæ˜¯å¦è¶…è¿‡è®¾ç½®çš„é˜ˆå€¼ï¼Œå³â€“threshold <arg>è®¾ç½®çš„é˜ˆå€¼æˆ–è€…é»˜è®¤çš„é˜ˆå€¼ã€‚è®¡ç®—çš„æ–¹å¼ä¸ºï¼šå…ˆè®¡ç®—æœŸæœ›ç§»åŠ¨èŠ‚ç‚¹çš„é˜ˆå€¼ï¼Œç®—æ³•ä¸ºï¼š(100-(100.0</arg></em>expected/n.slots.length)).absï¼Œå¦‚æœè®¡ç®—å‡ºçš„é˜ˆå€¼æ²¡æœ‰è¶…å‡ºè®¾ç½®é˜ˆå€¼ï¼Œåˆ™ä¸éœ€è¦ä¸ºè¯¥èŠ‚ç‚¹ç§»åŠ¨slotã€‚åªè¦æœ‰ä¸€ä¸ªmasterçš„ç§»åŠ¨èŠ‚ç‚¹è¶…è¿‡é˜ˆå€¼ï¼Œå°±ä¼šè§¦å‘rebalanceæ“ä½œã€‚<br>5ã€å¦‚æœè§¦å‘äº†rebalanceæ“ä½œã€‚é‚£ä¹ˆå°±å¼€å§‹æ‰§è¡Œrebalanceæ“ä½œï¼Œå…ˆå°†æ¯ä¸ªèŠ‚ç‚¹å½“å‰åˆ†é…çš„slotsæ•°é‡å‡å»æœŸæœ›åˆ†é…çš„slotæ•°é‡è·å¾—balanceå€¼ã€‚å°†æ¯ä¸ªèŠ‚ç‚¹çš„balanceä»å°åˆ°å¤§è¿›è¡Œæ’åºè·å¾—snæ•°ç»„ã€‚<br>6ã€ç”¨dst_idxå’Œsrc_idxæ¸¸æ ‡åˆ†åˆ«ä»snæ•°ç»„çš„å¤´éƒ¨å’Œå°¾éƒ¨å¼€å§‹éå†ã€‚ç›®çš„æ˜¯ä¸ºäº†æŠŠå°¾éƒ¨èŠ‚ç‚¹çš„slotåˆ†é…ç»™å¤´éƒ¨èŠ‚ç‚¹ã€‚</arg></p>
<p>snæ•°ç»„ä¿å­˜çš„balanceåˆ—è¡¨æ’åºåï¼Œè´Ÿæ•°åœ¨å‰é¢ï¼Œæ­£æ•°åœ¨åé¢ã€‚è´Ÿæ•°è¡¨ç¤ºéœ€è¦æœ‰slotè¿å…¥ï¼Œæ‰€ä»¥ä½¿ç”¨dst_idxæ¸¸æ ‡ï¼Œæ­£æ•°è¡¨ç¤ºéœ€è¦æœ‰slotè¿å‡ºï¼Œæ‰€ä»¥ä½¿ç”¨src_idxæ¸¸æ ‡ã€‚ç†è®ºä¸Šsnæ•°ç»„å„èŠ‚ç‚¹çš„balanceå€¼åŠ èµ·æ¥åº”è¯¥ä¸º0ï¼Œä¸è¿‡ç”±äºåœ¨è®¡ç®—æœŸæœ›åˆ†é…çš„slotçš„æ—¶å€™åªæ˜¯ä½¿ç”¨ç›´æ¥å–æ•´çš„æ–¹å¼ï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°balanceå€¼ä¹‹å’Œä¸ä¸º0çš„æƒ…å†µï¼Œbalanceå€¼ä¹‹å’Œä¸ä¸º0å³ä¸ºèŠ‚ç‚¹ä¸å¹³è¡¡çš„slotæ•°é‡ï¼Œç”±äºslotæ€»æ•°æœ‰16384ä¸ªï¼Œä¸å¹³è¡¡æ•°é‡ç›¸å¯¹äºæ€»æ•°ï¼ŒåŸºæ•°å¾ˆå°ï¼Œæ‰€ä»¥å¯¹rebalanceæµç¨‹å½±å“ä¸å¤§ã€‚</p>
<p>7ã€è·å–sn[dst_idx]å’Œsn[src_idx]çš„balanceå€¼è¾ƒå°çš„é‚£ä¸ªå€¼ï¼Œè¯¥å€¼å³ä¸ºéœ€è¦ä»sn[src_idx]èŠ‚ç‚¹è¿ç§»åˆ°sn[dst_idx]èŠ‚ç‚¹çš„slotæ•°é‡ã€‚<br>8ã€æ¥ç€é€šè¿‡compute_reshard_tableæ–¹æ³•è®¡ç®—æºèŠ‚ç‚¹çš„slotå¦‚ä½•åˆ†é…åˆ°æºèŠ‚ç‚¹åˆ—è¡¨ã€‚è¿™ä¸ªæ–¹æ³•åœ¨reshardæµç¨‹ä¸­ä¹Ÿæœ‰è°ƒç”¨ï¼Œå…·ä½“æ­¥éª¤å¯ä»¥å‚è€ƒreshardæµç¨‹çš„ç¬¬å…­æ­¥ã€‚<br>9ã€å¦‚æœæ˜¯simulateæ¨¡å¼ï¼Œåˆ™åªæ˜¯æ‰“å°å‡ºè¿ç§»åˆ—è¡¨ã€‚<br>10ã€å¦‚æœæ²¡æœ‰è®¾ç½®simulateï¼Œåˆ™æ‰§è¡Œmove_slotæ“ä½œï¼Œè¿ç§»slotï¼Œä¼ å…¥çš„å‚æ•°ä¸º:quiet=&gt;true,:dots=&gt;false,:update=&gt;trueã€‚<br>11ã€è¿ç§»å®Œæˆåæ›´æ–°sn[dst_idx]å’Œsn[src_idx]çš„balanceå€¼ã€‚å¦‚æœbalanceå€¼ä¸º0åï¼Œæ¸¸æ ‡å‘å‰è¿›1ã€‚<br>12ã€ç›´åˆ°dst_idxåˆ°è¾¾src_idxæ¸¸æ ‡ï¼Œå®Œæˆæ•´ä¸ªrebalanceæ“ä½œã€‚</p>
<h1 id="add-nodeå°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#add-nodeå°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="headerlink" title="add-nodeå°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"></a>add-nodeå°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h1><p>add-nodeå‘½ä»¤å¯ä»¥å°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼ŒèŠ‚ç‚¹å¯ä»¥ä¸ºmasterï¼Œä¹Ÿå¯ä»¥ä¸ºæŸä¸ªmasterèŠ‚ç‚¹çš„slaveã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">add-node    new_host:new_port existing_host:existing_port</div><div class="line">          --slave</div><div class="line">          --master-id &lt;arg&gt;</div></pre></td></tr></table></figure></p>
<p>add-nodeæœ‰ä¸¤ä¸ªå¯é€‰å‚æ•°ï¼š<br>â€“slaveï¼šè®¾ç½®è¯¥å‚æ•°ï¼Œåˆ™æ–°èŠ‚ç‚¹ä»¥slaveçš„è§’è‰²åŠ å…¥é›†ç¾¤<br>â€“master-idï¼šè¿™ä¸ªå‚æ•°éœ€è¦è®¾ç½®äº†â€“slaveæ‰èƒ½ç”Ÿæ•ˆï¼Œâ€“master-idç”¨æ¥æŒ‡å®šæ–°èŠ‚ç‚¹çš„masterèŠ‚ç‚¹ã€‚å¦‚æœä¸è®¾ç½®è¯¥å‚æ•°ï¼Œåˆ™ä¼šéšæœºä¸ºèŠ‚ç‚¹é€‰æ‹©masterèŠ‚ç‚¹ã€‚<br>å¯ä»¥çœ‹ä¸‹add-nodeå‘½ä»¤çš„æ‰§è¡Œç¤ºä¾‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb add-node --slave --master-id dcb792b3e85726f012e83061bf237072dfc45f99 10.180.157.202:6379 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Adding node 10.180.157.202:6379 to cluster 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)</div><div class="line">M: dcb792b3e85726f012e83061bf237072dfc45f99 10.180.157.199:6379</div><div class="line">   slots:0-5460 (5461 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">M: 464d740bf48953ebcf826f4113c86f9db3a9baf3 10.180.157.201:6379</div><div class="line">   slots:10923-16383 (5461 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">M: befa7e17b4e5f239e519bc74bfef3264a40f96ae 10.180.157.200:6379</div><div class="line">   slots:5461-10922 (5462 slots) master</div><div class="line">   0 additional replica(s)</div><div class="line">[OK] All nodes agree about slots configuration.</div><div class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</div><div class="line">&gt;&gt;&gt; Check slots coverage...</div><div class="line">[OK] All 16384 slots covered.</div><div class="line">&gt;&gt;&gt; Send CLUSTER MEET to node 10.180.157.202:6379 to make it join the cluster.</div><div class="line">Waiting <span class="keyword">for</span> the cluster to join.</div><div class="line">&gt;&gt;&gt; Configure node as replica of 10.180.157.199:6379.</div><div class="line">[OK] New node added correctly.</div></pre></td></tr></table></figure></p>
<p>add-nodeæµç¨‹å¦‚ä¸‹ï¼š<br>1ã€é€šè¿‡load_cluster_info_from_nodeæ–¹æ³•è½¬è½½é›†ç¾¤ä¿¡æ¯ï¼Œcheck_clusteræ–¹æ³•æ£€æŸ¥é›†ç¾¤æ˜¯å¦å¥åº·ã€‚<br>2ã€å¦‚æœè®¾ç½®äº†â€“slaveï¼Œåˆ™éœ€è¦ä¸ºè¯¥èŠ‚ç‚¹å¯»æ‰¾masterèŠ‚ç‚¹ã€‚è®¾ç½®äº†â€“master-idï¼Œåˆ™ä»¥è¯¥èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„masterï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®â€“master-idï¼Œåˆ™è°ƒç”¨get_master_with_least_replicasæ–¹æ³•ï¼Œå¯»æ‰¾slaveæ•°é‡æœ€å°‘çš„masterèŠ‚ç‚¹ã€‚å¦‚æœslaveæ•°é‡ä¸€è‡´ï¼Œåˆ™é€‰å–load_cluster_info_from_nodeé¡ºåºå‘ç°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚load_cluster_info_from_nodeé¡ºåºçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯add-nodeè®¾ç½®çš„existing_host:existing_portèŠ‚ç‚¹ï¼Œåé¢çš„é¡ºåºæ ¹æ®åœ¨è¯¥èŠ‚ç‚¹æ‰§è¡Œcluster nodesè¿”å›çš„ç»“æœè¿”å›çš„èŠ‚ç‚¹é¡ºåºã€‚<br>3ã€è¿æ¥æ–°çš„èŠ‚ç‚¹å¹¶ä¸é›†ç¾¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ¡æ‰‹ã€‚<br>4ã€å¦‚æœæ²¡è®¾ç½®â€“slaveå°±ç›´æ¥è¿”å›okï¼Œè®¾ç½®äº†â€“slaveï¼Œåˆ™éœ€è¦ç­‰å¾…ç¡®è®¤æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œç„¶åæ‰§è¡Œcluster replicateå‘½ä»¤å¤åˆ¶masterèŠ‚ç‚¹ã€‚<br>5ã€è‡³æ­¤ï¼Œå®Œæˆäº†å…¨éƒ¨çš„å¢åŠ èŠ‚ç‚¹çš„æµç¨‹ã€‚</p>
<h1 id="del-nodeä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹"><a href="#del-nodeä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="del-nodeä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹"></a>del-nodeä»é›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹</h1><p>del-nodeå¯ä»¥æŠŠæŸä¸ªèŠ‚ç‚¹ä»é›†ç¾¤ä¸­åˆ é™¤ã€‚del-nodeåªèƒ½åˆ é™¤æ²¡æœ‰åˆ†é…slotçš„èŠ‚ç‚¹ã€‚åˆ é™¤å‘½ä»¤ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼š<br>host:portï¼šä»è¯¥èŠ‚ç‚¹è·å–é›†ç¾¤ä¿¡æ¯ã€‚<br>node_idï¼šéœ€è¦åˆ é™¤çš„èŠ‚ç‚¹idã€‚<br>del-nodeæ‰§è¡Œç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb del-node 10.180.157.199:6379 d5f6d1d17426bd564a6e309f32d0f5b96962fe53</div><div class="line">&gt;&gt;&gt; Removing node d5f6d1d17426bd564a6e309f32d0f5b96962fe53 from cluster 10.180.157.199:6379</div><div class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</div><div class="line">&gt;&gt;&gt; SHUTDOWN the node.</div></pre></td></tr></table></figure></p>
<p>del-nodeæµç¨‹å¦‚ä¸‹ï¼š<br>1ã€é€šè¿‡load_cluster_info_from_nodeæ–¹æ³•è½¬è½½é›†ç¾¤ä¿¡æ¯ã€‚<br>2ã€æ ¹æ®ä¼ å…¥çš„node idè·å–èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹æ²¡æ‰¾åˆ°ï¼Œåˆ™ç›´æ¥æç¤ºé”™è¯¯å¹¶é€€å‡ºã€‚<br>3ã€å¦‚æœèŠ‚ç‚¹åˆ†é…çš„slotä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥æç¤ºé”™è¯¯å¹¶é€€å‡ºã€‚<br>4ã€éå†é›†ç¾¤å†…çš„å…¶ä»–èŠ‚ç‚¹ï¼Œæ‰§è¡Œcluster forgetå‘½ä»¤ï¼Œä»æ¯ä¸ªèŠ‚ç‚¹ä¸­å»é™¤è¯¥èŠ‚ç‚¹ã€‚å¦‚æœåˆ é™¤çš„èŠ‚ç‚¹æ˜¯masterï¼Œè€Œä¸”å®ƒæœ‰slaveçš„è¯ï¼Œè¿™äº›slaveä¼šå»å¤åˆ¶å…¶ä»–masterï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯get_master_with_least_replicasï¼Œä¸add-nodeæ²¡è®¾ç½®â€“master-idå¯»æ‰¾masterçš„æ–¹æ³•ä¸€æ ·ã€‚<br>5ã€ç„¶åå…³é—­è¯¥èŠ‚ç‚¹</p>
<p>set-timeoutè®¾ç½®é›†ç¾¤èŠ‚ç‚¹é—´å¿ƒè·³è¿æ¥çš„è¶…æ—¶æ—¶é—´<br>set-timeoutç”¨æ¥è®¾ç½®é›†ç¾¤èŠ‚ç‚¹é—´å¿ƒè·³è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œä¸å¾—å°äº100æ¯«ç§’ï¼Œå› ä¸º100æ¯«ç§’å¯¹äºå¿ƒè·³æ—¶é—´æ¥è¯´å¤ªçŸ­äº†ã€‚è¯¥å‘½ä»¤ä¿®æ”¹æ˜¯èŠ‚ç‚¹é…ç½®å‚æ•°cluster-node-timeoutï¼Œé»˜è®¤æ˜¯15000æ¯«ç§’ã€‚é€šè¿‡è¯¥å‘½ä»¤ï¼Œå¯ä»¥ç»™æ¯ä¸ªèŠ‚ç‚¹è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè®¾ç½®çš„æ–¹å¼ä½¿ç”¨config setå‘½ä»¤åŠ¨æ€è®¾ç½®ï¼Œç„¶åæ‰§è¡Œconfig rewriteå‘½ä»¤å°†é…ç½®æŒä¹…åŒ–ä¿å­˜åˆ°ç¡¬ç›˜ã€‚ä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ruby redis-trib.rb <span class="built_in">set</span>-timeout 10.180.157.199:6379 30000</div><div class="line">&gt;&gt;&gt; Reconfiguring node timeout <span class="keyword">in</span> every cluster node...</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.199:6379</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.205:6379</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.201:6379</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.200:6379</div><div class="line">*** New timeout <span class="built_in">set</span> <span class="keyword">for</span> 10.180.157.208:6379</div><div class="line">&gt;&gt;&gt; New node timeout <span class="built_in">set</span>. 5 OK, 0 ERR.</div></pre></td></tr></table></figure></p>
<h1 id="callåœ¨é›†ç¾¤å…¨éƒ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤"><a href="#callåœ¨é›†ç¾¤å…¨éƒ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤" class="headerlink" title="callåœ¨é›†ç¾¤å…¨éƒ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤"></a>callåœ¨é›†ç¾¤å…¨éƒ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤</h1><p>callå‘½ä»¤å¯ä»¥ç”¨æ¥åœ¨é›†ç¾¤çš„å…¨éƒ¨èŠ‚ç‚¹æ‰§è¡Œç›¸åŒçš„å‘½ä»¤ã€‚callå‘½ä»¤ä¹Ÿæ˜¯éœ€è¦é€šè¿‡é›†ç¾¤çš„ä¸€ä¸ªèŠ‚ç‚¹åœ°å€ï¼Œè¿ä¸Šæ•´ä¸ªé›†ç¾¤ï¼Œç„¶ååœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œè¯¥å‘½ä»¤ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ruby</span> redis-trib.rb call 10.180.157.199:6379 get key</div><div class="line">&gt;&gt;&gt; Calling GET key</div><div class="line">10.180.157.199:6379: MOVED 12539 10.180.157.201:6379</div><div class="line">10.180.157.205:6379: MOVED 12539 10.180.157.201:6379</div><div class="line">10.180.157.201:6379:</div><div class="line">10.180.157.200:6379: MOVED 12539 10.180.157.201:6379</div><div class="line">10.180.157.208:6379: MOVED 12539 10.180.157.201:6379</div></pre></td></tr></table></figure></p>
<h1 id="importå°†å¤–éƒ¨redisæ•°æ®å¯¼å…¥é›†ç¾¤"><a href="#importå°†å¤–éƒ¨redisæ•°æ®å¯¼å…¥é›†ç¾¤" class="headerlink" title="importå°†å¤–éƒ¨redisæ•°æ®å¯¼å…¥é›†ç¾¤"></a>importå°†å¤–éƒ¨redisæ•°æ®å¯¼å…¥é›†ç¾¤</h1><p>importå‘½ä»¤å¯ä»¥æŠŠå¤–éƒ¨çš„redisèŠ‚ç‚¹æ•°æ®å¯¼å…¥é›†ç¾¤ã€‚å¯¼å…¥çš„æµç¨‹å¦‚ä¸‹ï¼š<br>1ã€é€šè¿‡load_cluster_info_from_nodeæ–¹æ³•è½¬è½½é›†ç¾¤ä¿¡æ¯ï¼Œcheck_clusteræ–¹æ³•æ£€æŸ¥é›†ç¾¤æ˜¯å¦å¥åº·ã€‚<br>2ã€è¿æ¥å¤–éƒ¨redisèŠ‚ç‚¹ï¼Œå¦‚æœå¤–éƒ¨èŠ‚ç‚¹å¼€å¯äº†cluster_enabledï¼Œåˆ™æç¤ºé”™è¯¯ã€‚<br>3ã€é€šè¿‡scanå‘½ä»¤éå†å¤–éƒ¨èŠ‚ç‚¹ï¼Œä¸€æ¬¡è·å–1000æ¡æ•°æ®ã€‚<br>4ã€éå†è¿™äº›keyï¼Œè®¡ç®—å‡ºkeyå¯¹åº”çš„slotã€‚<br>5ã€æ‰§è¡Œmigrateå‘½ä»¤,æºèŠ‚ç‚¹æ˜¯å¤–éƒ¨èŠ‚ç‚¹,ç›®çš„èŠ‚ç‚¹æ˜¯é›†ç¾¤slotå¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æœè®¾ç½®äº†â€“copyå‚æ•°ï¼Œåˆ™ä¼ é€’copyå‚æ•°ï¼Œå¦‚æœè®¾ç½®äº†â€“replaceï¼Œåˆ™ä¼ é€’replaceå‚æ•°ã€‚<br>6ã€ä¸åœæ‰§è¡Œscanå‘½ä»¤ï¼Œç›´åˆ°éå†å®Œå…¨éƒ¨çš„keyã€‚<br>7ã€è‡³æ­¤å®Œæˆæ•´ä¸ªè¿ç§»æµç¨‹<br>è¿™ä¸­é—´å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œç¨‹åºå°±ä¼šåœæ­¢ã€‚æ²¡ä½¿ç”¨â€“copyæ¨¡å¼ï¼Œåˆ™å¯ä»¥é‡æ–°æ‰§è¡Œimportå‘½ä»¤ï¼Œä½¿ç”¨â€“copyçš„è¯ï¼Œæœ€å¥½æ¸…ç©ºæ–°çš„é›†ç¾¤å†å¯¼å…¥ä¸€æ¬¡ã€‚</p>
<p>importå‘½ä»¤æ›´é€‚åˆç¦»çº¿çš„æŠŠå¤–éƒ¨Redisæ•°æ®å¯¼å…¥ï¼Œåœ¨çº¿å¯¼å…¥çš„è¯æœ€å¥½ä½¿ç”¨æ›´ä¸“ä¸šçš„å¯¼å…¥å·¥å…·ï¼Œä»¥slaveçš„æ–¹å¼è¿æ¥redisèŠ‚ç‚¹å»åŒæ­¥èŠ‚ç‚¹æ•°æ®åº”è¯¥æ˜¯æ›´å¥½çš„æ–¹å¼ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./redis-trib.rb import --from 10.0.10.1:6379 10.10.10.1:7000</div><div class="line">ä¸Šé¢çš„å‘½ä»¤æ˜¯æŠŠ 10.0.10.1:6379ï¼ˆredis 2.8ï¼‰ä¸Šçš„æ•°æ®å¯¼å…¥åˆ° 10.10.10.1:7000è¿™ä¸ªèŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤</div></pre></td></tr></table></figure></p>
<p>åŸæ–‡åœ°å€<a href="http://blog.csdn.net/huwei2003/article/details/50973967" target="_blank" rel="external">http://blog.csdn.net/huwei2003/article/details/50973967</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;redis-trib.rbæ˜¯rediså®˜æ–¹æ¨å‡ºçš„ç®¡ç†redisé›†ç¾¤çš„å·¥å…·ï¼Œé›†æˆåœ¨redisçš„æºç srcç›®å½•ä¸‹ï¼Œæ˜¯åŸºäºredisæä¾›çš„é›†ç¾¤å‘½ä»¤å°è£…æˆç®€å•ã€ä¾¿æ·ã€å®ç”¨çš„æ“ä½œå·¥å…·ã€‚redis-trib.rbæ˜¯redisä½œè€…ç”¨rubyå®Œæˆçš„ã€‚ä¸ºäº†çœ‹æ‡‚redis-trib.rbï¼Œæˆ‘ç‰¹æ„èŠ±äº†ä¸€ä¸ªæ˜ŸæœŸå­¦ä¹ äº†rubyï¼Œä¹Ÿè¢«rubyçš„ç®€æ´ã€æ˜äº†æ‰€å¸å¼•ã€‚rubyæ˜¯é—¨éå¸¸çµæ´»çš„è¯­è¨€ï¼Œredis-trib.rbåªç”¨äº†1600è¡Œå·¦å³çš„ä»£ç ï¼Œå°±å®ç°äº†å¼ºå¤§çš„é›†ç¾¤æ“ä½œã€‚æœ¬æ–‡å¯¹redis-trib.rbçš„ä»‹ç»æ˜¯åŸºäºredis 3.0.6ç‰ˆæœ¬çš„æºç ã€‚é˜…è¯»æœ¬æ–‡éœ€è¦å¯¹redisé›†ç¾¤åŠŸèƒ½æœ‰ä¸€å®šçš„äº†è§£ã€‚å…³äºredisé›†ç¾¤åŠŸèƒ½çš„ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒæœ¬äººçš„å¦ä¸€ç¯‡æ–‡ç« ã€Šredis3.0 clusteråŠŸèƒ½ä»‹ç»ã€‹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="redis" scheme="http://idiotsky.me/categories/redis/"/>
    
    
      <category term="redis" scheme="http://idiotsky.me/tags/redis/"/>
    
  </entry>
  
</feed>
