<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[openstackå®‰è£…å‡†å¤‡(ä¸€)]]></title>
    <url>%2F2017%2F08%2F18%2Fopenstack-install-prepare-1%2F</url>
    <content type="text"><![CDATA[æ­£åœ¨å†™ã€‚ã€‚ã€‚ å‡†å¤‡VMwareç”±äºŽæˆ‘æ˜¯ä¹ æƒ¯äº†macä¸Šåšå®žéªŒï¼Œæ‰€ä»¥ç”¨VMware fusionï¼Œéšä¾¿ä¸‹ä¸ªç ´è§£ç‰ˆå³å¯ã€‚ å‡†å¤‡UbuntuUbuntuåŽ»å®˜ç½‘ä¸‹è½½16.04çš„æœåŠ¡å™¨ç‰ˆæœ¬çš„ISOå³å¯ã€‚ å‡†å¤‡ç½‘ç»œè¿™æ¬¡å®žéªŒç”¨åˆ°ä¸¤å°è™šæ‹Ÿæœºï¼š controller,computehostname:controller æŽ¥å£ ip æ¨¡å¼ ens33 192.168.199.10 æ¡¥æŽ¥ ens34 192.168.5.10 ç§æœ‰ ens35 192.168.112.10 nat hostname:compute æŽ¥å£ ip æ¨¡å¼ ens33 192.168.199.11 æ¡¥æŽ¥ ens34 192.168.5.11 ç§æœ‰ PS: æ¡¥æŽ¥æ¨¡å¼æ˜¯è™šæ‹Ÿæœºå¯ä»¥æ›´ç‰©ç†æœºæ‰€åœ¨ç½‘ç»œå…±äº«ä¸€å¥—ç½‘ç»œï¼Œä¾‹å¦‚è·Ÿç‰©ç†æœºåŒä¸€ä¸ªWiFié‡Œé¢çš„è®¾å¤‡éƒ½å¯ä»¥è®¿é—®ç‰©ç†æœºé‡Œé¢çš„è™šæ‹Ÿæœºã€‚ä¸€èˆ¬ç”¨æ¥åšç®¡ç†èŠ‚ç‚¹çš„ç½‘ç»œã€‚ ç§æœ‰æ¨¡å¼ä»£è¡¨è™šæ‹Ÿæœºåªèƒ½è·Ÿç‰©ç†æœºä½œä¸ºä¸€ä¸ªç½‘ç»œï¼Œå…¶ä»–è®¾å¤‡è®¿é—®ä¸äº†ï¼Œä¸€èˆ¬å¯ä»¥ç”¨æ¥åšå†…éƒ¨ç½‘ç»œ natæ¨¡å¼ç”¨æ¥ç»™è™šæ‹Ÿæœºè®¿é—®äº’è”ç½‘ç”¨ ä¸Šé¢ç½‘ç»œé…ç½®å¥½åŽï¼Œå¯ä»¥å¼€æžäº†ï¼Œè‡³äºŽæ€Žä¹ˆå®‰è£…è™šæ‹Ÿæœºå’Œé…ç½®ç½‘ç»œï¼Œå¯ä»¥æœç´¢ç›¸å…³æ–‡ç« ðŸ˜ˆã€‚]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[openstackå®‰è£…ç´¢å¼•]]></title>
    <url>%2F2017%2F08%2F16%2Fopenstack-install-index%2F</url>
    <content type="text"><![CDATA[ç´¢å¼•é¡µ openstackå®‰è£…å‡†å¤‡(ä¸€)]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸€å¼ å›¾äº†è§£ä¸‰è‰²æ ‡è®°æ³•]]></title>
    <url>%2F2017%2F08%2F16%2Fgc-three-color%2F</url>
    <content type="text"><![CDATA[ä¸‰è‰²æ ‡è®°æ³•æ˜¯ä¼ ç»Ÿ Mark-Sweep çš„ä¸€ä¸ªæ”¹è¿›ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¹¶å‘çš„ GC ç®—æ³•ã€‚åŽŸç†å¦‚ä¸‹ï¼Œ é¦–å…ˆåˆ›å»ºä¸‰ä¸ªé›†åˆï¼šç™½ã€ç°ã€é»‘ã€‚ å°†æ‰€æœ‰å¯¹è±¡æ”¾å…¥ç™½è‰²é›†åˆä¸­ã€‚ ç„¶åŽä»Žæ ¹èŠ‚ç‚¹å¼€å§‹éåŽ†æ‰€æœ‰å¯¹è±¡ï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸é€’å½’éåŽ†ï¼‰ï¼ŒæŠŠéåŽ†åˆ°çš„å¯¹è±¡ä»Žç™½è‰²é›†åˆæ”¾å…¥ç°è‰²é›†åˆã€‚ ä¹‹åŽéåŽ†ç°è‰²é›†åˆï¼Œå°†ç°è‰²å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ä»Žç™½è‰²é›†åˆæ”¾å…¥ç°è‰²é›†åˆï¼Œä¹‹åŽå°†æ­¤ç°è‰²å¯¹è±¡æ”¾å…¥é»‘è‰²é›†åˆ é‡å¤ 4 ç›´åˆ°ç°è‰²ä¸­æ— ä»»ä½•å¯¹è±¡ é€šè¿‡write-barrieræ£€æµ‹å¯¹è±¡æœ‰å˜åŒ–ï¼Œé‡å¤ä»¥ä¸Šæ“ä½œ æ”¶é›†æ‰€æœ‰ç™½è‰²å¯¹è±¡ï¼ˆåžƒåœ¾ï¼‰ è¿™ä¸ªç®—æ³•å¯ä»¥å®žçŽ° â€œon-the-flyâ€ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¨‹åºæ‰§è¡Œçš„åŒæ—¶è¿›è¡Œæ”¶é›†ï¼Œå¹¶ä¸éœ€è¦æš‚åœæ•´ä¸ªç¨‹åºã€‚ä½†æ˜¯ä¹Ÿä¼šæœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå¯èƒ½ç¨‹åºä¸­çš„åžƒåœ¾äº§ç”Ÿçš„é€Ÿåº¦ä¼šå¤§äºŽåžƒåœ¾æ”¶é›†çš„é€Ÿåº¦ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç¨‹åºä¸­çš„åžƒåœ¾è¶Šæ¥è¶Šå¤šæ— æ³•è¢«æ”¶é›†æŽ‰ã€‚]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>gc</tag>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸€å¼ å›¾äº†è§£æ ‡è®°æ¸…é™¤ç®—æ³•]]></title>
    <url>%2F2017%2F08%2F16%2Fgc-mark-sweep%2F</url>
    <content type="text"><![CDATA[è¿™ä¸ªç®—æ³•åˆ†ä¸ºä¸¤æ­¥ï¼Œæ ‡è®°å’Œæ¸…é™¤ã€‚ æ ‡è®°ï¼šä»Žç¨‹åºçš„æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œ é€’å½’åœ° éåŽ†æ‰€æœ‰å¯¹è±¡ï¼Œå°†èƒ½éåŽ†åˆ°çš„å¯¹è±¡æ‰“ä¸Šæ ‡è®°ã€‚ æ¸…é™¤ï¼šè®²æ‰€æœ‰æœªæ ‡è®°çš„çš„å¯¹è±¡å½“ä½œåžƒåœ¾é”€æ¯ã€‚ ä½†æ˜¯è¿™ä¸ªç®—æ³•ä¹Ÿæœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå°±æ˜¯äººä»¬å¸¸å¸¸è¯´çš„ STW é—®é¢˜ï¼ˆStop The Worldï¼‰ã€‚å› ä¸ºç®—æ³•åœ¨æ ‡è®°æ—¶å¿…é¡»æš‚åœæ•´ä¸ªç¨‹åºï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹çš„ä»£ç å¯èƒ½ä¼šæ”¹å˜å¯¹è±¡çŠ¶æ€ï¼Œä»Žè€Œå¯èƒ½æŠŠä¸åº”è¯¥å›žæ”¶çš„å¯¹è±¡å½“åšåžƒåœ¾æ”¶é›†æŽ‰ã€‚å½“ç¨‹åºä¸­çš„å¯¹è±¡é€æ¸å¢žå¤šæ—¶ï¼Œé€’å½’éåŽ†æ•´ä¸ªå¯¹è±¡æ ‘ä¼šæ¶ˆè€—å¾ˆå¤šçš„æ—¶é—´ï¼Œåœ¨å¤§åž‹ç¨‹åºä¸­è¿™ä¸ªæ—¶é—´å¯èƒ½ä¼šæ˜¯æ¯«ç§’çº§åˆ«çš„ã€‚è®©æ‰€æœ‰çš„ç”¨æˆ·ç­‰å¾…å‡ ç™¾æ¯«ç§’çš„ GC æ—¶é—´è¿™æ˜¯ä¸èƒ½å®¹å¿çš„ã€‚]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>gc</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[postmançš„å‡ ç§bodyçš„ä½¿ç”¨ä»‹ç»]]></title>
    <url>%2F2017%2F08%2F10%2Fpostman%2F</url>
    <content type="text"><![CDATA[postman,ç”¨æ¥æ¨¡æ‹Ÿå‘é€httpè¯·æ±‚çš„å·¥å…·ï¼Œé‡Œé¢æ¶‰åŠçš„è¯·æ±‚bodyæœ‰ä»¥ä¸‹å‡ ä¸ªç±»åž‹ï¼Œæ‰€ä»¥è®°ä¸‹ï¼Œè€Œä¸”ä¹Ÿèƒ½ç†è§£http bodyçš„å‡ ç§æ ¼å¼ï¼Œåˆ†äº«ä¹‹ã€‚ã€‚ form-dataå°±æ˜¯httpè¯·æ±‚ä¸­çš„multipart/form-data,å®ƒä¼šå°†è¡¨å•çš„æ•°æ®å¤„ç†ä¸ºä¸€æ¡æ¶ˆæ¯ï¼Œä»¥æ ‡ç­¾ä¸ºå•å…ƒï¼Œç”¨åˆ†éš”ç¬¦åˆ†å¼€ã€‚æ—¢å¯ä»¥ä¸Šä¼ é”®å€¼å¯¹ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚å½“ä¸Šä¼ çš„å­—æ®µæ˜¯æ–‡ä»¶æ—¶ï¼Œä¼šæœ‰Content-Typeæ¥è¡¨åæ–‡ä»¶ç±»åž‹ï¼›content-dispositionï¼Œç”¨æ¥è¯´æ˜Žå­—æ®µçš„ä¸€äº›ä¿¡æ¯ï¼›ç”±äºŽæœ‰boundaryéš”ç¦»ï¼Œæ‰€ä»¥multipart/form-dataæ—¢å¯ä»¥ä¸Šä¼ æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ é”®å€¼å¯¹ï¼Œå®ƒé‡‡ç”¨äº†é”®å€¼å¯¹çš„æ–¹å¼ï¼Œæ‰€ä»¥å¯ä»¥ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ã€‚ å†…å®¹ä¸º12345678910111213141516171819202122232425POST /login HTTP/1.1Host: 10.170.56.67Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gWCache-Control: no-cachePostman-Token: 9843651a-5bf9-0544-03c1-fcc2a16f484b------WebKitFormBoundary7MA4YWxkTrZu0gWContent-Disposition: form-data; name=&quot;username&quot;admin------WebKitFormBoundary7MA4YWxkTrZu0gWContent-Disposition: form-data; name=&quot;password&quot;admin123------WebKitFormBoundary7MA4YWxkTrZu0gWContent-Disposition: form-data; name=&quot;abc&quot;; filename=&quot;&quot;Content-Type: ------WebKitFormBoundary7MA4YWxkTrZu0gWContent-Disposition: form-data; name=&quot;tttt&quot;; filename=&quot;&quot;Content-Type: ------WebKitFormBoundary7MA4YWxkTrZu0gW-- x-www-form-urlencodedå°±æ˜¯application/x-www-from-urlencoded,ä¼šå°†è¡¨å•å†…çš„æ•°æ®è½¬æ¢ä¸ºé”®å€¼å¯¹ï¼Œå¹¶ä»¥urlencodeä¸ºæ ¼å¼å†…å®¹ä¸º1234567POST /login HTTP/1.1Host: 10.170.56.67Content-Type: application/x-www-form-urlencodedCache-Control: no-cachePostman-Token: e6887900-a46e-2ff4-8232-de878b75f5fdusername=admin&amp;password=admin123 rawå¯ä»¥ä¸Šä¼ ä»»æ„æ ¼å¼çš„æ–‡æœ¬ï¼Œå¯ä»¥ä¸Šä¼ textã€jsonã€xmlã€htmlç­‰å†…å®¹ä¸º12345678910POST /login HTTP/1.1Host: 10.170.56.67Content-Type: application/jsonCache-Control: no-cachePostman-Token: 233df0e0-c6d9-98c7-4d7e-736329322683&#123; &quot;abc&quot;:&quot;cba&quot;, &quot;cba&quot;:&quot;abc&quot;&#125; ä»Žå›¾ç‰‡å’Œå†…å®¹å¯¹æ¯”ï¼Œå¯ä»¥å‘çŽ°ï¼ŒåŸºæœ¬ï¼Œç²˜ä»€ä¹ˆï¼Œå°±å‘ä»€ä¹ˆï¼Œä¸ä¼šè¿›è¡Œä»»ä½•è½¬æ„ã€‚ binaryç›¸å½“äºŽContent-Type:application/octet-stream,ä»Žå­—é¢æ„æ€å¾—çŸ¥ï¼Œåªå¯ä»¥ä¸Šä¼ äºŒè¿›åˆ¶æ•°æ®ï¼Œé€šå¸¸ç”¨æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œç”±äºŽæ²¡æœ‰é”®å€¼ï¼Œæ‰€ä»¥ï¼Œä¸€æ¬¡åªèƒ½ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ã€‚ multipart/form-dataä¸Žx-www-form-urlencodedåŒºåˆ« multipart/form-dataï¼šæ—¢å¯ä»¥ä¸Šä¼ æ–‡ä»¶ç­‰äºŒè¿›åˆ¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ è¡¨å•é”®å€¼å¯¹ï¼Œåªæ˜¯æœ€åŽä¼šè½¬åŒ–ä¸ºä¸€æ¡ä¿¡æ¯ï¼› x-www-form-urlencodedï¼šåªèƒ½ä¸Šä¼ é”®å€¼å¯¹ï¼Œå¹¶ä¸”é”®å€¼å¯¹éƒ½æ˜¯é—´éš”åˆ†å¼€çš„]]></content>
      <categories>
        <category>http</category>
      </categories>
      <tags>
        <tag>postman</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[goçš„æ˜¯å¦éœ€è¦ç”¨goroutine poolï¼Ÿ]]></title>
    <url>%2F2017%2F08%2F03%2Fgo-worker-pool-if-need%2F</url>
    <content type="text"><![CDATA[è¿™å‡ å¤©æ— èŠï¼Œæƒ³åˆ°javaæœ‰è‡ªå·±çš„çº¿ç¨‹æ± ï¼Œæ˜¯å¦å¯¹åº”goä¹Ÿæœ‰å®ƒçš„goroutine poolå‘¢ï¼Œæ‰€ä»¥æœäº†ä¸‹ï¼Œæ ‡å‡†åº“æ²¡æœ‰ï¼Œgithubæœ‰ï¼Œä½†éƒ½å¤§åŒå°å¼‚ï¼Œæ‰€ä»¥è‡ªå·±å®žçŽ°äº†ä¸€ä¸ªã€‚ ä¸€ä¸ªç®€å•çš„goroutine pool12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758package workerpoolimport ( "sync" "fmt")type task func()type worker struct &#123; stopC chan bool&#125;type WorkerPool struct &#123; num int sync.Mutex taskQ chan task workers []*worker&#125;func NewWorkerPool(workerNum int,queueCap int) *WorkerPool&#123; return &amp;WorkerPool&#123;num:workerNum,taskQ:make(chan task,queueCap),workers:make([]*worker,workerNum)&#125;&#125;func (wp *WorkerPool) Execute(t task)&#123; wp.taskQ&lt;-t&#125;func (wp *WorkerPool) Start() *WorkerPool&#123; for i:=0;i&lt;wp.num;i++&#123; wp.workers[i]=&amp;worker&#123; make(chan bool)&#125; w:=wp.workers[i] go func(i int) &#123; for &#123; stop:=false select &#123; case f:=&lt;-wp.taskQ: f() case stop=&lt;-w.stopC: break &#125; if stop&#123; break &#125; &#125; fmt.Println("stop") &#125;(i) &#125; return wp&#125;func (wp *WorkerPool) Stop()&#123; for _,w:=range wp.workers&#123; w.stopC&lt;- true &#125;&#125; ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯NewWorkerPoolä¸€ä¸ªæ± å­çš„æ—¶å€™è®¾ç½®goroutineçš„æ•°é‡å’Œä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°ã€‚StartåŽå°±åˆ›å»ºé‚£ä¹ˆå¤šgoroutineåŽ»ä»»åŠ¡é˜Ÿåˆ—å–ä»»åŠ¡æ‰§è¡Œï¼Œå–ä¸åˆ°ä»»åŠ¡å°±è‡ªå¾ªã€‚Executeæ–¹æ³•æ˜¯æŠŠä»»åŠ¡åŽ‹è¿›é˜Ÿåˆ—ï¼Œå¦‚æžœé˜Ÿåˆ—æ»¡äº†å°±é˜»å¡žã€‚ æ€§èƒ½è¦æµ‹è¯•æ€§èƒ½ï¼Œè‚¯å®šè¦æœ‰å¯¹æ¯”ï¼Œä»¥ä¸‹æ˜¯æ²¡æœ‰ä½¿ç”¨pool:1234567891011121314func nopool() &#123; wg := new(sync.WaitGroup) //æ‰§è¡Œ1000000æ¬¡ï¼Œæ¯æ¬¡éƒ½å¯åŠ¨ä¸€ä¸ªgoroutine for i := 0; i &lt; 1000000; i++ &#123; wg.Add(1) go func(n int) &#123; for j := 0; j &lt; 100000; j++ &#123; &#125; defer wg.Done() &#125;(i) &#125; wg.Wait()&#125; ä»¥ä¸‹æ˜¯ç®€å•ç‰ˆçš„åªæ˜¯å•çº¯é™åˆ¶goroutineæ•°é‡å’Œä»»åŠ¡é˜Ÿåˆ—çš„ä»£ç ï¼Œæ²¡æœ‰ä»»ä½•å°è£…çš„:12345678910111213141516171819202122232425262728func gopool() &#123; wg := new(sync.WaitGroup) //é˜Ÿåˆ—100 data := make(chan int, 100) //goroutine æ•°é‡10ä¸ª for i := 0; i &lt; 10; i++ &#123; wg.Add(1) go func(n int) &#123; defer wg.Done() for _ = range data &#123; func()&#123; for j := 0; j &lt; 100000; j++ &#123; &#125; &#125;() &#125; &#125;(i) &#125; //æ‰§è¡Œ1000000ä¸ªä»»åŠ¡ for i := 0; i &lt; 1000000; i++ &#123; data &lt;- i &#125; close(data) wg.Wait()&#125; ç„¶åŽæ˜¯ä¸»è§’:123456789101112131415161718func workerpool() &#123; wg := new(sync.WaitGroup) //åä¸ªgoroutineï¼Œé˜Ÿåˆ—å®¹é‡100 wp:=NewWorkerPool(10,100) wp.Start() //æäº¤1000000ä»»åŠ¡ for i := 0; i &lt; 1000000; i++ &#123; wg.Add(1) wp.Execute(func() &#123; for j := 0; j &lt; 100000; j++ &#123; &#125; wg.Done() &#125;) &#125; wg.Wait()&#125; ä¸Šé¢ä»£ç åŸºæœ¬éƒ½æ˜¯åšåŒæ ·ä¸€ä»¶äº‹ï¼Œä½†æ˜¯åŽä¸¤ä¸ªåªå¼€10ä¸ªgoroutineï¼Œç¬¬ä¸€ä¸ªå°±å¼€äº†1000000ä¸ªï¼Œç»“æžœï¼š123BenchmarkNopool-8 1 7966900091 ns/opBenchmarkGopool-8 1 7949844269 ns/opBenchmarkWorkerPool-8 1 7997732135 ns/op å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ²¡æœ‰åŒºåˆ«ï¼Œé‡æ–°runå‡ æ¬¡åŸºæœ¬æ²¡æœ‰å¤šå¤§å˜åŒ–ã€‚ æ€»ç»“ç”±äºŽgoæœ¬èº«æœ‰å¯¹goroutineæœ‰è°ƒåº¦ï¼Œæ‰€ä»¥è‡ªå·±å®žçŽ°çš„æ± å­æ¥è°ƒåº¦å…¶å®žå¥½åƒæ²¡æœ‰ä»€ä¹ˆç”¨ã€‚è¿˜æœ‰å¯èƒ½æˆ‘è‡ªå·±èƒ½åŠ›å®žçŽ°ä¸å¥½ï¼Œæ²¡å‘æŒ¥æ± å­çš„ä½œç”¨ðŸ˜€ã€‚ä½†æ˜¯ç”¨æ›´å°‘çš„goroutineèƒ½å®ŒæˆåŒæ ·çš„äº‹æƒ…ï¼Œåº”è¯¥æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œè€Œä¸”è¿™é‡Œçš„goroutineæ‰§è¡Œéƒ½æ˜¯ç®€å•çš„å¾ªçŽ¯ï¼Œæ²¡æœ‰å¤æ‚çš„ä¸šåŠ¡ï¼Œä¸€æ—¦ä¸šåŠ¡å¤æ‚ï¼Œæ›´å°‘goroutineèƒ½å¤Ÿå‡å°‘å†…å­˜å’Œgoroutineåˆ‡æ¢æ—¶çš„cpuèµ„æºï¼Œæœ‰å¯èƒ½ä¸Šé¢æ€§èƒ½çš„æ¯”è¾ƒä¼šæ‹‰å¼€ã€‚]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ©ç”¨æ ‘èŽ“æ´¾æ­å»ºä¸€ä¸ªç®€æ˜“çš„NAS]]></title>
    <url>%2F2017%2F07%2F20%2Fraspberry-nas%2F</url>
    <content type="text"><![CDATA[å‡†å¤‡ raspberry pi 3 ç¡¬ç›˜ï¼ˆæ ¼å¼åŒ–è¿‡ext4çš„ï¼‰ è¿žæŽ¥raspberryç”¨çš„ç»ˆç«¯ å®‰è£…samba12sudo apt-get updatesudo apt-get install samba samba-common-bin é…ç½®samba12sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.backsudo vim /etc/samba/smb.conf 1234567891011121314151617# åœ¨æœ«å°¾åŠ å…¥å¦‚ä¸‹å†…å®¹# åˆ†äº«åç§°[MyNAS]# è¯´æ˜Žä¿¡æ¯comment = NAS Storage# å¯ä»¥è®¿é—®çš„ç”¨æˆ·valid users = pi,root# å…±äº«æ–‡ä»¶çš„è·¯å¾„,raspberry pi ä¼šè‡ªåŠ¨å°†è¿žæŽ¥åˆ°å…¶ä¸Šçš„å¤–æŽ¥å­˜å‚¨è®¾å¤‡æŒ‚è½½åˆ°/media/pi/ç›®å½•ä¸‹ã€‚path = /media/pi/# å¯è¢«å…¶ä»–äººçœ‹åˆ°èµ„æºåç§°ï¼ˆéžå†…å®¹ï¼‰browseable = yes# å¯å†™writable = yes# æ–°å»ºæ–‡ä»¶çš„æƒé™ä¸º 664create mask = 0664# æ–°å»ºç›®å½•çš„æƒé™ä¸º 775directory mask = 0775 å¯ä»¥æŠŠé…ç½®æ–‡ä»¶ä¸­ä½ ä¸éœ€è¦çš„åˆ†äº«åç§°åˆ é™¤ï¼Œä¾‹å¦‚ [homes], [printers] ç­‰ã€‚æµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰é”™è¯¯ï¼Œæ ¹æ®æç¤ºåšç›¸åº”ä¿®æ”¹1testparm æ·»åŠ ç™»é™†è´¦æˆ·å¹¶åˆ›å»ºå¯†ç ï¼Œå¿…é¡»æ˜¯ linux å·²å­˜åœ¨çš„ç”¨æˆ·1sudo smbpasswd -a pi é‡å¯ samba æœåŠ¡1sudo /etc/init.d/samba restart è¿žæŽ¥ä¸€èˆ¬æ ‘èŽ“æ´¾è·Ÿä½ çš„WiFiç›¸è¿žçš„è¯ï¼Œä½ çš„ç½‘ç»œå°±èƒ½çœ‹åˆ°è·Ÿä¸Šé¢é…ç½®ä¸€æ ·çš„åˆ†äº«åç§°ï¼Œå¦‚macä¸Šé¢è¿™æ ·çš„æ˜¾ç¤ºï¼šå¦‚æžœæ˜¾ç¤ºæ²¡æƒé™ï¼Œå¯ä»¥æ–­å¼€è¿žæŽ¥ï¼Œç”¨ä½ ä¸Šé¢æ·»åŠ çš„è´¦å·ç™»å½•ã€‚]]></content>
      <categories>
        <category>raspberrypi</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>raspberrypi</tag>
        <tag>NAS</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ©ç”¨æ ‘èŽ“æ´¾å®žçŽ°ä¸€ä¸ªèƒ½æ’­æ”¾å¤©æ°”çš„é—¹é’Ÿ]]></title>
    <url>%2F2017%2F07%2F18%2Fraspberry-weather-clock%2F</url>
    <content type="text"><![CDATA[å‰æä½ è¦æœ‰ä¸ªpiðŸ˜„ èŽ·å–å¤©æ°”æŽ¥å£è¿™é‡Œæˆ‘æ˜¯ç”¨å›¾çµæœºå™¨äººæ¥èŽ·å–å¤©æ°”çš„æŽ¥å£ï¼Œä½ å¯ä»¥è‡ªå·±ä¸ŠåŽ»æ³¨å†Œä¸€ä¸ªï¼Œä¸‹é¢ä»£ç URLçš„Keyæ˜¯æˆ‘æ³¨å†Œçš„æœºå™¨äººç»™çš„ã€‚1234567891011def getWeatherText(): try: response = requests.get( "http://www.tuling123.com/openapi/api?key=652ae4a714794fe6b01faa990d7a981f&amp;info=%s" % "å¹¿å·žä»Šæ—¥å¤©æ°”") json = response.json() if json["code"] == 100000: return json["text"] else: return "" except: return "" æ’­æ”¾æ–‡å­—åˆ©ç”¨ç™¾åº¦çš„æŽ¥å£å¯ä»¥è½¬æ¢æ–‡æœ¬ä¸ºè¯­éŸ³ã€‚é»˜è®¤åªæœ‰å¥³å£°12345def text2voice(text): url = 'http://tts.baidu.com/text2audio?idx=1&amp;tex=&#123;0&#125;&amp;cuid=baidu_speech_' \ 'demo&amp;cod=2&amp;lan=zh&amp;ctp=1&amp;pdt=1&amp;spd=4&amp;per=4&amp;vol=5&amp;pit=5'.format(text) # ç”¨mplayeræ’­æ”¾è¯­éŸ³ os.system('mplayer "%s"' % url) å®‰è£…æ’­æ”¾åª’ä½“è½¯ä»¶ä¸Šé¢ä»£ç ä½ çœ‹åˆ°çš„mplayer,å°±æ˜¯ç”¨æ¥æ’­æ”¾è¯­éŸ³çš„ï¼Œä¼ ä¸ªurlä½œä¸ºå‚æ•°12sudo apt-get install mplayerusage: mplayer [url] æ’­æ”¾éŸ³ä¹æœ‰äº†ä¸Šé¢è¿™ä¸ªç¥žå™¨ï¼Œä½ å¯ä»¥ç»™æ’­æŠ¥è¯­éŸ³å‰åŽåŠ ä¸€é¦–éŸ³ä¹ðŸ˜„12def playMusic(path): os.system('mplayer %s' % path) æ€»ç»“åˆ©ç”¨ä¸Šé¢çš„ä¸œä¸œï¼Œå¯ä»¥ç»„åˆäº›å¥½çŽ©çš„ä¸œè¥¿äº†ï¼Œè‡³äºŽé—¹é’Ÿçš„å”¤é†’ï¼Œå¯ä»¥crob job åšï¼Œä¹Ÿå¯ä»¥ä»£ç é‡Œé¢å®žçŽ°ï¼Œenjoyâ€¦ðŸ˜„å…¨éƒ¨ä»£ç åœ°å€ https://github.com/ejunjsh/raspberrypi-code/blob/master/clock/weather.py]]></content>
      <categories>
        <category>raspberrypi</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>raspberrypi</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”¨goå®žçŽ°ä¸€ä¸ªç®€å•çš„restfulæŽ¥å£]]></title>
    <url>%2F2017%2F07%2F18%2Fgo-first-rest%2F</url>
    <content type="text"><![CDATA[å‰è¨€goçš„æ ‡å‡†åº“httpå·²ç»å°è£…å¥½å¾ˆå¤šæŽ¥å£ï¼Œå¯ä»¥å¾ˆç®€å•å®žçŽ°ä¸€ä¸ªwebæœåŠ¡å™¨ã€‚12345678910111213// å®šä¹‰ handlerfunc HelloServer(w http.ResponseWriter, req *http.Request) &#123; io.WriteString(w, "hello, world!\n")&#125;func main() &#123; //ç»‘å®špatternå’Œhandler http.HandleFunc("/hello", HelloServer) err := http.ListenAndServe(":12345", nil) if err != nil &#123; log.Fatal("ListenAndServe: ", err) &#125;&#125; åŸºäºŽä¸Šé¢ä¾‹å­å¯ä»¥å°è£…ä¸€ä¸ªrestfulæŽ¥å£ï¼Œä¸æ˜¯éš¾äº‹ã€‚ å®žçŽ°ä»Žä¸Šé¢ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªurl patternå¯¹åº”ä¸€ä¸ªhandlerï¼Œå³å¯¹åº”ä¸€ä¸ªå¤„ç†ï¼Œå°±å¯ä»¥å¤„ç†httpè¯·æ±‚äº†ï¼Œæ‰€ä»¥ä¸‹é¢çš„å®žçŽ°æ˜¯åŸºäºŽå¯¹è¿™ä¸¤ä¸ªä¸œè¥¿çš„å°è£…å¼€å§‹ å°è£…ä¸€ä¸ªrestful app ç»“æž„12345678910111213type App struct &#123; //ä¸€ä¸ªmapï¼Œkeyæ˜¯patternï¼Œvalueæ˜¯handler handlers map[string]func(r *HttpRequest,w HttpResponse)error //patternæ•°ç»„ï¼Œç”¨æ¥ä¿è¯åŠ å…¥patternçš„é¡ºåºï¼Œå› ä¸ºä¸Šé¢çš„mapæ˜¯æ— é¡ºåºçš„ patterns []string //ä¸€ä¸ªmapï¼Œkeyæ˜¯patternï¼Œvalueæ˜¯http method methods map[string]string //ç”¨æ¥å®žçŽ°åœ¨url pathå–å‡ºå‚æ•°çš„ã€‚ regexps map[string]*regexp.Regexp pathparamanmes map[string][]string //ç”¨æ¥å¤„ç†å¼‚å¸¸çš„handler errHandler func( err error, r *HttpRequest,w HttpResponse)&#125; åˆå§‹åŒ–å‡½æ•°12345678910111213func NewApp() *App &#123; return &amp;App&#123; handlers: make(map[string]func(r *HttpRequest,w HttpResponse)error), patterns:make([]string,0), methods:make(map[string]string), regexps:make(map[string]*regexp.Regexp), pathparamanmes:make(map[string][]string), //ä¸€ä¸ªé»˜è®¤çš„å¼‚å¸¸å¤„ç†ï¼Œç›´æŽ¥è¿”å›žå¼‚å¸¸å†…å®¹ errHandler: func(err error, r *HttpRequest, w HttpResponse) &#123; w.Write( []byte(err.Error())) &#125;, &#125;&#125; æ˜ å°„ç»‘å®š123456789101112131415161718192021222324252627282930313233343536func(a *App) handle(method string,pattern string, handler func(r *HttpRequest,w HttpResponse) error)&#123; //ç»‘å®špatternå’Œhandler a.handlers[pattern]=handler //ç»‘å®špatternå’Œmethod a.methods[pattern]=method //ç»‘å®špattern æ­£åˆ™ï¼Œç”¨æ¥åŒ¹é…url pattern,å’ŒèŽ·å–url path å‚æ•° a.regexps[pattern],a.pathparamanmes[pattern]=convertPatterntoRegex(pattern) for _,s:=range a.patterns&#123; if s==pattern&#123; return &#125; &#125; //åŠ å…¥æ•°ç»„ï¼Œæ–¹ä¾¿ç”¨æ­¤æ•°ç»„ç¡®å®šé¡ºåº a.patterns=append(a.patterns,pattern)&#125;//ç»‘å®šGETfunc (a *App) Get(pattern string, handler func(r *HttpRequest,w HttpResponse)error) &#123; a.handle("GET",pattern,handler)&#125;//ç»‘å®šPOSTfunc (a *App) Post(pattern string, handler func(r *HttpRequest,w HttpResponse)error) &#123; a.handle("POST",pattern,handler)&#125;//ç»‘å®šDELETEfunc (a *App) Delete(pattern string, handler func(r *HttpRequest,w HttpResponse)error) &#123; a.handle("DELETE",pattern,handler)&#125;//ç»‘å®šPUTfunc (a *App) Put(pattern string, handler func(r *HttpRequest,w HttpResponse) error) &#123; a.handle("PUT",pattern,handler)&#125;func (a *App) Error(handler func(err error,r *HttpRequest,w HttpResponse)) &#123; a.errHandler=handler&#125; æœ‰äº†RestfulæŽ¥å£çš„å››ä¸ªæ–¹æ³•æ˜ å°„ç»‘å®šï¼Œå‰©ä¸‹çš„å°±è¦è¯·æ±‚èƒ½è¿›åˆ°æ¥ï¼Œæ‰€ä»¥æŽ¥ä¸‹æ¥è¦å†™ä¸ªå…¥å£æ‰è¡Œã€‚ ç¼–å†™httpå…¥å£12345678910111213141516171819//http å…¥å£func(a *App) Run(address string) error&#123; fmt.Printf("Server listens on %s",address) err:=http.ListenAndServe(address,&amp;hodler&#123;app:a&#125;) if err!=nil&#123; return err &#125; return nil&#125;//https å…¥å£func(a *App) RunTls(address string,cert string,key string) error&#123; fmt.Printf("Server listens on %s",address) err:=http.ListenAndServeTLS(address,cert,key,&amp;hodler&#123;app:a&#125;) if err!=nil&#123; return err &#125; return nil&#125; å…¥å£å‡½æ•°ä¸»è¦è°ƒç”¨httpåº“æ¥å¯åŠ¨httpæœåŠ¡ï¼Œç„¶åŽæŠŠè¯·æ±‚å¤„ç†å‡½æ•°ä½œä¸ºListenAndServeç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ã€‚è¿™é‡Œç”±holderæ¥å®žçŽ°è¿™ä¸ªå¤„ç†å‡½æ•°ã€‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950func (h *hodler) ServeHTTP(w http.ResponseWriter, r *http.Request)&#123; //å°è£…ä¸€ä¸‹ï¼Œé™„åŠ æ›´å¤šåŠŸèƒ½ request:= newHttpRequest(r) response:=newHttpResponse(w) //æ•èŽ·panicï¼Œå¹¶è®©errhandlerå¤„ç†è¿”å›žã€‚ defer func() &#123; if err:=recover();err!=nil&#123; if e,ok:=err.(error);ok&#123; h.app.errHandler(InternalError&#123;e,""&#125;,request,response) &#125; if e,ok:=err.(string);ok&#123; h.app.errHandler(InternalError&#123;nil,e&#125;,request,response) &#125; &#125; &#125;() //æ ¹æ®patternçš„æ·»åŠ é¡ºåºï¼Œå¾ªçŽ¯åˆ¤æ–­ for _,p:=range h.app.patterns&#123; if reg,ok:= h.app.regexps[p];ok&#123; //åŒ¹é…method if method,ok:=h.app.methods[p];ok&amp;&amp;r.Method==method&#123; //åŒ¹é…pattern if reg.Match([]byte(r.URL.Path)) &#123; //æŠ½å–url path parameters matchers:=reg.FindSubmatch([]byte(r.URL.Path)) pathParamMap:=make(map[string]string) if len(matchers)&gt;1&#123; if pathParamNames,ok:=h.app.pathparamanmes[p];ok&#123; for i:=1;i&lt;len(matchers);i++&#123; pathParamMap[pathParamNames[i]]=string(matchers[i]) &#125; &#125; &#125; //PathParamsæ˜¯å°è£…åŽçš„requestç‹¬æœ‰çš„å±žæ€§ request.PathParams=pathParamMap if handler,ok:=h.app.handlers[p];ok&#123; //æ‰§è¡Œhandler err:=handler(request,response) if err!=nil&#123; //æ‰§è¡Œerrhandler h.app.errHandler(err,request,response) &#125; return &#125; &#125; &#125; &#125; &#125; //æ‰§è¡Œno found errhandler h.app.errHandler(NoFoundError&#123;&#125;,request,response)&#125; åŸºæœ¬ä¸€ä¸ªè¯·æ±‚çš„æµç¨‹å¦‚ä¸‹ï¼šrequset-&gt;ServeHTTP()-&gt;åŒ¹é…url pattern-&gt;åŒ¹é…method-&gt;åŒ¹é…åˆ°ä½ çš„handler-&gt;æ‰§è¡Œä½ çš„handler-&gt;ä½ çš„handlerè¿”å›žç»“æžœ è¿”å›žç»“æžœç”±äºŽè¿”å›žç»“æžœå¯ä»¥æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥å°è£…äº†httpåº“çš„http.ResponseWriteræ¥å®žçŽ°WriteString,WriteJson,WriteXml,WriteFileç­‰æ–¹æ³•ã€‚1234567891011121314151617181920212223242526272829//å°è£…requestï¼Œé™„ä»¶ä¸€ä¸ªPathParamsæ¥ä¿å­˜url path parameters.type HttpRequest struct &#123; *http.Request PathParams map[string] string&#125;type HttpResponse struct &#123; http.ResponseWriter&#125;//ç”¨æ¥è¿”å›žå­—ç¬¦func (response *HttpResponse) WriteString(str string) error &#123; ...&#125;//è¿”å›žJSONfunc (response *HttpResponse) WriteJson(jsonObj interface&#123;&#125;) error &#123; ...&#125;//è¿”å›žXMLfunc (response *HttpResponse) WriteXml(xmlObj interface&#123;&#125;) error &#123; ...&#125;//è¿”å›žæ–‡ä»¶func (response *HttpResponse) WriteFile(filepath string) error &#123; ...&#125;//è¿”å›žä¸€ä¸ªæ¨¡æ¿htmlfunc (response *HttpResponse) WriteTemplates(data interface&#123;&#125;,tplPath ...string) error &#123; ...&#125; ä¾‹å­123456789101112131415161718192021222324func main()&#123; //new ä¸€ä¸ªrestfulæŽ¥å£ app:=gorest.NewApp() //ç»‘å®š app.Get("/json", func(r *gorest.HttpRequest, w gorest.HttpResponse) error &#123; a:= struct &#123; Abc string `json:"abc"` Cba string `json:"cba"` &#125;&#123;"123","321"&#125; //è¿”å›žjsonä½œä¸ºç»“æžœ return w.WriteJson(a) &#125;) app.Error(func(err error, r *gorest.HttpRequest, w gorest.HttpResponse)&#123; if e,ok:=err.(gorest.NoFoundError);ok &#123; w.Write([]byte(e.Error())) &#125; if e,ok:=err.(gorest.InternalError);ok &#123; w.Write([]byte(e.Error())) &#125; &#125;) //å¯åŠ¨ app.Run(":8081")&#125; æ”¶å·¥ðŸ˜„ æ€»ç»“goçš„æ ‡å‡†åº“å°è£…äº†å¾ˆå¤šäº†ï¼Œæ‰€ä»¥å®žçŽ°è¿™ä¸ªå…¶å®žè¿˜æ˜¯æ¯”è¾ƒè½»æ¾çš„ðŸ˜„è¯¦ç»†ä»£ç è§https://github.com/ejunjsh/gorest]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
        <tag>restful</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸€å¼ å›¾äº†è§£ä¸€è‡´æ€§hash]]></title>
    <url>%2F2017%2F07%2F16%2Fconsistent-hash%2F</url>
    <content type="text"><![CDATA[]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸€å¼ å›¾äº†è§£hashmap]]></title>
    <url>%2F2017%2F07%2F15%2Fhashmap%2F</url>
    <content type="text"><![CDATA[]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[SELECT * ...... FOR UPDATE é”æœºåˆ¶]]></title>
    <url>%2F2016%2F12%2F19%2Fmysql-select-for-update%2F</url>
    <content type="text"><![CDATA[ç”±äºŽInnoDBé¢„è®¾æ˜¯Row-Level Lockï¼ŒInnoDBè¡Œé”æ˜¯é€šè¿‡ç»™ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®žçŽ°çš„ï¼Œè¿™ä¸€ç‚¹MySQLä¸ŽOracleä¸åŒï¼ŒåŽè€…æ˜¯é€šè¿‡åœ¨æ•°æ®å—ä¸­å¯¹ç›¸åº”æ•°æ®è¡ŒåŠ é”æ¥å®žçŽ°çš„ã€‚InnoDBè¿™ç§è¡Œé”å®žçŽ°ç‰¹ç‚¹æ„å‘³ç€ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ï¼ ä¸¾ä¸ªä¾‹å­:å‡è®¾æœ‰ä¸ªè¡¨å•products ï¼Œé‡Œé¢æœ‰idè·ŸnameäºŒä¸ªæ ä½ï¼Œidæ˜¯ä¸»é”®ã€‚ä¾‹1: (æ˜Žç¡®æŒ‡å®šä¸»é”®ï¼Œå¹¶ä¸”æœ‰æ­¤ç¬”èµ„æ–™ï¼Œrow lock)12SELECT * FROM products WHERE id='3' FOR UPDATE;SELECT * FROM products WHERE id='3' and type=1 FOR UPDATE; ä¾‹2: (æ˜Žç¡®æŒ‡å®šä¸»é”®ï¼Œè‹¥æŸ¥æ— æ­¤ç¬”èµ„æ–™ï¼Œæ— lock)1SELECT * FROM products WHERE id='-1' FOR UPDATE; ä¾‹3: (æ— ä¸»é”®ï¼Œtable lock)1SELECT * FROM products WHERE name='Mouse' FOR UPDATE; ä¾‹4: (ä¸»é”®ä¸æ˜Žç¡®ï¼Œtable lock)1SELECT * FROM products WHERE id&lt;&gt;'3' FOR UPDATE; ä¾‹5: (ä¸»é”®ä¸æ˜Žç¡®ï¼Œtable lock)1SELECT * FROM products WHERE id LIKE '3' FOR UPDATE; æ³¨1: FOR UPDATEä»…é€‚ç”¨äºŽInnoDBï¼Œä¸”å¿…é¡»åœ¨äº¤æ˜“åŒºå—(BEGIN/COMMIT)ä¸­æ‰èƒ½ç”Ÿæ•ˆã€‚æ³¨2: è¦æµ‹è¯•é”å®šçš„çŠ¶å†µï¼Œå¯ä»¥åˆ©ç”¨mysqlçš„Command Mode ï¼Œå¼€äºŒä¸ªè§†çª—æ¥åšæµ‹è¯•ã€‚ åœ¨MySql 5.0ä¸­æµ‹è¯•ç¡®å®žæ˜¯è¿™æ ·çš„å¦å¤–ï¼šMyAsim åªæ”¯æŒè¡¨çº§é”ï¼ŒInnerDBæ”¯æŒè¡Œçº§é”æ·»åŠ äº†(è¡Œçº§é”/è¡¨çº§é”)é”çš„æ•°æ®ä¸èƒ½è¢«å…¶å®ƒäº‹åŠ¡å†é”å®šï¼Œä¹Ÿä¸è¢«å…¶å®ƒäº‹åŠ¡ä¿®æ”¹ï¼ˆä¿®æ”¹ã€åˆ é™¤ï¼‰æ˜¯è¡¨çº§é”æ—¶ï¼Œä¸ç®¡æ˜¯å¦æŸ¥è¯¢åˆ°è®°å½•ï¼Œéƒ½ä¼šé”å®šè¡¨ æ­¤å¤–ï¼Œå¦‚æžœAä¸ŽBéƒ½å¯¹è¡¨idè¿›è¡ŒæŸ¥è¯¢ä½†æŸ¥è¯¢ä¸åˆ°è®°å½•ï¼Œåˆ™Aä¸ŽBåœ¨æŸ¥è¯¢ä¸Šä¸ä¼šè¿›è¡Œrowé”ï¼Œä½†Aä¸ŽBéƒ½ä¼šèŽ·å–æŽ’å®ƒé”ï¼Œæ­¤æ—¶Aå†æ’å…¥ä¸€æ¡è®°å½•çš„è¯åˆ™ä¼šå› ä¸ºBå·²ç»æœ‰é”è€Œå¤„äºŽç­‰å¾…ä¸­ï¼Œæ­¤æ—¶Bå†æ’å…¥ä¸€æ¡åŒæ ·çš„æ•°æ®åˆ™ä¼šæŠ›å‡ºDeadlock found when trying to get lock; try restarting transactionç„¶åŽé‡Šæ”¾é”ï¼Œæ­¤æ—¶Aå°±èŽ·å¾—äº†é”è€Œæ’å…¥æˆåŠŸ ä¸Šé¢ä»‹ç»è¿‡SELECT â€¦ FOR UPDATE çš„ç”¨æ³•ï¼Œä¸è¿‡é”å®š(Lock)çš„æ•°æ®æ˜¯åˆ¤åˆ«å°±å¾—è¦æ³¨æ„ä¸€ä¸‹äº†ã€‚ç”±äºŽInnoDB é¢„è®¾æ˜¯Row-Level Lockï¼Œæ‰€ä»¥åªæœ‰ã€Œæ˜Žç¡®ã€çš„æŒ‡å®šä¸»é”®ï¼ŒMySQL æ‰ä¼šæ‰§è¡ŒRow lock (åªé”ä½è¢«é€‰å–çš„æ•°æ®) ï¼Œå¦åˆ™MySQL å°†ä¼šæ‰§è¡ŒTable Lock (å°†æ•´ä¸ªæ•°æ®è¡¨å•ç»™é”ä½)ã€‚ è½¬è½½ http://www.cnblogs.com/chenwenbiao/archive/2012/06/06/2537508.html]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç®€å•ç†è§£Java GCä¸Žå¹½çµå¼•ç”¨]]></title>
    <url>%2F2016%2F09%2F11%2Fjava-gc-reference%2F</url>
    <content type="text"><![CDATA[Javaä¸­ä¸€å…±æœ‰4ç§ç±»åž‹çš„å¼•ç”¨:StrongReferenceã€SoftReferenceã€WeakReferenceä»¥åŠPhantomReference (å¹½çµå¼•ç”¨), è¿™ 4 ç§ç±»åž‹çš„å¼•ç”¨ä¸ŽJava GCæœ‰ç€å¯†åˆ‡çš„å…³ç³», è®©æˆ‘ä»¬é€ä¸€æ¥çœ‹å®ƒä»¬çš„å®šä¹‰å’Œä½¿ç”¨åœºæ™¯ã€‚ Strong ReferenceStrongReference æ˜¯ Java çš„é»˜è®¤å¼•ç”¨å®žçŽ°,å®ƒä¼šå°½å¯èƒ½é•¿æ—¶é—´çš„å­˜æ´»äºŽ JVM å†…ï¼Œ å½“æ²¡æœ‰ä»»ä½•å¯¹è±¡æŒ‡å‘å®ƒæ—¶Java GC æ‰§è¡ŒåŽå°†ä¼šè¢«å›žæ”¶12345678910111213141516171819@Test public void strongReference() &#123; Object referent = new Object(); /** * é€šè¿‡èµ‹å€¼åˆ›å»º StrongReference */ Object strongReference = referent; assertSame(referent, strongReference); referent = null; System.gc(); /** * StrongReference åœ¨ GC åŽä¸ä¼šè¢«å›žæ”¶ */ assertNotNull(strongReference); &#125; WeakReference &amp; WeakHashMapWeakReferenceï¼Œ é¡¾åæ€ä¹‰,æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨,å½“æ‰€å¼•ç”¨çš„å¯¹è±¡åœ¨ JVM å†…ä¸å†æœ‰å¼ºå¼•ç”¨æ—¶, Java GC åŽ weak reference å°†ä¼šè¢«è‡ªåŠ¨å›žæ”¶123456789101112131415@Test public void weakReference() &#123; Object referent = new Object(); WeakReference&lt;Object&gt; weakRerference = new WeakReference&lt;Object&gt;(referent); assertSame(referent, weakRerference.get()); referent = null; System.gc(); /** * ä¸€æ—¦æ²¡æœ‰æŒ‡å‘ referent çš„å¼ºå¼•ç”¨, weak reference åœ¨ GC åŽä¼šè¢«è‡ªåŠ¨å›žæ”¶ */ assertNull(weakRerference.get()); &#125; WeakHashMap ä½¿ç”¨ WeakReference ä½œä¸º keyï¼Œ ä¸€æ—¦æ²¡æœ‰æŒ‡å‘ key çš„å¼ºå¼•ç”¨, WeakHashMap åœ¨Java GC åŽå°†è‡ªåŠ¨åˆ é™¤ç›¸å…³çš„ entry12345678910111213141516171819202122@Test public void weakHashMap() throws InterruptedException &#123; Map&lt;Object, Object&gt; weakHashMap = new WeakHashMap&lt;Object, Object&gt;(); Object key = new Object(); Object value = new Object(); weakHashMap.put(key, value); assertTrue(weakHashMap.containsValue(value)); key = null; System.gc(); /** * ç­‰å¾…æ— æ•ˆ entries è¿›å…¥ ReferenceQueue ä»¥ä¾¿ä¸‹ä¸€æ¬¡è°ƒç”¨ getTable æ—¶è¢«æ¸…ç† */ Thread.sleep(1000); /** * ä¸€æ—¦æ²¡æœ‰æŒ‡å‘ key çš„å¼ºå¼•ç”¨, WeakHashMap åœ¨ GC åŽå°†è‡ªåŠ¨åˆ é™¤ç›¸å…³çš„ entry */ assertFalse(weakHashMap.containsValue(value)); &#125; SoftReferenceSoftReference äºŽ WeakReference çš„ç‰¹æ€§åŸºæœ¬ä¸€è‡´ï¼Œ æœ€å¤§çš„åŒºåˆ«åœ¨äºŽ SoftReference ä¼šå°½å¯èƒ½é•¿çš„ä¿ç•™å¼•ç”¨ç›´åˆ° JVM å†…å­˜ä¸è¶³æ—¶æ‰ä¼šè¢«å›žæ”¶(è™šæ‹Ÿæœºä¿è¯), è¿™ä¸€ç‰¹æ€§ä½¿å¾— SoftReference éžå¸¸é€‚åˆç¼“å­˜åº”ç”¨123456789101112131415@Test public void softReference() &#123; Object referent = new Object(); SoftReference&lt;Object&gt; softRerference = new SoftReference&lt;Object&gt;(referent); assertNotNull(softRerference.get()); referent = null; System.gc(); /** *soft references åªæœ‰åœ¨ jvm OutOfMemory ä¹‹å‰æ‰ä¼šè¢«å›žæ”¶, æ‰€ä»¥å®ƒéžå¸¸é€‚åˆç¼“å­˜åº”ç”¨ */ assertNotNull(softRerference.get()); &#125; Phantom Referenceä½œä¸ºæœ¬æ–‡ä¸»è§’ï¼Œ Phantom Reference(å¹½çµå¼•ç”¨) ä¸Ž WeakReference å’Œ SoftReference æœ‰å¾ˆå¤§çš„ä¸åŒ,å› ä¸ºå®ƒçš„ get() æ–¹æ³•æ°¸è¿œè¿”å›ž null, è¿™ä¹Ÿæ­£æ˜¯å®ƒåå­—çš„ç”±æ¥12345678910@Test public void phantomReferenceAlwaysNull() &#123; Object referent = new Object(); PhantomReference&lt;Object&gt; phantomReference = new PhantomReference&lt;Object&gt;(referent, new ReferenceQueue&lt;Object&gt;()); /** * phantom reference çš„ get æ–¹æ³•æ°¸è¿œè¿”å›ž null */ assertNull(phantomReference.get()); &#125; è¯¸ä½å¯èƒ½è¦é—®, ä¸€ä¸ªæ°¸è¿œè¿”å›ž null çš„ reference è¦æ¥ä½•ç”¨,è¯·æ³¨æ„æž„é€  PhantomReference æ—¶çš„ç¬¬äºŒä¸ªå‚æ•° ReferenceQueue(äº‹å®žä¸Š WeakReference &amp; SoftReference ä¹Ÿå¯ä»¥æœ‰è¿™ä¸ªå‚æ•°)ï¼ŒPhantomReference å”¯ä¸€çš„ç”¨å¤„å°±æ˜¯è·Ÿè¸ª referentä½•æ—¶è¢« enqueue åˆ° ReferenceQueue ä¸­. RererenceQueueå½“ä¸€ä¸ª WeakReference å¼€å§‹è¿”å›ž null æ—¶ï¼Œ å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡å·²ç»å‡†å¤‡è¢«å›žæ”¶ï¼Œ è¿™æ—¶å¯ä»¥åšä¸€äº›åˆé€‚çš„æ¸…ç†å·¥ä½œ. å°†ä¸€ä¸ª ReferenceQueue ä¼ ç»™ä¸€ä¸ª Reference çš„æž„é€ å‡½æ•°ï¼Œ å½“å¯¹è±¡è¢«å›žæ”¶æ—¶ï¼Œ è™šæ‹Ÿæœºä¼šè‡ªåŠ¨å°†è¿™ä¸ªå¯¹è±¡æ’å…¥åˆ° ReferenceQueue ä¸­ï¼Œ WeakHashMap å°±æ˜¯åˆ©ç”¨ ReferenceQueue æ¥æ¸…é™¤ key å·²ç»æ²¡æœ‰å¼ºå¼•ç”¨çš„ entries.1234567891011121314151617@Test public void referenceQueue() throws InterruptedException &#123; Object referent = new Object(); ReferenceQueue&lt;Object&gt; referenceQueue = new ReferenceQueue&lt;Object&gt;(); WeakReference&lt;Object&gt; weakReference = new WeakReference&lt;Object&gt;(referent, referenceQueue); assertFalse(weakReference.isEnqueued()); Reference&lt;? extends Object&gt; polled = referenceQueue.poll(); assertNull(polled); referent = null; System.gc(); assertTrue(weakReference.isEnqueued()); Reference&lt;? extends Object&gt; removed = referenceQueue.remove(); assertNotNull(removed); &#125; Phantom Reference vs Weak ReferencePhantomReferenceæœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œ å…¶ä¸€ï¼Œ å®ƒå¯ä»¥è®©æˆ‘ä»¬å‡†ç¡®åœ°çŸ¥é“å¯¹è±¡ä½•æ—¶è¢«ä»Žå†…å­˜ä¸­åˆ é™¤ï¼Œ è¿™ä¸ªç‰¹æ€§å¯ä»¥è¢«ç”¨äºŽä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ä¸­(ä¾‹å¦‚ Distributed GCï¼ŒXWork å’Œ google-guice ä¸­ä¹Ÿä½¿ç”¨ PhantomReference åšäº†ä¸€äº›æ¸…ç†æ€§å·¥ä½œ). å…¶äºŒï¼Œ å®ƒå¯ä»¥é¿å… finalization å¸¦æ¥çš„ä¸€äº›æ ¹æœ¬æ€§é—®é¢˜, ä¸Šæ–‡æåˆ° PhantomReference çš„å”¯ä¸€ä½œç”¨å°±æ˜¯è·Ÿè¸ª referent ä½•æ—¶è¢« enqueue åˆ° ReferenceQueue ä¸­,ä½†æ˜¯ WeakReference ä¹Ÿæœ‰å¯¹åº”çš„åŠŸèƒ½, ä¸¤è€…çš„åŒºåˆ«åˆ°åº•åœ¨å“ªå‘¢ ?è¿™å°±è¦è¯´åˆ° Object çš„ finalize æ–¹æ³•, æ­¤æ–¹æ³•å°†åœ¨ gc æ‰§è¡Œå‰è¢«è°ƒç”¨, å¦‚æžœæŸä¸ªå¯¹è±¡é‡è½½äº† finalize æ–¹æ³•å¹¶æ•…æ„åœ¨æ–¹æ³•å†…åˆ›å»ºæœ¬èº«çš„å¼ºå¼•ç”¨,è¿™å°†å¯¼è‡´è¿™ä¸€è½®çš„ GC æ— æ³•å›žæ”¶è¿™ä¸ªå¯¹è±¡å¹¶æœ‰å¯èƒ½å¼•èµ·ä»»æ„æ¬¡ GCï¼Œ æœ€åŽçš„ç»“æžœå°±æ˜¯æ˜Žæ˜Ž JVM å†…æœ‰å¾ˆå¤š Garbage å´ OutOfMemoryï¼Œ ä½¿ç”¨ PhantomReference å°±å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œ å› ä¸º PhantomReference æ˜¯åœ¨ finalize æ–¹æ³•æ‰§è¡ŒåŽå›žæ”¶çš„ï¼Œä¹Ÿå°±æ„å‘³ç€æ­¤æ—¶å·²ç»ä¸å¯èƒ½æ‹¿åˆ°åŽŸæ¥çš„å¼•ç”¨,ä¹Ÿå°±ä¸ä¼šå‡ºçŽ°ä¸Šè¿°é—®é¢˜,å½“ç„¶è¿™æ˜¯ä¸€ä¸ªå¾ˆæžç«¯çš„ä¾‹å­, ä¸€èˆ¬ä¸ä¼šå‡ºçŽ°. å¯¹æ¯”Soft vs Weak vs Phantom References Type Purpose Use When GCed Implementing Class Strong Reference An ordinary reference. Keeps objects alive as long as they are referenced. normal reference. Any object not pointed to can be reclaimed. default Soft Reference Keeps objects alive provided thereâ€™s enough memory. to keep objects alive even after clients have removed their references (memory-sensitive caches), in case clients start asking for them again by key. After a first gc pass, the JVM decides it still needs to reclaim more space. java.lang.ref.SoftReference Weak Reference Keeps objects alive only while theyâ€™re in use (reachable) by clients. Containers that automatically delete objects no longer in use. After gc determines the object is only weakly reachable java.lang.ref.WeakReference java.util.WeakHashMap Phantom Reference Lets you clean up after finalization but before the space is reclaimed (replaces or augments the use offinalize()) Special clean up processing After finalization. java.lang.ref.PhantomReference Java GCå°ç»“ä¸€èˆ¬çš„åº”ç”¨ç¨‹åºä¸ä¼šæ¶‰åŠåˆ° Reference ç¼–ç¨‹ï¼Œ ä½†æ˜¯äº†è§£è¿™äº›çŸ¥è¯†ä¼šå¯¹ç†è§£Java GC çš„å·¥ä½œåŽŸç†ä»¥åŠæ€§èƒ½è°ƒä¼˜æœ‰ä¸€å®šå¸®åŠ©, åœ¨å®žçŽ°ä¸€äº›åŸºç¡€æ€§è®¾æ–½æ¯”å¦‚ç¼“å­˜æ—¶ä¹Ÿå¯èƒ½ä¼šç”¨åˆ°ï¼Œ å¸Œæœ›æœ¬æ–‡èƒ½æœ‰æ‰€å¸®åŠ©.]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>gc</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[redisçš„äº‹åŠ¡å’Œwatch]]></title>
    <url>%2F2016%2F09%2F03%2Fredis-transaction-watch%2F</url>
    <content type="text"><![CDATA[redisçš„äº‹åŠ¡ä¸¥æ ¼æ„ä¹‰æ¥è®²,redisçš„äº‹åŠ¡å’Œæˆ‘ä»¬ç†è§£çš„ä¼ ç»Ÿæ•°æ®åº“(å¦‚mysql)çš„äº‹åŠ¡æ˜¯ä¸ä¸€æ ·çš„ã€‚ redisä¸­çš„äº‹åŠ¡å®šä¹‰Redisä¸­çš„äº‹åŠ¡ï¼ˆtransactionï¼‰æ˜¯ä¸€ç»„å‘½ä»¤çš„é›†åˆã€‚ äº‹åŠ¡åŒå‘½ä»¤ä¸€æ ·éƒ½æ˜¯Redisçš„æœ€å°æ‰§è¡Œå•ä½ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­çš„å‘½ä»¤è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚äº‹åŠ¡çš„åŽŸç†æ˜¯å…ˆå°†å±žäºŽä¸€ä¸ªäº‹åŠ¡çš„å‘½ä»¤å‘é€ç»™Redisï¼Œç„¶åŽå†è®©Redisä¾æ¬¡æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚ Redisä¿è¯ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚å¦‚æžœåœ¨å‘é€EXECå‘½ä»¤å‰å®¢æˆ·ç«¯æ–­çº¿äº†ï¼Œåˆ™Redisä¼šæ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—ï¼Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œã€‚è€Œä¸€æ—¦å®¢æˆ·ç«¯å‘é€äº†EXECå‘½ä»¤ï¼Œæ‰€æœ‰çš„å‘½ä»¤å°±éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå³ä½¿æ­¤åŽå®¢æˆ·ç«¯æ–­çº¿ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºRedisä¸­å·²ç»è®°å½•äº†æ‰€æœ‰è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ é™¤æ­¤ä¹‹å¤–ï¼ŒRedisçš„äº‹åŠ¡è¿˜èƒ½ä¿è¯ä¸€ä¸ªäº‹åŠ¡å†…çš„å‘½ä»¤ä¾æ¬¡æ‰§è¡Œè€Œä¸è¢«å…¶ä»–å‘½ä»¤æ’å…¥ã€‚è¯•æƒ³å®¢æˆ·ç«¯Aéœ€è¦æ‰§è¡Œå‡ æ¡å‘½ä»¤ï¼ŒåŒæ—¶å®¢æˆ·ç«¯Bå‘é€äº†ä¸€æ¡å‘½ä»¤ï¼Œå¦‚æžœä¸ä½¿ç”¨äº‹åŠ¡ï¼Œåˆ™å®¢æˆ·ç«¯Bçš„å‘½ä»¤å¯èƒ½ä¼šæ’å…¥åˆ°å®¢æˆ·ç«¯Açš„å‡ æ¡å‘½ä»¤ä¸­æ‰§è¡Œã€‚å¦‚æžœä¸å¸Œæœ›å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨äº‹åŠ¡ã€‚ äº‹åŠ¡çš„åº”ç”¨ äº‹åŠ¡çš„åº”ç”¨éžå¸¸æ™®éï¼Œå¦‚é“¶è¡Œè½¬è´¦è¿‡ç¨‹ä¸­Aç»™Bæ±‡æ¬¾ï¼Œé¦–å…ˆç³»ç»Ÿä»ŽAçš„è´¦æˆ·ä¸­å°†é’±åˆ’èµ°ï¼Œç„¶åŽå‘Bçš„è´¦æˆ·å¢žåŠ ç›¸åº”çš„é‡‘é¢ã€‚è¿™ä¸¤ä¸ªæ­¥éª¤å¿…é¡»å±žäºŽåŒä¸€ä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œã€‚å¦åˆ™åªæ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œé’±å°±å‡­ç©ºæ¶ˆå¤±äº†ï¼Œè¿™æ˜¾ç„¶è®©äººæ— æ³•æŽ¥å—ã€‚ å’Œä¼ ç»Ÿçš„äº‹åŠ¡ä¸åŒ å’Œä¼ ç»Ÿçš„mysqläº‹åŠ¡ä¸åŒçš„äº‹ï¼Œå³ä½¿æˆ‘ä»¬çš„åŠ é’±æ“ä½œå¤±è´¥,æˆ‘ä»¬ä¹Ÿæ— æ³•åœ¨è¿™ä¸€ç»„å‘½ä»¤ä¸­è®©æ•´ä¸ªçŠ¶æ€å›žæ»šåˆ°æ“ä½œä¹‹å‰ äº‹åŠ¡çš„é”™è¯¯å¤„ç†å¦‚æžœä¸€ä¸ªäº‹åŠ¡ä¸­çš„æŸä¸ªå‘½ä»¤æ‰§è¡Œå‡ºé”™ï¼ŒRedisä¼šæ€Žæ ·å¤„ç†å‘¢ï¼Ÿè¦å›žç­”è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä»€ä¹ˆåŽŸå› ä¼šå¯¼è‡´å‘½ä»¤æ‰§è¡Œå‡ºé”™ã€‚ è¯­æ³•é”™è¯¯è¯­æ³•é”™è¯¯æŒ‡å‘½ä»¤ä¸å­˜åœ¨æˆ–è€…å‘½ä»¤å‚æ•°çš„ä¸ªæ•°ä¸å¯¹ã€‚æ¯”å¦‚ï¼š12345678910redisï¼žMULTIOKredisï¼žSET key valueQUEUEDredisï¼žSET key(error)ERR wrong number of arguments for 'set' commandredisï¼ž errorCOMMAND key(error) ERR unknown command 'errorCOMMAND'redisï¼ž EXEC(error) EXECABORT Transaction discarded because of previous errors. è·Ÿåœ¨MULTIå‘½ä»¤åŽæ‰§è¡Œäº†3ä¸ªå‘½ä»¤ï¼šä¸€ä¸ªæ˜¯æ­£ç¡®çš„å‘½ä»¤ï¼ŒæˆåŠŸåœ°åŠ å…¥äº‹åŠ¡é˜Ÿåˆ—ï¼›å…¶ä½™ä¸¤ä¸ªå‘½ä»¤éƒ½æœ‰è¯­æ³•é”™è¯¯ã€‚è€Œåªè¦æœ‰ä¸€ä¸ªå‘½ä»¤æœ‰è¯­æ³•é”™è¯¯ï¼Œæ‰§è¡ŒEXECå‘½ä»¤åŽRediså°±ä¼šç›´æŽ¥è¿”å›žé”™è¯¯ï¼Œè¿žè¯­æ³•æ­£ç¡®çš„å‘½ä»¤ä¹Ÿä¸ä¼šæ‰§è¡Œã€‚ è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼šRedis 2.6.5ä¹‹å‰çš„ç‰ˆæœ¬ä¼šå¿½ç•¥æœ‰è¯­æ³•é”™è¯¯çš„å‘½ä»¤ï¼Œç„¶åŽæ‰§è¡Œäº‹åŠ¡ä¸­å…¶ä»–è¯­æ³•æ­£ç¡®çš„å‘½ä»¤ã€‚å°±æ­¤ä¾‹è€Œè¨€ï¼ŒSET key valueä¼šè¢«æ‰§è¡Œï¼ŒEXECå‘½ä»¤ä¼šè¿”å›žä¸€ä¸ªç»“æžœï¼š1) OKã€‚ è¿è¡Œé”™è¯¯è¿è¡Œé”™è¯¯æŒ‡åœ¨å‘½ä»¤æ‰§è¡Œæ—¶å‡ºçŽ°çš„é”™è¯¯ï¼Œæ¯”å¦‚ä½¿ç”¨æ•£åˆ—ç±»åž‹çš„å‘½ä»¤æ“ä½œé›†åˆç±»åž‹çš„é”®ï¼Œè¿™ç§é”™è¯¯åœ¨å®žé™…æ‰§è¡Œä¹‹å‰Redisæ˜¯æ— æ³•å‘çŽ°çš„ï¼Œæ‰€ä»¥åœ¨äº‹åŠ¡é‡Œè¿™æ ·çš„å‘½ä»¤æ˜¯ä¼šè¢«RedisæŽ¥å—å¹¶æ‰§è¡Œçš„ã€‚å¦‚æžœäº‹åŠ¡é‡Œçš„ä¸€æ¡å‘½ä»¤å‡ºçŽ°äº†è¿è¡Œé”™è¯¯ï¼Œäº‹åŠ¡é‡Œå…¶ä»–çš„å‘½ä»¤ä¾ç„¶ä¼šç»§ç»­æ‰§è¡Œï¼ˆåŒ…æ‹¬å‡ºé”™å‘½ä»¤ä¹‹åŽçš„å‘½ä»¤ï¼‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š1234567891011121314redisï¼žMULTIOKredisï¼žSET key 1QUEUEDredisï¼žSADD key 2QUEUEDredisï¼žSET key 3QUEUEDredisï¼žEXEC1) OK2) (error) ERR Operation against a key holding the wrong kind of value3) OKredisï¼žGET key"3" å¯è§è™½ç„¶SADD key 2å‡ºçŽ°äº†é”™è¯¯ï¼Œä½†æ˜¯SET key 3ä¾ç„¶æ‰§è¡Œäº†ã€‚ Redisçš„äº‹åŠ¡æ²¡æœ‰å…³ç³»æ•°æ®åº“äº‹åŠ¡æä¾›çš„å›žæ»šï¼ˆrollbackï¼‰åŠŸèƒ½ã€‚ä¸ºæ­¤å¼€å‘è€…å¿…é¡»åœ¨äº‹åŠ¡æ‰§è¡Œå‡ºé”™åŽè‡ªå·±æ”¶æ‹¾å‰©ä¸‹çš„æ‘Šå­ï¼ˆå°†æ•°æ®åº“å¤åŽŸå›žäº‹åŠ¡æ‰§è¡Œå‰çš„çŠ¶æ€ç­‰,è¿™é‡Œæˆ‘ä»¬ä¸€èˆ¬é‡‡å–æ—¥å¿—è®°å½•ç„¶åŽä¸šåŠ¡è¡¥å¿çš„æ–¹å¼æ¥å¤„ç†ï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨redisåšçš„æ“ä½œä¸åº”è¯¥æœ‰è¿™ç§å¼ºä¸€è‡´æ€§è¦æ±‚çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ç§éœ€æ±‚ä¸ºä¸åˆç†çš„è®¾è®¡ï¼‰ã€‚ Watchå‘½ä»¤å¤§å®¶å¯èƒ½çŸ¥é“redisæä¾›äº†åŸºäºŽincrå‘½ä»¤æ¥æ“ä½œä¸€ä¸ªæ•´æ•°åž‹æ•°å€¼çš„åŽŸå­é€’å¢žï¼Œé‚£ä¹ˆæˆ‘ä»¬å‡è®¾å¦‚æžœredisæ²¡æœ‰è¿™ä¸ªincrå‘½ä»¤ï¼Œæˆ‘ä»¬è¯¥æ€Žä¹ˆå®žçŽ°è¿™ä¸ªincrçš„æ“ä½œå‘¢ï¼Ÿ é‚£ä¹ˆæˆ‘ä»¬ä¸‹é¢çš„æ­£ä¸»watchå°±è¦ä¸Šåœºäº†ã€‚ å¦‚ä½•ä½¿ç”¨watchå‘½ä»¤æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬æƒ³è¦å¯¹ä¸€ä¸ªæ•´å½¢æ•°å€¼åšä¿®æ”¹æ˜¯è¿™ä¹ˆåšçš„(ä¼ªä»£ç å®žçŽ°)ï¼š123val = GET mykeyval = val + 1SET mykey $val ä½†æ˜¯ä¸Šè¿°çš„ä»£ç ä¼šå‡ºçŽ°ä¸€ä¸ªé—®é¢˜,å› ä¸ºä¸Šé¢å§æ­£å¸¸çš„ä¸€ä¸ªincr(åŽŸå­é€’å¢žæ“ä½œ)åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†,é‚£ä¹ˆåœ¨å¤šçº¿ç¨‹(åˆ†å¸ƒå¼)çŽ¯å¢ƒä¸­ï¼Œè¿™ä¸ªæ“ä½œå°±æœ‰å¯èƒ½ä¸å†å…·æœ‰åŽŸå­æ€§äº†ã€‚ ç ”ç©¶è¿‡javaçš„jucåŒ…çš„äººåº”è¯¥éƒ½çŸ¥é“casï¼Œé‚£ä¹ˆredisä¹Ÿæä¾›äº†è¿™æ ·çš„ä¸€ä¸ªæœºåˆ¶ï¼Œå°±æ˜¯åˆ©ç”¨watchå‘½ä»¤æ¥å®žçŽ°çš„ã€‚ watchå‘½ä»¤æè¿° WATCHå‘½ä»¤å¯ä»¥ç›‘æŽ§ä¸€ä¸ªæˆ–å¤šä¸ªé”®ï¼Œä¸€æ—¦å…¶ä¸­æœ‰ä¸€ä¸ªé”®è¢«ä¿®æ”¹ï¼ˆæˆ–åˆ é™¤ï¼‰ï¼Œä¹‹åŽçš„äº‹åŠ¡å°±ä¸ä¼šæ‰§è¡Œã€‚ç›‘æŽ§ä¸€ç›´æŒç»­åˆ°EXECå‘½ä»¤ï¼ˆäº‹åŠ¡ä¸­çš„å‘½ä»¤æ˜¯åœ¨EXECä¹‹åŽæ‰æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åœ¨MULTIå‘½ä»¤åŽå¯ä»¥ä¿®æ”¹WATCHç›‘æŽ§çš„é”®å€¼ï¼‰ åˆ©ç”¨watchå®žçŽ°incrå…·ä½“åšæ³•å¦‚ä¸‹:123456WATCH mykeyval = GET mykeyval = val + 1MULTISET mykey $valEXEC å’Œæ­¤å‰ä»£ç ä¸åŒçš„æ˜¯ï¼Œæ–°ä»£ç åœ¨èŽ·å–mykeyçš„å€¼ä¹‹å‰å…ˆé€šè¿‡WATCHå‘½ä»¤ç›‘æŽ§äº†è¯¥é”®ï¼Œæ­¤åŽåˆå°†setå‘½ä»¤åŒ…å›´åœ¨äº‹åŠ¡ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆçš„ä¿è¯æ¯ä¸ªè¿žæŽ¥åœ¨æ‰§è¡ŒEXECä¹‹å‰ï¼Œå¦‚æžœå½“å‰è¿žæŽ¥èŽ·å–çš„mykeyçš„å€¼è¢«å…¶å®ƒè¿žæŽ¥çš„å®¢æˆ·ç«¯ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“å‰è¿žæŽ¥çš„EXECå‘½ä»¤å°†æ‰§è¡Œå¤±è´¥ã€‚è¿™æ ·è°ƒç”¨è€…åœ¨åˆ¤æ–­è¿”å›žå€¼åŽå°±å¯ä»¥èŽ·æ‚‰valæ˜¯å¦è¢«é‡æ–°è®¾ç½®æˆåŠŸã€‚ æ³¨æ„ç‚¹ç”±äºŽWATCHå‘½ä»¤çš„ä½œç”¨åªæ˜¯å½“è¢«ç›‘æŽ§çš„é”®å€¼è¢«ä¿®æ”¹åŽé˜»æ­¢ä¹‹åŽä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œï¼Œè€Œä¸èƒ½ä¿è¯å…¶ä»–å®¢æˆ·ç«¯ä¸ä¿®æ”¹è¿™ä¸€é”®å€¼ï¼Œæ‰€ä»¥åœ¨ä¸€èˆ¬çš„æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦åœ¨EXECæ‰§è¡Œå¤±è´¥åŽé‡æ–°æ‰§è¡Œæ•´ä¸ªå‡½æ•°ã€‚ æ‰§è¡ŒEXECå‘½ä»¤åŽä¼šå–æ¶ˆå¯¹æ‰€æœ‰é”®çš„ç›‘æŽ§ï¼Œå¦‚æžœä¸æƒ³æ‰§è¡Œäº‹åŠ¡ä¸­çš„å‘½ä»¤ä¹Ÿå¯ä»¥ä½¿ç”¨UNWATCHå‘½ä»¤æ¥å–æ¶ˆç›‘æŽ§ã€‚ å®žçŽ°ä¸€ä¸ªhsetNXå‡½æ•°æˆ‘ä»¬å®žçŽ°çš„hsetNXè¿™ä¸ªåŠŸèƒ½æ˜¯ï¼šä»…å½“å­—æ®µå­˜åœ¨æ—¶æ‰èµ‹å€¼ã€‚ ä¸ºäº†é¿å…ç«žæ€æ¡ä»¶æˆ‘ä»¬ä½¿ç”¨watchå’Œäº‹åŠ¡æ¥å®Œæˆè¿™ä¸€åŠŸèƒ½ï¼ˆä¼ªä»£ç ï¼‰ï¼š123456789WATCH key isFieldExists = HEXISTS key, field if isFieldExists is 1 MULTI HSET key, field, value EXEC else UNWATCH return isFieldExists åœ¨ä»£ç ä¸­ä¼šåˆ¤æ–­è¦èµ‹å€¼çš„å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æžœå­—æ®µä¸å­˜åœ¨çš„è¯å°±ä¸æ‰§è¡Œäº‹åŠ¡ä¸­çš„å‘½ä»¤ï¼Œä½†éœ€è¦ä½¿ç”¨UNWATCHå‘½ä»¤æ¥ä¿è¯ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸ä¼šå—åˆ°å½±å“ã€‚ åŽŸæ–‡åœ°å€ http://www.jianshu.com/p/361cb9cd13d5]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaå¤šçº¿ç¨‹(äºŒ) åŒæ­¥å’Œé”]]></title>
    <url>%2F2016%2F08%2F20%2Fjava-thread-2-md%2F</url>
    <content type="text"><![CDATA[è®°å½•ï¼Œæ±‡æ€» çº¿ç¨‹åŒæ­¥é—®é¢˜çš„äº§ç”Ÿä»€ä¹ˆæ˜¯çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µå–ç¥¨ç³»ç»Ÿçš„ä»£ç ï¼Œç„¶åŽå†åˆ†æžè¿™ä¸ªé—®é¢˜ï¼š1234567891011121314151617181920212223242526package com.sky.code.thread;public class TicketSeller implements Runnable &#123; private int num = 100; public void run() &#123; while(true) &#123; if(num&gt;0) &#123; try&#123; Thread.sleep(10); &#125;catch (InterruptedException e) &#123; e.printStackTrace(); &#125; //è¾“å‡ºå–ç¥¨ä¿¡æ¯ System.out.println(Thread.currentThread().getName()+".....sale...."+num--); &#125; else &#123; break; &#125; &#125; &#125;&#125; ä¸Šé¢æ˜¯å–ç¥¨çº¿ç¨‹ç±»ï¼Œä¸‹æ¥å†æ¥çœ‹çœ‹æ‰§è¡Œç±»ï¼š1234567891011121314151617181920package com.sky.code.thread;public class TickeDemo &#123; public static void main(String[] args) &#123; TicketSeller t = new TicketSeller();//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡å¯¹è±¡ã€‚ //åˆ›å»º4ä¸ªçº¿ç¨‹åŒæ—¶å–ç¥¨ Thread t1 = new Thread(t); Thread t2 = new Thread(t); Thread t3 = new Thread(t); Thread t4 = new Thread(t); //å¯åŠ¨çº¿ç¨‹ t1.start(); t2.start(); t3.start(); t4.start(); &#125;&#125; è¿è¡Œç¨‹åºç»“æžœå¦‚ä¸‹ï¼ˆä»…æˆªå–éƒ¨åˆ†æ•°æ®ï¼‰ï¼šä»Žè¿è¡Œç»“æžœï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæˆ‘ä»¬3ä¸ªå”®ç¥¨çª—å£åŒæ—¶å–å‡ºäº†96å·ç¥¨ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆé€»è¾‘çš„ï¼Œå…¶å®žè¿™ä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è¯´çš„çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚ä¸åŒçš„çº¿ç¨‹éƒ½å¯¹åŒä¸€ä¸ªæ•°æ®è¿›äº†æ“ä½œè¿™å°±å®¹æ˜“å¯¼è‡´æ•°æ®é”™ä¹±çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ä¸åŒæ­¥ã€‚é‚£ä¹ˆè¿™ä¸ªé—®é¢˜è¯¥æ€Žä¹ˆè§£å†³å‘¢ï¼Ÿåœ¨ç»™å‡ºè§£å†³æ€è·¯ä¹‹å‰æˆ‘ä»¬å…ˆæ¥åˆ†æžä¸€ä¸‹è¿™ä¸ªé—®é¢˜æ˜¯æ€Žä¹ˆäº§ç”Ÿçš„ï¼Ÿæˆ‘ä»¬å£°æ˜Žä¸€ä¸ªçº¿ç¨‹ç±»TicketSellerï¼Œåœ¨è¿™ä¸ªç±»ä¸­æˆ‘ä»¬åˆå£°æ˜Žäº†ä¸€ä¸ªæˆå‘˜å˜é‡numä¹Ÿå°±æ˜¯ç¥¨çš„æ•°é‡ï¼Œç„¶åŽæˆ‘ä»¬é€šè¿‡runæ–¹æ³•ä¸æ–­çš„åŽ»èŽ·å–ç¥¨æ•°å¹¶è¾“å‡ºï¼Œæœ€åŽæˆ‘ä»¬åœ¨å¤–éƒ¨ç±»TicketDemoä¸­åˆ›å»ºäº†å››ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œè¿™ä¸ªæ•°æ®ï¼Œè¿è¡ŒåŽå°±å‡ºçŽ°æˆ‘ä»¬åˆšæ‰æ‰€è¯´çš„çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œä»Žè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºäº§ç”Ÿçº¿ç¨‹åŒæ­¥(çº¿ç¨‹å®‰å…¨)é—®é¢˜çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š1.å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œå…±äº«çš„æ•°æ®ï¼ˆnumï¼‰ï¼Œ2.æ“ä½œå…±äº«æ•°æ®çš„çº¿ç¨‹ä»£ç æœ‰å¤šæ¡ï¼ˆ4æ¡çº¿ç¨‹ï¼‰ï¼›æ—¢ç„¶åŽŸå› çŸ¥é“äº†ï¼Œé‚£è¯¥æ€Žä¹ˆè§£å†³ï¼Ÿ è§£å†³æ€è·¯ï¼šå°†å¤šæ¡æ“ä½œå…±äº«æ•°æ®çš„çº¿ç¨‹ä»£ç å°è£…èµ·æ¥ï¼Œå½“æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œè¿™äº›ä»£ç çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹æ—¶ä¸å¯ä»¥å‚ä¸Žè¿ç®—çš„ã€‚å¿…é¡»è¦å½“å‰çº¿ç¨‹æŠŠè¿™äº›ä»£ç éƒ½æ‰§è¡Œå®Œæ¯•åŽï¼Œå…¶ä»–çº¿ç¨‹æ‰å¯ä»¥å‚ä¸Žè¿ç®—ã€‚ å¥½äº†ï¼Œæ€è·¯çŸ¥é“äº†ï¼Œæˆ‘ä»¬å°±ç”¨javaä»£ç çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ è§£å†³çº¿ç¨‹åŒæ­¥çš„ä¸¤ç§å…¸åž‹æ–¹æ¡ˆåœ¨javaä¸­æœ‰ä¸¤ç§æœºåˆ¶å¯ä»¥é˜²æ­¢çº¿ç¨‹å®‰å…¨çš„å‘ç”Ÿï¼ŒJavaè¯­è¨€æä¾›äº†ä¸€ä¸ªsynchronizedå…³é”®å­—æ¥è§£å†³è¿™é—®é¢˜ï¼ŒåŒæ—¶åœ¨Java SE5.0å¼•å…¥äº†Locké”å¯¹è±¡çš„ç›¸å…³ç±»ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«ä»‹ç»è¿™ä¸¤ç§æ–¹æ³• é€šè¿‡é”ï¼ˆLockï¼‰å¯¹è±¡çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜åœ¨ç»™å‡ºè§£å†³ä»£ç å‰æˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šLockï¼Œé”å¯¹è±¡ã€‚åœ¨javaä¸­é”æ˜¯ç”¨æ¥æŽ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼ˆä½†æœ‰çš„é”å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«èµ„æºï¼Œæ¯”å¦‚è¯»å†™é”ï¼ŒåŽé¢æˆ‘ä»¬ä¼šåˆ†æžï¼‰ã€‚åœ¨LockæŽ¥å£å‡ºçŽ°ä¹‹å‰ï¼Œjavaç¨‹åºæ˜¯é synchronizedå…³é”®å­—ï¼ˆåŽé¢åˆ†æžï¼‰å®žçŽ°é”åŠŸèƒ½çš„ï¼Œè€ŒJAVA SE5.0ä¹‹åŽå¹¶å‘åŒ…ä¸­æ–°å¢žäº†LockæŽ¥å£ç”¨æ¥å®žçŽ°é”çš„åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸Žsynchronizedå…³é”®å­—ç±»ä¼¼çš„åŒæ­¥åŠŸèƒ½ï¼Œåªæ˜¯åœ¨ä½¿ç”¨æ—¶éœ€è¦æ˜¾å¼åœ°èŽ·å–å’Œé‡Šæ”¾é”ï¼Œç¼ºç‚¹å°±æ˜¯ç¼ºå°‘åƒsynchronizedé‚£æ ·éšå¼èŽ·å–é‡Šæ”¾é”çš„ä¾¿æ·æ€§ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†é”èŽ·å–ä¸Žé‡Šæ”¾çš„å¯æ“ä½œæ€§ï¼Œå¯ä¸­æ–­çš„èŽ·å–é”ä»¥åŠè¶…æ—¶èŽ·å–é”ç­‰å¤šç§synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„åŒæ­¥ç‰¹æ€§ã€‚æŽ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ä»‹ç»LockæŽ¥å£çš„ä¸»è¦APIæ–¹ä¾¿æˆ‘ä»¬å­¦ä¹  æ–¹æ³• ç›¸å…³æè¿°å†…å®¹ void lock() èŽ·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å½“å‰çº¿ç¨‹ä¼šèŽ·å–é”ï¼Œå½“èŽ·å–é”åŽã€‚ä»Žè¯¥æ–¹æ³•è¿”å›ž void lockInterruptibly() throws InterruptedException å¯ä¸­æ–­èŽ·å–é”å’Œlock()æ–¹æ³•ä¸åŒçš„æ˜¯è¯¥æ–¹æ³•ä¼šå“åº”ä¸­æ–­ï¼Œå³åœ¨èŽ·å–é”ä¸­å¯ä»¥ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚ä¾‹å¦‚æŸä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ä¸€ä¸ªé”çš„æŽ§åˆ¶æƒçš„è¿™æ®µæ—¶é—´éœ€è¦ä¸­æ–­ã€‚ boolean tryLock() å°è¯•éžé˜»å¡žèŽ·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•åŽç«‹å³è¿”å›žï¼Œå¦‚æžœèƒ½å¤ŸèŽ·å–é”åˆ™è¿”å›žtrueï¼Œå¦åˆ™è¿”å›žfalseã€‚ boolean tryLock(long time,TimeUnit unit) throws InterruptedException è¶…æ—¶èŽ·å–é”ï¼Œå½“å‰çº¿ç¨‹åœ¨ä»¥ä¸‹3ç§æƒ…å†µè¿”å›žï¼š1.å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…èŽ·å–äº†é”2.å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´è¢«ä¸­æ–­3.å½“å‰çº¿ç¨‹è¶…æ—¶æ—¶é—´ç»“æŸï¼Œè¿”å›žfalse void unlock() é‡Šæ”¾é” Condition newCondition() æ¡ä»¶å¯¹è±¡ï¼ŒèŽ·å–ç­‰å¾…é€šçŸ¥ç»„ä»¶ã€‚è¯¥ç»„ä»¶å’Œå½“å‰çš„é”ç»‘å®šï¼Œå½“å‰çº¿ç¨‹åªæœ‰èŽ·å–äº†é”ï¼Œæ‰èƒ½è°ƒç”¨è¯¥ç»„ä»¶çš„await()æ–¹æ³•ï¼Œè€Œè°ƒç”¨åŽï¼Œå½“å‰çº¿ç¨‹å°†é‡Šæ”¾é”ã€‚ è¿™é‡Œå…ˆä»‹ç»ä¸€ä¸‹APIï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬å°†ç»“åˆLockæŽ¥å£çš„å®žçŽ°å­ç±»ReentrantLockæ¥è®²è§£ä¸‹ä»–çš„å‡ ä¸ªæ–¹æ³•ã€‚ ReentrantLockï¼ˆé‡å…¥é”)é‡å…¥é”ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æ”¯æŒé‡æ–°è¿›å…¥çš„é”ï¼Œå®ƒè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è°ƒç”¨lock()æ–¹æ³•æ—¶ï¼Œå·²ç»èŽ·å–åˆ°é”çš„çº¿ç¨‹ï¼Œèƒ½å¤Ÿå†æ¬¡è°ƒç”¨lock()æ–¹æ³•èŽ·å–é”è€Œä¸è¢«é˜»å¡žï¼ŒåŒæ—¶è¿˜æ”¯æŒèŽ·å–é”çš„å…¬å¹³æ€§å’Œéžå…¬å¹³æ€§ã€‚è¿™é‡Œçš„å…¬å¹³æ˜¯åœ¨ç»å¯¹æ—¶é—´ä¸Šï¼Œå…ˆå¯¹é”è¿›è¡ŒèŽ·å–çš„è¯·æ±‚ä¸€å®šå…ˆè¢«æ»¡è¶³ï¼Œé‚£ä¹ˆè¿™ä¸ªé”æ˜¯å…¬å¹³é”ï¼Œåä¹‹ï¼Œæ˜¯ä¸å…¬å¹³çš„(ä½†æ˜¯å¦‚æžœä¸æ˜¯éœ€è¦ï¼Œå»ºè®®ä¸è¦ç”¨å…¬å¹³é”ï¼Œå› ä¸ºä¼šé€ æˆä¸€äº›èµ„æºçš„æ²¡å¿…è¦ç­‰å¾…ï¼Œæµªè´¹æ€§èƒ½)ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿçœ‹èŒƒä¾‹ä»£ç ï¼š1.åŒæ­¥æ‰§è¡Œçš„ä»£ç è·Ÿsynchronizedç±»ä¼¼åŠŸèƒ½ï¼š123456789ReentrantLock lock = new ReentrantLock(); //å‚æ•°é»˜è®¤falseï¼Œä¸å…¬å¹³é” ReentrantLock lock = new ReentrantLock(true); //å…¬å¹³é” lock.lock(); //å¦‚æžœè¢«å…¶å®ƒèµ„æºé”å®šï¼Œä¼šåœ¨æ­¤ç­‰å¾…é”é‡Šæ”¾ï¼Œè¾¾åˆ°æš‚åœçš„æ•ˆæžœ try &#123; //æ“ä½œ &#125; finally &#123; lock.unlock(); //é‡Šæ”¾é” &#125; 2.é˜²æ­¢é‡å¤æ‰§è¡Œä»£ç ï¼š12345678ReentrantLock lock = new ReentrantLock(); if (lock.tryLock()) &#123; //å¦‚æžœå·²ç»è¢«lockï¼Œåˆ™ç«‹å³è¿”å›žfalseä¸ä¼šç­‰å¾…ï¼Œè¾¾åˆ°å¿½ç•¥æ“ä½œçš„æ•ˆæžœ try &#123; //æ“ä½œ &#125; finally &#123; lock.unlock(); &#125; &#125; 3.å°è¯•ç­‰å¾…æ‰§è¡Œçš„ä»£ç ï¼š12345678910111213ReentrantLock lock = new ReentrantLock(true); //å…¬å¹³é” try &#123; if (lock.tryLock(5, TimeUnit.SECONDS)) &#123; //å¦‚æžœå·²ç»è¢«lockï¼Œå°è¯•ç­‰å¾…5sï¼Œçœ‹æ˜¯å¦å¯ä»¥èŽ·å¾—é”ï¼Œå¦‚æžœ5såŽä»ç„¶æ— æ³•èŽ·å¾—é”åˆ™è¿”å›žfalseç»§ç»­æ‰§è¡Œ try &#123; //æ“ä½œ &#125; finally &#123; lock.unlock(); &#125; &#125; &#125; catch (InterruptedException e) &#123; e.printStackTrace(); //å½“å‰çº¿ç¨‹è¢«ä¸­æ–­æ—¶(interrupt)ï¼Œä¼šæŠ›InterruptedException &#125; è¿™é‡Œæœ‰ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ï¼ŒæŠŠè§£é”æ“ä½œæ”¾åœ¨finallyä»£ç å—å†…è¿™ä¸ªååˆ†é‡è¦ã€‚å¦‚æžœåœ¨ä¸´ç•ŒåŒºçš„ä»£ç æŠ›å‡ºå¼‚å¸¸ï¼Œé”å¿…é¡»è¢«é‡Šæ”¾ã€‚å¦åˆ™ï¼Œå…¶ä»–çº¿ç¨‹å°†æ°¸è¿œé˜»å¡žã€‚å¥½äº†ï¼ŒReentrantLockæˆ‘ä»¬å°±ç®€å•ä»‹ç»åˆ°è¿™é‡Œï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ReentrantLockæ¥è§£å†³å‰é¢å–ç¥¨çº¿ç¨‹çš„çº¿ç¨‹åŒæ­¥ï¼ˆå®‰å…¨ï¼‰é—®é¢˜ï¼Œä»£ç å¦‚ä¸‹ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041package com.sky.code.thread;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;public class TicketSellerWithLock implements Runnable &#123; //åˆ›å»ºé”å¯¹è±¡ private Lock ticketLock = new ReentrantLock(); //åˆ›å»ºé”å¯¹è±¡(å…¬å¹³é”) //private Lock ticketLock = new ReentrantLock(true); private int num = 100; public void run() &#123; while(true) &#123; ticketLock.lock();//èŽ·å–é” if(num&gt;0) &#123; try&#123; Thread.sleep(10); //è¾“å‡ºå–ç¥¨ä¿¡æ¯ System.out.println(Thread.currentThread().getName()+".....sale...."+num--); &#125;catch (InterruptedException e) &#123; Thread.currentThread().interrupt();//ç»§ç»­ä¸­æ–­å¼‚å¸¸ &#125;finally &#123; ticketLock.unlock();//é‡Šæ”¾é” &#125; &#125; else &#123; ticketLock.unlock();//é‡Šæ”¾é” break; &#125; &#125; &#125;&#125; TicketDemoç±»æ— éœ€å˜åŒ–ï¼Œçº¿ç¨‹å®‰å…¨é—®é¢˜å°±æ­¤è§£å†³ã€‚ä½†æ˜¯è¿˜æ˜¯è¦è¯´ä¸€ä¸‹å…¬å¹³é”çš„é—®é¢˜ï¼Œä¸Šé¢ä¾‹å­ï¼Œä¸å¼€å…¬å¹³é”çš„ç»“æžœå¦‚ä¸‹ï¼šå¼€å…¬å¹³é”çš„ç»“æžœå¦‚ä¸‹ï¼šä½ ä¼šå‘çŽ°ä¸å¼€å…¬å¹³é”ï¼Œcpué’Ÿçˆ±ç”¨ç¬¬ä¸€ä¸ªçº¿ç¨‹åšäº‹æƒ…ï¼Œè€Œå¼€äº†å…¬å¹³é”åŽï¼ŒåŸºæœ¬æ˜¯å„ä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚ä¸Šé¢æåˆ°å…¬å¹³é”æ˜¯ä¼šæ¶ˆè€—æ€§èƒ½çš„ï¼Œå¦‚æžœCPUè°ƒåº¦çš„æ—¶å€™é€‰æ‹©çš„ä¸æ˜¯å…¬å¹³è°ƒåº¦çš„é‚£ä¸ªçº¿ç¨‹ï¼ŒCPUä¼šæ”¾å¼ƒæœ¬æ¬¡è°ƒåº¦ï¼Œå¹²åˆ«çš„äº‹æƒ…ï¼Œå¦‚æžœè€æ˜¯è°ƒåº¦ä¸åˆ°çš„è¯ï¼Œæ˜¯æµªè´¹CPUè°ƒåº¦çš„ã€‚ é€šè¿‡synchroniedå…³é”®å­—çš„æ–¹å¼è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜åœ¨Javaä¸­å†…ç½®äº†è¯­è¨€çº§çš„åŒæ­¥åŽŸè¯­ï¼synchronizedï¼Œè¿™ä¸ªå¯ä»¥å¤§å¤§ç®€åŒ–äº†Javaä¸­å¤šçº¿ç¨‹åŒæ­¥çš„ä½¿ç”¨ã€‚ä»ŽJAVA SE1.0å¼€å§‹ï¼Œjavaä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå†…éƒ¨é”ï¼Œå¦‚æžœä¸€ä¸ªæ–¹æ³•ä½¿ç”¨synchronizedå…³é”®å­—è¿›è¡Œå£°æ˜Žï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¿æŠ¤æ•´ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨è¯¥æ–¹æ³•çº¿ç¨‹å¿…é¡»èŽ·å¾—å†…éƒ¨çš„å¯¹è±¡é”ã€‚123public synchronized void method&#123; //method body &#125; ç­‰ä»·äºŽ123456789private Lock ticketLock = new ReentrantLock(); public void method&#123; ticketLock.lock(); try&#123; //....... &#125;finally&#123; ticketLock.unlock(); &#125; &#125; ä»Žè¿™é‡Œå¯ä»¥çœ‹å‡ºä½¿ç”¨synchronizedå…³é”®å­—æ¥ç¼–å†™ä»£ç è¦ç®€æ´å¾—å¤šäº†ã€‚å½“ç„¶ï¼Œè¦ç†è§£è¿™ä¸€ä»£ç ï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå†…éƒ¨é”ï¼Œå¹¶ä¸”è¯¥é”æœ‰ä¸€ä¸ªå†…éƒ¨æ¡ä»¶ã€‚ç”±é”æ¥ç®¡ç†é‚£äº›è¯•å›¾è¿›å…¥synchronizedæ–¹æ³•çš„çº¿ç¨‹ï¼Œç”±æ¡ä»¶æ¥ç®¡é‚£äº›è°ƒç”¨waitçš„çº¿ç¨‹(wait()/notifyAll/notify())ã€‚åŒæ—¶æˆ‘ä»¬å¿…é¡»æ˜Žç™½ä¸€æ—¦æœ‰ä¸€ä¸ªçº¿ç¨‹é€šè¿‡synchroniedæ–¹æ³•èŽ·å–åˆ°å†…éƒ¨é”ï¼Œè¯¥ç±»çš„æ‰€æœ‰synchroniedæ–¹æ³•æˆ–è€…ä»£ç å—éƒ½æ— æ³•è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ç›´åˆ°å½“å‰çº¿ç¨‹é‡Šæ”¾äº†å†…éƒ¨é”ã€‚åˆšæ‰ä¸Šé¢è¯´çš„æ˜¯åŒæ­¥æ–¹æ³•ï¼Œsynchronizedè¿˜æœ‰ä¸€ç§åŒæ­¥ä»£ç å—çš„å®žçŽ°æ–¹å¼ï¼š1234Object obj = new Object(); synchronized(obj)&#123; //éœ€è¦åŒæ­¥çš„ä»£ç  &#125; å…¶ä¸­objæ˜¯å¯¹è±¡é”ï¼Œå¯ä»¥æ˜¯ä»»æ„å¯¹è±¡ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±é€šè¿‡å…¶ä¸­çš„ä¸€ä¸ªæ–¹æ³•æ¥è§£å†³å”®ç¥¨ç³»ç»Ÿçš„çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼š1234567891011121314151617181920class Ticket implements Runnable &#123; private int num = 100; Object obj = new Object(); public void run() &#123; while(true) &#123; synchronized(obj) &#123; if(num&gt;0) &#123; try&#123;Thread.sleep(10);&#125;catch (InterruptedException e)&#123;&#125; System.out.println(Thread.currentThread().getName()+".....sale...."+num--); &#125; &#125; &#125; &#125; &#125; å—¯ï¼ŒåŒæ­¥ä»£ç å—è§£å†³ï¼Œè¿è¡Œç»“æžœä¹Ÿæ­£å¸¸ã€‚åˆ°æ­¤åŒæ­¥é—®é¢˜ä¹Ÿå°±è§£å†³äº†ï¼Œå½“ç„¶ä»£ç åŒæ­¥ä¹Ÿæ˜¯è¦ç‰ºç‰²æ•ˆçŽ‡ä¸ºå‰æçš„ï¼šåŒæ­¥çš„å¥½å¤„ï¼šè§£å†³äº†çº¿ç¨‹çš„å®‰å…¨é—®é¢˜ã€‚åŒæ­¥çš„å¼Šç«¯ï¼šç›¸å¯¹é™ä½Žäº†æ•ˆçŽ‡ï¼Œå› ä¸ºåŒæ­¥å¤–çš„çº¿ç¨‹çš„éƒ½ä¼šåˆ¤æ–­åŒæ­¥é”ã€‚åŒæ­¥çš„å‰æï¼šåŒæ­¥ä¸­å¿…é¡»æœ‰å¤šä¸ªçº¿ç¨‹å¹¶ä½¿ç”¨åŒä¸€ä¸ªé”ã€‚ çº¿ç¨‹é—´çš„é€šä¿¡æœºåˆ¶çº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œæ‹¥æœ‰è‡ªå·±çš„æ ˆç©ºé—´ï¼Œä½†æ˜¯å¦‚æžœæ¯ä¸ªè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå¦‚æžœä»…ä»…æ˜¯å­¤ç«‹åœ°è¿è¡Œï¼Œé‚£ä¹ˆæ²¡æœ‰ä¸€ç‚¹å„¿ä»·å€¼ï¼Œæˆ–è€…æ˜¯ä»·å€¼å¾ˆå°ï¼Œå¦‚æžœå¤šçº¿ç¨‹èƒ½å¤Ÿç›¸äº’é…åˆå®Œæˆå·¥ä½œçš„è¯ï¼Œè¿™å°†å¸¦æ¥å·¨å¤§çš„ä»·å€¼ï¼Œè¿™ä¹Ÿå°±æ˜¯çº¿ç¨‹é—´çš„é€šä¿¡å•¦ã€‚åœ¨javaä¸­å¤šçº¿ç¨‹é—´çš„é€šä¿¡ä½¿ç”¨çš„æ˜¯ç­‰å¾…/é€šçŸ¥æœºåˆ¶æ¥å®žçŽ°çš„ã€‚ synchroniedå…³é”®å­—ç­‰å¾…/é€šçŸ¥æœºåˆ¶æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨äº†å¯¹è±¡Oçš„wait()æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹Bè°ƒç”¨äº†å¯¹è±¡Oçš„notify()æˆ–è€…notifyAll()æ–¹æ³•ï¼Œçº¿ç¨‹Aæ”¶åˆ°é€šçŸ¥åŽä»Žå¯¹è±¡Oçš„wait()æ–¹æ³•è¿”å›žï¼Œè¿›è€Œæ‰§è¡ŒåŽç»­æ“ä½œã€‚ä¸Šè¿°çš„ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡å¯¹è±¡Oæ¥å®Œæˆäº¤äº’ï¼Œè€Œå¯¹è±¡ä¸Šçš„wait()å’Œnotify()/notifyAll()çš„å…³ç³»å°±å¦‚åŒå¼€å…³ä¿¡å·ä¸€æ ·ï¼Œç”¨æ¥å®Œæˆç­‰å¾…æ–¹å’Œé€šçŸ¥æ–¹ä¹‹é—´çš„äº¤äº’å·¥ä½œã€‚ç­‰å¾…/é€šçŸ¥æœºåˆ¶ä¸»è¦æ˜¯ç”¨åˆ°çš„å‡½æ•°æ–¹æ³•æ˜¯notify()/notifyAll(),wait()/wait(long),wait(long,int),è¿™äº›æ–¹æ³•åœ¨ä¸Šä¸€ç¯‡æ–‡ç« éƒ½æœ‰è¯´æ˜Žè¿‡ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚å½“ç„¶è¿™æ˜¯é’ˆå¯¹synchroniedå…³é”®å­—ä¿®é¥°çš„å‡½æ•°æˆ–ä»£ç å—ï¼Œå› ä¸ºè¦ä½¿ç”¨notify()/notifyAll(),wait()/wait(long),wait(long,int)è¿™äº›æ–¹æ³•çš„å‰ææ˜¯å¯¹è°ƒç”¨å¯¹è±¡åŠ é”ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½åœ¨åŒæ­¥å‡½æ•°æˆ–è€…åŒæ­¥ä»£ç å—ä¸­ä½¿ç”¨ã€‚ æ¡ä»¶å¯¹è±¡çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶æ‰€è°“çš„æ¡ä»¶å¯¹è±¡ä¹Ÿå°±æ˜¯é…åˆå‰é¢æˆ‘ä»¬åˆ†æžçš„Locké”å¯¹è±¡ï¼Œé€šè¿‡é”å¯¹è±¡çš„æ¡ä»¶å¯¹è±¡æ¥å®žçŽ°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚é‚£ä¹ˆæ¡ä»¶å¯¹è±¡æ˜¯æ€Žä¹ˆåˆ›å»ºçš„å‘¢ï¼Ÿ12//åˆ›å»ºæ¡ä»¶å¯¹è±¡ Condition conditionObj=ticketLock.newCondition(); å°±è¿™æ ·æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ¡ä»¶å¯¹è±¡ã€‚æ³¨æ„è¿™é‡Œè¿”å›žçš„å¯¹è±¡æ˜¯ä¸Žè¯¥é”ï¼ˆticketLockï¼‰ç›¸å…³çš„æ¡ä»¶å¯¹è±¡ã€‚ä¸‹é¢æ˜¯æ¡ä»¶å¯¹è±¡çš„APIï¼š æ–¹æ³• å‡½æ•°æ–¹æ³•å¯¹åº”çš„æè¿° void await() å°†è¯¥çº¿ç¨‹æ”¾åˆ°æ¡ä»¶ç­‰å¾…æ± ä¸­ï¼ˆå¯¹åº”wait()æ–¹æ³•ï¼‰ void signalAll() è§£é™¤è¯¥æ¡ä»¶ç­‰å¾…æ± ä¸­æ‰€æœ‰çº¿ç¨‹çš„é˜»å¡žçŠ¶æ€ï¼ˆå¯¹åº”notifyAll()æ–¹æ³•ï¼‰ void signal() ä»Žè¯¥æ¡ä»¶çš„ç­‰å¾…æ± ä¸­éšæœºåœ°é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ï¼Œè§£é™¤å…¶é˜»å¡žçŠ¶æ€ï¼ˆå¯¹åº”notify()æ–¹æ³•ï¼‰ ä¸Šè¿°æ–¹æ³•çš„è¿‡ç¨‹åˆ†æžï¼šä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨äº†æ¡ä»¶å¯¹è±¡çš„await()æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹Bè°ƒç”¨äº†æ¡ä»¶å¯¹è±¡çš„signal()æˆ–è€…signalAll()æ–¹æ³•ï¼Œçº¿ç¨‹Aæ”¶åˆ°é€šçŸ¥åŽä»Žæ¡ä»¶å¯¹è±¡çš„await()æ–¹æ³•è¿”å›žï¼Œè¿›è€Œæ‰§è¡ŒåŽç»­æ“ä½œã€‚ä¸Šè¿°çš„ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡æ¡ä»¶å¯¹è±¡æ¥å®Œæˆäº¤äº’ï¼Œè€Œå¯¹è±¡ä¸Šçš„await()å’Œsignal()/signalAll()çš„å…³ç³»å°±å¦‚åŒå¼€å…³ä¿¡å·ä¸€æ ·ï¼Œç”¨æ¥å®Œæˆç­‰å¾…æ–¹å’Œé€šçŸ¥æ–¹ä¹‹é—´çš„äº¤äº’å·¥ä½œã€‚å½“ç„¶è¿™æ ·çš„æ“ä½œéƒ½æ˜¯å¿…é¡»åŸºäºŽæ¡ä»¶å¯¹è±¡çš„é”çš„ï¼Œå½“å‰çº¿ç¨‹åªæœ‰èŽ·å–äº†é”ï¼Œæ‰èƒ½è°ƒç”¨è¯¥æ¡ä»¶å¯¹è±¡çš„await()æ–¹æ³•ï¼Œè€Œè°ƒç”¨åŽï¼Œå½“å‰çº¿ç¨‹å°†é‡Šæ”¾é”ã€‚ è¿™é‡Œæœ‰ç‚¹è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œä¸Šè¿°ä¸¤ç§ç­‰å¾…/é€šçŸ¥æœºåˆ¶ä¸­ï¼Œæ— è®ºæ˜¯è°ƒç”¨äº†signal()/signalAll()æ–¹æ³•è¿˜æ˜¯è°ƒç”¨äº†notify()/notifyAll()æ–¹æ³•å¹¶ä¸ä¼šç«‹å³æ¿€æ´»ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚å®ƒä»¬ä»…ä»…éƒ½åªæ˜¯è§£é™¤ç­‰å¾…çº¿ç¨‹çš„é˜»å¡žçŠ¶æ€ï¼Œä»¥ä¾¿è¿™äº›çº¿ç¨‹å¯ä»¥åœ¨å½“å‰çº¿ç¨‹è§£é”æˆ–è€…é€€å‡ºåŒæ­¥æ–¹æ³•åŽï¼Œé€šè¿‡äº‰å¤ºCPUæ‰§è¡Œæƒå®žçŽ°å¯¹å¯¹è±¡çš„è®¿é—®ã€‚åˆ°æ­¤ï¼Œçº¿ç¨‹é€šä¿¡æœºåˆ¶çš„æ¦‚å¿µåˆ†æžå®Œï¼Œæˆ‘ä»¬ä¸‹é¢é€šè¿‡ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼æ¥å®žçŽ°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚ ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹ï¼Œä¸€ä¸ªçº¿ç¨‹ç”Ÿäº§ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç­‰å¾…/é€šçŸ¥æœºåˆ¶ä¸‹çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼šæˆ‘ä»¬å‡è®¾è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬æ˜¯å–åŒ—äº¬çƒ¤é¸­åº—é“ºï¼Œæˆ‘ä»¬çŽ°åœ¨åªæœ‰ä¸€æ¡ç”Ÿäº§çº¿ä¹Ÿåªæœ‰ä¸€æ¡æ¶ˆè´¹çº¿ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½ç”Ÿäº§çº¿ç¨‹ç”Ÿäº§å®Œäº†ï¼Œå†é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹æ‰èƒ½åŽ»å–ï¼Œå¦‚æžœæ¶ˆè´¹çº¿ç¨‹æ²¡çƒ¤é¸­äº†ï¼Œå°±å¿…é¡»é€šçŸ¥ç”Ÿäº§çº¿ç¨‹åŽ»ç”Ÿäº§ï¼Œæ­¤æ—¶æ¶ˆè´¹çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚åœ¨è¿™æ ·çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¸ä»…è¦ä¿è¯å…±äº«æ•°æ®ï¼ˆçƒ¤é¸­æ•°é‡ï¼‰çš„çº¿ç¨‹å®‰å…¨ï¼Œè€Œä¸”è¿˜è¦ä¿è¯çƒ¤é¸­æ•°é‡åœ¨æ¶ˆè´¹ä¹‹å‰å¿…é¡»æœ‰çƒ¤é¸­ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡javaä»£ç æ¥å®žçŽ°ï¼šåŒ—äº¬çƒ¤é¸­ç”Ÿäº§èµ„æºç±»KaoYaResourceï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344package com.sky.code.thread;public class KaoYaResource &#123; private String name; private int count = 1;//çƒ¤é¸­çš„åˆå§‹æ•°é‡ private boolean flag = false;//åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦çº¿ç¨‹ç­‰å¾…çš„æ ‡å¿— /** * ç”Ÿäº§çƒ¤é¸­ */ public synchronized void product(String name)&#123; if(flag)&#123; //æ­¤æ—¶æœ‰çƒ¤é¸­ï¼Œç­‰å¾… try &#123; this.wait(); &#125; catch (InterruptedException e) &#123; e.printStackTrace() ; &#125; &#125; this.name=name+count;//è®¾ç½®çƒ¤é¸­çš„åç§° count++; System.out.println(Thread.currentThread().getName()+"...ç”Ÿäº§è€…..."+this.name); flag=true;//æœ‰çƒ¤é¸­åŽæ”¹å˜æ ‡å¿— notifyAll();//é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯ä»¥æ¶ˆè´¹äº† &#125; /** * æ¶ˆè´¹çƒ¤é¸­ */ public synchronized void consume()&#123; if(!flag)&#123;//å¦‚æžœæ²¡æœ‰çƒ¤é¸­å°±ç­‰å¾… try&#123; this.wait(); &#125;catch(InterruptedException e)&#123; &#125; &#125; System.out.println(Thread.currentThread().getName()+"...æ¶ˆè´¹è€…........"+this.name);//æ¶ˆè´¹çƒ¤é¸­1 flag = false; notifyAll();//é€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§çƒ¤é¸­ &#125;&#125; åœ¨è¿™ä¸ªç±»ä¸­æˆ‘ä»¬æœ‰ä¸¤ä¸ªsynchronizedçš„åŒæ­¥æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ç”Ÿäº§çƒ¤é¸­çš„ï¼Œä¸€ä¸ªæ˜¯æ¶ˆè´¹çƒ¤é¸­çš„ï¼Œä¹‹æ‰€ä»¥éœ€è¦åŒæ­¥æ˜¯å› ä¸ºæˆ‘ä»¬æ“ä½œäº†å…±äº«æ•°æ®countï¼ŒåŒæ—¶ä¸ºäº†ä¿è¯ç”Ÿäº§çƒ¤é¸­åŽæ‰èƒ½æ¶ˆè´¹ä¹Ÿå°±æ˜¯ç”Ÿäº§ä¸€åªçƒ¤é¸­åŽæ‰èƒ½æ¶ˆè´¹ä¸€åªçƒ¤é¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œwait()å’Œnotify()ã€‚å½“ç¬¬ä¸€æ¬¡è¿è¡Œç”Ÿäº§çŽ°åœºæ—¶è°ƒç”¨ç”Ÿäº§çš„æ–¹æ³•ï¼Œæ­¤æ—¶æœ‰ä¸€åªçƒ¤é¸­ï¼Œå³flag=falseï¼Œæ— éœ€ç­‰å¾…ï¼Œå› æ­¤æˆ‘ä»¬è®¾ç½®å¯æ¶ˆè´¹çš„çƒ¤é¸­åç§°ç„¶åŽæ”¹å˜flag=trueï¼ŒåŒæ—¶é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯ä»¥æ¶ˆè´¹çƒ¤é¸­äº†ï¼Œå³ä½¿æ­¤æ—¶ç”Ÿäº§çº¿ç¨‹å†æ¬¡æŠ¢åˆ°æ‰§è¡Œæƒï¼Œå› ä¸ºflag=trueï¼Œæ‰€ä»¥ç”Ÿäº§çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…é˜»å¡žçŠ¶æ€ï¼Œæ¶ˆè´¹çº¿ç¨‹è¢«å”¤é†’åŽå°±è¿›å…¥æ¶ˆè´¹æ–¹æ³•ï¼Œæ¶ˆè´¹å®ŒæˆåŽï¼Œåˆæ”¹å˜æ ‡å¿—flag=falseï¼Œé€šçŸ¥ç”Ÿäº§çº¿ç¨‹å¯ä»¥ç”Ÿäº§çƒ¤é¸­äº†â€¦â€¦â€¦ä»¥æ­¤å¾ªçŽ¯ã€‚ç”Ÿäº§æ¶ˆè´¹æ‰§è¡Œç±»Single_Producer_Consumer.java:12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061package com.sky.code.thread;public class Single_Producer_Consumer &#123; public static void main(String[] args) &#123; KaoYaResource r = new KaoYaResource(); Producer pro = new Producer(r); Consumer con = new Consumer(r); //ç”Ÿäº§è€…çº¿ç¨‹ Thread t0 = new Thread(pro); //æ¶ˆè´¹è€…çº¿ç¨‹ Thread t2 = new Thread(con); //å¯åŠ¨çº¿ç¨‹ t0.start(); t2.start(); &#125;&#125;class Producer implements Runnable&#123; private KaoYaResource r; Producer(KaoYaResource r) &#123; this.r = r; &#125; public void run() &#123; while(true) &#123; r.product("åŒ—äº¬çƒ¤é¸­"); try &#123; Thread.sleep(100); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125;class Consumer implements Runnable&#123; private KaoYaResource r; Consumer(KaoYaResource r) &#123; this.r = r; &#125; public void run() &#123; while(true) &#123; r.consume(); try &#123; Thread.sleep(100); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; åœ¨è¿™ä¸ªç±»ä¸­æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯ç”Ÿäº§è€…çº¿ç¨‹ï¼Œæˆ‘ä»¬åˆ†åˆ«å¼€å¯è¿™ä¸¤ä¸ªçº¿ç¨‹ç”¨äºŽä¸æ–­çš„ç”Ÿäº§æ¶ˆè´¹ï¼Œè¿è¡Œç»“æžœå¦‚ä¸‹ï¼š12345678910111213141516171819hread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­1Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­1Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­2Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­2Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­3Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­3Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­4Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­4Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­5Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­5Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­6Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­6Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­7Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­7Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­8Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­8Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­9Thread-1...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­9..... å¾ˆæ˜¾ç„¶çš„æƒ…å†µå°±æ˜¯ç”Ÿäº§ä¸€åªçƒ¤é¸­ç„¶åŽå°±æ¶ˆè´¹ä¸€åªçƒ¤é¸­ã€‚è¿è¡Œæƒ…å†µå®Œå…¨æ­£å¸¸ï¼Œå—¯ï¼Œè¿™å°±æ˜¯å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼ã€‚ä¸Šé¢ä½¿ç”¨çš„æ˜¯synchronizedå…³é”®å­—çš„æ–¹å¼å®žçŽ°çš„ï¼Œé‚£ä¹ˆæŽ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨å¯¹è±¡é”çš„æ–¹å¼å®žçŽ°ï¼šKaoYaResourceByLock.java1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859package com.sky.code.thread;import java.util.concurrent.locks.Condition;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;public class KaoYaResourceByLock &#123; private String name; private int count = 1;//çƒ¤é¸­çš„åˆå§‹æ•°é‡ private boolean flag = false;//åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦çº¿ç¨‹ç­‰å¾…çš„æ ‡å¿— //åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡ private Lock resourceLock=new ReentrantLock(); //åˆ›å»ºæ¡ä»¶å¯¹è±¡ private Condition condition= resourceLock.newCondition(); /** * ç”Ÿäº§çƒ¤é¸­ */ public void product(String name)&#123; resourceLock.lock();//å…ˆèŽ·å–é” try&#123; if(flag)&#123; try &#123; condition.await(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; this.name=name+count;//è®¾ç½®çƒ¤é¸­çš„åç§° count++; System.out.println(Thread.currentThread().getName()+"...ç”Ÿäº§è€…..."+this.name); flag=true;//æœ‰çƒ¤é¸­åŽæ”¹å˜æ ‡å¿— condition.signalAll();//é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯ä»¥æ¶ˆè´¹äº† &#125;finally&#123; resourceLock.unlock(); &#125; &#125; /** * æ¶ˆè´¹çƒ¤é¸­ */ public void consume()&#123; resourceLock.lock(); try&#123; if(!flag)&#123;//å¦‚æžœæ²¡æœ‰çƒ¤é¸­å°±ç­‰å¾… try&#123; condition.await(); &#125;catch(InterruptedException e)&#123; &#125; &#125; System.out.println(Thread.currentThread().getName()+"...æ¶ˆè´¹è€…........"+this.name);//æ¶ˆè´¹çƒ¤é¸­1 flag = false; condition.signalAll();//é€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§çƒ¤é¸­ &#125;finally&#123; resourceLock.unlock(); &#125; &#125;&#125; ä»£ç å˜åŒ–ä¸å¤§ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹è±¡é”çš„æ–¹å¼åŽ»å®žçŽ°ï¼Œé¦–å…ˆè¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡é”ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„é‡å…¥é”ReestrantLockç±»ï¼Œç„¶åŽé€šè¿‡æ‰‹åŠ¨è®¾ç½®lock()å’Œunlock()çš„æ–¹å¼åŽ»èŽ·å–é”ä»¥åŠé‡Šæ”¾é”ã€‚ä¸ºäº†å®žçŽ°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»é€šè¿‡é”å¯¹è±¡åŽ»åˆ›å»ºä¸€ä¸ªæ¡ä»¶å¯¹è±¡Conditionï¼Œç„¶åŽé€šè¿‡é”å¯¹è±¡çš„await()å’ŒsignalAll()æ–¹æ³•åŽ»å®žçŽ°ç­‰å¾…ä»¥åŠé€šçŸ¥æ“ä½œã€‚Single_Producer_Consumer.javaä»£ç æ›¿æ¢ä¸€ä¸‹èµ„æºç±»å³å¯,è¿è¡Œç»“æžœä¸€æ ·ã€‚ å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼åˆ†æžå®Œäº†å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼ï¼Œæˆ‘ä»¬å†æ¥èŠèŠå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å¤šæ¡ç”Ÿäº§çº¿ç¨‹é…åˆå¤šæ¡æ¶ˆè´¹çº¿ç¨‹ã€‚æ—¢ç„¶è¿™æ ·çš„è¯æˆ‘ä»¬å…ˆæŠŠä¸Šé¢çš„ä»£ç Single_Producer_Consumer.javaç±»ä¿®æ”¹æˆæ–°ç±»ï¼Œå¤§éƒ¨åˆ†ä»£ç ä¸å˜ï¼Œä»…æ–°å¢ž2æ¡çº¿ç¨‹åŽ»è·‘ï¼Œä¸€æ¡t1çš„ç”Ÿäº§ å…±äº«èµ„æºç±»KaoYaResourceä¸ä½œæ›´æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364package com.sky.code.thread;public class Mutil_Producer_Consumer &#123; public static void main(String[] args) &#123; KaoYaResource r = new KaoYaResource(); Mutil_Producer pro = new Mutil_Producer(r); Mutil_Consumer con = new Mutil_Consumer(r); //ç”Ÿäº§è€…çº¿ç¨‹ Thread t0 = new Thread(pro); Thread t1 = new Thread(pro); //æ¶ˆè´¹è€…çº¿ç¨‹ Thread t2 = new Thread(con); Thread t3 = new Thread(con); //å¯åŠ¨çº¿ç¨‹ t0.start(); t1.start(); t2.start(); t3.start(); &#125;&#125;class Mutil_Producer implements Runnable&#123; private KaoYaResource r; Mutil_Producer(KaoYaResource r) &#123; this.r = r; &#125; public void run() &#123; while(true) &#123; r.product("åŒ—äº¬çƒ¤é¸­"); try &#123; Thread.sleep(100); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125;class Mutil_Consumer implements Runnable&#123; private KaoYaResource r; Mutil_Consumer(KaoYaResource r) &#123; this.r = r; &#125; public void run() &#123; while(true) &#123; r.consume(); try &#123; Thread.sleep(100); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; å°±å¤šäº†ä¸¤æ¡çº¿ç¨‹ï¼Œæˆ‘ä»¬è¿è¡Œä»£ç çœ‹çœ‹ï¼Œç»“æžœå¦‚ä¸‹ï¼š123456789Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­63Thread-2...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­63Thread-3...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­63 #æ¶ˆè´¹ä¸¤æ¬¡äº†............Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­67 #æ²¡æœ‰è¢«æ¶ˆè´¹Thread-1...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­68 Thread-2...æ¶ˆè´¹è€…........åŒ—äº¬çƒ¤é¸­68Thread-0...ç”Ÿäº§è€…...åŒ—äº¬çƒ¤é¸­69 ä¸å¯¹å‘€ï¼Œæˆ‘ä»¬æ‰ç”Ÿäº§ä¸€åªçƒ¤é¸­ï¼Œæ€Žä¹ˆå°±è¢«æ¶ˆè´¹äº†2æ¬¡å•Šï¼Œæœ‰çš„çƒ¤é¸­ç”Ÿäº§äº†ä¹Ÿæ²¡æœ‰è¢«æ¶ˆè´¹å•Šï¼Ÿéš¾é“å…±äº«æ•°æ®æºæ²¡æœ‰è¿›è¡Œçº¿ç¨‹åŒæ­¥ï¼Ÿå›žé¡¾ä¸‹KaoYaResource.javaå…±äº«æ•°æ®countçš„èŽ·å–æ–¹æ³•éƒ½è¿›è¡Œsynchronizedå…³é”®å­—åŒæ­¥äº†å‘€ï¼é‚£æ€Žä¹ˆè¿˜ä¼šå‡ºçŽ°æ•°æ®æ··ä¹±çš„çŽ°è±¡å•Šï¼Ÿåˆ†æžï¼šç¡®å®žï¼Œæˆ‘ä»¬å¯¹å…±äº«æ•°æ®ä¹Ÿé‡‡ç”¨äº†åŒæ­¥æŽªæ–½ï¼Œè€Œä¸”ä¹Ÿåº”ç”¨äº†ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œä½†æ˜¯è¿™æ ·çš„æŽªæ–½åªåœ¨å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…çš„æƒ…å†µä¸‹æ‰èƒ½æ­£ç¡®åº”ç”¨ï¼Œä½†ä»Žè¿è¡Œç»“æžœæ¥çœ‹ï¼Œæˆ‘ä»¬ä¹‹å‰çš„å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…å®‰å…¨å¤„ç†æŽªæ–½å°±ä¸å¤ªé€‚åˆå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…çš„æƒ…å†µäº†ã€‚é‚£ä¹ˆé—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿå¯ä»¥æ˜Žç¡®çš„å‘Šè¯‰å¤§å®¶ï¼Œè‚¯å®šæ˜¯åœ¨èµ„æºå…±äº«ç±»ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æžé—®é¢˜æ˜¯å¦‚ä½•å‡ºçŽ°ï¼Œåˆè¯¥å¦‚ä½•è§£å†³ï¼Ÿç›´æŽ¥ä¸Šå›¾ è§£å†³åŽçš„èµ„æºä»£ç å¦‚ä¸‹åªå°†ifæ”¹ä¸ºäº†whileï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344package com.sky.code.thread;public class KaoYaResourceByMulti &#123; private String name; private int count = 1;//çƒ¤é¸­çš„åˆå§‹æ•°é‡ private boolean flag = false;//åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦çº¿ç¨‹ç­‰å¾…çš„æ ‡å¿— /** * ç”Ÿäº§çƒ¤é¸­ */ public synchronized void product(String name)&#123; while (flag)&#123; //æ­¤æ—¶æœ‰çƒ¤é¸­ï¼Œç­‰å¾… try &#123; this.wait(); &#125; catch (InterruptedException e) &#123; e.printStackTrace() ; &#125; &#125; this.name=name+count;//è®¾ç½®çƒ¤é¸­çš„åç§° count++; System.out.println(Thread.currentThread().getName()+"...ç”Ÿäº§è€…..."+this.name); flag=true;//æœ‰çƒ¤é¸­åŽæ”¹å˜æ ‡å¿— notifyAll();//é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯ä»¥æ¶ˆè´¹äº† &#125; /** * æ¶ˆè´¹çƒ¤é¸­ */ public synchronized void consume()&#123; while (!flag)&#123;//å¦‚æžœæ²¡æœ‰çƒ¤é¸­å°±ç­‰å¾… try&#123; this.wait(); &#125;catch(InterruptedException e)&#123; &#125; &#125; System.out.println(Thread.currentThread().getName()+"...æ¶ˆè´¹è€…........"+this.name);//æ¶ˆè´¹çƒ¤é¸­1 flag = false; notifyAll();//é€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§çƒ¤é¸­ &#125;&#125; è¿è¡Œç»“æžœè·Ÿå•çº¿ç¨‹é‚£ä¸ªä¸€è‡´ï¼Œå°±ä¸è´´äº†ã€‚åˆ°æ­¤ï¼Œå¤šæ¶ˆè´¹è€…å¤šç”Ÿäº§è€…æ¨¡å¼ä¹Ÿå®Œæˆï¼Œä¸è¿‡ä¸Šé¢ç”¨çš„æ˜¯synchroniedå…³é”®å­—å®žçŽ°çš„ï¼Œè€Œé”å¯¹è±¡çš„è§£å†³æ–¹æ³•ä¹Ÿä¸€æ ·å°†ä¹‹å‰å•æ¶ˆè´¹è€…å•ç”Ÿäº§è€…çš„èµ„æºç±»ä¸­çš„ifåˆ¤æ–­æ”¹ä¸ºwhileåˆ¤æ–­å³å¯ä»£ç å°±ä¸è´´äº†å“ˆã€‚ä¸è¿‡ä¸‹é¢æˆ‘ä»¬å°†ä»‹ç»ä¸€ç§æ›´æœ‰æ•ˆçš„é”å¯¹è±¡è§£å†³æ–¹æ³•ï¼Œæˆ‘ä»¬å‡†å¤‡ä½¿ç”¨ä¸¤ç»„æ¡ä»¶å¯¹è±¡ï¼ˆConditionä¹Ÿç§°ä¸ºç›‘è§†å™¨ï¼‰æ¥å®žçŽ°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡å·²æœ‰çš„é”èŽ·å–ä¸¤ç»„ç›‘è§†å™¨ï¼Œä¸€ç»„ç›‘è§†ç”Ÿäº§è€…ï¼Œä¸€ç»„ç›‘è§†æ¶ˆè´¹è€…ã€‚æœ‰äº†å‰é¢çš„åˆ†æžè¿™é‡Œæˆ‘ä»¬ç›´æŽ¥ä¸Šä»£ç ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768package com.sky.code.thread;import java.util.concurrent.locks.Condition;import java.util.concurrent.locks.Lock;import java.util.concurrent.locks.ReentrantLock;public class ResourceBy2Condition &#123; private String name; private int count = 1; private boolean flag = false; //åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡ã€‚ Lock lock = new ReentrantLock(); //é€šè¿‡å·²æœ‰çš„é”èŽ·å–ä¸¤ç»„ç›‘è§†å™¨ï¼Œä¸€ç»„ç›‘è§†ç”Ÿäº§è€…ï¼Œä¸€ç»„ç›‘è§†æ¶ˆè´¹è€…ã€‚ Condition producer_con = lock.newCondition(); Condition consumer_con = lock.newCondition(); /** * ç”Ÿäº§ * @param name */ public void product(String name) &#123; lock.lock(); try &#123; while(flag)&#123; try&#123;producer_con.await();&#125;catch(InterruptedException e)&#123;&#125; &#125; this.name = name + count; count++; System.out.println(Thread.currentThread().getName()+"...ç”Ÿäº§è€…5.0..."+this.name); flag = true;// notifyAll(); // con.signalAll(); consumer_con.signal();//ç›´æŽ¥å”¤é†’æ¶ˆè´¹çº¿ç¨‹ &#125; finally &#123; lock.unlock(); &#125; &#125; /** * æ¶ˆè´¹ */ public void consume() &#123; lock.lock(); try &#123; while(!flag)&#123; try&#123;consumer_con.await();&#125;catch(InterruptedException e)&#123;&#125; &#125; System.out.println(Thread.currentThread().getName()+"...æ¶ˆè´¹è€….5.0......."+this.name);//æ¶ˆè´¹çƒ¤é¸­1 flag = false;// notifyAll(); // con.signalAll(); producer_con.signal();//ç›´æŽ¥å”¤é†’ç”Ÿäº§çº¿ç¨‹ &#125; finally &#123; lock.unlock(); &#125; &#125;&#125; ä»Žä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åˆ›å»ºäº†producer_con å’Œconsumer_conä¸¤ä¸ªæ¡ä»¶å¯¹è±¡ï¼Œåˆ†åˆ«ç”¨äºŽç›‘å¬ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œåœ¨product()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬èŽ·å–åˆ°é”åŽï¼Œå¦‚æžœæ­¤æ—¶flagä¸ºtrueçš„è¯ï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶è¿˜æœ‰çƒ¤é¸­æœªè¢«æ¶ˆè´¹ï¼Œå› æ­¤ç”Ÿäº§çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨ç”Ÿäº§çº¿ç¨‹çš„ç›‘æŽ§å™¨producer_conçš„await()çš„æ–¹æ³•è¿›å…¥é˜»å¡žç­‰å¾…æ± ï¼›ä½†å¦‚æžœæ­¤æ—¶çš„flagä¸ºfalseçš„è¯ï¼Œå°±è¯´æ˜Žçƒ¤é¸­å·²ç»æ¶ˆè´¹å®Œï¼Œéœ€è¦ç”Ÿäº§çº¿ç¨‹åŽ»ç”Ÿäº§çƒ¤é¸­ï¼Œé‚£ä¹ˆç”Ÿäº§çº¿ç¨‹å°†è¿›è¡Œçƒ¤é¸­ç”Ÿäº§å¹¶é€šè¿‡æ¶ˆè´¹çº¿ç¨‹çš„ç›‘æŽ§å™¨consumer_conçš„signal()æ–¹æ³•åŽ»é€šçŸ¥æ¶ˆè´¹çº¿ç¨‹å¯¹çƒ¤é¸­è¿›è¡Œæ¶ˆè´¹ã€‚consume()æ–¹æ³•ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šåˆ†æžäº†ã€‚æˆ‘ä»¬å¯ä»¥å‘çŽ°è¿™ç§æ–¹æ³•æ¯”æˆ‘ä»¬ä¹‹å‰çš„synchronizedåŒæ­¥æ–¹æ³•æˆ–è€…æ˜¯å•ç›‘è§†å™¨çš„é”å¯¹è±¡éƒ½æ¥å¾—é«˜æ•ˆå’Œæ–¹ä¾¿äº›ï¼Œä¹‹å‰éƒ½æ˜¯ä½¿ç”¨notifyAll()å’ŒsignalAll()æ–¹æ³•åŽ»å”¤é†’æ± ä¸­çš„çº¿ç¨‹ï¼Œç„¶åŽè®©æ± ä¸­çš„çº¿ç¨‹åˆè¿›å…¥ ç«žäº‰é˜Ÿåˆ—åŽ»æŠ¢å CPUèµ„æºï¼Œè¿™æ ·ä¸ä»…å”¤é†’äº†æ— å…³çš„çº¿ç¨‹è€Œä¸”åˆè®©å…¨éƒ¨çº¿ç¨‹è¿›å…¥äº†ç«žäº‰é˜Ÿåˆ—ä¸­ï¼Œè€Œæˆ‘ä»¬æœ€åŽä½¿ç”¨ä¸¤ç§ç›‘å¬å™¨åˆ†åˆ«ç›‘å¬ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œè¿™æ ·çš„æ–¹å¼æ°å¥½è§£å†³å‰é¢ä¸¤ç§æ–¹å¼çš„é—®é¢˜æ‰€åœ¨ï¼Œæˆ‘ä»¬æ¯æ¬¡å”¤é†’éƒ½åªæ˜¯ç”Ÿäº§è€…çº¿ç¨‹æˆ–è€…æ˜¯æ¶ˆè´¹è€…çº¿ç¨‹è€Œä¸ä¼šè®©ä¸¤è€…åŒæ—¶å”¤é†’ï¼Œè¿™æ ·ä¸å°±èƒ½æ›´é«˜æ•ˆå¾—åŽ»æ‰§è¡Œç¨‹åºäº†å—ï¼Ÿå¥½äº†ï¼Œåˆ°æ­¤å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…æ¨¡å¼ä¹Ÿåˆ†æžå®Œæ¯•ã€‚ çº¿ç¨‹æ­»é”çŽ°åœ¨æˆ‘ä»¬å†æ¥è®¨è®ºä¸€ä¸‹çº¿ç¨‹æ­»é”é—®é¢˜ï¼Œä»Žä¸Šé¢çš„åˆ†æžï¼Œæˆ‘ä»¬çŸ¥é“é”æ˜¯ä¸ªéžå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œè¿ç”¨çš„åœºæ™¯éžå¸¸å¤šï¼Œå› ä¸ºå®ƒä½¿ç”¨èµ·æ¥éžå¸¸ç®€å•ï¼Œè€Œä¸”æ˜“äºŽç†è§£ã€‚ä½†åŒæ—¶å®ƒä¹Ÿä¼šå¸¦æ¥ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦ï¼Œé‚£å°±æ˜¯å¯èƒ½ä¼šå¼•èµ·æ­»é”ï¼Œä¸€æ—¦äº§ç”Ÿæ­»é”ï¼Œå°±ä¼šé€ æˆç³»ç»ŸåŠŸèƒ½ä¸å¯ç”¨ã€‚æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªä¾‹å­æ¥åˆ†æžï¼Œè¿™ä¸ªä¾‹å­ä¼šå¼•èµ·æ­»é”ï¼Œä½¿å¾—çº¿ç¨‹t1å’Œçº¿ç¨‹t2äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.sky.code.thread;public class DeadLockDemo &#123; private static String A="A"; private static String B="B"; public static void main(String[] args) &#123; DeadLockDemo deadLock=new DeadLockDemo(); deadLock.deadLock(); &#125; private void deadLock()&#123; Thread t1=new Thread(new Runnable()&#123; @SuppressWarnings("static-access") @Override public void run() &#123; synchronized (A) &#123; try &#123; Thread.currentThread().sleep(2000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; synchronized (B) &#123; System.out.println("1"); &#125; &#125; &#125; &#125;); Thread t2 =new Thread(new Runnable() &#123; @Override public void run() &#123; synchronized (B) &#123; synchronized (A) &#123; System.out.println("2"); &#125; &#125; &#125; &#125;); //å¯åŠ¨çº¿ç¨‹ t1.start(); t2.start(); &#125;&#125; ä¸Šé¢ä»£ç è¿è¡ŒåŸºæœ¬æ²¡æœ‰è¾“å‡ºï¼Œä¸€ç›´å¡ç€ã€‚åŒæ­¥åµŒå¥—æ˜¯äº§ç”Ÿæ­»é”çš„å¸¸è§æƒ…æ™¯ï¼Œä»Žä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå½“t1çº¿ç¨‹æ‹¿åˆ°é”AåŽï¼Œç¡çœ 2ç§’ï¼Œæ­¤æ—¶çº¿ç¨‹t2åˆšå¥½æ‹¿åˆ°äº†Bé”ï¼ŒæŽ¥ç€è¦èŽ·å–Aé”ï¼Œä½†æ˜¯æ­¤æ—¶Aé”æ­£å¥½è¢«t1çº¿ç¨‹æŒæœ‰ï¼Œå› æ­¤åªèƒ½ç­‰å¾…t1çº¿ç¨‹é‡Šæ”¾é”Aï¼Œä½†é—æ†¾çš„æ˜¯åœ¨t1çº¿ç¨‹å†…åˆè¦æ±‚èŽ·å–åˆ°Bé”ï¼Œè€ŒBé”æ­¤æ—¶åˆè¢«t2çº¿ç¨‹æŒæœ‰ï¼Œåˆ°æ­¤ç»“æžœå°±æ˜¯t1çº¿ç¨‹æ‹¿åˆ°äº†é”AåŒæ—¶åœ¨ç­‰å¾…t2çº¿ç¨‹é‡Šæ”¾é”Bï¼Œè€Œt2çº¿ç¨‹èŽ·å–åˆ°äº†é”Bä¹ŸåŒæ—¶åœ¨ç­‰å¾…t1çº¿ç¨‹é‡Šæ”¾é”Aï¼Œå½¼æ­¤ç­‰å¾…ä¹Ÿå°±é€ æˆäº†çº¿ç¨‹æ­»é”é—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬çŽ°å®žä¸­ä¸€èˆ¬ä¸ä¼šå‘ä¸Šé¢é‚£ä¹ˆå†™å‡ºé‚£æ ·çš„ä»£ç ï¼Œä½†æ˜¯æœ‰äº›æ›´ä¸ºå¤æ‚çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚t1æ‹¿äº†é”ä¹‹åŽï¼Œå› ä¸ºä¸€äº›å¼‚å¸¸æƒ…å†µæ²¡æœ‰é‡Šæ”¾é”ï¼ˆæ­»å¾ªçŽ¯ï¼‰ï¼Œä¹Ÿå¯èƒ½t1æ‹¿åˆ°ä¸€ä¸ªæ•°æ®åº“é”ï¼Œé‡Šæ”¾é”çš„æ—¶å€™æŠ›å‡ºäº†å¼‚å¸¸ï¼Œæ²¡æœ‰é‡Šæ”¾ç­‰ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨å†™ä»£ç çš„æ—¶å€™å¤šè€ƒè™‘æ­»é”çš„æƒ…å†µï¼Œè¿™æ ·æ‰èƒ½æœ‰æ•ˆé¢„é˜²æ­»é”ç¨‹åºçš„å‡ºçŽ°ã€‚ä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹é¿å…æ­»é”çš„å‡ ä¸ªå¸¸è§æ–¹æ³•ï¼š é¿å…ä¸€ä¸ªçº¿ç¨‹åŒæ—¶èŽ·å–å¤šä¸ªé”ã€‚ é¿å…åœ¨ä¸€ä¸ªèµ„æºå†…å ç”¨å¤šä¸ª èµ„æºï¼Œå°½é‡ä¿è¯æ¯ä¸ªé”åªå ç”¨ä¸€ä¸ªèµ„æºã€‚ å°è¯•ä½¿ç”¨å®šæ—¶é”ï¼Œä½¿ç”¨tryLock(timeout)æ¥ä»£æ›¿ä½¿ç”¨å†…éƒ¨é”æœºåˆ¶ã€‚ å¯¹äºŽæ•°æ®åº“é”ï¼ŒåŠ é”å’Œè§£é”å¿…é¡»åœ¨ä¸€ä¸ªæ•°æ®åº“è¿žæŽ¥é‡Œï¼Œå¦åˆ™ä¼šå‡ºçŽ°è§£é”å¤±è´¥çš„æƒ…å†µã€‚ é¿å…åŒæ­¥åµŒå¥—çš„å‘ç”Ÿ Thread.join()å¦‚æžœä¸€ä¸ªçº¿ç¨‹Aæ‰§è¡Œäº†thread.join()è¯­å¥ï¼Œå…¶å«ä¹‰æ˜¯ï¼šå½“å‰çº¿ç¨‹Aç­‰å¾…threadçº¿ç¨‹ç»ˆæ­¢ä¹‹åŽæ‰èƒ½ä»Žthread.join()è¿”å›žã€‚çº¿ç¨‹Threadé™¤äº†æä¾›join()æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æä¾›äº†join(long millis)å’Œjoin(long millis,int nanos)ä¸¤ä¸ªå…·å¤‡è¶…æ—¶ç‰¹æ€§çš„æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªè¶…æ—¶çš„æ–¹æ³•è¡¨ç¤ºï¼Œå¦‚æžœçº¿ç¨‹åœ¨ç»™å®šçš„è¶…æ—¶æ—¶é—´é‡Œæ²¡æœ‰ç»ˆæ­¢ï¼Œé‚£ä¹ˆå°†ä¼šä»Žè¯¥è¶…æ—¶æ–¹æ³•ä¸­è¿”å›žã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼Œåˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œç¼–å·0~9ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨å‰ä¸€ä¸ªçº¿ç¨‹çš„join()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹0ç»“æŸäº†ï¼Œçº¿ç¨‹1æ‰èƒ½ä»Žjoin()æ–¹æ³•ä¸­è¿”å›žï¼Œè€Œ0éœ€è¦ç­‰å¾…mainçº¿ç¨‹ç»“æŸã€‚12345678910111213141516171819202122232425262728293031package com.sky.code.thread;public class JoinDemo &#123; public static void main(String[] args) &#123; Thread previous = Thread.currentThread(); for(int i=0;i&lt;10;i++)&#123; //æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å‰ä¸€ä¸ªçº¿ç¨‹çš„å¼•ç”¨ã€‚éœ€è¦ç­‰å¾…å‰ä¸€ä¸ªçº¿ç¨‹ç»ˆæ­¢ï¼Œæ‰èƒ½ä»Žç­‰å¾…ä¸­è¿”å›ž Thread thread=new Thread(new Domino(previous),String.valueOf(i)); thread.start(); previous=thread; &#125; System.out.println(Thread.currentThread().getName()+" çº¿ç¨‹ç»“æŸ"); &#125;&#125;class Domino implements Runnable&#123; private Thread thread; public Domino(Thread thread)&#123; this.thread=thread; &#125; @Override public void run() &#123; try &#123; thread.join(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; System.out.println(Thread.currentThread().getName()+" çº¿ç¨‹ç»“æŸ"); &#125;&#125; è¿è¡Œç»“æžœï¼š1234567891011main çº¿ç¨‹ç»“æŸ0 çº¿ç¨‹ç»“æŸ1 çº¿ç¨‹ç»“æŸ2 çº¿ç¨‹ç»“æŸ3 çº¿ç¨‹ç»“æŸ4 çº¿ç¨‹ç»“æŸ5 çº¿ç¨‹ç»“æŸ6 çº¿ç¨‹ç»“æŸ7 çº¿ç¨‹ç»“æŸ8 çº¿ç¨‹ç»“æŸ9 çº¿ç¨‹ç»“æŸ ç»“æŸ å‚è€ƒ http://blog.csdn.net/javazejian/article/details/50878665æ‰€æœ‰ä»£ç åœ¨ https://github.com/ejunjsh/java-code/tree/master/com/sky/code/thread]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Javaå¤šçº¿ç¨‹(ä¸€)åŸºç¡€]]></title>
    <url>%2F2016%2F08%2F08%2Fjava-thread-1-md%2F</url>
    <content type="text"><![CDATA[å¯¹å¤šçº¿ç¨‹å¤ä¹ ä¸‹ï¼Œæ±‡æ€»ä¸€ä¸‹ ä»€ä¹ˆæ˜¯çº¿ç¨‹ä»¥åŠå¤šçº¿ç¨‹ä¸Žè¿›ç¨‹çš„åŒºåˆ«åœ¨çŽ°ä»£æ“ä½œåœ¨è¿è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚ä¾‹å¦‚å¯åŠ¨ä¸€ä¸ªQQç¨‹åºï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚è€Œæ“ä½œç³»ç»Ÿä¸­è°ƒåº¦çš„æœ€å°å•ä½å…ƒæ˜¯çº¿ç¨‹ï¼Œä¹Ÿå«è½»é‡çº§è¿›ç¨‹ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œå¯ä»¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹éƒ½æ‹¥æœ‰å„è‡ªçš„è®¡æ•°å™¨ï¼Œå †æ ˆå’Œå±€éƒ¨å˜é‡ç­‰å±žæ€§ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¿é—®å…±äº«çš„å†…å­˜å˜é‡ã€‚å¤„ç†å™¨åœ¨è¿™äº›çº¿ç¨‹ä¸Šé«˜é€Ÿåˆ‡æ¢ï¼Œè®©ä½¿ç”¨è€…æ„Ÿè§‰åˆ°è¿™äº›çº¿ç¨‹åœ¨åŒæ—¶æ‰§è¡Œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£ï¼šè¿›ç¨‹ï¼šæ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œæ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒç”¨çš„ç‹¬ç«‹å•ä½ã€‚æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„å†…å­˜ç©ºé—´å’Œç³»ç»Ÿèµ„æºã€‚çº¿ç¨‹ï¼šæ˜¯è¿›ç¨‹ä¸­çš„å•ä¸ªé¡ºåºæŽ§åˆ¶æµï¼Œæ˜¯ä¸€æ¡æ‰§è¡Œè·¯å¾„ä¸€ä¸ªè¿›ç¨‹å¦‚æžœåªæœ‰ä¸€æ¡æ‰§è¡Œè·¯å¾„ï¼Œåˆ™ç§°ä¸ºå•çº¿ç¨‹ç¨‹åºã€‚ä¸€ä¸ªè¿›ç¨‹å¦‚æžœæœ‰å¤šæ¡æ‰§è¡Œè·¯å¾„ï¼Œåˆ™ç§°ä¸ºå¤šçº¿ç¨‹ç¨‹åºã€‚ å¤šçº¿ç¨‹çš„åˆ›å»ºä¸Žå¯åŠ¨åˆ›å»ºå¤šçº¿ç¨‹æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯å®žçŽ°RunnableæŽ¥å£é‡å†™runæ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«ç»™å‡ºä»£ç ç¤ºä¾‹ï¼Œç»§æ‰¿Threadç±»é‡å†™runæ–¹æ³•ï¼š123456789package com.sky.code.thread;public class NewThread extends Thread &#123; @Override public void run()&#123; System.out.println("I'm a thread that extends Thread!"); &#125;&#125; å®žçŽ°RunnableæŽ¥å£é‡å†™runæ–¹æ³•:12345678910package com.sky.code.thread;public class NewRunnable implements Runnable&#123; @Override public void run() &#123; System.out.println("I'm a thread that implements Runnable !"); &#125;&#125; æ€Žä¹ˆå¯åŠ¨çº¿ç¨‹ï¼Ÿ12345678910111213package com.sky.code.thread;public class StartThread &#123; public static void main(String[] args)&#123; NewThread t1=new NewThread(); t1.start(); NewRunnable r=new NewRunnable(); Thread t2=new Thread(r); t2.start(); &#125;&#125; è¿è¡Œç»“æžœï¼š12I&apos;m a thread that extends Thread!I&apos;m a thread that implements Runnable ! ä»£ç ç›¸å½“ç®€å•ï¼Œä¸è¿‡å¤šè§£é‡Šã€‚è¿™é‡Œæœ‰ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯è°ƒç”¨start()æ–¹æ³•åŽå¹¶ä¸æ˜¯æ˜¯ç«‹å³çš„æ‰§è¡Œå¤šçº¿ç¨‹çš„ä»£ç ï¼Œè€Œæ˜¯ä½¿è¯¥çº¿ç¨‹å˜ä¸ºå¯è¿è¡Œæ€ï¼Œä»€ä¹ˆæ—¶å€™è¿è¡Œå¤šçº¿ç¨‹ä»£ç æ˜¯ç”±æ“ä½œç³»ç»Ÿå†³å®šçš„ã€‚ ä¸­æ–­çº¿ç¨‹å’Œå®ˆæŠ¤çº¿ç¨‹ä»¥åŠçº¿ç¨‹ä¼˜å…ˆçº§ä»€ä¹ˆæ˜¯ä¸­æ–­çº¿ç¨‹ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸­æ–­çº¿ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ(è¯¥è§£é‡Šæ¥è‡ªjavaæ ¸å¿ƒæŠ€æœ¯ä¸€ä¹¦ï¼Œæˆ‘å¯¹å…¶è¿›è¡Œç¨å¾®ç®€åŒ–)ï¼Œå½“çº¿ç¨‹çš„run()æ–¹æ³•æ‰§è¡Œæ–¹æ³•ä½“ä¸­çš„æœ€åŽä¸€æ¡è¯­å¥åŽï¼Œå¹¶ç»ç”±æ‰§è¡Œreturnè¯­å¥è¿”å›žæ—¶ï¼Œæˆ–è€…å‡ºçŽ°åœ¨æ–¹æ³•ä¸­æ²¡æœ‰æ•èŽ·çš„å¼‚å¸¸æ—¶çº¿ç¨‹å°†ç»ˆæ­¢ã€‚åœ¨javaæ—©æœŸç‰ˆæœ¬ä¸­æœ‰ä¸€ä¸ªstopæ–¹æ³•ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è°ƒç”¨å®ƒç»ˆæ­¢çº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•çŽ°åœ¨å·²ç»è¢«å¼ƒç”¨äº†ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¼šé€ æˆä¸€äº›çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸­æ–­ç†è§£ä¸ºä¸€ä¸ªæ ‡è¯†ä½çš„å±žæ€§ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªè¿è¡Œä¸­çš„çº¿ç¨‹æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­æ“ä½œï¼Œè€Œä¸­æ–­å°±å¥½æ¯”å…¶ä»–çº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æ‰“å¯ä¸ªæ‹›å‘¼ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡è°ƒç”¨è¯¥çº¿ç¨‹çš„interruptæ–¹æ³•å¯¹å…¶è¿›è¡Œä¸­æ–­æ“ä½œï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨interruptæ–¹æ³•æ—¶ï¼Œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼ˆæ ‡è¯†ä½ï¼‰å°†è¢«ç½®ä½ï¼ˆæ”¹å˜ï¼‰ï¼Œè¿™æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½å…·æœ‰çš„booleanæ ‡å¿—ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½åº”è¯¥ä¸æ—¶çš„æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ï¼Œæ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ã€‚è€Œè¦åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç 1Thread.currentThread().isInterrupted() 123while(!Thread.currentThread().isInterrupted())&#123; do something &#125; ä½†æ˜¯å¦‚æžœæ­¤æ—¶çº¿ç¨‹å¤„äºŽé˜»å¡žçŠ¶æ€ï¼ˆsleepæˆ–è€…waitï¼‰ï¼Œå°±æ— æ³•æ£€æŸ¥ä¸­æ–­çŠ¶æ€ï¼Œæ­¤æ—¶ä¼šæŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚å¦‚æžœæ¯æ¬¡è¿­ä»£ä¹‹åŽéƒ½è°ƒç”¨sleepæ–¹æ³•ï¼ˆæˆ–è€…å…¶ä»–å¯ä¸­æ–­çš„æ–¹æ³•ï¼‰ï¼ŒisInterruptedæ£€æµ‹å°±æ²¡å¿…è¦ä¹Ÿæ²¡ç”¨å¤„äº†ï¼Œå¦‚æžœåœ¨ä¸­æ–­çŠ¶æ€è¢«ç½®ä½æ—¶è°ƒç”¨sleepæ–¹æ³•ï¼Œå®ƒä¸ä¼šä¼‘çœ åè€Œä¼šæ¸…é™¤è¿™ä¸€ä¼‘çœ çŠ¶æ€å¹¶æŠ›å‡ºInterruptedExceptionã€‚æ‰€ä»¥å¦‚æžœåœ¨å¾ªçŽ¯ä¸­è°ƒç”¨sleep,ä¸è¦åŽ»æ£€æµ‹ä¸­æ–­çŠ¶æ€ï¼Œåªéœ€æ•èŽ·InterruptedExceptionã€‚ä»£ç èŒƒä¾‹å¦‚ä¸‹ï¼š1234567891011public void run()&#123; while(more work to do )&#123; try &#123; Thread.sleep(5000); &#125; catch (InterruptedException e) &#123; //thread was interrupted during sleep e.printStackTrace(); &#125;finally&#123; //clean up , if required &#125; &#125; ä¸å¦¥çš„å¤„ç†æ–¹å¼ï¼š12345678void myTask()&#123; ... try&#123; sleep(50) &#125;catch(InterruptedException e)&#123; ... &#125; &#125; æ­£ç¡®çš„å¤„ç†æ–¹å¼ï¼š123void myTask()throw InterruptedException&#123; sleep(50) &#125; æˆ–è€…12345678void myTask()&#123; ... try&#123; sleep(50) &#125;catch(InterruptedException e)&#123; Thread.currentThread().interrupt(); &#125; &#125; æœ€åŽå…³äºŽä¸­æ–­çº¿ç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œç»™å‡ºä¸­æ–­çº¿ç¨‹çš„ä¸€äº›ä¸»è¦æ–¹æ³•ï¼švoid interrupt()ï¼šå‘çº¿ç¨‹å‘é€ä¸­æ–­è¯·æ±‚ï¼Œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å°†ä¼šè¢«è®¾ç½®ä¸ºtrueï¼Œå¦‚æžœå½“å‰çº¿ç¨‹è¢«ä¸€ä¸ªsleepè°ƒç”¨é˜»å¡žï¼Œé‚£ä¹ˆå°†ä¼šæŠ›å‡ºinterrupedExceptionå¼‚å¸¸ã€‚static boolean interrupted()ï¼šæµ‹è¯•å½“å‰çº¿ç¨‹ï¼ˆå½“å‰æ­£åœ¨æ‰§è¡Œå‘½ä»¤çš„è¿™ä¸ªçº¿ç¨‹ï¼‰æ˜¯å¦è¢«ä¸­æ–­ã€‚æ³¨æ„è¿™æ˜¯ä¸ªé™æ€æ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼šäº§ç”Ÿä¸€ä¸ªå‰¯ä½œç”¨é‚£å°±æ˜¯å®ƒä¼šå°†å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€é‡ç½®ä¸ºfalseã€‚boolean isInterrupted()ï¼šåˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨å³ä¸æ”¹å˜çº¿ç¨‹çš„å½“å‰ä¸­æ–­çŠ¶æ€ã€‚static Thread currentThread() : è¿”å›žä»£è¡¨å½“å‰æ‰§è¡Œçº¿ç¨‹çš„Threadå¯¹è±¡ã€‚ è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œä¸ºå•¥ä¸Šé¢çš„ä»£ç ï¼Œåœ¨catchä¹‹åŽè¿˜è¦åœ¨ä¸­æ–­ä¸€æ¬¡ï¼Œå› ä¸ºcatchä¼šæŠŠå½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—é‡ç½®ä¸ºfalseï¼Œè¿™é‡Œä¸é‡æ–°ä¸­æ–­ä¸€æ¬¡ï¼Œä¸Šå±‚ä»£ç å°±ä¸çŸ¥é“ä¸­æ–­äº†ï¼Œç¨‹åºå°±ä¸çŸ¥é“æœ‰ä¸­æ–­çš„å‘ç”Ÿï¼Œä¸‹é¢ä»£ç å¯ä»¥è¯´æ˜Žè¿™ä¸ª123456789101112131415161718192021222324252627282930313233343536373839404142434445package com.sky.code.thread;/** * Created by ejunjsh on 8/10/2017. */public class TestInterrupt &#123; public static void main(String[] args) &#123; Thread t= new Thread(new Runnable() &#123; @Override public void run() &#123; try &#123; Thread.sleep(5000); &#125; catch (InterruptedException e)&#123; //catch å¼‚å¸¸ä¹‹åŽï¼Œè¾“å‡ºæ˜¯false System.out.println("1.current interrupted flag is " +Thread.currentThread().isInterrupted()); Thread.currentThread().interrupt(); System.out.println("2.current interrupted flag is " +Thread.currentThread().isInterrupted()); &#125; try &#123; Thread.sleep(5000); &#125; catch (InterruptedException e)&#123; System.out.println("3.current interrupted flag is " +Thread.currentThread().isInterrupted()); Thread.currentThread().interrupt(); System.out.println("4.current interrupted flag is " +Thread.currentThread().isInterrupted()); &#125; &#125; &#125;); t.start(); //å¼€å§‹ä¸­æ–­ t.interrupt(); try &#123; t.join(); &#125; catch (InterruptedException e) &#123; &#125; System.out.println("5.current state is " +t.getState()); &#125;&#125; è¾“å‡ºç»“æžœ:123451.current interrupted flag is false2.current interrupted flag is true3.current interrupted flag is false4.current interrupted flag is true5.current state is TERMINATED å¾ˆæ˜Žæ˜¾ï¼Œå¼€å§‹ä¸­æ–­åŽï¼Œcatchçš„æ ‡å¿—ä½è¢«é‡ç½®äº†ã€‚ ä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Ÿé¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡t.setDaemon(true)çš„æ–¹æ³•å°†çº¿ç¨‹è½¬åŒ–ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚è€Œå®ˆæŠ¤çº¿ç¨‹çš„å”¯ä¸€ä½œç”¨å°±æ˜¯ä¸ºå…¶ä»–çº¿ç¨‹æä¾›æœåŠ¡ã€‚è®¡æ—¶çº¿ç¨‹å°±æ˜¯ä¸€ä¸ªå…¸åž‹çš„ä¾‹å­ï¼Œå®ƒå®šæ—¶åœ°å‘é€â€œè®¡æ—¶å™¨æ»´ç­”â€ä¿¡å·å‘Šè¯‰å…¶ä»–çº¿ç¨‹åŽ»æ‰§è¡ŒæŸé¡¹ä»»åŠ¡ã€‚å½“åªå‰©ä¸‹å®ˆæŠ¤çº¿ç¨‹æ—¶ï¼Œè™šæ‹Ÿæœºå°±é€€å‡ºäº†ï¼Œå› ä¸ºå¦‚æžœåªå‰©ä¸‹å®ˆæŠ¤çº¿ç¨‹ï¼Œç¨‹åºå°±æ²¡æœ‰å¿…è¦æ‰§è¡Œäº†ã€‚å¦å¤–JVMçš„åžƒåœ¾å›žæ”¶ã€å†…å­˜ç®¡ç†ç­‰çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚è¿˜æœ‰å°±æ˜¯åœ¨åšæ•°æ®åº“åº”ç”¨æ—¶å€™ï¼Œä½¿ç”¨çš„æ•°æ®åº“è¿žæŽ¥æ± ï¼Œè¿žæŽ¥æ± æœ¬èº«ä¹ŸåŒ…å«ç€å¾ˆå¤šåŽå°çº¿ç¨‹ï¼Œç›‘æŽ§è¿žæŽ¥ä¸ªæ•°ã€è¶…æ—¶æ—¶é—´ã€çŠ¶æ€ç­‰ç­‰ã€‚æœ€åŽè¿˜æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯åœ¨javaè™šæ‹Ÿæœºé€€å‡ºæ—¶Daemonçº¿ç¨‹ä¸­çš„finallyä»£ç å—å¹¶ä¸ä¸€å®šä¼šæ‰§è¡Œå“¦ï¼Œä»£ç ç¤ºä¾‹ï¼š12345678910111213141516171819202122232425package com.sky.code.thread;public class Deamon &#123; public static void main(String[] args) &#123; Thread deamon = new Thread(new DaemonRunner(),"DaemonRunner"); //è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ deamon.setDaemon(true); deamon.start();//å¯åŠ¨çº¿ç¨‹ &#125; static class DaemonRunner implements Runnable&#123; @Override public void run() &#123; try &#123; Thread.sleep(500); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;finally&#123; System.out.println("è¿™é‡Œçš„ä»£ç åœ¨javaè™šæ‹Ÿæœºé€€å‡ºæ—¶å¹¶ä¸ä¸€å®šä¼šæ‰§è¡Œå“¦ï¼"); &#125; &#125; &#125;&#125; å› æ­¤åœ¨æž„å»ºDaemonçº¿ç¨‹æ—¶ï¼Œä¸èƒ½ä¾é finallyä»£ç å—ä¸­çš„å†…å®¹æ¥ç¡®ä¿æ‰§è¡Œå…³é—­æˆ–æ¸…ç†èµ„æºçš„é€»è¾‘ã€‚ ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¼˜å…ˆçº§åœ¨çŽ°ä»£æ“ä½œç³»ç»Ÿä¸­åŸºæœ¬é‡‡ç”¨æ—¶åˆ†çš„å½¢å¼è°ƒåº¦è¿è¡Œçš„çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†å‡ºä¸€ä¸ªä¸ªæ—¶é—´ç‰‡ï¼Œçº¿ç¨‹ä¼šåˆ†é…åˆ°è‹¥å¹²æ—¶é—´ç‰‡ï¼Œå½“çº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œäº†å°±ä¼šå‘ç”Ÿçº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ç­‰å¾…ç€ä¸‹ä¸€æ¬¡åˆ†é…ã€‚çº¿ç¨‹åˆ†é…åˆ°çš„æ—¶é—´ç‰‡å¤šå°‘ä¹Ÿå†³å®šäº†çº¿ç¨‹ä½¿ç”¨å¤„ç†å™¨èµ„æºçš„å¤šå°‘ï¼Œè€Œçº¿ç¨‹ä¼˜å…ˆçº§å°±æ˜¯å†³å®šçº¿ç¨‹éœ€è¦å¤šæˆ–è€…å°‘åˆ†é…ä¸€äº›å¤„ç†å™¨èµ„æºçš„çº¿ç¨‹å±žæ€§ã€‚åœ¨javaçº¿ç¨‹ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªæ•´åž‹çš„æˆå‘˜å˜é‡Priorityæ¥æŽ§åˆ¶çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹ç»§æ‰¿å®ƒçˆ¶ç±»çš„ä¼˜å…ˆçº§ã€‚å¯ä»¥ç”¨setPriorityæ–¹æ³•æé«˜æˆ–é™ä½Žä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¼˜å…ˆçº§ã€‚å¯ä»¥å°†ä¼˜å…ˆçº§è®¾ç½®åœ¨MIN_PRIORITYï¼ˆåœ¨Threadç±»å®šä¹‰ä¸º1ï¼‰ä¸ŽMAX_PRIORITYï¼ˆåœ¨Threadç±»å®šä¹‰ä¸º10ï¼‰ä¹‹é—´çš„ä»»ä½•å€¼ã€‚çº¿ç¨‹çš„é»˜è®¤ä¼˜å…ˆçº§ä¸ºNORM_PRIORITYï¼ˆåœ¨Threadç±»å®šä¹‰ä¸º5ï¼‰ã€‚å°½é‡ä¸è¦ä¾èµ–ä¼˜å…ˆçº§ï¼Œå¦‚æžœç¡®å®žè¦ç”¨ï¼Œåº”è¯¥é¿å…åˆå­¦è€…å¸¸çŠ¯çš„ä¸€ä¸ªé”™è¯¯ã€‚å¦‚æžœæœ‰å‡ ä¸ªé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æ²¡æœ‰è¿›å…¥éžæ´»åŠ¨çŠ¶æ€ï¼Œä½Žä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½æ°¸è¿œä¹Ÿä¸èƒ½æ‰§è¡Œã€‚æ¯å½“è°ƒåº¦å™¨å†³å®šè¿è¡Œä¸€ä¸ªæ–°çº¿ç¨‹æ—¶ï¼Œé¦–å…ˆä¼šåœ¨å…·æœ‰é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¸­è¿›è¡Œé€‰æ‹©ï¼Œå°½ç®¡è¿™æ ·ä¼šä½¿ä½Žä¼˜å…ˆçº§çš„çº¿ç¨‹å¯èƒ½æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œåˆ°ã€‚å› æ­¤æˆ‘ä»¬åœ¨è®¾ç½®ä¼˜å…ˆçº§æ—¶ï¼Œé’ˆå¯¹é¢‘ç¹é˜»å¡žï¼ˆä¼‘çœ æˆ–è€…I/Oæ“ä½œï¼‰çš„çº¿ç¨‹éœ€è¦è®¾ç½®è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œè€Œåé‡è®¡ç®—ï¼ˆéœ€è¦è¾ƒå¤šCPUæ—¶é—´æˆ–è€…è¿ç®—ï¼‰çš„çº¿ç¨‹åˆ™è®¾ç½®è¾ƒä½Žçš„ä¼˜å…ˆçº§ï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿å¤„ç†å™¨ä¸ä¼šè¢«é•¿ä¹…ç‹¬å ã€‚å½“ç„¶è¿˜æœ‰è¦æ³¨æ„å°±æ˜¯åœ¨ä¸åŒçš„JVMä»¥åŠæ“ä½œç³»ç»Ÿä¸Šçº¿ç¨‹çš„è§„åˆ’å­˜åœ¨å·®å¼‚ï¼Œæœ‰äº›æ“ä½œç³»ç»Ÿç”šè‡³ä¼šå¿½ç•¥å¯¹çº¿ç¨‹ä¼˜å…ˆçº§çš„è®¾å®šï¼Œå¦‚mac osç³»ç»Ÿæˆ–è€…Ubuntuç³»ç»Ÿâ€¦â€¦.. çº¿ç¨‹çš„çŠ¶æ€è½¬åŒ–å…³ç³»1.æ–°å»ºçŠ¶æ€ï¼ˆNewï¼‰ï¼šæ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ã€‚2.å°±ç»ªçŠ¶æ€ï¼ˆRunnableï¼‰ï¼šçº¿ç¨‹å¯¹è±¡åˆ›å»ºåŽï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨äº†è¯¥å¯¹è±¡çš„start()æ–¹æ³•ã€‚è¯¥çŠ¶æ€çš„çº¿ç¨‹ä½äºŽå¯è¿è¡Œçº¿ç¨‹æ± ä¸­ï¼Œå˜å¾—å¯è¿è¡Œï¼Œç­‰å¾…èŽ·å–CPUçš„ä½¿ç”¨æƒã€‚3.è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰ï¼šå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹èŽ·å–äº†CPUï¼Œæ‰§è¡Œç¨‹åºä»£ç ã€‚4.é˜»å¡žçŠ¶æ€ï¼ˆBlockedï¼‰ï¼šé˜»å¡žçŠ¶æ€æ˜¯çº¿ç¨‹å› ä¸ºæŸç§åŽŸå› æ”¾å¼ƒCPUä½¿ç”¨æƒï¼Œæš‚æ—¶åœæ­¢è¿è¡Œã€‚ç›´åˆ°çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œæ‰æœ‰æœºä¼šè½¬åˆ°è¿è¡ŒçŠ¶æ€ã€‚é˜»å¡žçš„æƒ…å†µåˆ†ä¸‰ç§ï¼š ç­‰å¾…é˜»å¡žï¼ˆWAITINGï¼‰ï¼šè¿è¡Œçš„çº¿ç¨‹æ‰§è¡Œwait()æ–¹æ³•ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥ç­‰å¾…æ± ä¸­ã€‚ åŒæ­¥é˜»å¡žï¼ˆBlockedï¼‰ï¼šè¿è¡Œçš„çº¿ç¨‹åœ¨èŽ·å–å¯¹è±¡çš„åŒæ­¥é”æ—¶ï¼Œè‹¥è¯¥åŒæ­¥é”è¢«åˆ«çš„çº¿ç¨‹å ç”¨ï¼Œåˆ™JVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥é”æ± ä¸­ã€‚ è¶…æ—¶é˜»å¡žï¼ˆTIME_WAITINGï¼‰ï¼šè¿è¡Œçš„çº¿ç¨‹æ‰§è¡Œsleep(long)æˆ–join(long)æ–¹æ³•ï¼Œæˆ–è€…å‘å‡ºäº†I/Oè¯·æ±‚æ—¶ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹ç½®ä¸ºé˜»å¡žçŠ¶æ€ã€‚ 5.æ­»äº¡çŠ¶æ€ï¼ˆDeadï¼‰ï¼šçº¿ç¨‹æ‰§è¡Œå®Œäº†æˆ–è€…å› å¼‚å¸¸é€€å‡ºäº†run()æ–¹æ³•ï¼Œè¯¥çº¿ç¨‹ç»“æŸç”Ÿå‘½å‘¨æœŸã€‚å›¾ä¸­çš„æ–¹æ³•è§£æžå¦‚ä¸‹ï¼šThread.sleep()ï¼šåœ¨æŒ‡å®šæ—¶é—´å†…è®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æš‚åœæ‰§è¡Œï¼Œä½†ä¸ä¼šé‡Šæ”¾â€é”æ ‡å¿—â€ã€‚ä¸æŽ¨èä½¿ç”¨ã€‚Thread.sleep(long)ï¼šä½¿å½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡žçŠ¶æ€ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…ä¸ä¼šæ‰§è¡Œã€‚Object.wait()å’ŒObject.wait(long)ï¼šåœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨å¯¹è±¡çš„notifyæˆ–notifyAllæ–¹æ³•å‰ï¼Œå¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ã€‚çº¿ç¨‹ä¼šé‡Šæ”¾æŽ‰å®ƒæ‰€å æœ‰çš„â€é”æ ‡å¿—â€ï¼Œä»Žè€Œä½¿åˆ«çš„çº¿ç¨‹æœ‰æœºä¼šæŠ¢å è¯¥é”ã€‚ å½“å‰çº¿ç¨‹å¿…é¡»æ‹¥æœ‰å½“å‰å¯¹è±¡é”ã€‚å¦‚æžœå½“å‰çº¿ç¨‹ä¸æ˜¯æ­¤é”çš„æ‹¥æœ‰è€…ï¼Œä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ã€‚ å”¤é†’å½“å‰å¯¹è±¡é”çš„ç­‰å¾…çº¿ç¨‹ä½¿ç”¨notifyæˆ–notifyAllæ–¹æ³•ï¼Œä¹Ÿå¿…é¡»æ‹¥æœ‰ç›¸åŒçš„å¯¹è±¡é”ï¼Œå¦åˆ™ä¹Ÿä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ï¼Œwaite()å’Œnotify()å¿…é¡»åœ¨synchronizedå‡½æ•°æˆ–synchronizedä¸­è¿›è¡Œè°ƒç”¨ã€‚å¦‚æžœåœ¨non-synchronizedå‡½æ•°æˆ–non-synchronizedä¸­è¿›è¡Œè°ƒç”¨,è™½ç„¶èƒ½ç¼–è¯‘é€šè¿‡ï¼Œä½†åœ¨è¿è¡Œæ—¶ä¼šå‘ç”ŸIllegalMonitorStateExceptionçš„å¼‚å¸¸ã€‚Object.notifyAll()ï¼šåˆ™ä»Žå¯¹è±¡ç­‰å¾…æ± ä¸­å”¤é†’æ‰€æœ‰ç­‰å¾…ç­‰å¾…çº¿ç¨‹Object.notify()ï¼šåˆ™ä»Žå¯¹è±¡ç­‰å¾…æ± ä¸­å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ã€‚Thread.yield()æ–¹æ³• æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å¯¹è±¡ï¼Œyield()åªæ˜¯ä½¿å½“å‰çº¿ç¨‹é‡æ–°å›žåˆ°å¯æ‰§è¡ŒçŠ¶æ€ï¼Œæ‰€ä»¥æ‰§è¡Œyield()çš„çº¿ç¨‹æœ‰å¯èƒ½åœ¨è¿›å…¥åˆ°å¯æ‰§è¡ŒçŠ¶æ€åŽé©¬ä¸Šåˆè¢«æ‰§è¡Œï¼Œyield()åªèƒ½ä½¿åŒä¼˜å…ˆçº§æˆ–æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æœ‰æ‰§è¡Œçš„æœºä¼šã€‚Thread.Join()ï¼šæŠŠæŒ‡å®šçš„çº¿ç¨‹åŠ å…¥åˆ°å½“å‰çº¿ç¨‹ï¼Œå¯ä»¥å°†ä¸¤ä¸ªäº¤æ›¿æ‰§è¡Œçš„çº¿ç¨‹åˆå¹¶ä¸ºé¡ºåºæ‰§è¡Œçš„çº¿ç¨‹ã€‚æ¯”å¦‚åœ¨çº¿ç¨‹Bä¸­è°ƒç”¨äº†çº¿ç¨‹Açš„Join()æ–¹æ³•ï¼Œç›´åˆ°çº¿ç¨‹Aæ‰§è¡Œå®Œæ¯•åŽï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œçº¿ç¨‹Bã€‚å¥½äº†ã€‚æœ¬ç¯‡çº¿ç¨‹åŸºç¡€çŸ¥è¯†ä»‹ç»åˆ°æ­¤ç»“æŸã€‚ å‚è€ƒ http://blog.csdn.net/javazejian/article/details/50878598æ‰€æœ‰ä»£ç åœ¨ https://github.com/ejunjsh/java-code/tree/master/com/sky/code/thread]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é€šè¿‡åç¼–è¯‘æ·±å…¥ç†è§£Java StringåŠintern]]></title>
    <url>%2F2016%2F07%2F29%2Fjava-string-intern%2F</url>
    <content type="text"><![CDATA[å­—ç¬¦ä¸²é—®é¢˜å­—ç¬¦ä¸²åœ¨æˆ‘ä»¬å¹³æ—¶çš„ç¼–ç å·¥ä½œä¸­å…¶å®žç”¨çš„éžå¸¸å¤šï¼Œå¹¶ä¸”ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥å¾ˆå°‘æœ‰äººå¯¹å…¶åšç‰¹åˆ«æ·±å…¥çš„ç ”ç©¶ã€‚å€’æ˜¯é¢è¯•æˆ–è€…ç¬”è¯•çš„æ—¶å€™ï¼Œå¾€å¾€ä¼šæ¶‰åŠæ¯”è¾ƒæ·±å…¥å’Œéš¾åº¦å¤§ä¸€ç‚¹çš„é—®é¢˜ã€‚æˆ‘åœ¨æ‹›è˜çš„æ—¶å€™ä¹Ÿå¶å°”ä¼šé—®åº”è˜è€…ç›¸å…³çš„é—®é¢˜ï¼Œå€’ä¸æ˜¯è¯´ä¸€å®šè¦å›žç­”çš„ç‰¹åˆ«æ­£ç¡®å’Œæ·±å…¥ï¼Œé€šå¸¸é—®è¿™äº›é—®é¢˜çš„ç›®çš„æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€æ˜¯è€ƒå¯Ÿå¯¹ JAVA åŸºç¡€çŸ¥è¯†çš„äº†è§£ç¨‹åº¦ï¼Œç¬¬äºŒæ˜¯è€ƒå¯Ÿåº”è˜è€…å¯¹æŠ€æœ¯çš„æ€åº¦ã€‚ æˆ‘ä»¬çœ‹çœ‹ä»¥ä¸‹ç¨‹åºä¼šè¾“å‡ºä»€ä¹ˆç»“æžœï¼Ÿå¦‚æžœä½ èƒ½æ­£ç¡®çš„å›žç­”æ¯ä¸€é“é¢˜ï¼Œå¹¶ä¸”æ¸…æ¥šå…¶åŽŸå› ï¼Œé‚£æœ¬æ–‡å¯¹ä½ å°±æ²¡ä»€ä¹ˆå¤ªå¤§çš„æ„ä¹‰ã€‚å¦‚æžœå›žç­”ä¸æ­£ç¡®æˆ–è€…ä¸æ˜¯å¾ˆæ¸…æ¥šå…¶åŽŸç†ï¼Œé‚£å°±ä»”ç»†çœ‹çœ‹ä»¥ä¸‹çš„åˆ†æžï¼Œæœ¬æ–‡åº”è¯¥èƒ½å¸®åŠ©ä½ æ¸…æ¥šçš„ç†è§£æ¯æ®µç¨‹åºçš„ç»“æžœåŠè¾“å‡ºè¯¥ç»“æžœçš„æ·±å±‚æ¬¡åŽŸå› ã€‚ ä»£ç æ®µä¸€ï¼š1234567891011package com.paddx.test.string;public class StringTest &#123; public static void main(String[] args) &#123; String str1 = "string"; String str2 = new String("string"); String str3 = str2.intern(); System.out.println(str1==str2);//#1 System.out.println(str1==str3);//#2 &#125;&#125; ä»£ç æ®µäºŒï¼š12345678910111213141516171819 package com.paddx.test.string; public class StringTest01 &#123; public static void main(String[] args) &#123; String baseStr = "baseStr"; final String baseFinalStr = "baseStr"; String str1 = "baseStr01"; String str2 = "baseStr"+"01"; String str3 = baseStr + "01"; String str4 = baseFinalStr+"01"; String str5 = new String("baseStr01").intern(); System.out.println(str1 == str2);//#3 System.out.println(str1 == str3);//#4 System.out.println(str1 == str4);//#5 System.out.println(str1 == str5);//#6 &#125;&#125; ä»£ç æ®µä¸‰ï¼ˆ1ï¼‰ï¼š12345678910package com.paddx.test.string;&lt;br&gt; public class InternTest &#123; public static void main(String[] args) &#123; String str2 = new String("str")+new String("01"); str2.intern(); String str1 = "str01"; System.out.println(str2==str1);//#7 &#125;&#125; ä»£ç æ®µä¸‰ï¼ˆ2ï¼‰ï¼š12345678910 package com.paddx.test.string; public class InternTest01 &#123; public static void main(String[] args) &#123; String str1 = "str01"; String str2 = new String("str")+new String("01"); str2.intern(); System.out.println(str2 == str1);//#8 &#125;&#125; ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘å¯¹ä¸Šè¿°ä»£ç çš„è¾“å‡ºç»“æžœç”±#1~#8è¿›è¡Œäº†ç¼–ç ï¼Œä¸‹æ–‡ä¸­è“è‰²å­—ä½“éƒ¨åˆ†å³ä¸ºç»“æžœã€‚ å­—ç¬¦ä¸²æ·±å…¥åˆ†æžä»£ç æ®µä¸€åˆ†æžå­—ç¬¦ä¸²ä¸å±žäºŽåŸºæœ¬ç±»åž‹ï¼Œä½†æ˜¯å¯ä»¥åƒåŸºæœ¬ç±»åž‹ä¸€æ ·ï¼Œç›´æŽ¥é€šè¿‡å­—é¢é‡èµ‹å€¼ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡newæ¥ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ã€‚ä¸è¿‡é€šè¿‡å­—é¢é‡èµ‹å€¼çš„æ–¹å¼å’Œnewçš„æ–¹å¼ç”Ÿæˆå­—ç¬¦ä¸²æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼š é€šè¿‡å­—é¢é‡èµ‹å€¼åˆ›å»ºå­—ç¬¦ä¸²æ—¶ï¼Œä¼šä¼˜å…ˆåœ¨å¸¸é‡æ± ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œå€˜è‹¥å·²ç»å­˜åœ¨ï¼Œæ ˆä¸­çš„å¼•ç”¨ç›´æŽ¥æŒ‡å‘è¯¥å­—ç¬¦ä¸²ï¼›å€˜è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå†å°†æ ˆä¸­çš„å¼•ç”¨æŒ‡å‘è¯¥å­—ç¬¦ä¸²ã€‚è€Œé€šè¿‡newçš„æ–¹å¼åˆ›å»ºå­—ç¬¦ä¸²æ—¶ï¼Œå°±ç›´æŽ¥åœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²çš„å¯¹è±¡ï¼ˆå¤‡æ³¨ï¼ŒJDK 7 ä»¥åŽï¼ŒHotSpot å·²å°†å¸¸é‡æ± ä»Žæ°¸ä¹…ä»£è½¬ç§»åˆ°äº†å †ä¸­ã€‚è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒã€ŠJDK8å†…å­˜æ¨¡åž‹-æ¶ˆå¤±çš„PermGenã€‹ä¸€æ–‡ï¼‰ï¼Œæ ˆä¸­çš„å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡ã€‚å¯¹äºŽå †ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ intern() æ–¹æ³•æ¥å°†å­—ç¬¦ä¸²æ·»åŠ çš„å¸¸é‡æ± ä¸­ï¼Œå¹¶è¿”å›žæŒ‡å‘è¯¥å¸¸é‡çš„å¼•ç”¨ã€‚çŽ°åœ¨æˆ‘ä»¬åº”è¯¥èƒ½å¾ˆæ¸…æ¥šä»£ç æ®µä¸€çš„ç»“æžœäº†ï¼š ç»“æžœ #1ï¼šå› ä¸ºstr1æŒ‡å‘çš„æ˜¯å­—ç¬¦ä¸²ä¸­çš„å¸¸é‡ï¼Œstr2æ˜¯åœ¨å †ä¸­ç”Ÿæˆçš„å¯¹è±¡ï¼Œæ‰€ä»¥str1==str2è¿”å›žfalseã€‚ç»“æžœ #2ï¼šstr2è°ƒç”¨internæ–¹æ³•ï¼Œä¼šå°†str2ä¸­å€¼ï¼ˆâ€œstringâ€ï¼‰å¤åˆ¶åˆ°å¸¸é‡æ± ä¸­ï¼Œä½†æ˜¯å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨è¯¥å­—ç¬¦ä¸²ï¼ˆå³str1æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼‰ï¼Œæ‰€ä»¥ç›´æŽ¥è¿”å›žè¯¥å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼Œå› æ­¤str1==str2è¿”å›žtrueã€‚ ä»¥ä¸‹è¿è¡Œä»£ç æ®µä¸€çš„ä»£ç çš„ç»“æžœï¼š ä»£ç æ®µäºŒåˆ†æžå¯¹äºŽä»£ç æ®µäºŒçš„ç»“æžœï¼Œè¿˜æ˜¯é€šè¿‡åç¼–è¯‘StringTest01.classæ–‡ä»¶æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼šå¸¸é‡æ± å†…å®¹ï¼ˆéƒ¨åˆ†ï¼‰ï¼šæ‰§è¡ŒæŒ‡ä»¤ï¼ˆéƒ¨åˆ†ï¼Œç¬¬äºŒåˆ—#+åºæ•°å¯¹åº”å¸¸é‡æ± ä¸­çš„é¡¹ï¼‰ï¼šåœ¨è§£é‡Šä¸Šè¿°æ‰§è¡Œè¿‡ç¨‹ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸¤æ¡æŒ‡ä»¤ï¼š ldcï¼šPush item from run-time constant poolï¼Œä»Žå¸¸é‡æ± ä¸­åŠ è½½æŒ‡å®šé¡¹çš„å¼•ç”¨åˆ°æ ˆã€‚ astore_ï¼šStore reference into local variableï¼Œå°†å¼•ç”¨èµ‹å€¼ç»™ç¬¬nä¸ªå±€éƒ¨å˜é‡ã€‚ çŽ°åœ¨æˆ‘ä»¬å¼€å§‹è§£é‡Šä»£ç æ®µäºŒçš„æ‰§è¡Œè¿‡ç¨‹ï¼š 0: ldc #2ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬äºŒé¡¹ï¼ˆâ€baseStrâ€ï¼‰åˆ°æ ˆä¸­ã€‚ 2: astore_1 ï¼šå°†1ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå³String baseStr = â€œbaseStrâ€ï¼› 3: ldc #2ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬äºŒé¡¹ï¼ˆâ€baseStrâ€ï¼‰åˆ°æ ˆä¸­ã€‚ 5: astore_2 ï¼šå°†3ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬äºŒä¸ªå±€éƒ¨å˜é‡ï¼Œå³ final String baseFinalStr=â€baseStrâ€ï¼› 6: ldc #3ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼ˆâ€baseStr01â€ï¼‰åˆ°æ ˆä¸­ã€‚ 8: astore_3 ï¼šå°†6ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬ä¸‰ä¸ªå±€éƒ¨å˜é‡ï¼Œå³String str1=â€baseStr01â€; 9: ldc #3ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼ˆâ€baseStr01â€ï¼‰åˆ°æ ˆä¸­ã€‚ 11: astore 4ï¼šå°†9ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬å››ä¸ªå±€éƒ¨å˜é‡ï¼šå³String str2=â€baseStr01â€ï¼› ç»“æžœ#3ï¼šstr1==str2 è‚¯å®šä¼šè¿”å›žtrueï¼Œå› ä¸ºstr1å’Œstr2éƒ½æŒ‡å‘å¸¸é‡æ± ä¸­çš„åŒä¸€å¼•ç”¨åœ°å€ã€‚æ‰€ä»¥å…¶å®žåœ¨JAVA 1.6ä¹‹åŽï¼Œå¸¸é‡å­—ç¬¦ä¸²çš„â€œ+â€æ“ä½œï¼Œç¼–è¯‘é˜¶æ®µç›´æŽ¥ä¼šåˆæˆä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚13: new #4ï¼šç”ŸæˆStringBuilderçš„å®žä¾‹ã€‚16: dup ï¼šå¤åˆ¶13ç”Ÿæˆå¯¹è±¡çš„å¼•ç”¨å¹¶åŽ‹å…¥æ ˆä¸­ã€‚17: invokespecial #5ï¼šè°ƒç”¨å¸¸é‡æ± ä¸­çš„ç¬¬äº”é¡¹ï¼Œå³StringBuilder.æ–¹æ³•ã€‚ä»¥ä¸Šä¸‰æ¡æŒ‡ä»¤çš„ä½œç”¨æ˜¯ç”Ÿæˆä¸€ä¸ªStringBuilderçš„å¯¹è±¡ã€‚20: aload_1 ï¼šåŠ è½½ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼ï¼Œå³â€baseStrâ€21: invokevirtual #6 ï¼šè°ƒç”¨StringBuilderå¯¹è±¡çš„appendæ–¹æ³•ã€‚24: ldc #7ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸ƒé¡¹ï¼ˆâ€01â€ï¼‰åˆ°æ ˆä¸­ã€‚26: invokevirtual #6ï¼šè°ƒç”¨StringBuilder.appendæ–¹æ³•ã€‚29: invokevirtual #8ï¼šè°ƒç”¨StringBuilder.toStringæ–¹æ³•ã€‚32: astore 5ï¼šå°†29ä¸­çš„ç»“æžœå¼•ç”¨èµ‹å€¼æ”¹ç¬¬äº”ä¸ªå±€éƒ¨å˜é‡ï¼Œå³å¯¹å˜é‡str3çš„èµ‹å€¼ã€‚ç»“æžœ #4ï¼šå› ä¸ºstr3å®žé™…ä¸Šæ˜¯stringBuilder.append()ç”Ÿæˆçš„ç»“æžœï¼Œæ‰€ä»¥ä¸Žstr1ä¸ç›¸ç­‰ï¼Œç»“æžœè¿”å›žfalseã€‚34: ldc #3ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼ˆâ€baseStr01â€ï¼‰åˆ°æ ˆä¸­ã€‚36: astore 6ï¼šå°†34ä¸­çš„å¼•ç”¨èµ‹å€¼ç»™ç¬¬å…­ä¸ªå±€éƒ¨å˜é‡ï¼Œå³str4=â€baseStr01â€;ç»“æžœ #5 ï¼šå› ä¸ºstr1å’Œstr4æŒ‡å‘çš„éƒ½æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼Œæ‰€ä»¥str1==str4è¿”å›žtrueã€‚è¿™é‡Œæˆ‘ä»¬è¿˜èƒ½å‘çŽ°ä¸€ä¸ªçŽ°è±¡ï¼Œå¯¹äºŽfinalå­—æ®µï¼Œç¼–è¯‘æœŸç›´æŽ¥è¿›è¡Œäº†å¸¸é‡æ›¿æ¢ï¼Œè€Œå¯¹äºŽéžfinalå­—æ®µåˆ™æ˜¯åœ¨è¿è¡ŒæœŸè¿›è¡Œèµ‹å€¼å¤„ç†çš„ã€‚38: new #9ï¼šåˆ›å»ºStringå¯¹è±¡41: dup ï¼šå¤åˆ¶å¼•ç”¨å¹¶åŽ‹å¦‚æ ˆä¸­ã€‚42: ldc #3ï¼šåŠ è½½å¸¸é‡æ± ä¸­çš„ç¬¬ä¸‰é¡¹ï¼ˆâ€baseStr01â€ï¼‰åˆ°æ ˆä¸­ã€‚44: invokespecial #10ï¼šè°ƒç”¨String.â€â€œæ–¹æ³•ï¼Œå¹¶ä¼ 42æ­¥éª¤ä¸­çš„å¼•ç”¨ä½œä¸ºå‚æ•°ä¼ å…¥è¯¥æ–¹æ³•ã€‚47: invokevirtual #11ï¼šè°ƒç”¨String.internæ–¹æ³•ã€‚ä»Ž38åˆ°41çš„å¯¹åº”çš„æºç å°±æ˜¯new String(â€œbaseStr01â€).intern()ã€‚50: astore 7ï¼šå°†47æ­¥è¿”å›žçš„ç»“æžœèµ‹å€¼ç»™å˜é‡7ï¼Œå³str5æŒ‡å‘baseStr01åœ¨å¸¸é‡æ± ä¸­çš„ä½ç½®ã€‚ç»“æžœ #6 ï¼šå› ä¸ºstr5å’Œstr1éƒ½æŒ‡å‘çš„éƒ½æ˜¯å¸¸é‡æ± ä¸­çš„åŒä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥str1==str5è¿”å›žtrueã€‚è¿è¡Œä»£ç æ®µäºŒï¼Œè¾“å‡ºç»“æžœå¦‚ä¸‹ï¼š## ä»£ç æ®µä¸‰è§£æžï¼šå¯¹äºŽä»£ç æ®µä¸‰ï¼Œåœ¨ JDK 1.6 å’Œ JDK 1.7ä¸­çš„è¿è¡Œç»“æžœä¸åŒã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿è¡Œç»“æžœï¼Œç„¶åŽå†æ¥è§£é‡Šå…¶åŽŸå› ï¼šJDK 1.6 ä¸‹çš„è¿è¡Œç»“æžœï¼šJDK 1.7 ä¸‹çš„è¿è¡Œç»“æžœï¼šæ ¹æ®å¯¹ä»£ç æ®µä¸€çš„åˆ†æžï¼Œåº”è¯¥å¯ä»¥å¾ˆç®€å•å¾—å‡º JDK 1.6 çš„ç»“æžœï¼Œå› ä¸º str2 å’Œ str1æœ¬æ¥å°±æ˜¯æŒ‡å‘ä¸åŒçš„ä½ç½®ï¼Œç†åº”è¿”å›žfalseã€‚æ¯”è¾ƒå¥‡æ€ªçš„é—®é¢˜åœ¨äºŽJDK 1.7åŽï¼Œå¯¹äºŽç¬¬ä¸€ç§æƒ…å†µè¿”å›žtrueï¼Œä½†æ˜¯è°ƒæ¢äº†ä¸€ä¸‹ä½ç½®è¿”å›žçš„ç»“æžœå°±å˜æˆäº†falseã€‚è¿™ä¸ªåŽŸå› ä¸»è¦æ˜¯ä»ŽJDK 1.7åŽï¼ŒHotSpot å°†å¸¸é‡æ± ä»Žæ°¸ä¹…ä»£ç§»åˆ°äº†å…ƒç©ºé—´ï¼Œæ­£å› ä¸ºå¦‚æ­¤ï¼ŒJDK 1.7 åŽçš„internæ–¹æ³•åœ¨å®žçŽ°ä¸Šå‘ç”Ÿäº†æ¯”è¾ƒå¤§çš„æ”¹å˜ï¼ŒJDK 1.7åŽï¼Œinternæ–¹æ³•è¿˜æ˜¯ä¼šå…ˆåŽ»æŸ¥è¯¢å¸¸é‡æ± ä¸­æ˜¯å¦æœ‰å·²ç»å­˜åœ¨ï¼Œå¦‚æžœå­˜åœ¨ï¼Œåˆ™è¿”å›žå¸¸é‡æ± ä¸­çš„å¼•ç”¨ï¼Œè¿™ä¸€ç‚¹ä¸Žä¹‹å‰æ²¡æœ‰åŒºåˆ«ï¼ŒåŒºåˆ«åœ¨äºŽï¼Œå¦‚æžœåœ¨å¸¸é‡æ± æ‰¾ä¸åˆ°å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œåˆ™ä¸ä¼šå†å°†å­—ç¬¦ä¸²æ‹·è´åˆ°å¸¸é‡æ± ï¼Œè€Œåªæ˜¯åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆä¸€ä¸ªå¯¹åŽŸå­—ç¬¦ä¸²çš„å¼•ç”¨ã€‚æ‰€ä»¥:ç»“æžœ #7ï¼šåœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œå› ä¸ºå¸¸é‡æ± ä¸­æ²¡æœ‰â€œstr01â€è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¼šåœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆä¸€ä¸ªå¯¹å †ä¸­çš„â€œstr01â€çš„å¼•ç”¨ï¼Œè€Œåœ¨è¿›è¡Œå­—é¢é‡èµ‹å€¼çš„æ—¶å€™ï¼Œå¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨ï¼Œæ‰€ä»¥ç›´æŽ¥è¿”å›žè¯¥å¼•ç”¨å³å¯ï¼Œå› æ­¤str1å’Œstr2éƒ½æŒ‡å‘å †ä¸­çš„å­—ç¬¦ä¸²ï¼Œè¿”å›žtrueã€‚ç»“æžœ #8ï¼šè°ƒæ¢ä½ç½®ä»¥åŽï¼Œå› ä¸ºåœ¨è¿›è¡Œå­—é¢é‡èµ‹å€¼ï¼ˆString str1 = â€œstr01â€ï¼‰çš„æ—¶å€™ï¼Œå¸¸é‡æ± ä¸­ä¸å­˜åœ¨ï¼Œæ‰€ä»¥str1æŒ‡å‘çš„å¸¸é‡æ± ä¸­çš„ä½ç½®ï¼Œè€Œstr2æŒ‡å‘çš„æ˜¯å †ä¸­çš„å¯¹è±¡ï¼Œå†è¿›è¡Œinternæ–¹æ³•æ—¶ï¼Œå¯¹str1å’Œstr2å·²ç»æ²¡æœ‰å½±å“äº†ï¼Œæ‰€ä»¥è¿”å›žfalseã€‚ å¸¸è§é¢è¯•é¢˜è§£ç­”æœ‰äº†å¯¹ä»¥ä¸Šçš„çŸ¥è¯†çš„äº†è§£ï¼Œæˆ‘ä»¬çŽ°åœ¨å†æ¥çœ‹å¸¸è§çš„é¢è¯•æˆ–ç¬”è¯•é¢˜å°±å¾ˆç®€å•äº†ï¼š Qï¼šString s = new String(â€œxyzâ€)ï¼Œåˆ›å»ºäº†å‡ ä¸ªString Object? Aï¼šä¸¤ä¸ªï¼Œå¸¸é‡æ± ä¸­çš„â€xyzâ€å’Œå †ä¸­å¯¹è±¡ã€‚ Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æžœï¼š String s1 = â€œabcâ€;String s2 = â€œabcâ€;System.out.println(s1 == s2); Aï¼štrueï¼Œå‡æŒ‡å‘å¸¸é‡æ± ä¸­å¯¹è±¡ã€‚ Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æžœï¼š String s1 = new String(â€œabcâ€);String s2 = new String(â€œabcâ€);System.out.println(s1 == s2); Aï¼šfalseï¼Œä¸¤ä¸ªå¼•ç”¨æŒ‡å‘å †ä¸­çš„ä¸åŒå¯¹è±¡ã€‚ Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æžœï¼š String s1 = â€œabcâ€;String s2 = â€œaâ€;String s3 = â€œbcâ€;String s4 = s2 + s3;System.out.println(s1 == s4); Aï¼šfalseï¼Œå› ä¸ºs2+s3å®žé™…ä¸Šæ˜¯ä½¿ç”¨StringBuilder.appendæ¥å®Œæˆï¼Œä¼šç”Ÿæˆä¸åŒçš„å¯¹è±¡ã€‚ Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æžœï¼š String s1 = â€œabcâ€;final String s2 = â€œaâ€;final String s3 = â€œbcâ€;String s4 = s2 + s3;System.out.println(s1 == s4); Aï¼štrueï¼Œå› ä¸ºfinalå˜é‡åœ¨ç¼–è¯‘åŽä¼šç›´æŽ¥æ›¿æ¢æˆå¯¹åº”çš„å€¼ï¼Œæ‰€ä»¥å®žé™…ä¸Šç­‰äºŽs4=â€aâ€+â€bcâ€ï¼Œè€Œè¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šç›´æŽ¥åˆå¹¶ä¸ºs4=â€abcâ€ï¼Œæ‰€ä»¥æœ€ç»ˆs1==s4ã€‚ Qï¼šä¸‹åˆ—ç¨‹åºçš„è¾“å‡ºç»“æžœï¼š String s = new String(â€œabcâ€);String s1 = â€œabcâ€;String s2 = new String(â€œabcâ€); System.out.println(s == s1.intern());System.out.println(s == s2.intern());System.out.println(s1 == s2.intern()); Aï¼šfalseï¼Œfalseï¼Œtrueï¼Œå…·ä½“åŽŸå› å‚è€ƒç¬¬äºŒéƒ¨åˆ†å†…å®¹ã€‚ åŽŸæ–‡åœ°å€ http://www.cnblogs.com/paddix/p/5326863.html]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Java8å†…å­˜æ¨¡åž‹â€”æ°¸ä¹…ä»£(PermGen)å’Œå…ƒç©ºé—´(Metaspace)]]></title>
    <url>%2F2016%2F07%2F26%2Fjava8-permgen-metaspace%2F</url>
    <content type="text"><![CDATA[JVM å†…å­˜æ¨¡åž‹æ ¹æ® JVM è§„èŒƒï¼ŒJVM å†…å­˜å…±åˆ†ä¸ºè™šæ‹Ÿæœºæ ˆã€å †ã€æ–¹æ³•åŒºã€ç¨‹åºè®¡æ•°å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆäº”ä¸ªéƒ¨åˆ†ã€‚ è™šæ‹Ÿæœºæ ˆæ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªç§æœ‰çš„æ ˆï¼Œéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºã€‚æ ˆé‡Œé¢å­˜ç€çš„æ˜¯ä¸€ç§å«â€œæ ˆå¸§â€çš„ä¸œè¥¿ï¼Œæ¯ä¸ªæ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ ˆå¸§ä¸­å­˜æ”¾äº†å±€éƒ¨å˜é‡è¡¨ï¼ˆåŸºæœ¬æ•°æ®ç±»åž‹å’Œå¯¹è±¡å¼•ç”¨ï¼‰ã€æ“ä½œæ•°æ ˆã€æ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚æ ˆçš„å¤§å°å¯ä»¥å›ºå®šä¹Ÿå¯ä»¥åŠ¨æ€æ‰©å±•ã€‚å½“æ ˆè°ƒç”¨æ·±åº¦å¤§äºŽJVMæ‰€å…è®¸çš„èŒƒå›´ï¼Œä¼šæŠ›å‡ºStackOverflowErrorçš„é”™è¯¯ï¼Œä¸è¿‡è¿™ä¸ªæ·±åº¦èŒƒå›´ä¸æ˜¯ä¸€ä¸ªæ’å®šçš„å€¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™æ®µç¨‹åºå¯ä»¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªç»“æžœï¼šæ ˆæº¢å‡ºæµ‹è¯•æºç ï¼š1234567891011121314151617181920package com.paddx.test.memory; public class StackErrorMock &#123; private static int index = 1; public void call()&#123; index++; call(); &#125; public static void main(String[] args) &#123; StackErrorMock mock = new StackErrorMock(); try &#123; mock.call(); &#125;catch (Throwable e)&#123; System.out.println("Stack deep : "+index); e.printStackTrace(); &#125; &#125;&#125; ä»£ç æ®µ1 è¿è¡Œä¸‰æ¬¡ï¼Œå¯ä»¥çœ‹å‡ºæ¯æ¬¡æ ˆçš„æ·±åº¦éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¾“å‡ºç»“æžœå¦‚ä¸‹ã€‚è‡³äºŽçº¢è‰²æ¡†é‡Œçš„å€¼æ˜¯æ€Žä¹ˆå‡ºæ¥çš„ï¼Œå°±éœ€è¦æ·±å…¥åˆ° JVM çš„æºç ä¸­æ‰èƒ½æŽ¢è®¨ï¼Œè¿™é‡Œä¸ä½œè¯¦ç»†é˜è¿°ã€‚ è™šæ‹Ÿæœºæ ˆé™¤äº†ä¸Šè¿°é”™è¯¯å¤–ï¼Œè¿˜æœ‰å¦ä¸€ç§é”™è¯¯ï¼Œé‚£å°±æ˜¯å½“ç”³è¯·ä¸åˆ°ç©ºé—´æ—¶ï¼Œä¼šæŠ›å‡º OutOfMemoryErrorã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œcatch æ•èŽ·çš„æ˜¯ Throwableï¼Œè€Œä¸æ˜¯ Exceptionã€‚å› ä¸º StackOverflowError å’Œ OutOfMemoryError éƒ½ä¸å±žäºŽ Exception çš„å­ç±»ã€‚ æœ¬åœ°æ–¹æ³•æ ˆè¿™éƒ¨åˆ†ä¸»è¦ä¸Žè™šæ‹Ÿæœºç”¨åˆ°çš„ Native æ–¹æ³•ç›¸å…³ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ Java åº”ç”¨ç¨‹åºå‘˜å¹¶ä¸éœ€è¦å…³å¿ƒè¿™éƒ¨åˆ†çš„å†…å®¹ PC å¯„å­˜å™¨PC å¯„å­˜å™¨ï¼Œä¹Ÿå«ç¨‹åºè®¡æ•°å™¨ã€‚JVMæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ã€‚å€˜è‹¥å½“å‰æ‰§è¡Œçš„æ˜¯ JVM çš„æ–¹æ³•ï¼Œåˆ™è¯¥å¯„å­˜å™¨ä¸­ä¿å­˜å½“å‰æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ï¼›å€˜è‹¥æ‰§è¡Œçš„æ˜¯native æ–¹æ³•ï¼Œåˆ™PCå¯„å­˜å™¨ä¸­ä¸ºç©ºã€‚ å †å †å†…å­˜æ˜¯ JVM æ‰€æœ‰çº¿ç¨‹å…±äº«çš„éƒ¨åˆ†ï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™å°±å·²ç»åˆ›å»ºã€‚æ‰€æœ‰çš„å¯¹è±¡å’Œæ•°ç»„éƒ½åœ¨å †ä¸Šè¿›è¡Œåˆ†é…ã€‚è¿™éƒ¨åˆ†ç©ºé—´å¯é€šè¿‡ GC è¿›è¡Œå›žæ”¶ã€‚å½“ç”³è¯·ä¸åˆ°ç©ºé—´æ—¶ä¼šæŠ›å‡º OutOfMemoryErrorã€‚ä¸‹é¢æˆ‘ä»¬ç®€å•çš„æ¨¡æ‹Ÿä¸€ä¸ªå †å†…å­˜æº¢å‡ºçš„æƒ…å†µï¼š12345678910111213141516171819202122package com.paddx.test.memory; import java.util.ArrayList;import java.util.List; public class HeapOomMock &#123; public static void main(String[] args) &#123; List&lt;byte[]&gt; list = new ArrayList&lt;byte[]&gt;(); int i = 0; boolean flag = true; while (flag)&#123; try &#123; i++; list.add(new byte[1024 * 1024]);//æ¯æ¬¡å¢žåŠ ä¸€ä¸ª1Må¤§å°çš„æ•°ç»„å¯¹è±¡ &#125;catch (Throwable e)&#123; e.printStackTrace(); flag = false; System.out.println("count="+i);//è®°å½•è¿è¡Œçš„æ¬¡æ•° &#125; &#125; &#125;&#125; ä»£ç æ®µ2 è¿è¡Œä¸Šè¿°ä»£ç ï¼Œè¾“å‡ºç»“æžœå¦‚ä¸‹ï¼š æ³¨æ„ï¼Œè¿™é‡Œæˆ‘æŒ‡å®šäº†å †å†…å­˜çš„å¤§å°ä¸º16Mï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹æ˜¾ç¤ºçš„count=14ï¼ˆè¿™ä¸ªæ•°å­—ä¸æ˜¯å›ºå®šçš„ï¼‰ï¼Œè‡³äºŽä¸ºä»€ä¹ˆä¼šæ˜¯14æˆ–å…¶ä»–æ•°å­—ï¼Œéœ€è¦æ ¹æ® GC æ—¥å¿—æ¥åˆ¤æ–­ æ–¹æ³•åŒº æ–¹æ³•åŒºä¹Ÿæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«ã€‚ä¸»è¦ç”¨äºŽå­˜å‚¨ç±»çš„ä¿¡æ¯ã€å¸¸é‡æ± ã€æ–¹æ³•æ•°æ®ã€æ–¹æ³•ä»£ç ç­‰ã€‚æ–¹æ³•åŒºé€»è¾‘ä¸Šå±žäºŽå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä¸ºäº†ä¸Žå †è¿›è¡ŒåŒºåˆ†ï¼Œé€šå¸¸åˆå«â€œéžå †â€ã€‚ å…³äºŽæ–¹æ³•åŒºå†…å­˜æº¢å‡ºçš„é—®é¢˜ä¼šåœ¨ä¸‹æ–‡ä¸­è¯¦ç»†æŽ¢è®¨ã€‚ PermGenï¼ˆæ°¸ä¹…ä»£ï¼‰ç»å¤§éƒ¨åˆ† Java ç¨‹åºå‘˜åº”è¯¥éƒ½è§è¿‡ â€œjava.lang.OutOfMemoryError: PermGen space â€œè¿™ä¸ªå¼‚å¸¸ã€‚è¿™é‡Œçš„ â€œPermGen spaceâ€å…¶å®žæŒ‡çš„å°±æ˜¯æ–¹æ³•åŒºã€‚ä¸è¿‡æ–¹æ³•åŒºå’Œâ€œPermGen spaceâ€åˆæœ‰ç€æœ¬è´¨çš„åŒºåˆ«ã€‚å‰è€…æ˜¯ JVM çš„è§„èŒƒï¼Œè€ŒåŽè€…åˆ™æ˜¯ JVM è§„èŒƒçš„ä¸€ç§å®žçŽ°ï¼Œå¹¶ä¸”åªæœ‰ HotSpot æ‰æœ‰ â€œPermGen spaceâ€ï¼Œè€Œå¯¹äºŽå…¶ä»–ç±»åž‹çš„è™šæ‹Ÿæœºï¼Œå¦‚ JRockitï¼ˆOracleï¼‰ã€J9ï¼ˆIBMï¼‰ å¹¶æ²¡æœ‰â€œPermGen spaceâ€ã€‚ç”±äºŽæ–¹æ³•åŒºä¸»è¦å­˜å‚¨ç±»çš„ç›¸å…³ä¿¡æ¯ï¼Œæ‰€ä»¥å¯¹äºŽåŠ¨æ€ç”Ÿæˆç±»çš„æƒ…å†µæ¯”è¾ƒå®¹æ˜“å‡ºçŽ°æ°¸ä¹…ä»£çš„å†…å­˜æº¢å‡ºã€‚æœ€å…¸åž‹çš„åœºæ™¯å°±æ˜¯ï¼Œåœ¨ jsp é¡µé¢æ¯”è¾ƒå¤šçš„æƒ…å†µï¼Œå®¹æ˜“å‡ºçŽ°æ°¸ä¹…ä»£å†…å­˜æº¢å‡ºã€‚æˆ‘ä»¬çŽ°åœ¨é€šè¿‡åŠ¨æ€ç”Ÿæˆç±»æ¥æ¨¡æ‹Ÿ â€œPermGen spaceâ€çš„å†…å­˜æº¢å‡ºï¼š1234package com.paddx.test.memory; public class Test &#123;&#125; 12345678910111213141516171819202122232425package com.paddx.test.memory; import java.io.File;import java.net.URL;import java.net.URLClassLoader;import java.util.ArrayList;import java.util.List; public class PermGenOomMock&#123; public static void main(String[] args) &#123; URL url = null; List&lt;ClassLoader&gt; classLoaderList = new ArrayList&lt;ClassLoader&gt;(); try &#123; url = new File("/tmp").toURI().toURL(); URL[] urls = &#123;url&#125;; while (true)&#123; ClassLoader loader = new URLClassLoader(urls); classLoaderList.add(loader); loader.loadClass("com.paddx.test.memory.Test"); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; ä»£ç æ®µ3 è¿è¡Œç»“æžœå¦‚ä¸‹ï¼š æœ¬ä¾‹ä¸­ä½¿ç”¨çš„ JDK ç‰ˆæœ¬æ˜¯ 1.7ï¼ŒæŒ‡å®šçš„ PermGen åŒºçš„å¤§å°ä¸º 8Mã€‚é€šè¿‡æ¯æ¬¡ç”Ÿæˆä¸åŒURLClassLoaderå¯¹è±¡æ¥åŠ è½½Testç±»ï¼Œä»Žè€Œç”Ÿæˆä¸åŒçš„ç±»å¯¹è±¡ï¼Œè¿™æ ·å°±èƒ½çœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„ â€œjava.lang.OutOfMemoryError: PermGen space â€œ å¼‚å¸¸äº†ã€‚è¿™é‡Œä¹‹æ‰€ä»¥é‡‡ç”¨ JDK 1.7ï¼Œæ˜¯å› ä¸ºåœ¨ JDK 1.8 ä¸­ï¼Œ HotSpot å·²ç»æ²¡æœ‰ â€œPermGen spaceâ€è¿™ä¸ªåŒºé—´äº†ï¼Œå–è€Œä»£ä¹‹æ˜¯ä¸€ä¸ªå«åš Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰ çš„ä¸œè¥¿ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ Metaspace ä¸Ž PermGen space çš„åŒºåˆ«ã€‚ Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰å…¶å®žï¼Œç§»é™¤æ°¸ä¹…ä»£çš„å·¥ä½œä»ŽJDK1.7å°±å¼€å§‹äº†ã€‚JDK1.7ä¸­ï¼Œå­˜å‚¨åœ¨æ°¸ä¹…ä»£çš„éƒ¨åˆ†æ•°æ®å°±å·²ç»è½¬ç§»åˆ°äº†Java Heapæˆ–è€…æ˜¯ Native Heapã€‚ä½†æ°¸ä¹…ä»£ä»å­˜åœ¨äºŽJDK1.7ä¸­ï¼Œå¹¶æ²¡å®Œå…¨ç§»é™¤ï¼Œè­¬å¦‚ç¬¦å·å¼•ç”¨(Symbols)è½¬ç§»åˆ°äº†native heapï¼›å­—é¢é‡(interned strings)è½¬ç§»åˆ°äº†java heapï¼›ç±»çš„é™æ€å˜é‡(class statics)è½¬ç§»åˆ°äº†java heapã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€æ®µç¨‹åºæ¥æ¯”è¾ƒ JDK 1.6 ä¸Ž JDK 1.7åŠ JDK 1.8 çš„åŒºåˆ«ï¼Œä»¥å­—ç¬¦ä¸²å¸¸é‡ä¸ºä¾‹ï¼š12345678910111213141516package com.paddx.test.memory; import java.util.ArrayList;import java.util.List; public class StringOomMock &#123; static String base = "string"; public static void main(String[] args) &#123; List&lt;String&gt; list = new ArrayList&lt;String&gt;(); for (int i=0;i&lt; Integer.MAX_VALUE;i++)&#123; String str = base + base; base = str; list.add(str.intern()); &#125; &#125;&#125; ä»£ç æ®µ4 è¿™æ®µç¨‹åºä»¥2çš„æŒ‡æ•°çº§ä¸æ–­çš„ç”Ÿæˆæ–°çš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·å¯ä»¥æ¯”è¾ƒå¿«é€Ÿçš„æ¶ˆè€—å†…å­˜ã€‚æˆ‘ä»¬é€šè¿‡ JDK 1.6ã€JDK 1.7 å’Œ JDK 1.8 åˆ†åˆ«è¿è¡Œï¼šJDK 1.6 çš„è¿è¡Œç»“æžœï¼šJDK 1.7çš„è¿è¡Œç»“æžœï¼šJDK 1.8çš„è¿è¡Œç»“æžœï¼šä»Žä¸Šè¿°ç»“æžœå¯ä»¥çœ‹å‡ºï¼ŒJDK 1.6ä¸‹ï¼Œä¼šå‡ºçŽ°â€œPermGen Spaceâ€çš„å†…å­˜æº¢å‡ºï¼Œè€Œåœ¨ JDK 1.7å’Œ JDK 1.8 ä¸­ï¼Œä¼šå‡ºçŽ°å †å†…å­˜æº¢å‡ºï¼Œå¹¶ä¸” JDK 1.8ä¸­ PermSize å’Œ MaxPermGen å·²ç»æ— æ•ˆã€‚å› æ­¤ï¼Œå¯ä»¥å¤§è‡´éªŒè¯ JDK 1.7 å’Œ 1.8 å°†å­—ç¬¦ä¸²å¸¸é‡ç”±æ°¸ä¹…ä»£è½¬ç§»åˆ°å †ä¸­ï¼Œå¹¶ä¸” JDK 1.8 ä¸­å·²ç»ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„ç»“è®ºã€‚çŽ°åœ¨æˆ‘ä»¬çœ‹çœ‹å…ƒç©ºé—´åˆ°åº•æ˜¯ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®žçŽ°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸Žæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºŽï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹å‚æ•°æ¥æŒ‡å®šå…ƒç©ºé—´çš„å¤§å°ï¼š -XX:MetaspaceSizeï¼Œåˆå§‹ç©ºé—´å¤§å°ï¼Œè¾¾åˆ°è¯¥å€¼å°±ä¼šè§¦å‘åžƒåœ¾æ”¶é›†è¿›è¡Œç±»åž‹å¸è½½ï¼ŒåŒæ—¶GCä¼šå¯¹è¯¥å€¼è¿›è¡Œè°ƒæ•´ï¼šå¦‚æžœé‡Šæ”¾äº†å¤§é‡çš„ç©ºé—´ï¼Œå°±é€‚å½“é™ä½Žè¯¥å€¼ï¼›å¦‚æžœé‡Šæ”¾äº†å¾ˆå°‘çš„ç©ºé—´ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡MaxMetaspaceSizeæ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ã€‚ -XX:MaxMetaspaceSizeï¼Œæœ€å¤§ç©ºé—´ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰é™åˆ¶çš„ã€‚ é™¤äº†ä¸Šé¢ä¸¤ä¸ªæŒ‡å®šå¤§å°çš„é€‰é¡¹ä»¥å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªä¸Ž GC ç›¸å…³çš„å±žæ€§ï¼š -XX:MinMetaspaceFreeRatioï¼Œåœ¨GCä¹‹åŽï¼Œæœ€å°çš„Metaspaceå‰©ä½™ç©ºé—´å®¹é‡çš„ç™¾åˆ†æ¯”ï¼Œå‡å°‘ä¸ºåˆ†é…ç©ºé—´æ‰€å¯¼è‡´çš„åžƒåœ¾æ”¶é›† -XX:MaxMetaspaceFreeRatioï¼Œåœ¨GCä¹‹åŽï¼Œæœ€å¤§çš„Metaspaceå‰©ä½™ç©ºé—´å®¹é‡çš„ç™¾åˆ†æ¯”ï¼Œå‡å°‘ä¸ºé‡Šæ”¾ç©ºé—´æ‰€å¯¼è‡´çš„åžƒåœ¾æ”¶é›† çŽ°åœ¨æˆ‘ä»¬åœ¨ JDK 8ä¸‹é‡æ–°è¿è¡Œä¸€ä¸‹ä»£ç æ®µ3ï¼Œä¸è¿‡è¿™æ¬¡ä¸å†æŒ‡å®š PermSize å’Œ MaxPermSizeã€‚è€Œæ˜¯æŒ‡å®š MetaSpaceSize å’Œ MaxMetaSpaceSizeçš„å¤§å°ã€‚è¾“å‡ºç»“æžœå¦‚ä¸‹ï¼šä»Žè¾“å‡ºç»“æžœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™æ¬¡ä¸å†å‡ºçŽ°æ°¸ä¹…ä»£æº¢å‡ºï¼Œè€Œæ˜¯å‡ºçŽ°äº†å…ƒç©ºé—´çš„æº¢å‡ºã€‚ æ€»ç»“ é€šè¿‡ä¸Šé¢åˆ†æžï¼Œå¤§å®¶åº”è¯¥å¤§è‡´äº†è§£äº† JVM çš„å†…å­˜åˆ’åˆ†ï¼Œä¹Ÿæ¸…æ¥šäº† JDK 8 ä¸­æ°¸ä¹…ä»£å‘å…ƒç©ºé—´çš„è½¬æ¢ã€‚ä¸è¿‡å¤§å®¶åº”è¯¥éƒ½æœ‰ä¸€ä¸ªç–‘é—®ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªè½¬æ¢ï¼Ÿæ‰€ä»¥ï¼Œæœ€åŽç»™å¤§å®¶æ€»ç»“ä»¥ä¸‹å‡ ç‚¹åŽŸå› ï¼š å­—ç¬¦ä¸²å­˜åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œå®¹æ˜“å‡ºçŽ°æ€§èƒ½é—®é¢˜å’Œå†…å­˜æº¢å‡ºã€‚ ç±»åŠæ–¹æ³•çš„ä¿¡æ¯ç­‰æ¯”è¾ƒéš¾ç¡®å®šå…¶å¤§å°ï¼Œå› æ­¤å¯¹äºŽæ°¸ä¹…ä»£çš„å¤§å°æŒ‡å®šæ¯”è¾ƒå›°éš¾ï¼Œå¤ªå°å®¹æ˜“å‡ºçŽ°æ°¸ä¹…ä»£æº¢å‡ºï¼Œå¤ªå¤§åˆ™å®¹æ˜“å¯¼è‡´è€å¹´ä»£æº¢å‡ºã€‚ æ°¸ä¹…ä»£ä¼šä¸º GC å¸¦æ¥ä¸å¿…è¦çš„å¤æ‚åº¦ï¼Œå¹¶ä¸”å›žæ”¶æ•ˆçŽ‡åä½Žã€‚ Oracle å¯èƒ½ä¼šå°†HotSpot ä¸Ž JRockit åˆäºŒä¸ºä¸€ã€‚ åŽŸæ–‡åœ°å€ http://www.cnblogs.com/paddix/p/5309550.html]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä»Žå­—èŠ‚ç å±‚é¢çœ‹â€œHelloWorldâ€]]></title>
    <url>%2F2016%2F07%2F23%2Fbytecode-hello-world%2F</url>
    <content type="text"><![CDATA[HelloWorld å­—èŠ‚ç ç”Ÿæˆä¼—æ‰€å‘¨çŸ¥ï¼ŒJava ç¨‹åºæ˜¯åœ¨ JVM ä¸Šè¿è¡Œçš„ï¼Œä¸è¿‡ JVM è¿è¡Œçš„å…¶å®žä¸æ˜¯ Java è¯­è¨€æœ¬èº«ï¼Œè€Œæ˜¯ Java ç¨‹åºç¼–è¯‘æˆçš„å­—èŠ‚ç æ–‡ä»¶ã€‚å¯èƒ½ä¸€å¼€å§‹ JVM æ˜¯ä¸º Java è¯­è¨€æœåŠ¡çš„ï¼Œä¸è¿‡éšç€ç¼–è¯‘æŠ€æœ¯å’Œ JVM è‡ªèº«çš„ä¸æ–­å‘å±•å’Œæˆç†Ÿï¼ŒJVM å·²ç»ä¸ä»…ä»…åªè¿è¡Œ Java ç¨‹åºã€‚ä»»ä½•èƒ½ç¼–è¯‘æˆä¸ºç¬¦åˆ JVM å­—èŠ‚ç è§„èŒƒçš„è¯­è¨€éƒ½å¯ä»¥åœ¨ JVM ä¸Šè¿è¡Œï¼Œæ¯”è¾ƒå¸¸è§çš„ Scalaã€Grooveã€JRubyç­‰ã€‚ä»Šå¤©ï¼Œæˆ‘å°±ä»Žå¤§å®¶æœ€ç†Ÿæ‚‰çš„ç¨‹åºâ€œHelloWorldâ€ç¨‹åºå…¥æ‰‹ï¼Œåˆ†æžæ•´ä¸ª Class æ–‡ä»¶çš„ç»“æž„ã€‚è™½ç„¶è¿™ä¸ªç¨‹åºæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åŸºæœ¬ä¸ŠåŒ…å«äº†å­—èŠ‚ç è§„èŒƒä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œå› æ­¤å³ä½¿ä»¥åŽè¦åˆ†æžæ›´å¤æ‚çš„ç¨‹åºï¼Œé‚£ä¹Ÿåªæ˜¯â€œé‡â€ä¸Šçš„å˜åŒ–ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ã€‚ æˆ‘ä»¬å…ˆç›´è§‚çš„çœ‹ä¸‹æºç ä¸Žå­—èŠ‚ç ä¹‹é—´çš„å¯¹åº”å…³ç³»:HelloWorldçš„æºç ï¼š1234567package com.paddx.test.asm; public class HelloWorld &#123; public static void main(String[] args) &#123; System.out.println("Hello,World!"); &#125;&#125; ç¼–è¯‘å™¨é‡‡ç”¨JDK 1.7ï¼š12345678&lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;source&gt;1.7&lt;/source&gt; &lt;target&gt;1.7&lt;/target&gt; &lt;/configuration&gt; &lt;/plugin&gt; ç¼–è¯‘ä»¥åŽçš„å­—èŠ‚ç æ–‡ä»¶ï¼ˆä½¿ç”¨UltraEditçš„16è¿›åˆ¶æ¨¡å¼æ‰“å¼€ï¼‰ï¼šçº¢è‰²æ¡†å†…çš„éƒ¨åˆ†å°±æ˜¯HelloWorld.classçš„å†…å®¹ï¼Œå…¶ä»–éƒ¨åˆ†æ˜¯UltraEditè‡ªåŠ¨ç”Ÿæˆçš„ï¼šçº¢è‰²æ¡†é¡¶éƒ¨çš„0~fä»£è¡¨åˆ—å·ï¼Œå·¦è¾¹éƒ¨åˆ†ä»£è¡¨è¡Œå·ï¼Œå³ä¾§éƒ¨åˆ†æ˜¯äºŒè¿›åˆ¶ç å¯¹åº”çš„å­—ç¬¦ï¼ˆutf-8ç¼–ç ï¼‰ã€‚ å­—èŠ‚ç è§£æžè¦å¼„æ˜Žç™½ HelloWorld.java å’Œ HelloWorld.class æ–‡ä»¶æ˜¯å¦‚ä½•å¯¹åº”çš„ï¼Œæˆ‘ä»¬å¿…é¡»å¯¹ JVM çš„å­—èŠ‚ç è§„èŒƒæœ‰æ‰€äº†è§£ã€‚å­—èŠ‚ç æ–‡ä»¶çš„ç»“æž„éžå¸¸ç´§å‡‘ï¼Œæ²¡æœ‰ä»»ä½•å†—ä½™çš„ä¿¡æ¯ï¼Œè¿žåˆ†éš”ç¬¦éƒ½æ²¡æœ‰ï¼Œå®ƒé‡‡ç”¨çš„æ˜¯å›ºå®šçš„æ–‡ä»¶ç»“æž„å’Œæ•°æ®ç±»åž‹æ¥å®žçŽ°å¯¹å†…å®¹çš„åˆ†å‰²çš„ã€‚å­—èŠ‚ç ä¸­åŒ…æ‹¬ä¸¤ç§æ•°æ®ç±»åž‹ï¼šæ— ç¬¦å·æ•°å’Œè¡¨ã€‚æ— ç¬¦å·æ•°åˆåŒ…æ‹¬ u1ï¼Œu2ï¼Œu4ï¼Œu8å››ç§ï¼Œåˆ†åˆ«ä»£è¡¨1ä¸ªå­—èŠ‚ã€2ä¸ªå­—èŠ‚ã€4ä¸ªå­—èŠ‚å’Œ8ä¸ªå­—èŠ‚ã€‚è€Œè¡¨ç»“æž„åˆ™æ˜¯ç”±æ— ç¬¦å·æ•°æ®ç»„æˆçš„ã€‚ å­—èŠ‚ç æ–‡ä»¶çš„æ ¼å¼å›ºå®šå¦‚ä¸‹ï¼š type descriptor u4 magic u2 minor_version u2 major_version u2 constant_pool_count cp_info constant_pool[cosntant_pool_count â€“ 1] u2 access_flags u2 this_class u2 super_class u2 interfaces_count u2 interfaces[interfaces_count] u2 fields_count field_info fields[fields_count] u2 methods_count method_info methods[methods_count] u2 attributes_count attribute_info attributes[attributes_count] çŽ°åœ¨ï¼Œæˆ‘ä»¬å°±æŒ‰è¿™ä¸ªæ ¼å¼å¯¹ä¸Šè¿°HelloWorld.classæ–‡ä»¶è¿›è¡Œåˆ†æžï¼š magicï¼ˆu4ï¼‰ï¼šCA FE BA BE ï¼Œä»£è¡¨è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ï¼Œæˆ‘ä»¬å¹³æ—¶åŒºåˆ†æ–‡ä»¶ç±»åž‹éƒ½æ˜¯é€šè¿‡åŽç¼€åæ¥åŒºåˆ†çš„ï¼Œä¸è¿‡åŽç¼€åæ˜¯å¯ä»¥éšä¾¿ä¿®æ”¹çš„ï¼Œæ‰€ä»¥ä»…é åŽç¼€åä¸èƒ½çœŸæ­£åŒºåˆ†ä¸€ä¸ªæ–‡ä»¶çš„ç±»åž‹ã€‚åŒºåˆ†æ–‡ä»¶ç±»åž‹çš„å¦ä¸ªåŠžæ³•å°±æ˜¯magicæ•°å­—ï¼ŒJVM å°±æ˜¯é€šè¿‡ CA FE BA BE æ¥åˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯ä¸æ˜¯classæ–‡ä»¶ã€‚ minor_versionï¼ˆu2ï¼‰ï¼š00 00ï¼Œå°ç‰ˆæœ¬å·ï¼Œå› ä¸ºæˆ‘è¿™é‡Œé‡‡ç”¨çš„1.7ï¼Œæ‰€ä»¥å°ç‰ˆæœ¬å·ä¸º0. major_versionï¼ˆu2ï¼‰ï¼š00 33ï¼Œå¤§ç‰ˆæœ¬å·ï¼Œx033è½¬æ¢ä¸ºåè¿›åˆ¶ä¸º51ï¼Œä¸‹è¡¨æ˜¯jdk 1.6 ä»¥åŽå¯¹åº”æ”¯æŒçš„ Class æ–‡ä»¶ç‰ˆæœ¬å·ï¼š ç¼–è¯‘å™¨ç‰ˆæœ¬ -targetå‚æ•° åå…­è¿›åˆ¶ç‰ˆæœ¬ åè¿›åˆ¶ç‰ˆæœ¬ JDK 1.6.0_01 ä¸å¸¦ï¼ˆé»˜è®¤ -target 1.6ï¼‰ 00 00 00 32 50.0 JDK 1.6.0_01 -target 1.5 00 00 00 31 49.0 JDK 1.6.0_01 -target 1.4 -source 1.4 00 00 00 30 48.0 JDK 1.7.0 ä¸å¸¦ï¼ˆé»˜è®¤ -target 1.7ï¼‰ 00 00 00 33 51.0 JDK 1.7.0 -target 1.6 00 00 00 32 50.0 JDK 1.7.0 -target 1.4 -source 1.4 00 00 00 30 48.0 JDK 1.8.0 ä¸å¸¦ï¼ˆé»˜è®¤ -target 1.8ï¼‰ 00 00 00 34 52.0 constant_pool_countï¼ˆu2ï¼‰ï¼š00 22ï¼Œå¸¸é‡æ± æ•°é‡ï¼Œè½¬æ¢ä¸ºåè¿›åˆ¶åŽä¸º34ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­—èŠ‚ç çš„å¸¸é‡æ± æ˜¯ä»Ž1å¼€å§‹è®¡æ•°çš„ï¼Œæ‰€ä»¥34è¡¨ç¤ºä¸ºï¼ˆ34-1ï¼‰=33é¡¹ã€‚ TAGï¼ˆu1ï¼‰ï¼š0Aï¼Œå¸¸é‡æ± çš„æ•°æ®ç±»åž‹æ˜¯è¡¨ï¼Œæ¯ä¸€é¡¹çš„å¼€å§‹éƒ½æœ‰ä¸€ä¸ªtagï¼ˆu1ï¼‰ï¼Œè¡¨ç¤ºå¸¸é‡çš„ç±»åž‹ï¼Œå¸¸é‡æ± çš„è¡¨çš„ç±»åž‹åŒ…æ‹¬å¦‚ä¸‹14ç§ï¼Œè¿™é‡ŒAï¼ˆ10ï¼‰è¡¨ç¤ºCONSTANT_Methodrefï¼Œä»£è¡¨æ–¹æ³•å¼•ç”¨ã€‚ å¸¸é‡ç±»åž‹ å€¼ CONSTANT_Utf8_info 1 CONSTANT_Integer_info 3 CONSTANT_Float_info 4 CONSTANT_Long_info 5 CONSTANT_Double_info 6 CONSTANT_Class_info 7 CONSTANT_String_info 8 CONSTANT_Fieldref_info 9 CONSTANT_Methodref_info 10 CONSTANT_InterfaceMethodref_info 11 CONSTANT_NameAndType_info 12 CONSTANT_MethodHandle_info 15 CONSTANT_MethodType_info 16 CONSTANT_InvokeDynamic_info 18 æ¯ç§å¸¸é‡ç±»åž‹å¯¹åº”è¡¨ç»“æž„ï¼š å¸¸é‡ é¡¹ç›® ç±»åž‹ æè¿° CONSTANT_Utf8_info tag u1 1 length u2 å­—èŠ‚æ•° bytes u1 utf-8ç¼–ç çš„å­—ç¬¦ä¸² CONSTANT_Integer_info tag u1 3 bytes u4 intå€¼ CONSTANT_Float_info tag u4 4 bytes u1 floatå€¼ CONSTANT_Long_info tag u1 5 bytes u8 longå€¼ CONSTANT_Double_info tag u1 6 bytes u8 doubleå€¼ CONSTANT_Class_info tag u1 7 index u2 æŒ‡å‘å…¨é™å®šåå¸¸é‡é¡¹çš„ç´¢å¼• CONSTANT_String_info tag u1 8 index u2 æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡çš„ç´¢å¼• CONSTANT_Fieldref_info tag u1 9 index u2 æŒ‡å‘å£°æ˜Žå­—æ®µçš„ç±»æˆ–æŽ¥å£æè¿°ç¬¦CONSTANT_Class_infoçš„ç´¢å¼•å€¼ index u2 æŒ‡å‘CONSTANT_NameAndType_infoçš„ç´¢å¼•å€¼ CONSTANT_Methodref_info tag u1 10 index u2 æŒ‡å‘å£°æ˜Žæ–¹æ³•çš„ç±»æè¿°ç¬¦CONSTANT_Class_infoçš„ç´¢å¼•å€¼ index u2 æŒ‡å‘CONSTANT_NameAndType_infoçš„ç´¢å¼•å€¼ CONSTANT_InterfaceMethodref_info tag u1 11 index u2 æŒ‡å‘å£°æ˜Žæ–¹æ³•çš„æŽ¥å£æè¿°ç¬¦CONSTANT_Class_infoçš„ç´¢å¼•å€¼ index u2 æŒ‡å‘CONSTANT_NameAndType_infoçš„ç´¢å¼•å€¼ CONSTANT_NameAndType_info tag u1 12 index u2 æŒ‡å‘è¯¥å­—æ®µæˆ–æ–¹æ³•åç§°å¸¸é‡çš„ç´¢å¼•å€¼ index u2 æŒ‡å‘è¯¥å­—æ®µæˆ–æ–¹æ³•æè¿°ç¬¦å¸¸é‡çš„ç´¢å¼•å€¼ CONSTANT_MethodHandle_info tag u1 15 reference_kind u1 å€¼å¿…é¡»1~9ï¼Œå®ƒå†³å®šäº†æ–¹æ³•å¥æŸ„çš„çš„ç±»åž‹ reference_index u2 å¯¹å¸¸é‡æ± çš„ç´¢å¼• CONSTANT_MethodType_info tag u1 16 description_index u2 å¯¹å¸¸é‡æ± ä¸­æ–¹æ³•æè¿°ç¬¦çš„ç´¢å¼• CONSTANT_InvokeDynamic_info tag u1 18 bootstap_method_attr_index u2 å¯¹å¼•å¯¼æ–¹æ³•è¡¨çš„ç´¢å¼• name_and_type_index u2 å¯¹CONSTANT_NameAndType_infoçš„ç´¢å¼• CONSTANT_Methodref_infoï¼ˆu2):00 06ï¼Œå› ä¸ºtagä¸ºAï¼Œä»£è¡¨ä¸€ä¸ªæ–¹æ³•å¼•ç”¨è¡¨ï¼ˆCONSTANT_Methodref_infoï¼‰ï¼Œæ‰€ä»¥ç¬¬äºŒé¡¹ï¼ˆu2ï¼‰åº”è¯¥æ˜¯æŒ‡å‘å¸¸é‡æ± çš„ä½ç½®ï¼Œå³å¸¸é‡æ± çš„ç¬¬å…­é¡¹ï¼Œè¡¨ç¤ºä¸€ä¸ªCONSTANT_Class_infoè¡¨çš„ç´¢å¼•ï¼Œç”¨ç±»ä¼¼çš„æ–¹æ³•å¾€ä¸‹åˆ†æžï¼Œå¯ä»¥å‘çŽ°å¸¸é‡æ± çš„ç¬¬å…­é¡¹å¦‚ä¸‹ï¼Œtagç±»åž‹ä¸º07ï¼ŒæŸ¥è¯¢ä¸Šè¡¨å¯çŸ¥é“å…¶å³ä¸ºCONSTANT_Class_infoã€‚ 07ä¹‹åŽçš„00 1Bè¡¨ç¤ºå¯¹å¸¸é‡æ± åœ°27é¡¹ï¼ˆCONSTANT_Utf8_infoï¼‰çš„å¼•ç”¨ï¼ŒæŸ¥çœ‹ç¬¬27é¡¹å¦‚ä¸‹å›¾ï¼Œå³ï¼ˆjava/lang/Objectï¼‰ï¼š CONSTANT_NameAndType_infoï¼ˆu2ï¼‰ï¼š00 14,æ–¹æ³•å¼•ç”¨è¡¨çš„ç¬¬ä¸‰é¡¹ï¼ˆu2ï¼‰ï¼Œå¸¸é‡æ± ç´¢å¼•ï¼ŒæŒ‡å‘ç¬¬20é¡¹ã€‚ CONSTANT_Fieldref_infoï¼ˆu1ï¼‰ï¼štagä¸º09ã€‚ â€¦.. å¸¸é‡æ± çš„åˆ†æžéƒ½ç±»ä¼¼ï¼Œå…¶ä»–çš„åˆ†æžç”±äºŽç¯‡å¹…é—®é¢˜å°±ä¸åœ¨æ­¤ä¸€ä¸€è®²è¿°äº†ã€‚è·³è¿‡å¸¸é‡æ± å°±åˆ°äº†è®¿é—®æ ‡è¯†ï¼ˆu2ï¼‰ï¼š JVM å¯¹è®¿é—®æ ‡ç¤ºç¬¦çš„è§„èŒƒå¦‚ä¸‹ï¼š Flag Name Value Remarks ACC_PUBLIC 0x0001 pubilc ACC_FINAL 0x0010 final ACC_SUPER 0x0020 ç”¨äºŽå…¼å®¹æ—©æœŸç¼–è¯‘å™¨ï¼Œæ–°ç¼–è¯‘å™¨éƒ½è®¾ç½®è¯¥æ ‡è®°ï¼Œä»¥åœ¨ä½¿ç”¨ invokespecialæŒ‡ä»¤æ—¶å¯¹å­ç±»æ–¹æ³•åšç‰¹å®šå¤„ç†ã€‚ ACC_INTERFACE 0x0200 æŽ¥å£ï¼ŒåŒæ—¶éœ€è¦è®¾ç½®ï¼šACC_ABSTRACTã€‚ä¸å¯åŒæ—¶è®¾ç½®ï¼šACC_FINALã€ACC_SUPERã€ACC_ENUM ACC_ABSTRACT 0x0400 æŠ½è±¡ç±»ï¼Œæ— æ³•å®žä¾‹åŒ–ã€‚ä¸å¯ä¸ŽACC_FINALåŒæ—¶è®¾ç½®ã€‚ ACC_SYNTHETIC 0x1000 syntheticï¼Œç”±ç¼–è¯‘å™¨äº§ç”Ÿï¼Œä¸å­˜åœ¨äºŽæºä»£ç ä¸­ã€‚ ACC_ANNOTATION 0x2000 æ³¨è§£ç±»åž‹ï¼ˆannotationï¼‰ï¼Œéœ€åŒæ—¶è®¾ç½®ï¼šACC_INTERFACEã€ACC_ABSTRACT ACC_ENUM 0x4000 æžšä¸¾ç±»åž‹ è¿™ä¸ªè¡¨é‡Œé¢æ— æ³•ç›´æŽ¥æŸ¥è¯¢åˆ°0021è¿™ä¸ªå€¼ï¼ŒåŽŸå› æ˜¯0021=0020+0001ï¼Œå³public+invokespecialæŒ‡ä»¤ï¼Œæºç ä¸­çš„æ–¹æ³•mainæ˜¯publicçš„ï¼Œè€Œinvokespecialæ˜¯çŽ°åœ¨çš„ç‰ˆæœ¬éƒ½æœ‰çš„ï¼Œæ‰€ä»¥å€¼ä¸º0021ã€‚ æŽ¥ç€å¾€ä¸‹æ˜¯this_classï¼ˆu2ï¼‰ï¼šæ˜¯æŒ‡å‘constant poolçš„ç´¢å¼•å€¼ï¼Œè¯¥å€¼å¿…é¡»æ˜¯CONSTANT_Class_infoç±»åž‹ï¼Œå€¼ä¸º00 05ï¼Œå³æŒ‡å‘å¸¸é‡æ± ä¸­çš„ç¬¬äº”é¡¹ï¼Œç¬¬äº”é¡¹æŒ‡å‘å¸¸é‡æ± ä¸­çš„ç¬¬26é¡¹ï¼Œå³com/paddx/test/asm/HelloWorldï¼š super_class(u2)ï¼‰ï¼šsuper_classæ˜¯æŒ‡å‘constant poolçš„ç´¢å¼•å€¼ï¼Œè¯¥å€¼å¿…é¡»æ˜¯CONSTANT_Class_infoç±»åž‹ï¼ŒæŒ‡å®šå½“å‰å­—èŠ‚ç å®šä¹‰çš„ç±»æˆ–æŽ¥å£çš„ç›´æŽ¥çˆ¶ç±»ã€‚è¿™é‡Œçš„å–å€¼ä¸º00 06ï¼Œæ ¹æ®ä¸Šé¢çš„åˆ†æžï¼Œå¯¹åº”çš„æŒ‡å‘çš„å…¨é™å®šæ€§ç±»åä¸ºjava/lang/objectï¼Œå³å½“å‰ç±»çš„çˆ¶ç±»ä¸ºObjectç±»ã€‚ interfaces_countï¼ˆu2ï¼‰ï¼šæŽ¥å£çš„æ•°é‡ï¼Œå› ä¸ºè¿™é‡Œæ²¡æœ‰å®žçŽ°æŽ¥å£ï¼Œæ‰€ä»¥å€¼ä¸º 00 00ã€‚ interfaces[interfaces_count]ï¼šå› ä¸ºæ²¡æœ‰æŽ¥å£ï¼Œæ‰€ä»¥å°±ä¸å­˜åœ¨interfcesé€‰é¡¹ã€‚ field_countï¼šå±žæ€§æ•°é‡ï¼Œ00 00ã€‚ field_infoï¼šå› ä¸ºæ²¡æœ‰å±žæ€§ï¼Œæ‰€ä»¥ä¸å­˜åœ¨è¿™ä¸ªé€‰é¡¹ã€‚ method_countï¼š00 02ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ªæ–¹æ³•å‘¢ï¼Ÿæˆ‘ä»¬æ˜Žæ˜Žåªå†™äº†ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºJVM ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª çš„æ–¹æ³•ã€‚ method_infoï¼šæ–¹æ³•è¡¨ï¼Œå…¶ç»“æž„å¦‚ä¸‹ï¼š Type Descriptor u2 access_flag u2 name_index u2 descriptor_index u2 attributes_count attribute_info attribute_info[attributes_count] HelloWorld.classæ–‡ä»¶ä¸­å¯¹åº”çš„æ•°æ®ï¼š access_flagï¼ˆu2ï¼‰: 00 01 name_indexï¼ˆu2ï¼‰:00 07 descriptor_indexï¼ˆu2ï¼‰:00 08 å¯ä»¥çœ‹çœ‹ 07ã€08å¯¹åº”çš„å¸¸é‡æ± é‡Œé¢çš„å€¼ï¼š å³ 07 å¯¹åº”çš„æ˜¯ &#60;init&#62;ï¼Œ08 å¯¹åº”çš„æ˜¯()ï¼› attributes_count:00 01ï¼Œè¡¨ç¤ºåŒ…å«ä¸€ä¸ªå±žæ€§ attribute_infoï¼šå±žæ€§è¡¨ï¼Œè¯¥è¡¨çš„ç»“æž„å¦‚ä¸‹ï¼š Type Descriptor u2 attribute_name_index u4 attribute_length u1 bytes attribute_name_indexï¼ˆu2ï¼‰: 00 09ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­çš„ç´¢å¼•ã€‚ attribute_lengthï¼ˆu4ï¼‰ï¼š00 00 00 2Fï¼Œå±žæ€§çš„é•¿åº¦47ã€‚ attribute_info:å…·ä½“å±žæ€§çš„åˆ†æžä¸Žä¸Šé¢ç±»ä¼¼ï¼Œå¤§å®¶å¯ä»¥å¯¹ç€JVMçš„è§„èŒƒè‡ªå·±å°è¯•åˆ†æžä¸€ä¸‹ã€‚ ç¬¬ä¸€ä¸ªæ–¹æ³•ç»“æŸåŽï¼ŒæŽ¥ç€è¿›å…¥ç¬¬äºŒä¸ªæ–¹æ³•ï¼š ç¬¬äºŒä¸ªæ–¹æ³•çš„å±žæ€§é•¿åº¦ä¸ºx037ï¼Œè½¬æ¢ä¸ºåè¿›åˆ¶ä¸º55ä¸ªå­—èŠ‚ã€‚ä¸¤ä¸ªæ–¹æ³•ä¹‹åŽç´§è·Ÿç€çš„æ˜¯attribute_countå’Œattributesï¼š attribute_countï¼ˆu2ï¼‰:å€¼ä¸º 00 01ï¼Œå³æœ‰ä¸€ä¸ªå±žæ€§ã€‚ attribute_name_indexï¼ˆu2ï¼‰ï¼šæŒ‡å‘å¸¸é‡æ± ä¸­çš„ç¬¬åäºŒé¡¹ã€‚ attribute_lengthï¼ˆu4ï¼‰ï¼š00 00 00 02ï¼Œé•¿åº¦ä¸º2ã€‚ åˆ†æžå®Œæ¯•ï¼ åŸºäºŽå­—èŠ‚ç çš„æ“ä½œ é€šè¿‡å¯¹HelloWorldè¿™ä¸ªç¨‹åºçš„å­—èŠ‚ç åˆ†æžï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿæ¯”è¾ƒæ¸…æ¥šçš„è®¤è¯†åˆ°æ•´ä¸ªå­—èŠ‚ç çš„ç»“æž„ã€‚é‚£æˆ‘ä»¬é€šè¿‡å­—èŠ‚ç ï¼Œå¯ä»¥åšäº›ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®žé€šè¿‡å­—èŠ‚ç èƒ½åšå¾ˆå¤šå¹³æ—¶æˆ‘ä»¬æ— æ³•å®Œæˆçš„å·¥ä½œã€‚æ¯”å¦‚ï¼Œåœ¨ç±»åŠ è½½ä¹‹å‰æ·»åŠ æŸäº›æ“ä½œæˆ–è€…ç›´æŽ¥åŠ¨æ€çš„ç”Ÿæˆå­—èŠ‚ç ï¼ŒCGlibå°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å®žçŽ°åŠ¨æ€ä»£ç†çš„ã€‚çŽ°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥å®Œæˆå¦ä¸€ä¸ªç‰ˆæœ¬çš„HelloWorldï¼š1234567package com.paddx.test.asm; public class HelloWorld2 &#123; public static void sayHello()&#123; &#125;&#125; æˆ‘ä»¬æœ‰ä¸ªç©ºçš„æ–¹æ³• sayHello()ï¼ŒçŽ°åœ¨è¦å®žçŽ°è°ƒè¯¥æ–¹æ³•çš„æ—¶å€™æ‰“å°å‡ºâ€œHelloWorldâ€ï¼Œæ€Žä¹ˆå¤„ç†ï¼Ÿå¦‚æžœæˆ‘ä»¬æ‰‹åŠ¨åŽ»ä¿®æ”¹å­—èŠ‚ç æ–‡ä»¶ï¼Œå°†æ‰“å°â€œHelloWorldâ€çš„ä»£ç æ’å…¥åˆ°sayHelloæ–¹æ³•ä¸­ï¼ŒåŽŸç†ä¸Šè‚¯å®šæ²¡é—®é¢˜ï¼Œä¸è¿‡æ“ä½œè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚Java çš„æœ€å¤§ä¼˜åŠ¿å°±åœ¨äºŽåªè¦ä½ èƒ½æƒ³åˆ°çš„åŠŸèƒ½ï¼ŒåŸºæœ¬ä¸Šå°±æœ‰ç¬¬ä¸‰æ–¹å¼€æºçš„åº“å®žçŽ°è¿‡ã€‚å­—èŠ‚ç æ“ä½œçš„å¼€æºåº“ä¹Ÿæ¯”è¾ƒå¤šï¼Œè¿™é‡Œæˆ‘å°±ç”¨ ASM 4.0æ¥å®žçŽ°è¯¥åŠŸèƒ½ï¼š12345678910111213141516171819202122232425262728293031323334353637383940package com.paddx.test.asm; import org.objectweb.asm.*; import java.io.IOException;import java.lang.reflect.InvocationTargetException; public class AsmDemo extends ClassLoader&#123; public static void main(String[] args) throws IOException, IllegalAccessException, InstantiationException, InvocationTargetException &#123; ClassReader classReader = new ClassReader("com.paddx.test.asm.HelloWorld2"); ClassWriter cw=new ClassWriter(ClassWriter.COMPUTE_MAXS); CustomVisitor myv=new CustomVisitor(Opcodes.ASM4,cw); classReader.accept(myv, 0); byte[] code=cw.toByteArray(); AsmDemo loader=new AsmDemo(); Class&lt;?&gt; appClass=loader.defineClass(null, code, 0,code.length); appClass.getMethods()[0].invoke(appClass.newInstance(), new Object[]&#123;&#125;); &#125; &#125; class CustomVisitor extends ClassVisitor implements Opcodes &#123; public CustomVisitor(int api, ClassVisitor cv) &#123; super(api, cv); &#125; @Override public MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions) &#123; MethodVisitor mv = super.visitMethod(access, name, desc, signature, exceptions); if (name.equals("sayHello")) &#123; mv.visitFieldInsn(GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;"); mv.visitLdcInsn("HelloWorld!"); mv.visitMethodInsn(INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V"); &#125; return mv; &#125;&#125; è¿è¡Œç»“æžœå¦‚ä¸‹ï¼š å…³äºŽ ASM 4çš„æ“ä½œåœ¨è¿™å°±ä¸ç»†è¯´äº†ã€‚æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªå·±åŽ»ç ”ç©¶ä¸€ä¸‹ï¼Œæœ‰æœºä¼šï¼Œæˆ‘ä¹Ÿå¯ä»¥å†åŽç»­çš„åšæ–‡ä¸­è·Ÿå¤§å®¶åˆ†äº«ã€‚ æ€»ç»“ æœ¬æ–‡é€šè¿‡HelloWorldè¿™æ ·ä¸€ä¸ªå¤§å®¶éƒ½éžå¸¸ç†Ÿæ‚‰çš„ä¾‹å­ï¼Œæ·±å…¥çš„åˆ†æžäº†å­—èŠ‚ç æ–‡ä»¶çš„ç»“æž„ã€‚åˆ©ç”¨è¿™äº›ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å®Œæˆä¸€äº›ç›¸å¯¹é«˜çº§çš„åŠŸèƒ½ï¼Œå¦‚åŠ¨æ€ä»£ç†ç­‰ã€‚è¿™äº›ä¾‹å­è™½ç„¶éƒ½å¾ˆç®€å•ï¼Œä½†æ˜¯â€œéº»é›€è™½å°äº”è„ä¿±å…¨â€ï¼Œå³ä½¿å†å¤æ‚çš„ç¨‹åºä¹Ÿé€ƒç¦»ä¸äº†è¿™äº›æœ€åŸºæœ¬çš„ä¸œè¥¿ã€‚æŠ€æœ¯å±‚é¢çš„ä¸œè¥¿å°±æ˜¯è¿™æ ·å­ï¼Œåªè¦ä½ èƒ½äº†è§£ä¸€ä¸ªç®€å•çš„ç¨‹åºçš„åŽŸç†ï¼Œä¸¾ä¸€åä¸‰ï¼Œå°±èƒ½å¾ˆå®¹æ˜“çš„ç†è§£æ›´å¤æ‚çš„ç¨‹åºï¼Œè¿™å°±æ˜¯æŠ€æœ¯â€œæ˜“â€çš„æ–¹é¢ã€‚åŒæ—¶ï¼Œåè¿‡æ¥è¯´ï¼Œå³ä½¿â€œHelloWorldâ€è¿™æ ·ä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œå¦‚æžœæˆ‘ä»¬æ·±å…¥æŽ¢ç©¶ï¼Œä¹Ÿä¸ä¸€å®šèƒ½ç‰¹åˆ«ç†è§£å…¶åŽŸç†ï¼Œè¿™å°±æ˜¯æŠ€æœ¯â€œéš¾â€çš„æ–¹é¢ã€‚æ€»ä¹‹ï¼ŒæŠ€æœ¯è¿™ç§ä¸œè¥¿åªè¦ä½ ç”¨å¿ƒæ·±å…¥åœ°åŽ»ç ”ç©¶ï¼Œæ€»æ˜¯èƒ½å¸¦ç»™ä½ æ„æƒ³ä¸åˆ°çš„æƒŠå–œ~ åŽŸæ–‡åœ°å€ http://www.cnblogs.com/paddix/p/5282004.html]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[redis clusterç®¡ç†å·¥å…·redis-trib.rbè¯¦è§£]]></title>
    <url>%2F2016%2F04%2F22%2Fredis-trib%2F</url>
    <content type="text"><![CDATA[redis-trib.rbæ˜¯rediså®˜æ–¹æŽ¨å‡ºçš„ç®¡ç†redisé›†ç¾¤çš„å·¥å…·ï¼Œé›†æˆåœ¨redisçš„æºç srcç›®å½•ä¸‹ï¼Œæ˜¯åŸºäºŽredisæä¾›çš„é›†ç¾¤å‘½ä»¤å°è£…æˆç®€å•ã€ä¾¿æ·ã€å®žç”¨çš„æ“ä½œå·¥å…·ã€‚redis-trib.rbæ˜¯redisä½œè€…ç”¨rubyå®Œæˆçš„ã€‚ä¸ºäº†çœ‹æ‡‚redis-trib.rbï¼Œæˆ‘ç‰¹æ„èŠ±äº†ä¸€ä¸ªæ˜ŸæœŸå­¦ä¹ äº†rubyï¼Œä¹Ÿè¢«rubyçš„ç®€æ´ã€æ˜Žäº†æ‰€å¸å¼•ã€‚rubyæ˜¯é—¨éžå¸¸çµæ´»çš„è¯­è¨€ï¼Œredis-trib.rbåªç”¨äº†1600è¡Œå·¦å³çš„ä»£ç ï¼Œå°±å®žçŽ°äº†å¼ºå¤§çš„é›†ç¾¤æ“ä½œã€‚æœ¬æ–‡å¯¹redis-trib.rbçš„ä»‹ç»æ˜¯åŸºäºŽredis 3.0.6ç‰ˆæœ¬çš„æºç ã€‚é˜…è¯»æœ¬æ–‡éœ€è¦å¯¹redisé›†ç¾¤åŠŸèƒ½æœ‰ä¸€å®šçš„äº†è§£ã€‚å…³äºŽredisé›†ç¾¤åŠŸèƒ½çš„ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒæœ¬äººçš„å¦ä¸€ç¯‡æ–‡ç« ã€Šredis3.0 clusteråŠŸèƒ½ä»‹ç»ã€‹ã€‚ help ä¿¡æ¯å…ˆä»Žredis-trib.rbçš„helpä¿¡æ¯ï¼Œçœ‹ä¸‹redis-trib.rbæä¾›äº†å“ªäº›åŠŸèƒ½ã€‚12345678910111213141516171819202122232425262728293031323334353637$ruby redis-trib.rb helpUsage: redis-trib &lt;command&gt; &lt;options&gt; &lt;arguments ...&gt; create host1:port1 ... hostN:portN --replicas &lt;arg&gt; check host:port info host:port fix host:port --timeout &lt;arg&gt; reshard host:port --from &lt;arg&gt; --to &lt;arg&gt; --slots &lt;arg&gt; --yes --timeout &lt;arg&gt; --pipeline &lt;arg&gt; rebalance host:port --weight &lt;arg&gt; --auto-weights --threshold &lt;arg&gt; --use-empty-masters --timeout &lt;arg&gt; --simulate --pipeline &lt;arg&gt; add-node new_host:new_port existing_host:existing_port --slave --master-id &lt;arg&gt; del-node host:port node_id set-timeout host:port milliseconds call host:port command arg arg .. arg import host:port --from &lt;arg&gt; --copy --replace help (show this help)For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster. å¯ä»¥çœ‹åˆ°redis-trib.rbå…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š1ã€createï¼šåˆ›å»ºé›†ç¾¤2ã€checkï¼šæ£€æŸ¥é›†ç¾¤3ã€infoï¼šæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯4ã€fixï¼šä¿®å¤é›†ç¾¤5ã€reshardï¼šåœ¨çº¿è¿ç§»slot6ã€rebalanceï¼šå¹³è¡¡é›†ç¾¤èŠ‚ç‚¹slotæ•°é‡7ã€add-nodeï¼šå°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤8ã€del-nodeï¼šä»Žé›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹9ã€set-timeoutï¼šè®¾ç½®é›†ç¾¤èŠ‚ç‚¹é—´å¿ƒè·³è¿žæŽ¥çš„è¶…æ—¶æ—¶é—´10ã€callï¼šåœ¨é›†ç¾¤å…¨éƒ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤11ã€importï¼šå°†å¤–éƒ¨redisæ•°æ®å¯¼å…¥é›†ç¾¤ä¸‹é¢ä»Žredis-trib.rbä½¿ç”¨å’Œæºç çš„è§’åº¦è¯¦ç»†ä»‹ç»redis-trib.rbçš„æ¯ä¸ªåŠŸèƒ½ã€‚ redis-trib.rbä¸»è¦æœ‰ä¸¤ä¸ªç±»ï¼šClusterNodeå’ŒRedisTribã€‚ClusterNodeä¿å­˜äº†æ¯ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ŒRedisTribåˆ™æ˜¯redis-trib.rbå„ä¸ªåŠŸèƒ½çš„å®žçŽ°ã€‚ ClusterNodeå¯¹è±¡å…ˆåˆ†æžClusterNodeæºç ã€‚ClusterNodeæœ‰ä¸‹é¢å‡ ä¸ªæˆå‘˜å˜é‡ï¼ˆrubyçš„ç±»æˆå‘˜å˜é‡æ˜¯ä»¥@å¼€å¤´çš„ï¼‰ï¼š@rï¼šæ‰§è¡Œrediså‘½ä»¤çš„å®¢æˆ·ç«¯å¯¹è±¡ã€‚@infoï¼šä¿å­˜äº†è¯¥èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬cluster nodeså‘½ä»¤ä¸­è‡ªå·±è¿™è¡Œçš„ä¿¡æ¯å’Œcluster infoçš„ä¿¡æ¯ã€‚@dirtyï¼šèŠ‚ç‚¹ä¿¡æ¯æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¦‚æžœä¸ºtrueï¼Œæˆ‘ä»¬éœ€è¦æŠŠå†…å­˜çš„èŠ‚ç‚¹æ›´æ–°ä¿¡æ¯åˆ°èŠ‚ç‚¹ä¸Šã€‚@friendsï¼šä¿å­˜äº†é›†ç¾¤å…¶ä»–èŠ‚ç‚¹çš„infoä¿¡æ¯ã€‚å…¶ä¿¡æ¯ä¸ºé€šè¿‡cluster nodeså‘½ä»¤èŽ·å¾—çš„å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯ã€‚ClusterNodeæœ‰ä¸‹é¢ä¸€äº›æˆå‘˜æ–¹æ³•ï¼šinitializeï¼šClusterNodeçš„æž„é€ æ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥èŠ‚ç‚¹çš„åœ°å€ä¿¡æ¯ã€‚friendsï¼šè¿”å›ž@friendså¯¹è±¡ã€‚slotsï¼šè¿”å›žè¯¥èŠ‚ç‚¹è´Ÿè´£çš„slotsä¿¡æ¯ã€‚has_flag?ï¼šåˆ¤æ–­èŠ‚ç‚¹infoä¿¡æ¯çš„çš„flagsä¸­æ˜¯å¦æœ‰ç»™å®šçš„flagã€‚to_sï¼šç±»ä¼¼javaçš„toStringæ–¹æ³•ï¼Œè¿”å›žèŠ‚ç‚¹çš„åœ°å€ä¿¡æ¯ã€‚connectï¼šè¿žæŽ¥redisèŠ‚ç‚¹ã€‚assert_clusterï¼šåˆ¤æ–­èŠ‚ç‚¹å¼€å¯äº†é›†ç¾¤é…ç½®ã€‚assert_emptyï¼šç¡®å®šèŠ‚ç‚¹ç›®å‰æ²¡æœ‰è·Ÿä»»ä½•å…¶ä»–èŠ‚ç‚¹æ¡æ‰‹ï¼ŒåŒæ—¶è‡ªå·±çš„dbæ•°æ®ä¸ºç©ºã€‚load_infoï¼šé€šè¿‡cluster infoå’Œcluster nodeså¯¼å…¥èŠ‚ç‚¹ä¿¡æ¯ã€‚add_slotsï¼šç»™èŠ‚ç‚¹å¢žåŠ slotï¼Œè¯¥æ“ä½œåªæ˜¯åœ¨å†…å­˜ä¸­ä¿®æ”¹ï¼Œå¹¶æŠŠdirtyè®¾ç½®æˆtrueï¼Œç­‰å¾…flush_node_configå°†å†…å­˜ä¸­çš„æ•°æ®åŒæ­¥åœ¨èŠ‚ç‚¹æ‰§è¡Œã€‚set_as_replicaï¼šslaveè®¾ç½®å¤åˆ¶çš„masteråœ°å€ã€‚dirtyè®¾ç½®æˆtrueã€‚flush_node_configï¼šå°†å†…å­˜çš„æ•°æ®ä¿®æ”¹åŒæ­¥åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­æ‰§è¡Œã€‚info_stringï¼šç®€å•çš„infoä¿¡æ¯ã€‚get_config_signatureï¼šç”¨æ¥éªŒè¯é›†ç¾¤èŠ‚ç‚¹è§çš„cluster nodesä¿¡æ¯æ˜¯å¦ä¸€è‡´ã€‚è¯¥æ–¹æ³•è¿”å›žèŠ‚ç‚¹çš„ç­¾åä¿¡æ¯ã€‚infoï¼šè¿”å›ž@infoå¯¹è±¡ï¼ŒåŒ…å«è¯¦ç»†çš„infoä¿¡æ¯ã€‚is_dirty?ï¼šåˆ¤æ–­@dirtyã€‚rï¼šè¿”å›žæ‰§è¡Œrediså‘½ä»¤çš„å®¢æˆ·ç«¯å¯¹è±¡ã€‚ æœ‰äº†ClusterNodeå¯¹è±¡ï¼Œåœ¨å¤„ç†é›†ç¾¤æ“ä½œçš„æ—¶å€™ï¼Œå°±èŽ·å¾—äº†é›†ç¾¤çš„ä¿¡æ¯ï¼Œå¯ä»¥è¿›è¡Œé›†ç¾¤ç›¸å…³æ“ä½œã€‚åœ¨æ­¤å…ˆç®€å•ä»‹ç»ä¸‹redis-trib.rbè„šæœ¬çš„ä½¿ç”¨ï¼Œä»¥createä¸ºä¾‹ï¼š12create host1:port1 ... hostN:portN --replicas &lt;arg&gt; host1:port1 â€¦ hostN:portNè¡¨ç¤ºå­å‚æ•°ï¼Œè¿™ä¸ªå¿…é¡»åœ¨å¯é€‰å‚æ•°ä¹‹åŽï¼Œâ€“replicas æ˜¯å¯é€‰å‚æ•°ï¼Œå¸¦çš„è¡¨ç¤ºåŽé¢å¿…é¡»å¡«å†™ä¸€ä¸ªå‚æ•°ï¼Œåƒâ€“slaveè¿™æ ·ï¼ŒåŽé¢å°±ä¸å¸¦å‚æ•°ï¼ŒæŽŒæ¡äº†è¿™ä¸ªåŸºæœ¬è§„åˆ™ï¼Œå°±èƒ½ä»Žhelpå‘½ä»¤ä¸­èŽ·å¾—redis-trib.rbçš„ä½¿ç”¨æ–¹æ³•ã€‚ å…¶ä»–å‘½ä»¤å¤§éƒ½éœ€è¦ä¼ é€’host:portï¼Œè¿™æ˜¯redis-trib.rbä¸ºäº†è¿žæŽ¥é›†ç¾¤ï¼Œéœ€è¦é€‰æ‹©é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åŽé€šè¿‡è¯¥èŠ‚ç‚¹èŽ·å¾—æ•´ä¸ªé›†ç¾¤çš„ä¿¡æ¯ã€‚ ä¸‹é¢å°±ä¸€ä¸€è¯¦ç»†ä»‹ç»redis-trib.rbçš„æ¯ä¸ªåŠŸèƒ½ã€‚ createåˆ›å»ºé›†ç¾¤createå‘½ä»¤å¯é€‰replicaså‚æ•°ï¼Œreplicasè¡¨ç¤ºéœ€è¦æœ‰å‡ ä¸ªslaveã€‚æœ€ç®€å•å‘½ä»¤ä½¿ç”¨å¦‚ä¸‹ï¼š1$ruby redis-trib.rb create 10.180.157.199:6379 10.180.157.200:6379 10.180.157.201:6379 æœ‰ä¸€ä¸ªslaveçš„åˆ›å»ºå‘½ä»¤å¦‚ä¸‹ï¼š1$ruby redis-trib.rb create --replicas 1 10.180.157.199:6379 10.180.157.200:6379 10.180.157.201:6379 10.180.157.202:6379 10.180.157.205:6379 10.180.157.208:6379 åˆ›å»ºæµç¨‹å¦‚ä¸‹ï¼š1ã€é¦–å…ˆä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºClusterNodeå¯¹è±¡ï¼ŒåŒ…æ‹¬è¿žæŽ¥æ¯ä¸ªèŠ‚ç‚¹ã€‚æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºç‹¬ç«‹ä¸”dbä¸ºç©ºçš„èŠ‚ç‚¹ã€‚æ‰§è¡Œload_infoæ–¹æ³•å¯¼å…¥èŠ‚ç‚¹ä¿¡æ¯ã€‚2ã€æ£€æŸ¥ä¼ å…¥çš„masterèŠ‚ç‚¹æ•°é‡æ˜¯å¦å¤§äºŽç­‰äºŽ3ä¸ªã€‚åªæœ‰å¤§äºŽ3ä¸ªèŠ‚ç‚¹æ‰èƒ½ç»„æˆé›†ç¾¤ã€‚3ã€è®¡ç®—æ¯ä¸ªmasteréœ€è¦åˆ†é…çš„slotæ•°é‡ï¼Œä»¥åŠç»™masteråˆ†é…slaveã€‚åˆ†é…çš„ç®—æ³•å¤§è‡´å¦‚ä¸‹ï¼šå…ˆæŠŠèŠ‚ç‚¹æŒ‰ç…§hoståˆ†ç±»ï¼Œè¿™æ ·ä¿è¯masterèŠ‚ç‚¹èƒ½åˆ†é…åˆ°æ›´å¤šçš„ä¸»æœºä¸­ã€‚ä¸åœéåŽ†éåŽ†hoståˆ—è¡¨ï¼Œä»Žæ¯ä¸ªhoståˆ—è¡¨ä¸­å¼¹å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ”¾å…¥interleavedæ•°ç»„ã€‚ç›´åˆ°æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å¼¹å‡ºä¸ºæ­¢ã€‚masterèŠ‚ç‚¹åˆ—è¡¨å°±æ˜¯interleavedå‰é¢çš„masteræ•°é‡çš„èŠ‚ç‚¹åˆ—è¡¨ã€‚ä¿å­˜åœ¨mastersæ•°ç»„ã€‚è®¡ç®—æ¯ä¸ªmasterèŠ‚ç‚¹è´Ÿè´£çš„slotæ•°é‡ï¼Œä¿å­˜åœ¨slots_per_nodeå¯¹è±¡ï¼Œç”¨slotæ€»æ•°é™¤ä»¥masteræ•°é‡å–æ•´å³å¯ã€‚éåŽ†mastersæ•°ç»„ï¼Œæ¯ä¸ªmasteråˆ†é…slots_per_nodeä¸ªslotï¼Œæœ€åŽä¸€ä¸ªmasterï¼Œåˆ†é…åˆ°16384ä¸ªslotä¸ºæ­¢ã€‚æŽ¥ä¸‹æ¥ä¸ºmasteråˆ†é…slaveï¼Œåˆ†é…ç®—æ³•ä¼šå°½é‡ä¿è¯masterå’ŒslaveèŠ‚ç‚¹ä¸åœ¨åŒä¸€å°ä¸»æœºä¸Šã€‚å¯¹äºŽåˆ†é…å®ŒæŒ‡å®šslaveæ•°é‡çš„èŠ‚ç‚¹ï¼Œè¿˜æœ‰å¤šä½™çš„èŠ‚ç‚¹ï¼Œä¹Ÿä¼šä¸ºè¿™äº›èŠ‚ç‚¹å¯»æ‰¾masterã€‚åˆ†é…ç®—æ³•ä¼šéåŽ†ä¸¤æ¬¡mastersæ•°ç»„ã€‚ç¬¬ä¸€æ¬¡éåŽ†mastersæ•°ç»„ï¼Œåœ¨ä½™ä¸‹çš„èŠ‚ç‚¹åˆ—è¡¨æ‰¾åˆ°replicasæ•°é‡ä¸ªslaveã€‚æ¯ä¸ªslaveä¸ºç¬¬ä¸€ä¸ªå’ŒmasterèŠ‚ç‚¹hostä¸ä¸€æ ·çš„èŠ‚ç‚¹ï¼Œå¦‚æžœæ²¡æœ‰ä¸ä¸€æ ·çš„èŠ‚ç‚¹ï¼Œåˆ™ç›´æŽ¥å–å‡ºä½™ä¸‹åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚ç¬¬äºŒæ¬¡éåŽ†æ˜¯åœ¨å¯¹äºŽèŠ‚ç‚¹æ•°é™¤ä»¥replicasä¸ä¸ºæ•´æ•°ï¼Œåˆ™ä¼šå¤šä½™ä¸€éƒ¨åˆ†èŠ‚ç‚¹ã€‚éåŽ†çš„æ–¹å¼è·Ÿç¬¬ä¸€æ¬¡ä¸€æ ·ï¼Œåªæ˜¯ç¬¬ä¸€æ¬¡ä¼šä¸€æ¬¡æ€§ç»™masteråˆ†é…replicasæ•°é‡ä¸ªslaveï¼Œè€Œç¬¬äºŒæ¬¡éåŽ†åªåˆ†é…ä¸€ä¸ªï¼Œç›´åˆ°ä½™ä¸‹çš„èŠ‚ç‚¹è¢«å…¨éƒ¨åˆ†é…å‡ºåŽ»ã€‚4ã€æ‰“å°å‡ºåˆ†é…ä¿¡æ¯ï¼Œå¹¶æç¤ºç”¨æˆ·è¾“å…¥â€œyesâ€ç¡®è®¤æ˜¯å¦æŒ‰ç…§æ‰“å°å‡ºæ¥çš„åˆ†é…æ–¹å¼åˆ›å»ºé›†ç¾¤ã€‚5ã€è¾“å…¥â€œyesâ€åŽï¼Œä¼šæ‰§è¡Œflush_nodes_configæ“ä½œï¼Œè¯¥æ“ä½œæ‰§è¡Œå‰é¢çš„åˆ†é…ç»“æžœï¼Œç»™masteråˆ†é…slotï¼Œè®©slaveå¤åˆ¶masterï¼Œå¯¹äºŽè¿˜æ²¡æœ‰æ¡æ‰‹ï¼ˆcluster meetï¼‰çš„èŠ‚ç‚¹ï¼Œslaveå¤åˆ¶æ“ä½œæ— æ³•å®Œæˆï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œflush_nodes_configæ“ä½œå‡ºçŽ°å¼‚å¸¸ä¼šå¾ˆå¿«è¿”å›žï¼ŒåŽç»­æ¡æ‰‹åŽä¼šå†æ¬¡æ‰§è¡Œflush_nodes_configã€‚6ã€ç»™æ¯ä¸ªèŠ‚ç‚¹åˆ†é…epochï¼ŒéåŽ†èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆ†é…çš„epochæ¯”ä¹‹å‰èŠ‚ç‚¹å¤§1ã€‚7ã€èŠ‚ç‚¹é—´å¼€å§‹ç›¸äº’æ¡æ‰‹ï¼Œæ¡æ‰‹çš„æ–¹å¼ä¸ºèŠ‚ç‚¹åˆ—è¡¨çš„å…¶ä»–èŠ‚ç‚¹è·Ÿç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ¡æ‰‹ã€‚8ã€ç„¶åŽæ¯éš”1ç§’æ£€æŸ¥ä¸€æ¬¡å„ä¸ªèŠ‚ç‚¹æ˜¯å¦å·²ç»æ¶ˆæ¯åŒæ­¥å®Œæˆï¼Œä½¿ç”¨ClusterNodeçš„get_config_signatureæ–¹æ³•ï¼Œæ£€æŸ¥çš„ç®—æ³•ä¸ºèŽ·å–æ¯ä¸ªèŠ‚ç‚¹cluster nodesä¿¡æ¯ï¼ŒæŽ’åºæ¯ä¸ªèŠ‚ç‚¹ï¼Œç»„è£…æˆnode_id1:slots|node_id2:slot2|â€¦çš„å­—ç¬¦ä¸²ã€‚å¦‚æžœæ¯ä¸ªèŠ‚ç‚¹èŽ·å¾—å­—ç¬¦ä¸²éƒ½ç›¸åŒï¼Œå³è®¤ä¸ºæ¡æ‰‹æˆåŠŸã€‚9ã€æ­¤åŽä¼šå†æ‰§è¡Œä¸€æ¬¡flush_nodes_configï¼Œè¿™æ¬¡ä¸»è¦æ˜¯ä¸ºäº†å®Œæˆslaveå¤åˆ¶æ“ä½œã€‚10ã€æœ€åŽå†æ‰§è¡Œcheck_clusterï¼Œå…¨é¢æ£€æŸ¥ä¸€æ¬¡é›†ç¾¤çŠ¶æ€ã€‚åŒ…æ‹¬å’Œå‰é¢æ¡æ‰‹æ—¶æ£€æŸ¥ä¸€æ ·çš„æ–¹å¼å†æ£€æŸ¥ä¸€éã€‚ç¡®è®¤æ²¡æœ‰è¿ç§»çš„èŠ‚ç‚¹ã€‚ç¡®è®¤æ‰€æœ‰çš„slotéƒ½è¢«åˆ†é…å‡ºåŽ»äº†ã€‚11ã€è‡³æ­¤å®Œæˆäº†æ•´ä¸ªåˆ›å»ºæµç¨‹ï¼Œè¿”å›ž[OK] All 16384 slots covered.ã€‚ checkæ£€æŸ¥é›†ç¾¤æ£€æŸ¥é›†ç¾¤çŠ¶æ€çš„å‘½ä»¤ï¼Œæ²¡æœ‰å…¶ä»–å‚æ•°ï¼Œåªéœ€è¦é€‰æ‹©ä¸€ä¸ªé›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å³å¯ã€‚æ‰§è¡Œå‘½ä»¤ä»¥åŠç»“æžœå¦‚ä¸‹ï¼š123456789101112131415161718192021222324$ruby redis-trib.rb check 10.180.157.199:6379&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)M: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379 slots:0-5460 (5461 slots) master 1 additional replica(s)S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379 slots: (0 slots) slave replicates e36c46dbe90960f30861af00786d4c2064e63df2M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379 slots:10923-16383 (5461 slots) master 1 additional replica(s)S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379 slots: (0 slots) slave replicates 15126fb33796c2c26ea89e553418946f7443d5a5S: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379 slots: (0 slots) slave replicates b2506515b38e6bbd3034d540599f4cd2a5279ad1M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379 slots:5461-10922 (5462 slots) master 1 additional replica(s)[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered. æ£€æŸ¥å‰ä¼šå…ˆæ‰§è¡Œload_cluster_info_from_nodeæ–¹æ³•ï¼ŒæŠŠæ‰€æœ‰èŠ‚ç‚¹æ•°æ®loadè¿›æ¥ã€‚loadçš„æ–¹å¼ä¸ºé€šè¿‡è‡ªå·±çš„cluster nodeså‘çŽ°å…¶ä»–èŠ‚ç‚¹ï¼Œç„¶åŽè¿žæŽ¥æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥nodesæ•°ç»„ã€‚æŽ¥ç€ç”ŸæˆèŠ‚ç‚¹é—´çš„å¤åˆ¶å…³ç³»ã€‚ loadå®Œæ•°æ®åŽï¼Œå¼€å§‹æ£€æŸ¥æ•°æ®ï¼Œæ£€æŸ¥çš„æ–¹å¼ä¹Ÿæ˜¯è°ƒç”¨åˆ›å»ºæ—¶å€™ä½¿ç”¨çš„check_clusterã€‚ infoæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯infoå‘½ä»¤ç”¨æ¥æŸ¥çœ‹é›†ç¾¤çš„ä¿¡æ¯ã€‚infoå‘½ä»¤ä¹Ÿæ˜¯å…ˆæ‰§è¡Œload_cluster_info_from_nodeèŽ·å–å®Œæ•´çš„é›†ç¾¤ä¿¡æ¯ã€‚ç„¶åŽæ˜¾ç¤ºClusterNodeçš„info_stringç»“æžœï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š123456$ruby redis-trib.rb info 10.180.157.199:637910.180.157.199:6379 (b2506515...) -&gt; 0 keys | 5461 slots | 1 slaves.10.180.157.201:6379 (15126fb3...) -&gt; 0 keys | 5461 slots | 1 slaves.10.180.157.200:6379 (e36c46db...) -&gt; 0 keys | 5462 slots | 1 slaves.[OK] 0 keys in 3 masters.0.00 keys per slot on average. fixä¿®å¤é›†ç¾¤fixå‘½ä»¤çš„æµç¨‹è·Ÿcheckçš„æµç¨‹å¾ˆåƒï¼Œæ˜¾ç¤ºåŠ è½½é›†ç¾¤ä¿¡æ¯ï¼Œç„¶åŽåœ¨check_clusteræ–¹æ³•å†…ä¼ å…¥fixä¸ºtrueçš„å˜é‡ï¼Œä¼šåœ¨é›†ç¾¤æ£€æŸ¥å‡ºçŽ°å¼‚å¸¸çš„æ—¶å€™æ‰§è¡Œä¿®å¤æµç¨‹ã€‚ç›®å‰fixå‘½ä»¤èƒ½ä¿®å¤ä¸¤ç§å¼‚å¸¸ï¼Œä¸€ç§æ˜¯é›†ç¾¤æœ‰å¤„äºŽè¿ç§»ä¸­çš„slotçš„èŠ‚ç‚¹ï¼Œä¸€ç§æ˜¯slotæœªå®Œå…¨åˆ†é…çš„å¼‚å¸¸ã€‚ fix_open_slotæ–¹æ³•æ˜¯ä¿®å¤é›†ç¾¤æœ‰å¤„äºŽè¿ç§»ä¸­çš„slotçš„èŠ‚ç‚¹å¼‚å¸¸ã€‚1ã€å…ˆæ£€æŸ¥è¯¥slotæ˜¯è°è´Ÿè´£çš„ï¼Œè¿ç§»çš„æºèŠ‚ç‚¹å¦‚æžœæ²¡å®Œæˆè¿ç§»ï¼Œownerè¿˜æ˜¯è¯¥èŠ‚ç‚¹ã€‚æ²¡æœ‰ownerçš„slotæ— æ³•å®Œæˆä¿®å¤åŠŸèƒ½ã€‚2ã€éåŽ†æ¯ä¸ªèŠ‚ç‚¹ï¼ŒèŽ·å–å“ªäº›èŠ‚ç‚¹æ ‡è®°è¯¥slotä¸ºmigratingçŠ¶æ€ï¼Œå“ªäº›èŠ‚ç‚¹æ ‡è®°è¯¥slotä¸ºimportingçŠ¶æ€ã€‚å¯¹äºŽownerä¸æ˜¯è¯¥èŠ‚ç‚¹ï¼Œä½†æ˜¯é€šè¿‡cluster countkeysinslotèŽ·å–åˆ°è¯¥èŠ‚ç‚¹æœ‰æ•°æ®çš„æƒ…å†µï¼Œä¹Ÿè®¤ä¸ºè¯¥èŠ‚ç‚¹ä¸ºimportingçŠ¶æ€ã€‚3ã€å¦‚æžœmigratingå’ŒimportingçŠ¶æ€çš„èŠ‚ç‚¹å‡åªæœ‰1ä¸ªï¼Œè¿™å¯èƒ½æ˜¯è¿ç§»è¿‡ç¨‹ä¸­redis-trib.rbè¢«ä¸­æ–­æ‰€è‡´ï¼Œç›´æŽ¥æ‰§è¡Œmove_slotç»§ç»­å®Œæˆè¿ç§»ä»»åŠ¡å³å¯ã€‚ä¼ é€’dotså’Œfixä¸ºtrueã€‚4ã€å¦‚æžœmigratingä¸ºç©ºï¼ŒimportingçŠ¶æ€çš„èŠ‚ç‚¹å¤§äºŽ0ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µæ‰§è¡Œå›žæ»šæµç¨‹ï¼Œå°†importingçŠ¶æ€çš„èŠ‚ç‚¹æ•°æ®é€šè¿‡move_slotæ–¹æ³•å¯¼ç»™slotçš„ownerèŠ‚ç‚¹ï¼Œä¼ é€’dotsã€fixå’Œcoldä¸ºtrueã€‚æŽ¥ç€å¯¹importingçš„èŠ‚ç‚¹æ‰§è¡Œcluster stableå‘½ä»¤æ¢å¤ç¨³å®šã€‚5ã€å¦‚æžœimportingçŠ¶æ€çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œæœ‰ä¸€ä¸ªmigratingçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œè€Œä¸”è¯¥èŠ‚ç‚¹åœ¨å½“å‰slotæ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æŽ¥æŠŠè¿™ä¸ªslotè®¾ä¸ºstableã€‚6ã€å¦‚æžœmigratingå’ŒimportingçŠ¶æ€ä¸æ˜¯ä¸Šè¿°æƒ…å†µï¼Œç›®å‰redis-trib.rbå·¥å…·æ— æ³•ä¿®å¤ï¼Œä¸Šè¿°çš„ä¸‰ç§æƒ…å†µä¹Ÿå·²ç»è¦†ç›–äº†é€šè¿‡redis-trib.rbå·¥å…·è¿ç§»å‡ºçŽ°å¼‚å¸¸çš„å„ä¸ªæ–¹é¢ï¼Œäººä¸ºçš„å¼‚å¸¸æƒ…å½¢å¤ªå¤šï¼Œå¾ˆéš¾è€ƒè™‘å®Œå…¨ã€‚ fix_slots_coverageæ–¹æ³•èƒ½ä¿®å¤slotæœªå®Œå…¨åˆ†é…çš„å¼‚å¸¸ã€‚æœªåˆ†é…çš„slotæœ‰ä¸‰ç§çŠ¶æ€ã€‚1ã€æ‰€æœ‰èŠ‚ç‚¹çš„è¯¥slotéƒ½æ²¡æœ‰æ•°æ®ã€‚è¯¥çŠ¶æ€redis-trib.rbå·¥å…·ç›´æŽ¥é‡‡ç”¨éšæœºåˆ†é…çš„æ–¹å¼ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘èŠ‚ç‚¹çš„å‡è¡¡ã€‚æœ¬äººå°è¯•å¯¹æ²¡æœ‰åˆ†é…slotçš„é›†ç¾¤é€šè¿‡fixä¿®å¤é›†ç¾¤ï¼Œç»“æžœslotè¿˜æ˜¯èƒ½æ¯”è¾ƒå¹³å‡çš„åˆ†é…ï¼Œä½†æ˜¯æ²¡æœ‰äº†è¿žç»­æ€§ï¼Œæ‰“å°çš„slotä¿¡æ¯éžå¸¸ç¦»æ•£ã€‚2ã€æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„è¯¥slotæœ‰æ•°æ®ã€‚è¯¥çŠ¶æ€ä¸‹ï¼Œç›´æŽ¥æŠŠslotåˆ†é…ç»™è¯¥slotæœ‰æ•°æ®çš„èŠ‚ç‚¹ã€‚3ã€æœ‰å¤šä¸ªèŠ‚ç‚¹çš„è¯¥slotæœ‰æ•°æ®ã€‚æ­¤ç§æƒ…å†µç›®å‰è¿˜å¤„äºŽTODOçŠ¶æ€ï¼Œä¸è¿‡redisä½œè€…åˆ—å‡ºäº†ä¿®å¤çš„æ­¥éª¤ï¼Œå¯¹è¿™äº›èŠ‚ç‚¹ï¼Œé™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰§è¡Œcluster migratingå‘½ä»¤ï¼Œç„¶åŽæŠŠè¿™äº›èŠ‚ç‚¹çš„æ•°æ®è¿ç§»åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚æ¸…é™¤migratingçŠ¶æ€ï¼Œç„¶åŽæŠŠslotåˆ†é…ç»™ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚ reshardåœ¨çº¿è¿ç§»slotreshardå‘½ä»¤å¯ä»¥åœ¨çº¿æŠŠé›†ç¾¤çš„ä¸€äº›slotä»Žé›†ç¾¤åŽŸæ¥slotè´Ÿè´£èŠ‚ç‚¹è¿ç§»åˆ°æ–°çš„èŠ‚ç‚¹ï¼Œåˆ©ç”¨reshardå¯ä»¥å®Œæˆé›†ç¾¤çš„åœ¨çº¿æ¨ªå‘æ‰©å®¹å’Œç¼©å®¹ã€‚reshardçš„å‚æ•°å¾ˆå¤šï¼Œä¸‹é¢æ¥ä¸€ä¸€è§£é‡Šä¸€ç•ªï¼š1234567reshard host:port --from &lt;arg&gt; --to &lt;arg&gt; --slots &lt;arg&gt; --yes --timeout &lt;arg&gt; --pipeline &lt;arg&gt; host:portï¼šè¿™ä¸ªæ˜¯å¿…ä¼ å‚æ•°ï¼Œç”¨æ¥ä»Žä¸€ä¸ªèŠ‚ç‚¹èŽ·å–æ•´ä¸ªé›†ç¾¤ä¿¡æ¯ï¼Œç›¸å½“äºŽèŽ·å–é›†ç¾¤ä¿¡æ¯çš„å…¥å£ã€‚â€“from ï¼šéœ€è¦ä»Žå“ªäº›æºèŠ‚ç‚¹ä¸Šè¿ç§»slotï¼Œå¯ä»Žå¤šä¸ªæºèŠ‚ç‚¹å®Œæˆè¿ç§»ï¼Œä»¥é€—å·éš”å¼€ï¼Œä¼ é€’çš„æ˜¯èŠ‚ç‚¹çš„node idï¼Œè¿˜å¯ä»¥ç›´æŽ¥ä¼ é€’â€“from allï¼Œè¿™æ ·æºèŠ‚ç‚¹å°±æ˜¯é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¸ä¼ é€’è¯¥å‚æ•°çš„è¯ï¼Œåˆ™ä¼šåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚â€“to ï¼šslotéœ€è¦è¿ç§»çš„ç›®çš„èŠ‚ç‚¹çš„node idï¼Œç›®çš„èŠ‚ç‚¹åªèƒ½å¡«å†™ä¸€ä¸ªï¼Œä¸ä¼ é€’è¯¥å‚æ•°çš„è¯ï¼Œåˆ™ä¼šåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚â€“slots ï¼šéœ€è¦è¿ç§»çš„slotæ•°é‡ï¼Œä¸ä¼ é€’è¯¥å‚æ•°çš„è¯ï¼Œåˆ™ä¼šåœ¨è¿ç§»è¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·è¾“å…¥ã€‚â€“yesï¼šè®¾ç½®è¯¥å‚æ•°ï¼Œå¯ä»¥åœ¨æ‰“å°æ‰§è¡Œreshardè®¡åˆ’çš„æ—¶å€™ï¼Œæç¤ºç”¨æˆ·è¾“å…¥yesç¡®è®¤åŽå†æ‰§è¡Œreshardã€‚â€“timeout ï¼šè®¾ç½®migrateå‘½ä»¤çš„è¶…æ—¶æ—¶é—´ã€‚â€“pipeline ï¼šå®šä¹‰cluster getkeysinslotå‘½ä»¤ä¸€æ¬¡å–å‡ºçš„keyæ•°é‡ï¼Œä¸ä¼ çš„è¯ä½¿ç”¨é»˜è®¤å€¼ä¸º10ã€‚ è¿ç§»çš„æµç¨‹å¦‚ä¸‹ï¼š1ã€é€šè¿‡load_cluster_info_from_nodeæ–¹æ³•è£…è½½é›†ç¾¤ä¿¡æ¯ã€‚2ã€æ‰§è¡Œcheck_clusteræ–¹æ³•æ£€æŸ¥é›†ç¾¤æ˜¯å¦å¥åº·ã€‚åªæœ‰å¥åº·çš„é›†ç¾¤æ‰èƒ½è¿›è¡Œè¿ç§»ã€‚3ã€èŽ·å–éœ€è¦è¿ç§»çš„slotæ•°é‡ï¼Œç”¨æˆ·æ²¡ä¼ é€’â€“slotså‚æ•°ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ã€‚4ã€èŽ·å–è¿ç§»çš„ç›®çš„èŠ‚ç‚¹ï¼Œç”¨æˆ·æ²¡ä¼ é€’â€“toå‚æ•°ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ã€‚æ­¤å¤„ä¼šæ£€æŸ¥ç›®çš„èŠ‚ç‚¹å¿…é¡»ä¸ºmasterèŠ‚ç‚¹ã€‚5ã€èŽ·å–è¿ç§»çš„æºèŠ‚ç‚¹ï¼Œç”¨æˆ·æ²¡ä¼ é€’â€“fromå‚æ•°ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ã€‚æ­¤å¤„ä¼šæ£€æŸ¥æºèŠ‚ç‚¹å¿…é¡»ä¸ºmasterèŠ‚ç‚¹ã€‚â€“from allçš„è¯ï¼ŒæºèŠ‚ç‚¹å°±æ˜¯é™¤äº†ç›®çš„èŠ‚ç‚¹å¤–çš„å…¨éƒ¨masterèŠ‚ç‚¹ã€‚è¿™é‡Œä¸ºäº†ä¿è¯é›†ç¾¤slotåˆ†é…çš„å¹³å‡ï¼Œå»ºè®®ä¼ é€’â€“from allã€‚6ã€æ‰§è¡Œcompute_reshard_tableæ–¹æ³•ï¼Œè®¡ç®—éœ€è¦è¿ç§»çš„slotæ•°é‡å¦‚ä½•åˆ†é…åˆ°æºèŠ‚ç‚¹åˆ—è¡¨ï¼Œé‡‡ç”¨çš„ç®—æ³•æ˜¯æŒ‰ç…§èŠ‚ç‚¹è´Ÿè´£slotæ•°é‡ç”±å¤šåˆ°å°‘æŽ’åºï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹éœ€è¦è¿ç§»çš„slotçš„æ–¹æ³•ä¸ºï¼šè¿ç§»slotæ•°é‡ * (è¯¥æºèŠ‚ç‚¹è´Ÿè´£çš„slotæ•°é‡ / æºèŠ‚ç‚¹åˆ—è¡¨è´Ÿè´£çš„slotæ€»æ•°)ã€‚è¿™æ ·ç®—å‡ºçš„æ•°é‡å¯èƒ½ä¸ä¸ºæ•´æ•°ï¼Œè¿™é‡Œä»£ç ç”¨äº†ä¸‹é¢çš„æ–¹å¼å¤„ç†ï¼š12345n = (numslots/source_tot_slots*s.slots.length)if i == 0 n = n.ceilelse n = n.floor è¿™æ ·çš„å¤„ç†æ–¹å¼ä¼šå¸¦æ¥æœ€ç»ˆåˆ†é…çš„slotä¸Žè¯·æ±‚è¿ç§»çš„slotæ•°é‡ä¸ä¸€è‡´ï¼Œè¿™ä¸ªBUGå·²ç»åœ¨githubä¸Šæç»™ä½œè€…ï¼Œhttps://github.com/antirez/redis/issues/2990ã€‚7ã€æ‰“å°å‡ºreshardè®¡åˆ’ï¼Œå¦‚æžœç”¨æˆ·æ²¡ä¼ â€“yesï¼Œå°±æç¤ºç”¨æˆ·ç¡®è®¤è®¡åˆ’ã€‚8ã€æ ¹æ®reshardè®¡åˆ’ï¼Œä¸€ä¸ªä¸ªslotçš„è¿ç§»åˆ°æ–°èŠ‚ç‚¹ä¸Šï¼Œè¿ç§»ä½¿ç”¨move_slotæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¢«å¾ˆå¤šå‘½ä»¤ä½¿ç”¨ï¼Œå…·ä½“å¯ä»¥å‚è§ä¸‹é¢çš„è¿ç§»æµç¨‹ã€‚move_slotæ–¹æ³•ä¼ é€’dotsä¸ºtrueå’Œpipelineæ•°é‡ã€‚9ã€è‡³æ­¤ï¼Œå°±å®Œæˆäº†å…¨éƒ¨çš„è¿ç§»ä»»åŠ¡ã€‚ä¸‹é¢çœ‹ä¸‹ä¸€æ¬¡reshardçš„æ‰§è¡Œç»“æžœï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465$ruby redis-trib.rb reshard --from all --to 80b661ecca260c89e3d8ea9b98f77edaeef43dcd --slots 11 10.180.157.199:6379&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)S: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379 slots: (0 slots) slave replicates 460b3a11e296aafb2615043291b7dd98274bb351S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379 slots: (0 slots) slave replicates e36c46dbe90960f30861af00786d4c2064e63df2M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379 slots:10923-16383 (5461 slots) master 1 additional replica(s)S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379 slots: (0 slots) slave replicates 15126fb33796c2c26ea89e553418946f7443d5a5M: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379 slots:0-5460 (5461 slots) master 1 additional replica(s)M: 80b661ecca260c89e3d8ea9b98f77edaeef43dcd 10.180.157.200:6380 slots: (0 slots) master 0 additional replica(s)M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379 slots:5461-10922 (5462 slots) master 1 additional replica(s)[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.Ready to move 11 slots. Source nodes: M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379 slots:10923-16383 (5461 slots) master 1 additional replica(s) M: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379 slots:0-5460 (5461 slots) master 1 additional replica(s) M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379 slots:5461-10922 (5462 slots) master 1 additional replica(s) Destination node: M: 80b661ecca260c89e3d8ea9b98f77edaeef43dcd 10.180.157.200:6380 slots: (0 slots) master 0 additional replica(s) Resharding plan: Moving slot 5461 from e36c46dbe90960f30861af00786d4c2064e63df2 Moving slot 5462 from e36c46dbe90960f30861af00786d4c2064e63df2 Moving slot 5463 from e36c46dbe90960f30861af00786d4c2064e63df2 Moving slot 5464 from e36c46dbe90960f30861af00786d4c2064e63df2 Moving slot 0 from 460b3a11e296aafb2615043291b7dd98274bb351 Moving slot 1 from 460b3a11e296aafb2615043291b7dd98274bb351 Moving slot 2 from 460b3a11e296aafb2615043291b7dd98274bb351 Moving slot 10923 from 15126fb33796c2c26ea89e553418946f7443d5a5 Moving slot 10924 from 15126fb33796c2c26ea89e553418946f7443d5a5 Moving slot 10925 from 15126fb33796c2c26ea89e553418946f7443d5a5Do you want to proceed with the proposed reshard plan (yes/no)? yesMoving slot 5461 from 10.180.157.200:6379 to 10.180.157.200:6380:Moving slot 5462 from 10.180.157.200:6379 to 10.180.157.200:6380:Moving slot 5463 from 10.180.157.200:6379 to 10.180.157.200:6380:Moving slot 5464 from 10.180.157.200:6379 to 10.180.157.200:6380:Moving slot 0 from 10.180.157.202:6379 to 10.180.157.200:6380:Moving slot 1 from 10.180.157.202:6379 to 10.180.157.200:6380:Moving slot 2 from 10.180.157.202:6379 to 10.180.157.200:6380:Moving slot 10923 from 10.180.157.201:6379 to 10.180.157.200:6380:Moving slot 10924 from 10.180.157.201:6379 to 10.180.157.200:6380:Moving slot 10925 from 10.180.157.201:6379 to 10.180.157.200:6380: move_slotæ–¹æ³•å¯ä»¥åœ¨çº¿å°†ä¸€ä¸ªslotçš„å…¨éƒ¨æ•°æ®ä»ŽæºèŠ‚ç‚¹è¿ç§»åˆ°ç›®çš„èŠ‚ç‚¹ï¼Œfixã€reshardã€rebalanceéƒ½éœ€è¦è°ƒç”¨è¯¥æ–¹æ³•è¿ç§»slotã€‚move_slotæŽ¥å—ä¸‹é¢å‡ ä¸ªå‚æ•°ï¼Œ1ã€pipelineï¼šè®¾ç½®ä¸€æ¬¡ä»Žslotä¸ŠèŽ·å–å¤šå°‘ä¸ªkeyã€‚2ã€quietï¼šè¿ç§»ä¼šæ‰“å°ç›¸å…³ä¿¡æ¯ï¼Œè®¾ç½®quietå‚æ•°ï¼Œå¯ä»¥ä¸ç”¨æ‰“å°è¿™äº›ä¿¡æ¯ã€‚3ã€coldï¼šè®¾ç½®coldï¼Œä¼šå¿½ç•¥æ‰§è¡Œimportingå’Œmigratingã€‚4ã€dotsï¼šè®¾ç½®dotsï¼Œåˆ™ä¼šåœ¨è¿ç§»è¿‡ç¨‹æ‰“å°è¿ç§»keyæ•°é‡çš„è¿›åº¦ã€‚5ã€updateï¼šè®¾ç½®updateï¼Œåˆ™ä¼šæ›´æ–°å†…å­˜ä¿¡æ¯ï¼Œæ–¹ä¾¿ä»¥åŽçš„æ“ä½œã€‚ move_slotæµç¨‹å¦‚ä¸‹ï¼š1ã€å¦‚æžœæ²¡æœ‰è®¾ç½®coldï¼Œåˆ™å¯¹æºèŠ‚ç‚¹æ‰§è¡Œcluster importingå‘½ä»¤ï¼Œå¯¹ç›®çš„èŠ‚ç‚¹æ‰§è¡Œmigratingå‘½ä»¤ã€‚fixçš„æ—¶å€™æœ‰å¯èƒ½importingå’Œmigratingå·²ç»æ‰§è¡Œè¿‡æ¥ï¼Œæ‰€ä»¥æ­¤ç§åœºæ™¯ä¼šè®¾ç½®coldã€‚2ã€é€šè¿‡cluster getkeysinslotå‘½ä»¤ï¼Œä¸€æ¬¡æ€§èŽ·å–è¿œèŠ‚ç‚¹è¿ç§»slotçš„pipelineä¸ªkeyçš„æ•°é‡.3ã€å¯¹è¿™äº›keyæ‰§è¡Œmigrateå‘½ä»¤ï¼Œå°†æ•°æ®ä»ŽæºèŠ‚ç‚¹è¿ç§»åˆ°ç›®çš„èŠ‚ç‚¹ã€‚4ã€å¦‚æžœmigrateå‡ºçŽ°å¼‚å¸¸ï¼Œåœ¨fixæ¨¡å¼ä¸‹ï¼ŒBUSYKEYçš„å¼‚å¸¸ï¼Œä¼šä½¿ç”¨migrateçš„replaceæ¨¡å¼å†æ‰§è¡Œä¸€æ¬¡ï¼ŒBUSYKEYè¡¨ç¤ºç›®çš„èŠ‚ç‚¹å·²ç»æœ‰è¯¥keyäº†ï¼Œreplaceæ¨¡å¼å¯ä»¥å¼ºåˆ¶æ›¿æ¢ç›®çš„èŠ‚ç‚¹çš„keyã€‚ä¸æ˜¯fixæ¨¡å¼å°±ç›´æŽ¥è¿”å›žé”™è¯¯äº†ã€‚5ã€å¾ªçŽ¯æ‰§è¡Œcluster getkeysinslotå‘½ä»¤ï¼Œç›´åˆ°è¿”å›žçš„keyæ•°é‡ä¸º0ï¼Œå°±é€€å‡ºå¾ªçŽ¯ã€‚6ã€å¦‚æžœæ²¡æœ‰è®¾ç½®coldï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œcluster setslotå‘½ä»¤ï¼ŒæŠŠslotèµ‹ç»™ç›®çš„èŠ‚ç‚¹ã€‚7ã€å¦‚æžœè®¾ç½®updateï¼Œåˆ™ä¿®æ”¹æºèŠ‚ç‚¹å’Œç›®çš„èŠ‚ç‚¹çš„slotä¿¡æ¯ã€‚8ã€è‡³æ­¤å®Œæˆäº†è¿ç§»slotçš„æµç¨‹ã€‚ rebalanceå¹³è¡¡é›†ç¾¤èŠ‚ç‚¹slotæ•°é‡rebalanceå‘½ä»¤å¯ä»¥æ ¹æ®ç”¨æˆ·ä¼ å…¥çš„å‚æ•°å¹³è¡¡é›†ç¾¤èŠ‚ç‚¹çš„slotæ•°é‡ï¼ŒrebalanceåŠŸèƒ½éžå¸¸å¼ºå¤§ï¼Œå¯ä»¥ä¼ å…¥çš„å‚æ•°å¾ˆå¤šï¼Œä»¥ä¸‹æ˜¯rebalanceçš„å‚æ•°åˆ—è¡¨å’Œå‘½ä»¤ç¤ºä¾‹ã€‚12345678rebalance host:port --weight &lt;arg&gt; --auto-weights --threshold &lt;arg&gt; --use-empty-masters --timeout &lt;arg&gt; --simulate --pipeline &lt;arg&gt; 1$ruby redis-trib.rb rebalance --threshold 1 --weight b31e3a2e=5 --weight 60b8e3a1=5 --use-empty-masters --simulate 10.180.157.199:6379 ä¸‹é¢ä¹Ÿå…ˆä¸€ä¸€è§£é‡Šä¸‹æ¯ä¸ªå‚æ•°çš„ç”¨æ³•ï¼šhost:portï¼šè¿™ä¸ªæ˜¯å¿…ä¼ å‚æ•°ï¼Œç”¨æ¥ä»Žä¸€ä¸ªèŠ‚ç‚¹èŽ·å–æ•´ä¸ªé›†ç¾¤ä¿¡æ¯ï¼Œç›¸å½“äºŽèŽ·å–é›†ç¾¤ä¿¡æ¯çš„å…¥å£ã€‚â€“weight ï¼šèŠ‚ç‚¹çš„æƒé‡ï¼Œæ ¼å¼ä¸ºnode_id=weightï¼Œå¦‚æžœéœ€è¦ä¸ºå¤šä¸ªèŠ‚ç‚¹åˆ†é…æƒé‡çš„è¯ï¼Œéœ€è¦æ·»åŠ å¤šä¸ªâ€“weight å‚æ•°ï¼Œå³â€“weight b31e3a2e=5 â€“weight 60b8e3a1=5ï¼Œnode_idå¯ä¸ºèŠ‚ç‚¹åç§°çš„å‰ç¼€ï¼Œåªè¦ä¿è¯å‰ç¼€ä½æ•°èƒ½å”¯ä¸€åŒºåˆ†è¯¥èŠ‚ç‚¹å³å¯ã€‚æ²¡æœ‰ä¼ é€’â€“weightçš„èŠ‚ç‚¹çš„æƒé‡é»˜è®¤ä¸º1ã€‚â€“auto-weightsï¼šè¿™ä¸ªå‚æ•°åœ¨rebalanceæµç¨‹ä¸­å¹¶æœªç”¨åˆ°ã€‚â€“threshold ï¼šåªæœ‰èŠ‚ç‚¹éœ€è¦è¿ç§»çš„sloté˜ˆå€¼è¶…è¿‡thresholdï¼Œæ‰ä¼šæ‰§è¡Œrebalanceæ“ä½œã€‚å…·ä½“è®¡ç®—æ–¹æ³•å¯ä»¥å‚è€ƒä¸‹é¢çš„rebalanceå‘½ä»¤æµç¨‹çš„ç¬¬å››æ­¥ã€‚â€“use-empty-mastersï¼šrebalanceæ˜¯å¦è€ƒè™‘æ²¡æœ‰èŠ‚ç‚¹çš„masterï¼Œé»˜è®¤æ²¡æœ‰åˆ†é…slotèŠ‚ç‚¹çš„masteræ˜¯ä¸å‚ä¸Žrebalanceçš„ï¼Œè®¾ç½®â€“use-empty-masterså¯ä»¥è®©æ²¡æœ‰åˆ†é…slotçš„èŠ‚ç‚¹å‚ä¸Žrebalanceã€‚â€“timeout ï¼šè®¾ç½®migrateå‘½ä»¤çš„è¶…æ—¶æ—¶é—´ã€‚â€“simulateï¼šè®¾ç½®è¯¥å‚æ•°ï¼Œå¯ä»¥æ¨¡æ‹Ÿrebalanceæ“ä½œï¼Œæç¤ºç”¨æˆ·ä¼šè¿ç§»å“ªäº›slotsï¼Œè€Œä¸ä¼šçœŸæ­£æ‰§è¡Œè¿ç§»æ“ä½œã€‚â€“pipeline ï¼šä¸Žresharçš„pipelineå‚æ•°ä¸€æ ·ï¼Œå®šä¹‰cluster getkeysinslotå‘½ä»¤ä¸€æ¬¡å–å‡ºçš„keyæ•°é‡ï¼Œä¸ä¼ çš„è¯ä½¿ç”¨é»˜è®¤å€¼ä¸º10ã€‚ rebalanceå‘½ä»¤æµç¨‹å¦‚ä¸‹ï¼š1ã€load_cluster_info_from_nodeæ–¹æ³•å…ˆåŠ è½½é›†ç¾¤ä¿¡æ¯ã€‚2ã€è®¡ç®—æ¯ä¸ªmasterçš„æƒé‡ï¼Œæ ¹æ®å‚æ•°â€“weight ï¼Œä¸ºæ¯ä¸ªè®¾ç½®çš„èŠ‚ç‚¹åˆ†é…æƒé‡ï¼Œæ²¡æœ‰è®¾ç½®çš„èŠ‚ç‚¹ï¼Œåˆ™æƒé‡é»˜è®¤ä¸º1ã€‚3ã€æ ¹æ®æ¯ä¸ªmasterçš„æƒé‡ï¼Œä»¥åŠæ€»çš„æƒé‡ï¼Œè®¡ç®—è‡ªå·±æœŸæœ›è¢«åˆ†é…å¤šå°‘ä¸ªslotã€‚è®¡ç®—çš„æ–¹å¼ä¸ºï¼šæ€»slotæ•°é‡ ï¼ˆè‡ªå·±çš„æƒé‡ / æ€»æƒé‡ï¼‰ã€‚4ã€è®¡ç®—æ¯ä¸ªmasteræœŸæœ›åˆ†é…çš„slotæ˜¯å¦è¶…è¿‡è®¾ç½®çš„é˜ˆå€¼ï¼Œå³â€“threshold è®¾ç½®çš„é˜ˆå€¼æˆ–è€…é»˜è®¤çš„é˜ˆå€¼ã€‚è®¡ç®—çš„æ–¹å¼ä¸ºï¼šå…ˆè®¡ç®—æœŸæœ›ç§»åŠ¨èŠ‚ç‚¹çš„é˜ˆå€¼ï¼Œç®—æ³•ä¸ºï¼š(100-(100.0expected/n.slots.length)).absï¼Œå¦‚æžœè®¡ç®—å‡ºçš„é˜ˆå€¼æ²¡æœ‰è¶…å‡ºè®¾ç½®é˜ˆå€¼ï¼Œåˆ™ä¸éœ€è¦ä¸ºè¯¥èŠ‚ç‚¹ç§»åŠ¨slotã€‚åªè¦æœ‰ä¸€ä¸ªmasterçš„ç§»åŠ¨èŠ‚ç‚¹è¶…è¿‡é˜ˆå€¼ï¼Œå°±ä¼šè§¦å‘rebalanceæ“ä½œã€‚5ã€å¦‚æžœè§¦å‘äº†rebalanceæ“ä½œã€‚é‚£ä¹ˆå°±å¼€å§‹æ‰§è¡Œrebalanceæ“ä½œï¼Œå…ˆå°†æ¯ä¸ªèŠ‚ç‚¹å½“å‰åˆ†é…çš„slotsæ•°é‡å‡åŽ»æœŸæœ›åˆ†é…çš„slotæ•°é‡èŽ·å¾—balanceå€¼ã€‚å°†æ¯ä¸ªèŠ‚ç‚¹çš„balanceä»Žå°åˆ°å¤§è¿›è¡ŒæŽ’åºèŽ·å¾—snæ•°ç»„ã€‚6ã€ç”¨dst_idxå’Œsrc_idxæ¸¸æ ‡åˆ†åˆ«ä»Žsnæ•°ç»„çš„å¤´éƒ¨å’Œå°¾éƒ¨å¼€å§‹éåŽ†ã€‚ç›®çš„æ˜¯ä¸ºäº†æŠŠå°¾éƒ¨èŠ‚ç‚¹çš„slotåˆ†é…ç»™å¤´éƒ¨èŠ‚ç‚¹ã€‚ snæ•°ç»„ä¿å­˜çš„balanceåˆ—è¡¨æŽ’åºåŽï¼Œè´Ÿæ•°åœ¨å‰é¢ï¼Œæ­£æ•°åœ¨åŽé¢ã€‚è´Ÿæ•°è¡¨ç¤ºéœ€è¦æœ‰slotè¿å…¥ï¼Œæ‰€ä»¥ä½¿ç”¨dst_idxæ¸¸æ ‡ï¼Œæ­£æ•°è¡¨ç¤ºéœ€è¦æœ‰slotè¿å‡ºï¼Œæ‰€ä»¥ä½¿ç”¨src_idxæ¸¸æ ‡ã€‚ç†è®ºä¸Šsnæ•°ç»„å„èŠ‚ç‚¹çš„balanceå€¼åŠ èµ·æ¥åº”è¯¥ä¸º0ï¼Œä¸è¿‡ç”±äºŽåœ¨è®¡ç®—æœŸæœ›åˆ†é…çš„slotçš„æ—¶å€™åªæ˜¯ä½¿ç”¨ç›´æŽ¥å–æ•´çš„æ–¹å¼ï¼Œæ‰€ä»¥å¯èƒ½å‡ºçŽ°balanceå€¼ä¹‹å’Œä¸ä¸º0çš„æƒ…å†µï¼Œbalanceå€¼ä¹‹å’Œä¸ä¸º0å³ä¸ºèŠ‚ç‚¹ä¸å¹³è¡¡çš„slotæ•°é‡ï¼Œç”±äºŽslotæ€»æ•°æœ‰16384ä¸ªï¼Œä¸å¹³è¡¡æ•°é‡ç›¸å¯¹äºŽæ€»æ•°ï¼ŒåŸºæ•°å¾ˆå°ï¼Œæ‰€ä»¥å¯¹rebalanceæµç¨‹å½±å“ä¸å¤§ã€‚ 7ã€èŽ·å–sn[dst_idx]å’Œsn[src_idx]çš„balanceå€¼è¾ƒå°çš„é‚£ä¸ªå€¼ï¼Œè¯¥å€¼å³ä¸ºéœ€è¦ä»Žsn[src_idx]èŠ‚ç‚¹è¿ç§»åˆ°sn[dst_idx]èŠ‚ç‚¹çš„slotæ•°é‡ã€‚8ã€æŽ¥ç€é€šè¿‡compute_reshard_tableæ–¹æ³•è®¡ç®—æºèŠ‚ç‚¹çš„slotå¦‚ä½•åˆ†é…åˆ°æºèŠ‚ç‚¹åˆ—è¡¨ã€‚è¿™ä¸ªæ–¹æ³•åœ¨reshardæµç¨‹ä¸­ä¹Ÿæœ‰è°ƒç”¨ï¼Œå…·ä½“æ­¥éª¤å¯ä»¥å‚è€ƒreshardæµç¨‹çš„ç¬¬å…­æ­¥ã€‚9ã€å¦‚æžœæ˜¯simulateæ¨¡å¼ï¼Œåˆ™åªæ˜¯æ‰“å°å‡ºè¿ç§»åˆ—è¡¨ã€‚10ã€å¦‚æžœæ²¡æœ‰è®¾ç½®simulateï¼Œåˆ™æ‰§è¡Œmove_slotæ“ä½œï¼Œè¿ç§»slotï¼Œä¼ å…¥çš„å‚æ•°ä¸º:quiet=&gt;true,:dots=&gt;false,:update=&gt;trueã€‚11ã€è¿ç§»å®ŒæˆåŽæ›´æ–°sn[dst_idx]å’Œsn[src_idx]çš„balanceå€¼ã€‚å¦‚æžœbalanceå€¼ä¸º0åŽï¼Œæ¸¸æ ‡å‘å‰è¿›1ã€‚12ã€ç›´åˆ°dst_idxåˆ°è¾¾src_idxæ¸¸æ ‡ï¼Œå®Œæˆæ•´ä¸ªrebalanceæ“ä½œã€‚ add-nodeå°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤add-nodeå‘½ä»¤å¯ä»¥å°†æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼ŒèŠ‚ç‚¹å¯ä»¥ä¸ºmasterï¼Œä¹Ÿå¯ä»¥ä¸ºæŸä¸ªmasterèŠ‚ç‚¹çš„slaveã€‚123add-node new_host:new_port existing_host:existing_port --slave --master-id &lt;arg&gt; add-nodeæœ‰ä¸¤ä¸ªå¯é€‰å‚æ•°ï¼šâ€“slaveï¼šè®¾ç½®è¯¥å‚æ•°ï¼Œåˆ™æ–°èŠ‚ç‚¹ä»¥slaveçš„è§’è‰²åŠ å…¥é›†ç¾¤â€“master-idï¼šè¿™ä¸ªå‚æ•°éœ€è¦è®¾ç½®äº†â€“slaveæ‰èƒ½ç”Ÿæ•ˆï¼Œâ€“master-idç”¨æ¥æŒ‡å®šæ–°èŠ‚ç‚¹çš„masterèŠ‚ç‚¹ã€‚å¦‚æžœä¸è®¾ç½®è¯¥å‚æ•°ï¼Œåˆ™ä¼šéšæœºä¸ºèŠ‚ç‚¹é€‰æ‹©masterèŠ‚ç‚¹ã€‚å¯ä»¥çœ‹ä¸‹add-nodeå‘½ä»¤çš„æ‰§è¡Œç¤ºä¾‹ï¼š1234567891011121314151617181920$ruby redis-trib.rb add-node --slave --master-id dcb792b3e85726f012e83061bf237072dfc45f99 10.180.157.202:6379 10.180.157.199:6379&gt;&gt;&gt; Adding node 10.180.157.202:6379 to cluster 10.180.157.199:6379&gt;&gt;&gt; Performing Cluster Check (using node 10.180.157.199:6379)M: dcb792b3e85726f012e83061bf237072dfc45f99 10.180.157.199:6379 slots:0-5460 (5461 slots) master 0 additional replica(s)M: 464d740bf48953ebcf826f4113c86f9db3a9baf3 10.180.157.201:6379 slots:10923-16383 (5461 slots) master 0 additional replica(s)M: befa7e17b4e5f239e519bc74bfef3264a40f96ae 10.180.157.200:6379 slots:5461-10922 (5462 slots) master 0 additional replica(s)[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.&gt;&gt;&gt; Send CLUSTER MEET to node 10.180.157.202:6379 to make it join the cluster.Waiting for the cluster to join.&gt;&gt;&gt; Configure node as replica of 10.180.157.199:6379.[OK] New node added correctly. add-nodeæµç¨‹å¦‚ä¸‹ï¼š1ã€é€šè¿‡load_cluster_info_from_nodeæ–¹æ³•è½¬è½½é›†ç¾¤ä¿¡æ¯ï¼Œcheck_clusteræ–¹æ³•æ£€æŸ¥é›†ç¾¤æ˜¯å¦å¥åº·ã€‚2ã€å¦‚æžœè®¾ç½®äº†â€“slaveï¼Œåˆ™éœ€è¦ä¸ºè¯¥èŠ‚ç‚¹å¯»æ‰¾masterèŠ‚ç‚¹ã€‚è®¾ç½®äº†â€“master-idï¼Œåˆ™ä»¥è¯¥èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹çš„masterï¼Œå¦‚æžœæ²¡æœ‰è®¾ç½®â€“master-idï¼Œåˆ™è°ƒç”¨get_master_with_least_replicasæ–¹æ³•ï¼Œå¯»æ‰¾slaveæ•°é‡æœ€å°‘çš„masterèŠ‚ç‚¹ã€‚å¦‚æžœslaveæ•°é‡ä¸€è‡´ï¼Œåˆ™é€‰å–load_cluster_info_from_nodeé¡ºåºå‘çŽ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚load_cluster_info_from_nodeé¡ºåºçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯add-nodeè®¾ç½®çš„existing_host:existing_portèŠ‚ç‚¹ï¼ŒåŽé¢çš„é¡ºåºæ ¹æ®åœ¨è¯¥èŠ‚ç‚¹æ‰§è¡Œcluster nodesè¿”å›žçš„ç»“æžœè¿”å›žçš„èŠ‚ç‚¹é¡ºåºã€‚3ã€è¿žæŽ¥æ–°çš„èŠ‚ç‚¹å¹¶ä¸Žé›†ç¾¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ¡æ‰‹ã€‚4ã€å¦‚æžœæ²¡è®¾ç½®â€“slaveå°±ç›´æŽ¥è¿”å›žokï¼Œè®¾ç½®äº†â€“slaveï¼Œåˆ™éœ€è¦ç­‰å¾…ç¡®è®¤æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œç„¶åŽæ‰§è¡Œcluster replicateå‘½ä»¤å¤åˆ¶masterèŠ‚ç‚¹ã€‚5ã€è‡³æ­¤ï¼Œå®Œæˆäº†å…¨éƒ¨çš„å¢žåŠ èŠ‚ç‚¹çš„æµç¨‹ã€‚ del-nodeä»Žé›†ç¾¤ä¸­åˆ é™¤èŠ‚ç‚¹del-nodeå¯ä»¥æŠŠæŸä¸ªèŠ‚ç‚¹ä»Žé›†ç¾¤ä¸­åˆ é™¤ã€‚del-nodeåªèƒ½åˆ é™¤æ²¡æœ‰åˆ†é…slotçš„èŠ‚ç‚¹ã€‚åˆ é™¤å‘½ä»¤ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼šhost:portï¼šä»Žè¯¥èŠ‚ç‚¹èŽ·å–é›†ç¾¤ä¿¡æ¯ã€‚node_idï¼šéœ€è¦åˆ é™¤çš„èŠ‚ç‚¹idã€‚del-nodeæ‰§è¡Œç»“æžœç¤ºä¾‹å¦‚ä¸‹ï¼š1234$ruby redis-trib.rb del-node 10.180.157.199:6379 d5f6d1d17426bd564a6e309f32d0f5b96962fe53&gt;&gt;&gt; Removing node d5f6d1d17426bd564a6e309f32d0f5b96962fe53 from cluster 10.180.157.199:6379&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...&gt;&gt;&gt; SHUTDOWN the node. del-nodeæµç¨‹å¦‚ä¸‹ï¼š1ã€é€šè¿‡load_cluster_info_from_nodeæ–¹æ³•è½¬è½½é›†ç¾¤ä¿¡æ¯ã€‚2ã€æ ¹æ®ä¼ å…¥çš„node idèŽ·å–èŠ‚ç‚¹ï¼Œå¦‚æžœèŠ‚ç‚¹æ²¡æ‰¾åˆ°ï¼Œåˆ™ç›´æŽ¥æç¤ºé”™è¯¯å¹¶é€€å‡ºã€‚3ã€å¦‚æžœèŠ‚ç‚¹åˆ†é…çš„slotä¸ä¸ºç©ºï¼Œåˆ™ç›´æŽ¥æç¤ºé”™è¯¯å¹¶é€€å‡ºã€‚4ã€éåŽ†é›†ç¾¤å†…çš„å…¶ä»–èŠ‚ç‚¹ï¼Œæ‰§è¡Œcluster forgetå‘½ä»¤ï¼Œä»Žæ¯ä¸ªèŠ‚ç‚¹ä¸­åŽ»é™¤è¯¥èŠ‚ç‚¹ã€‚å¦‚æžœåˆ é™¤çš„èŠ‚ç‚¹æ˜¯masterï¼Œè€Œä¸”å®ƒæœ‰slaveçš„è¯ï¼Œè¿™äº›slaveä¼šåŽ»å¤åˆ¶å…¶ä»–masterï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯get_master_with_least_replicasï¼Œä¸Žadd-nodeæ²¡è®¾ç½®â€“master-idå¯»æ‰¾masterçš„æ–¹æ³•ä¸€æ ·ã€‚5ã€ç„¶åŽå…³é—­è¯¥èŠ‚ç‚¹ set-timeoutè®¾ç½®é›†ç¾¤èŠ‚ç‚¹é—´å¿ƒè·³è¿žæŽ¥çš„è¶…æ—¶æ—¶é—´set-timeoutç”¨æ¥è®¾ç½®é›†ç¾¤èŠ‚ç‚¹é—´å¿ƒè·³è¿žæŽ¥çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œä¸å¾—å°äºŽ100æ¯«ç§’ï¼Œå› ä¸º100æ¯«ç§’å¯¹äºŽå¿ƒè·³æ—¶é—´æ¥è¯´å¤ªçŸ­äº†ã€‚è¯¥å‘½ä»¤ä¿®æ”¹æ˜¯èŠ‚ç‚¹é…ç½®å‚æ•°cluster-node-timeoutï¼Œé»˜è®¤æ˜¯15000æ¯«ç§’ã€‚é€šè¿‡è¯¥å‘½ä»¤ï¼Œå¯ä»¥ç»™æ¯ä¸ªèŠ‚ç‚¹è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè®¾ç½®çš„æ–¹å¼ä½¿ç”¨config setå‘½ä»¤åŠ¨æ€è®¾ç½®ï¼Œç„¶åŽæ‰§è¡Œconfig rewriteå‘½ä»¤å°†é…ç½®æŒä¹…åŒ–ä¿å­˜åˆ°ç¡¬ç›˜ã€‚ä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š12345678ruby redis-trib.rb set-timeout 10.180.157.199:6379 30000&gt;&gt;&gt; Reconfiguring node timeout in every cluster node...*** New timeout set for 10.180.157.199:6379*** New timeout set for 10.180.157.205:6379*** New timeout set for 10.180.157.201:6379*** New timeout set for 10.180.157.200:6379*** New timeout set for 10.180.157.208:6379&gt;&gt;&gt; New node timeout set. 5 OK, 0 ERR. callåœ¨é›†ç¾¤å…¨éƒ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤callå‘½ä»¤å¯ä»¥ç”¨æ¥åœ¨é›†ç¾¤çš„å…¨éƒ¨èŠ‚ç‚¹æ‰§è¡Œç›¸åŒçš„å‘½ä»¤ã€‚callå‘½ä»¤ä¹Ÿæ˜¯éœ€è¦é€šè¿‡é›†ç¾¤çš„ä¸€ä¸ªèŠ‚ç‚¹åœ°å€ï¼Œè¿žä¸Šæ•´ä¸ªé›†ç¾¤ï¼Œç„¶åŽåœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œè¯¥å‘½ä»¤ã€‚1234567$ruby redis-trib.rb call 10.180.157.199:6379 get key&gt;&gt;&gt; Calling GET key10.180.157.199:6379: MOVED 12539 10.180.157.201:637910.180.157.205:6379: MOVED 12539 10.180.157.201:637910.180.157.201:6379:10.180.157.200:6379: MOVED 12539 10.180.157.201:637910.180.157.208:6379: MOVED 12539 10.180.157.201:6379 importå°†å¤–éƒ¨redisæ•°æ®å¯¼å…¥é›†ç¾¤importå‘½ä»¤å¯ä»¥æŠŠå¤–éƒ¨çš„redisèŠ‚ç‚¹æ•°æ®å¯¼å…¥é›†ç¾¤ã€‚å¯¼å…¥çš„æµç¨‹å¦‚ä¸‹ï¼š1ã€é€šè¿‡load_cluster_info_from_nodeæ–¹æ³•è½¬è½½é›†ç¾¤ä¿¡æ¯ï¼Œcheck_clusteræ–¹æ³•æ£€æŸ¥é›†ç¾¤æ˜¯å¦å¥åº·ã€‚2ã€è¿žæŽ¥å¤–éƒ¨redisèŠ‚ç‚¹ï¼Œå¦‚æžœå¤–éƒ¨èŠ‚ç‚¹å¼€å¯äº†cluster_enabledï¼Œåˆ™æç¤ºé”™è¯¯ã€‚3ã€é€šè¿‡scanå‘½ä»¤éåŽ†å¤–éƒ¨èŠ‚ç‚¹ï¼Œä¸€æ¬¡èŽ·å–1000æ¡æ•°æ®ã€‚4ã€éåŽ†è¿™äº›keyï¼Œè®¡ç®—å‡ºkeyå¯¹åº”çš„slotã€‚5ã€æ‰§è¡Œmigrateå‘½ä»¤,æºèŠ‚ç‚¹æ˜¯å¤–éƒ¨èŠ‚ç‚¹,ç›®çš„èŠ‚ç‚¹æ˜¯é›†ç¾¤slotå¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æžœè®¾ç½®äº†â€“copyå‚æ•°ï¼Œåˆ™ä¼ é€’copyå‚æ•°ï¼Œå¦‚æžœè®¾ç½®äº†â€“replaceï¼Œåˆ™ä¼ é€’replaceå‚æ•°ã€‚6ã€ä¸åœæ‰§è¡Œscanå‘½ä»¤ï¼Œç›´åˆ°éåŽ†å®Œå…¨éƒ¨çš„keyã€‚7ã€è‡³æ­¤å®Œæˆæ•´ä¸ªè¿ç§»æµç¨‹è¿™ä¸­é—´å¦‚æžœå‡ºçŽ°å¼‚å¸¸ï¼Œç¨‹åºå°±ä¼šåœæ­¢ã€‚æ²¡ä½¿ç”¨â€“copyæ¨¡å¼ï¼Œåˆ™å¯ä»¥é‡æ–°æ‰§è¡Œimportå‘½ä»¤ï¼Œä½¿ç”¨â€“copyçš„è¯ï¼Œæœ€å¥½æ¸…ç©ºæ–°çš„é›†ç¾¤å†å¯¼å…¥ä¸€æ¬¡ã€‚ importå‘½ä»¤æ›´é€‚åˆç¦»çº¿çš„æŠŠå¤–éƒ¨Redisæ•°æ®å¯¼å…¥ï¼Œåœ¨çº¿å¯¼å…¥çš„è¯æœ€å¥½ä½¿ç”¨æ›´ä¸“ä¸šçš„å¯¼å…¥å·¥å…·ï¼Œä»¥slaveçš„æ–¹å¼è¿žæŽ¥redisèŠ‚ç‚¹åŽ»åŒæ­¥èŠ‚ç‚¹æ•°æ®åº”è¯¥æ˜¯æ›´å¥½çš„æ–¹å¼ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­12./redis-trib.rb import --from 10.0.10.1:6379 10.10.10.1:7000ä¸Šé¢çš„å‘½ä»¤æ˜¯æŠŠ 10.0.10.1:6379ï¼ˆredis 2.8ï¼‰ä¸Šçš„æ•°æ®å¯¼å…¥åˆ° 10.10.10.1:7000è¿™ä¸ªèŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤ åŽŸæ–‡åœ°å€http://blog.csdn.net/huwei2003/article/details/50973967]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JVMç›‘æŽ§ä¸Žè°ƒä¼˜]]></title>
    <url>%2F2015%2F09%2F12%2Fjava-jvm-monitor-optimization%2F</url>
    <content type="text"><![CDATA[JVMç›‘æŽ§ä¸Žè°ƒä¼˜ä¸»è¦çš„ç€çœ¼ç‚¹åœ¨äºŽå¦‚ä½•é…ç½®ã€å¦‚ä½•ç›‘æŽ§ã€å¦‚ä½•ä¼˜åŒ–3ç‚¹ä¸Šã€‚ä¸‹é¢å°±å°†é’ˆå¯¹è¿™3ç‚¹è¿›è¡Œå­¦ä¹  å‚æ•°è®¾ç½®åœ¨Javaè™šæ‹Ÿæœºçš„å‚æ•°ä¸­ï¼Œæœ‰3ç§è¡¨ç¤ºæ–¹æ³•,ç”¨ps -ef |grep javaå‘½ä»¤ï¼Œå¯ä»¥å¾—åˆ°å½“å‰Javaè¿›ç¨‹çš„æ‰€æœ‰å¯åŠ¨å‚æ•°å’Œé…ç½®å‚æ•°ï¼š æ ‡å‡†å‚æ•°ï¼ˆ-ï¼‰ï¼Œæ‰€æœ‰çš„JVMå®žçŽ°éƒ½å¿…é¡»å®žçŽ°è¿™äº›å‚æ•°çš„åŠŸèƒ½ï¼Œè€Œä¸”å‘åŽå…¼å®¹ï¼› éžæ ‡å‡†å‚æ•°ï¼ˆ-Xï¼‰ï¼Œé»˜è®¤jvmå®žçŽ°è¿™äº›å‚æ•°çš„åŠŸèƒ½ï¼Œä½†æ˜¯å¹¶ä¸ä¿è¯æ‰€æœ‰jvmå®žçŽ°éƒ½æ»¡è¶³ï¼Œä¸”ä¸ä¿è¯å‘åŽå…¼å®¹ï¼› éžStableå‚æ•°ï¼ˆ-XXï¼‰ï¼Œæ­¤ç±»å‚æ•°å„ä¸ªjvmå®žçŽ°ä¼šæœ‰æ‰€ä¸åŒï¼Œå°†æ¥å¯èƒ½ä¼šéšæ—¶å–æ¶ˆï¼Œéœ€è¦æ…Žé‡ä½¿ç”¨ï¼ˆä½†æ˜¯ï¼Œè¿™äº›å‚æ•°å¾€å¾€æ˜¯éžå¸¸æœ‰ç”¨çš„ï¼‰; æ ‡å‡†å‚æ•°å…¶å®žæ ‡å‡†å‚æ•°æ˜¯ç”¨è¿‡Javaçš„äººéƒ½æœ€ç†Ÿæ‚‰çš„ï¼Œå°±æ˜¯ä½ åœ¨è¿è¡Œjavaå‘½ä»¤æ—¶åŽé¢åŠ ä¸Šçš„å‚æ•°ï¼Œå¦‚java -version, java -jar ç­‰ï¼Œè¾“å…¥å‘½ä»¤java -helpæˆ–java -?å°±èƒ½èŽ·å¾—å½“å‰æœºå™¨æ‰€æœ‰javaçš„æ ‡å‡†å‚æ•°åˆ—è¡¨ã€‚-clientè®¾ç½®jvmä½¿ç”¨clientæ¨¡å¼ï¼Œè¿™æ˜¯ä¸€èˆ¬åœ¨pcæœºå™¨ä¸Šä½¿ç”¨çš„æ¨¡å¼ï¼Œå¯åŠ¨å¾ˆå¿«ï¼Œä½†æ€§èƒ½å’Œå†…å­˜ç®¡ç†æ•ˆçŽ‡å¹¶ä¸é«˜ï¼›å¤šç”¨äºŽæ¡Œé¢åº”ç”¨ï¼›-serverä½¿ç”¨serveræ¨¡å¼ï¼Œå¯åŠ¨é€Ÿåº¦è™½ç„¶æ…¢ï¼ˆæ¯”clientæ¨¡å¼æ…¢10%å·¦å³ï¼‰ï¼Œä½†æ˜¯æ€§èƒ½å’Œå†…å­˜ç®¡ç†æ•ˆçŽ‡å¾ˆé«˜ï¼Œé€‚ç”¨äºŽæœåŠ¡å™¨ï¼Œç”¨äºŽç”ŸæˆçŽ¯å¢ƒã€å¼€å‘çŽ¯å¢ƒæˆ–æµ‹è¯•çŽ¯å¢ƒçš„æœåŠ¡ç«¯ï¼›å¦‚æžœæ²¡æœ‰æŒ‡å®š-serveræˆ–-clientï¼ŒJVMå¯åŠ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨æ£€æµ‹å½“å‰ä¸»æœºæ˜¯å¦ä¸ºæœåŠ¡å™¨ï¼Œå¦‚æžœæ˜¯å°±ä»¥serveræ¨¡å¼å¯åŠ¨ï¼Œ64ä½çš„JVMåªæœ‰serveræ¨¡å¼ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨-clientå‚æ•°ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸åŒçš„å¯åŠ¨æ¨¡å¼ï¼Œæ‰§è¡ŒGCçš„æ–¹å¼æœ‰æ‰€åŒºåˆ«ï¼š å¯åŠ¨æ¨¡å¼ æ–°ç”Ÿä»£GCæ–¹å¼ æ—§ç”Ÿä»£å’ŒæŒä¹…ä»£GCçš„æ–¹å¼ client ä¸²è¡Œ ä¸²è¡Œ server å¹¶è¡Œ å¹¶å‘ å¦‚æžœæ²¡æœ‰æŒ‡å®š-serveræˆ–-clientæ¨¡å¼ï¼Œåˆ™åˆ¤æ–­æ–¹æ³•å¦‚ä¸‹ï¼š-classpath / -cpJVMåŠ è½½å’Œæœç´¢æ–‡ä»¶çš„ç›®å½•è·¯å¾„ï¼Œå¤šä¸ªè·¯å¾„ç”¨;åˆ†éš”ã€‚æ³¨æ„ï¼Œå¦‚æžœä½¿ç”¨äº†-classpathï¼ŒJVMå°±ä¸ä¼šå†æœç´¢çŽ¯å¢ƒå˜é‡ä¸­å®šä¹‰çš„CLASSPATHè·¯å¾„ã€‚JVMæœç´¢è·¯å¾„çš„é¡ºåºä¸ºï¼š1.å…ˆæœç´¢JVMè‡ªå¸¦çš„jaræˆ–zipåŒ…ï¼ˆBootstratï¼Œæœç´¢è·¯å¾„å¯ä»¥ç”¨System.getProperty(â€œsun.boot.class.pathâ€)èŽ·å¾—ï¼‰ï¼›2.æœç´¢JRE_HOME/lib/extä¸‹çš„jaråŒ…ï¼ˆExtensionï¼Œæœç´¢è·¯å¾„å¯ä»¥ç”¨System.getProperty(â€œjava.ext.dirsâ€)èŽ·å¾—ï¼‰ï¼›3.æœç´¢ç”¨æˆ·è‡ªå®šä¹‰ç›®å½•ï¼Œé¡ºåºä¸ºï¼šå½“å‰ç›®å½•ï¼ˆ.ï¼‰ï¼ŒCLASSPATHï¼Œ-cpï¼›ï¼ˆæœç´¢è·¯å¾„ç”¨System.getProperty(â€œjava.class.pathâ€)èŽ·å¾—ï¼‰ -DpropertyName=valueå®šä¹‰ç³»ç»Ÿçš„å…¨å±€å±žæ€§å€¼ï¼Œå¦‚é…ç½®æ–‡ä»¶åœ°å€ç­‰ï¼Œå¦‚æžœvalueæœ‰ç©ºæ ¼ï¼Œå¯ä»¥ç”¨-Dname=â€space stringâ€è¿™æ ·çš„å½¢å¼æ¥å®šä¹‰ï¼Œç”¨System.getProperty(â€œpropertyNameâ€)å¯ä»¥èŽ·å¾—è¿™äº›å®šä¹‰çš„å±žæ€§å€¼ï¼Œåœ¨ä»£ç ä¸­ä¹Ÿå¯ä»¥ç”¨System.setProperty(â€œpropertyNameâ€,â€valueâ€)çš„å½¢å¼æ¥å®šä¹‰å±žæ€§ã€‚ -verboseè¿™æ˜¯æŸ¥è¯¢GCé—®é¢˜æœ€å¸¸ç”¨çš„å‘½ä»¤ä¹‹ä¸€ï¼Œå…·ä½“å‚æ•°å¦‚ï¼š-verbose:class è¾“å‡ºjvmè½½å…¥ç±»çš„ç›¸å…³ä¿¡æ¯ï¼Œå½“jvmæŠ¥å‘Šè¯´æ‰¾ä¸åˆ°ç±»æˆ–è€…ç±»å†²çªæ—¶å¯æ­¤è¿›è¡Œè¯Šæ–­ã€‚-verbose:gc è¾“å‡ºæ¯æ¬¡GCçš„ç›¸å…³æƒ…å†µï¼ŒåŽé¢ä¼šæœ‰æ›´è¯¦ç»†çš„ä»‹ç»ã€‚-verbose:jni è¾“å‡ºnativeæ–¹æ³•è°ƒç”¨çš„ç›¸å…³æƒ…å†µï¼Œä¸€èˆ¬ç”¨äºŽè¯Šæ–­jniè°ƒç”¨é”™è¯¯ä¿¡æ¯ã€‚ éžæ ‡å‡†å‚æ•°éžæ ‡å‡†å‚æ•°ï¼Œæ˜¯åœ¨æ ‡å‡†å‚æ•°çš„åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•çš„å‚æ•°ï¼Œè¾“å…¥java -Xå‘½ä»¤ï¼Œèƒ½å¤ŸèŽ·å¾—å½“å‰JVMæ”¯æŒçš„æ‰€æœ‰éžæ ‡å‡†å‚æ•°åˆ—è¡¨ï¼ˆä½ ä¼šå‘çŽ°ï¼Œå…¶å®žå¹¶ä¸å¤šå“¦ï¼‰ã€‚åœ¨ä¸åŒç±»åž‹çš„JVMä¸­ï¼Œé‡‡ç”¨çš„å‚æ•°æœ‰æ‰€ä¸åŒï¼Œåœ¨è®²è§£éžæ ‡å‡†å‚æ•°æ—¶ï¼Œè¯·å‚è€ƒä¸‹é¢çš„å›¾ï¼Œå¯¹å†…å­˜åŒºåŸŸçš„å¤§å°æœ‰ä¸ªå½¢è±¡çš„äº†è§£-Xmnæ–°ç”Ÿä»£å†…å­˜å¤§å°çš„æœ€å¤§å€¼ï¼ŒåŒ…æ‹¬EåŒºå’Œä¸¤ä¸ªSåŒºçš„æ€»å’Œï¼Œä½¿ç”¨æ–¹æ³•å¦‚ï¼š-Xmn65535ï¼Œ-Xmn1024kï¼Œ-Xmn512mï¼Œ-Xmn1g (-Xms,-Xmxä¹Ÿæ˜¯ç§å†™æ³•)-Xmnåªèƒ½ä½¿ç”¨åœ¨JDK1.4æˆ–ä¹‹åŽçš„ç‰ˆæœ¬ä¸­ï¼Œï¼ˆä¹‹å‰çš„1.3/1.4ç‰ˆæœ¬ä¸­ï¼Œå¯ä½¿ç”¨-XX:NewSizeè®¾ç½®å¹´è½»ä»£å¤§å°ï¼Œç”¨-XX:MaxNewSizeè®¾ç½®å¹´è½»ä»£æœ€å¤§å€¼ï¼‰ï¼›å¦‚æžœåŒæ—¶è®¾ç½®äº†-Xmnå’Œ-XX:NewSizeï¼Œ-XX:MaxNewSizeï¼Œåˆ™è°è®¾ç½®åœ¨åŽé¢ï¼Œè°å°±ç”Ÿæ•ˆï¼›å¦‚æžœåŒæ—¶è®¾ç½®äº†-XX:NewSize -XX:MaxNewSizeä¸Ž-XX:NewRatioåˆ™å®žé™…ç”Ÿæ•ˆçš„å€¼æ˜¯ï¼šmin(MaxNewSize,max(NewSize, heap/(NewRatio+1)))åœ¨å¼€å‘ã€æµ‹è¯•çŽ¯å¢ƒï¼Œå¯ä»¥-XX:NewSizeå’Œ-XX:MaxNewSizeæ¥è®¾ç½®æ–°ç”Ÿä»£å¤§å°ï¼Œä½†åœ¨çº¿ä¸Šç”Ÿäº§çŽ¯å¢ƒï¼Œä½¿ç”¨-Xmnä¸€ä¸ªå³å¯ï¼ˆæŽ¨èï¼‰ï¼Œæˆ–è€…å°†-XX:NewSizeå’Œ-XX:MaxNewSizeè®¾ç½®ä¸ºåŒä¸€ä¸ªå€¼ï¼Œè¿™æ ·èƒ½å¤Ÿé˜²æ­¢åœ¨æ¯æ¬¡GCä¹‹åŽéƒ½è¦è°ƒæ•´å †çš„å¤§å°ï¼ˆå³ï¼šæŠ–åŠ¨ï¼ŒæŠ–åŠ¨ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼‰ -Xmsåˆå§‹å †çš„å¤§å°ï¼Œä¹Ÿæ˜¯å †å¤§å°çš„æœ€å°å€¼ï¼Œé»˜è®¤å€¼æ˜¯æ€»å…±çš„ç‰©ç†å†…å­˜/64ï¼ˆä¸”å°äºŽ1Gï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å †ä¸­å¯ç”¨å†…å­˜å°äºŽ40%(è¿™ä¸ªå€¼å¯ä»¥ç”¨-XX: MinHeapFreeRatioè°ƒæ•´ï¼Œå¦‚-X:MinHeapFreeRatio=30)æ—¶ï¼Œå †å†…å­˜ä¼šå¼€å§‹å¢žåŠ ï¼Œä¸€ç›´å¢žåŠ åˆ°-Xmxçš„å¤§å°ï¼› -Xmxå †çš„æœ€å¤§å€¼ï¼Œé»˜è®¤å€¼æ˜¯æ€»å…±çš„ç‰©ç†å†…å­˜/64ï¼ˆä¸”å°äºŽ1Gï¼‰ï¼Œå¦‚æžœ-Xmså’Œ-Xmxéƒ½ä¸è®¾ç½®ï¼Œåˆ™ä¸¤è€…å¤§å°ä¼šç›¸åŒï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å †ä¸­å¯ç”¨å†…å­˜å¤§äºŽ70%ï¼ˆè¿™ä¸ªå€¼å¯ä»¥ç”¨-XX:MaxHeapFreeRatioè°ƒæ•´ï¼Œå¦‚-X:MaxHeapFreeRatio=60)æ—¶ï¼Œå †å†…å­˜ä¼šå¼€å§‹å‡å°‘ï¼Œä¸€ç›´å‡å°åˆ°-Xmsçš„å¤§å°ï¼›æ•´ä¸ªå †çš„å¤§å°=å¹´è½»ä»£å¤§å°+å¹´è€ä»£å¤§å°ï¼Œå †çš„å¤§å°ä¸åŒ…å«æŒä¹…ä»£å¤§å°ï¼Œå¦‚æžœå¢žå¤§äº†å¹´è½»ä»£ï¼Œå¹´è€ä»£ç›¸åº”å°±ä¼šå‡å°ï¼Œå®˜æ–¹é»˜è®¤çš„é…ç½®ä¸ºå¹´è€ä»£å¤§å°/å¹´è½»ä»£å¤§å°=2/1å·¦å³ï¼ˆä½¿ç”¨-XX:NewRatioå¯ä»¥è®¾ç½®-XX:NewRatio=5ï¼Œè¡¨ç¤ºå¹´è€ä»£/å¹´è½»ä»£=5/1ï¼‰ï¼›å»ºè®®åœ¨å¼€å‘æµ‹è¯•çŽ¯å¢ƒå¯ä»¥ç”¨-Xmså’Œ-Xmxåˆ†åˆ«è®¾ç½®æœ€å°å€¼æœ€å¤§å€¼ï¼Œä½†æ˜¯åœ¨çº¿ä¸Šç”Ÿäº§çŽ¯å¢ƒï¼Œ-Xmså’Œ-Xmxè®¾ç½®çš„å€¼å¿…é¡»ä¸€æ ·ï¼ŒåŽŸå› ä¸Žå¹´è½»ä»£ä¸€æ ·â€”â€”é˜²æ­¢æŠ–åŠ¨ï¼› -Xssè¿™ä¸ªå‚æ•°ç”¨äºŽè®¾ç½®æ¯ä¸ªçº¿ç¨‹çš„æ ˆå†…å­˜ï¼Œé»˜è®¤1Mï¼Œä¸€èˆ¬æ¥è¯´æ˜¯ä¸éœ€è¦æ”¹çš„ã€‚é™¤éžä»£ç ä¸å¤šï¼Œå¯ä»¥è®¾ç½®çš„å°ç‚¹ï¼Œå¦å¤–ä¸€ä¸ªç›¸ä¼¼çš„å‚æ•°æ˜¯-XX:ThreadStackSizeï¼Œè¿™ä¸¤ä¸ªå‚æ•°åœ¨1.6ä»¥å‰ï¼Œéƒ½æ˜¯è°è®¾ç½®åœ¨åŽé¢ï¼Œè°å°±ç”Ÿæ•ˆï¼›1.6ç‰ˆæœ¬ä»¥åŽï¼Œ-Xssè®¾ç½®åœ¨åŽé¢ï¼Œåˆ™ä»¥-Xssä¸ºå‡†ï¼Œ-XXThreadStackSizeè®¾ç½®åœ¨åŽé¢ï¼Œåˆ™ä¸»çº¿ç¨‹ä»¥-Xssä¸ºå‡†ï¼Œå…¶å®ƒçº¿ç¨‹ä»¥-XX:ThreadStackSize -Xrså‡å°‘JVMå¯¹æ“ä½œç³»ç»Ÿä¿¡å·ï¼ˆOS Signalsï¼‰çš„ä½¿ç”¨ï¼ˆJDK1.3.1ä¹‹åŽæ‰æœ‰æ•ˆï¼‰ï¼Œå½“æ­¤å‚æ•°è¢«è®¾ç½®ä¹‹åŽï¼Œjvmå°†ä¸æŽ¥æ”¶æŽ§åˆ¶å°çš„æŽ§åˆ¶handlerï¼Œä»¥é˜²æ­¢ä¸Žåœ¨åŽå°ä»¥æœåŠ¡å½¢å¼è¿è¡Œçš„JVMå†²çªï¼ˆè¿™ä¸ªç”¨çš„æ¯”è¾ƒå°‘ï¼‰ã€‚ -Xprofè·Ÿè¸ªæ­£è¿è¡Œçš„ç¨‹åºï¼Œå¹¶å°†è·Ÿè¸ªæ•°æ®åœ¨æ ‡å‡†è¾“å‡ºè¾“å‡ºï¼›é€‚åˆäºŽå¼€å‘çŽ¯å¢ƒè°ƒè¯•ã€‚ -Xnoclassgcå…³é—­é’ˆå¯¹classçš„gcåŠŸèƒ½ï¼›å› ä¸ºå…¶é˜»æ­¢å†…å­˜å›žæ”¶ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå¯¼è‡´OutOfMemoryErroré”™è¯¯ï¼Œæ…Žç”¨ï¼› -Xincgcå¼€å¯å¢žé‡gcï¼ˆé»˜è®¤ä¸ºå…³é—­ï¼‰ï¼›è¿™æœ‰åŠ©äºŽå‡å°‘é•¿æ—¶é—´GCæ—¶åº”ç”¨ç¨‹åºå‡ºçŽ°çš„åœé¡¿ï¼›ä½†ç”±äºŽå¯èƒ½å’Œåº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼Œæ‰€ä»¥ä¼šé™ä½ŽCPUå¯¹åº”ç”¨çš„å¤„ç†èƒ½åŠ›ã€‚ -Xloggc:fileä¸Ž-verbose:gcåŠŸèƒ½ç±»ä¼¼ï¼Œåªæ˜¯å°†æ¯æ¬¡GCäº‹ä»¶çš„ç›¸å…³æƒ…å†µè®°å½•åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶çš„ä½ç½®æœ€å¥½åœ¨æœ¬åœ°ï¼Œä»¥é¿å…ç½‘ç»œçš„æ½œåœ¨é—®é¢˜ã€‚è‹¥ä¸Žverboseå‘½ä»¤åŒæ—¶å‡ºçŽ°åœ¨å‘½ä»¤è¡Œä¸­ï¼Œåˆ™ä»¥-Xloggcä¸ºå‡†ã€‚ éžStableå‚æ•°ï¼ˆéžé™æ€å‚æ•°ï¼‰ä»¥-XXè¡¨ç¤ºçš„éžStableå‚æ•°ï¼Œè™½ç„¶åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ˜¯ä¸ç¡®å®šçš„ï¼Œä¸å¥å£®çš„ï¼Œå„ä¸ªå…¬å¸çš„å®žçŽ°ä¹Ÿå„æœ‰ä¸åŒï¼Œä½†å¾€å¾€éžå¸¸å®žç”¨ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†å‚æ•°å¯¹äºŽGCéžå¸¸é‡è¦ã€‚JVMï¼ˆHotspotï¼‰ä¸­ä¸»è¦çš„å‚æ•°å¯ä»¥å¤§è‡´åˆ†ä¸º3ç±» æ€§èƒ½å‚æ•°ï¼ˆPerformance Optionsï¼‰ï¼šç”¨äºŽJVMçš„æ€§èƒ½è°ƒä¼˜å’Œå†…å­˜åˆ†é…æŽ§åˆ¶ï¼Œå¦‚åˆå§‹åŒ–å†…å­˜å¤§å°çš„è®¾ç½®ï¼› è¡Œä¸ºå‚æ•°ï¼ˆBehavioral Optionsï¼‰ï¼šç”¨äºŽæ”¹å˜JVMçš„åŸºç¡€è¡Œä¸ºï¼Œå¦‚GCçš„æ–¹å¼å’Œç®—æ³•çš„é€‰æ‹©ï¼› è°ƒè¯•å‚æ•°ï¼ˆDebugging Optionsï¼‰ï¼šç”¨äºŽç›‘æŽ§ã€æ‰“å°ã€è¾“å‡ºç­‰jvmå‚æ•°ï¼Œç”¨äºŽæ˜¾ç¤ºjvmæ›´åŠ è¯¦ç»†çš„ä¿¡æ¯ï¼› å¯¹äºŽéžStableå‚æ•°ï¼Œä½¿ç”¨æ–¹æ³•æœ‰4ç§ï¼š -XX:+[option] å¯ç”¨é€‰é¡¹ -XX:-[option] ä¸å¯ç”¨é€‰é¡¹ -XX:[option]=[number] ç»™é€‰é¡¹è®¾ç½®ä¸€ä¸ªæ•°å­—ç±»åž‹å€¼ï¼Œå¯è·Ÿå•ä½ï¼Œä¾‹å¦‚ 32k, 1024m, 2g -XX:[option]=[string] ç»™é€‰é¡¹è®¾ç½®ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œä¾‹å¦‚-XX:HeapDumpPath=./dump.core é¦–å…ˆä»‹ç»æ€§èƒ½å‚æ•°ï¼Œæ€§èƒ½å‚æ•°å¾€å¾€ç”¨æ¥å®šä¹‰å†…å­˜åˆ†é…çš„å¤§å°å’Œæ¯”ä¾‹ï¼Œç›¸æ¯”äºŽè¡Œä¸ºå‚æ•°å’Œè°ƒè¯•å‚æ•°ï¼Œä¸€ä¸ªæ¯”è¾ƒæ˜Žæ˜¾çš„åŒºåˆ«æ˜¯æ€§èƒ½å‚æ•°åŽé¢å¾€å¾€è·Ÿçš„æœ‰æ•°å€¼ï¼Œå¸¸ç”¨å¦‚ä¸‹ï¼š å‚æ•°åŠå…¶é»˜è®¤å€¼ æè¿° -XX:NewSize=2.125m æ–°ç”Ÿä»£å¯¹è±¡ç”Ÿæˆæ—¶å ç”¨å†…å­˜çš„é»˜è®¤å€¼ -XX:MaxNewSize=size æ–°ç”Ÿæˆå¯¹è±¡èƒ½å ç”¨å†…å­˜çš„æœ€å¤§å€¼ -XX:MaxPermSize=64m æ–¹æ³•åŒºæ‰€èƒ½å ç”¨çš„æœ€å¤§å†…å­˜ï¼ˆéžå †å†…å­˜ï¼‰ -XX:PermSize=64m æ–¹æ³•åŒºåˆ†é…çš„åˆå§‹å†…å­˜ -XX:MaxTenuringThreshold=15 å¯¹è±¡åœ¨æ–°ç”Ÿä»£å­˜æ´»åŒºåˆ‡æ¢çš„æ¬¡æ•°ï¼ˆåšæŒè¿‡MinorGCçš„æ¬¡æ•°ï¼Œæ¯åšæŒè¿‡ä¸€æ¬¡ï¼Œè¯¥å€¼å°±å¢žåŠ 1ï¼‰ï¼Œå¤§äºŽè¯¥å€¼ä¼šè¿›å…¥è€å¹´ä»£ -XX:MaxHeapFreeRatio=70 GCåŽjavaå †ä¸­ç©ºé—²é‡å çš„æœ€å¤§æ¯”ä¾‹ï¼Œå¤§äºŽè¯¥å€¼ï¼Œåˆ™å †å†…å­˜ä¼šå‡å°‘ -XX:MinHeapFreeRatio=40 GCåŽjavaå †ä¸­ç©ºé—²é‡å çš„æœ€å°æ¯”ä¾‹ï¼Œå°äºŽè¯¥å€¼ï¼Œåˆ™å †å†…å­˜ä¼šå¢žåŠ  -XX:NewRatio=2 æ–°ç”Ÿä»£å†…å­˜å®¹é‡ä¸Žè€ç”Ÿä»£å†…å­˜å®¹é‡çš„æ¯”ä¾‹ -XX:ReservedCodeCacheSize= 32m ä¿ç•™ä»£ç å ç”¨çš„å†…å­˜å®¹é‡ -XX:ThreadStackSize=512 è®¾ç½®çº¿ç¨‹æ ˆå¤§å°ï¼Œè‹¥ä¸º0åˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å€¼ -XX:LargePageSizeInBytes=4m è®¾ç½®ç”¨äºŽJavaå †çš„å¤§é¡µé¢å°ºå¯¸ -XX:PretenureSizeThreshold= size å¤§äºŽè¯¥å€¼çš„å¯¹è±¡ç›´æŽ¥æ™‹å‡å…¥è€å¹´ä»£ï¼ˆè¿™ç§å¯¹è±¡å°‘ç”¨ä¸ºå¥½ï¼‰ -XX:SurvivorRatio=8 EdenåŒºåŸŸSurvivoråŒºçš„å®¹é‡æ¯”å€¼ï¼Œå¦‚é»˜è®¤å€¼ä¸º8ï¼Œä»£è¡¨Edenï¼šSurvivor1ï¼šSurvivor2=8:1:1 å¸¸ç”¨çš„è¡Œä¸ºå‚æ•°ï¼Œä¸»è¦ç”¨æ¥é€‰æ‹©ä½¿ç”¨ä»€ä¹ˆæ ·çš„åžƒåœ¾æ”¶é›†å™¨ç»„åˆï¼Œä»¥åŠæŽ§åˆ¶è¿è¡Œè¿‡ç¨‹ä¸­çš„GCç­–ç•¥ç­‰ï¼š å‚æ•°åŠå…¶é»˜è®¤å€¼ æè¿° -XX:+UseSerialGC å¯ç”¨ä¸²è¡ŒGCï¼Œå³é‡‡ç”¨Serial+Serial Oldæ¨¡å¼ -XX:+UseParallelGC å¯ç”¨å¹¶è¡ŒGCï¼Œå³é‡‡ç”¨Parallel Scavenge+Serial Oldæ”¶é›†å™¨ç»„åˆï¼ˆ-Serveræ¨¡å¼ä¸‹çš„é»˜è®¤ç»„åˆï¼‰ -XX:GCTimeRatio=99 è®¾ç½®ç”¨æˆ·æ‰§è¡Œæ—¶é—´å æ€»æ—¶é—´çš„æ¯”ä¾‹ï¼ˆé»˜è®¤å€¼99ï¼Œå³1%çš„æ—¶é—´ç”¨äºŽGCï¼‰ -XX:MaxGCPauseMillis=time è®¾ç½®GCçš„æœ€å¤§åœé¡¿æ—¶é—´ï¼ˆè¿™ä¸ªå‚æ•°åªå¯¹Parallel Scavengeæœ‰æ•ˆï¼‰ -XX:+UseParNewGC ä½¿ç”¨ParNew+Serial Oldæ”¶é›†å™¨ç»„åˆ -XX:ParallelGCThreads è®¾ç½®æ‰§è¡Œå†…å­˜å›žæ”¶çš„çº¿ç¨‹æ•°ï¼Œåœ¨+UseParNewGCçš„æƒ…å†µä¸‹ä½¿ç”¨ -XX:+UseParallelOldGC ä½¿ç”¨Parallel Scavenge +Parallel Oldç»„åˆæ”¶é›†å™¨ -XX:+UseConcMarkSweepGC ä½¿ç”¨ParNew+CMS+Serial Oldç»„åˆå¹¶å‘æ”¶é›†ï¼Œä¼˜å…ˆä½¿ç”¨ParNew+CMSï¼Œå½“ç”¨æˆ·çº¿ç¨‹å†…å­˜ä¸è¶³æ—¶ï¼Œé‡‡ç”¨å¤‡ç”¨æ–¹æ¡ˆSerial Oldæ”¶é›†ã€‚ -XX:+DisableExplicitGC ç¦æ­¢è°ƒç”¨System.gc()ï¼›ä½†jvmçš„gcä»ç„¶æœ‰æ•ˆ -XX:+ScavengeBeforeFullGC æ–°ç”Ÿä»£GCä¼˜å…ˆäºŽFull GCæ‰§è¡Œ å¸¸ç”¨çš„è°ƒè¯•å‚æ•°ï¼Œä¸»è¦ç”¨äºŽç›‘æŽ§å’Œæ‰“å°GCçš„ä¿¡æ¯ï¼š å‚æ•°åŠå…¶é»˜è®¤å€¼ æè¿° -XX:+CITime æ‰“å°æ¶ˆè€—åœ¨JITç¼–è¯‘çš„æ—¶é—´ -XX:ErrorFile=./hs_err_pid[pid].log ä¿å­˜é”™è¯¯æ—¥å¿—æˆ–è€…æ•°æ®åˆ°æ–‡ä»¶ä¸­ -XX:+ExtendedDTraceProbes å¼€å¯solarisç‰¹æœ‰çš„dtraceæŽ¢é’ˆ -XX:HeapDumpPath=./java_pid[pid].hprof æŒ‡å®šå¯¼å‡ºå †ä¿¡æ¯æ—¶çš„è·¯å¾„æˆ–æ–‡ä»¶å -XX:+HeapDumpOnOutOfMemoryError å½“é¦–æ¬¡é­é‡OOMæ—¶å¯¼å‡ºæ­¤æ—¶å †ä¸­ç›¸å…³ä¿¡æ¯ -XX:OnError=â€[cmd args&gt;];[cmd args]â€ å‡ºçŽ°è‡´å‘½ERRORä¹‹åŽè¿è¡Œè‡ªå®šä¹‰å‘½ä»¤ -XX:OnOutOfMemoryError=â€[cmd args];[cmd args]â€ å½“é¦–æ¬¡é­é‡OOMæ—¶æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤ -XX:+PrintClassHistogram é‡åˆ°Ctrl-BreakåŽæ‰“å°ç±»å®žä¾‹çš„æŸ±çŠ¶ä¿¡æ¯ï¼Œä¸Žjmap -histoåŠŸèƒ½ç›¸åŒ -XX:+PrintConcurrentLocks é‡åˆ°Ctrl-BreakåŽæ‰“å°å¹¶å‘é”çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸Žjstack -låŠŸèƒ½ç›¸åŒ -XX:+PrintCommandLineFlags æ‰“å°åœ¨å‘½ä»¤è¡Œä¸­å‡ºçŽ°è¿‡çš„æ ‡è®° -XX:+PrintCompilation å½“ä¸€ä¸ªæ–¹æ³•è¢«ç¼–è¯‘æ—¶æ‰“å°ç›¸å…³ä¿¡æ¯ -XX:+PrintGC æ¯æ¬¡GCæ—¶æ‰“å°ç›¸å…³ä¿¡æ¯ -XX:+PrintGC Details æ¯æ¬¡GCæ—¶æ‰“å°è¯¦ç»†ä¿¡æ¯ -XX:+PrintGCTimeStamps æ‰“å°æ¯æ¬¡GCçš„æ—¶é—´æˆ³ -XX:+TraceClassLoading è·Ÿè¸ªç±»çš„åŠ è½½ä¿¡æ¯ -XX:+TraceClassLoadingPreorder è·Ÿè¸ªè¢«å¼•ç”¨åˆ°çš„æ‰€æœ‰ç±»çš„åŠ è½½ä¿¡æ¯ -XX:+TraceClassResolution è·Ÿè¸ªå¸¸é‡æ±  -XX:+TraceClassUnloading è·Ÿè¸ªç±»çš„å¸è½½ä¿¡æ¯ -XX:+TraceLoaderConstraints è·Ÿè¸ªç±»åŠ è½½å™¨çº¦æŸçš„ç›¸å…³ä¿¡æ¯ è¿™äº›å‚æ•°å°†ä¸ºæˆ‘ä»¬è¿›è¡ŒGCçš„ç›‘æŽ§ä¸Žè°ƒä¼˜æä¾›å¾ˆå¤§åŠ©åŠ›ï¼Œæ˜¯æˆ‘ä»¬è¿›è¡ŒGCç›¸å…³æ“ä½œçš„é‡è¦å·¥å…·ã€‚ æ”¶é›†å™¨æ­é…åœ¨ä»‹ç»äº†å¸¸ç”¨çš„é…ç½®å‚æ•°ä¹‹åŽï¼Œæˆ‘ä»¬å°†å¼€å§‹çœŸæ­£çš„JVMå®žæ“å¾ç¨‹ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬è¦ä¸ºåº”ç”¨ç¨‹åºé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„åžƒåœ¾æ”¶é›†å™¨ç»„åˆï¼ŒåŠä¸ŠèŠ‚ä¸­çš„è¡Œä¸ºå‚æ•°ã€‚å›¾ä¸­ä¸¤ä¸ªæ”¶é›†å™¨ä¹‹é—´æœ‰è¿žçº¿ï¼Œè¯´æ˜Žå®ƒä»¬å¯ä»¥é…åˆä½¿ç”¨æ–°ç”Ÿä»£æ”¶é›†å™¨å¦‚ä¸‹ï¼šSerialæ”¶é›†å™¨ï¼š Serialæ”¶é›†å™¨æ˜¯åœ¨clientæ¨¡å¼ä¸‹é»˜è®¤çš„æ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œå…¶æ”¶é›†æ•ˆçŽ‡å¤§çº¦æ˜¯100Må·¦å³çš„å†…å­˜éœ€è¦å‡ ååˆ°100å¤šæ¯«ç§’ï¼›åœ¨clientæ¨¡å¼ä¸‹ï¼Œæ”¶é›†æ¡Œé¢åº”ç”¨çš„å†…å­˜åžƒåœ¾ï¼ŒåŸºæœ¬ä¸Šä¸å½±å“ç”¨æˆ·ä½“éªŒã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬çš„Javaæ¡Œé¢åº”ç”¨ä¸­ï¼Œç›´æŽ¥ä½¿ç”¨Serialæ”¶é›†å™¨ï¼ˆä¸éœ€è¦é…ç½®å‚æ•°ï¼Œç”¨é»˜è®¤å³å¯ï¼‰ã€‚ParNewæ”¶é›†å™¨ï¼šSerialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œè¿™ç§æ”¶é›†å™¨é»˜è®¤å¼€é€šçš„çº¿ç¨‹æ•°ä¸ŽCPUæ•°é‡ç›¸åŒï¼Œ-XX:ParallelGCThreadså¯ä»¥ç”¨æ¥è®¾ç½®å¼€é€šçš„çº¿ç¨‹æ•°ã€‚å¯ä»¥ä¸ŽCMSæ”¶é›†å™¨é…åˆä½¿ç”¨ï¼Œäº‹å®žä¸Šç”¨-XX:+UseConcMarkSweepGCé€‰æ‹©ä½¿ç”¨CMSæ”¶é›†å™¨æ—¶ï¼Œé»˜è®¤ä½¿ç”¨çš„å°±æ˜¯ParNewæ”¶é›†å™¨ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–è®¾ç½®-XX:+UseParNewGCï¼Œè®¾ç½®äº†ä¹Ÿä¸ä¼šå†²çªï¼Œå› ä¸ºä¼šå°†ParNew+Serial Oldä½œä¸ºä¸€ä¸ªå¤‡é€‰æ–¹æ¡ˆï¼›å¦‚æžœå•ç‹¬ä½¿ç”¨-XX:+UseParNewGCå‚æ•°ï¼Œåˆ™é€‰æ‹©çš„æ˜¯ParNew+Serial Oldæ”¶é›†å™¨ç»„åˆæ”¶é›†å™¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨serveræ¨¡å¼ä¸‹ï¼Œå¦‚æžœé€‰æ‹©CMSæ”¶é›†å™¨ï¼Œåˆ™ä¼˜å…ˆé€‰æ‹©ParNewæ”¶é›†å™¨ã€‚Parallel Scavengeæ”¶é›†å™¨ï¼šå…³æ³¨çš„æ˜¯åžåé‡ï¼Œæ„å‘³ç€å¼ºè°ƒä»»åŠ¡æ›´å¿«çš„å®Œæˆï¼Œè€Œå¦‚CMSç­‰å…³æ³¨åœé¡¿æ—¶é—´çŸ­çš„æ”¶é›†å™¨ï¼Œå¼ºè°ƒçš„æ˜¯ç”¨æˆ·äº¤äº’ä½“éªŒã€‚åœ¨éœ€è¦å…³æ³¨åžåé‡çš„åœºåˆï¼Œæ¯”å¦‚æ•°æ®è¿ç®—æœåŠ¡å™¨ç­‰ï¼Œå°±å¯ä»¥ä½¿ç”¨Parallel Scavengeæ”¶é›†å™¨ã€‚ è€å¹´ä»£æ”¶é›†å™¨å¦‚ä¸‹ï¼šSerial Oldæ”¶é›†å™¨ï¼šåœ¨1.5ç‰ˆæœ¬åŠä»¥å‰å¯ä»¥ä¸Ž Parallel Scavengeç»“åˆä½¿ç”¨ï¼ˆäº‹å®žä¸Šï¼Œä¹Ÿæ˜¯å½“æ—¶Parallel Scavengeå”¯ä¸€èƒ½ç”¨çš„ç‰ˆæœ¬ï¼‰ï¼Œå¦å¤–å°±æ˜¯åœ¨ä½¿ç”¨CMSæ”¶é›†å™¨æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆï¼Œå‘ç”Ÿ Concurrent Mode Failureæ—¶ä½¿ç”¨ã€‚å¦‚æžœæ˜¯å•ç‹¬ä½¿ç”¨ï¼ŒSerial Oldä¸€èˆ¬ç”¨åœ¨clientæ¨¡å¼ä¸­ã€‚Parallel Oldæ”¶é›†å™¨ï¼šåœ¨1.6ç‰ˆæœ¬ä¹‹åŽï¼Œä¸Ž Parallel Scavengeç»“åˆä½¿ç”¨ï¼Œä»¥æ›´å¥½çš„è´¯å½»åžåé‡ä¼˜å…ˆçš„æ€æƒ³ï¼Œå¦‚æžœæ˜¯å…³æ³¨åžåé‡çš„æœåŠ¡å™¨ï¼Œå»ºè®®ä½¿ç”¨Parallel Scavenge + Parallel Old æ”¶é›†å™¨ã€‚CMSæ”¶é›†å™¨ï¼šè¿™æ˜¯å½“å‰é˜¶æ®µä½¿ç”¨å¾ˆå¹¿çš„ä¸€ç§æ”¶é›†å™¨ï¼Œå›½å†…å¾ˆå¤šå¤§çš„äº’è”ç½‘å…¬å¸çº¿ä¸ŠæœåŠ¡å™¨éƒ½ä½¿ç”¨è¿™ç§åžƒåœ¾æ”¶é›†å™¨,CMSæ”¶é›†å™¨ä»¥èŽ·å–æœ€çŸ­å›žæ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡ï¼Œéžå¸¸é€‚åˆå¯¹ç”¨æˆ·å“åº”æ¯”è¾ƒé«˜çš„B/Sæž¶æž„æœåŠ¡å™¨ã€‚CMSIncrementalModeï¼š CMSæ”¶é›†å™¨å˜ç§ï¼Œå±žå¢žé‡å¼åžƒåœ¾æ”¶é›†å™¨ï¼Œåœ¨å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…ç†æ—¶äº¤æ›¿è¿è¡Œåžƒåœ¾æ”¶é›†å™¨å’Œç”¨æˆ·çº¿ç¨‹ã€‚G1 æ”¶é›†å™¨ï¼šé¢å‘æœåŠ¡å™¨ç«¯åº”ç”¨çš„åžƒåœ¾æ”¶é›†å™¨ï¼Œè®¡åˆ’æœªæ¥æ›¿ä»£CMSæ”¶é›†å™¨ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æžœæ˜¯Javaæ¡Œé¢åº”ç”¨ï¼Œå»ºè®®é‡‡ç”¨Serial+Serial Oldæ”¶é›†å™¨ç»„åˆï¼Œå³ï¼š-XX:+UseSerialGCï¼ˆ-clientä¸‹çš„é»˜è®¤å‚æ•°ï¼‰ åœ¨å¼€å‘/æµ‹è¯•çŽ¯å¢ƒï¼Œå¯ä»¥é‡‡ç”¨é»˜è®¤å‚æ•°ï¼Œå³é‡‡ç”¨Parallel Scavenge+Serial Oldæ”¶é›†å™¨ç»„åˆï¼Œå³ï¼š-XX:+UseParallelGCï¼ˆ-serverä¸‹çš„é»˜è®¤å‚æ•°ï¼‰ åœ¨çº¿ä¸Šè¿ç®—ä¼˜å…ˆçš„çŽ¯å¢ƒï¼Œå»ºè®®é‡‡ç”¨Parallel Scavenge+Serial Oldæ”¶é›†å™¨ç»„åˆï¼Œå³ï¼š-XX:+UseParallelGC åœ¨çº¿ä¸ŠæœåŠ¡å“åº”ä¼˜å…ˆçš„çŽ¯å¢ƒï¼Œå»ºè®®é‡‡ç”¨ParNew+CMS+Serial Oldæ”¶é›†å™¨ç»„åˆï¼Œå³ï¼š-XX:+UseConcMarkSweepGC å¦å¤–åœ¨é€‰æ‹©äº†åžƒåœ¾æ”¶é›†å™¨ç»„åˆä¹‹åŽï¼Œè¿˜è¦é…ç½®ä¸€äº›è¾…åŠ©å‚æ•°ï¼Œä»¥ä¿è¯æ”¶é›†å™¨å¯ä»¥æ›´å¥½çš„å·¥ä½œ é€‰ç”¨äº†ParNewæ”¶é›†å™¨ï¼Œä½ å¯èƒ½éœ€è¦é…ç½®4ä¸ªå‚æ•°ï¼š -XX:SurvivorRatio, -XX:PretenureSizeThreshold, -XX:+HandlePromotionFailure,-XX:MaxTenuringThresholdï¼› é€‰ç”¨äº† Parallel Scavengeæ”¶é›†å™¨ï¼Œä½ å¯èƒ½éœ€è¦é…ç½®3ä¸ªå‚æ•°ï¼š -XX:MaxGCPauseMillisï¼Œ-XX:GCTimeRatioï¼Œ -XX:+UseAdaptiveSizePolicy ï¼› é€‰ç”¨äº†CMSæ”¶é›†å™¨ï¼Œä½ å¯èƒ½éœ€è¦é…ç½®3ä¸ªå‚æ•°ï¼š -XX:CMSInitiatingOccupancyFractionï¼Œ -XX:+UseCMSCompactAtFullCollection, -XX:CMSFullGCsBeforeCompactionï¼› å¯åŠ¨å†…å­˜åˆ†é…å…³äºŽGCæœ‰ä¸€ä¸ªå¸¸è§çš„ç–‘é—®æ˜¯ï¼Œåœ¨å¯åŠ¨æ—¶ï¼Œæˆ‘çš„å†…å­˜å¦‚ä½•åˆ†é…ï¼Ÿç»è¿‡å‰é¢çš„å­¦ä¹ ï¼Œå·²ç»å¾ˆå®¹æ˜“çŸ¥é“ï¼Œç”¨-Xmnï¼Œ-Xmxï¼Œ-Xmsï¼Œ-Xssï¼Œ-XX:NewSizeï¼Œ-XX:MaxNewSizeï¼Œ-XX:MaxPermSizeï¼Œ-XX:PermSizeï¼Œ-XX:SurvivorRatioï¼Œ-XX:PretenureSizeThresholdï¼Œ-XX:MaxTenuringThresholdå°±åŸºæœ¬å¯ä»¥é…ç½®å†…å­˜å¯åŠ¨æ—¶çš„åˆ†é…æƒ…å†µã€‚ä½†æ˜¯ï¼Œå…·ä½“é…ç½®å¤šå°‘ï¼Ÿè®¾ç½®å°äº†ï¼Œé¢‘ç¹GCï¼ˆç”šè‡³å†…å­˜æº¢å‡ºï¼‰ï¼Œè®¾ç½®å¤§äº†ï¼Œå†…å­˜æµªè´¹ã€‚ç»“åˆå‰é¢å¯¹äºŽå†…å­˜åŒºåŸŸå’Œå…¶ä½œç”¨çš„å­¦ä¹ ï¼Œå°½é‡è€ƒè™‘å¦‚ä¸‹å»ºè®®ï¼š -XX:PermSizeå°½é‡æ¯”-XX:MaxPermSizeå°ï¼Œ-XX:MaxPermSize&gt;= 2 * -XX:PermSize, -XX:PermSize&gt; 64mï¼Œä¸€èˆ¬å¯¹äºŽ4Gå†…å­˜çš„æœºå™¨ï¼Œ-XX:MaxPermSizeä¸ä¼šè¶…è¿‡256mï¼› -Xms = -Xmxï¼ˆçº¿ä¸ŠServeræ¨¡å¼ï¼‰ï¼Œä»¥é˜²æ­¢æŠ–åŠ¨ï¼Œå¤§å°å—æ“ä½œç³»ç»Ÿå’Œå†…å­˜å¤§å°é™åˆ¶ï¼Œå¦‚æžœæ˜¯32ä½ç³»ç»Ÿï¼Œåˆ™ä¸€èˆ¬-Xmsè®¾ç½®ä¸º1g-2gï¼ˆå‡è®¾æœ‰4gå†…å­˜ï¼‰ï¼Œåœ¨64ä½ç³»ç»Ÿä¸Šï¼Œæ²¡æœ‰é™åˆ¶ï¼Œä¸è¿‡ä¸€èˆ¬ä¸ºæœºå™¨æœ€å¤§å†…å­˜çš„ä¸€åŠå·¦å³ï¼› -Xmnï¼Œåœ¨å¼€å‘çŽ¯å¢ƒä¸‹ï¼Œå¯ä»¥ç”¨-XX:NewSizeå’Œ-XX:MaxNewSizeæ¥è®¾ç½®æ–°ç”Ÿä»£çš„å¤§å°ï¼ˆ-XX:NewSize&lt;=-XX:MaxNewSizeï¼‰ï¼Œåœ¨ç”Ÿäº§çŽ¯å¢ƒï¼Œå»ºè®®åªè®¾ç½®-Xmnï¼Œä¸€èˆ¬-Xmnçš„å¤§å°æ˜¯-Xmsçš„1/2å·¦å³ï¼Œä¸è¦è®¾ç½®çš„è¿‡å¤§æˆ–è¿‡å°ï¼Œè¿‡å¤§å¯¼è‡´è€å¹´ä»£å˜å°ï¼Œé¢‘ç¹Full GCï¼Œè¿‡å°å¯¼è‡´minor GCé¢‘ç¹ã€‚å¦‚æžœä¸è®¾ç½®-Xmnï¼Œå¯ä»¥é‡‡ç”¨-XX:NewRatio=2æ¥è®¾ç½®ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„æ•ˆæžœï¼› -Xssä¸€èˆ¬æ˜¯ä¸éœ€è¦æ”¹çš„ï¼Œé»˜è®¤å€¼å³å¯ã€‚ -XX:SurvivorRatioä¸€èˆ¬è®¾ç½®8-10å·¦å³ï¼ŒæŽ¨èè®¾ç½®ä¸º10ï¼Œä¹Ÿå³ï¼šSurvivoråŒºçš„å¤§å°æ˜¯EdenåŒºçš„1/10ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæ™®é€šçš„Javaç¨‹åºåº”ç”¨ï¼Œä¸€æ¬¡minorGCåŽï¼Œè‡³å°‘98%-99%çš„å¯¹è±¡ï¼Œéƒ½ä¼šæ¶ˆäº¡ï¼Œæ‰€ä»¥ï¼ŒsurvivoråŒºè®¾ç½®ä¸ºEdenåŒºçš„1/10å·¦å³ï¼Œèƒ½ä½¿SurvivoråŒºå®¹çº³ä¸‹10-20æ¬¡çš„minor GCæ‰æ»¡ï¼Œç„¶åŽå†è¿›å…¥è€å¹´ä»£ï¼Œè¿™ä¸ªä¸Ž -XX:MaxTenuringThresholdçš„é»˜è®¤å€¼15æ¬¡ä¹Ÿç›¸åŒ¹é…çš„ã€‚å¦‚æžœXX:SurvivorRatioè®¾ç½®çš„å¤ªå°ï¼Œä¼šå¯¼è‡´æœ¬æ¥èƒ½é€šè¿‡minorå›žæ”¶æŽ‰çš„å¯¹è±¡æå‰è¿›å…¥è€å¹´ä»£ï¼Œäº§ç”Ÿä¸å¿…è¦çš„full gcï¼›å¦‚æžœXX:SurvivorRatioè®¾ç½®çš„å¤ªå¤§ï¼Œä¼šå¯¼è‡´EdenåŒºç›¸åº”çš„è¢«åŽ‹ç¼©ã€‚ -XX:MaxTenuringThresholdé»˜è®¤ä¸º15ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç»è¿‡15æ¬¡Survivorè½®æ¢ï¼ˆå³15æ¬¡minor GCï¼‰ï¼Œå°±è¿›å…¥è€å¹´ä»£ï¼Œ å¦‚æžœè®¾ç½®çš„å°çš„è¯ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡åœ¨survivorä¸­å­˜æ´»çš„æ—¶é—´å‡å°ï¼Œæå‰è¿›å…¥å¹´è€ä»£ï¼Œå¯¹äºŽå¹´è€ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œå¯ä»¥æé«˜æ•ˆçŽ‡ã€‚å¦‚æžœå°†æ­¤å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡ä¼šåœ¨SurvivoråŒºè¿›è¡Œå¤šæ¬¡å¤åˆ¶ï¼Œè¿™æ ·å¯ä»¥å¢žåŠ å¯¹è±¡åœ¨å¹´è½»ä»£çš„å­˜æ´»æ—¶é—´ï¼Œå¢žåŠ åœ¨å¹´è½»ä»£å³è¢«å›žæ”¶çš„æ¦‚çŽ‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®¾ç½®äº† -XX:MaxTenuringThresholdï¼Œå¹¶ä¸ä»£è¡¨ç€ï¼Œå¯¹è±¡ä¸€å®šåœ¨å¹´è½»ä»£å­˜æ´»15æ¬¡æ‰è¢«æ™‹å‡è¿›å…¥è€å¹´ä»£ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæœ€å¤§å€¼ï¼Œäº‹å®žä¸Šï¼Œå­˜åœ¨ä¸€ä¸ªåŠ¨æ€è®¡ç®—æœºåˆ¶ï¼Œè®¡ç®—æ¯æ¬¡æ™‹å…¥è€å¹´ä»£çš„é˜ˆå€¼ï¼Œå–é˜ˆå€¼å’ŒMaxTenuringThresholdä¸­è¾ƒå°çš„ä¸€ä¸ªä¸ºå‡†ã€‚ -XX:PretenureSizeThresholdä¸€èˆ¬é‡‡ç”¨é»˜è®¤å€¼å³å¯ã€‚ ç›‘æŽ§å·¥å…·å’Œæ–¹æ³•åœ¨JVMè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ºä¿è¯å…¶ç¨³å®šã€é«˜æ•ˆï¼Œæˆ–åœ¨å‡ºçŽ°GCé—®é¢˜æ—¶åˆ†æžé—®é¢˜åŽŸå› ï¼Œæˆ‘ä»¬éœ€è¦å¯¹GCè¿›è¡Œç›‘æŽ§ã€‚æ‰€è°“ç›‘æŽ§ï¼Œå…¶å®žå°±æ˜¯åˆ†æžæ¸…æ¥šå½“å‰GCçš„æƒ…å†µã€‚å…¶ç›®çš„æ˜¯é‰´åˆ«JVMæ˜¯å¦åœ¨é«˜æ•ˆçš„è¿›è¡Œåžƒåœ¾å›žæ”¶ï¼Œä»¥åŠæœ‰æ²¡æœ‰å¿…è¦è¿›è¡Œè°ƒä¼˜ã€‚é€šè¿‡ç›‘æŽ§GCï¼Œæˆ‘ä»¬å¯ä»¥æžæ¸…æ¥šå¾ˆå¤šé—®é¢˜ï¼Œå¦‚ï¼š minor GCå’Œfull GCçš„é¢‘çŽ‡ï¼› æ‰§è¡Œä¸€æ¬¡GCæ‰€æ¶ˆè€—çš„æ—¶é—´ï¼› æ–°ç”Ÿä»£çš„å¯¹è±¡ä½•æ—¶è¢«ç§»åˆ°è€ç”Ÿä»£ä»¥åŠèŠ±è´¹äº†å¤šå°‘æ—¶é—´ï¼› æ¯æ¬¡GCä¸­ï¼Œå…¶å®ƒçº¿ç¨‹æš‚åœï¼ˆStop the worldï¼‰çš„æ—¶é—´ï¼› æ¯æ¬¡GCçš„æ•ˆæžœå¦‚ä½•ï¼Œæ˜¯å¦ä¸ç†æƒ³ï¼› ç›‘æŽ§GCçš„å·¥å…·åˆ†ä¸º2ç§ï¼šå‘½ä»¤è¡Œå·¥å…·å’Œå›¾å½¢å·¥å…·ï¼›å¸¸ç”¨çš„å‘½ä»¤è¡Œå·¥å…·æœ‰ï¼šæ³¨ï¼šä¸‹é¢çš„å‘½ä»¤éƒ½åœ¨JAVA_HOME/binä¸­ï¼Œæ˜¯javaè‡ªå¸¦çš„å‘½ä»¤ã€‚å¦‚æžœæ‚¨å‘çŽ°æ— æ³•ä½¿ç”¨ï¼Œè¯·ç›´æŽ¥è¿›å…¥Javaå®‰è£…ç›®å½•è°ƒç”¨æˆ–è€…å…ˆè®¾ç½®Javaçš„çŽ¯å¢ƒå˜é‡ï¼Œä¸€ä¸ªç®€å•çš„åŠžæ³•ä¸ºï¼šç›´æŽ¥è¿è¡Œå‘½ä»¤ export PATH=$JAVA_HOME/bin:$PATHï¼›å¦å¤–ï¼Œä¸€èˆ¬çš„ï¼Œåœ¨Linuxä¸‹ï¼Œä¸‹é¢çš„å‘½ä»¤éœ€è¦sudoæƒé™ï¼Œåœ¨windowsä¸‹ï¼Œéƒ¨åˆ†å‘½ä»¤çš„éƒ¨åˆ†é€‰é¡¹ä¸èƒ½ä½¿ç”¨ã€‚è¿˜æ˜¯æ— æ³•ä½¿ç”¨ï¼Œè¦ä¿è¯ä½ è£…çš„æ˜¯å¦æ˜¯jdkè¿˜æ˜¯jreï¼Œjreæ˜¯ä¸å¸¦å¾ˆå¤šå·¥å…·çš„ã€‚ jpsjpså‘½ä»¤ç”¨äºŽæŸ¥è¯¢æ­£åœ¨è¿è¡Œçš„JVMè¿›ç¨‹ï¼Œå¸¸ç”¨çš„å‚æ•°ä¸ºï¼š -q:åªè¾“å‡ºLVMIDï¼Œçœç•¥ä¸»ç±»çš„åç§° -m:è¾“å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶ä¼ ç»™ä¸»ç±»main()å‡½æ•°çš„å‚æ•° -l:è¾“å‡ºä¸»ç±»çš„å…¨ç±»åï¼Œå¦‚æžœè¿›ç¨‹æ‰§è¡Œçš„æ˜¯JaråŒ…ï¼Œè¾“å‡ºJarè·¯å¾„ -v:è¾“å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶JVMå‚æ•°å‘½ä»¤æ ¼å¼:jps [option] [hostid]ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šåœ¨ä¸Šå›¾ä¸­ï¼Œæœ‰ä¸€ä¸ªvidä¸º309çš„apacheè¿›ç¨‹åœ¨æä¾›webæœåŠ¡ã€‚ jstatjstatå¯ä»¥å®žæ—¶æ˜¾ç¤ºæœ¬åœ°æˆ–è¿œç¨‹JVMè¿›ç¨‹ä¸­ç±»è£…è½½ã€å†…å­˜ã€åžƒåœ¾æ”¶é›†ã€JITç¼–è¯‘ç­‰æ•°æ®ï¼ˆå¦‚æžœè¦æ˜¾ç¤ºè¿œç¨‹JVMä¿¡æ¯ï¼Œéœ€è¦è¿œç¨‹ä¸»æœºå¼€å¯RMIæ”¯æŒï¼‰ã€‚å¦‚æžœåœ¨æœåŠ¡å¯åŠ¨æ—¶æ²¡æœ‰æŒ‡å®šå¯åŠ¨å‚æ•°-verbose:gcï¼Œåˆ™å¯ä»¥ç”¨jstatå®žæ—¶æŸ¥çœ‹gcæƒ…å†µã€‚jstatæœ‰å¦‚ä¸‹é€‰é¡¹ï¼š -class:ç›‘è§†ç±»è£…è½½ã€å¸è½½æ•°é‡ã€æ€»ç©ºé—´åŠç±»è£…è½½æ‰€è€—è´¹çš„æ—¶é—´ -gc:ç›‘å¬Javaå †çŠ¶å†µï¼ŒåŒ…æ‹¬EdenåŒºã€ä¸¤ä¸ªSurvivoråŒºã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ç­‰çš„å®¹é‡ï¼Œä»¥ç”¨ç©ºé—´ã€GCæ—¶é—´åˆè®¡ç­‰ä¿¡æ¯ -gccapacity:ç›‘è§†å†…å®¹ä¸Ž-gcåŸºæœ¬ç›¸åŒï¼Œä½†è¾“å‡ºä¸»è¦å…³æ³¨javaå †å„ä¸ªåŒºåŸŸä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´ -gcutil:ç›‘è§†å†…å®¹ä¸Ž-gcåŸºæœ¬ç›¸åŒï¼Œä½†è¾“å‡ºä¸»è¦å…³æ³¨å·²ä½¿ç”¨ç©ºé—´å æ€»ç©ºé—´çš„ç™¾åˆ†æ¯” -gccause:ä¸Ž-gcutilåŠŸèƒ½ä¸€æ ·ï¼Œä½†æ˜¯ä¼šé¢å¤–è¾“å‡ºå¯¼è‡´ä¸Šä¸€æ¬¡GCäº§ç”Ÿçš„åŽŸå›  -gcnew:ç›‘è§†æ–°ç”Ÿä»£GCçŠ¶å†µ -gcnewcapacity:ç›‘è§†å†…åŒä¸Ž-gcnewåŸºæœ¬ç›¸åŒï¼Œè¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´ -gcold:ç›‘è§†è€å¹´ä»£GCæƒ…å†µ -gcoldcapacity:ç›‘è§†å†…åŒä¸Ž-gcoldåŸºæœ¬ç›¸åŒï¼Œè¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´ -gcpermcapacity:è¾“å‡ºæ°¸ä¹…ä»£ä½¿ç”¨åˆ°æœ€å¤§å’Œæœ€å°ç©ºé—´ -compiler:è¾“å‡ºJITç¼–è¯‘å™¨ç¼–è¯‘è¿‡çš„æ–¹æ³•ã€è€—æ—¶ç­‰ä¿¡æ¯ -printcompilation:è¾“å‡ºå·²ç»è¢«JITç¼–è¯‘çš„æ–¹æ³•å‘½ä»¤æ ¼å¼:jstat [option vmid [interval[s|ms] [count]]]jstatå¯ä»¥ç›‘æŽ§è¿œç¨‹æœºå™¨ï¼Œå‘½ä»¤æ ¼å¼ä¸­VMIDå’ŒLVMIDç‰¹åˆ«è¯´æ˜Žï¼šå¦‚æžœæ˜¯æœ¬åœ°è™šæ‹Ÿæœºè¿›ç¨‹ï¼ŒVMIDå’ŒLVMIDæ˜¯ä¸€è‡´çš„ï¼Œå¦‚æžœæ˜¯è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œé‚£ä¹ˆVMIDæ ¼å¼æ˜¯: [protocol:][//]lvmid[@hostname[:port]/servername]ï¼Œå¦‚æžœçœç•¥intervalå’Œcountï¼Œåˆ™åªæŸ¥è¯¢ä¸€æ¬¡æŸ¥çœ‹gcæƒ…å†µçš„ä¾‹å­ï¼šåœ¨å›¾ä¸­ï¼Œå‘½ä»¤sudo jstat -gc 309 1000 5ä»£è¡¨ç€ï¼šæœé›†vidä¸º309çš„javaè¿›ç¨‹çš„æ•´ä½“gcçŠ¶æ€ï¼Œ æ¯1000msæ”¶é›†ä¸€æ¬¡ï¼Œå…±æ”¶é›†5æ¬¡ï¼›XXXCè¡¨ç¤ºè¯¥åŒºå®¹é‡ï¼ŒXXXUè¡¨ç¤ºè¯¥åŒºä½¿ç”¨é‡ï¼Œå„åˆ—è§£é‡Šå¦‚ä¸‹ï¼šS0Cï¼šS0åŒºå®¹é‡ï¼ˆS1åŒºç›¸åŒï¼Œç•¥ï¼‰S0Uï¼šS0åŒºå·²ä½¿ç”¨ECï¼šEåŒºå®¹é‡EUï¼šEåŒºå·²ä½¿ç”¨OCï¼šè€å¹´ä»£å®¹é‡OUï¼šè€å¹´ä»£å·²ä½¿ç”¨PCï¼šPermå®¹é‡PUï¼šPermåŒºå·²ä½¿ç”¨YGCï¼šYoung GCï¼ˆMinor GCï¼‰æ¬¡æ•°YGCTï¼šYoung GCæ€»è€—æ—¶FGCï¼šFull GCæ¬¡æ•°FGCTï¼šFull GCæ€»è€—æ—¶GCTï¼šGCæ€»è€—æ—¶ ç”¨gcutilæŸ¥çœ‹å†…å­˜çš„ä¾‹å­ï¼šå›¾ä¸­çš„å„åˆ—ä¸Žç”¨gcå‚æ•°æ—¶åŸºæœ¬ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯å·²å ç”¨çš„ç™¾åˆ†æ¯”ï¼Œå¦‚S0ä¸º86.53ï¼Œä»£è¡¨ç€S0åŒºå·²ä½¿ç”¨äº†86.53% jinfoç”¨äºŽæŸ¥è¯¢å½“å‰è¿è¡Œè¿™çš„JVMå±žæ€§å’Œå‚æ•°çš„å€¼ã€‚jinfoå¯ä»¥ä½¿ç”¨å¦‚ä¸‹é€‰é¡¹ï¼š -flag:æ˜¾ç¤ºæœªè¢«æ˜¾ç¤ºæŒ‡å®šçš„å‚æ•°çš„ç³»ç»Ÿé»˜è®¤å€¼ -flag [+|-]nameæˆ–-flag name=value: ä¿®æ”¹éƒ¨åˆ†å‚æ•° -sysprops:æ‰“å°è™šæ‹Ÿæœºè¿›ç¨‹çš„System.getProperties() å‘½ä»¤æ ¼å¼:jinfo [option] pid jmapç”¨äºŽæ˜¾ç¤ºå½“å‰Javaå †å’Œæ°¸ä¹…ä»£çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚å½“å‰ä½¿ç”¨çš„æ”¶é›†å™¨ï¼Œå½“å‰çš„ç©ºé—´ä½¿ç”¨çŽ‡ç­‰ï¼‰ -dump:ç”Ÿæˆjavaå †è½¬å‚¨å¿«ç…§ -heap:æ˜¾ç¤ºjavaå †è¯¦ç»†ä¿¡æ¯(åªåœ¨Linux/Solarisä¸‹æœ‰æ•ˆ) -F:å½“è™šæ‹Ÿæœºè¿›ç¨‹å¯¹-dumpé€‰é¡¹æ²¡æœ‰å“åº”æ—¶ï¼Œå¯ä½¿ç”¨è¿™ä¸ªé€‰é¡¹å¼ºåˆ¶ç”Ÿæˆdumpå¿«ç…§(åªåœ¨Linux/Solarisä¸‹æœ‰æ•ˆ) -finalizerinfo:æ˜¾ç¤ºåœ¨F-Queueä¸­ç­‰å¾…Finalizerçº¿ç¨‹æ‰§è¡Œfinalizeæ–¹æ³•çš„å¯¹è±¡(åªåœ¨Linux/Solarisä¸‹æœ‰æ•ˆ) -histo:æ˜¾ç¤ºå †ä¸­å¯¹è±¡ç»Ÿè®¡ä¿¡æ¯ -permstat:ä»¥ClassLoaderä¸ºç»Ÿè®¡å£å¾„æ˜¾ç¤ºæ°¸ä¹…ä»£å†…å­˜çŠ¶æ€(åªåœ¨Linux/Solarisä¸‹æœ‰æ•ˆ) å‘½ä»¤æ ¼å¼:jmap [option] vmidå…¶ä¸­å‰é¢3ä¸ªå‚æ•°æœ€é‡è¦ï¼Œå¦‚ï¼šæŸ¥çœ‹å¯¹è¯¦ç»†ä¿¡æ¯ï¼šsudo jmap -heap 309ç”Ÿæˆdumpæ–‡ä»¶ï¼š sudo jmap -dump:file=./test.prof 309éƒ¨åˆ†ç”¨æˆ·æ²¡æœ‰æƒé™æ—¶ï¼Œé‡‡ç”¨adminç”¨æˆ·ï¼šsudo -u admin -H jmap -dump:format=b,file=æ–‡ä»¶å.hprof pidæŸ¥çœ‹å½“å‰å †ä¸­å¯¹è±¡ç»Ÿè®¡ä¿¡æ¯ï¼šsudo jmap -histo 309ï¼šè¯¥å‘½ä»¤æ˜¾ç¤º3åˆ—ï¼Œåˆ†åˆ«ä¸ºå¯¹è±¡æ•°é‡ï¼Œå¯¹è±¡å¤§å°ï¼Œå¯¹è±¡åç§°ï¼Œé€šè¿‡è¯¥å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ˜¯å¦å†…å­˜ä¸­æœ‰å¤§å¯¹è±¡ï¼›æœ‰çš„ç”¨æˆ·å¯èƒ½æ²¡æœ‰jmapæƒé™ï¼šsudo -u admin -H jmap -histo 309 | less jhatç”¨äºŽåˆ†æžä½¿ç”¨jmapç”Ÿæˆçš„dumpæ–‡ä»¶ï¼Œæ˜¯JDKè‡ªå¸¦çš„å·¥å…·ï¼Œä½¿ç”¨æ–¹æ³•ä¸ºï¼šjhat -J -Xmx512m [file]ä¸è¿‡jhatæ²¡æœ‰matå¥½ç”¨ï¼ŒæŽ¨èä½¿ç”¨matï¼ˆEclipseæ’ä»¶ï¼š http://www.eclipse.org/mat ï¼‰ï¼Œmaté€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸”æ˜¯å›¾å½¢ç•Œé¢ã€‚ jstackç”¨äºŽç”Ÿæˆå½“å‰JVMçš„æ‰€æœ‰çº¿ç¨‹å¿«ç…§ï¼Œçº¿ç¨‹å¿«ç…§æ˜¯è™šæ‹Ÿæœºæ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•,ç›®çš„æ˜¯å®šä½çº¿ç¨‹å‡ºçŽ°é•¿æ—¶é—´åœé¡¿çš„åŽŸå› ã€‚ -F:å½“æ­£å¸¸è¾“å‡ºçš„è¯·æ±‚ä¸è¢«å“åº”æ—¶ï¼Œå¼ºåˆ¶è¾“å‡ºçº¿ç¨‹å †æ ˆ -l:é™¤å †æ ˆå¤–ï¼Œæ˜¾ç¤ºå…³äºŽé”çš„é™„åŠ ä¿¡æ¯ -m:å¦‚æžœè°ƒç”¨åˆ°æœ¬åœ°æ–¹æ³•çš„è¯ï¼Œå¯ä»¥æ˜¾ç¤ºC/C++çš„å †æ ˆå‘½ä»¤æ ¼å¼:jstack [option] vmid -verbosegc-verbosegcæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å¯åŠ¨å‚æ•°ï¼Œè®°å½•æ¯æ¬¡gcçš„æ—¥å¿—ï¼Œä¸‹é¢çš„è¡¨æ ¼å¯¹æ¯”äº†jstatå’Œ-verbosegcï¼š jstat -verbosegc ç›‘æŽ§å¯¹è±¡ è¿è¡Œåœ¨æœ¬æœºçš„Javaåº”ç”¨å¯ä»¥æŠŠæ—¥å¿—è¾“å‡ºåˆ°ç»ˆç«¯ä¸Šï¼Œæˆ–è€…å€ŸåŠ©jstatdå‘½ä»¤é€šè¿‡ç½‘ç»œè¿žæŽ¥è¿œç¨‹çš„Javaåº”ç”¨ã€‚ åªæœ‰é‚£äº›æŠŠ-verbogcä½œä¸ºå¯åŠ¨å‚æ•°çš„JVMã€‚ è¾“å‡ºä¿¡æ¯ å †çŠ¶æ€ï¼ˆå·²ç”¨ç©ºé—´ï¼Œæœ€å¤§é™åˆ¶ï¼ŒGCæ‰§è¡Œæ¬¡æ•°/æ—¶é—´ï¼Œç­‰ç­‰ï¼‰ æ‰§è¡ŒGCå‰åŽæ–°ç”Ÿä»£å’Œè€å¹´ä»£ç©ºé—´å¤§å°ï¼ŒGCæ‰§è¡Œæ—¶é—´ã€‚ è¾“å‡ºæ—¶é—´ Every designated timeæ¯æ¬¡è®¾å®šå¥½çš„æ—¶é—´ã€‚ æ¯æ¬¡GCå‘ç”Ÿçš„æ—¶å€™ã€‚ ç”¨é€” è§‚å¯Ÿå †ç©ºé—´å˜åŒ–æƒ…å†µ äº†è§£å•æ¬¡GCäº§ç”Ÿçš„æ•ˆæžœã€‚ ä¸Ž-verbosegcé…åˆä½¿ç”¨çš„ä¸€äº›å¸¸ç”¨å‚æ•°ä¸ºï¼š -XX:+PrintGCDetailsï¼Œæ‰“å°GCä¿¡æ¯ï¼Œè¿™æ˜¯-verbosegcé»˜è®¤å¼€å¯çš„é€‰é¡¹ -XX:+PrintGCTimeStampsï¼Œæ‰“å°æ¯æ¬¡GCçš„æ—¶é—´æˆ³ -XX:+PrintHeapAtGCï¼šæ¯æ¬¡GCæ—¶ï¼Œæ‰“å°å †ä¿¡æ¯ -XX:+PrintGCDateStamps (from JDK 6 update 4) ï¼šæ‰“å°GCæ—¥æœŸï¼Œé€‚åˆäºŽé•¿æœŸè¿è¡Œçš„æœåŠ¡å™¨ -Xloggc:/home/admin/logs/gc.logï¼šåˆ¶å®šæ‰“å°ä¿¡æ¯çš„è®°å½•çš„æ—¥å¿—ä½ç½®æ¯æ¡verbosegcæ‰“å°å‡ºçš„gcæ—¥å¿—ï¼Œéƒ½ç±»ä¼¼äºŽä¸‹é¢çš„æ ¼å¼ï¼štime [GC [&lt;collector&gt;: &lt;starting occupancy1&gt; -&gt; &lt;ending occupancy1&gt;(total occupancy1), &lt;pause time1&gt; secs] &lt;starting occupancy3&gt; -&gt; &lt;ending occupancy3&gt;(total occupancy3), &lt;pause time3&gt; secs]å¦‚ï¼šè¿™äº›é€‰é¡¹çš„æ„ä¹‰æ˜¯ï¼štimeï¼šæ‰§è¡ŒGCçš„æ—¶é—´ï¼Œéœ€è¦æ·»åŠ -XX:+PrintGCDateStampså‚æ•°æ‰æœ‰ï¼›collectorï¼šminor gcä½¿ç”¨çš„æ”¶é›†å™¨çš„åå­—ã€‚starting occupancy1ï¼šGCæ‰§è¡Œå‰æ–°ç”Ÿä»£ç©ºé—´å¤§å°ã€‚ending occupancy1ï¼šGCæ‰§è¡ŒåŽæ–°ç”Ÿä»£ç©ºé—´å¤§å°ã€‚total occupancy1ï¼šæ–°ç”Ÿä»£æ€»å¤§å°pause time1ï¼šå› ä¸ºæ‰§è¡Œminor GCï¼ŒJavaåº”ç”¨æš‚åœçš„æ—¶é—´ã€‚starting occupancy3ï¼šGCæ‰§è¡Œå‰å †åŒºåŸŸæ€»å¤§å°ending occupancy3ï¼šGCæ‰§è¡ŒåŽå †åŒºåŸŸæ€»å¤§å°total occupancy3ï¼šå †åŒºæ€»å¤§å°pause time3ï¼šJavaåº”ç”¨ç”±äºŽæ‰§è¡Œå †ç©ºé—´GCï¼ˆåŒ…æ‹¬full GCï¼‰è€Œåœæ­¢çš„æ—¶é—´ã€‚ å¯è§†åŒ–å·¥å…·ç›‘æŽ§å’Œåˆ†æžGCä¹Ÿæœ‰ä¸€äº›å¯è§†åŒ–å·¥å…·ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰JConsoleå’ŒVisualVM JConsoleJConsoleå·¥å…·åœ¨JDK/binç›®å½•ä¸‹ï¼Œå¯åŠ¨JConsoleåŽï¼Œå°†è‡ªåŠ¨æœç´¢æœ¬æœºè¿è¡Œçš„jvmè¿›ç¨‹ï¼Œä¸éœ€è¦jpså‘½ä»¤æ¥æŸ¥è¯¢æŒ‡å®šã€‚åŒå‡»å…¶ä¸­ä¸€ä¸ªjvmè¿›ç¨‹å³å¯å¼€å§‹ç›‘æŽ§ï¼Œä¹Ÿå¯ä½¿ç”¨â€œè¿œç¨‹è¿›ç¨‹â€æ¥è¿žæŽ¥è¿œç¨‹æœåŠ¡å™¨ã€‚è¿›å…¥JConsoleä¸»ç•Œé¢ï¼Œæœ‰â€œæ¦‚è¿°â€ã€â€œå†…å­˜â€ã€â€œçº¿ç¨‹â€ã€â€œç±»â€ã€â€œVMæ‘˜è¦â€å’Œâ€Mbeanâ€å…­ä¸ªé¡µç­¾ï¼šå†…å­˜é¡µç­¾ç›¸å½“äºŽjstatå‘½ä»¤ï¼Œç”¨äºŽç›‘è§†æ”¶é›†å™¨ç®¡ç†çš„è™šæ‹Ÿæœºå†…å­˜(Javaå †å’Œæ°¸ä¹…ä»£)å˜åŒ–è¶‹åŠ¿ï¼Œè¿˜å¯åœ¨è¯¦ç»†ä¿¡æ¯æ è§‚å¯Ÿå…¨éƒ¨GCæ‰§è¡Œçš„æ—¶é—´åŠæ¬¡æ•°ã€‚çº¿ç¨‹é¡µç­¾æœ€åŽä¸€ä¸ªå¸¸ç”¨é¡µç­¾ï¼ŒVMé¡µç­¾ï¼Œå¯æ¸…æ¥šçš„äº†è§£æ˜¾ç¤ºæŒ‡å®šçš„JVMå‚æ•°åŠå †ä¿¡æ¯ã€‚ VisualVMVisualVMæ˜¯ä¸€ä¸ªé›†æˆå¤šä¸ªJDKå‘½ä»¤è¡Œå·¥å…·çš„å¯è§†åŒ–å·¥å…·ã€‚VisualVMåŸºäºŽNetBeanså¹³å°å¼€å‘ï¼Œå®ƒå…·å¤‡äº†æ’ä»¶æ‰©å±•åŠŸèƒ½çš„ç‰¹æ€§ï¼Œé€šè¿‡æ’ä»¶çš„æ‰©å±•ï¼Œå¯ç”¨äºŽæ˜¾ç¤ºè™šæ‹Ÿæœºè¿›ç¨‹åŠè¿›ç¨‹çš„é…ç½®å’ŒçŽ¯å¢ƒä¿¡æ¯(jpsï¼Œjinfo)ï¼Œç›‘è§†åº”ç”¨ç¨‹åºçš„CPUã€GCã€å †ã€æ–¹æ³•åŒºåŠçº¿ç¨‹çš„ä¿¡æ¯(jstatã€jstack)ç­‰ã€‚VisualVMåœ¨JDK/binç›®å½•ä¸‹ã€‚å®‰è£…æ’ä»¶ï¼š å·¥å…·- æ’ä»¶VisualVMä¸»ç•Œé¢åœ¨VisualVMä¸­ç”Ÿæˆdumpæ–‡ä»¶ï¼š è°ƒä¼˜æ–¹æ³•ä¸€åˆ‡éƒ½æ˜¯ä¸ºäº†è¿™ä¸€æ­¥ï¼Œè°ƒä¼˜ï¼Œåœ¨è°ƒä¼˜ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½ä¸‹é¢çš„åŽŸåˆ™ï¼š å¤šæ•°çš„Javaåº”ç”¨ä¸éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šè¿›è¡ŒGCä¼˜åŒ–ï¼› å¤šæ•°å¯¼è‡´GCé—®é¢˜çš„Javaåº”ç”¨ï¼Œéƒ½ä¸æ˜¯å› ä¸ºæˆ‘ä»¬å‚æ•°è®¾ç½®é”™è¯¯ï¼Œè€Œæ˜¯ä»£ç é—®é¢˜ï¼› åœ¨åº”ç”¨ä¸Šçº¿ä¹‹å‰ï¼Œå…ˆè€ƒè™‘å°†æœºå™¨çš„JVMå‚æ•°è®¾ç½®åˆ°æœ€ä¼˜ï¼ˆæœ€é€‚åˆï¼‰ï¼› å‡å°‘åˆ›å»ºå¯¹è±¡çš„æ•°é‡ï¼› å‡å°‘ä½¿ç”¨å…¨å±€å˜é‡å’Œå¤§å¯¹è±¡ï¼› GCä¼˜åŒ–æ˜¯åˆ°æœ€åŽä¸å¾—å·²æ‰é‡‡ç”¨çš„æ‰‹æ®µï¼› åœ¨å®žé™…ä½¿ç”¨ä¸­ï¼Œåˆ†æžGCæƒ…å†µä¼˜åŒ–ä»£ç æ¯”ä¼˜åŒ–GCå‚æ•°è¦å¤šå¾—å¤šï¼› GCä¼˜åŒ–çš„ç›®çš„æœ‰ä¸¤ä¸ª: å°†è½¬ç§»åˆ°è€å¹´ä»£çš„å¯¹è±¡æ•°é‡é™ä½Žåˆ°æœ€å°ï¼› å‡å°‘full GCçš„æ‰§è¡Œæ—¶é—´ï¼› ä¸ºäº†è¾¾åˆ°ä¸Šé¢çš„ç›®çš„ï¼Œä¸€èˆ¬åœ°ï¼Œä½ éœ€è¦åšçš„äº‹æƒ…æœ‰ï¼š å‡å°‘ä½¿ç”¨å…¨å±€å˜é‡å’Œå¤§å¯¹è±¡ï¼› è°ƒæ•´æ–°ç”Ÿä»£çš„å¤§å°åˆ°æœ€åˆé€‚ï¼› è®¾ç½®è€å¹´ä»£çš„å¤§å°ä¸ºæœ€åˆé€‚ï¼› é€‰æ‹©åˆé€‚çš„GCæ”¶é›†å™¨ï¼› åœ¨ä¸Šé¢çš„4æ¡æ–¹æ³•ä¸­ï¼Œç”¨äº†å‡ ä¸ªâ€œåˆé€‚â€ï¼Œé‚£ç©¶ç«Ÿä»€ä¹ˆæ‰ç®—åˆé€‚ï¼Œä¸€èˆ¬çš„ï¼Œè¯·å‚è€ƒä¸Šé¢â€œæ”¶é›†å™¨æ­é…â€å’Œâ€œå¯åŠ¨å†…å­˜åˆ†é…â€ä¸¤èŠ‚ä¸­çš„å»ºè®®ã€‚ä½†è¿™äº›å»ºè®®ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œéœ€è¦æ ¹æ®æ‚¨çš„æœºå™¨å’Œåº”ç”¨æƒ…å†µè¿›è¡Œå‘å±•å’Œå˜åŒ–ï¼Œå®žé™…æ“ä½œä¸­ï¼Œå¯ä»¥å°†ä¸¤å°æœºå™¨åˆ†åˆ«è®¾ç½®æˆä¸åŒçš„GCå‚æ•°ï¼Œå¹¶ä¸”è¿›è¡Œå¯¹æ¯”ï¼Œé€‰ç”¨é‚£äº›ç¡®å®žæé«˜äº†æ€§èƒ½æˆ–å‡å°‘äº†GCæ—¶é—´çš„å‚æ•°ã€‚çœŸæ­£ç†Ÿç»ƒçš„ä½¿ç”¨GCè°ƒä¼˜ï¼Œæ˜¯å»ºç«‹åœ¨å¤šæ¬¡è¿›è¡ŒGCç›‘æŽ§å’Œè°ƒä¼˜çš„å®žæˆ˜ç»éªŒä¸Šçš„ï¼Œè¿›è¡Œç›‘æŽ§å’Œè°ƒä¼˜çš„ä¸€èˆ¬æ­¥éª¤ä¸ºï¼š ç›‘æŽ§GCçš„çŠ¶æ€ä½¿ç”¨å„ç§JVMå·¥å…·ï¼ŒæŸ¥çœ‹å½“å‰æ—¥å¿—ï¼Œåˆ†æžå½“å‰JVMå‚æ•°è®¾ç½®ï¼Œå¹¶ä¸”åˆ†æžå½“å‰å †å†…å­˜å¿«ç…§å’Œgcæ—¥å¿—ï¼Œæ ¹æ®å®žé™…çš„å„åŒºåŸŸå†…å­˜åˆ’åˆ†å’ŒGCæ‰§è¡Œæ—¶é—´ï¼Œè§‰å¾—æ˜¯å¦è¿›è¡Œä¼˜åŒ–ï¼› åˆ†æžç»“æžœï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦ä¼˜åŒ–å¦‚æžœå„é¡¹å‚æ•°è®¾ç½®åˆç†ï¼Œç³»ç»Ÿæ²¡æœ‰è¶…æ—¶æ—¥å¿—å‡ºçŽ°ï¼ŒGCé¢‘çŽ‡ä¸é«˜ï¼ŒGCè€—æ—¶ä¸é«˜ï¼Œé‚£ä¹ˆæ²¡æœ‰å¿…è¦è¿›è¡ŒGCä¼˜åŒ–ï¼›å¦‚æžœGCæ—¶é—´è¶…è¿‡1-3ç§’ï¼Œæˆ–è€…é¢‘ç¹GCï¼Œåˆ™å¿…é¡»ä¼˜åŒ–ï¼›æ³¨ï¼šå¦‚æžœæ»¡è¶³ä¸‹é¢çš„æŒ‡æ ‡ï¼Œåˆ™ä¸€èˆ¬ä¸éœ€è¦è¿›è¡ŒGCï¼š Minor GCæ‰§è¡Œæ—¶é—´ä¸åˆ°50msï¼› Minor GCæ‰§è¡Œä¸é¢‘ç¹ï¼Œçº¦10ç§’ä¸€æ¬¡ï¼› Full GCæ‰§è¡Œæ—¶é—´ä¸åˆ°1sï¼› Full GCæ‰§è¡Œé¢‘çŽ‡ä¸ç®—é¢‘ç¹ï¼Œä¸ä½ŽäºŽ10åˆ†é’Ÿ1æ¬¡ï¼› è°ƒæ•´GCç±»åž‹å’Œå†…å­˜åˆ†é…å¦‚æžœå†…å­˜åˆ†é…è¿‡å¤§æˆ–è¿‡å°ï¼Œæˆ–è€…é‡‡ç”¨çš„GCæ”¶é›†å™¨æ¯”è¾ƒæ…¢ï¼Œåˆ™åº”è¯¥ä¼˜å…ˆè°ƒæ•´è¿™äº›å‚æ•°ï¼Œå¹¶ä¸”å…ˆæ‰¾1å°æˆ–å‡ å°æœºå™¨è¿›è¡Œbetaï¼Œç„¶åŽæ¯”è¾ƒä¼˜åŒ–è¿‡çš„æœºå™¨å’Œæ²¡æœ‰ä¼˜åŒ–çš„æœºå™¨çš„æ€§èƒ½å¯¹æ¯”ï¼Œå¹¶æœ‰é’ˆå¯¹æ€§çš„åšå‡ºæœ€åŽé€‰æ‹©ï¼› ä¸æ–­çš„åˆ†æžå’Œè°ƒæ•´é€šè¿‡ä¸æ–­çš„è¯•éªŒå’Œè¯•é”™ï¼Œåˆ†æžå¹¶æ‰¾åˆ°æœ€åˆé€‚çš„å‚æ•° å…¨é¢åº”ç”¨å‚æ•°å¦‚æžœæ‰¾åˆ°äº†æœ€åˆé€‚çš„å‚æ•°ï¼Œåˆ™å°†è¿™äº›å‚æ•°åº”ç”¨åˆ°æ‰€æœ‰æœåŠ¡å™¨ï¼Œå¹¶è¿›è¡ŒåŽç»­è·Ÿè¸ªã€‚ è°ƒä¼˜å®žä¾‹ä¸Šé¢çš„å†…å®¹éƒ½æ˜¯çº¸ä¸Šè°ˆå…µï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ä¸€äº›çœŸå®žä¾‹å­æ¥è¿›è¡Œè¯´æ˜Žï¼š å®žä¾‹1ç¬”è€…æ˜¨æ—¥å‘çŽ°éƒ¨åˆ†å¼€å‘æµ‹è¯•æœºå™¨å‡ºçŽ°å¼‚å¸¸ï¼šjava.lang.OutOfMemoryError: GC overhead limit exceededï¼Œè¿™ä¸ªå¼‚å¸¸ä»£è¡¨ï¼šGCä¸ºäº†é‡Šæ”¾å¾ˆå°çš„ç©ºé—´å´è€—è´¹äº†å¤ªå¤šçš„æ—¶é—´ï¼Œå…¶åŽŸå› ä¸€èˆ¬æœ‰ä¸¤ä¸ªï¼š1ï¼Œå †å¤ªå°ï¼Œ2ï¼Œæœ‰æ­»å¾ªçŽ¯æˆ–å¤§å¯¹è±¡ï¼›ç¬”è€…é¦–å…ˆæŽ’é™¤äº†ç¬¬2ä¸ªåŽŸå› ï¼Œå› ä¸ºè¿™ä¸ªåº”ç”¨åŒæ—¶æ˜¯åœ¨çº¿ä¸Šè¿è¡Œçš„ï¼Œå¦‚æžœæœ‰é—®é¢˜ï¼Œæ—©å°±æŒ‚äº†ã€‚æ‰€ä»¥æ€€ç–‘æ˜¯è¿™å°æœºå™¨ä¸­å †è®¾ç½®å¤ªå°ï¼›ä½¿ç”¨ps -ef |grep &quot;java&quot;æŸ¥çœ‹ï¼Œå‘çŽ°ï¼šè¯¥åº”ç”¨çš„å †åŒºè®¾ç½®åªæœ‰768mï¼Œè€Œæœºå™¨å†…å­˜æœ‰2gï¼Œæœºå™¨ä¸Šåªè·‘è¿™ä¸€ä¸ªjavaåº”ç”¨ï¼Œæ²¡æœ‰å…¶ä»–éœ€è¦å ç”¨å†…å­˜çš„åœ°æ–¹ã€‚å¦å¤–ï¼Œè¿™ä¸ªåº”ç”¨æ¯”è¾ƒå¤§ï¼Œéœ€è¦å ç”¨çš„å†…å­˜ä¹Ÿæ¯”è¾ƒå¤šï¼›ç¬”è€…é€šè¿‡ä¸Šé¢çš„æƒ…å†µåˆ¤æ–­ï¼Œåªéœ€è¦æ”¹å˜å †ä¸­å„åŒºåŸŸçš„å¤§å°è®¾ç½®å³å¯ï¼ŒäºŽæ˜¯æ”¹æˆä¸‹é¢çš„æƒ…å†µï¼šè·Ÿè¸ªè¿è¡Œæƒ…å†µå‘çŽ°ï¼Œç›¸å…³å¼‚å¸¸æ²¡æœ‰å†å‡ºçŽ°ï¼› å®žä¾‹2ä¸€ä¸ªæœåŠ¡ç³»ç»Ÿï¼Œç»å¸¸å‡ºçŽ°å¡é¡¿ï¼Œåˆ†æžåŽŸå› ï¼Œå‘çŽ°Full GCæ—¶é—´å¤ªé•¿ï¼š123jstat -gcutil:S0 S1 E O P YGC YGCT FGC FGCT GCT12.16 0.00 5.18 63.78 20.32 54 2.047 5 6.946 8.993 åˆ†æžä¸Šé¢çš„æ•°æ®ï¼Œå‘çŽ°Young GCæ‰§è¡Œäº†54æ¬¡ï¼Œè€—æ—¶2.047ç§’ï¼Œæ¯æ¬¡Young GCè€—æ—¶37msï¼Œåœ¨æ­£å¸¸èŒƒå›´ï¼Œè€ŒFull GCæ‰§è¡Œäº†5æ¬¡ï¼Œè€—æ—¶6.946ç§’ï¼Œæ¯æ¬¡å¹³å‡1.389sï¼Œæ•°æ®æ˜¾ç¤ºå‡ºæ¥çš„é—®é¢˜æ˜¯ï¼šFull GCè€—æ—¶è¾ƒé•¿ï¼Œåˆ†æžè¯¥ç³»ç»Ÿçš„æ˜¯æŒ‡å‘çŽ°ï¼ŒNewRatio=9ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ–°ç”Ÿä»£å’Œè€ç”Ÿä»£å¤§å°ä¹‹æ¯”ä¸º1:9ï¼Œè¿™å°±æ˜¯é—®é¢˜çš„åŽŸå› ï¼š æ–°ç”Ÿä»£å¤ªå°ï¼Œå¯¼è‡´å¯¹è±¡æå‰è¿›å…¥è€å¹´ä»£ï¼Œè§¦å‘è€å¹´ä»£å‘ç”ŸFull GCï¼› è€å¹´ä»£è¾ƒå¤§ï¼Œè¿›è¡ŒFull GCæ—¶è€—æ—¶è¾ƒå¤§ï¼›ä¼˜åŒ–çš„æ–¹æ³•æ˜¯è°ƒæ•´NewRatioçš„å€¼ï¼Œè°ƒæ•´åˆ°4ï¼Œå‘çŽ°Full GCæ²¡æœ‰å†å‘ç”Ÿï¼Œåªæœ‰Young GCåœ¨æ‰§è¡Œã€‚è¿™å°±æ˜¯æŠŠå¯¹è±¡æŽ§åˆ¶åœ¨æ–°ç”Ÿä»£å°±æ¸…ç†æŽ‰ï¼Œæ²¡æœ‰è¿›å…¥è€å¹´ä»£ï¼ˆè¿™ç§åšæ³•å¯¹ä¸€äº›åº”ç”¨æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä½†å¹¶ä¸æ˜¯å¯¹æ‰€æœ‰åº”ç”¨éƒ½è¦è¿™ä¹ˆåšï¼‰ å®žä¾‹3ä¸€åº”ç”¨åœ¨æ€§èƒ½æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘çŽ°å†…å­˜å ç”¨çŽ‡å¾ˆé«˜ï¼ŒFull GCé¢‘ç¹ï¼Œä½¿ç”¨sudo -u admin -H jmap -dump:format=b,file=æ–‡ä»¶å.hprof pidæ¥dumpå†…å­˜ï¼Œç”Ÿæˆdumpæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨Eclipseä¸‹çš„matå·®è·è¿›è¡Œåˆ†æžï¼Œå‘çŽ°ï¼šä»Žå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªçº¿ç¨‹å­˜åœ¨é—®é¢˜ï¼Œé˜Ÿåˆ—LinkedBlockingQueueæ‰€å¼•ç”¨çš„å¤§é‡å¯¹è±¡å¹¶æœªé‡Šæ”¾ï¼Œå¯¼è‡´æ•´ä¸ªçº¿ç¨‹å ç”¨å†…å­˜é«˜è¾¾378mï¼Œæ­¤æ—¶é€šçŸ¥å¼€å‘äººå‘˜è¿›è¡Œä»£ç ä¼˜åŒ–ï¼Œå°†ç›¸å…³å¯¹è±¡é‡Šæ”¾æŽ‰å³å¯ã€‚ å‚è€ƒ http://www.cnblogs.com/zhguang/p/Java-JVM-GC.html]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[javaçš„å†…å­˜åˆ†é…å’Œå›žæ”¶]]></title>
    <url>%2F2015%2F08%2F12%2Fjava-memory-gc%2F</url>
    <content type="text"><![CDATA[javaçš„å†…å­˜åˆ†é…å’Œå›žæ”¶ï¼Œä¸»è¦éƒ½åœ¨å †ä¸­åˆ†é…å’Œå›žæ”¶ï¼Œæ‰€ä»¥å †å†…å­˜æ˜¯æœ¬æ–‡è®²è§£çš„é‡ç‚¹ã€‚ Javaå†…å­˜åˆ†é…æœºåˆ¶Javaå†…å­˜åˆ†é…å’Œå›žæ”¶çš„æœºåˆ¶æ¦‚æ‹¬çš„è¯´ï¼Œå°±æ˜¯ï¼šåˆ†ä»£åˆ†é…ï¼Œåˆ†ä»£å›žæ”¶ã€‚å¯¹è±¡å°†æ ¹æ®å­˜æ´»çš„æ—¶é—´è¢«åˆ†ä¸ºï¼šå¹´è½»ä»£ï¼ˆYoung Generationï¼‰ã€å¹´è€ä»£ï¼ˆOld Generationï¼‰ã€æ°¸ä¹…ä»£ï¼ˆPermanent Generationï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•åŒºï¼‰ã€‚å¦‚ä¸‹å›¾ å¹´è½»ä»£ï¼ˆYoung Generationï¼‰å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå†…å­˜çš„åˆ†é…é¦–å…ˆå‘ç”Ÿåœ¨å¹´è½»ä»£ï¼ˆå¤§å¯¹è±¡å¯ä»¥ç›´æŽ¥ è¢«åˆ›å»ºåœ¨å¹´è€ä»£ï¼‰ï¼Œå¤§éƒ¨åˆ†çš„å¯¹è±¡åœ¨åˆ›å»ºåŽå¾ˆå¿«å°±ä¸å†ä½¿ç”¨ï¼Œå› æ­¤å¾ˆå¿«å˜å¾—ä¸å¯è¾¾ï¼ŒäºŽæ˜¯è¢«å¹´è½»ä»£çš„GCæœºåˆ¶æ¸…ç†æŽ‰ï¼ˆIBMçš„ç ”ç©¶è¡¨æ˜Žï¼Œ98%çš„å¯¹è±¡éƒ½æ˜¯å¾ˆå¿«æ¶ˆ äº¡çš„ï¼‰ï¼Œè¿™ä¸ªGCæœºåˆ¶è¢«ç§°ä¸ºMinor GCæˆ–å«Young GCã€‚æ³¨æ„ï¼ŒMinor GCå¹¶ä¸ä»£è¡¨å¹´è½»ä»£å†…å­˜ä¸è¶³ï¼Œå®ƒäº‹å®žä¸Šåªè¡¨ç¤ºåœ¨EdenåŒºä¸Šçš„GCã€‚å¹´è½»ä»£ä¸Šçš„å†…å­˜åˆ†é…æ˜¯è¿™æ ·çš„ï¼Œå¹´è½»ä»£å¯ä»¥åˆ†ä¸º3ä¸ªåŒºåŸŸï¼šEdenåŒºå’Œä¸¤ä¸ªå­˜æ´»åŒºï¼ˆSurvivor 0 ã€Survivor 1ï¼‰ã€‚å†…å­˜åˆ†é…è¿‡ç¨‹å¦‚ä¸‹å›¾ ç»å¤§å¤šæ•°åˆšåˆ›å»ºçš„å¯¹è±¡ä¼šè¢«åˆ†é…åœ¨EdenåŒºï¼Œå…¶ä¸­çš„å¤§å¤šæ•°å¯¹è±¡å¾ˆå¿«å°±ä¼šæ¶ˆäº¡ã€‚EdenåŒºæ˜¯è¿žç»­çš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤åœ¨å…¶ä¸Šåˆ†é…å†…å­˜æžå¿«ï¼› å½“EdenåŒºæ»¡çš„æ—¶å€™ï¼Œæ‰§è¡ŒMinor GCï¼Œå°†æ¶ˆäº¡çš„å¯¹è±¡æ¸…ç†æŽ‰ï¼Œå¹¶å°†å‰©ä½™çš„å¯¹è±¡å¤åˆ¶åˆ°ä¸€ä¸ªå­˜æ´»åŒºSurvivor0ï¼ˆæ­¤æ—¶ï¼ŒSurvivor1æ˜¯ç©ºç™½çš„ï¼Œä¸¤ä¸ªSurvivoræ€»æœ‰ä¸€ä¸ªæ˜¯ç©ºç™½çš„ï¼‰ï¼› æ­¤åŽï¼Œæ¯æ¬¡EdenåŒºæ»¡äº†ï¼Œå°±æ‰§è¡Œä¸€æ¬¡Minor GCï¼Œå¹¶å°†å‰©ä½™çš„å¯¹è±¡éƒ½æ·»åŠ åˆ°Survivor0ï¼› å½“Survivor0ä¹Ÿæ»¡çš„æ—¶å€™ï¼Œå°†å…¶ä¸­ä»ç„¶æ´»ç€çš„å¯¹è±¡ç›´æŽ¥å¤åˆ¶åˆ°Survivor1ï¼Œä»¥åŽEdenåŒºæ‰§è¡ŒMinor GCåŽï¼Œå°±å°†å‰©ä½™çš„å¯¹è±¡æ·»åŠ Survivor1ï¼ˆæ­¤æ—¶ï¼ŒSurvivor0æ˜¯ç©ºç™½çš„ï¼‰ã€‚ å½“ä¸¤ä¸ªå­˜æ´»åŒºåˆ‡æ¢äº†å‡ æ¬¡ï¼ˆHotSpotè™šæ‹Ÿæœºé»˜è®¤15æ¬¡ï¼Œç”¨-XX:MaxTenuringThresholdæŽ§åˆ¶ï¼Œå¤§äºŽè¯¥å€¼è¿›å…¥è€å¹´ä»£ï¼‰ä¹‹åŽï¼Œä»ç„¶å­˜æ´»çš„å¯¹è±¡ï¼ˆå…¶å®žåªæœ‰ä¸€å°éƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å¯¹è±¡ï¼‰ï¼Œå°†è¢«å¤åˆ¶åˆ°è€å¹´ä»£ã€‚ ä»Žä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼ŒEdenåŒºæ˜¯è¿žç»­çš„ç©ºé—´ï¼Œä¸”Survivoræ€»æœ‰ä¸€ä¸ªä¸ºç©ºã€‚ç»è¿‡ä¸€æ¬¡GCå’Œå¤åˆ¶ï¼Œä¸€ä¸ªSurvivorä¸­ä¿å­˜ç€å½“å‰è¿˜æ´» ç€çš„å¯¹è±¡ï¼Œè€ŒEdenåŒºå’Œå¦ä¸€ä¸ªSurvivoråŒºçš„å†…å®¹éƒ½ä¸å†éœ€è¦äº†ï¼Œå¯ä»¥ç›´æŽ¥æ¸…ç©ºï¼Œåˆ°ä¸‹ä¸€æ¬¡GCæ—¶ï¼Œä¸¤ä¸ªSurvivorçš„è§’è‰²å†äº’æ¢ã€‚å› æ­¤ï¼Œè¿™ç§æ–¹å¼åˆ†é…å†…å­˜å’Œæ¸…ç†å†…å­˜çš„æ•ˆçŽ‡éƒ½æžé«˜ï¼Œè¿™ç§åžƒåœ¾å›žæ”¶çš„æ–¹å¼å°±æ˜¯è‘—åçš„â€œåœæ­¢-å¤åˆ¶ï¼ˆStop-and-copyï¼‰â€æ¸…ç†æ³•ï¼ˆå°†EdenåŒºå’Œä¸€ä¸ªSurvivorä¸­ä»ç„¶å­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ°å¦ä¸€ä¸ªSurvivorä¸­ï¼‰ï¼Œè¿™ä¸ä»£è¡¨ç€åœæ­¢å¤åˆ¶æ¸…ç†æ³•å¾ˆé«˜æ•ˆï¼Œå…¶å®žï¼Œå®ƒä¹Ÿåªåœ¨è¿™ç§æƒ…å†µä¸‹é«˜æ•ˆï¼Œå¦‚æžœåœ¨è€å¹´ä»£é‡‡ç”¨åœæ­¢å¤åˆ¶ï¼Œåˆ™æŒºæ‚²å‰§çš„ã€‚åœ¨EdenåŒºï¼ŒHotSpotè™šæ‹Ÿæœºä½¿ç”¨äº†ä¸¤ç§æŠ€æœ¯æ¥åŠ å¿«å†…å­˜åˆ†é…ã€‚åˆ†åˆ«æ˜¯bump-the-pointerå’ŒTLABï¼ˆThread-Local Allocation Buffersï¼‰ï¼Œè¿™ä¸¤ç§æŠ€æœ¯çš„åšæ³•åˆ†åˆ«æ˜¯ï¼šç”±äºŽEdenåŒºæ˜¯è¿žç»­çš„ï¼Œå› æ­¤bump-the-pointeræŠ€æœ¯çš„æ ¸å¿ƒå°±æ˜¯è·Ÿè¸ªæœ€åŽåˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨å¯¹è±¡åˆ›å»ºæ—¶ï¼Œåªéœ€è¦æ£€æŸ¥æœ€åŽä¸€ä¸ªå¯¹è±¡åŽé¢æ˜¯å¦æœ‰è¶³å¤Ÿçš„å†…å­˜å³å¯ï¼Œä»Žè€Œå¤§å¤§åŠ å¿«å†…å­˜åˆ†é…é€Ÿåº¦ï¼›è€Œå¯¹äºŽTLABæŠ€æœ¯æ˜¯å¯¹äºŽå¤šçº¿ç¨‹è€Œè¨€çš„ï¼Œå°†EdenåŒºåˆ†ä¸ºè‹¥å¹²æ®µï¼Œæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„ä¸€æ®µï¼Œé¿å…ç›¸äº’å½±å“ã€‚TLABç»“åˆbump-the-pointeræŠ€æœ¯ï¼Œå°†ä¿è¯æ¯ä¸ªçº¿ç¨‹éƒ½ä½¿ç”¨EdenåŒºçš„ä¸€æ®µï¼Œå¹¶å¿«é€Ÿçš„åˆ†é…å†…å­˜ã€‚ å¹´è€ä»£ï¼ˆOld Generationï¼‰å¯¹è±¡å¦‚æžœåœ¨å¹´è½»ä»£å­˜æ´»äº†è¶³å¤Ÿé•¿çš„æ—¶é—´è€Œæ²¡æœ‰è¢«æ¸…ç†æŽ‰ï¼ˆå³åœ¨å‡ æ¬¡ Young GCåŽå­˜æ´»äº†ä¸‹æ¥ï¼‰ï¼Œåˆ™ä¼šè¢«å¤åˆ¶åˆ°å¹´è€ä»£ï¼Œå¹´è€ä»£çš„ç©ºé—´ä¸€èˆ¬æ¯”å¹´è½»ä»£å¤§ï¼Œèƒ½å­˜æ”¾æ›´å¤šçš„å¯¹è±¡ï¼Œåœ¨å¹´è€ä»£ä¸Šå‘ç”Ÿçš„GCæ¬¡æ•°ä¹Ÿæ¯”å¹´è½»ä»£å°‘ã€‚å½“å¹´è€ä»£å†…å­˜ä¸è¶³æ—¶ï¼Œ å°†æ‰§è¡ŒMajor GCï¼Œä¹Ÿå« Full GCã€‚ å¯ä»¥ä½¿ç”¨-XX:+UseAdaptiveSizePolicyå¼€å…³æ¥æŽ§åˆ¶æ˜¯å¦é‡‡ç”¨åŠ¨æ€æŽ§åˆ¶ç­–ç•¥ï¼Œå¦‚æžœåŠ¨æ€æŽ§åˆ¶ï¼Œåˆ™åŠ¨æ€è°ƒæ•´Javaå †ä¸­å„ä¸ªåŒºåŸŸçš„å¤§å°ä»¥åŠè¿›å…¥è€å¹´ä»£çš„å¹´é¾„ã€‚ å¦‚æžœå¯¹è±¡æ¯”è¾ƒå¤§ï¼ˆæ¯”å¦‚é•¿å­—ç¬¦ä¸²æˆ–å¤§æ•°ç»„ï¼‰ï¼ŒYoungç©ºé—´ä¸è¶³ï¼Œåˆ™å¤§å¯¹è±¡ä¼šç›´æŽ¥åˆ†é…åˆ°è€å¹´ä»£ä¸Šï¼ˆå¤§å¯¹è±¡å¯èƒ½è§¦å‘æå‰GCï¼Œåº”å°‘ç”¨ï¼Œæ›´åº”é¿å…ä½¿ç”¨çŸ­å‘½çš„å¤§å¯¹è±¡ï¼‰ã€‚ç”¨-XX:PretenureSizeThresholdæ¥æŽ§åˆ¶ç›´æŽ¥å‡å…¥è€å¹´ä»£çš„å¯¹è±¡å¤§å°ï¼Œå¤§äºŽè¿™ä¸ªå€¼çš„å¯¹è±¡ä¼šç›´æŽ¥åˆ†é…åœ¨è€å¹´ä»£ä¸Šã€‚ å¯èƒ½å­˜åœ¨å¹´è€ä»£å¯¹è±¡å¼•ç”¨æ–°ç”Ÿä»£å¯¹è±¡çš„æƒ…å†µï¼Œå¦‚æžœéœ€è¦æ‰§è¡ŒYoung GCï¼Œåˆ™å¯èƒ½éœ€è¦æŸ¥è¯¢æ•´ä¸ªè€å¹´ä»£ä»¥ç¡®å®šæ˜¯å¦å¯ä»¥æ¸…ç†å›žæ”¶ï¼Œè¿™æ˜¾ç„¶æ˜¯ä½Žæ•ˆçš„ã€‚è§£å†³çš„æ–¹æ³•æ˜¯ï¼Œå¹´è€ä»£ä¸­ç»´æŠ¤ä¸€ä¸ª512 byteçš„å—â€”â€”â€card tableâ€œï¼Œæ‰€æœ‰è€å¹´ä»£å¯¹è±¡å¼•ç”¨æ–°ç”Ÿä»£å¯¹è±¡çš„è®°å½•éƒ½è®°å½•åœ¨è¿™é‡Œã€‚Young GCæ—¶ï¼Œåªè¦æŸ¥è¿™é‡Œå³å¯ï¼Œä¸ç”¨å†åŽ»æŸ¥å…¨éƒ¨è€å¹´ä»£ï¼Œå› æ­¤æ€§èƒ½å¤§å¤§æé«˜ã€‚ Java GCæœºåˆ¶GCæœºåˆ¶çš„åŸºæœ¬ç®—æ³•æ˜¯ï¼šåˆ†ä»£æ”¶é›†ï¼Œè¿™ä¸ªä¸ç”¨èµ˜è¿°ã€‚ä¸‹é¢é˜è¿°æ¯ä¸ªåˆ†ä»£çš„æ”¶é›†æ–¹æ³•ã€‚ å¹´è½»ä»£äº‹å®žä¸Šï¼Œåœ¨ä¸Šä¸€èŠ‚ï¼Œå·²ç»ä»‹ç»äº†æ–°ç”Ÿä»£çš„ä¸»è¦åžƒåœ¾å›žæ”¶æ–¹æ³•ï¼Œåœ¨æ–°ç”Ÿä»£ä¸­ï¼Œä½¿ç”¨â€œåœæ­¢-å¤åˆ¶â€ç®—æ³•è¿›è¡Œæ¸…ç†ï¼Œå°†æ–°ç”Ÿä»£å†…å­˜åˆ†ä¸º2éƒ¨åˆ†ï¼Œ1éƒ¨åˆ† EdenåŒºè¾ƒå¤§ï¼Œ1éƒ¨åˆ†Survivoræ¯”è¾ƒå°ï¼Œå¹¶è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªç­‰é‡çš„éƒ¨åˆ†ã€‚æ¯æ¬¡è¿›è¡Œæ¸…ç†æ—¶ï¼Œå°†EdenåŒºå’Œä¸€ä¸ªSurvivorä¸­ä»ç„¶å­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ° å¦ä¸€ä¸ªSurvivorä¸­ï¼Œç„¶åŽæ¸…ç†æŽ‰Edenå’Œåˆšæ‰çš„Survivorã€‚ è¿™é‡Œä¹Ÿå¯ä»¥å‘çŽ°ï¼Œåœæ­¢å¤åˆ¶ç®—æ³•ä¸­ï¼Œç”¨æ¥å¤åˆ¶çš„ä¸¤éƒ¨åˆ†å¹¶ä¸æ€»æ˜¯ç›¸ç­‰çš„ï¼ˆä¼ ç»Ÿçš„åœæ­¢å¤åˆ¶ç®—æ³•ä¸¤éƒ¨åˆ†å†…å­˜ç›¸ç­‰ï¼Œä½†æ–°ç”Ÿä»£ä¸­ä½¿ç”¨1ä¸ªå¤§çš„EdenåŒºå’Œ2ä¸ªå°çš„SurvivoråŒºæ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼‰ ç”±äºŽç»å¤§éƒ¨åˆ†çš„å¯¹è±¡éƒ½æ˜¯çŸ­å‘½çš„ï¼Œç”šè‡³å­˜æ´»ä¸åˆ°Survivorä¸­ï¼Œæ‰€ä»¥ï¼ŒEdenåŒºä¸ŽSurvivorçš„æ¯”ä¾‹è¾ƒå¤§ï¼ŒHotSpoté»˜è®¤æ˜¯ 8:1ï¼Œå³åˆ†åˆ«å æ–°ç”Ÿä»£çš„80%ï¼Œ10%ï¼Œ10%ã€‚å¦‚æžœä¸€æ¬¡å›žæ”¶ä¸­ï¼ŒSurvivor+Edenä¸­å­˜æ´»ä¸‹æ¥çš„å†…å­˜è¶…è¿‡äº†10%ï¼Œåˆ™éœ€è¦å°†ä¸€éƒ¨åˆ†å¯¹è±¡åˆ†é…åˆ° è€å¹´ä»£ã€‚ç”¨-XX:SurvivorRatioå‚æ•°æ¥é…ç½®EdenåŒºåŸŸSurvivoråŒºçš„å®¹é‡æ¯”å€¼ï¼Œé»˜è®¤æ˜¯8ï¼Œä»£è¡¨Edenï¼šSurvivor1ï¼šSurvivor2=8:1:1. è€å¹´ä»£è€å¹´ä»£å­˜å‚¨çš„å¯¹è±¡æ¯”å¹´è½»ä»£å¤šå¾—å¤šï¼Œè€Œä¸”ä¸ä¹å¤§å¯¹è±¡ï¼Œå¯¹è€å¹´ä»£è¿›è¡Œå†…å­˜æ¸…ç†æ—¶ï¼Œå¦‚æžœä½¿ç”¨åœæ­¢-å¤åˆ¶ç®—æ³•ï¼Œåˆ™ç›¸å½“ä½Žæ•ˆã€‚ä¸€èˆ¬ï¼Œè€å¹´ä»£ç”¨çš„ç®—æ³•æ˜¯æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå³ï¼šæ ‡è®°å‡ºä»ç„¶å­˜æ´»çš„å¯¹è±¡ï¼ˆå­˜åœ¨å¼•ç”¨çš„ï¼‰ï¼Œå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å‘ä¸€ç«¯ç§»åŠ¨ï¼Œä»¥ä¿è¯å†…å­˜çš„è¿žç»­ã€‚åœ¨å‘ç”ŸMinor GCæ—¶ï¼Œè™šæ‹Ÿæœºä¼šæ£€æŸ¥æ¯æ¬¡æ™‹å‡è¿›å…¥è€å¹´ä»£çš„å¤§å°æ˜¯å¦å¤§äºŽè€å¹´ä»£çš„å‰©ä½™ç©ºé—´å¤§å°ï¼Œå¦‚æžœå¤§äºŽï¼Œåˆ™ç›´æŽ¥è§¦å‘ä¸€æ¬¡Full GCï¼Œå¦åˆ™ï¼Œå°±æŸ¥çœ‹æ˜¯å¦è®¾ ç½®äº†-XX:+HandlePromotionFailureï¼ˆå…è®¸æ‹…ä¿å¤±è´¥ï¼‰ï¼Œå¦‚æžœå…è®¸ï¼Œåˆ™åªä¼šè¿›è¡ŒMinorGCï¼Œæ­¤æ—¶å¯ä»¥å®¹å¿å†…å­˜åˆ†é…å¤±è´¥ï¼›å¦‚æžœä¸å…è®¸ï¼Œåˆ™ä»ç„¶è¿›è¡ŒFull GCï¼ˆè¿™ä»£è¡¨ç€å¦‚æžœè®¾ç½®-XX:+HandlePromotionFailureï¼Œåˆ™è§¦å‘MinorGCå°±ä¼šåŒæ—¶è§¦å‘Full GCï¼Œå“ªæ€•è€å¹´ä»£è¿˜æœ‰å¾ˆå¤šå†…å­˜ï¼Œæ‰€ä»¥ï¼Œæœ€å¥½ä¸è¦è¿™æ ·åšï¼‰ã€‚ æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰æ°¸ä¹…ä»£çš„å›žæ”¶æœ‰ä¸¤ç§ï¼šå¸¸é‡æ± ä¸­çš„å¸¸é‡(1.7 å·²ç§»å‡ºæ–¹æ³•åŒº)ï¼Œæ— ç”¨çš„ç±»ä¿¡æ¯ï¼Œå¸¸é‡çš„å›žæ”¶å¾ˆç®€å•ï¼Œæ²¡æœ‰å¼•ç”¨äº†å°±å¯ä»¥è¢«å›žæ”¶ã€‚å¯¹äºŽæ— ç”¨çš„ç±»è¿›è¡Œå›žæ”¶ï¼Œå¿…é¡»ä¿è¯3ç‚¹ï¼š ç±»çš„æ‰€æœ‰å®žä¾‹éƒ½å·²ç»è¢«å›žæ”¶ åŠ è½½ç±»çš„ClassLoaderå·²ç»è¢«å›žæ”¶ ç±»å¯¹è±¡çš„Classå¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨ï¼ˆå³æ²¡æœ‰é€šè¿‡åå°„å¼•ç”¨è¯¥ç±»çš„åœ°æ–¹ï¼‰ æ°¸ä¹…ä»£çš„å›žæ”¶å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œå¯ä»¥é€šè¿‡å‚æ•°æ¥è®¾ç½®æ˜¯å¦å¯¹ç±»è¿›è¡Œå›žæ”¶ã€‚HotSpotæä¾›-Xnoclassgcè¿›è¡ŒæŽ§åˆ¶ä½¿ç”¨-verboseï¼Œ-XX:+TraceClassLoadingã€-XX:+TraceClassUnLoadingå¯ä»¥æŸ¥çœ‹ç±»åŠ è½½å’Œå¸è½½ä¿¡æ¯-verboseã€-XX:+TraceClassLoadingå¯ä»¥åœ¨Productç‰ˆHotSpotä¸­ä½¿ç”¨ï¼›-XX:+TraceClassUnLoadingéœ€è¦fastdebugç‰ˆHotSpotæ”¯æŒ åžƒåœ¾æ”¶é›†å™¨åœ¨GCæœºåˆ¶ä¸­ï¼Œèµ·é‡è¦ä½œç”¨çš„æ˜¯åžƒåœ¾æ”¶é›†å™¨ï¼Œåžƒåœ¾æ”¶é›†å™¨æ˜¯GCçš„å…·ä½“å®žçŽ°ï¼ŒJavaè™šæ‹Ÿæœºè§„èŒƒä¸­å¯¹äºŽåžƒåœ¾æ”¶é›†å™¨æ²¡æœ‰ä»»ä½•è§„å®šï¼Œæ‰€ä»¥ä¸åŒåŽ‚å•†å®žçŽ°çš„åžƒåœ¾ æ”¶é›†å™¨å„ä¸ç›¸åŒï¼ŒHotSpot 1.6ç‰ˆä½¿ç”¨çš„åžƒåœ¾æ”¶é›†å™¨å¦‚ä¸‹å›¾ï¼ˆå›¾æ¥æºäºŽã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ•ˆä¸Žæœ€ä½³å®žçŽ°ã€‹ï¼Œå›¾ä¸­ä¸¤ä¸ªæ”¶é›†å™¨ä¹‹é—´æœ‰è¿žçº¿ï¼Œè¯´æ˜Žå®ƒä»¬å¯ä»¥é…åˆä½¿ç”¨ï¼‰ï¼šåœ¨ä»‹ç»åžƒåœ¾æ”¶é›†å™¨ä¹‹å‰ï¼Œéœ€è¦æ˜Žç¡®ä¸€ç‚¹ï¼Œå°±æ˜¯åœ¨æ–°ç”Ÿä»£é‡‡ç”¨çš„åœæ­¢å¤åˆ¶ç®—æ³•ä¸­ï¼Œâ€œåœ æ­¢ï¼ˆStop-the-worldï¼‰â€çš„æ„ä¹‰æ˜¯åœ¨å›žæ”¶å†…å­˜æ—¶ï¼Œéœ€è¦æš‚åœå…¶ä»–æ‰€ æœ‰çº¿ç¨‹çš„æ‰§è¡Œã€‚è¿™ä¸ªæ˜¯å¾ˆä½Žæ•ˆçš„ï¼ŒçŽ°åœ¨çš„å„ç§æ–°ç”Ÿä»£æ”¶é›†å™¨è¶Šæ¥è¶Šä¼˜åŒ–è¿™ä¸€ç‚¹ï¼Œä½†ä»ç„¶åªæ˜¯å°†åœæ­¢çš„æ—¶é—´å˜çŸ­ï¼Œå¹¶æœªå½»åº•å–æ¶ˆåœæ­¢ã€‚ Serialæ”¶é›†å™¨ï¼šæ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œä½¿ç”¨åœæ­¢å¤åˆ¶ç®—æ³•ï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡ŒGCï¼Œå…¶å®ƒå·¥ä½œçº¿ç¨‹æš‚åœã€‚ä½¿ç”¨-XX:+UseSerialGCå¯ä»¥ä½¿ç”¨Serial+Serial Oldæ¨¡å¼è¿è¡Œè¿›è¡Œå†…å­˜å›žæ”¶ï¼ˆè¿™ä¹Ÿæ˜¯è™šæ‹Ÿæœºåœ¨Clientæ¨¡å¼ä¸‹è¿è¡Œçš„é»˜è®¤å€¼ï¼‰ ParNewæ”¶é›†å™¨ï¼šæ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œä½¿ç”¨åœæ­¢å¤åˆ¶ç®—æ³•ï¼ŒSerialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆï¼Œç”¨å¤šä¸ªçº¿ç¨‹è¿›è¡ŒGCï¼Œå…¶å®ƒå·¥ä½œçº¿ç¨‹æš‚åœï¼Œå…³æ³¨ç¼©çŸ­åžƒåœ¾æ”¶é›†æ—¶é—´ã€‚ä½¿ç”¨-XX:+UseParNewGCå¼€å…³æ¥æŽ§åˆ¶ä½¿ç”¨ParNew+Serial Oldæ”¶é›†å™¨ç»„åˆæ”¶é›†å†…å­˜ï¼›ä½¿ç”¨-XX:ParallelGCThreadsæ¥è®¾ç½®æ‰§è¡Œå†…å­˜å›žæ”¶çš„çº¿ç¨‹æ•°ã€‚ Parallel Scavenge æ”¶é›†å™¨ï¼šæ–°ç”Ÿä»£æ”¶é›†å™¨ï¼Œä½¿ç”¨åœæ­¢å¤åˆ¶ç®—æ³•ï¼Œå…³æ³¨CPUåžåé‡ï¼Œå³è¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´/æ€»æ—¶é—´ï¼Œæ¯”å¦‚ï¼šJVMè¿è¡Œ100åˆ†é’Ÿï¼Œå…¶ä¸­è¿è¡Œç”¨æˆ·ä»£ç 99åˆ†é’Ÿï¼Œåžƒåœ¾æ”¶é›†1åˆ†é’Ÿï¼Œåˆ™åžåé‡æ˜¯99%ï¼Œè¿™ç§æ”¶é›†å™¨èƒ½æœ€é«˜æ•ˆçŽ‡çš„åˆ©ç”¨CPUï¼Œé€‚åˆè¿è¡ŒåŽå°è¿ç®—ï¼ˆå…³æ³¨ç¼©çŸ­åžƒåœ¾æ”¶é›†æ—¶é—´çš„æ”¶é›†å™¨ï¼Œå¦‚CMSï¼Œç­‰å¾…æ—¶é—´å¾ˆå°‘ï¼Œæ‰€ä»¥é€‚åˆç”¨æˆ·äº¤äº’ï¼Œæé«˜ç”¨æˆ·ä½“éªŒï¼‰ã€‚ä½¿ç”¨-XX:+UseParallelGCå¼€å…³æŽ§åˆ¶ä½¿ç”¨ Parallel Scavenge+Serial Oldæ”¶é›†å™¨ç»„åˆå›žæ”¶åžƒåœ¾ï¼ˆè¿™ä¹Ÿæ˜¯åœ¨Serveræ¨¡å¼ä¸‹çš„é»˜è®¤å€¼ï¼‰ï¼›ä½¿ç”¨-XX:GCTimeRatioæ¥è®¾ç½®ç”¨æˆ·æ‰§è¡Œæ—¶é—´å æ€»æ—¶é—´çš„æ¯”ä¾‹ï¼Œé»˜è®¤99ï¼Œå³ 1%çš„æ—¶é—´ç”¨æ¥è¿›è¡Œåžƒåœ¾å›žæ”¶ã€‚ä½¿ç”¨-XX:MaxGCPauseMillisè®¾ç½®GCçš„æœ€å¤§åœé¡¿æ—¶é—´ï¼ˆè¿™ä¸ªå‚æ•°åªå¯¹Parallel Scavengeæœ‰æ•ˆï¼‰ Serial Oldæ”¶é›†å™¨ï¼šè€å¹´ä»£æ”¶é›†å™¨ï¼Œå•çº¿ç¨‹æ”¶é›†å™¨ï¼Œä½¿ç”¨æ ‡è®°æ•´ç†ï¼ˆæ•´ç†çš„æ–¹æ³•æ˜¯Sweepï¼ˆæ¸…ç†ï¼‰å’ŒCompactï¼ˆåŽ‹ç¼©ï¼‰ï¼Œæ¸…ç†æ˜¯å°†åºŸå¼ƒçš„å¯¹è±¡å¹²æŽ‰ï¼Œåªç•™å¹¸å­˜çš„å¯¹è±¡ï¼ŒåŽ‹ç¼©æ˜¯å°†ç§»åŠ¨å¯¹è±¡ï¼Œå°†ç©ºé—´å¡«æ»¡ä¿è¯å†…å­˜åˆ†ä¸º2å—ï¼Œä¸€å—å…¨æ˜¯å¯¹è±¡ï¼Œä¸€å—ç©ºé—²ï¼‰ç®—æ³•ï¼Œä½¿ç”¨å•çº¿ç¨‹è¿›è¡ŒGCï¼Œå…¶å®ƒå·¥ä½œçº¿ç¨‹æš‚åœï¼ˆæ³¨æ„ï¼Œåœ¨è€å¹´ä»£ä¸­è¿›è¡Œæ ‡è®°æ•´ç†ç®—æ³•æ¸…ç†ï¼Œä¹Ÿéœ€è¦æš‚åœå…¶å®ƒçº¿ç¨‹ï¼‰ï¼Œåœ¨JDK1.5ä¹‹å‰ï¼ŒSerial Parallel Oldæ”¶é›†å™¨ï¼šè€å¹´ä»£æ”¶é›†å™¨ï¼Œå¤šçº¿ç¨‹ï¼Œå¤šçº¿ç¨‹æœºåˆ¶ä¸ŽParallel Scavengeå·®ä¸é”™ï¼Œä½¿ç”¨æ ‡è®°æ•´ç†ï¼ˆä¸ŽSerial Oldä¸åŒï¼Œè¿™é‡Œçš„æ•´ç†æ˜¯Summaryï¼ˆæ±‡æ€»ï¼‰å’ŒCompactï¼ˆåŽ‹ç¼©ï¼‰ï¼Œæ±‡æ€»çš„æ„æ€å°±æ˜¯å°†å¹¸å­˜çš„å¯¹è±¡å¤åˆ¶åˆ°é¢„å…ˆå‡†å¤‡å¥½çš„åŒºåŸŸï¼Œè€Œä¸æ˜¯åƒSweepï¼ˆæ¸… ç†ï¼‰é‚£æ ·æ¸…ç†åºŸå¼ƒçš„å¯¹è±¡ï¼‰ç®—æ³•ï¼Œåœ¨Parallel Oldæ‰§è¡Œæ—¶ï¼Œä»ç„¶éœ€è¦æš‚åœå…¶å®ƒçº¿ç¨‹ã€‚Parallel Oldåœ¨å¤šæ ¸è®¡ç®—ä¸­å¾ˆæœ‰ç”¨ã€‚Parallel Oldå‡ºçŽ°åŽï¼ˆJDK 1.6ï¼‰ï¼Œä¸ŽParallel Scavengeé…åˆæœ‰å¾ˆå¥½çš„æ•ˆæžœï¼Œå……åˆ†ä½“çŽ°Parallel Scavengeæ”¶é›†å™¨åžåé‡ä¼˜å…ˆçš„æ•ˆæžœã€‚ä½¿ç”¨-XX:+UseParallelOldGCå¼€å…³æŽ§åˆ¶ä½¿ç”¨Parallel Scavenge +Parallel Oldç»„åˆæ”¶é›†å™¨è¿›è¡Œæ”¶é›†ã€‚ CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨ï¼šè€å¹´ä»£æ”¶é›†å™¨ï¼Œè‡´åŠ›äºŽèŽ·å–æœ€çŸ­å›žæ”¶åœé¡¿æ—¶é—´ï¼Œä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œå¤šçº¿ç¨‹ï¼Œä¼˜ç‚¹æ˜¯å¹¶å‘æ”¶é›†ï¼ˆç”¨æˆ·çº¿ç¨‹å¯ä»¥å’ŒGCçº¿ç¨‹åŒæ—¶å·¥ä½œï¼‰ï¼Œåœé¡¿å°ã€‚ä½¿ç”¨-XX:+UseConcMarkSweepGCè¿›è¡ŒParNew+CMS+Serial Oldè¿›è¡Œå†…å­˜å›žæ”¶ï¼Œä¼˜å…ˆä½¿ç”¨ParNew+CMSï¼ˆåŽŸå› è§åŽé¢ï¼‰ï¼Œå½“ç”¨æˆ·çº¿ç¨‹å†…å­˜ä¸è¶³æ—¶ï¼Œé‡‡ç”¨å¤‡ç”¨æ–¹æ¡ˆSerial Oldæ”¶é›†ã€‚CMSæ”¶é›†çš„æ–¹æ³•æ˜¯ï¼šå…ˆ3æ¬¡æ ‡è®°ï¼Œå†1æ¬¡æ¸…é™¤ï¼Œ3æ¬¡æ ‡è®°ä¸­å‰ä¸¤æ¬¡æ˜¯åˆå§‹æ ‡è®°å’Œé‡æ–°æ ‡è®°ï¼ˆæ­¤æ—¶ä»ç„¶éœ€è¦åœæ­¢ï¼ˆstop the worldï¼‰ï¼‰ï¼Œ åˆå§‹æ ‡è®°ï¼ˆInitial Remarkï¼‰æ˜¯æ ‡è®°GC Rootsèƒ½å…³è”åˆ°çš„å¯¹è±¡ï¼ˆå³æœ‰å¼•ç”¨çš„å¯¹è±¡ï¼‰ï¼Œåœé¡¿æ—¶é—´å¾ˆçŸ­ï¼›å¹¶å‘æ ‡è®°ï¼ˆConcurrent remarkï¼‰æ˜¯æ‰§è¡ŒGC RootsæŸ¥æ‰¾å¼•ç”¨çš„è¿‡ç¨‹ï¼Œä¸éœ€è¦ç”¨æˆ·çº¿ç¨‹åœé¡¿ï¼›é‡æ–°æ ‡è®°ï¼ˆRemarkï¼‰æ˜¯åœ¨åˆå§‹æ ‡è®°å’Œå¹¶å‘æ ‡è®°æœŸé—´ï¼Œæœ‰æ ‡è®°å˜åŠ¨çš„é‚£éƒ¨åˆ†ä»éœ€è¦æ ‡è®°ï¼Œæ‰€ä»¥åŠ ä¸Šè¿™ä¸€éƒ¨åˆ† æ ‡è®°çš„è¿‡ç¨‹ï¼Œåœé¡¿æ—¶é—´æ¯”å¹¶å‘æ ‡è®°å°å¾—å¤šï¼Œä½†æ¯”åˆå§‹æ ‡è®°ç¨é•¿ã€‚åœ¨å®Œæˆæ ‡è®°ä¹‹åŽï¼Œå°±å¼€å§‹å¹¶å‘æ¸…é™¤ï¼Œä¸éœ€è¦ç”¨æˆ·çº¿ç¨‹åœé¡¿ã€‚æ‰€ä»¥åœ¨CMSæ¸…ç†è¿‡ç¨‹ä¸­ï¼Œåªæœ‰åˆå§‹æ ‡è®°å’Œé‡æ–°æ ‡è®°éœ€è¦çŸ­æš‚åœé¡¿ï¼Œå¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤éƒ½ä¸éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œå› æ­¤æ•ˆçŽ‡å¾ˆé«˜ï¼Œå¾ˆé€‚åˆé«˜äº¤äº’çš„åœºåˆã€‚CMSä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå®ƒéœ€è¦æ¶ˆè€—é¢å¤–çš„CPUå’Œå†…å­˜èµ„æºï¼Œåœ¨CPUå’Œå†…å­˜èµ„æºç´§å¼ ï¼ŒCPUè¾ƒå°‘æ—¶ï¼Œä¼šåŠ é‡ç³»ç»Ÿè´Ÿæ‹…ï¼ˆCMSé»˜è®¤å¯åŠ¨çº¿ç¨‹æ•°ä¸º(CPUæ•°é‡+3)/4ï¼‰ã€‚å¦å¤–ï¼Œåœ¨å¹¶å‘æ”¶é›†è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹ä»ç„¶åœ¨è¿è¡Œï¼Œä»ç„¶äº§ç”Ÿå†…å­˜åžƒåœ¾ï¼Œæ‰€ä»¥å¯èƒ½äº§ç”Ÿâ€œæµ®åŠ¨åžƒåœ¾â€ï¼Œæœ¬æ¬¡æ— æ³•æ¸…ç†ï¼Œåªèƒ½ä¸‹ä¸€æ¬¡Full GCæ‰æ¸…ç†ï¼Œå› æ­¤åœ¨GCæœŸé—´ï¼Œéœ€è¦é¢„ç•™è¶³å¤Ÿçš„å†…å­˜ç»™ç”¨æˆ·çº¿ç¨‹ä½¿ç”¨ã€‚æ‰€ä»¥ä½¿ç”¨CMSçš„æ”¶é›†å™¨å¹¶ä¸æ˜¯è€å¹´ä»£æ»¡äº†æ‰è§¦å‘Full GCï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨äº†ä¸€å¤§åŠï¼ˆé»˜è®¤68%ï¼Œå³2/3ï¼Œä½¿ç”¨-XX:CMSInitiatingOccupancyFractionæ¥è®¾ç½®ï¼‰çš„æ—¶å€™å°±è¦è¿›è¡ŒFull GCï¼Œå¦‚æžœç”¨æˆ·çº¿ç¨‹æ¶ˆè€—å†…å­˜ä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œå¯ä»¥é€‚å½“è°ƒé«˜-XX:CMSInitiatingOccupancyFractionä»¥é™ä½ŽGCæ¬¡æ•°ï¼Œæé«˜æ€§èƒ½ï¼Œå¦‚æžœé¢„ç•™çš„ç”¨æˆ·çº¿ç¨‹å†…å­˜ä¸å¤Ÿï¼Œåˆ™ä¼šè§¦å‘Concurrent Mode Failureï¼Œæ­¤æ—¶ï¼Œå°†è§¦å‘å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨Serial Old æ”¶é›†å™¨è¿›è¡Œæ”¶é›†ï¼Œä½†è¿™æ ·åœé¡¿æ—¶é—´å°±é•¿äº†ï¼Œå› æ­¤-XX:CMSInitiatingOccupancyFractionä¸å®œè®¾çš„è¿‡å¤§ã€‚è¿˜æœ‰ï¼ŒCMSé‡‡ç”¨çš„æ˜¯æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œä¼šå¯¼è‡´å†…å­˜ç¢Žç‰‡çš„äº§ç”Ÿï¼Œå¯ä»¥ä½¿ç”¨-XXï¼š+UseCMSCompactAtFullCollectionæ¥è®¾ç½®æ˜¯å¦åœ¨Full GCä¹‹åŽè¿›è¡Œç¢Žç‰‡æ•´ç†ï¼Œç”¨-XXï¼šCMSFullGCsBeforeCompactionæ¥è®¾ç½®åœ¨æ‰§è¡Œå¤šå°‘æ¬¡ä¸åŽ‹ç¼©çš„Full GCä¹‹åŽï¼Œæ¥ä¸€æ¬¡å¸¦åŽ‹ç¼©çš„Full GCã€‚ G1æ”¶é›†å™¨ï¼šåœ¨JDK1.7ä¸­æ­£å¼å‘å¸ƒï¼Œä¸ŽçŽ°çŠ¶çš„æ–°ç”Ÿä»£ã€è€å¹´ä»£æ¦‚å¿µæœ‰å¾ˆå¤§ä¸åŒï¼Œç›®å‰ä½¿ç”¨è¾ƒå°‘ï¼Œä¸åšä»‹ç»ã€‚ å‚è€ƒï¼šhttp://www.cnblogs.com/zhguang/p/3257367.html]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
        <tag>gc</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[pythonåœ¨ä¸åŒå±‚çº§ç›®å½•importæ¨¡å—çš„æ–¹æ³•]]></title>
    <url>%2F2015%2F02%2F18%2Fpython-import-module%2F</url>
    <content type="text"><![CDATA[ä½¿ç”¨pythonè¿›è¡Œç¨‹åºç¼–å†™æ—¶ï¼Œç»å¸¸ä¼šä½¿ç”¨ç¬¬ä¸‰æ–¹æ¨¡å—åŒ…ã€‚è¿™ç§åŒ…æˆ‘ä»¬å¯ä»¥é€šè¿‡python setup install è¿›è¡Œå®‰è£…åŽï¼Œé€šè¿‡import XXXæˆ–from XXX import yyy è¿›è¡Œå¯¼å…¥ã€‚ä¸è¿‡å¦‚æžœæ˜¯è‡ªå·±éå†™çš„ä¾èµ–åŒ…ï¼Œåˆä¸æƒ³å®‰è£…åˆ°pythonçš„ç›¸åº”ç›®å½•ï¼Œå¯ä»¥æ”¾åˆ°æœ¬ç›®å½•é‡Œè¿›è¡Œimportè¿›è¡Œè°ƒç”¨ï¼›ä¸ºäº†æ›´æ¸…æ™°çš„ç†æ¸…ç¨‹åºä¹‹é—´çš„å…³ç³»ï¼Œä¾‹å¦‚æˆ‘ä»¬ä¼šæŠŠè¿™ç§åŒ…æ”¾åˆ°libç›®å½•å†è°ƒç”¨ã€‚æœ¬ç¯‡å°±é’ˆå¯¹å¸¸è§çš„æ¨¡å—è°ƒç”¨æ–¹æ³•æ±‡æ€»ä¸‹ã€‚ åŒçº§ç›®å½•ä¸‹çš„è°ƒæœ‰ç¨‹åºç»“æž„å¦‚ä¸‹ï¼š123-- src |-- mod1.py |-- test1.py è‹¥åœ¨ç¨‹åºtest1.pyä¸­å¯¼å…¥æ¨¡å—mod1, åˆ™ç›´æŽ¥ä½¿ç”¨123import mod1æˆ–from mod1 import *; è°ƒç”¨å­ç›®å½•ä¸‹çš„æ¨¡å—ç¨‹åºç»“æž„å¦‚ä¸‹ï¼š12345-- src |-- mod1.py |-- lib | |-- mod2.py |-- test1.py è¿™æ—¶çœ‹åˆ°test1.pyå’Œlibç›®å½•ï¼ˆå³mod2.pyçš„çˆ¶çº§ç›®å½•ï¼‰ï¼Œå¦‚æžœæƒ³åœ¨ç¨‹åºtest1.pyä¸­å¯¼å…¥æ¨¡å—mod2.py ï¼Œå¯ä»¥åœ¨libä»¶å¤¹ä¸­å»ºç«‹ç©ºæ–‡ä»¶init.pyæ–‡ä»¶(ä¹Ÿå¯ä»¥åœ¨è¯¥æ–‡ä»¶ä¸­è‡ªå®šä¹‰è¾“å‡ºæ¨¡å—æŽ¥å£)ï¼Œç„¶åŽä½¿ç”¨ï¼š123from lib.mod2 import *æˆ–import lib.mod2 è°ƒç”¨ä¸Šçº§ç›®å½•ä¸‹çš„æ–‡ä»¶ç¨‹åºç»“æž„å¦‚ä¸‹ï¼š123456-- src |-- mod1.py |-- lib | |-- mod2.py |-- sub | |-- test2.py è¿™é‡Œæƒ³è¦å®žçŽ°test2.pyè°ƒç”¨mod1.pyå’Œmod2.py ï¼Œåšæ³•æ˜¯æˆ‘ä»¬å…ˆè·³åˆ°srcç›®å½•ä¸‹é¢ï¼Œç›´æŽ¥å¯ä»¥è°ƒç”¨mod1ï¼Œç„¶åŽåœ¨libä¸Šå½“ä¸‹å»ºä¸€ä¸ªç©ºæ–‡ä»¶init.py ï¼Œå°±å¯ä»¥åƒç¬¬äºŒæ­¥è°ƒç”¨å­ç›®å½•ä¸‹çš„æ¨¡å—ä¸€æ ·ï¼Œé€šè¿‡import lib.mod2è¿›è¡Œè°ƒç”¨äº†ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š1234import syssys.path.append("..")import mod1import lib.mod2]]></content>
      <categories>
        <category>pythonåŸºç¡€</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¯ç”¨NginxçŠ¶æ€ç›‘æŽ§]]></title>
    <url>%2F2014%2F10%2F12%2Fnginx-status-monitor%2F</url>
    <content type="text"><![CDATA[ç¼–è¯‘Nginxæ·»åŠ http_stub_status_moduleç¼–è¯‘Nginxçš„æ—¶å€™æ·»åŠ å‚æ•°ï¼šâ€“with-http_stub_status_module123456cd nginx-&#123;version&#125;/./configure --prefix=/opt/nginx --with-http_stub_status_module --with-http_ssl_modulemake &amp;&amp; make install å¯ç”¨nginx statusé…ç½®ä¿®æ”¹Nginxé…ç½®æ–‡ä»¶nginx.confï¼Œåœ¨HTTPæ®µä¸­æ·»åŠ 1vi /opt/nginx/conf/nginx.conf 123456789101112server&#123; listen 80; server_name localhost; location /nginx_status &#123; #ä¸»è¦æ˜¯è¿™é‡Œä»£è¡¨æ ¹ç›®å½•æ˜¾ç¤ºä¿¡æ¯ stub_status on; access_log off; &#125;&#125; æ‰“å¼€statusé¡µé¢æµè§ˆå™¨è®¿é—®ç›‘æŽ§é¡µé¢åœ°å€http://{your IP}/nginx-status,æ˜¾ç¤ºå¦‚ä¸‹1Active connections: 2 server accepts handled requests 8 8 33 Reading: 0 Writing: 1 Waiting: 1 è§£æžï¼šActive connections //å½“å‰ Nginx æ­£å¤„ç†çš„æ´»åŠ¨è¿žæŽ¥æ•°ã€‚server accepts handledrequests //æ€»å…±å¤„ç†äº†8 ä¸ªè¿žæŽ¥ , æˆåŠŸåˆ›å»º 8 æ¬¡æ¡æ‰‹,æ€»å…±å¤„ç†äº†33ä¸ªè¯·æ±‚ã€‚Reading //nginx è¯»å–åˆ°å®¢æˆ·ç«¯çš„ Header ä¿¡æ¯æ•°ã€‚Writing //nginx è¿”å›žç»™å®¢æˆ·ç«¯çš„ Header ä¿¡æ¯æ•°ã€‚Waiting //å¼€å¯ keep-alive çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼ç­‰äºŽ active â€“ (reading + writing)ï¼Œæ„æ€å°±æ˜¯ Nginx å·²ç»å¤„ç†å®Œæ­£åœ¨ç­‰å€™ä¸‹ä¸€æ¬¡è¯·æ±‚æŒ‡ä»¤çš„é©»ç•™è¿žæŽ¥]]></content>
      <categories>
        <category>ngnix</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[nginx location è¯­æ³•å’Œä¼˜å…ˆçº§]]></title>
    <url>%2F2014%2F10%2F07%2Fnginx-location%2F</url>
    <content type="text"><![CDATA[éªŒè¯ä¸‹ï¼Œè®°å½•ä¸‹ï¼Œä»¥åŽä¸ç”¨åˆ°å¤„æ‰¾ è¯­æ³•:location [=|~|~*|^~] /uri/ { â€¦ } = ç²¾ç¡®åŒ¹é…ï¼Œä¾‹å¦‚ location =/test åªåŒ¹é… /test ~ åŽé¢æŽ¥æ­£åˆ™ï¼ŒåŒºåˆ†å¤§å°å†™,åŒ¹é…æ»¡è¶³æ­¤æ­£åˆ™çš„url ~* åŽé¢æŽ¥æ­£åˆ™ï¼Œä¸åŒºåˆ†å¤§å°å†™,åŒ¹é…æ»¡è¶³æ­¤æ­£åˆ™çš„url ^~ åŒ¹é…ä»¥ä»€ä¹ˆå¼€å¤´çš„ï¼Œä¾‹å¦‚ location ^~ /test åŒ¹é… /test,/test/1,/test/2 ; ä»€ä¹ˆéƒ½ä¸åŠ çš„è¯ï¼Œç±»ä¼¼ç¬¬å››ç‚¹ï¼Œlocation /test åŒ¹é… /test,/test/1,/test/2 ;ä¼˜å…ˆçº§= å¤§äºŽ ^~ å¤§äºŽ ~ æˆ–è€…~* å¤§äºŽ ä»€ä¹ˆéƒ½ä¸åŠ  å‡å¦‚é‡åˆ°åŒçº§çš„è¯ ~ å’Œ~ ï¼ˆä»–ä»¬æ˜¯åŒçº§çš„ï¼‰æ¯”è¾ƒçš„è¯ï¼Œå°±æ˜¯æ ¹æ®ä»–ä»¬åœ¨æ–‡ä»¶çš„å‡ºçŽ°é¡ºåºã€‚ä¾‹å¦‚location ~ /sb.txtlocation ~ /sb.txtå¦‚æžœè®¿é—® http://localhost/sb.txt,å°±ä¼šè·³åˆ°ç¬¬ä¸€ä¸ªï¼Œè®¿é—® http://localhost/SB.txt è·³åˆ°ç¬¬äºŒä¸ªï¼Œæ¢ä¸ªé¡ºåºlocation ~* /sb.txtlocation ~ /sb.txtä¸ç®¡è®¿é—® http://localhost/sb.txt è¿˜æ˜¯ http://localhost/SB.txt ,éƒ½åªä¼šè·³åˆ°ç¬¬ä¸€ä¸ª ^~ çš„è¯ï¼Œå°±æ ¹æ®ä»–ä»¬çš„åŒ¹é…åº¦ï¼Œä¾‹å¦‚location ^~ /sb/location ^~ /sb/sb2/å¦‚æžœè®¿é—®http://localhost/sb/sb2/,å°±ä¼šè·³åˆ°ç¬¬äºŒä¸ªåŽ»å¤„ç†ï¼Œå› ä¸ºä»–æ›´åŠ åŒ¹é…å§ã€‚å¦‚æžœè®¿é—®http://localhost/sb/ï¼Œå°±ä¼šè·³åˆ°ç¬¬ä¸€ä¸ªå¤„ç†ï¼Œå¦‚æžœè®¿é—®http://localhost/sb/sb3,ä¹Ÿä¼šè·³åˆ°ç¬¬ä¸€ä¸ªã€‚ ä»€ä¹ˆéƒ½ä¸åŠ çš„è¯ï¼Œä¹Ÿæ˜¯æ ¹æ®ä»–ä»¬çš„åŒ¹é…åº¦ï¼Œä¾‹å¦‚location /sb/location /sb/sb2/å¦‚æžœè®¿é—®http://localhost/sb/sb2/,å°±ä¼šè·³åˆ°ç¬¬äºŒä¸ªåŽ»å¤„ç†ï¼Œå› ä¸ºä»–æ›´åŠ åŒ¹é…å§ã€‚å¦‚æžœè®¿é—®http://localhost/sb/ï¼Œå°±ä¼šè·³åˆ°ç¬¬ä¸€ä¸ªå¤„ç†ï¼Œå¦‚æžœè®¿é—®http://localhost/sb/sb3,ä¹Ÿä¼šè·³åˆ°ç¬¬ä¸€ä¸ªã€‚]]></content>
      <categories>
        <category>ngix</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[lvs+keepalived åšè´Ÿè½½å’Œçƒ­å¤‡]]></title>
    <url>%2F2014%2F10%2F07%2Flinux-lvs%2F</url>
    <content type="text"><![CDATA[ä¸€ç›´è§‰å¾—nginxåšè´Ÿè½½ä¸é”™äº†ï¼Œå¯å‘çŽ°å±…ç„¶è¿™çŽ©æ„è¿™ä¹ˆå¥½ï¼Œç‰¹åˆ«keepalivedçƒ­å¤‡ã€‚ å‡†å¤‡å·¥ä½œæœ¬å®žéªŒåŸºäºŽVMware+centos,ä»¥ä¸‹æ˜¯çŽ¯å¢ƒä¿¡æ¯ï¼šå‡å¦‚æœ‰4å°æœåŠ¡å™¨masterï¼š192.168.153.132backupï¼š192.168.153.133vipï¼ˆvirtual ip è™šæ‹Ÿipï¼‰ï¼š192.168.153.100 ï¼ˆå®žé™…æµè§ˆå™¨è®¿é—®çš„åœ°å€ï¼‰realserver 1: 192.168.153.128realserver 2: 192.168.153.129çƒ­å¤‡çš„æ„æ€å°±æ˜¯masteråäº†ï¼Œbackupèƒ½è¡¥ä¸ŠåŽ»ï¼Œç”±äºŽéƒ½æ˜¯ä½¿ç”¨vipï¼Œæ‰€ä»¥å¤–é¢æµè§ˆå™¨è®¿é—®æ²¡æœ‰å½±å“realserver1å’Œ2æ˜¯ç”¨æ¥åšè´Ÿè½½å‡è¡¡ï¼ŒæŒ‰ç…§æƒé‡æ¥è°ƒåˆ°ç›¸åº”çš„æœåŠ¡å™¨æ¥å¤„ç†è¯·æ±‚ã€‚lvså’Œkeepalivedéƒ½è¦è£…åˆ°masterå’Œbackupä¸Š ä¸‹è½½keepalivedå’Œlvsçš„adminç¨‹åº1$ wget http://www.keepalived.org/software/keepalived-1.2.13.tar.gz 1$ wget http://www.linuxvirtualserver.org/software/kernel-2.6/ipvsadm-1.26.tar.gz å®‰è£…ä¾èµ–1$ yum -y install libnl* openssl* popt* kernel-devel è§£åŽ‹å®‰è£…12$ tar -zxvf keepalived-1.2.13.tar.gz$ tar -zxvf ipvsadm-1.26.tar.gz 123$ cd keepalived-1.2.13$ ./configure --prefix=/usr --sysconf=/etc$ make &amp;&amp; make install 12$ cd ipvsadm-1.26$ make &amp;&amp; make install éªŒè¯lvs1$ ipvsadm ln éªŒè¯keepalived1$ service keepalived start å¦‚æžœæ˜¾ç¤ºæ— è¯¯å°±ä»£è¡¨å®‰è£…æˆåŠŸäº†ã€‚ é…ç½®é…ç½®master1$ vi /etc/keepalived/keepalived.conf 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455global_defs &#123; notification_email &#123; acassen@firewall.loc failover@firewall.loc sysadmin@firewall.loc &#125; notification_email_from Alexandre.Cassen@firewall.loc smtp_server 192.168.200.1 smtp_connect_timeout 30 router_id LVS_DEVEL&#125;vrrp_instance VI_1 &#123; state MASTER #è¡¨ç¤ºmaster interface eth1 #ç½‘ç»œæŽ¥å£ï¼Œæœ‰å¯èƒ½æ˜¯eth0ï¼Œå¯ä»¥ç”¨å‘½ä»¤ifconfigæŸ¥çœ‹ virtual_router_id 51 priority 100 #ä¼˜å…ˆçº§ advert_int 1 authentication &#123; auth_type PASS auth_pass 1111 &#125; virtual_ipaddress &#123; 192.168.153.100 #vipé…ç½® &#125;&#125;virtual_server 192.168.153.100 80 &#123; delay_loop 6 lb_algo rr #è´Ÿè½½ç®—æ³• lb_kind DR #è´Ÿè½½æ–¹å¼ DRï¼Œè¿™ç§æ–¹å¼çš„è¯VIPç«¯å£å’Œrealserverç«¯å£å¿…é¡»ä¸€è‡´ #persistence_timeout 20 protocol TCP real_server 192.168.153.128 80 &#123; weight 3 #æƒé‡ TCP_CHECK &#123; connect_timeout 3 nb_get_retry 3 delay_before_retry 3 connect_port 80&#125;&#125; real_server 192.168.153.129 80 &#123; weight 3 #æƒé‡ TCP_CHECK &#123; connect_timeout 3 nb_get_retry 3 delay_before_retry 3 connect_port 80&#125;&#125;&#125; é…ç½®backupåŸºæœ¬è·Ÿmasterä¸€è‡´ï¼Œåªæ˜¯åœ¨ä¸Šé¢çº¢è‰²çš„ç¬¬ä¸€å¤„æ”¹æˆBACKUPï¼Œç¬¬äºŒå¤„æ”¹æˆæ¯”masterå°çš„å€¼ï¼Œä¾‹å¦‚90 é‡å¯keepalived1$ service keepalived restart é…ç½®realserveråœ¨real server 1å’Œ2ä¸Šï¼ŒæŠŠä»¥ä¸‹è„šæœ¬æ”¾åœ¨/etc/rc.d/init.d/ä¸‹12345678910111213141516171819202122232425262728293031323334#!/bin/bash# description: Config realserver lo and apply noarp SNS_VIP=192.168.153.100 . /etc/rc.d/init.d/functions case "$1" instart) ifconfig lo:0 $SNS_VIP netmask 255.255.255.255 broadcast $SNS_VIP /sbin/route add -host $SNS_VIP dev lo:0 echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce sysctl -p &gt;/dev/null 2&gt;&amp;1 echo "RealServer Start OK" ;;stop) ifconfig lo:0 down route del $SNS_VIP &gt;/dev/null 2&gt;&amp;1 echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_announce echo "RealServer Stoped" ;;*) echo "Usage: $0 &#123;start|stop&#125;" exit 1esac exit 0 å‘½åæˆrealserver,ç„¶åŽå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ï¼š1$ service realserver start å…³é—­iptableå¦‚æžœä¸æƒ³å…³æŽ‰çš„è¯åœ¨master åŠ ä¸Šä»¥ä¸‹è§„åˆ™1-A INPUT -i eth1 -p vrrp -s 192.168.153.133 -j ACCEPT åœ¨backupåŠ ä¸Šä»¥ä¸‹è§„åˆ™1-A INPUT -i eth1 -p vrrp -s 192.168.153.132 -j ACCEPT å…¶å®žå°±æ˜¯è®©çƒ­å¤‡ä¹‹é—´å¯ä»¥é€šè®¯ï¼Œæ³¨æ„eth1æ˜¯ä½ çš„ç½‘ç»œæŽ¥å£ï¼Œå¦‚æžœæ˜¯eth0å°±è¦æ¢æˆeth0realserverå°±åªè¦å¼€å¯80ç«¯å£å°±å¯ä»¥äº†ã€‚ éªŒè¯ å¼€å¯realserverçš„webåº”ç”¨ç¨‹åº æ‰§è¡Œrealserverè„šæœ¬ å¼€å¯masterå’Œbackupçš„keepalived ç”¨watch ipvsadm -lnåœ¨masterå’Œbackupä¸Šå¯ä»¥æŸ¥çœ‹çŠ¶æ€å¦‚æžœæœ‰ä¸¤æ¡è®°å½•åˆ†åˆ«æŒ‡å‘realserverçš„ipå°±ä»£è¡¨è¿è¡Œæ­£ç¡®äº†ã€‚ æµè§ˆå™¨è®¿é—®vipï¼Œçœ‹èƒ½å¦æ­£ç¡®è®¿é—®webåº”ç”¨ç¨‹åºã€‚ å…³æŽ‰master çš„keepalivedï¼Œå¦‚æžœè¿˜èƒ½è®¿é—®çš„è¯ï¼Œå°±ä»£è¡¨backupæŽ¥ç®¡äº†ã€‚å¯ä»¥åœ¨backupçš„æ—¥å¿—ä¸Šé¢çœ‹åˆ°ï¼Œtail -f /var/log/messageå¦‚æžœæœ‰transition MASTERçš„ï¼Œå°±ä»£è¡¨æŽ¥ç®¡äº†ã€‚ å†å¯åŠ¨masterçš„keepalivedï¼Œå†åˆ°backupçš„æ—¥å¿—ä¸Šé¢çœ‹åˆ°transition BACKUPçš„ï¼Œå°±ä»£è¡¨å·²ç»äº¤å›žmasteräº†ã€‚ å…³æŽ‰å…¶ä¸­ä¸€ä¸ªrealserverï¼Œç”¨watch ipvsadm -lnå¯ä»¥çœ‹åˆ°è¯¥realserverçš„ipè¢«å‰”é™¤äº†ã€‚]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>lvs</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[centos å¯ç”¨ftpåŠŸèƒ½]]></title>
    <url>%2F2014%2F08%2F17%2Fcentos-ftp%2F</url>
    <content type="text"><![CDATA[1.å®‰è£…vsftpdç»„ä»¶1yum -y install vsftpd å®‰è£…å®ŒåŽï¼Œæœ‰ä¸ª/etc/vsftpd/vsftpd.conf æ–‡ä»¶ï¼Œç”¨æ¥é…ç½®è¿˜æœ‰è‡ªåŠ¨æ–°å»ºäº†ä¸€ä¸ªftpç”¨æˆ·å’Œftpçš„ç»„ï¼Œhomeç›®å½•ä¸º/var/ftp,é»˜è®¤æ˜¯nologinï¼ˆä¸èƒ½ç™»å½•ç³»ç»Ÿï¼‰1cat /etc/passwd | grep ftp é»˜è®¤ftpæœåŠ¡æ˜¯æ²¡æœ‰å¯åŠ¨çš„ï¼Œç”¨ä¸‹é¢å‘½ä»¤å¯åŠ¨1service vsftpd start 2.å®‰è£…ftpå®¢æˆ·ç«¯ç»„ä»¶ï¼ˆç”¨æ¥éªŒè¯æ˜¯å¦vsftpdï¼‰1yum -y install ftp æ‰§è¡Œå‘½ä»¤å°è¯•ç™»å½•1ftp localhost è¾“å…¥ç”¨æˆ·åftpï¼Œå¯†ç éšä¾¿ï¼ˆå› ä¸ºé»˜è®¤æ˜¯å…è®¸åŒ¿åçš„ï¼‰ ç™»å½•æˆåŠŸï¼Œå°±ä»£è¡¨ftpæœåŠ¡å¯ç”¨äº†ã€‚ ä½†æ˜¯ï¼Œå¤–ç½‘æ˜¯è®¿é—®ä¸äº†çš„ï¼Œæ‰€ä»¥è¿˜è¦ç»§ç»­é…ç½®ã€‚ 3.å–æ¶ˆåŒ¿åç™»é™†1vi /etc/vsftpd/vsftpd.conf æŠŠç¬¬ä¸€è¡Œçš„ anonymous_enable=YES ï¼Œæ”¹ä¸ºNOé‡å¯1service vsftpd restart 4.æ–°å»ºä¸€ä¸ªç”¨æˆ·(ftpuserä¸ºç”¨æˆ·åï¼Œéšä¾¿å°±å¯ä»¥)1useradd ftpuser ä¿®æ”¹å¯†ç ï¼ˆè¾“å…¥ä¸¤æ¬¡ï¼‰1passwd ftpuser è¿™æ ·ä¸€ä¸ªç”¨æˆ·å»ºå®Œï¼Œå¯ä»¥ç”¨è¿™ä¸ªç™»å½•ï¼Œè®°å¾—ç”¨æ™®é€šç™»å½•ä¸è¦ç”¨åŒ¿åäº†ã€‚ç™»å½•åŽé»˜è®¤çš„è·¯å¾„ä¸º /home/ftpuser. 5.å¼€æ”¾21ç«¯å£ å› ä¸ºftpé»˜è®¤çš„ç«¯å£ä¸º21ï¼Œè€Œcentosé»˜è®¤æ˜¯æ²¡æœ‰å¼€å¯çš„ï¼Œæ‰€ä»¥è¦ä¿®æ”¹iptablesæ–‡ä»¶1vi /etc/sysconfig/iptables åœ¨è¡Œä¸Šé¢æœ‰22 -j ACCEPT ä¸‹é¢å¦èµ·ä¸€è¡Œè¾“å…¥è·Ÿé‚£è¡Œå·®ä¸å¤šçš„ï¼Œåªæ˜¯æŠŠ22æ¢æˆ21ï¼Œç„¶åŽï¼šwqä¿å­˜ã€‚è¿˜è¦è¿è¡Œä¸‹,é‡å¯iptables1service iptables restart å¤–ç½‘æ˜¯å¯ä»¥è®¿é—®ä¸ŠåŽ»äº†ï¼Œå¯æ˜¯å‘çŽ°æ²¡æ³•è¿”å›žç›®å½•ï¼Œä¹Ÿä¸Šä¼ ä¸äº†ï¼Œå› ä¸ºselinuxä½œæ€ªäº†ã€‚6.ä¿®æ”¹selinux1getsebool -a | grep ftp æ‰§è¡Œä¸Šé¢å‘½ä»¤ï¼Œå†è¿”å›žçš„ç»“æžœçœ‹åˆ°ä¸¤è¡Œéƒ½æ˜¯offï¼Œä»£è¡¨ï¼Œæ²¡æœ‰å¼€å¯å¤–ç½‘çš„è®¿é—®12345.... allow_ftpd_full_access off ........ftp_home_dir off åªè¦æŠŠä¸Šé¢éƒ½å˜æˆonå°±è¡Œæ‰§è¡Œ12setsebool -P allow_ftpd_full_access 1 setsebool -P ftp_home_dir off 1 å†é‡å¯ä¸€ä¸‹vsftpd1service vsftpd restart è¿™æ ·åº”è¯¥æ²¡é—®é¢˜äº†ï¼ˆå¦‚æžœï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ç”¨äº†ftpå®¢æˆ·ç«¯å·¥å…·ç”¨äº†passiveæ¨¡å¼è®¿é—®äº†ï¼Œå¦‚æç¤ºEntering Passive modeï¼Œå°±ä»£è¡¨æ˜¯passiveæ¨¡å¼ï¼Œé»˜è®¤æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºftp passiveæ¨¡å¼è¢«iptablesæŒ¡ä½äº†ï¼Œä¸‹é¢ä¼šè®²æ€Žä¹ˆå¼€å¯ï¼Œå¦‚æžœæ‡’å¾—å¼€çš„è¯ï¼Œå°±çœ‹çœ‹ä½ å®¢æˆ·ç«¯ftpæ˜¯å¦æœ‰portæ¨¡å¼çš„é€‰é¡¹ï¼Œæˆ–è€…æŠŠpassiveæ¨¡å¼çš„é€‰é¡¹åŽ»æŽ‰ã€‚å¦‚æžœå®¢æˆ·ç«¯è¿˜æ˜¯ä¸è¡Œï¼Œçœ‹çœ‹å®¢æˆ·ç«¯ä¸Šçš„ä¸»æœºçš„ç”µè„‘æ˜¯å¦å¼€äº†é˜²ç«å¢™ï¼Œå…³å§ï¼‰ 7.å¼€å¯passiveæ¨¡å¼ é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œä½†æ˜¯è¦æŒ‡å®šä¸€ä¸ªç«¯å£èŒƒå›´ï¼Œæ‰“å¼€vsftpd.confæ–‡ä»¶ï¼Œåœ¨åŽé¢åŠ ä¸Š123pasv_min_port=30000pasv_max_port=30999 è¡¨ç¤ºç«¯å£èŒƒå›´ä¸º30000~30999ï¼Œè¿™ä¸ªå¯ä»¥éšæ„æ”¹ã€‚æ”¹å®Œé‡å¯ä¸€ä¸‹vsftpd ç”±äºŽæŒ‡å®šè¿™æ®µç«¯å£èŒƒå›´ï¼Œiptablesä¹Ÿè¦ç›¸åº”çš„å¼€å¯è¿™ä¸ªèŒƒå›´ï¼Œæ‰€ä»¥åƒä¸Šé¢é‚£æ ·æ‰“å¼€iptablesæ–‡ä»¶ ä¹Ÿæ˜¯åœ¨21ä¸Šä¸‹é¢å¦èµ·ä¸€è¡Œï¼Œæ›´é‚£è¡Œå·®ä¸å¤šï¼Œåªæ˜¯æŠŠ21 æ”¹ä¸º30000:30999,ç„¶åŽ:wqä¿å­˜ï¼Œé‡å¯ä¸‹iptablesã€‚è¿™æ ·å°±æžå®šäº†ã€‚]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Listã€Setã€Mapé›†åˆå­˜æ”¾nullåˆ†æž]]></title>
    <url>%2F2014%2F08%2F16%2Fjava-collection-null%2F</url>
    <content type="text"><![CDATA[éªŒè¯ä¸‹ã€‚ ä¸Šä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100package com.sky.code.collection;import java.util.*;import java.util.concurrent.ConcurrentHashMap;public class TestNull &#123; public static void main(String[] args)&#123; System.out.println("æµ‹è¯•ArrayList"); List&lt;Object&gt; list = new ArrayList&lt;Object&gt;(); list.add(null); list.add(null); System.out.println(list); System.out.println("æµ‹è¯•LinkedList"); List&lt;Object&gt; list1 = new LinkedList&lt;Object&gt;(); list1.add(null); list1.add(null); System.out.println(list1); System.out.println("æµ‹è¯•HashSet"); Set&lt;Object&gt; set = new HashSet&lt;Object&gt;(); set.add(null); set.add(null); System.out.println(set); System.out.println("æµ‹è¯•TreeSet"); Set&lt;Object&gt; treeSet = new TreeSet&lt;Object&gt;(); try &#123; treeSet.add(null); &#125;catch (Exception e)&#123; System.out.println(e); &#125; System.out.println("æµ‹è¯•LinkedHashSet"); Set&lt;Object&gt; set1 = new LinkedHashSet&lt;Object&gt;(); set1.add(null); set1.add(null); System.out.println(set1); System.out.println("æµ‹è¯•HashMap"); Map&lt;Object, Object&gt; hashMap = new HashMap&lt;&gt;(); hashMap.put(null, null); hashMap.put(null, null); hashMap.put(1, null); hashMap.put(1, 12); System.out.println(hashMap); System.out.println("æµ‹è¯•LinkedHashMap"); Map&lt;Object, Object&gt; linkedHashMap = new LinkedHashMap&lt;&gt;(); linkedHashMap.put(null, null); linkedHashMap.put(null, null); linkedHashMap.put(1, null); linkedHashMap.put(1, 12); System.out.println(linkedHashMap); System.out.println("æµ‹è¯•TreeMap"); Map&lt;Object, Object&gt; treemap = new TreeMap&lt;&gt;(); treemap.put(1, null); try &#123; treemap.put(null, 1); &#125; catch (Exception e)&#123; System.out.println(e); &#125; treemap.put(2, 12); System.out.println(treemap); System.out.println("æµ‹è¯•ConcurrentHashMap"); Map&lt;Object, Object&gt; concurrentHashMap = new ConcurrentHashMap&lt;&gt;(); try &#123; concurrentHashMap.put(null, 1); &#125;catch (Exception e)&#123; System.out.println(e); &#125; try &#123; concurrentHashMap.put(1, null); &#125; catch (Exception e)&#123; System.out.println(e); &#125; concurrentHashMap.put(1, 12); System.out.println(treemap); System.out.println("æµ‹è¯•Hashtable"); Map&lt;Object, Object&gt; hashtable = new Hashtable&lt;&gt;(); try &#123; hashtable.put(null,"null"); &#125; catch (Exception e)&#123; System.out.println(e); &#125; try &#123; hashtable.put(3,null); &#125; catch (Exception e)&#123; System.out.println(e); &#125; &#125;&#125; ç»“æžœ123456789101112131415161718192021222324æµ‹è¯•ArrayList[null, null]æµ‹è¯•LinkedList[null, null]æµ‹è¯•HashSet[null]æµ‹è¯•TreeSetjava.lang.NullPointerExceptionæµ‹è¯•LinkedHashSet[null]æµ‹è¯•HashMap&#123;null=null, 1=12&#125;æµ‹è¯•LinkedHashMap&#123;null=null, 1=12&#125;æµ‹è¯•TreeMapjava.lang.NullPointerException&#123;1=null, 2=12&#125;æµ‹è¯•ConcurrentHashMapjava.lang.NullPointerExceptionjava.lang.NullPointerException&#123;1=null, 2=12&#125;æµ‹è¯•Hashtablejava.lang.NullPointerExceptionjava.lang.NullPointerException ç»“è®ºå¾ˆæ˜Žæ˜¾treeç»“æž„çš„éƒ½ä¸æŽ¥å—keyä¸ºnull,hashtableå’Œconcurrenthashmapæ˜¯keyå’Œvalueéƒ½ä¸æ”¯æŒnullçš„ï¼Œå…¶ä»–éƒ½å°±éšä¾¿å§ã€‚ðŸ™‚ æ‰€æœ‰ä»£ç åœ¨ https://github.com/ejunjsh/java-code/tree/master/com/sky/code/collection]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[javascriptåœ¨æµè§ˆå™¨è·¨åŸŸè®¿é—®çš„å‡ ç§å¤„ç†æ–¹å¼]]></title>
    <url>%2F2014%2F08%2F02%2Fjquery-cross-domain-ajax%2F</url>
    <content type="text"><![CDATA[è¿™é‡Œè¯´çš„jsè·¨åŸŸæ˜¯æŒ‡é€šè¿‡jsåœ¨ä¸åŒçš„åŸŸä¹‹é—´è¿›è¡Œæ•°æ®ä¼ è¾“æˆ–é€šä¿¡ï¼Œæ¯”å¦‚ç”¨ajaxå‘ä¸€ä¸ªä¸åŒçš„åŸŸè¯·æ±‚æ•°æ®ã€‚åªè¦åè®®ã€åŸŸåã€ç«¯å£æœ‰ä»»ä½•ä¸€ä¸ªä¸åŒï¼Œéƒ½è¢«å½“ä½œæ˜¯ä¸åŒçš„åŸŸã€‚ä¸‹è¡¨ç»™å‡ºäº†ç›¸å¯¹http://store.company.com/dir/page.html åŒæºæ£€æµ‹çš„ç»“æžœ: URL ç»“æžœ åŽŸå›  http://store.company.com/dir2/other.html æˆåŠŸ http://store.company.com/dir/inner/another.html æˆåŠŸ https://store.company.com/dir/inner/another.html å¤±è´¥ åè®®ä¸åŒ http://store.company.com:81/dir/inner/another.html å¤±è´¥ ç«¯å£ä¸åŒ http://news.company.com/dir/inner/another.html å¤±è´¥ åŸŸåä¸åŒ è¦è§£å†³è·¨åŸŸçš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š é€šè¿‡jsonpåœ¨jsä¸­ï¼Œæˆ‘ä»¬ç›´æŽ¥ç”¨XMLHttpRequestè¯·æ±‚ä¸åŒåŸŸä¸Šçš„æ•°æ®æ—¶ï¼Œæ˜¯ä¸å¯ä»¥çš„ã€‚ä½†æ˜¯ï¼Œåœ¨é¡µé¢ä¸Šå¼•å…¥ä¸åŒåŸŸä¸Šçš„jsè„šæœ¬æ–‡ä»¶å´æ˜¯å¯ä»¥çš„ï¼Œjsonpæ­£æ˜¯åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥å®žçŽ°çš„ã€‚æ¯”å¦‚ï¼Œæœ‰ä¸ªa.htmlé¡µé¢ï¼Œå®ƒé‡Œé¢çš„ä»£ç éœ€è¦åˆ©ç”¨ajaxèŽ·å–ä¸€ä¸ªä¸åŒåŸŸä¸Šçš„jsonæ•°æ®ï¼Œå‡è®¾è¿™ä¸ªjsonæ•°æ®åœ°å€æ˜¯http://example.com/data.php, é‚£ä¹ˆa.htmlä¸­çš„ä»£ç å°±å¯ä»¥è¿™æ ·ï¼š123456&lt;scirpt&gt;function dosomething(jsondata)&#123; //å¤„ç†èŽ·å¾—çš„jsonæ•°æ®&#125;&lt;/scirpt&gt;&lt;scirpt src="http://example.com/data.php?callback=dosomething"&gt;&lt;/scirpt&gt; æˆ‘ä»¬çœ‹åˆ°èŽ·å–æ•°æ®çš„åœ°å€åŽé¢è¿˜æœ‰ä¸€ä¸ªcallbackå‚æ•°ï¼ŒæŒ‰æƒ¯ä¾‹æ˜¯ç”¨è¿™ä¸ªå‚æ•°åï¼Œä½†æ˜¯ä½ ç”¨å…¶ä»–çš„ä¹Ÿä¸€æ ·ã€‚å½“ç„¶å¦‚æžœèŽ·å–æ•°æ®çš„jsonpåœ°å€é¡µé¢ä¸æ˜¯ä½ è‡ªå·±èƒ½æŽ§åˆ¶çš„ï¼Œå°±å¾—æŒ‰ç…§æä¾›æ•°æ®çš„é‚£ä¸€æ–¹çš„è§„å®šæ ¼å¼æ¥æ“ä½œäº†ã€‚å› ä¸ºæ˜¯å½“åšä¸€ä¸ªjsæ–‡ä»¶æ¥å¼•å…¥çš„ï¼Œæ‰€ä»¥http://example.com/data.phpè¿”å›žçš„å¿…é¡»æ˜¯ä¸€ä¸ªèƒ½æ‰§è¡Œçš„jsæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™ä¸ªé¡µé¢çš„phpä»£ç å¯èƒ½æ˜¯è¿™æ ·çš„:12345&lt;?php$callback=&amp;_GET[`callback`];//èŽ·å¾—å›žè°ƒå‡½æ•°å$data=array('a','b','c');//è¦è¿”å›žçš„æ•°æ®echo $callback.'('.json_encode($data).')';//è¾“å‡º?&gt; æœ€ç»ˆé‚£ä¸ªé¡µé¢è¾“å‡ºçš„ç»“æžœæ˜¯:1dosomething(['a','b','c']) æ‰€ä»¥é€šè¿‡http://example.com/data.php?callback=dosomethingå¾—åˆ°çš„jsæ–‡ä»¶ï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„dosomethingå‡½æ•°,å¹¶ä¸”å®ƒçš„å‚æ•°å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„jsonæ•°æ®ï¼Œè¿™æ ·æˆ‘ä»¬å°±è·¨åŸŸèŽ·å¾—äº†æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚ è¿™æ ·jsonpçš„åŽŸç†å°±å¾ˆæ¸…æ¥šäº†ï¼Œé€šè¿‡scriptæ ‡ç­¾å¼•å…¥ä¸€ä¸ªjsæ–‡ä»¶ï¼Œè¿™ä¸ªjsæ–‡ä»¶è½½å…¥æˆåŠŸåŽä¼šæ‰§è¡Œæˆ‘ä»¬åœ¨urlå‚æ•°ä¸­æŒ‡å®šçš„å‡½æ•°ï¼Œå¹¶ä¸”ä¼šæŠŠæˆ‘ä»¬éœ€è¦çš„jsonæ•°æ®ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚æ‰€ä»¥jsonpæ˜¯éœ€è¦æœåŠ¡å™¨ç«¯çš„é¡µé¢è¿›è¡Œç›¸åº”çš„é…åˆçš„ã€‚ çŸ¥é“jsonpè·¨åŸŸçš„åŽŸç†åŽæˆ‘ä»¬å°±å¯ä»¥ç”¨jsåŠ¨æ€ç”Ÿæˆscriptæ ‡ç­¾æ¥è¿›è¡Œè·¨åŸŸæ“ä½œäº†ï¼Œè€Œä¸ç”¨ç‰¹æ„çš„æ‰‹åŠ¨çš„ä¹¦å†™é‚£äº›scriptæ ‡ç­¾ã€‚å¦‚æžœä½ çš„é¡µé¢ä½¿ç”¨jqueryï¼Œé‚£ä¹ˆé€šè¿‡å®ƒå°è£…çš„æ–¹æ³•å°±èƒ½å¾ˆæ–¹ä¾¿çš„æ¥è¿›è¡Œjsonpæ“ä½œäº†ã€‚12345&lt;scirpt&gt;$.getJSON('http://example.com/data.php?callback=?',function(jsondata)&#123; ////å¤„ç†èŽ·å¾—çš„jsonæ•°æ®&#125;);&lt;/scirpt&gt; åŽŸç†æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨çš„æ’å…¥scriptæ ‡ç­¾ä»¥åŠå®šä¹‰å›žæŽ‰å‡½æ•°ã€‚jqueryä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå…¨å±€å‡½æ•°æ¥æ›¿æ¢callback=?ä¸­çš„é—®å·ï¼Œä¹‹åŽèŽ·å–åˆ°æ•°æ®åŽåˆä¼šè‡ªåŠ¨é”€æ¯ï¼Œå®žé™…ä¸Šå°±æ˜¯èµ·ä¸€ä¸ªä¸´æ—¶ä»£ç†å‡½æ•°çš„ä½œç”¨ã€‚$.getJSONæ–¹æ³•ä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦è·¨åŸŸï¼Œä¸è·¨åŸŸçš„è¯ï¼Œå°±è°ƒç”¨æ™®é€šçš„ajaxæ–¹æ³•ï¼›è·¨åŸŸçš„è¯ï¼Œåˆ™ä¼šä»¥å¼‚æ­¥åŠ è½½jsæ–‡ä»¶çš„å½¢å¼æ¥è°ƒç”¨jsonpçš„å›žè°ƒå‡½æ•°ã€‚ é€šè¿‡XHR2HTML5ä¸­æä¾›çš„XMLHTTPREQUEST Level2ï¼ˆåŠXHR2ï¼‰å·²ç»å®žçŽ°äº†è·¨åŸŸè®¿é—®ã€‚ä½†ie10ä»¥ä¸‹ä¸æ”¯æŒåªéœ€è¦åœ¨æœåŠ¡ç«¯å¡«ä¸Šå“åº”å¤´123header(&quot;Access-Control-Allow-Origin:*&quot;);/*æ˜Ÿå·è¡¨ç¤ºæ‰€æœ‰çš„åŸŸéƒ½å¯ä»¥æŽ¥å—ï¼Œ*/header(&quot;Access-Control-Allow-Methods:GET,POST&quot;);]]></content>
      <categories>
        <category>javascript</category>
      </categories>
      <tags>
        <tag>javascirpt</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”¨cglibç”Ÿæˆçš„ä»£ç†ç±»å–ä¸åˆ°æ³¨è§£çš„é—®é¢˜]]></title>
    <url>%2F2014%2F07%2F19%2Fjava-cglib%2F</url>
    <content type="text"><![CDATA[ç»å¸¸ç”¨cglibæ¥åˆ›å»ºä»£ç†ç±»æ¥å®žçŽ°aopçš„åŠŸèƒ½ï¼Œå¯æ˜¯ï¼Œå½“æƒ³ç”¨åå°„æ¥å–å¾—ä»£ç†ç±»æ‰€ä»£ç†çš„ç±»çš„æ³¨è§£çš„æ—¶å€™ï¼Œå´æ€Žä¹ˆä¹Ÿå–ä¸åˆ°ã€‚ã€‚ã€‚ã€‚ ç„¶åŽæœäº†ä¸‹stackoverflowï¼Œhttp://stackoverflow.com/questions/1706751/retain-annotations-on-cglib-proxiesç”¨@Inherited,æ³¨è§£è‡ªå·±çš„æ³¨è§£ï¼ˆç»•~~ï¼‰12345@Inherited@Retention(RetentionPolicy.RUNTIME)@Target(ElementType.TYPE)public @interface MyAnnotation &#123;&#125; ç„¶åŽç”¨è¿™ä¸ªæ³¨è§£æ³¨è§£ä½ è¦ä»£ç†çš„ç±»ï¼Œé‚£æ ·é€šè¿‡åå°„å¯ä»¥æ‹¿åˆ°è¢«ä»£ç†çš„æ³¨è§£ã€‚åŽŸæ¥CGLIB è¿”å›žçš„ä»£ç†ç±»æ˜¯è¢«ä»£ç†çš„ç±»çš„å­ç±»ï¼ŒåŠ ä¸Šè¿™ä¸ªæ ‡å¿—å°±å¯ä»¥ä»¤å­ç±»ç»§æ‰¿è¿™ä¸ªæ³¨è§£ï¼Œ@Inherited å­—é¢æ„æ€å°±æ˜¯æœ‰ç»§æ‰¿çš„æ„æ€ã€‚]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[maven resource è®°å½•]]></title>
    <url>%2F2014%2F02%2F20%2Fmaven-resouce%2F</url>
    <content type="text"><![CDATA[ä»Šå¤©é‡åˆ°mavenæ‰“åŒ…çš„æ—¶å€™å‘çŽ°åœ¨main/javaé‡Œé¢çš„xmlæ²¡æœ‰æ‰“åŒ…è¿›jarä¸Šã€‚ ä¸Šç½‘æœäº†ä¸‹ï¼Œmavené»˜è®¤æ‰“åŒ…main/resourceçš„èµ„æºï¼Œè¦æƒ³æ‰“åŒ…main/javaçš„è¦åƒä¸‹é¢è¿™æ ·é…ã€‚12345678910111213&lt;build&gt; &lt;resources&gt; &lt;resource&gt; &lt;directory&gt;src/main/java&lt;/directory&gt; &lt;includes&gt; &lt;include&gt;**/*.properties&lt;/include&gt; &lt;include&gt;**/*.xml&lt;/include&gt; &lt;include&gt;**/*.tld&lt;/include&gt; &lt;/includes&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;/resource&gt; &lt;/resources&gt; &lt;/build&gt; æžå®šæ”¶å·¥ã€‚ã€‚ã€‚ä¸çŸ¥é“æœ‰æ²¡æœ‰æ›´å¥½åˆ°æ–¹æ³•å‘¢ï¼Ÿ]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[jenkins + git+mavenåšæŒç»­é›†æˆ]]></title>
    <url>%2F2014%2F02%2F20%2Fjenkins-jenkins-git-maven%2F</url>
    <content type="text"><![CDATA[1.ä¸‹ä¸ªjenkinsï¼Œå®˜ç½‘åŽ»ä¸‹ http://jenkins-ci.org/ï¼Œé‡Œé¢æä¾›waråŒ…ä¸‹è½½ï¼Œç›´æŽ¥éƒ¨ç½²åˆ°tomcatä»€ä¹ˆä¸Šé¢å§ã€‚2.éƒ¨ç½²æˆåŠŸåŽæ‰“å¼€ç½‘ç«™ä¾‹å¦‚ï¼šhttp://localhost/jenkinï¼Œé»˜è®¤æ˜¯ä¸å¸¦gitçš„æ’ä»¶çš„ï¼Œæ‰€ä»¥å…ˆåŽ»ä¸‹ä¸€ä¸ªå…ˆï¼Œç‚¹å‡»ä¸»é¡µçš„å³ä¾§â€œç³»ç»Ÿç®¡ç†â€=&gt;&quot;ç®¡ç†æ’ä»¶&quot;=&gt;â€œå¯é€‰æ’ä»¶â€ æ‰¾åˆ°â€git plunginâ€ ç„¶åŽç‚¹å‡»ç›´æŽ¥å®‰è£…ã€‚ï¼ˆè¿™å¯èƒ½è¦èŠ±ç‚¹æ—¶é—´ï¼‰3.ä¸‹å®Œgitæ’ä»¶åŽå°±è¦é…çŽ¯å¢ƒäº†ï¼Œè¿˜æ˜¯ç‚¹å‡»å³ä¾§â€œç³»ç»Ÿç®¡ç†â€=&gt;â€œç³»ç»Ÿè®¾ç½®â€ ä¸»è¦é…jdkå’Œmavençš„çŽ¯å¢ƒã€‚ï¼ˆæŠŠè‡ªåŠ¨å®‰è£…å‹¾æŽ‰å°±å¯ä»¥è¾“è·¯å¾„äº†ï¼‰ï¼Œä¿å­˜ä¸‹å°±å¯ä»¥äº†ã€‚ 4.ç‚¹å‡»å³ä¾§â€œæ–°å»ºâ€=&gt;â€œæž„å»ºä¸€ä¸ªmavené¡¹ç›®â€ è¾“å…¥åå­—åˆ°ä¸‹ä¸€æ­¥å¦‚ä¸‹å›¾å‹¾ä¸Šâ€œä¸¢å¼ƒæ—§çš„æž„å»ºâ€ï¼ŒæŒ‰ç…§è‡ªå·±çš„éœ€è¦é…ç½®ï¼Œå¦åˆ™å¾ˆå ç¡¬ç›˜ã€‚é…ç½®gitä»“åº“ï¼ˆå¦‚æžœæ˜¯ç§æœ‰åº“ï¼Œå¿…é¡»æ·»åŠ ä¸€ä¸ªCredentialsï¼Œç‚¹å‡»å³ä¾§Addï¼Œåœ¨å¼¹å‡ºç•Œé¢å½•å…¥å¸å·å¯†ç ï¼‰æŽ¥ä¸‹æ¥é…ç½®å®šæ—¶æž„å»ºï¼ˆå‹¾ä¸ŠBuild periodically,å›¾ä¸­è®¾ç½®æ˜¯æ¯15åˆ†é’Ÿä¸€æ¬¡ï¼‰ï¼Œé…ç½®è¦æ‰§è¡Œçš„mavenå‘½ä»¤ clean install (mvnä¸ç”¨è¾“)ä¿å­˜åŽï¼Œä¸€ä¸ªæž„å»ºå°±å¯ä»¥äº†ï¼ˆå¯ä»¥ç«‹å³æž„å»ºè¯•è¯•ï¼Œä¹Ÿå¯ä»¥å®šæ—¶æ‰§è¡Œï¼‰ã€‚jenkinsæä¾›äº†ä¸€å †çš„é¡µé¢åŽ»å±•ç¤ºæž„å»ºçš„è¿‡ç¨‹ï¼Œå¾ˆä¸é”™ã€‚å¦‚æžœwebç¨‹åºæƒ³è‡ªåŠ¨éƒ¨ç½²åˆ°æœ¬åœ°çš„tomcatï¼Œå¯ä»¥è¯•ä¸‹cargoæ’ä»¶ï¼ŒåŠ ä¸Šä¸‹é¢ä»£ç åˆ°é¡¹ç›®pomä¸Šã€‚ä¸‹é¢ä»£ç æ”¹ä¸‹è·¯å¾„å°±å¯ä»¥äº†ã€‚å½“ç„¶ä¹Ÿå¯ä»¥éƒ¨ç½²åˆ°è¿œç¨‹ï¼Œå°±ä¸è´´äº†ã€‚12345678910111213141516171819202122&lt;plugin&gt; &lt;groupId&gt;org.codehaus.cargo&lt;/groupId&gt; &lt;artifactId&gt;cargo-maven2-plugin&lt;/artifactId&gt; &lt;version&gt;1.4.5&lt;/version&gt; &lt;configuration&gt; &lt;container&gt; &lt;containerId&gt;tomcat7x&lt;/containerId&gt; &lt;home&gt;/opt/apache-tomcat-7.0.47&lt;/home&gt; &lt;/container&gt; &lt;configuration&gt; &lt;type&gt;existing&lt;/type&gt; &lt;home&gt;/opt/apache-tomcat-7.0.47&lt;/home&gt; &lt;/configuration&gt; &lt;/configuration&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;tomcat-deploy&lt;/id&gt; &lt;phase&gt;package&lt;/phase&gt; &lt;goals&gt;&lt;goal&gt;deploy&lt;/goal&gt;&lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; è¿™æ ·ä¸€ä¸ªæŒç»­é›†æˆå°±é…å¥½äº†ã€‚æƒ³æƒ³é‚£è¾¹æäº¤ä»£ç ï¼Œå¦ä¸€è¾¹å°±è‡ªåŠ¨éƒ¨ç½²åˆ°tomcatä¸Šï¼Œçˆ½æ­ªæ­ªäº†ã€‚]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jenkins</tag>
        <tag>git</tag>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[find å‘½ä»¤]]></title>
    <url>%2F2014%2F02%2F14%2Flinux-find%2F</url>
    <content type="text"><![CDATA[markä¸€ä¸‹ï¼Œå½“ç¬”è®°ï¼Œä»¥åŽå¿˜äº†æŸ¥çœ‹ æŸ¥æ‰¾æ–‡ä»¶find ./ -type f æŸ¥æ‰¾ç›®å½•find ./ -type d æŸ¥æ‰¾åå­—ä¸ºtestçš„æ–‡ä»¶æˆ–ç›®å½•find ./ -name test æŸ¥æ‰¾åå­—ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼çš„æ–‡ä»¶,æ³¨æ„å‰é¢çš„â€˜.â€™(æŸ¥æ‰¾åˆ°çš„æ–‡ä»¶å¸¦æœ‰ç›®å½•)find ./ -regex .so.*.gz æŸ¥æ‰¾ç›®å½•å¹¶åˆ—å‡ºç›®å½•ä¸‹çš„æ–‡ä»¶(ä¸ºæ‰¾åˆ°çš„æ¯ä¸€ä¸ªç›®å½•å•ç‹¬æ‰§è¡Œlså‘½ä»¤ï¼Œæ²¡æœ‰é€‰é¡¹-printæ—¶æ–‡ä»¶åˆ—è¡¨å‰ä¸€è¡Œä¸ä¼šæ˜¾ç¤ºç›®å½•åç§°)find ./ -type d -print -exec ls {} \; æŸ¥æ‰¾ç›®å½•å¹¶åˆ—å‡ºç›®å½•ä¸‹çš„æ–‡ä»¶(ä¸ºæ‰¾åˆ°çš„æ¯ä¸€ä¸ªç›®å½•å•ç‹¬æ‰§è¡Œlså‘½ä»¤,æ‰§è¡Œå‘½ä»¤å‰éœ€è¦ç¡®è®¤)find ./ -type d -ok ls {} \; æŸ¥æ‰¾ç›®å½•å¹¶åˆ—å‡ºç›®å½•ä¸‹çš„æ–‡ä»¶(å°†æ‰¾åˆ°çš„ç›®å½•æ·»åŠ åˆ°lså‘½ä»¤åŽä¸€æ¬¡æ‰§è¡Œï¼Œå‚æ•°è¿‡é•¿æ—¶ä¼šåˆ†å¤šæ¬¡æ‰§è¡Œ)find ./ -type d -exec ls {} + æŸ¥æ‰¾æ–‡ä»¶ååŒ¹é….cçš„æ–‡ä»¶find ./ -name \.c æ‰“å°testæ–‡ä»¶ååŽï¼Œæ‰“å°testæ–‡ä»¶çš„å†…å®¹find ./ -name test -print -exec cat {} \; ä¸æ‰“å°testæ–‡ä»¶åï¼Œåªæ‰“å°testæ–‡ä»¶çš„å†…å®¹find ./ -name test -exec cat {} \; æŸ¥æ‰¾æ–‡ä»¶æ›´æ–°æ—¥æ—¶åœ¨è·çŽ°åœ¨æ—¶åˆ»äºŒå¤©ä»¥å†…çš„æ–‡ä»¶find ./ -mtime -2 æŸ¥æ‰¾æ–‡ä»¶æ›´æ–°æ—¥æ—¶åœ¨è·çŽ°åœ¨æ—¶åˆ»äºŒå¤©ä»¥ä¸Šçš„æ–‡ä»¶find ./ -mtime +2 æŸ¥æ‰¾æ–‡ä»¶æ›´æ–°æ—¥æ—¶åœ¨è·çŽ°åœ¨æ—¶åˆ»ä¸€å¤©ä»¥ä¸ŠäºŒå¤©ä»¥å†…çš„æ–‡ä»¶find ./ -mtime 2 æŸ¥æ‰¾æ–‡ä»¶æ›´æ–°æ—¥æ—¶åœ¨è·çŽ°åœ¨æ—¶åˆ»äºŒåˆ†ä»¥å†…çš„æ–‡ä»¶find ./ -mmin -2 æŸ¥æ‰¾æ–‡ä»¶æ›´æ–°æ—¥æ—¶åœ¨è·çŽ°åœ¨æ—¶åˆ»äºŒåˆ†ä»¥ä¸Šçš„æ–‡ä»¶find ./ -mmin +2 æŸ¥æ‰¾æ–‡ä»¶æ›´æ–°æ—¥æ—¶åœ¨è·çŽ°åœ¨æ—¶åˆ»ä¸€åˆ†ä»¥ä¸ŠäºŒåˆ†ä»¥å†…çš„æ–‡ä»¶find ./ -mmin 2 æŸ¥æ‰¾æ–‡ä»¶æ›´æ–°æ—¶é—´æ¯”æ–‡ä»¶abcçš„å†…å®¹æ›´æ–°æ—¶é—´æ–°çš„æ–‡ä»¶find ./ -newer abc æŸ¥æ‰¾æ–‡ä»¶è®¿é—®æ—¶é—´æ¯”æ–‡ä»¶abcçš„å†…å®¹æ›´æ–°æ—¶é—´æ–°çš„æ–‡ä»¶find ./ -anewer abc æŸ¥æ‰¾ç©ºæ–‡ä»¶æˆ–ç©ºç›®å½•find ./ -empty æŸ¥æ‰¾ç©ºæ–‡ä»¶å¹¶åˆ é™¤find ./ -empty -type f -print -delete æŸ¥æ‰¾æƒé™ä¸º644çš„æ–‡ä»¶æˆ–ç›®å½•(éœ€å®Œå…¨ç¬¦åˆ)find ./ -perm 664 æŸ¥æ‰¾ç”¨æˆ·/ç»„æƒé™ä¸ºè¯»å†™ï¼Œå…¶ä»–ç”¨æˆ·æƒé™ä¸ºè¯»(å…¶ä»–æƒé™ä¸é™)çš„æ–‡ä»¶æˆ–ç›®å½•find ./ -perm -664 æŸ¥æ‰¾ç”¨æˆ·æœ‰å†™æƒé™æˆ–è€…ç»„ç”¨æˆ·æœ‰å†™æƒé™çš„æ–‡ä»¶æˆ–ç›®å½•find ./ -perm /220find ./ -perm /u+w,g+wfind ./ -perm /u=w,g=w æŸ¥æ‰¾æ‰€æœ‰è€…æƒé™æœ‰è¯»æƒé™çš„ç›®å½•æˆ–æ–‡ä»¶find ./ -perm -u=r æŸ¥æ‰¾ç”¨æˆ·ç»„æƒé™æœ‰è¯»æƒé™çš„ç›®å½•æˆ–æ–‡ä»¶find ./ -perm -g=r æŸ¥æ‰¾å…¶å®ƒç”¨æˆ·æƒé™æœ‰è¯»æƒé™çš„ç›®å½•æˆ–æ–‡ä»¶find ./ -perm -o=r æŸ¥æ‰¾æ‰€æœ‰è€…ä¸ºlzjçš„æ–‡ä»¶æˆ–ç›®å½•find ./ -user lzj æŸ¥æ‰¾ç»„åä¸ºgnameçš„æ–‡ä»¶æˆ–ç›®å½•find ./ -group gname æŸ¥æ‰¾æ–‡ä»¶çš„ç”¨æˆ·IDä¸å­˜åœ¨çš„æ–‡ä»¶find ./ -nouser æŸ¥æ‰¾æ–‡ä»¶çš„ç»„IDä¸å­˜åœ¨çš„æ–‡ä»¶find ./ -nogroup æŸ¥æ‰¾æœ‰æ‰§è¡Œæƒé™ä½†æ²¡æœ‰å¯è¯»æƒé™çš„æ–‡ä»¶find ./ -executable ! -readable æŸ¥æ‰¾æ–‡ä»¶sizeå°äºŽ10ä¸ªå­—èŠ‚çš„æ–‡ä»¶æˆ–ç›®å½•find ./ -size -10c æŸ¥æ‰¾æ–‡ä»¶sizeç­‰äºŽ10ä¸ªå­—èŠ‚çš„æ–‡ä»¶æˆ–ç›®å½•find ./ -size 10c æŸ¥æ‰¾æ–‡ä»¶sizeå¤§äºŽ10ä¸ªå­—èŠ‚çš„æ–‡ä»¶æˆ–ç›®å½•find ./ -size +10c æŸ¥æ‰¾æ–‡ä»¶sizeå°äºŽ10kçš„æ–‡ä»¶æˆ–ç›®å½•find ./ -size -10k æŸ¥æ‰¾æ–‡ä»¶sizeå°äºŽ10Mçš„æ–‡ä»¶æˆ–ç›®å½•find ./ -size -10M æŸ¥æ‰¾æ–‡ä»¶sizeå°äºŽ10Gçš„æ–‡ä»¶æˆ–ç›®å½•find ./ -size -10G]]></content>
      <categories>
        <category>linuxå‘½ä»¤</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>find</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[crontab å‘½ä»¤]]></title>
    <url>%2F2014%2F02%2F13%2Flinux-crontab%2F</url>
    <content type="text"><![CDATA[ä¸€èˆ¬ç¼–å†™è°ƒåº¦è®©ç³»ç»Ÿå¸®ä½ å®šæ—¶åšäº‹æƒ…æœ‰ä¸¤ç§æ–¹å¼ï¼š åœ¨/etcç›®å½•ä¸‹æœ‰ä¸€ä¸ªcrontabæ–‡ä»¶ï¼Œè¿™é‡Œå­˜æ”¾æœ‰ç³»ç»Ÿè¿è¡Œçš„ä¸€äº›è°ƒåº¦ç¨‹åº,å¯ä»¥æŠŠè‡ªå·±çš„è°ƒåº¦å†™åœ¨è¿™é‡Œã€‚ æ¯ä¸ªç”¨æˆ·å¯ä»¥ç”¨crontabå‘½ä»¤å»ºç«‹è‡ªå·±çš„è°ƒåº¦,è°ƒåº¦æ–‡ä»¶å­˜æ”¾åœ¨ä»¥ç”¨æˆ·åä¸ºåçš„æ–‡ä»¶/usr/spool/cron/crontabs/usernameã€‚ crontabå‘½ä»¤æœ‰ä¸‰ç§å½¢å¼çš„å‘½ä»¤è¡Œç»“æž„ï¼š crontab [-u user] [file] crontab [-u user] [-e|-l|-r] crontab -l -u [-e|-l|-r] ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œä¸­ï¼Œfileæ˜¯å‘½ä»¤æ–‡ä»¶çš„åå­—ã€‚å¦‚æžœåœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šäº†è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆæ‰§è¡Œcrontabå‘½ä»¤ï¼Œåˆ™å°†è¿™ä¸ªæ–‡ä»¶æ‹·è´åˆ°crontabsç›®å½•ä¸‹ï¼›å¦‚æžœåœ¨å‘½ä»¤è¡Œä¸­æ²¡æœ‰åˆ¶å®šè¿™ä¸ªæ–‡ä»¶ï¼Œcrontabå‘½ä»¤å°†æŽ¥å—æ ‡å‡†è¾“å…¥ï¼ˆé”®ç›˜ï¼‰ä¸Šé”®å…¥çš„å‘½ä»¤ï¼Œå¹¶å°†ä»–ä»¬ä¹Ÿå­˜æ”¾åœ¨crontabç›®å½•ä¸‹ã€‚ å‘½ä»¤è¡Œä¸­-ré€‰é¡¹çš„ä½œç”¨æ˜¯ä»Ž/usr/spool/cron/crontabsç›®å½•ä¸‹åˆ é™¤ç”¨æˆ·å®šä¹‰çš„æ–‡ä»¶crontabï¼› å‘½ä»¤è¡Œä¸­-lé€‰é¡¹çš„ä½œç”¨æ˜¯æ˜¾ç¤ºç”¨æˆ·crontabæ–‡ä»¶çš„å†…å®¹ã€‚ ä½¿ç”¨å‘½ä»¤crontab -u user -eå‘½ä»¤ç¼–è¾‘ç”¨æˆ·userçš„cron(c)ä½œä¸šã€‚ç”¨æˆ·é€šè¿‡ç¼–è¾‘æ–‡ä»¶æ¥å¢žåŠ æˆ–ä¿®æ”¹ä»»ä½•ä½œä¸šè¯·æ±‚ã€‚ æ‰§è¡Œå‘½ä»¤crontab -u user -rå³å¯åˆ é™¤å½“å‰ç”¨æˆ·çš„æ‰€æœ‰çš„cronä½œä¸šã€‚ ä½œä¸šä¸Žå®ƒä»¬é¢„å®šçš„æ—¶é—´å‚¨å­˜åœ¨æ–‡ä»¶/usr/spool/cron/crontabs/usernameé‡Œã€‚usernameä½¿ç”¨æˆ·åï¼Œåœ¨ç›¸åº”çš„æ–‡ä»¶ä¸­å­˜æ”¾ç€è¯¥ç”¨æˆ·æ‰€è¦è¿è¡Œçš„å‘½ä»¤ã€‚å‘½ä»¤æ‰§è¡Œçš„ç»“æžœï¼Œæ— è®ºæ˜¯æ ‡å‡†è¾“å‡ºè¿˜æ˜¯é”™è¯¯è¾“å‡ºï¼Œéƒ½å°†ä»¥é‚®ä»¶å½¢å¼å‘ç»™ç”¨æˆ·ã€‚æ–‡ä»¶é‡Œçš„æ¯ä¸€ä¸ªè¯·æ±‚å¿…é¡»åŒ…å«ä»¥spaceså’Œtabsåˆ†å‰²çš„å…­ä¸ªåŸŸã€‚å‰äº”ä¸ªå­—æ®µå¯ä»¥å–æ•´æ•°å€¼ï¼ŒæŒ‡å®šä½•æ—¶å¼€å§‹å·¥ä½œï¼Œç¬¬å…­ä¸ªåŸŸæ˜¯å­—ç¬¦ä¸²ï¼Œç§°ä¸ºå‘½ä»¤å­—æ®µï¼Œå…¶ä¸­åŒ…æ‹¬äº†crontabè°ƒåº¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ ç¬¬ä¸€é“ç¬¬äº”ä¸ªå­—æ®µçš„æ•´æ•°å–å€¼èŒƒå›´åŠæ„ä¹‰æ˜¯ï¼š 0ï½ž59 è¡¨ç¤ºåˆ† 1ï½ž23 è¡¨ç¤ºå°æ—¶ 1ï½ž31 è¡¨ç¤ºæ—¥ 1ï½ž12 è¡¨ç¤ºæœˆä»½ 0ï½ž6 è¡¨ç¤ºæ˜ŸæœŸï¼ˆå…¶ä¸­0è¡¨ç¤ºæ˜ŸæœŸæ—¥ï¼‰ /usr/lib/cron/cron.allowè¡¨ç¤ºè°èƒ½ä½¿ç”¨crontabå‘½ä»¤ã€‚å¦‚æžœå®ƒæ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶è¡¨æ˜Žæ²¡æœ‰ä¸€ä¸ªç”¨æˆ·èƒ½å®‰æŽ’ä½œä¸šã€‚å¦‚æžœè¿™ä¸ªæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè€Œæœ‰å¦å¤–ä¸€ä¸ªæ–‡ä»¶/usr/lib/cron/cron.deny,åˆ™åªæœ‰ä¸åŒ…æ‹¬åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç”¨æˆ·æ‰å¯ä»¥ä½¿ç”¨crontabå‘½ä»¤ã€‚å¦‚æžœå®ƒæ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶è¡¨æ˜Žä»»ä½•ç”¨æˆ·éƒ½å¯å®‰æŽ’ä½œä¸šã€‚ä¸¤ä¸ªæ–‡ä»¶åŒæ—¶å­˜åœ¨æ—¶cron.allowä¼˜å…ˆï¼Œå¦‚æžœéƒ½ä¸å­˜åœ¨ï¼Œåªæœ‰è¶…çº§ç”¨æˆ·å¯ä»¥å®‰æŽ’ä½œä¸šã€‚]]></content>
      <categories>
        <category>linuxå‘½ä»¤</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>crontab</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[jQuery.extend å‡½æ•°è¯¦è§£]]></title>
    <url>%2F2014%2F02%2F05%2Fjquery-extend%2F</url>
    <content type="text"><![CDATA[Jqueryçš„æ‰©å±•æ–¹æ³•extendæ˜¯æˆ‘ä»¬åœ¨å†™æ’ä»¶çš„è¿‡ç¨‹ä¸­å¸¸ç”¨çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ‰ä¸€äº›é‡è½½åŽŸåž‹ï¼Œåœ¨æ­¤ï¼Œæˆ‘ä»¬ä¸€èµ·åŽ»äº†è§£äº†è§£ã€‚ å¦‚ä½•ä½¿ç”¨Jqueryçš„æ‰©å±•æ–¹æ³•åŽŸåž‹æ˜¯: 1extend(dest,src1,src2,src3...); å®ƒçš„å«ä¹‰æ˜¯å°†src1,src2,src3â€¦åˆå¹¶åˆ°destä¸­,è¿”å›žå€¼ä¸ºåˆå¹¶åŽçš„dest,ç”±æ­¤å¯ä»¥çœ‹å‡ºè¯¥æ–¹æ³•åˆå¹¶åŽï¼Œæ˜¯ä¿®æ”¹äº†destçš„ç»“æž„çš„ã€‚å¦‚æžœæƒ³è¦å¾—åˆ°åˆå¹¶çš„ç»“æžœå´åˆä¸æƒ³ä¿®æ”¹destçš„ç»“æž„ï¼Œå¯ä»¥å¦‚ä¸‹ä½¿ç”¨ï¼š1var newSrc=$.extend(&#123;&#125;,src1,src2,src3...)//ä¹Ÿå°±æ˜¯å°†"&#123;&#125;"ä½œä¸ºdestå‚æ•°ã€‚ è¿™æ ·å°±å¯ä»¥å°†src1,src2,src3â€¦è¿›è¡Œåˆå¹¶ï¼Œç„¶åŽå°†åˆå¹¶ç»“æžœè¿”å›žç»™newSrcäº†ã€‚å¦‚ä¸‹ä¾‹ï¼š1var result=$.extend(&#123;&#125;,&#123;name:"Tom",age:21&#125;,&#123;name:"Jerry",sex:"Boy"&#125;) é‚£ä¹ˆåˆå¹¶åŽçš„ç»“æžœ1result=&#123;name:"Jerry",age:21,sex:"Boy"&#125; ä¹Ÿå°±æ˜¯è¯´åŽé¢çš„å‚æ•°å¦‚æžœå’Œå‰é¢çš„å‚æ•°å­˜åœ¨ç›¸åŒçš„åç§°ï¼Œé‚£ä¹ˆåŽé¢çš„ä¼šè¦†ç›–å‰é¢çš„å‚æ•°å€¼ã€‚ çœç•¥destå‚æ•°ä¸Šè¿°çš„extendæ–¹æ³•åŽŸåž‹ä¸­çš„destå‚æ•°æ˜¯å¯ä»¥çœç•¥çš„ï¼Œå¦‚æžœçœç•¥äº†ï¼Œåˆ™è¯¥æ–¹æ³•å°±åªèƒ½æœ‰ä¸€ä¸ªsrcå‚æ•°ï¼Œè€Œä¸”æ˜¯å°†è¯¥srcåˆå¹¶åˆ°è°ƒç”¨extendæ–¹æ³•çš„å¯¹è±¡ä¸­åŽ»ï¼Œå¦‚ï¼š $.extend(src)è¯¥æ–¹æ³•å°±æ˜¯å°†srcåˆå¹¶åˆ°jqueryçš„å…¨å±€å¯¹è±¡ä¸­åŽ»ï¼Œå¦‚ï¼š123$.extend(&#123; hello:function()&#123;alert('hello');&#125; &#125;); å°±æ˜¯å°†helloæ–¹æ³•åˆå¹¶åˆ°jqueryçš„å…¨å±€å¯¹è±¡ä¸­ã€‚ $.fn.extend(src)è¯¥æ–¹æ³•å°†srcåˆå¹¶åˆ°jqueryçš„å®žä¾‹å¯¹è±¡ä¸­åŽ»ï¼Œå¦‚:123$.fn.extend(&#123; hello:function()&#123;alert('hello');&#125; &#125;); å°±æ˜¯å°†helloæ–¹æ³•åˆå¹¶åˆ°jqueryçš„å®žä¾‹å¯¹è±¡ä¸­ã€‚ ä¸¾ä¸ªä¾‹å­1234567$.extend(&#123;net:&#123;&#125;&#125;);```` è¿™æ˜¯åœ¨jqueryå…¨å±€å¯¹è±¡ä¸­æ‰©å±•ä¸€ä¸ªnetå‘½åç©ºé—´ã€‚ ````javascript$.extend($.net,&#123; hello:function()&#123;alert('hello');&#125; &#125;) è¿™æ˜¯å°†helloæ–¹æ³•æ‰©å±•åˆ°ä¹‹å‰æ‰©å±•çš„Jqueryçš„netå‘½åç©ºé—´ä¸­åŽ»ã€‚ Jqueryçš„extendæ–¹æ³•è¿˜æœ‰ä¸€ä¸ªé‡è½½åŽŸåž‹1234567extend(boolean,dest,src1,src2,src3...)```` ç¬¬ä¸€ä¸ªå‚æ•°booleanä»£è¡¨æ˜¯å¦è¿›è¡Œæ·±åº¦æ‹·è´ï¼Œå…¶ä½™å‚æ•°å’Œå‰é¢ä»‹ç»çš„ä¸€è‡´ï¼Œä»€ä¹ˆå«æ·±å±‚æ‹·è´ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š ````javascriptvar result=$.extend( true, &#123;&#125;, &#123; name: &quot;John&quot;, location: &#123;city: &quot;Boston&quot;,county:&quot;USA&quot;&#125; &#125;, &#123; last: &quot;Resig&quot;, location: &#123;state: &quot;MA&quot;,county:&quot;China&quot;&#125; &#125; ); æˆ‘ä»¬å¯ä»¥çœ‹å‡ºsrc1ä¸­åµŒå¥—å­å¯¹è±¡location:{city:â€Bostonâ€},src2ä¸­ä¹ŸåµŒå¥—å­å¯¹è±¡location:{state:â€MAâ€},ç¬¬ä¸€ä¸ªæ·±åº¦æ‹·è´å‚æ•°ä¸ºtrueï¼Œé‚£ä¹ˆåˆå¹¶åŽçš„ç»“æžœå°±æ˜¯ï¼š12result=&#123;name:"John",last:"Resig", location:&#123;city:"Boston",state:"MA",county:"China"&#125;&#125; ä¹Ÿå°±æ˜¯è¯´å®ƒä¼šå°†srcä¸­çš„åµŒå¥—å­å¯¹è±¡ä¹Ÿè¿›è¡Œåˆå¹¶ï¼Œè€Œå¦‚æžœç¬¬ä¸€ä¸ªå‚æ•°booleanä¸ºfalseï¼Œæˆ‘ä»¬çœ‹çœ‹åˆå¹¶çš„ç»“æžœæ˜¯ä»€ä¹ˆï¼Œå¦‚ä¸‹ï¼š1234var result=$.extend( false, &#123;&#125;, &#123; name: "John", location:&#123;city: "Boston",county:"USA"&#125; &#125;, &#123; last: "Resig", location: &#123;state: "MA",county:"China"&#125; &#125; ); é‚£ä¹ˆåˆå¹¶åŽçš„ç»“æžœå°±æ˜¯:1result=&#123;name:"John",last:"Resig",location:&#123;state:"MA",county:"China"&#125;&#125; ä»¥ä¸Šå°±æ˜¯$.extend()åœ¨é¡¹ç›®ä¸­ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„ä¸€äº›ç»†èŠ‚ã€‚]]></content>
      <categories>
        <category>jQuery</category>
      </categories>
      <tags>
        <tag>jQuery</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…³äºŽjQueryæ–°çš„äº‹ä»¶ç»‘å®šæœºåˆ¶on()çš„ä½¿ç”¨æŠ€å·§]]></title>
    <url>%2F2014%2F01%2F11%2Fjquery-on%2F</url>
    <content type="text"><![CDATA[æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†ï¼Œå…³äºŽjQueryæ–°çš„äº‹ä»¶ç»‘å®šæœºåˆ¶on()çš„ä½¿ç”¨æŠ€å·§ã€‚éœ€è¦çš„æœ‹å‹å‚è€ƒä¸‹ä»Šå¤©æµè§ˆjQueryçš„deprecatedåˆ—è¡¨ï¼Œå‘çŽ°live()å’Œdie()åœ¨é‡Œé¢äº†ï¼Œèµ¶ç´§çœ‹äº†ä¸€ä¸‹ï¼Œå‘çŽ°ä»ŽjQuery1.7å¼€å§‹ï¼ŒjQueryå¼•å…¥äº†å…¨æ–°çš„äº‹ä»¶ç»‘å®šæœºåˆ¶ï¼Œon()å’Œoff()ä¸¤ä¸ªå‡½æ•°ç»Ÿä¸€å¤„ç†äº‹ä»¶ç»‘å®šã€‚å› ä¸ºåœ¨æ­¤ä¹‹å‰æœ‰bind(), live(), delegate()ç­‰æ–¹æ³•æ¥å¤„ç†äº‹ä»¶ç»‘å®šï¼ŒjQueryä»Žæ€§èƒ½ä¼˜åŒ–ä»¥åŠæ–¹å¼ç»Ÿä¸€æ–¹é¢è€ƒè™‘å†³å®šæŽ¨å‡ºæ–°çš„å‡½æ•°æ¥ç»Ÿä¸€äº‹ä»¶ç»‘å®šæ–¹æ³•å¹¶ä¸”æ›¿æ¢æŽ‰ä»¥å‰çš„æ–¹æ³•ã€‚ ç”¨æ³•1on(events,[selector],[data],fn) events:ä¸€ä¸ªæˆ–å¤šä¸ªç”¨ç©ºæ ¼åˆ†éš”çš„äº‹ä»¶ç±»åž‹å’Œå¯é€‰çš„å‘½åç©ºé—´ï¼Œå¦‚â€clickâ€æˆ–â€keydown.myPluginâ€ ã€‚selector:ä¸€ä¸ªé€‰æ‹©å™¨å­—ç¬¦ä¸²ç”¨äºŽè¿‡æ»¤å™¨çš„è§¦å‘äº‹ä»¶çš„é€‰æ‹©å™¨å…ƒç´ çš„åŽä»£ã€‚å¦‚æžœé€‰æ‹©å™¨ä¸ºnullæˆ–çœç•¥ï¼Œå½“å®ƒåˆ°è¾¾é€‰å®šçš„å…ƒç´ ï¼Œäº‹ä»¶æ€»æ˜¯è§¦å‘ã€‚data:å½“ä¸€ä¸ªäº‹ä»¶è¢«è§¦å‘æ—¶è¦ä¼ é€’event.dataç»™äº‹ä»¶å¤„ç†å‡½æ•°ã€‚fn:è¯¥äº‹ä»¶è¢«è§¦å‘æ—¶æ‰§è¡Œçš„å‡½æ•°ã€‚ false å€¼ä¹Ÿå¯ä»¥åšä¸€ä¸ªå‡½æ•°çš„ç®€å†™ï¼Œè¿”å›žfalseã€‚ æ›¿æ¢bind()å½“ç¬¬äºŒä¸ªå‚æ•°â€™selectorâ€™ä¸ºnullæ—¶ï¼Œon()å’Œbind()å…¶å®žåœ¨ç”¨æ³•ä¸ŠåŸºæœ¬ä¸Šæ²¡æœ‰ä»»ä½•åŒºåˆ«äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤ä¸ºon()åªæ˜¯æ¯”bind()å¤šäº†ä¸€ä¸ªå¯é€‰çš„â€™selectorâ€™å‚æ•°ï¼Œæ‰€ä»¥on()å¯ä»¥éžå¸¸æ–¹ä¾¿çš„æ¢æŽ‰bind() æ›¿æ¢live()åœ¨1.4ä¹‹å‰ç›¸ä¿¡å¤§å®¶éžå¸¸å–œæ¬¢ä½¿ç”¨live(),å› ä¸ºå®ƒå¯ä»¥æŠŠäº‹ä»¶ç»‘å®šåˆ°å½“å‰ä»¥åŠä»¥åŽæ·»åŠ çš„å…ƒç´ ä¸Šé¢ï¼Œå½“ç„¶åœ¨1.4ä¹‹åŽdelegate()ä¹Ÿå¯ä»¥åšç±»ä¼¼çš„äº‹æƒ…äº†ã€‚live()çš„åŽŸç†å¾ˆç®€å•ï¼Œå®ƒæ˜¯é€šè¿‡documentè¿›è¡Œäº‹ä»¶å§”æ´¾çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨on()é€šè¿‡å°†äº‹ä»¶ç»‘å®šåˆ°documentæ¥è¾¾åˆ°live()ä¸€æ ·çš„æ•ˆæžœã€‚ live()å†™æ³•123 $('#list li').live('click', '#list li', function() &#123; //function code here. &#125;); on()å†™æ³•123$(document).on('click', '#list li', function() &#123; //function code here.&#125;); è¿™é‡Œçš„å…³é”®å°±æ˜¯ç¬¬äºŒä¸ªå‚æ•°â€™selectorâ€™åœ¨èµ·ä½œç”¨äº†ã€‚å®ƒæ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨çš„ä½œç”¨ï¼Œåªæœ‰è¢«é€‰ä¸­å…ƒç´ çš„åŽä»£å…ƒç´ æ‰ä¼šè§¦å‘äº‹ä»¶ã€‚ æ›¿æ¢delegate()delegate()æ˜¯1.4å¼•å…¥çš„ï¼Œç›®çš„æ˜¯é€šè¿‡ç¥–å…ˆå…ƒç´ æ¥ä»£ç†å§”æ´¾åŽä»£å…ƒç´ çš„äº‹ä»¶ç»‘å®šé—®é¢˜ï¼ŒæŸç§ç¨‹åº¦ä¸Šå’Œlive()ä¼˜ç‚¹ç›¸ä¼¼ã€‚åªä¸è¿‡live()æ˜¯é€šè¿‡documentå…ƒç´ å§”æ´¾ï¼Œè€Œdelegateåˆ™å¯ä»¥æ˜¯ä»»æ„çš„ç¥–å…ˆèŠ‚ç‚¹ã€‚ä½¿ç”¨on()å®žçŽ°ä»£ç†çš„å†™æ³•å’Œdelegate()åŸºæœ¬ä¸€è‡´ã€‚ delegate()çš„å†™æ³•123$('#list').delegate('li', 'click', function() &#123; //function code here. &#125;); on()å†™æ³•123$('#list').on('click', 'li', function() &#123; //function code here.&#125;); è²Œä¼¼ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå‚æ•°çš„é¡ºåºé¢ å€’äº†ä¸€ä¸‹ï¼Œåˆ«çš„åŸºæœ¬ä¸€æ ·ã€‚ æ€»ç»“jQueryæŽ¨å‡ºon()çš„ç›®çš„æœ‰2ä¸ªï¼Œä¸€æ˜¯ä¸ºäº†ç»Ÿä¸€æŽ¥å£ï¼ŒäºŒæ˜¯ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæ‰€ä»¥ä»ŽçŽ°åœ¨å¼€å§‹ç”¨on()æ›¿æ¢bind(), live(), delegateå§ã€‚å°¤å…¶æ˜¯ä¸è¦å†ç”¨live()äº†ï¼Œå› ä¸ºå®ƒå·²ç»å¤„äºŽä¸æŽ¨èä½¿ç”¨åˆ—è¡¨äº†ï¼Œéšæ—¶ä¼šè¢«å¹²æŽ‰ã€‚å¦‚æžœåªç»‘å®šä¸€æ¬¡äº‹ä»¶ï¼Œé‚£æŽ¥ç€ç”¨one()å§ï¼Œè¿™ä¸ªæ²¡æœ‰å˜åŒ–ã€‚]]></content>
      <categories>
        <category>jQuery</category>
      </categories>
      <tags>
        <tag>jQuery</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[linux awkå‘½ä»¤è¯¦è§£]]></title>
    <url>%2F2014%2F01%2F06%2Flinux-awk%2F</url>
    <content type="text"><![CDATA[ç®€ä»‹awkæ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ–‡æœ¬åˆ†æžå·¥å…·ï¼Œç›¸å¯¹äºŽgrepçš„æŸ¥æ‰¾ï¼Œsedçš„ç¼–è¾‘ï¼Œawkåœ¨å…¶å¯¹æ•°æ®åˆ†æžå¹¶ç”ŸæˆæŠ¥å‘Šæ—¶ï¼Œæ˜¾å¾—å°¤ä¸ºå¼ºå¤§ã€‚ç®€å•æ¥è¯´awkå°±æ˜¯æŠŠæ–‡ä»¶é€è¡Œçš„è¯»å…¥ï¼Œä»¥ç©ºæ ¼ä¸ºé»˜è®¤åˆ†éš”ç¬¦å°†æ¯è¡Œåˆ‡ç‰‡ï¼Œåˆ‡å¼€çš„éƒ¨åˆ†å†è¿›è¡Œå„ç§åˆ†æžå¤„ç†ã€‚ awkæœ‰3ä¸ªä¸åŒç‰ˆæœ¬: awkã€nawkå’Œgawkï¼Œæœªä½œç‰¹åˆ«è¯´æ˜Žï¼Œä¸€èˆ¬æŒ‡gawkï¼Œgawk æ˜¯ AWK çš„ GNU ç‰ˆæœ¬ã€‚ awkå…¶åç§°å¾—è‡ªäºŽå®ƒçš„åˆ›å§‹äºº Alfred Aho ã€Peter Weinberger å’Œ Brian Kernighan å§“æ°çš„é¦–ä¸ªå­—æ¯ã€‚å®žé™…ä¸Š AWK çš„ç¡®æ‹¥æœ‰è‡ªå·±çš„è¯­è¨€ï¼š AWK ç¨‹åºè®¾è®¡è¯­è¨€ ï¼Œ ä¸‰ä½åˆ›å»ºè€…å·²å°†å®ƒæ­£å¼å®šä¹‰ä¸ºâ€œæ ·å¼æ‰«æå’Œå¤„ç†è¯­è¨€â€ã€‚å®ƒå…è®¸æ‚¨åˆ›å»ºç®€çŸ­çš„ç¨‹åºï¼Œè¿™äº›ç¨‹åºè¯»å–è¾“å…¥æ–‡ä»¶ã€ä¸ºæ•°æ®æŽ’åºã€å¤„ç†æ•°æ®ã€å¯¹è¾“å…¥æ‰§è¡Œè®¡ç®—ä»¥åŠç”ŸæˆæŠ¥è¡¨ï¼Œè¿˜æœ‰æ— æ•°å…¶ä»–çš„åŠŸèƒ½ã€‚ ä½¿ç”¨æ–¹æ³•1awk &apos;&#123;pattern + action&#125;&apos; &#123;filenames&#125; å°½ç®¡æ“ä½œå¯èƒ½ä¼šå¾ˆå¤æ‚ï¼Œä½†è¯­æ³•æ€»æ˜¯è¿™æ ·ï¼Œå…¶ä¸­ pattern è¡¨ç¤º AWK åœ¨æ•°æ®ä¸­æŸ¥æ‰¾çš„å†…å®¹ï¼Œè€Œ action æ˜¯åœ¨æ‰¾åˆ°åŒ¹é…å†…å®¹æ—¶æ‰€æ‰§è¡Œçš„ä¸€ç³»åˆ—å‘½ä»¤ã€‚èŠ±æ‹¬å·ï¼ˆ{}ï¼‰ä¸éœ€è¦åœ¨ç¨‹åºä¸­å§‹ç»ˆå‡ºçŽ°ï¼Œä½†å®ƒä»¬ç”¨äºŽæ ¹æ®ç‰¹å®šçš„æ¨¡å¼å¯¹ä¸€ç³»åˆ—æŒ‡ä»¤è¿›è¡Œåˆ†ç»„ã€‚ patternå°±æ˜¯è¦è¡¨ç¤ºçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ–œæ æ‹¬èµ·æ¥ã€‚ awkè¯­è¨€çš„æœ€åŸºæœ¬åŠŸèƒ½æ˜¯åœ¨æ–‡ä»¶æˆ–è€…å­—ç¬¦ä¸²ä¸­åŸºäºŽæŒ‡å®šè§„åˆ™æµè§ˆå’ŒæŠ½å–ä¿¡æ¯ï¼ŒawkæŠ½å–ä¿¡æ¯åŽï¼Œæ‰èƒ½è¿›è¡Œå…¶ä»–æ–‡æœ¬æ“ä½œã€‚å®Œæ•´çš„awkè„šæœ¬é€šå¸¸ç”¨æ¥æ ¼å¼åŒ–æ–‡æœ¬æ–‡ä»¶ä¸­çš„ä¿¡æ¯ã€‚ é€šå¸¸ï¼Œawkæ˜¯ä»¥æ–‡ä»¶çš„ä¸€è¡Œä¸ºå¤„ç†å•ä½çš„ã€‚awkæ¯æŽ¥æ”¶æ–‡ä»¶çš„ä¸€è¡Œï¼Œç„¶åŽæ‰§è¡Œç›¸åº”çš„å‘½ä»¤ï¼Œæ¥å¤„ç†æ–‡æœ¬ã€‚ è°ƒç”¨awkæœ‰ä¸‰ç§æ–¹å¼è°ƒç”¨awk 1.å‘½ä»¤è¡Œæ–¹å¼awk [-F field-separator] â€˜commandsâ€™ input-file(s)å…¶ä¸­ï¼Œcommands æ˜¯çœŸæ­£awkå‘½ä»¤ï¼Œ[-FåŸŸåˆ†éš”ç¬¦]æ˜¯å¯é€‰çš„ã€‚ input-file(s) æ˜¯å¾…å¤„ç†çš„æ–‡ä»¶ã€‚åœ¨awkä¸­ï¼Œæ–‡ä»¶çš„æ¯ä¸€è¡Œä¸­ï¼Œç”±åŸŸåˆ†éš”ç¬¦åˆ†å¼€çš„æ¯ä¸€é¡¹ç§°ä¸ºä¸€ä¸ªåŸŸã€‚é€šå¸¸ï¼Œåœ¨ä¸æŒ‡å-FåŸŸåˆ†éš”ç¬¦çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤çš„åŸŸåˆ†éš”ç¬¦æ˜¯ç©ºæ ¼ã€‚ 2.shellè„šæœ¬æ–¹å¼å°†æ‰€æœ‰çš„awkå‘½ä»¤æ’å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä½¿awkç¨‹åºå¯æ‰§è¡Œï¼Œç„¶åŽawkå‘½ä»¤è§£é‡Šå™¨ä½œä¸ºè„šæœ¬çš„é¦–è¡Œï¼Œä¸€éé€šè¿‡é”®å…¥è„šæœ¬åç§°æ¥è°ƒç”¨ã€‚ç›¸å½“äºŽshellè„šæœ¬é¦–è¡Œçš„ï¼š#!/bin/shå¯ä»¥æ¢æˆï¼š#!/bin/awk 3.å°†æ‰€æœ‰çš„awkå‘½ä»¤æ’å…¥ä¸€ä¸ªå•ç‹¬æ–‡ä»¶ï¼Œç„¶åŽè°ƒç”¨ï¼š1awk -f awk-script-file input-file(s) å…¶ä¸­ï¼Œ-fé€‰é¡¹åŠ è½½awk-script-fileä¸­çš„awkè„šæœ¬ï¼Œinput-file(s)è·Ÿä¸Šé¢çš„æ˜¯ä¸€æ ·çš„ã€‚ æœ¬ç« é‡ç‚¹ä»‹ç»å‘½ä»¤è¡Œæ–¹å¼ã€‚ å…¥é—¨å®žä¾‹å‡è®¾last -n 5çš„è¾“å‡ºå¦‚ä¸‹ 123456[root@www ~]# last -n 5 &lt;==ä»…å–å‡ºå‰äº”è¡Œroot pts/1 192.168.1.100 Tue Feb 10 11:21 still logged inroot pts/1 192.168.1.100 Tue Feb 10 00:46 - 02:28 (01:41)root pts/1 192.168.1.100 Mon Feb 9 11:41 - 18:30 (06:48)dmtsai pts/1 192.168.1.100 Mon Feb 9 11:41 - 11:41 (00:00)root tty1 Fri Sep 5 14:09 - 14:10 (00:01) å¦‚æžœåªæ˜¯æ˜¾ç¤ºæœ€è¿‘ç™»å½•çš„5ä¸ªå¸å· 123456#last -n 5 | awk &apos;&#123;print $1&#125;&apos;rootrootrootdmtsairoot awkå·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼šè¯»å…¥æœ‰â€™\nâ€™æ¢è¡Œç¬¦åˆ†å‰²çš„ä¸€æ¡è®°å½•ï¼Œç„¶åŽå°†è®°å½•æŒ‰æŒ‡å®šçš„åŸŸåˆ†éš”ç¬¦åˆ’åˆ†åŸŸï¼Œå¡«å……åŸŸï¼Œ$0åˆ™è¡¨ç¤ºæ‰€æœ‰åŸŸ,$1è¡¨ç¤ºç¬¬ä¸€ä¸ªåŸŸ,$nè¡¨ç¤ºç¬¬nä¸ªåŸŸã€‚é»˜è®¤åŸŸåˆ†éš”ç¬¦æ˜¯â€ç©ºç™½é”®â€ æˆ– â€œ[tab]é”®â€,æ‰€ä»¥$1è¡¨ç¤ºç™»å½•ç”¨æˆ·ï¼Œ$3è¡¨ç¤ºç™»å½•ç”¨æˆ·ip,ä»¥æ­¤ç±»æŽ¨ã€‚ å¦‚æžœåªæ˜¯æ˜¾ç¤º/etc/passwdçš„è´¦æˆ· 12345#cat /etc/passwd |awk -F &apos;:&apos; &apos;&#123;print $1&#125;&apos; rootdaemonbinsys è¿™ç§æ˜¯awk+actionçš„ç¤ºä¾‹ï¼Œæ¯è¡Œéƒ½ä¼šæ‰§è¡Œaction{print $1}ã€‚ -FæŒ‡å®šåŸŸåˆ†éš”ç¬¦ä¸ºâ€™:â€™ã€‚ å¦‚æžœåªæ˜¯æ˜¾ç¤º/etc/passwdçš„è´¦æˆ·å’Œè´¦æˆ·å¯¹åº”çš„shell,è€Œè´¦æˆ·ä¸Žshellä¹‹é—´ä»¥tabé”®åˆ†å‰² 12345#cat /etc/passwd |awk -F &apos;:&apos; &apos;&#123;print $1&quot;\t&quot;$7&#125;&apos;root /bin/bashdaemon /bin/shbin /bin/shsys /bin/sh å¦‚æžœåªæ˜¯æ˜¾ç¤º/etc/passwdçš„è´¦æˆ·å’Œè´¦æˆ·å¯¹åº”çš„shell,è€Œè´¦æˆ·ä¸Žshellä¹‹é—´ä»¥é€—å·åˆ†å‰²,è€Œä¸”åœ¨æ‰€æœ‰è¡Œæ·»åŠ åˆ—åname,shell,åœ¨æœ€åŽä¸€è¡Œæ·»åŠ â€blue,/bin/noshâ€ã€‚ 12345678cat /etc/passwd |awk -F &apos;:&apos; &apos;BEGIN &#123;print &quot;name,shell&quot;&#125; &#123;print $1&quot;,&quot;$7&#125; END &#123;print &quot;blue,/bin/nosh&quot;&#125;&apos;name,shellroot,/bin/bashdaemon,/bin/shbin,/bin/shsys,/bin/sh....blue,/bin/nosh awkå·¥ä½œæµç¨‹æ˜¯è¿™æ ·çš„ï¼šå…ˆæ‰§è¡ŒBEGINGï¼Œç„¶åŽè¯»å–æ–‡ä»¶ï¼Œè¯»å…¥æœ‰/næ¢è¡Œç¬¦åˆ†å‰²çš„ä¸€æ¡è®°å½•ï¼Œç„¶åŽå°†è®°å½•æŒ‰æŒ‡å®šçš„åŸŸåˆ†éš”ç¬¦åˆ’åˆ†åŸŸï¼Œå¡«å……åŸŸï¼Œ $0åˆ™è¡¨ç¤ºæ‰€æœ‰åŸŸ,$1è¡¨ç¤ºç¬¬ä¸€ä¸ªåŸŸ,$nè¡¨ç¤ºç¬¬nä¸ªåŸŸ ,éšåŽå¼€å§‹æ‰§è¡Œæ¨¡å¼æ‰€å¯¹åº”çš„åŠ¨ä½œactionã€‚æŽ¥ç€å¼€å§‹è¯»å…¥ç¬¬äºŒæ¡è®°å½•Â·Â·Â·Â·Â·Â·ç›´åˆ°æ‰€æœ‰çš„è®°å½•éƒ½è¯»å®Œï¼Œæœ€åŽæ‰§è¡ŒENDæ“ä½œã€‚ æœç´¢/etc/passwdæœ‰rootå…³é”®å­—çš„æ‰€æœ‰è¡Œ 12#awk -F: &apos;/root/&apos; /etc/passwdroot:x:0:0:root:/root:/bin/bash è¿™ç§æ˜¯patternçš„ä½¿ç”¨ç¤ºä¾‹ï¼ŒåŒ¹é…äº†pattern(è¿™é‡Œæ˜¯root)çš„è¡Œæ‰ä¼šæ‰§è¡Œaction(æ²¡æœ‰æŒ‡å®šactionï¼Œé»˜è®¤è¾“å‡ºæ¯è¡Œçš„å†…å®¹)ã€‚ æœç´¢æ”¯æŒæ­£åˆ™ï¼Œä¾‹å¦‚æ‰¾rootå¼€å¤´çš„: awk -F: â€˜/^root/â€˜ /etc/passwd æœç´¢/etc/passwdæœ‰rootå…³é”®å­—çš„æ‰€æœ‰è¡Œï¼Œå¹¶æ˜¾ç¤ºå¯¹åº”çš„shell 12# awk -F: &apos;/root/&#123;print $7&#125;&apos; /etc/passwd /bin/bash è¿™é‡ŒæŒ‡å®šäº†action{print $7} awkå†…ç½®å˜é‡awkæœ‰è®¸å¤šå†…ç½®å˜é‡ç”¨æ¥è®¾ç½®çŽ¯å¢ƒä¿¡æ¯ï¼Œè¿™äº›å˜é‡å¯ä»¥è¢«æ”¹å˜ï¼Œä¸‹é¢ç»™å‡ºäº†æœ€å¸¸ç”¨çš„ä¸€äº›å˜é‡ã€‚ 1234567891011ARGC å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°ARGV å‘½ä»¤è¡Œå‚æ•°æŽ’åˆ—ENVIRON æ”¯æŒé˜Ÿåˆ—ä¸­ç³»ç»ŸçŽ¯å¢ƒå˜é‡çš„ä½¿ç”¨FILENAME awkæµè§ˆçš„æ–‡ä»¶åFNR æµè§ˆæ–‡ä»¶çš„è®°å½•æ•°FS è®¾ç½®è¾“å…¥åŸŸåˆ†éš”ç¬¦ï¼Œç­‰ä»·äºŽå‘½ä»¤è¡Œ -Fé€‰é¡¹NF æµè§ˆè®°å½•çš„åŸŸçš„ä¸ªæ•°NR å·²è¯»çš„è®°å½•æ•°OFS è¾“å‡ºåŸŸåˆ†éš”ç¬¦ORS è¾“å‡ºè®°å½•åˆ†éš”ç¬¦RS æŽ§åˆ¶è®°å½•åˆ†éš”ç¬¦ æ­¤å¤–, $0å˜é‡æ˜¯æŒ‡æ•´æ¡è®°å½•ã€‚$1è¡¨ç¤ºå½“å‰è¡Œçš„ç¬¬ä¸€ä¸ªåŸŸ,$2è¡¨ç¤ºå½“å‰è¡Œçš„ç¬¬äºŒä¸ªåŸŸ,â€¦â€¦ä»¥æ­¤ç±»æŽ¨ã€‚ ç»Ÿè®¡/etc/passwd:æ–‡ä»¶åï¼Œæ¯è¡Œçš„è¡Œå·ï¼Œæ¯è¡Œçš„åˆ—æ•°ï¼Œå¯¹åº”çš„å®Œæ•´è¡Œå†…å®¹: 12345#awk -F &apos;:&apos; &apos;&#123;print &quot;filename:&quot; FILENAME &quot;,linenumber:&quot; NR &quot;,columns:&quot; NF &quot;,linecontent:&quot;$0&#125;&apos; /etc/passwdfilename:/etc/passwd,linenumber:1,columns:7,linecontent:root:x:0:0:root:/root:/bin/bashfilename:/etc/passwd,linenumber:2,columns:7,linecontent:daemon:x:1:1:daemon:/usr/sbin:/bin/shfilename:/etc/passwd,linenumber:3,columns:7,linecontent:bin:x:2:2:bin:/bin:/bin/shfilename:/etc/passwd,linenumber:4,columns:7,linecontent:sys:x:3:3:sys:/dev:/bin/sh ä½¿ç”¨printfæ›¿ä»£print,å¯ä»¥è®©ä»£ç æ›´åŠ ç®€æ´ï¼Œæ˜“è¯» 1awk -F &apos;:&apos; &apos;&#123;printf(&quot;filename:%10s,linenumber:%s,columns:%s,linecontent:%s\n&quot;,FILENAME,NR,NF,$0)&#125;&apos; /etc/passwd printå’Œprintfawkä¸­åŒæ—¶æä¾›äº†printå’Œprintfä¸¤ç§æ‰“å°è¾“å‡ºçš„å‡½æ•°ã€‚ å…¶ä¸­printå‡½æ•°çš„å‚æ•°å¯ä»¥æ˜¯å˜é‡ã€æ•°å€¼æˆ–è€…å­—ç¬¦ä¸²ã€‚å­—ç¬¦ä¸²å¿…é¡»ç”¨åŒå¼•å·å¼•ç”¨ï¼Œå‚æ•°ç”¨é€—å·åˆ†éš”ã€‚å¦‚æžœæ²¡æœ‰é€—å·ï¼Œå‚æ•°å°±ä¸²è”åœ¨ä¸€èµ·è€Œæ— æ³•åŒºåˆ†ã€‚è¿™é‡Œï¼Œé€—å·çš„ä½œç”¨ä¸Žè¾“å‡ºæ–‡ä»¶çš„åˆ†éš”ç¬¦çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯åŽè€…æ˜¯ç©ºæ ¼è€Œå·²ã€‚ printfå‡½æ•°ï¼Œå…¶ç”¨æ³•å’Œcè¯­è¨€ä¸­printfåŸºæœ¬ç›¸ä¼¼,å¯ä»¥æ ¼å¼åŒ–å­—ç¬¦ä¸²,è¾“å‡ºå¤æ‚æ—¶ï¼Œprintfæ›´åŠ å¥½ç”¨ï¼Œä»£ç æ›´æ˜“æ‡‚ã€‚ awkç¼–ç¨‹ å˜é‡å’Œèµ‹å€¼ é™¤äº†awkçš„å†…ç½®å˜é‡ï¼Œawkè¿˜å¯ä»¥è‡ªå®šä¹‰å˜é‡ã€‚ ä¸‹é¢ç»Ÿè®¡/etc/passwdçš„è´¦æˆ·äººæ•°1234awk &apos;&#123;count++;print $0;&#125; END&#123;print &quot;user count is &quot;, count&#125;&apos; /etc/passwdroot:x:0:0:root:/root:/bin/bash......user count is 40 countæ˜¯è‡ªå®šä¹‰å˜é‡ã€‚ä¹‹å‰çš„action{}é‡Œéƒ½æ˜¯åªæœ‰ä¸€ä¸ªprint,å…¶å®žprintåªæ˜¯ä¸€ä¸ªè¯­å¥ï¼Œè€Œaction{}å¯ä»¥æœ‰å¤šä¸ªè¯­å¥ï¼Œä»¥;å·éš”å¼€ã€‚ è¿™é‡Œæ²¡æœ‰åˆå§‹åŒ–countï¼Œè™½ç„¶é»˜è®¤æ˜¯0ï¼Œä½†æ˜¯å¦¥å½“çš„åšæ³•è¿˜æ˜¯åˆå§‹åŒ–ä¸º0: 12345awk &apos;BEGIN &#123;count=0;print &quot;[start]user count is &quot;, count&#125; &#123;count=count+1;print $0;&#125; END&#123;print &quot;[end]user count is &quot;, count&#125;&apos; /etc/passwd[start]user count is 0root:x:0:0:root:/root:/bin/bash...[end]user count is 40 ç»Ÿè®¡æŸä¸ªæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å ç”¨çš„å­—èŠ‚æ•°12ls -l |awk &apos;BEGIN &#123;size=0;&#125; &#123;size=size+$5;&#125; END&#123;print &quot;[end]size is &quot;, size&#125;&apos;[end]size is 8657198 å¦‚æžœä»¥Mä¸ºå•ä½æ˜¾ç¤º:12ls -l |awk &apos;BEGIN &#123;size=0;&#125; &#123;size=size+$5;&#125; END&#123;print &quot;[end]size is &quot;, size/1024/1024,&quot;M&quot;&#125;&apos; [end]size is 8.25889 M æ³¨æ„ï¼Œç»Ÿè®¡ä¸åŒ…æ‹¬æ–‡ä»¶å¤¹çš„å­ç›®å½•ã€‚ æ¡ä»¶è¯­å¥awkä¸­çš„æ¡ä»¶è¯­å¥æ˜¯ä»ŽCè¯­è¨€ä¸­å€Ÿé‰´æ¥çš„ï¼Œè§å¦‚ä¸‹å£°æ˜Žæ–¹å¼ï¼š 12345678910111213141516171819if (expression) &#123; statement; statement; ... ...&#125;if (expression) &#123; statement;&#125; else &#123; statement2;&#125;if (expression) &#123; statement1;&#125; else if (expression1) &#123; statement2;&#125; else &#123; statement3;&#125; ç»Ÿè®¡æŸä¸ªæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å ç”¨çš„å­—èŠ‚æ•°,è¿‡æ»¤4096å¤§å°çš„æ–‡ä»¶(ä¸€èˆ¬éƒ½æ˜¯æ–‡ä»¶å¤¹):12ls -l |awk &apos;BEGIN &#123;size=0;print &quot;[start]size is &quot;, size&#125; &#123;if($5!=4096)&#123;size=size+$5;&#125;&#125; END&#123;print &quot;[end]size is &quot;, size/1024/1024,&quot;M&quot;&#125;&apos; [end]size is 8.22339 M å¾ªçŽ¯è¯­å¥ awkä¸­çš„å¾ªçŽ¯è¯­å¥åŒæ ·å€Ÿé‰´äºŽCè¯­è¨€ï¼Œæ”¯æŒwhileã€do/whileã€forã€breakã€continueï¼Œè¿™äº›å…³é”®å­—çš„è¯­ä¹‰å’ŒCè¯­è¨€ä¸­çš„è¯­ä¹‰å®Œå…¨ç›¸åŒã€‚ æ•°ç»„ å› ä¸ºawkä¸­æ•°ç»„çš„ä¸‹æ ‡å¯ä»¥æ˜¯æ•°å­—å’Œå­—æ¯ï¼Œæ•°ç»„çš„ä¸‹æ ‡é€šå¸¸è¢«ç§°ä¸ºå…³é”®å­—(key)ã€‚å€¼å’Œå…³é”®å­—éƒ½å­˜å‚¨åœ¨å†…éƒ¨çš„ä¸€å¼ é’ˆå¯¹key/valueåº”ç”¨hashçš„è¡¨æ ¼é‡Œã€‚ç”±äºŽhashä¸æ˜¯é¡ºåºå­˜å‚¨ï¼Œå› æ­¤åœ¨æ˜¾ç¤ºæ•°ç»„å†…å®¹æ—¶ä¼šå‘çŽ°ï¼Œå®ƒä»¬å¹¶ä¸æ˜¯æŒ‰ç…§ä½ é¢„æ–™çš„é¡ºåºæ˜¾ç¤ºå‡ºæ¥çš„ã€‚æ•°ç»„å’Œå˜é‡ä¸€æ ·ï¼Œéƒ½æ˜¯åœ¨ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»ºçš„ï¼Œawkä¹ŸåŒæ ·ä¼šè‡ªåŠ¨åˆ¤æ–­å…¶å­˜å‚¨çš„æ˜¯æ•°å­—è¿˜æ˜¯å­—ç¬¦ä¸²ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œawkä¸­çš„æ•°ç»„ç”¨æ¥ä»Žè®°å½•ä¸­æ”¶é›†ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºŽè®¡ç®—æ€»å’Œã€ç»Ÿè®¡å•è¯ä»¥åŠè·Ÿè¸ªæ¨¡æ¿è¢«åŒ¹é…çš„æ¬¡æ•°ç­‰ç­‰ã€‚ æ˜¾ç¤º/etc/passwdçš„è´¦æˆ· 12345678awk -F &apos;:&apos; &apos;BEGIN &#123;count=0;&#125; &#123;name[count] = $1;count++;&#125;; END&#123;for (i = 0; i &lt; NR; i++) print i, name[i]&#125;&apos; /etc/passwdrootdaemonbinsyssyncgames......]]></content>
      <categories>
        <category>linuxå‘½ä»¤</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>awk</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[linux sedå‘½ä»¤è¯¦è§£]]></title>
    <url>%2F2014%2F01%2F05%2Flinux-sed%2F</url>
    <content type="text"><![CDATA[åŠŸèƒ½è¯´æ˜Žï¼š åˆ©ç”¨scriptæ¥å¤„ç†æ–‡æœ¬æ–‡ä»¶ã€‚ è¯­ æ³•ï¼š sed [-hnV][-e script][-f scriptæ–‡ä»¶][æ–‡æœ¬æ–‡ä»¶] è¡¥å……è¯´æ˜Žï¼š sedå¯ä¾ç…§scriptçš„æŒ‡ä»¤ï¼Œæ¥å¤„ç†ã€ç¼–è¾‘æ–‡æœ¬æ–‡ä»¶ã€‚ å‚ æ•°ï¼š-e scriptæˆ–â€”expression=script ä»¥é€‰é¡¹ä¸­æŒ‡å®šçš„scriptæ¥å¤„ç†è¾“å…¥çš„æ–‡æœ¬æ–‡ä»¶ã€‚-f scriptæ–‡ä»¶æˆ–â€”file=scriptæ–‡ä»¶ ä»¥é€‰é¡¹ä¸­æŒ‡å®šçš„scriptæ–‡ä»¶æ¥å¤„ç†è¾“å…¥çš„æ–‡æœ¬æ–‡ä»¶ã€‚-hæˆ–â€”help æ˜¾ç¤ºå¸®åŠ©ã€‚-næˆ–â€”quietæˆ–â€“silent ä»…æ˜¾ç¤ºscriptå¤„ç†åŽçš„ç»“æžœã€‚-Væˆ–â€”version æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ã€‚ ä¾‹ å­ï¼š1$ sed -e 's/123/1234/' a.txt å°†a.txtæ–‡ä»¶ä¸­æ‰€æœ‰è¡Œä¸­çš„123ç”¨1234æ›¿æ¢ï¼ˆ-eè¡¨ç¤ºå‘½ä»¤ä»¥å‘½ä»¤è¡Œçš„æ–¹å¼æ‰§è¡Œï¼›å‚æ•°sï¼Œè¡¨ç¤ºæ‰§è¡Œæ›¿æ¢æ“ä½œï¼‰ 1$ sed -e '3,5 a4' a.txt å°†a.txtæ–‡ä»¶ä¸­çš„3è¡Œåˆ°5è¡Œä¹‹é—´æ‰€æœ‰è¡Œçš„åŽé¢æ·»åŠ ä¸€è¡Œå†…å®¹ä¸º4çš„è¡Œï¼ˆå‚æ•°aï¼Œè¡¨ç¤ºæ·»åŠ è¡Œï¼Œå‚æ•°aåŽé¢æŒ‡å®šæ·»åŠ çš„å†…å®¹ï¼‰ 1$ sed -e '1 s/12/45/' a.txt æŠŠç¬¬ä¸€è¡Œçš„12æ›¿æ¢æˆ45 1$ sed -i "s/oldstring/newstring/g" `grep oldstring -rl yourdir` æ‰¹é‡å¤„ç†é€šè¿‡grepæœç´¢å‡ºæ¥çš„æ‰€æœ‰æ–‡æ¡£ï¼Œå°†è¿™äº›æ–‡æ¡£ä¸­æ‰€æœ‰çš„oldstringç”¨newstringæ›¿æ¢ï¼ˆ-iå‚æ•°è¡¨ç¤ºç›´æŽ¥å¯¹ç›®æ ‡æ–‡ä»¶æ“ä½œï¼‰ 1$ sed -n 's/^test/mytest/p' example.file (-n)é€‰é¡¹å’Œpæ ‡å¿—ä¸€èµ·ä½¿ç”¨è¡¨ç¤ºåªæ‰“å°é‚£äº›å‘ç”Ÿæ›¿æ¢çš„è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æžœæŸä¸€è¡Œå¼€å¤´çš„testè¢«æ›¿æ¢æˆmytestï¼Œå°±æ‰“å°å®ƒã€‚(^è¿™æ˜¯æ­£åˆ™è¡¨è¾¾å¼ä¸­è¡¨ç¤ºå¼€å¤´ï¼Œè¯¥ç¬¦å·åŽé¢è·Ÿçš„å°±æ˜¯å¼€å¤´çš„å­—ç¬¦ä¸²)ï¼ˆå‚æ•°pè¡¨ç¤ºæ‰“å°è¡Œï¼‰ 1$ sed 's/^wangpan/&amp;19850715/' example.file è¡¨ç¤ºè¢«æ›¿æ¢æ¢å­—ç¬¦ä¸²è¢«æ‰¾åˆ°åŽï¼Œè¢«æ›¿æ¢çš„å­—ç¬¦ä¸²é€šè¿‡ï¼†ç¬¦å·è¿žæŽ¥ç»™å‡ºçš„å­—ç¬¦ä¸²ç»„æˆæ–°å­—ç¬¦ä¼ æ›¿æ¢è¢«æ›¿æ¢çš„å­—ç¬¦ä¸²,æ‰€æœ‰ä»¥wangpanå¼€å¤´çš„è¡Œéƒ½ä¼šè¢«æ›¿æ¢æˆå®ƒè‡ªå·²åŠ 19850715ï¼Œå˜æˆwangpan19850715 1$ sed -n 's/\(love\)able/\1rs/p' example.file loveè¢«æ ‡è®°ä¸º1ï¼Œæ‰€æœ‰loveableä¼šè¢«æ›¿æ¢æˆloversï¼Œè€Œä¸”æ›¿æ¢çš„è¡Œä¼šè¢«æ‰“å°å‡ºæ¥ã€‚éœ€è¦å°†è¿™æ¡å‘½ä»¤åˆ†è§£ï¼Œs/æ˜¯è¡¨ç¤ºæ›¿æ¢æ“ä½œï¼Œ(love)è¡¨ç¤ºé€‰ä¸­loveå­—ç¬¦ä¸²ï¼Œ(love)able/è¡¨ç¤ºåŒ…å«loveableçš„è¡Œï¼Œ(love)able/\lè¡¨ç¤ºloveå­—ç¬¦ä¸²æ ‡è®°ä¸º1ï¼Œè¡¨ç¤ºåœ¨æ›¿æ¢è¿‡ç¨‹ä¸­ä¸å˜ã€‚rs/è¡¨ç¤ºæ›¿æ¢çš„ç›®æ ‡å­—ç¬¦ä¸²ã€‚è¿™æ¡å‘½ä»¤çš„æ“ä½œå«ä¹‰ï¼šåªæ‰“å°æ›¿æ¢äº†çš„è¡Œ 1$ sed 's#10#100#g' example.file ä¸è®ºä»€ä¹ˆå­—ç¬¦ï¼Œç´§è·Ÿç€så‘½ä»¤çš„éƒ½è¢«è®¤ä¸ºæ˜¯æ–°çš„åˆ†éš”ç¬¦ï¼Œæ‰€ä»¥ï¼Œâ€œ#â€åœ¨è¿™é‡Œæ˜¯åˆ†éš”ç¬¦ï¼Œä»£æ›¿äº†é»˜è®¤çš„â€œ/â€åˆ†éš”ç¬¦ã€‚è¡¨ç¤ºæŠŠæ‰€æœ‰10æ›¿æ¢æˆ100ã€‚ 1$ sed -n '/love/,/unlove/p' example.file åªæ‰“å°åŒ…å«loveå­—ç¬¦ä¸²è¡Œåˆ°åŒ…å«unloveå­—ç¬¦ä¸²è¡Œä¹‹é—´çš„æ‰€æœ‰è¡Œï¼ˆç¡®å®šè¡Œçš„èŒƒå›´å°±æ˜¯é€šè¿‡é€—å·å®žçŽ°çš„ï¼‰ 1$ sed -n '5,/^wang/p' example åªæ‰“å°ä»Žç¬¬äº”è¡Œå¼€å§‹åˆ°ç¬¬ä¸€ä¸ªåŒ…å«ä»¥wangå¼€å§‹çš„è¡Œä¹‹é—´çš„æ‰€æœ‰è¡Œ 1$ sed '/love/,/unlove/s/$/wangpan/' example.file å¯¹äºŽåŒ…å«loveå­—ç¬¦ä¸²çš„è¡Œåˆ°åŒ…å«unloveå­—ç¬¦ä¸²ä¹‹é—´çš„è¡Œï¼Œæ¯è¡Œçš„æœ«å°¾ç”¨å­—ç¬¦ä¸²wangpanæ›¿æ¢ã€‚å­—ç¬¦ä¸²$/è¡¨ç¤ºä»¥å­—ç¬¦ä¸²ç»“å°¾çš„è¡Œï¼Œ$/è¡¨ç¤ºæ¯ä¸€è¡Œçš„ç»“å°¾ï¼Œs/$/wangpan/è¡¨ç¤ºæ¯ä¸€è¡Œçš„ç»“å°¾æ·»åŠ wangpanå­—ç¬¦ä¸² 1$ sed -e '11,53d' -e 's/wang/pan/' example.file (-e)é€‰é¡¹å…è®¸åœ¨åŒä¸€è¡Œé‡Œæ‰§è¡Œå¤šæ¡å‘½ä»¤ã€‚å¦‚ä¾‹å­æ‰€ç¤ºï¼Œç¬¬ä¸€æ¡å‘½ä»¤åˆ é™¤11è‡³53è¡Œï¼Œç¬¬äºŒæ¡å‘½ä»¤ç”¨panæ›¿æ¢wangã€‚å‘½ä»¤çš„æ‰§è¡Œé¡ºåºå¯¹ç»“æžœæœ‰å½±å“ã€‚å¦‚æžœä¸¤ä¸ªå‘½ä»¤éƒ½æ˜¯æ›¿æ¢å‘½ä»¤ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ›¿æ¢å‘½ä»¤å°†å½±å“ç¬¬äºŒä¸ªæ›¿æ¢å‘½ä»¤çš„ç»“æžœã€‚(å‚æ•°dï¼Œè¡¨ç¤ºåˆ é™¤æŒ‡å®šçš„è¡Œ) 1$ sed --expression='s/wang/pan/' --expression='/love/d' example.file ä¸€ä¸ªæ¯”-eæ›´å¥½çš„å‘½ä»¤æ˜¯â€“expressionã€‚å®ƒèƒ½ç»™sedè¡¨è¾¾å¼èµ‹å€¼ã€‚ 1$ sed '/wangpan/r file' example.file fileé‡Œçš„å†…å®¹è¢«è¯»è¿›æ¥ï¼Œæ˜¾ç¤ºåœ¨ä¸ŽwangpanåŒ¹é…çš„è¡ŒåŽé¢ï¼Œå¦‚æžœåŒ¹é…å¤šè¡Œï¼Œåˆ™fileçš„å†…å®¹å°†æ˜¾ç¤ºåœ¨æ‰€æœ‰åŒ¹é…è¡Œçš„ä¸‹é¢ã€‚å‚æ•°rï¼Œè¡¨ç¤ºè¯»å‡ºæ–‡ä»¶ï¼ŒåŽé¢ç©ºæ ¼ç´§è·Ÿæ–‡ä»¶åç§° 1$ sed -n '/test/w file' example.file åœ¨example.fileä¸­æ‰€æœ‰åŒ…å«testçš„è¡Œéƒ½è¢«å†™å…¥fileé‡Œã€‚å‚æ•°wï¼Œè¡¨ç¤ºå°†åŒ¹é…çš„è¡Œå†™å…¥åˆ°æŒ‡å®šçš„æ–‡ä»¶fileä¸­ 1$ sed '/^test/a\oh! My god!' example.file â€˜oh! My god!â€™è¢«è¿½åŠ åˆ°ä»¥testå¼€å¤´çš„è¡Œçš„åŽé¢ï¼Œsedè¦æ±‚å‚æ•°aåŽé¢æœ‰ä¸€ä¸ªåæ–œæ ã€‚ 1$ sed '/test/i\oh! My god!' example.file â€˜oh! My god!â€™è¢«è¿½åŠ åˆ°åŒ…å«testå­—ç¬¦ä¸²è¡Œçš„å‰é¢ï¼Œå‚æ•°iè¡¨ç¤ºæ·»åŠ æŒ‡å®šå†…å®¹åˆ°åŒ¹é…è¡Œçš„å‰é¢ï¼Œsedè¦æ±‚å‚æ•°iåŽé¢æœ‰ä¸€ä¸ªåæ–œæ  1$ sed '/test/&#123; n; s/aa/bb/; &#125;' example.file å¦‚æžœtestè¢«åŒ¹é…ï¼Œåˆ™ç§»åŠ¨åˆ°åŒ¹é…è¡Œçš„ä¸‹ä¸€è¡Œï¼Œæ›¿æ¢è¿™ä¸€è¡Œçš„aaï¼Œå˜ä¸ºbbã€‚å‚æ•°nï¼Œè¡¨ç¤ºè¯»å–åŒ¹é…è¡Œçš„ä¸‹ä¸€ä¸ªè¾“å…¥è¡Œï¼Œç”¨ä¸‹ä¸€ä¸ªå‘½ä»¤å¤„ç†æ–°çš„è¡Œè€Œä¸æ˜¯åŒ¹é…è¡Œã€‚Sedè¦æ±‚å‚æ•°nåŽè·Ÿåˆ†å· 1$ sed '1,10y/abcde/ABCDE/' example.file æŠŠ1â€”10è¡Œå†…æ‰€æœ‰abcdeè½¬å˜ä¸ºå¤§å†™ï¼Œæ³¨æ„ï¼Œæ­£åˆ™è¡¨è¾¾å¼å…ƒå­—ç¬¦ä¸èƒ½ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ã€‚å‚æ•°yï¼Œè¡¨ç¤ºæŠŠä¸€ä¸ªå­—ç¬¦ç¿»è¯‘ä¸ºå¦å¤–çš„å­—ç¬¦ï¼ˆä½†æ˜¯ä¸ç”¨äºŽæ­£åˆ™è¡¨è¾¾å¼ï¼‰ 1$ sed -i 's/now/right now/g' test_sed_command.txt è¡¨ç¤ºç›´æŽ¥æ“ä½œæ–‡ä»¶test_sed_command.txtï¼Œå°†æ–‡ä»¶test_sed_command.txtä¸­æ‰€æœ‰çš„nowç”¨right nowæ›¿æ¢ã€‚å‚æ•°-iï¼Œè¡¨ç¤ºç›´æŽ¥æ“ä½œä¿®æ”¹æ–‡ä»¶ï¼Œä¸è¾“å‡ºã€‚ 1$ sed '2q' test_sed_command.txt åœ¨æ‰“å°å®Œç¬¬2è¡ŒåŽï¼Œå°±ç›´æŽ¥é€€å‡ºsedã€‚å‚æ•°qï¼Œè¡¨ç¤ºé€€å‡º 1$ sed -e '/old/h' -e '/girl-friend/G' test_sed_command.txt é¦–å…ˆäº†è§£å‚æ•°hï¼Œæ‹·è´åŒ¹é…æˆåŠŸè¡Œçš„å†…å®¹åˆ°å†…å­˜ä¸­çš„ç¼“å†²åŒºã€‚åœ¨äº†è§£å‚æ•°Gï¼ŒèŽ·å¾—å†…å­˜ç¼“å†²åŒºçš„å†…å®¹ï¼Œå¹¶è¿½åŠ åˆ°å½“å‰æ¨¡æ¿å—æ–‡æœ¬çš„åŽé¢ã€‚ä¸Šé¢å‘½ä»¤è¡Œçš„å«ä¹‰ï¼šå°†åŒ…å«oldå­—ç¬¦ä¸²çš„è¡Œçš„å†…å®¹ä¿å­˜åœ¨ç¼“å†²åŒºä¸­ï¼Œç„¶åŽå°†ç¼“å†²åŒºçš„å†…å®¹æ‹¿å‡ºæ¥æ·»åŠ åˆ°åŒ…å«girl-friendå­—ç¬¦ä¸²è¡Œçš„åŽé¢ã€‚éšå«è¦æ±‚æœé›†åˆ°ç¼“å†²åŒºçš„åŒ¹é…è¡Œåœ¨éœ€è¦æ·»åŠ è¡Œçš„å‰é¢ã€‚ 1$ sed -e '/test/h' -e '/wangpan/x' example.file å°†åŒ…å«testå­—ç¬¦ä¸²çš„è¡Œçš„å†…å®¹ä¿å­˜åœ¨ç¼“å†²åŒºä¸­ï¼Œç„¶åŽå†å°†ç¼“å†²åŒºçš„å†…å®¹æ›¿æ¢åŒ…å«wangpanå­—ç¬¦ä¸²çš„è¡Œã€‚å‚æ•°xï¼Œè¡¨ç¤ºè¡Œæ›¿æ¢æ“ä½œã€‚éšå«è¦æ±‚æœé›†åˆ°ç¼“å†²åŒºçš„åŒ¹é…è¡Œåœ¨éœ€è¦è¢«æ›¿æ¢è¡Œçš„å‰é¢ã€‚]]></content>
      <categories>
        <category>linuxå‘½ä»¤</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>sed</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[linux grepå‘½ä»¤è¯¦è§£]]></title>
    <url>%2F2014%2F01%2F04%2Flinux-grep%2F</url>
    <content type="text"><![CDATA[ç®€ä»‹grep (global search regular expression(RE) and print out the line,å…¨é¢æœç´¢æ­£åˆ™è¡¨è¾¾å¼å¹¶æŠŠè¡Œæ‰“å°å‡ºæ¥)æ˜¯ä¸€ç§å¼ºå¤§çš„æ–‡æœ¬æœç´¢å·¥å…·ï¼Œå®ƒèƒ½ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æœç´¢æ–‡æœ¬ï¼Œå¹¶æŠŠåŒ¹é…çš„è¡Œæ‰“å°å‡ºæ¥ã€‚ Unixçš„grepå®¶æ—åŒ…æ‹¬grepã€egrepå’Œfgrepã€‚egrepå’Œfgrepçš„å‘½ä»¤åªè·Ÿgrepæœ‰å¾ˆå°ä¸åŒã€‚egrepæ˜¯grepçš„æ‰©å±•ï¼Œæ”¯æŒæ›´å¤šçš„reå…ƒå­—ç¬¦ï¼Œ fgrepå°±æ˜¯fixed grepæˆ–fast grepï¼Œå®ƒä»¬æŠŠæ‰€æœ‰çš„å­—æ¯éƒ½çœ‹ä½œå•è¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ­£åˆ™è¡¨è¾¾å¼ä¸­çš„å…ƒå­—ç¬¦è¡¨ç¤ºå›žå…¶è‡ªèº«çš„å­—é¢æ„ä¹‰ï¼Œä¸å†ç‰¹æ®Šã€‚linuxä½¿ç”¨GNUç‰ˆæœ¬çš„grepã€‚å®ƒåŠŸèƒ½æ›´å¼ºï¼Œå¯ä»¥é€šè¿‡-Gã€-Eã€-Få‘½ä»¤è¡Œé€‰é¡¹æ¥ä½¿ç”¨egrepå’Œfgrepçš„åŠŸèƒ½ã€‚ grepå¸¸ç”¨ç”¨æ³•grep [-acinv] [â€“color=auto] â€˜æœå¯»å­—ç¬¦ä¸²â€™ filenameé€‰é¡¹ä¸Žå‚æ•°ï¼š-a ï¼šå°† binary æ–‡ä»¶ä»¥ text æ–‡ä»¶çš„æ–¹å¼æœå¯»æ•°æ®-c ï¼šè®¡ç®—æ‰¾åˆ° â€˜æœå¯»å­—ç¬¦ä¸²â€™ çš„æ¬¡æ•°-i ï¼šå¿½ç•¥å¤§å°å†™çš„ä¸åŒï¼Œæ‰€ä»¥å¤§å°å†™è§†ä¸ºç›¸åŒ-n ï¼šé¡ºä¾¿è¾“å‡ºè¡Œå·-v ï¼šåå‘é€‰æ‹©ï¼Œäº¦å³æ˜¾ç¤ºå‡ºæ²¡æœ‰ â€˜æœå¯»å­—ç¬¦ä¸²â€™ å†…å®¹çš„é‚£ä¸€è¡Œï¼â€“color=auto ï¼šå¯ä»¥å°†æ‰¾åˆ°çš„å…³é”®è¯éƒ¨åˆ†åŠ ä¸Šé¢œè‰²çš„æ˜¾ç¤ºå–”ï¼ å°†/etc/passwdï¼Œæœ‰å‡ºçŽ° root çš„è¡Œå–å‡ºæ¥1234567grep root /etc/passwdroot:x:0:0:root:/root:/bin/bashoperator:x:11:0:operator:/root:/sbin/nologinæˆ–cat /etc/passwd | grep root root:x:0:0:root:/root:/bin/bashoperator:x:11:0:operator:/root:/sbin/nologin å°†/etc/passwdï¼Œæœ‰å‡ºçŽ° root çš„è¡Œå–å‡ºæ¥,åŒæ—¶æ˜¾ç¤ºè¿™äº›è¡Œåœ¨/etc/passwdçš„è¡Œå·123grep -n root /etc/passwd1:root:x:0:0:root:/root:/bin/bash30:operator:x:11:0:operator:/root:/sbin/nologin åœ¨å…³é”®å­—çš„æ˜¾ç¤ºæ–¹é¢ï¼Œgrep å¯ä»¥ä½¿ç”¨ â€“color=auto æ¥å°†å…³é”®å­—éƒ¨åˆ†ä½¿ç”¨é¢œè‰²æ˜¾ç¤ºã€‚ è¿™å¯æ˜¯ä¸ªå¾ˆä¸é”™çš„åŠŸèƒ½å•Šï¼ä½†æ˜¯å¦‚æžœæ¯æ¬¡ä½¿ç”¨ grep éƒ½å¾—è¦è‡ªè¡ŒåŠ ä¸Š â€“color=auto åˆæ˜¾çš„å¾ˆéº»çƒ¦ï½ž æ­¤æ—¶é‚£ä¸ªå¥½ç”¨çš„ alias å°±å¾—æ¥å¤„ç†ä¸€ä¸‹å•¦ï¼ä½ å¯ä»¥åœ¨ ~/.bashrc å†…åŠ ä¸Šè¿™è¡Œï¼šalias grep=&#39;grep --color=auto&#39;å†ä»¥source ~/.bashrcæ¥ç«‹å³ç”Ÿæ•ˆå³å¯å–”ï¼ è¿™æ ·æ¯æ¬¡è¿è¡Œ grep ä»–éƒ½ä¼šè‡ªåŠ¨å¸®ä½ åŠ ä¸Šé¢œè‰²æ˜¾ç¤ºå•¦ å°†/etc/passwdï¼Œå°†æ²¡æœ‰å‡ºçŽ° root çš„è¡Œå–å‡ºæ¥123grep -v root /etc/passwdroot:x:0:0:root:/root:/bin/bashoperator:x:11:0:operator:/root:/sbin/nologin å°†/etc/passwdï¼Œå°†æ²¡æœ‰å‡ºçŽ° root å’Œnologinçš„è¡Œå–å‡ºæ¥123grep -v root /etc/passwd | grep -v nologinroot:x:0:0:root:/root:/bin/bashoperator:x:11:0:operator:/root:/sbin/nologin ç”¨ dmesg åˆ—å‡ºæ ¸å¿ƒä¿¡æ¯ï¼Œå†ä»¥ grep æ‰¾å‡ºå†…å« eth é‚£è¡Œ,è¦å°†æ‰åˆ°çš„å…³é”®å­—æ˜¾è‰²ï¼Œä¸”åŠ ä¸Šè¡Œå·æ¥è¡¨ç¤ºï¼š12345[root@www ~]# dmesg | grep -n --color=auto 'eth'247:eth0: RealTek RTL8139 at 0xee846000, 00:90:cc:a6:34:84, IRQ 10248:eth0: Identified 8139 chip type 'RTL-8139C'294:eth0: link up, 100Mbps, full-duplex, lpa 0xC5E1305:eth0: no IPv6 routers present ä½ ä¼šå‘çŽ°é™¤äº† eth ä¼šæœ‰ç‰¹æ®Šé¢œè‰²æ¥è¡¨ç¤ºä¹‹å¤–ï¼Œæœ€å‰é¢è¿˜æœ‰è¡Œå·å–”ï¼åœ¨å…³é”®å­—çš„æ˜¾ç¤ºæ–¹é¢ï¼Œgrep å¯ä»¥ä½¿ç”¨ â€“color=auto æ¥å°†å…³é”®å­—éƒ¨åˆ†ä½¿ç”¨é¢œè‰²æ˜¾ç¤ºã€‚ è¿™å¯æ˜¯ä¸ªå¾ˆä¸é”™çš„åŠŸèƒ½å•Šï¼ä½†æ˜¯å¦‚æžœæ¯æ¬¡ä½¿ç”¨ grep éƒ½å¾—è¦è‡ªè¡ŒåŠ ä¸Š â€“color=auto åˆæ˜¾çš„å¾ˆéº»çƒ¦ï½ž æ­¤æ—¶é‚£ä¸ªå¥½ç”¨çš„ alias å°±å¾—æ¥å¤„ç†ä¸€ä¸‹å•¦ï¼ä½ å¯ä»¥åœ¨ ~/.bashrc å†…åŠ ä¸Šè¿™è¡Œï¼šalias grep=&#39;grep --color=auto&#39;å†ä»¥source ~/.bashrcæ¥ç«‹å³ç”Ÿæ•ˆå³å¯å–”ï¼ è¿™æ ·æ¯æ¬¡è¿è¡Œ grep ä»–éƒ½ä¼šè‡ªåŠ¨å¸®ä½ åŠ ä¸Šé¢œè‰²æ˜¾ç¤ºå•¦ ç”¨ dmesg åˆ—å‡ºæ ¸å¿ƒä¿¡æ¯ï¼Œå†ä»¥ grep æ‰¾å‡ºå†…å« eth é‚£è¡Œ,åœ¨å…³é”®å­—æ‰€åœ¨è¡Œçš„å‰ä¸¤è¡Œä¸ŽåŽä¸‰è¡Œä¹Ÿä¸€èµ·æ‰å‡ºæ¥æ˜¾ç¤º12345678[root@www ~]# dmesg | grep -n -A3 -B2 --color=auto 'eth'245-PCI: setting IRQ 10 as level-triggered246-ACPI: PCI Interrupt 0000:00:0e.0[A] -&gt; Link [LNKB] ...247:eth0: RealTek RTL8139 at 0xee846000, 00:90:cc:a6:34:84, IRQ 10248:eth0: Identified 8139 chip type 'RTL-8139C'249-input: PC Speaker as /class/input/input2250-ACPI: PCI Interrupt 0000:00:01.4[B] -&gt; Link [LNKB] ...251-hdb: ATAPI 48X DVD-ROM DVD-R-RAM CD-R/RW drive, 2048kB Cache, UDMA(66) å¦‚ä¸Šæ‰€ç¤ºï¼Œä½ ä¼šå‘çŽ°å…³é”®å­— 247 æ‰€åœ¨çš„å‰ä¸¤è¡ŒåŠ 248 åŽä¸‰è¡Œä¹Ÿéƒ½è¢«æ˜¾ç¤ºå‡ºæ¥ï¼è¿™æ ·å¯ä»¥è®©ä½ å°†å…³é”®å­—å‰åŽæ•°æ®æ‰å‡ºæ¥è¿›è¡Œåˆ†æžå•¦ï¼ æ ¹æ®æ–‡ä»¶å†…å®¹é€’å½’æŸ¥æ‰¾ç›®å½•123grep â€˜energywiseâ€™ * #åœ¨å½“å‰ç›®å½•æœç´¢å¸¦'energywise'è¡Œçš„æ–‡ä»¶grep -r â€˜energywiseâ€™ * #åœ¨å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æœç´¢'energywise'è¡Œçš„æ–‡ä»¶grep -l -r â€˜energywiseâ€™ * #åœ¨å½“å‰ç›®å½•åŠå…¶å­ç›®å½•ä¸‹æœç´¢'energywise'è¡Œçš„æ–‡ä»¶ï¼Œä½†æ˜¯ä¸æ˜¾ç¤ºåŒ¹é…çš„è¡Œï¼Œåªæ˜¾ç¤ºåŒ¹é…çš„æ–‡ä»¶ grepä¸Žæ­£è§„è¡¨è¾¾å¼å­—ç¬¦ç±» å­—ç¬¦ç±»çš„æœç´¢ï¼šå¦‚æžœæˆ‘æƒ³è¦æœå¯» test æˆ– taste è¿™ä¸¤ä¸ªå•å­—æ—¶ï¼Œå¯ä»¥å‘çŽ°åˆ°ï¼Œå…¶å®žå¥¹ä»¬æœ‰å…±é€šçš„ â€˜t?stâ€™ å­˜åœ¨ï½žè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘å¯ä»¥è¿™æ ·æ¥æœå¯»ï¼š123[root@www ~]# grep -n 't[ae]st' regular_express.txt8:I can't finish the test.9:Oh! The soup taste good. å…¶å®ž [] é‡Œé¢ä¸è®ºæœ‰å‡ ä¸ªå­—èŠ‚ï¼Œä»–éƒ½è°¨ä»£è¡¨æŸä¸€ä¸ªå­—èŠ‚ï¼Œ æ‰€ä»¥ï¼Œä¸Šé¢çš„ä¾‹å­è¯´æ˜Žäº†ï¼Œæˆ‘éœ€è¦çš„å­—ä¸²æ˜¯tastæˆ–testä¸¤ä¸ªå­—ä¸²è€Œå·²ï¼ å­—ç¬¦ç±»çš„åå‘é€‰æ‹© [^] ï¼šå¦‚æžœæƒ³è¦æœç´¢åˆ°æœ‰ oo çš„è¡Œï¼Œä½†ä¸æƒ³è¦ oo å‰é¢æœ‰ gï¼Œå¦‚ä¸‹12345[root@www ~]# grep -n '[^g]oo' regular_express.txt2:apple is my favorite food.3:Football game is not use feet only.18:google is the best tools for search keyword.19:goooooogle yes! ç¬¬ 2,3 è¡Œæ²¡æœ‰ç–‘é—®ï¼Œå› ä¸º foo ä¸Ž Foo å‡å¯è¢«æŽ¥å—ï¼ ä½†æ˜¯ç¬¬ 18 è¡Œæ˜Žæ˜Žæœ‰ google çš„ goo å•Šï½žåˆ«å¿˜è®°äº†ï¼Œå› ä¸ºè¯¥è¡ŒåŽé¢å‡ºçŽ°äº† tool çš„ too å•Šï¼æ‰€ä»¥è¯¥è¡Œä¹Ÿè¢«åˆ—å‡ºæ¥ï½ž ä¹Ÿå°±æ˜¯è¯´ï¼Œ 18 è¡Œé‡Œé¢è™½ç„¶å‡ºçŽ°äº†æˆ‘ä»¬æ‰€ä¸è¦çš„é¡¹ç›® (goo) ä½†æ˜¯ç”±æ–¼æœ‰éœ€è¦çš„é¡¹ç›® (too) ï¼Œ å› æ­¤ï¼Œæ˜¯ç¬¦åˆå­—ä¸²æœå¯»çš„å–”ï¼ è‡³æ–¼ç¬¬ 19 è¡Œï¼ŒåŒæ ·çš„ï¼Œå› ä¸º goooooogle é‡Œé¢çš„ oo å‰é¢å¯èƒ½æ˜¯ o ï¼Œä¾‹å¦‚ï¼š go(ooo)oogle ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸€è¡Œä¹Ÿæ˜¯ç¬¦åˆéœ€æ±‚çš„ï¼ å­—ç¬¦ç±»çš„è¿žç»­ï¼šå†æ¥ï¼Œå‡è®¾æˆ‘ oo å‰é¢ä¸æƒ³è¦æœ‰å°å†™å­—èŠ‚ï¼Œæ‰€ä»¥ï¼Œæˆ‘å¯ä»¥è¿™æ ·å†™ [^abcdâ€¦.z]oo ï¼Œ ä½†æ˜¯è¿™æ ·ä¼¼ä¹Žä¸æ€Žä¹ˆæ–¹ä¾¿ï¼Œç”±æ–¼å°å†™å­—èŠ‚çš„ ASCII ä¸Šç¼–ç çš„é¡ºåºæ˜¯è¿žç»­çš„ï¼Œ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¹‹ç®€åŒ–ä¸ºåº•ä¸‹è¿™æ ·ï¼š12[root@www ~]# grep -n '[^a-z]oo' regular_express.txt3:Football game is not use feet only. ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬åœ¨ä¸€ç»„é›†åˆå­—èŠ‚ä¸­ï¼Œå¦‚æžœè¯¥å­—èŠ‚ç»„æ˜¯è¿žç»­çš„ï¼Œä¾‹å¦‚å¤§å†™è‹±æ–‡/å°å†™è‹±æ–‡/æ•°å­—ç­‰ç­‰ï¼Œ å°±å¯ä»¥ä½¿ç”¨[a-z],[A-Z],[0-9]ç­‰æ–¹å¼æ¥ä¹¦å†™ï¼Œé‚£ä¹ˆå¦‚æžœæˆ‘ä»¬çš„è¦æ±‚å­—ä¸²æ˜¯æ•°å­—ä¸Žè‹±æ–‡å‘¢ï¼Ÿ å‘µå‘µï¼å°±å°†ä»–å…¨éƒ¨å†™åœ¨ä¸€èµ·ï¼Œå˜æˆï¼š[a-zA-Z0-9]ã€‚ æˆ‘ä»¬è¦å–å¾—æœ‰æ•°å­—çš„é‚£ä¸€è¡Œï¼Œå°±è¿™æ ·ï¼š123[root@www ~]# grep -n '[0-9]' regular_express.txt5:However, this dress is about $ 3183 dollars.15:You are the best is mean you are the no. 1. è¡Œé¦–ä¸Žè¡Œå°¾å­—èŠ‚ ^ $è¡Œé¦–å­—ç¬¦ï¼šå¦‚æžœæˆ‘æƒ³è¦è®© the åªåœ¨è¡Œé¦–åˆ—å‡ºå‘¢ï¼Ÿ è¿™ä¸ªæ—¶å€™å°±å¾—è¦ä½¿ç”¨å®šä½å­—èŠ‚äº†ï¼æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š12[root@www ~]# grep -n '^the' regular_express.txt12:the symbol '*' is represented as start. æ­¤æ—¶ï¼Œå°±åªå‰©ä¸‹ç¬¬ 12 è¡Œï¼Œå› ä¸ºåªæœ‰ç¬¬ 12 è¡Œçš„è¡Œé¦–æ˜¯ the å¼€å¤´å•Šï½žæ­¤å¤–ï¼Œ å¦‚æžœæˆ‘æƒ³è¦å¼€å¤´æ˜¯å°å†™å­—èŠ‚çš„é‚£ä¸€è¡Œå°±åˆ—å‡ºå‘¢ï¼Ÿå¯ä»¥è¿™æ ·ï¼š12345678[root@www ~]# grep -n '^[a-z]' regular_express.txt2:apple is my favorite food.4:this dress doesn't fit me.10:motorcycle is cheap than car.12:the symbol '*' is represented as start.18:google is the best tools for search keyword.19:goooooogle yes!20:go! go! Let's go. å¦‚æžœæˆ‘ä¸æƒ³è¦å¼€å¤´æ˜¯è‹±æ–‡å­—æ¯ï¼Œåˆ™å¯ä»¥æ˜¯è¿™æ ·ï¼š123[root@www ~]# grep -n '^[^a-zA-Z]' regular_express.txt1:"Open Source" is a good mechanism to develop programs.21:# I am VBird ^ ç¬¦å·ï¼Œåœ¨å­—ç¬¦ç±»ç¬¦å·(æ‹¬å·[])ä¹‹å†…ä¸Žä¹‹å¤–æ˜¯ä¸åŒçš„ï¼ åœ¨ [] å†…ä»£è¡¨åå‘é€‰æ‹©ï¼Œåœ¨ [] ä¹‹å¤–åˆ™ä»£è¡¨å®šä½åœ¨è¡Œé¦–çš„æ„ä¹‰ï¼ é‚£å¦‚æžœæˆ‘æƒ³è¦æ‰¾å‡ºæ¥ï¼Œè¡Œå°¾ç»“æŸä¸ºå°æ•°ç‚¹ (.) çš„é‚£ä¸€è¡Œï¼š12345678910111213[root@www ~]# grep -n '\.$' regular_express.txt1:"Open Source" is a good mechanism to develop programs.2:apple is my favorite food.3:Football game is not use feet only.4:this dress doesn't fit me.10:motorcycle is cheap than car.11:This window is clear.12:the symbol '*' is represented as start.15:You are the best is mean you are the no. 1.16:The world &lt;Happy&gt; is the same with "glad".17:I like dog.18:google is the best tools for search keyword.20:go! go! Let's go. ç‰¹åˆ«æ³¨æ„åˆ°ï¼Œå› ä¸ºå°æ•°ç‚¹å…·æœ‰å…¶ä»–æ„ä¹‰(åº•ä¸‹ä¼šä»‹ç»)ï¼Œæ‰€ä»¥å¿…é¡»è¦ä½¿ç”¨è½¬ä¹‰å­—ç¬¦(\)æ¥åŠ ä»¥è§£é™¤å…¶ç‰¹æ®Šæ„ä¹‰ï¼ æ‰¾å‡ºç©ºç™½è¡Œï¼š12[root@www ~]# grep -n '^$' regular_express.txt22: å› ä¸ºåªæœ‰è¡Œé¦–è·Ÿè¡Œå°¾ (^$)ï¼Œæ‰€ä»¥ï¼Œè¿™æ ·å°±å¯ä»¥æ‰¾å‡ºç©ºç™½è¡Œå•¦ï¼ ä»»æ„ä¸€ä¸ªå­—èŠ‚ . ä¸Žé‡å¤å­—èŠ‚ *è¿™ä¸¤ä¸ªç¬¦å·åœ¨æ­£åˆ™è¡¨è¾¾å¼çš„æ„ä¹‰å¦‚ä¸‹ï¼š . (å°æ•°ç‚¹)ï¼šä»£è¡¨ä¸€å®šæœ‰ä¸€ä¸ªä»»æ„å­—èŠ‚çš„æ„æ€ï¼›* (æ˜Ÿå·)ï¼šä»£è¡¨é‡å¤å‰ä¸€ä¸ªå­—ç¬¦ï¼Œ 0 åˆ°æ— ç©·å¤šæ¬¡çš„æ„æ€ï¼Œä¸ºç»„åˆå½¢æ€ å‡è®¾æˆ‘éœ€è¦æ‰¾å‡º g??d çš„å­—ä¸²ï¼Œäº¦å³å…±æœ‰å››ä¸ªå­—èŠ‚ï¼Œ èµ·å¤´æ˜¯ g è€Œç»“æŸæ˜¯ d ï¼Œæˆ‘å¯ä»¥è¿™æ ·åšï¼š1234[root@www ~]# grep -n 'g..d' regular_express.txt1:"Open Source" is a good mechanism to develop programs.9:Oh! The soup taste good.16:The world &lt;Happy&gt; is the same with "glad". å› ä¸ºå¼ºè°ƒ g ä¸Ž d ä¹‹é—´ä¸€å®šè¦å­˜åœ¨ä¸¤ä¸ªå­—èŠ‚ï¼Œå› æ­¤ï¼Œç¬¬ 13 è¡Œçš„ god ä¸Žç¬¬ 14 è¡Œçš„ gd å°±ä¸ä¼šè¢«åˆ—å‡ºæ¥å•¦ï¼ å¦‚æžœæˆ‘æƒ³è¦åˆ—å‡ºæœ‰ oo, ooo, oooo ç­‰ç­‰çš„æ•°æ®ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œè‡³å°‘è¦æœ‰ä¸¤ä¸ª(å«) o ä»¥ä¸Šï¼Œè¯¥å¦‚ä½•æ˜¯å¥½ï¼Ÿ å› ä¸º * ä»£è¡¨çš„æ˜¯é‡å¤ 0 ä¸ªæˆ–å¤šä¸ªå‰é¢çš„ RE å­—ç¬¦çš„æ„ä¹‰ï¼Œ å› æ­¤ o* ä»£è¡¨çš„æ˜¯ï¼šæ‹¥æœ‰ç©ºå­—èŠ‚æˆ–ä¸€ä¸ª o ä»¥ä¸Šçš„å­—èŠ‚ï¼Œå› æ­¤ï¼Œgrep -n &#39;o*&#39; regular_express.txtå°†ä¼šæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½åˆ—å°å‡ºæ¥ç»ˆç«¯ä¸Šï¼ å½“æˆ‘ä»¬éœ€è¦è‡³å°‘ä¸¤ä¸ª o ä»¥ä¸Šçš„å­—ä¸²æ—¶ï¼Œå°±éœ€è¦ ooo* ï¼Œäº¦å³æ˜¯ï¼š1234567[root@www ~]# grep -n 'ooo*' regular_express.txt1:"Open Source" is a good mechanism to develop programs.2:apple is my favorite food.3:Football game is not use feet only.9:Oh! The soup taste good.18:google is the best tools for search keyword.19:goooooogle yes! å¦‚æžœæˆ‘æƒ³è¦å­—ä¸²å¼€å¤´ä¸Žç»“å°¾éƒ½æ˜¯ gï¼Œä½†æ˜¯ä¸¤ä¸ª g ä¹‹é—´ä»…èƒ½å­˜åœ¨è‡³å°‘ä¸€ä¸ª o ï¼Œäº¦å³æ˜¯ gog, goog, gooogâ€¦. ç­‰ç­‰ï¼Œé‚£è¯¥å¦‚ä½•ï¼Ÿ123[root@www ~]# grep -n 'goo*g' regular_express.txt18:google is the best tools for search keyword.19:goooooogle yes! å¦‚æžœæˆ‘æƒ³è¦æ‰¾å‡º g å¼€å¤´ä¸Ž g ç»“å°¾çš„è¡Œï¼Œå½“ä¸­çš„å­—ç¬¦å¯æœ‰å¯æ— 123456[root@www ~]# grep -n 'g.*g' regular_express.txt1:"Open Source" is a good mechanism to develop programs.14:The gd software is a library for drafting programs.18:google is the best tools for search keyword.19:goooooogle yes!20:go! go! Let's go. å› ä¸ºæ˜¯ä»£è¡¨ g å¼€å¤´ä¸Ž g ç»“å°¾ï¼Œä¸­é—´ä»»æ„å­—èŠ‚å‡å¯æŽ¥å—ï¼Œæ‰€ä»¥ï¼Œç¬¬ 1, 14, 20 è¡Œæ˜¯å¯æŽ¥å—çš„å–”ï¼ è¿™ä¸ª .* çš„ RE è¡¨ç¤ºä»»æ„å­—ç¬¦æ˜¯å¾ˆå¸¸è§çš„. å¦‚æžœæˆ‘æƒ³è¦æ‰¾å‡ºä»»æ„æ•°å­—çš„è¡Œï¼Ÿå› ä¸ºä»…æœ‰æ•°å­—ï¼Œæ‰€ä»¥å°±æˆä¸ºï¼š123[root@www ~]# grep -n '[0-9][0-9]*' regular_express.txt5:However, this dress is about $ 3183 dollars.15:You are the best is mean you are the no. 1. é™å®šè¿žç»­ RE å­—ç¬¦èŒƒå›´ {}æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ . ä¸Ž RE å­—ç¬¦åŠ * æ¥é…ç½® 0 ä¸ªåˆ°æ— é™å¤šä¸ªé‡å¤å­—èŠ‚ï¼Œ é‚£å¦‚æžœæˆ‘æƒ³è¦é™åˆ¶ä¸€ä¸ªèŒƒå›´åŒºé—´å†…çš„é‡å¤å­—èŠ‚æ•°å‘¢ï¼Ÿ ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘æƒ³è¦æ‰¾å‡ºä¸¤ä¸ªåˆ°äº”ä¸ª o çš„è¿žç»­å­—ä¸²ï¼Œè¯¥å¦‚ä½•ä½œï¼Ÿè¿™æ—¶å€™å°±å¾—è¦ä½¿ç”¨åˆ°é™å®šèŒƒå›´çš„å­—ç¬¦ {} äº†ã€‚ ä½†å› ä¸º { ä¸Ž } çš„ç¬¦å·åœ¨ shell æ˜¯æœ‰ç‰¹æ®Šæ„ä¹‰çš„ï¼Œå› æ­¤ï¼Œ æˆ‘ä»¬å¿…é¡»è¦ä½¿ç”¨å­—ç¬¦ \ æ¥è®©ä»–å¤±åŽ»ç‰¹æ®Šæ„ä¹‰æ‰è¡Œã€‚ è‡³æ–¼ {} çš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼Œå‡è®¾æˆ‘è¦æ‰¾åˆ°ä¸¤ä¸ª o çš„å­—ä¸²ï¼Œå¯ä»¥æ˜¯ï¼š1234567[root@www ~]# grep -n 'o\&#123;2\&#125;' regular_express.txt1:"Open Source" is a good mechanism to develop programs.2:apple is my favorite food.3:Football game is not use feet only.9:Oh! The soup taste good.18:google is the best tools for search ke19:goooooogle yes! å‡è®¾æˆ‘ä»¬è¦æ‰¾å‡º g åŽé¢æŽ¥ 2 åˆ° 5 ä¸ª o ï¼Œç„¶åŽå†æŽ¥ä¸€ä¸ª g çš„å­—ä¸²ï¼Œä»–ä¼šæ˜¯è¿™æ ·ï¼š12[root@www ~]# grep -n 'go\&#123;2,5\&#125;g' regular_express.txt18:google is the best tools for search keyword. å¦‚æžœæˆ‘æƒ³è¦çš„æ˜¯ 2 ä¸ª o ä»¥ä¸Šçš„ gooooâ€¦.g å‘¢ï¼Ÿé™¤äº†å¯ä»¥æ˜¯ gooo*g ï¼Œä¹Ÿå¯ä»¥æ˜¯ï¼š123[root@www ~]# grep -n 'go\&#123;2,\&#125;g' regular_express.txt18:google is the best tools for search keyword.19:goooooogle yes! æ‰©å±•grep(grep -E æˆ–è€… egrep)ï¼šä½¿ç”¨æ‰©å±•grepçš„ä¸»è¦å¥½å¤„æ˜¯å¢žåŠ äº†é¢å¤–çš„æ­£åˆ™è¡¨è¾¾å¼å…ƒå­—ç¬¦é›†ã€‚ æ‰“å°æ‰€æœ‰åŒ…å«NWæˆ–EAçš„è¡Œã€‚å¦‚æžœä¸æ˜¯ä½¿ç”¨egrepï¼Œè€Œæ˜¯grepï¼Œå°†ä¸ä¼šæœ‰ç»“æžœæŸ¥å‡ºã€‚123egrep 'NW|EA' testfile northwest NW Charles Main 3.0 .98 3 34 eastern EA TB Savage 4.4 .84 5 20 å¯¹äºŽæ ‡å‡†grepï¼Œå¦‚æžœåœ¨æ‰©å±•å…ƒå­—ç¬¦å‰é¢åŠ \ï¼Œgrepä¼šè‡ªåŠ¨å¯ç”¨æ‰©å±•é€‰é¡¹-Eã€‚123grep 'NW\|EA' testfilenorthwest NW Charles Main 3.0 .98 3 34eastern EA TB Savage 4.4 .84 5 20 æœç´¢æ‰€æœ‰åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª3çš„è¡Œã€‚12345678egrep '3+' testfilegrep -E '3+' testfilegrep '3\+' testfile #è¿™3æ¡å‘½ä»¤å°†ä¼šnorthwest NW Charles Main 3.0 .98 3 34western WE Sharon Gray 5.3 .97 5 23northeast NE AM Main Jr. 5.1 .94 3 13central CT Ann Stephens 5.7 .94 5 13 æœç´¢æ‰€æœ‰åŒ…å«0ä¸ªæˆ–1ä¸ªå°æ•°ç‚¹å­—ç¬¦çš„è¡Œã€‚1234567egrep '2\.?[0-9]' testfile grep -E '2\.?[0-9]' testfilegrep '2\.\?[0-9]' testfile #é¦–å…ˆå«æœ‰2å­—ç¬¦ï¼Œå…¶åŽç´§è·Ÿç€0ä¸ªæˆ–1ä¸ªç‚¹ï¼ŒåŽé¢å†æ˜¯0å’Œ9ä¹‹é—´çš„æ•°å­—ã€‚western WE Sharon Gray 5.3 .97 5 23southwest SW Lewis Dalsass 2.7 .8 2 18eastern EA TB Savage 4.4 .84 5 20 æœç´¢ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿žç»­çš„noçš„è¡Œã€‚123456egrep '(no)+' testfilegrep -E '(no)+' testfilegrep '\(no\)\+' testfile #3ä¸ªå‘½ä»¤è¿”å›žç›¸åŒç»“æžœï¼Œnorthwest NW Charles Main 3.0 .98 3 34northeast NE AM Main Jr. 5.1 .94 3 13north NO Margot Weber 4.5 .89 5 9 ä¸ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ fgrep æŸ¥è¯¢é€Ÿåº¦æ¯”grepå‘½ä»¤å¿«ï¼Œä½†æ˜¯ä¸å¤Ÿçµæ´»ï¼šå®ƒåªèƒ½æ‰¾å›ºå®šçš„æ–‡æœ¬ï¼Œè€Œä¸æ˜¯è§„åˆ™è¡¨è¾¾å¼ã€‚ å¦‚æžœä½ æƒ³åœ¨ä¸€ä¸ªæ–‡ä»¶æˆ–è€…è¾“å‡ºä¸­æ‰¾åˆ°åŒ…å«æ˜Ÿå·å­—ç¬¦çš„è¡Œ12345fgrep '*' /etc/profilefor i in /etc/profile.d/*.sh ; doæˆ–grep -F '*' /etc/profilefor i in /etc/profile.d/*.sh ; do]]></content>
      <categories>
        <category>linuxå‘½ä»¤</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>grep</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[jQueryçš„.bind()ã€.live()å’Œ.delegate()ä¹‹é—´åŒºåˆ«]]></title>
    <url>%2F2014%2F01%2F04%2Fjquery-bind-delegate%2F</url>
    <content type="text"><![CDATA[æ‘˜è¦: jQueryçš„.bind()ã€.live()å’Œ.delegate()ä¹‹é—´çš„åŒºåˆ«å¹¶éžæ€»æ˜¯é‚£ä¹ˆæ˜Žæ˜¾çš„ï¼Œç„¶è€Œï¼Œå¦‚æžœæˆ‘ä»¬å¯¹æ‰€æœ‰çš„ä¸åŒä¹‹å¤„éƒ½æœ‰æ¸…æ™°çš„ç†è§£çš„è¯ï¼Œé‚£ä¹ˆè¿™å°†ä¼šæœ‰åŠ©äºŽæˆ‘ä»¬ç¼–å†™å‡ºæ›´åŠ ç®€æ´çš„ä»£ç ï¼Œä»¥åŠé˜²æ­¢åœ¨äº¤äº’åº”ç”¨ä¸­å¼¹å‡ºé”™è¯¯ã€‚ DOMæ ‘ é¦–å…ˆï¼Œå¯è§†åŒ–ä¸€ä¸ªHMTLæ–‡æ¡£çš„DOMæ ‘æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚ä¸€ä¸ªç®€å•çš„HTMLé¡µé¢çœ‹èµ·æ¥å°±åƒæ˜¯è¿™ä¸ªæ ·å­ï¼š äº‹ä»¶å†’æ³¡(åˆç§°äº‹ä»¶ä¼ æ’­) å½“æˆ‘ä»¬ç‚¹å‡»ä¸€ä¸ªé“¾æŽ¥æ—¶ï¼Œå…¶è§¦å‘äº†é“¾æŽ¥å…ƒç´ çš„å•å‡»äº‹ä»¶ï¼Œè¯¥äº‹ä»¶åˆ™å¼•å‘ä»»ä½•æˆ‘ä»¬å·²ç»‘å®šåˆ°è¯¥å…ƒç´ çš„å•å‡»äº‹ä»¶ä¸Šçš„å‡½æ•°çš„æ‰§è¡Œã€‚ 1$('a').bind('click', function() &#123; alert("That tickles!") &#125;); å› æ­¤ä¸€ä¸ªå•å‡»æ“ä½œä¼šè§¦å‘alertå‡½æ•°çš„æ‰§è¡Œã€‚ clickäº‹ä»¶æŽ¥ç€ä¼šå‘æ ‘çš„æ ¹æ–¹å‘ä¼ æ’­ï¼Œå¹¿æ’­åˆ°çˆ¶å…ƒç´ ï¼Œç„¶åŽæŽ¥ç€æ˜¯æ¯ä¸ªç¥–å…ˆå…ƒç´ ï¼Œåªè¦æ˜¯å®ƒçš„æŸä¸ªåŽä»£å…ƒç´ ä¸Šçš„å•å‡»äº‹ä»¶è¢«è§¦å‘ï¼Œäº‹ä»¶å°±ä¼šä¼ ç»™å®ƒã€‚ åœ¨æ“çºµDOMçš„è¯­å¢ƒä¸­ï¼Œdocumentæ˜¯æ ¹èŠ‚ç‚¹ã€‚ çŽ°åœ¨æˆ‘ä»¬å¯ä»¥è¾ƒå®¹æ˜“åœ°è¯´æ˜Ž.bind()ã€.live()å’Œ.delegate()çš„ä¸åŒä¹‹å¤„äº†ã€‚ .bind() 1$('a').bind('click', function() &#123; alert("That tickles!") &#125;); è¿™æ˜¯æœ€ç®€å•çš„ç»‘å®šæ–¹æ³•äº†ã€‚JQueryæ‰«ææ–‡æ¡£æ‰¾å‡ºæ‰€æœ‰çš„$(â€˜aâ€™)å…ƒç´ ï¼Œå¹¶æŠŠalertå‡½æ•°ç»‘å®šåˆ°æ¯ä¸ªå…ƒç´ çš„clickäº‹ä»¶ä¸Šã€‚ .live() 1$('a').live('click', function() &#123; alert("That tickles!") &#125;); JQueryæŠŠalertå‡½æ•°ç»‘å®šåˆ°$(document)å…ƒç´ ä¸Šï¼Œå¹¶ä½¿ç”¨â€™clickâ€™å’Œâ€™aâ€™ä½œä¸ºå‚æ•°ã€‚ä»»ä½•æ—¶å€™åªè¦æœ‰äº‹ä»¶å†’æ³¡åˆ°documentèŠ‚ç‚¹ä¸Šï¼Œå®ƒå°±æŸ¥çœ‹è¯¥äº‹ä»¶æ˜¯å¦æ˜¯ä¸€ä¸ªclickäº‹ä»¶ï¼Œä»¥åŠè¯¥äº‹ä»¶çš„ç›®æ ‡å…ƒç´ ä¸Žâ€™aâ€™è¿™ä¸€CSSé€‰æ‹©å™¨æ˜¯å¦åŒ¹é…ï¼Œå¦‚æžœéƒ½æ˜¯çš„è¯ï¼Œåˆ™æ‰§è¡Œå‡½æ•°ã€‚ liveæ–¹æ³•è¿˜å¯ä»¥è¢«ç»‘å®šåˆ°å…·ä½“çš„å…ƒç´ (æˆ–â€œcontextâ€)è€Œä¸æ˜¯documentä¸Šï¼Œåƒè¿™æ ·ï¼š 1$('a', $('#container')[0]).live(...); .delegate() 1$('#container').delegate('a', 'click', function() &#123; alert("That tickles!") &#125;); JQueryæ‰«ææ–‡æ¡£æŸ¥æ‰¾$(â€˜#containerâ€™)ï¼Œå¹¶ä½¿ç”¨clickäº‹ä»¶å’Œâ€™aâ€™è¿™ä¸€CSSé€‰æ‹©å™¨ä½œä¸ºå‚æ•°æŠŠalertå‡½æ•°ç»‘å®šåˆ°$(â€˜#containerâ€™)ä¸Šã€‚ä»»ä½•æ—¶å€™åªè¦æœ‰äº‹ä»¶å†’æ³¡åˆ°$(â€˜#containerâ€™)ä¸Šï¼Œå®ƒå°±æŸ¥çœ‹è¯¥äº‹ä»¶æ˜¯å¦æ˜¯clickäº‹ä»¶ï¼Œä»¥åŠè¯¥äº‹ä»¶çš„ç›®æ ‡å…ƒç´ æ˜¯å¦ä¸ŽCCSé€‰æ‹©å™¨ç›¸åŒ¹é…ã€‚å¦‚æžœä¸¤ç§æ£€æŸ¥çš„ç»“æžœéƒ½ä¸ºçœŸçš„è¯ï¼Œå®ƒå°±æ‰§è¡Œå‡½æ•°ã€‚ å¯ä»¥æ³¨æ„åˆ°ï¼Œè¿™ä¸€è¿‡ç¨‹ä¸Ž.live()ç±»ä¼¼ï¼Œä½†æ˜¯å…¶æŠŠå¤„ç†ç¨‹åºç»‘å®šåˆ°å…·ä½“çš„å…ƒç´ è€Œéždocumentè¿™ä¸€æ ¹ä¸Šã€‚ç²¾æ˜Žçš„JSâ€™erä»¬å¯èƒ½ä¼šåšå‡ºè¿™æ ·çš„ç»“è®ºï¼Œå³$(â€˜aâ€™).live() == $(document).delegate(â€˜aâ€™)ï¼Œæ˜¯è¿™æ ·å—?å—¯ï¼Œä¸ï¼Œä¸å®Œå…¨æ˜¯ã€‚ ä¸ºä»€ä¹ˆ.delegate()è¦æ¯”.live()å¥½ç”¨ åŸºäºŽå‡ ä¸ªåŽŸå› ï¼Œäººä»¬é€šå¸¸æ›´æ„¿æ„é€‰ç”¨jQueryçš„delegateæ–¹æ³•è€Œä¸æ˜¯liveæ–¹æ³•ã€‚è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š 123$('a').live('click', function() &#123; blah() &#125;); // æˆ–è€… $(document).delegate('a', 'click', function() &#123; blah() &#125;); é€Ÿåº¦ åŽè€…å®žé™…ä¸Šè¦å¿«è¿‡å‰è€…ï¼Œå› ä¸ºå‰è€…é¦–å…ˆè¦æ‰«ææ•´ä¸ªçš„æ–‡æ¡£æŸ¥æ‰¾æ‰€æœ‰çš„$(â€˜aâ€™)å…ƒç´ ï¼ŒæŠŠå®ƒä»¬å­˜æˆjQueryå¯¹è±¡ã€‚å°½ç®¡liveå‡½æ•°ä»…éœ€è¦æŠŠâ€™aâ€™ä½œä¸ºä¸²å‚æ•°ä¼ é€’ä»¥ç”¨åšä¹‹åŽçš„åˆ¤æ–­ï¼Œä½†æ˜¯$()å‡½æ•°å¹¶æœªâ€œçŸ¥é“â€è¢«é“¾æŽ¥çš„æ–¹æ³•å°†ä¼šæ˜¯.live()ã€‚ è€Œå¦ä¸€æ–¹é¢ï¼Œdelegateæ–¹æ³•ä»…éœ€è¦æŸ¥æ‰¾å¹¶å­˜å‚¨$(document)å…ƒç´ ã€‚ ä¸€ç§å¯»æ±‚é¿å¼€è¿™ä¸€é—®é¢˜çš„æ–¹æ³•æ˜¯è°ƒç”¨åœ¨$(document).ready()ä¹‹å¤–ç»‘å®šçš„liveï¼Œè¿™æ ·å®ƒå°±ä¼šç«‹å³æ‰§è¡Œã€‚åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œå…¶ä¼šåœ¨DOMèŽ·å¾—å¡«å……ä¹‹å‰è¿è¡Œï¼Œå› æ­¤å°±ä¸ä¼šæŸ¥æ‰¾å…ƒç´ æˆ–æ˜¯åˆ›å»ºjQueryå¯¹è±¡äº†ã€‚ çµæ´»æ€§å’Œé“¾èƒ½åŠ› liveå‡½æ•°ä¹ŸæŒºä»¤äººè´¹è§£çš„ã€‚æƒ³æƒ³çœ‹ï¼Œå®ƒè¢«é“¾åˆ°$(â€˜aâ€™)å¯¹è±¡é›†ä¸Šï¼Œä½†å…¶å®žé™…ä¸Šæ˜¯åœ¨$(document)å¯¹è±¡ä¸Šå‘ç”Ÿä½œç”¨ã€‚ç”±äºŽè¿™ä¸ªåŽŸå› ï¼Œå®ƒèƒ½å¤Ÿè¯•å›¾ä»¥ä¸€ç§å“æ­»äººçš„æ–¹å¼æ¥æŠŠæ–¹æ³•é“¾åˆ°è‡ªèº«ä¸Šã€‚å®žé™…ä¸Šï¼Œæˆ‘æƒ³è¯´çš„æ˜¯ï¼Œä»¥$.live(â€˜aâ€™,â€¦)è¿™ä¸€å½¢å¼ä½œä¸ºä¸€ç§å…¨å±€æ€§çš„jQueryæ–¹æ³•ï¼Œliveæ–¹æ³•ä¼šæ›´å…·æ„ä¹‰ä¸€äº›ã€‚ ä»…æ”¯æŒCSSé€‰æ‹©å™¨ æœ€åŽä¸€ç‚¹ï¼Œliveæ–¹æ³•æœ‰ä¸€ä¸ªéžå¸¸å¤§çš„ç¼ºç‚¹ï¼Œé‚£å°±æ˜¯å®ƒä»…èƒ½é’ˆå¯¹ç›´æŽ¥çš„CSSé€‰æ‹©å™¨åšæ“ä½œï¼Œè¿™ä½¿å¾—å®ƒå˜å¾—éžå¸¸çš„ä¸çµæ´»ã€‚ æ¬²äº†è§£æ›´å¤šå…³äºŽCSSé€‰æ‹©å™¨çš„ç¼ºç‚¹ï¼Œè¯·å‚é˜…Exploring jQuery .live() and .die()ä¸€æ–‡ã€‚ æ›´æ–°ï¼šæ„Ÿè°¢Hacker Newsä¸Šçš„pedalpeteå’ŒåŽé¢è¯„è®ºä¸­çš„Ellsassæé†’æˆ‘åŠ å…¥æŽ¥ä¸‹æ¥çš„è¿™ä¸€èŠ‚å†…å®¹ã€‚ ä¸ºä»€ä¹ˆé€‰æ‹©.live()æˆ–.delegate()è€Œä¸æ˜¯.bind() æ¯•ç«Ÿï¼Œbindçœ‹èµ·æ¥ä¼¼ä¹Žæ›´åŠ çš„æ˜Žç¡®å’Œç›´æŽ¥ï¼Œéš¾é“ä¸æ˜¯å—?å—¯ï¼Œæœ‰ä¸¤ä¸ªåŽŸå› è®©æˆ‘ä»¬æ›´æ„¿æ„é€‰æ‹©delegateæˆ–liveè€Œä¸æ˜¯bindï¼š ä¸ºäº†æŠŠå¤„ç†ç¨‹åºé™„åŠ åˆ°å¯èƒ½è¿˜æœªå­˜åœ¨äºŽDOMä¸­çš„DOMå…ƒç´ ä¹‹ä¸Šã€‚å› ä¸ºbindæ˜¯ç›´æŽ¥æŠŠå¤„ç†ç¨‹åºç»‘å®šåˆ°å„ä¸ªå…ƒç´ ä¸Šï¼Œå®ƒä¸èƒ½æŠŠå¤„ç†ç¨‹åºç»‘å®šåˆ°è¿˜æœªå­˜åœ¨äºŽé¡µé¢ä¸­çš„å…ƒç´ ä¹‹ä¸Šã€‚ å¦‚æžœä½ è¿è¡Œäº†$(â€˜aâ€™).bind(â€¦)ï¼Œè€ŒåŽæ–°çš„é“¾æŽ¥ç»ç”±AJAXåŠ å…¥åˆ°äº†é¡µé¢ä¸­ï¼Œåˆ™ä½ çš„bindå¤„ç†ç¨‹åºå¯¹äºŽè¿™äº›æ–°åŠ å…¥çš„é“¾æŽ¥æ¥è¯´æ˜¯æ— æ•ˆçš„ã€‚è€Œå¦ä¸€æ–¹é¢liveå’Œdelegateåˆ™æ˜¯è¢«ç»‘å®šåˆ°å¦ä¸€ä¸ªç¥–å…ˆèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤å…¶å¯¹äºŽä»»ä½•ç›®å‰æˆ–æ˜¯å°†æ¥å­˜åœ¨äºŽè¯¥ç¥–å…ˆå…ƒç´ ä¹‹å†…çš„å…ƒç´ éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ æˆ–è€…ä¸ºäº†æŠŠå¤„ç†ç¨‹åºé™„åŠ åˆ°å•ä¸ªå…ƒç´ ä¸Šæˆ–æ˜¯ä¸€å°ç»„å…ƒç´ ä¹‹ä¸Šï¼Œç›‘å¬åŽä»£å…ƒç´ ä¸Šçš„äº‹ä»¶è€Œä¸æ˜¯å¾ªçŽ¯éåŽ†å¹¶æŠŠåŒä¸€ä¸ªå‡½æ•°é€ä¸ªé™„åŠ åˆ°DOMä¸­çš„100ä¸ªå…ƒç´ ä¸Šã€‚æŠŠå¤„ç†ç¨‹åºé™„åŠ åˆ°ä¸€ä¸ª(æˆ–æ˜¯ä¸€å°ç»„)ç¥–å…ˆå…ƒç´ ä¸Šè€Œä¸æ˜¯ç›´æŽ¥æŠŠå¤„ç†ç¨‹åºé™„åŠ åˆ°é¡µé¢ä¸­çš„æ‰€æœ‰å…ƒç´ ä¸Šï¼Œè¿™ç§åšæ³•å¸¦æ¥äº†æ€§èƒ½ä¸Šçš„å¥½å¤„ã€‚ åœæ­¢ä¼ æ’­ æœ€åŽä¸€ä¸ªæˆ‘æƒ³åšçš„æé†’ä¸Žäº‹ä»¶ä¼ æ’­æœ‰å…³ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨è¿™æ ·çš„äº‹ä»¶æ–¹æ³•æ¥ç»ˆæ­¢å¤„ç†å‡½æ•°çš„æ‰§è¡Œï¼š 12345$('a').bind('click', function(e) &#123; e.preventDefault(); // æˆ–è€… e.stopPropagation(); &#125;); ä¸è¿‡ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨liveæˆ–æ˜¯delegateæ–¹æ³•çš„æ—¶å€™ï¼Œå¤„ç†å‡½æ•°å®žé™…ä¸Šå¹¶æ²¡æœ‰åœ¨è¿è¡Œï¼Œéœ€è¦ç­‰åˆ°äº‹ä»¶å†’æ³¡åˆ°å¤„ç†ç¨‹åºå®žé™…ç»‘å®šçš„å…ƒç´ ä¸Šæ—¶å‡½æ•°æ‰ä¼šè¿è¡Œã€‚è€Œåˆ°æ­¤æ—¶ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„å…¶ä»–çš„æ¥è‡ª.bind()çš„å¤„ç†å‡½æ•°æ—©å·²è¿è¡Œäº†ã€‚ åŽŸæ–‡åœ°å€ï¼šhttp://developer.51cto.com/art/201103/249694.htm]]></content>
      <categories>
        <category>jQuery</category>
      </categories>
      <tags>
        <tag>jQuery</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ­£ç¡®ç†è§£ThreadLocal]]></title>
    <url>%2F2014%2F01%2F04%2Fthreadlocal-understanding%2F</url>
    <content type="text"><![CDATA[é¦–å…ˆï¼ŒThreadLocal ä¸æ˜¯ç”¨æ¥è§£å†³å…±äº«å¯¹è±¡çš„å¤šçº¿ç¨‹è®¿é—®é—®é¢˜çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé€šè¿‡ThreadLocal.set() åˆ°çº¿ç¨‹ä¸­çš„å¯¹è±¡æ˜¯è¯¥çº¿ç¨‹è‡ªå·±ä½¿ç”¨çš„å¯¹è±¡ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯ä¸éœ€è¦è®¿é—®çš„ï¼Œä¹Ÿè®¿é—®ä¸åˆ°çš„ã€‚ å„ä¸ªçº¿ç¨‹ä¸­è®¿é—®çš„æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚ å¦å¤–ï¼Œè¯´ThreadLocalä½¿å¾—å„çº¿ç¨‹èƒ½å¤Ÿä¿æŒå„è‡ªç‹¬ç«‹çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸æ˜¯é€šè¿‡ThreadLocal.set()æ¥å®žçŽ°çš„ï¼Œè€Œæ˜¯é€šè¿‡æ¯ä¸ªçº¿ç¨‹ä¸­çš„new å¯¹è±¡ çš„æ“ä½œæ¥åˆ›å»ºçš„å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªï¼Œä¸æ˜¯ä»€ä¹ˆå¯¹è±¡çš„æ‹·è´æˆ–å‰¯æœ¬ã€‚ é€šè¿‡ThreadLocal.set()å°†è¿™ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°å„çº¿ç¨‹çš„è‡ªå·±çš„ä¸€ä¸ªmapä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è¿™æ ·ä¸€ä¸ªmapï¼Œæ‰§è¡ŒThreadLocal.get()æ—¶ï¼Œå„çº¿ç¨‹ä»Žè‡ªå·±çš„mapä¸­å–å‡ºæ”¾è¿›åŽ»çš„å¯¹è±¡ï¼Œå› æ­¤å–å‡ºæ¥çš„æ˜¯å„è‡ªè‡ªå·±çº¿ç¨‹ä¸­çš„å¯¹è±¡ï¼ŒThreadLocalå®žä¾‹æ˜¯ä½œä¸ºmapçš„keyæ¥ä½¿ç”¨çš„ã€‚å¦‚æžœThreadLocal.set()è¿›åŽ»çš„ä¸œè¥¿æœ¬æ¥å°±æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹çš„ThreadLocal.get()å–å¾—çš„è¿˜æ˜¯è¿™ä¸ªå…±äº«å¯¹è±¡æœ¬èº«ï¼Œè¿˜æ˜¯æœ‰å¹¶å‘è®¿é—®é—®é¢˜ã€‚ ä¸‹é¢æ¥çœ‹ä¸€ä¸ªhibernateä¸­å…¸åž‹çš„ThreadLocalçš„åº”ç”¨ï¼š 1234567891011121314private static final ThreadLocal threadSession = new ThreadLocal(); public static Session getSession() throws InfrastructureException &#123; Session s = (Session) threadSession.get(); try &#123; if (s == null) &#123; s = getSessionFactory().openSession(); threadSession.set(s); &#125; &#125; catch (HibernateException ex) &#123; throw new InfrastructureException(ex); &#125; return s; &#125; å¯ä»¥çœ‹åˆ°åœ¨getSession()æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹ä¸­æœ‰æ²¡æœ‰æ”¾è¿›åŽ»sessionï¼Œå¦‚æžœè¿˜æ²¡æœ‰ï¼Œé‚£ä¹ˆé€šè¿‡sessionFactory().openSession()æ¥åˆ›å»ºä¸€ä¸ªsessionï¼Œå†å°†session setåˆ°çº¿ç¨‹ä¸­ï¼Œå®žé™…æ˜¯æ”¾åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMapè¿™ä¸ªmapä¸­ï¼Œè¿™æ—¶ï¼Œå¯¹äºŽè¿™ä¸ªsessionçš„å”¯ä¸€å¼•ç”¨å°±æ˜¯å½“å‰çº¿ç¨‹ä¸­çš„é‚£ä¸ªThreadLocalMapï¼ˆä¸‹é¢ä¼šè®²åˆ°ï¼‰ï¼Œè€ŒthreadSessionä½œä¸ºè¿™ä¸ªå€¼çš„keyï¼Œè¦å–å¾—è¿™ä¸ªsessionå¯ä»¥é€šè¿‡threadSession.get()æ¥å¾—åˆ°ï¼Œé‡Œé¢æ‰§è¡Œçš„æ“ä½œå®žé™…æ˜¯å…ˆå–å¾—å½“å‰çº¿ç¨‹ä¸­çš„ThreadLocalMapï¼Œç„¶åŽå°†threadSessionä½œä¸ºkeyå°†å¯¹åº”çš„å€¼å–å‡ºã€‚è¿™ä¸ªsessionç›¸å½“äºŽçº¿ç¨‹çš„ç§æœ‰å˜é‡ï¼Œè€Œä¸æ˜¯publicçš„ã€‚æ˜¾ç„¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸­æ˜¯å–ä¸åˆ°è¿™ä¸ªsessionçš„ï¼Œä»–ä»¬ä¹Ÿåªèƒ½å–åˆ°è‡ªå·±çš„ThreadLocalMapä¸­çš„ä¸œè¥¿ã€‚è¦æ˜¯sessionæ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«ä½¿ç”¨çš„ï¼Œé‚£è¿˜ä¸ä¹±å¥—äº†ã€‚è¯•æƒ³å¦‚æžœä¸ç”¨ThreadLocalæ€Žä¹ˆæ¥å®žçŽ°å‘¢ï¼Ÿå¯èƒ½å°±è¦åœ¨actionä¸­åˆ›å»ºsessionï¼Œç„¶åŽæŠŠsessionä¸€ä¸ªä¸ªä¼ åˆ°serviceå’Œdaoä¸­ï¼Œè¿™å¯å¤Ÿéº»çƒ¦çš„ã€‚æˆ–è€…å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªé™æ€çš„mapï¼Œå°†å½“å‰threadä½œä¸ºkeyï¼Œåˆ›å»ºçš„sessionä½œä¸ºå€¼ï¼Œputåˆ°mapä¸­ï¼Œåº”è¯¥ä¹Ÿè¡Œï¼Œè¿™ä¹Ÿæ˜¯ä¸€èˆ¬äººçš„æƒ³æ³•ï¼Œä½†äº‹å®žä¸Šï¼ŒThreadLocalçš„å®žçŽ°åˆšå¥½ç›¸åï¼Œå®ƒæ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­æœ‰ä¸€ä¸ªmapï¼Œè€Œå°†ThreadLocalå®žä¾‹ä½œä¸ºkeyï¼Œè¿™æ ·æ¯ä¸ªmapä¸­çš„é¡¹æ•°å¾ˆå°‘ï¼Œè€Œä¸”å½“çº¿ç¨‹é”€æ¯æ—¶ç›¸åº”çš„ä¸œè¥¿ä¹Ÿä¸€èµ·é”€æ¯äº†ï¼Œä¸çŸ¥é“é™¤äº†è¿™äº›è¿˜æœ‰ä»€ä¹ˆå…¶ä»–çš„å¥½å¤„ã€‚ æ€»ä¹‹ï¼ŒThreadLocalä¸æ˜¯ç”¨æ¥è§£å†³å¯¹è±¡å…±äº«è®¿é—®é—®é¢˜çš„ï¼Œè€Œä¸»è¦æ˜¯æä¾›äº†ä¿æŒå¯¹è±¡çš„æ–¹æ³•å’Œé¿å…å‚æ•°ä¼ é€’çš„æ–¹ä¾¿çš„å¯¹è±¡è®¿é—®æ–¹å¼ã€‚å½’çº³äº†ä¸¤ç‚¹ï¼š1ã€‚æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ThreadLocalMapç±»å¯¹è±¡ï¼Œå¯ä»¥å°†çº¿ç¨‹è‡ªå·±çš„å¯¹è±¡ä¿æŒåˆ°å…¶ä¸­ï¼Œå„ç®¡å„çš„ï¼Œçº¿ç¨‹å¯ä»¥æ­£ç¡®çš„è®¿é—®åˆ°è‡ªå·±çš„å¯¹è±¡ã€‚2ã€‚å°†ä¸€ä¸ªå…±ç”¨çš„ThreadLocalé™æ€å®žä¾‹ä½œä¸ºkeyï¼Œå°†ä¸åŒå¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°ä¸åŒçº¿ç¨‹çš„ThreadLocalMapä¸­ï¼Œç„¶åŽåœ¨çº¿ç¨‹æ‰§è¡Œçš„å„å¤„é€šè¿‡è¿™ä¸ªé™æ€ThreadLocalå®žä¾‹çš„get()æ–¹æ³•å–å¾—è‡ªå·±çº¿ç¨‹ä¿å­˜çš„é‚£ä¸ªå¯¹è±¡ï¼Œé¿å…äº†å°†è¿™ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’çš„éº»çƒ¦ã€‚ å½“ç„¶å¦‚æžœè¦æŠŠæœ¬æ¥çº¿ç¨‹å…±äº«çš„å¯¹è±¡é€šè¿‡ThreadLocal.set()æ”¾åˆ°çº¿ç¨‹ä¸­ä¹Ÿå¯ä»¥ï¼Œå¯ä»¥å®žçŽ°é¿å…å‚æ•°ä¼ é€’çš„è®¿é—®æ–¹å¼ï¼Œä½†æ˜¯è¦æ³¨æ„get()åˆ°çš„æ˜¯é‚£åŒä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œå¹¶å‘è®¿é—®é—®é¢˜è¦é å…¶ä»–æ‰‹æ®µæ¥è§£å†³ã€‚ä½†ä¸€èˆ¬æ¥è¯´çº¿ç¨‹å…±äº«çš„å¯¹è±¡é€šè¿‡è®¾ç½®ä¸ºæŸç±»çš„é™æ€å˜é‡å°±å¯ä»¥å®žçŽ°æ–¹ä¾¿çš„è®¿é—®äº†ï¼Œä¼¼ä¹Žæ²¡å¿…è¦æ”¾åˆ°çº¿ç¨‹ä¸­ã€‚ ThreadLocalçš„åº”ç”¨åœºåˆï¼Œæˆ‘è§‰å¾—æœ€é€‚åˆçš„æ˜¯æŒ‰çº¿ç¨‹å¤šå®žä¾‹ï¼ˆæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªå®žä¾‹ï¼‰çš„å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡å¾ˆå¤šåœ°æ–¹éƒ½è¦ç”¨åˆ°ã€‚ ä¸‹é¢æ¥çœ‹çœ‹ThreadLocalçš„å®žçŽ°åŽŸç†ï¼ˆjdk1.5æºç ï¼‰123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124public class ThreadLocal&lt;T&gt; &#123; /** * ThreadLocals rely on per-thread hash maps attached to each thread * (Thread.threadLocals and inheritableThreadLocals). The ThreadLocal * objects act as keys, searched via threadLocalHashCode. This is a * custom hash code (useful only within ThreadLocalMaps) that eliminates * collisions in the common case where consecutively constructed * ThreadLocals are used by the same threads, while remaining well-behaved * in less common cases. */ private final int threadLocalHashCode = nextHashCode(); /** * The next hash code to be given out. Accessed only by like-named method. */ private static int nextHashCode = 0; /** * The difference between successively generated hash codes - turns * implicit sequential thread-local IDs into near-optimally spread * multiplicative hash values for power-of-two-sized tables. */ private static final int HASH_INCREMENT = 0x61c88647; /** * Compute the next hash code. The static synchronization used here * should not be a performance bottleneck. When ThreadLocals are * generated in different threads at a fast enough rate to regularly * contend on this lock, memory contention is by far a more serious * problem than lock contention. */ private static synchronized int nextHashCode() &#123; int h = nextHashCode; nextHashCode = h + HASH_INCREMENT; return h; &#125; /** * Creates a thread local variable. */ public ThreadLocal() &#123; &#125; /** * Returns the value in the current thread's copy of this thread-local * variable. Creates and initializes the copy if this is the first time * the thread has called this method. * * @return the current thread's value of this thread-local */ public T get() &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) return (T)map.get(this); // Maps are constructed lazily. if the map for this thread // doesn't exist, create it, with this ThreadLocal and its // initial value as its only entry. T value = initialValue(); createMap(t, value); return value; &#125; /** * Sets the current thread's copy of this thread-local variable * to the specified value. Many applications will have no need for * this functionality, relying solely on the &#123;@link #initialValue&#125; * method to set the values of thread-locals. * * @param value the value to be stored in the current threads' copy of * this thread-local. */ public void set(T value) &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value); &#125; /** * Get the map associated with a ThreadLocal. Overridden in * InheritableThreadLocal. * * @param t the current thread * @return the map */ ThreadLocalMap getMap(Thread t) &#123; return t.threadLocals; &#125; /** * Create the map associated with a ThreadLocal. Overridden in * InheritableThreadLocal. * * @param t the current thread * @param firstValue value for the initial entry of the map * @param map the map to store. */ void createMap(Thread t, T firstValue) &#123; t.threadLocals = new ThreadLocalMap(this, firstValue); &#125; ....... /** * ThreadLocalMap is a customized hash map suitable only for * maintaining thread local values. No operations are exported * outside of the ThreadLocal class. The class is package private to * allow declaration of fields in class Thread. To help deal with * very large and long-lived usages, the hash table entries use * WeakReferences for keys. However, since reference queues are not * used, stale entries are guaranteed to be removed only when * the table starts running out of space. */ static class ThreadLocalMap &#123; ........ &#125;&#125; å¯ä»¥çœ‹åˆ°ThreadLocalç±»ä¸­çš„å˜é‡åªæœ‰è¿™3ä¸ªintåž‹ï¼š 123private final int threadLocalHashCode = nextHashCode(); private static int nextHashCode = 0; private static final int HASH_INCREMENT = 0x61c88647; è€Œä½œä¸ºThreadLocalå®žä¾‹çš„å˜é‡åªæœ‰ threadLocalHashCode è¿™ä¸€ä¸ªï¼ŒnextHashCode å’ŒHASH_INCREMENT æ˜¯ThreadLocalç±»çš„é™æ€å˜é‡ï¼Œå®žé™…ä¸ŠHASH_INCREMENTæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤ºäº†è¿žç»­åˆ†é…çš„ä¸¤ä¸ªThreadLocalå®žä¾‹çš„threadLocalHashCodeå€¼çš„å¢žé‡ï¼Œè€ŒnextHashCode çš„è¡¨ç¤ºäº†å³å°†åˆ†é…çš„ä¸‹ä¸€ä¸ªThreadLocalå®žä¾‹çš„threadLocalHashCode çš„å€¼ã€‚ å¯ä»¥æ¥çœ‹ä¸€ä¸‹åˆ›å»ºä¸€ä¸ªThreadLocalå®žä¾‹å³new ThreadLocal()æ—¶åšäº†å“ªäº›æ“ä½œï¼Œä»Žä¸Šé¢çœ‹åˆ°æž„é€ å‡½æ•°ThreadLocal()é‡Œä»€ä¹ˆæ“ä½œéƒ½æ²¡æœ‰ï¼Œå”¯ä¸€çš„æ“ä½œæ˜¯è¿™å¥ï¼š 1private final int threadLocalHashCode = nextHashCode(); é‚£ä¹ˆnextHashCode()åšäº†ä»€ä¹ˆå‘¢ï¼š 12345private static synchronized int nextHashCode() &#123; int h = nextHashCode; nextHashCode = h + HASH_INCREMENT; return h; &#125; å°±æ˜¯å°†ThreadLocalç±»çš„ä¸‹ä¸€ä¸ªhashCodeå€¼å³nextHashCodeçš„å€¼èµ‹ç»™å®žä¾‹çš„threadLocalHashCodeï¼Œç„¶åŽnextHashCodeçš„å€¼å¢žåŠ HASH_INCREMENTè¿™ä¸ªå€¼ã€‚ å› æ­¤ThreadLocalå®žä¾‹çš„å˜é‡åªæœ‰è¿™ä¸ªthreadLocalHashCodeï¼Œè€Œä¸”æ˜¯finalçš„ï¼Œç”¨æ¥åŒºåˆ†ä¸åŒçš„ThreadLocalå®žä¾‹ï¼ŒThreadLocalç±»ä¸»è¦æ˜¯ä½œä¸ºå·¥å…·ç±»æ¥ä½¿ç”¨ï¼Œé‚£ä¹ˆThreadLocal.set()è¿›åŽ»çš„å¯¹è±¡æ˜¯æ”¾åœ¨å“ªå„¿çš„å‘¢ï¼Ÿ çœ‹ä¸€ä¸‹ä¸Šé¢çš„set()æ–¹æ³•ï¼Œä¸¤å¥åˆå¹¶ä¸€ä¸‹æˆä¸º 1ThreadLocalMap map = Thread.currentThread().threadLocals; è¿™ä¸ªThreadLocalMap ç±»æ˜¯ThreadLocalä¸­å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œä½†æ˜¯å®ƒçš„å®žä¾‹å´ç”¨åœ¨Threadç±»ä¸­ï¼š 12345678public class Thread implements Runnable &#123; ...... /* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ ThreadLocal.ThreadLocalMap threadLocals = null; ......&#125; å†çœ‹è¿™å¥ï¼š12if (map != null) map.set(this, value); ä¹Ÿå°±æ˜¯å°†è¯¥ThreadLocalå®žä¾‹ä½œä¸ºkeyï¼Œè¦ä¿æŒçš„å¯¹è±¡ä½œä¸ºå€¼ï¼Œè®¾ç½®åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMap ä¸­ï¼Œget()æ–¹æ³•åŒæ ·å¤§å®¶çœ‹äº†ä»£ç ä¹Ÿå°±æ˜Žç™½äº†ï¼ŒThreadLocalMap ç±»çš„ä»£ç å¤ªå¤šäº†ï¼Œæˆ‘å°±ä¸å¸–äº†ï¼Œè‡ªå·±åŽ»çœ‹æºç å§ã€‚ è´´ä¸ªä¾‹å­å§ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465public class Student &#123; private int age = 0; //å¹´é¾„ public int getAge() &#123; return this.age; &#125; public void setAge(int age) &#123; this.age = age; &#125;&#125; public class ThreadLocalDemo implements Runnable &#123; //åˆ›å»ºçº¿ç¨‹å±€éƒ¨å˜é‡studentLocalï¼Œåœ¨åŽé¢ä½ ä¼šå‘çŽ°ç”¨æ¥ä¿å­˜Studentå¯¹è±¡ private final static ThreadLocal studentLocal = new ThreadLocal(); public static void main(String[] agrs) &#123; ThreadLocalDemo td = new ThreadLocalDemo(); Thread t1 = new Thread(td, "a"); Thread t2 = new Thread(td, "b"); t1.start(); t2.start(); &#125; public void run() &#123; accessStudent(); &#125; /** * ç¤ºä¾‹ä¸šåŠ¡æ–¹æ³•ï¼Œç”¨æ¥æµ‹è¯• */ public void accessStudent() &#123; //èŽ·å–å½“å‰çº¿ç¨‹çš„åå­— String currentThreadName = Thread.currentThread().getName(); System.out.println(currentThreadName + " is running!"); //äº§ç”Ÿä¸€ä¸ªéšæœºæ•°å¹¶æ‰“å° Random random = new Random(); int age = random.nextInt(100); System.out.println("thread " + currentThreadName + " set age to:" + age); //èŽ·å–ä¸€ä¸ªStudentå¯¹è±¡ï¼Œå¹¶å°†éšæœºæ•°å¹´é¾„æ’å…¥åˆ°å¯¹è±¡å±žæ€§ä¸­ Student student = getStudent(); student.setAge(age); System.out.println("thread " + currentThreadName + " first read age is:" + student.getAge()); try &#123; Thread.sleep(500); &#125; catch (InterruptedException ex) &#123; ex.printStackTrace(); &#125; System.out.println("thread " + currentThreadName + " second read age is:" + student.getAge()); &#125; protected Student getStudent() &#123; //èŽ·å–æœ¬åœ°çº¿ç¨‹å˜é‡å¹¶å¼ºåˆ¶è½¬æ¢ä¸ºStudentç±»åž‹ Student student = (Student) studentLocal.get(); //çº¿ç¨‹é¦–æ¬¡æ‰§è¡Œæ­¤æ–¹æ³•çš„æ—¶å€™ï¼ŒstudentLocal.get()è‚¯å®šä¸ºnull if (student == null) &#123; //åˆ›å»ºä¸€ä¸ªStudentå¯¹è±¡ï¼Œå¹¶ä¿å­˜åˆ°æœ¬åœ°çº¿ç¨‹å˜é‡studentLocalä¸­ student = new Student(); studentLocal.set(student); &#125; return student; &#125;&#125; ç»“æžœï¼š12345678a is running! thread a set age to:76 b is running! thread b set age to:27 thread a first read age is:76 thread b first read age is:27 thread a second read age is:76 thread b second read age is:27 åŽŸæ–‡åœ°å€ï¼šhttp://www.iteye.com/topic/103804]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>threadlocal</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[vi/vim ç¼–è¾‘å™¨å‘½ä»¤]]></title>
    <url>%2F2014%2F01%2F03%2Flinux-vi%2F</url>
    <content type="text"><![CDATA[vi/vim ç”¨æ³•ç¬”è®°ã€‚ æŒ‰ i è¿›å…¥ç¼–è¾‘æ¨¡å¼ ï¼ˆä¸€å¼€å§‹æ˜¯å‘½ä»¤æ¨¡å¼çš„ï¼‰ æŒ‰ esc è¿›å…¥å‘½ä»¤æ¨¡å¼ åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥:wq ä¿å­˜ ï¼ˆwrite and quitï¼‰ åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥:q é€€å‡º åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥:q! å¼ºåˆ¶é€€å‡º (ä¸ä¿å­˜) åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥/åŽæŽ¥å…³é”®å­—æœç´¢ï¼Œnä¸‹ä¸€ä¸ªåŒ¹é…ï¼ŒNä¸Šä¸€ä¸ªåŒ¹é… åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥gg å›žåˆ°é¡¶éƒ¨ï¼ŒGGåˆ°åº•éƒ¨ åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥dd åˆ é™¤å½“å‰è¡Œ åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥x åˆ é™¤åŽä¸€ä¸ªå­—ç¬¦ï¼ŒXåˆ é™¤å‰ä¸€ä¸ªå­—ç¬¦ åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥u undoæœ€åŽä¸€æ¬¡ä¿®æ”¹ åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥yy å¤åˆ¶å½“å‰è¡Œ åœ¨å‘½ä»¤æ¨¡å¼ä¸­è¾“å…¥p ç²˜è´´åˆ°å…‰æ ‡åŽé¢ï¼ŒPç²˜è´´åˆ°å…‰æ ‡å‰é¢ æœªå®Œå¾…ç»­â€¦]]></content>
      <categories>
        <category>linuxå‘½ä»¤</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>vi</tag>
        <tag>vim</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Hello World]]></title>
    <url>%2F2014%2F01%2F01%2Fhello-world%2F</url>
    <content type="text"><![CDATA[Welcome to my blog, This is my first post.so hello world]]></content>
      <categories>
        <category>life</category>
      </categories>
      <tags>
        <tag>hello</tag>
        <tag>world</tag>
      </tags>
  </entry>
</search>
