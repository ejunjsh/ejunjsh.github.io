<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="java,æ•°æ®ç»“æ„,conccurenthashmap," />





  <link rel="alternate" href="/atom.xml" title="IdiotSky" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢  jdk6å’Œjdk7ä¸­çš„å®ç°è®¾è®¡æ€è·¯ConcurrentHashMapé‡‡ç”¨äº†åˆ†æ®µé”çš„è®¾è®¡ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†æ®µå†…æ‰å­˜åœ¨ç«æ€å…³ç³»ï¼Œä¸åŒçš„åˆ†æ®µé”ä¹‹é—´æ²¡æœ‰é”ç«äº‰ã€‚ç›¸æ¯”äºå¯¹æ•´ä¸ªMapåŠ é”çš„è®¾è®¡ï¼Œåˆ†æ®µé”å¤§å¤§çš„æé«˜äº†é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å¤„ç†èƒ½åŠ›ã€‚ä½†åŒæ—¶ï¼Œç”±äºä¸æ˜¯å¯¹æ•´ä¸ªMapåŠ é”ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦æ‰«ææ•´ä¸ªMapçš„æ–¹æ³•ï¼ˆå¦‚size(), containsValue">
<meta name="keywords" content="java,æ•°æ®ç»“æ„,conccurenthashmap">
<meta property="og:type" content="article">
<meta property="og:title" content="java ConcurrentHashMapè§£æ">
<meta property="og:url" content="http://idiotsky.top/2018/07/28/java-concurrenthashmap/index.html">
<meta property="og:site_name" content="IdiotSky">
<meta property="og:description" content="åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢  jdk6å’Œjdk7ä¸­çš„å®ç°è®¾è®¡æ€è·¯ConcurrentHashMapé‡‡ç”¨äº†åˆ†æ®µé”çš„è®¾è®¡ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†æ®µå†…æ‰å­˜åœ¨ç«æ€å…³ç³»ï¼Œä¸åŒçš„åˆ†æ®µé”ä¹‹é—´æ²¡æœ‰é”ç«äº‰ã€‚ç›¸æ¯”äºå¯¹æ•´ä¸ªMapåŠ é”çš„è®¾è®¡ï¼Œåˆ†æ®µé”å¤§å¤§çš„æé«˜äº†é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å¤„ç†èƒ½åŠ›ã€‚ä½†åŒæ—¶ï¼Œç”±äºä¸æ˜¯å¯¹æ•´ä¸ªMapåŠ é”ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦æ‰«ææ•´ä¸ªMapçš„æ–¹æ³•ï¼ˆå¦‚size(), containsValue">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg">
<meta property="og:updated_time" content="2018-09-13T12:06:17.276Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java ConcurrentHashMapè§£æ">
<meta name="twitter:description" content="åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢  jdk6å’Œjdk7ä¸­çš„å®ç°è®¾è®¡æ€è·¯ConcurrentHashMapé‡‡ç”¨äº†åˆ†æ®µé”çš„è®¾è®¡ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†æ®µå†…æ‰å­˜åœ¨ç«æ€å…³ç³»ï¼Œä¸åŒçš„åˆ†æ®µé”ä¹‹é—´æ²¡æœ‰é”ç«äº‰ã€‚ç›¸æ¯”äºå¯¹æ•´ä¸ªMapåŠ é”çš„è®¾è®¡ï¼Œåˆ†æ®µé”å¤§å¤§çš„æé«˜äº†é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å¤„ç†èƒ½åŠ›ã€‚ä½†åŒæ—¶ï¼Œç”±äºä¸æ˜¯å¯¹æ•´ä¸ªMapåŠ é”ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦æ‰«ææ•´ä¸ªMapçš„æ–¹æ³•ï¼ˆå¦‚size(), containsValue">
<meta name="twitter:image" content="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '4C652JRMON',
      apiKey: 'ef468e206fb85903f33c4fc8b4bb2cd6',
      indexName: 'myblog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://idiotsky.top/2018/07/28/java-concurrenthashmap/"/>





  <title>java ConcurrentHashMapè§£æ | IdiotSky</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c2da852ee703ae71196b173fd6edef51";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IdiotSky</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            Books
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://idiotsky.top/2018/07/28/java-concurrenthashmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ejunjsh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars7.githubusercontent.com/u/22493186?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IdiotSky">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">java ConcurrentHashMapè§£æ</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-28T15:31:20+08:00">
                28 Jul 18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢</p>
</blockquote>
<h1 id="jdk6å’Œjdk7ä¸­çš„å®ç°"><a href="#jdk6å’Œjdk7ä¸­çš„å®ç°" class="headerlink" title="jdk6å’Œjdk7ä¸­çš„å®ç°"></a>jdk6å’Œjdk7ä¸­çš„å®ç°</h1><h2 id="è®¾è®¡æ€è·¯"><a href="#è®¾è®¡æ€è·¯" class="headerlink" title="è®¾è®¡æ€è·¯"></a>è®¾è®¡æ€è·¯</h2><p>ConcurrentHashMapé‡‡ç”¨äº†åˆ†æ®µé”çš„è®¾è®¡ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåˆ†æ®µå†…æ‰å­˜åœ¨ç«æ€å…³ç³»ï¼Œä¸åŒçš„åˆ†æ®µé”ä¹‹é—´æ²¡æœ‰é”ç«äº‰ã€‚ç›¸æ¯”äºå¯¹æ•´ä¸ªMapåŠ é”çš„è®¾è®¡ï¼Œåˆ†æ®µé”å¤§å¤§çš„æé«˜äº†é«˜å¹¶å‘ç¯å¢ƒä¸‹çš„å¤„ç†èƒ½åŠ›ã€‚ä½†åŒæ—¶ï¼Œç”±äºä¸æ˜¯å¯¹æ•´ä¸ªMapåŠ é”ï¼Œå¯¼è‡´ä¸€äº›éœ€è¦æ‰«ææ•´ä¸ªMapçš„æ–¹æ³•ï¼ˆå¦‚size(), containsValue()ï¼‰éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„å®ç°ï¼Œå¦å¤–ä¸€äº›æ–¹æ³•ï¼ˆå¦‚clear()ï¼‰ç”šè‡³æ”¾å¼ƒäº†å¯¹ä¸€è‡´æ€§çš„è¦æ±‚ï¼ˆConcurrentHashMapæ˜¯å¼±ä¸€è‡´æ€§çš„ï¼‰ã€‚</p>
<p>ConcurrentHashMapä¸­çš„åˆ†æ®µé”ç§°ä¸ºSegmentï¼Œå®ƒå³ç±»ä¼¼äºHashMapçš„ç»“æ„ï¼Œå³å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªEntryæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åˆæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼›åŒæ—¶åˆæ˜¯ä¸€ä¸ªReentrantLockï¼ˆSegmentç»§æ‰¿äº†ReentrantLockï¼‰ã€‚ConcurrentHashMapä¸­çš„HashEntryç›¸å¯¹äºHashMapä¸­çš„Entryæœ‰ä¸€å®šçš„å·®å¼‚æ€§ï¼šHashEntryä¸­çš„valueä»¥åŠnextéƒ½è¢«volatileä¿®é¥°ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹è¯»å†™è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒå®ƒä»¬çš„å¯è§æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HashEntry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        <span class="keyword">volatile</span> V value;</span><br><span class="line">        <span class="keyword">volatile</span> HashEntry&lt;K,V&gt; next;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="å¹¶å‘åº¦ï¼ˆConcurrency-Levelï¼‰"><a href="#å¹¶å‘åº¦ï¼ˆConcurrency-Levelï¼‰" class="headerlink" title="å¹¶å‘åº¦ï¼ˆConcurrency Levelï¼‰"></a>å¹¶å‘åº¦ï¼ˆConcurrency Levelï¼‰</h2><p>å¹¶å‘åº¦å¯ä»¥ç†è§£ä¸ºç¨‹åºè¿è¡Œæ—¶èƒ½å¤ŸåŒæ—¶æ›´æ–°ConccurentHashMapä¸”ä¸äº§ç”Ÿé”ç«äº‰çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯ConcurrentHashMapä¸­çš„åˆ†æ®µé”ä¸ªæ•°ï¼Œå³Segment[]çš„æ•°ç»„é•¿åº¦ã€‚ConcurrentHashMapé»˜è®¤çš„å¹¶å‘åº¦ä¸º16ï¼Œä½†ç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½®å¹¶å‘åº¦ã€‚å½“ç”¨æˆ·è®¾ç½®å¹¶å‘åº¦æ—¶ï¼ŒConcurrentHashMapä¼šä½¿ç”¨å¤§äºç­‰äºè¯¥å€¼çš„æœ€å°2å¹‚æŒ‡æ•°ä½œä¸ºå®é™…å¹¶å‘åº¦ï¼ˆå‡å¦‚ç”¨æˆ·è®¾ç½®å¹¶å‘åº¦ä¸º17ï¼Œå®é™…å¹¶å‘åº¦åˆ™ä¸º32ï¼‰ã€‚è¿è¡Œæ—¶é€šè¿‡å°†keyçš„é«˜nä½ï¼ˆ<code>n = 32 â€“ segmentShift</code>ï¼‰å’Œå¹¶å‘åº¦å‡1ï¼ˆsegmentMaskï¼‰åšä½ä¸è¿ç®—å®šä½åˆ°æ‰€åœ¨çš„Segmentã€‚segmentShiftä¸segmentMaskéƒ½æ˜¯åœ¨æ„é€ è¿‡ç¨‹ä¸­æ ¹æ®concurrency levelè¢«ç›¸åº”çš„è®¡ç®—å‡ºæ¥ã€‚</p>
<p>å¦‚æœå¹¶å‘åº¦è®¾ç½®çš„è¿‡å°ï¼Œä¼šå¸¦æ¥ä¸¥é‡çš„é”ç«äº‰é—®é¢˜ï¼›å¦‚æœå¹¶å‘åº¦è®¾ç½®çš„è¿‡å¤§ï¼ŒåŸæœ¬ä½äºåŒä¸€ä¸ªSegmentå†…çš„è®¿é—®ä¼šæ‰©æ•£åˆ°ä¸åŒçš„Segmentä¸­ï¼ŒCPU cacheå‘½ä¸­ç‡ä¼šä¸‹é™ï¼Œä»è€Œå¼•èµ·ç¨‹åºæ€§èƒ½ä¸‹é™ã€‚ï¼ˆæ–‡æ¡£çš„è¯´æ³•æ˜¯æ ¹æ®ä½ å¹¶å‘çš„çº¿ç¨‹æ•°é‡å†³å®šï¼Œå¤ªå¤šä¼šå¯¼æ€§èƒ½é™ä½ï¼‰</p>
<h2 id="åˆ›å»ºåˆ†æ®µé”"><a href="#åˆ›å»ºåˆ†æ®µé”" class="headerlink" title="åˆ›å»ºåˆ†æ®µé”"></a>åˆ›å»ºåˆ†æ®µé”</h2><p>å’ŒJDK6ä¸åŒï¼ŒJDK7ä¸­é™¤äº†ç¬¬ä¸€ä¸ªSegmentä¹‹å¤–ï¼Œå‰©ä½™çš„Segmentsé‡‡ç”¨çš„æ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„æœºåˆ¶ï¼šæ¯æ¬¡putä¹‹å‰éƒ½éœ€è¦æ£€æŸ¥keyå¯¹åº”çš„Segmentæ˜¯å¦ä¸ºnullï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ensureSegment()ä»¥ç¡®ä¿å¯¹åº”çš„Segmentè¢«åˆ›å»ºã€‚</p>
<p>ensureSegmentå¯èƒ½åœ¨å¹¶å‘ç¯å¢ƒä¸‹è¢«è°ƒç”¨ï¼Œä½†ä¸æƒ³è±¡ä¸­ä¸åŒï¼ŒensureSegmentå¹¶æœªä½¿ç”¨é”æ¥æ§åˆ¶ç«äº‰ï¼Œè€Œæ˜¯ä½¿ç”¨äº†Unsafeå¯¹è±¡çš„getObjectVolatile()æä¾›çš„åŸå­è¯»è¯­ä¹‰ç»“åˆCASæ¥ç¡®ä¿Segmentåˆ›å»ºçš„åŸå­æ€§ã€‚ä»£ç æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                == <span class="keyword">null</span>) &#123; <span class="comment">// recheck</span></span><br><span class="line">                Segment&lt;K,V&gt; s = <span class="keyword">new</span> Segment&lt;K,V&gt;(lf, threshold, tab);</span><br><span class="line">                <span class="keyword">while</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                       == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(ss, u, <span class="keyword">null</span>, seg = s))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="put-putIfAbsent-putAll"><a href="#put-putIfAbsent-putAll" class="headerlink" title="put/putIfAbsent/putAll"></a>put/putIfAbsent/putAll</h2><p>å’ŒJDK6ä¸€æ ·ï¼ŒConcurrentHashMapçš„putæ–¹æ³•è¢«ä»£ç†åˆ°äº†å¯¹åº”çš„Segmentï¼ˆå®šä½Segmentçš„åŸç†ä¹‹å‰å·²ç»æè¿°è¿‡ï¼‰ä¸­ã€‚ä¸JDK6ä¸åŒçš„æ˜¯ï¼ŒJDK7ç‰ˆæœ¬çš„ConcurrentHashMapåœ¨è·å¾—Segmenté”çš„è¿‡ç¨‹ä¸­ï¼Œåšäº†ä¸€å®šçš„ä¼˜åŒ– - åœ¨çœŸæ­£ç”³è¯·é”ä¹‹å‰ï¼Œputæ–¹æ³•ä¼šé€šè¿‡tryLock()æ–¹æ³•å°è¯•è·å¾—é”ï¼Œåœ¨å°è¯•è·å¾—é”çš„è¿‡ç¨‹ä¸­ä¼šå¯¹å¯¹åº”hashcodeçš„é“¾è¡¨è¿›è¡Œéå†ï¼Œå¦‚æœéå†å®Œæ¯•ä»ç„¶æ‰¾ä¸åˆ°ä¸keyç›¸åŒçš„HashEntryèŠ‚ç‚¹ï¼Œåˆ™ä¸ºåç»­çš„putæ“ä½œæå‰åˆ›å»ºä¸€ä¸ªHashEntryã€‚å½“tryLockä¸€å®šæ¬¡æ•°åä»æ— æ³•è·å¾—é”ï¼Œåˆ™é€šè¿‡lockç”³è¯·é”ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºåœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œå…¶ä»–çº¿ç¨‹çš„putï¼Œrehashæˆ–è€…removeæ“ä½œå¯èƒ½ä¼šå¯¼è‡´é“¾è¡¨å¤´ç»“ç‚¹çš„å˜åŒ–ï¼Œå› æ­¤åœ¨è¿‡ç¨‹ä¸­éœ€è¦è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå¤´ç»“ç‚¹å‘ç”Ÿå˜åŒ–åˆ™é‡æ–°å¯¹è¡¨è¿›è¡Œéå†ã€‚è€Œå¦‚æœå…¶ä»–çº¿ç¨‹å¼•èµ·äº†é“¾è¡¨ä¸­çš„æŸä¸ªèŠ‚ç‚¹è¢«åˆ é™¤ï¼Œå³ä½¿è¯¥å˜åŒ–å› ä¸ºæ˜¯éåŸå­å†™æ“ä½œï¼ˆåˆ é™¤èŠ‚ç‚¹åé“¾æ¥åç»­èŠ‚ç‚¹è°ƒç”¨çš„æ˜¯Unsafe.putOrderedObject()ï¼Œè¯¥æ–¹æ³•ä¸æä¾›åŸå­å†™è¯­ä¹‰ï¼‰å¯èƒ½å¯¼è‡´å½“å‰çº¿ç¨‹æ— æ³•è§‚å¯Ÿåˆ°ï¼Œä½†å› ä¸ºä¸å½±å“éå†çš„æ­£ç¡®æ€§æ‰€ä»¥å¿½ç•¥ä¸è®¡ã€‚</p>
<p>ä¹‹æ‰€ä»¥åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­å¯¹æ•´ä¸ªé“¾è¡¨è¿›è¡Œéå†ï¼Œä¸»è¦ç›®çš„æ˜¯å¸Œæœ›éå†çš„é“¾è¡¨è¢«CPU cacheæ‰€ç¼“å­˜ï¼Œä¸ºåç»­å®é™…putè¿‡ç¨‹ä¸­çš„é“¾è¡¨éå†æ“ä½œæå‡æ€§èƒ½ã€‚</p>
<p>åœ¨è·å¾—é”ä¹‹åï¼ŒSegmentå¯¹é“¾è¡¨è¿›è¡Œéå†ï¼Œå¦‚æœæŸä¸ªHashEntryèŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„keyï¼Œåˆ™æ›´æ–°è¯¥HashEntryçš„valueå€¼ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ªHashEntryèŠ‚ç‚¹ï¼Œå°†å®ƒè®¾ç½®ä¸ºé“¾è¡¨çš„æ–°headèŠ‚ç‚¹å¹¶å°†åŸå¤´èŠ‚ç‚¹è®¾ä¸ºæ–°headçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚æ–°å»ºè¿‡ç¨‹ä¸­å¦‚æœèŠ‚ç‚¹æ€»æ•°ï¼ˆå«æ–°å»ºçš„HashEntryï¼‰è¶…è¿‡thresholdï¼Œåˆ™è°ƒç”¨rehash()æ–¹æ³•å¯¹Segmentè¿›è¡Œæ‰©å®¹ï¼Œæœ€åå°†æ–°å»ºHashEntryå†™å…¥åˆ°æ•°ç»„ä¸­ã€‚</p>
<p>putæ–¹æ³•ä¸­ï¼Œé“¾æ¥æ–°èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆHashEntry.setNext()ï¼‰ä»¥åŠå°†é“¾è¡¨å†™å…¥åˆ°æ•°ç»„ä¸­ï¼ˆsetEntryAt()ï¼‰éƒ½æ˜¯é€šè¿‡Unsafeçš„putOrderedObject()æ–¹æ³•æ¥å®ç°ï¼Œè¿™é‡Œå¹¶æœªä½¿ç”¨å…·æœ‰åŸå­å†™è¯­ä¹‰çš„putObjectVolatile()çš„åŸå› æ˜¯ï¼šJMMä¼šä¿è¯è·å¾—é”åˆ°é‡Šæ”¾é”ä¹‹é—´æ‰€æœ‰å¯¹è±¡çš„çŠ¶æ€æ›´æ–°éƒ½ä¼šåœ¨é”è¢«é‡Šæ”¾ä¹‹åæ›´æ–°åˆ°ä¸»å­˜ï¼Œä»è€Œä¿è¯è¿™äº›å˜æ›´å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚</p>
<h2 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h2><p>ç›¸å¯¹äºHashMapçš„resizeï¼ŒConcurrentHashMapçš„rehashåŸç†ç±»ä¼¼ï¼Œä½†æ˜¯Doug Leaä¸ºrehashåšäº†ä¸€å®šçš„ä¼˜åŒ–ï¼Œé¿å…è®©æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½è¿›è¡Œå¤åˆ¶æ“ä½œï¼šç”±äºæ‰©å®¹æ˜¯åŸºäº2çš„å¹‚æŒ‡æ¥æ“ä½œï¼Œå‡è®¾æ‰©å®¹å‰æŸHashEntryå¯¹åº”åˆ°Segmentä¸­æ•°ç»„çš„indexä¸ºiï¼Œæ•°ç»„çš„å®¹é‡ä¸ºcapacityï¼Œé‚£ä¹ˆæ‰©å®¹åè¯¥HashEntryå¯¹åº”åˆ°æ–°æ•°ç»„ä¸­çš„indexåªå¯èƒ½ä¸ºiæˆ–è€…i+capacityï¼Œå› æ­¤å¤§å¤šæ•°HashEntryèŠ‚ç‚¹åœ¨æ‰©å®¹å‰åindexå¯ä»¥ä¿æŒä¸å˜ã€‚åŸºäºæ­¤ï¼Œrehashæ–¹æ³•ä¸­ä¼šå®šä½ç¬¬ä¸€ä¸ªåç»­æ‰€æœ‰èŠ‚ç‚¹åœ¨æ‰©å®¹åindexéƒ½ä¿æŒä¸å˜çš„èŠ‚ç‚¹ï¼Œç„¶åå°†è¿™ä¸ªèŠ‚ç‚¹ä¹‹å‰çš„æ‰€æœ‰èŠ‚ç‚¹é‡æ’å³å¯ã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rehash</span><span class="params">(HashEntry&lt;K,V&gt; node)</span> </span>&#123;</span><br><span class="line">           HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">           <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">           <span class="keyword">int</span> newCapacity = oldCapacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">           threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor);</span><br><span class="line">           HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">               (HashEntry&lt;K,V&gt;[]) <span class="keyword">new</span> HashEntry[newCapacity];</span><br><span class="line">           <span class="keyword">int</span> sizeMask = newCapacity - <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">               HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">               <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">                   <span class="keyword">int</span> idx = e.hash &amp; sizeMask;</span><br><span class="line">                   <span class="keyword">if</span> (next == <span class="keyword">null</span>)   <span class="comment">//  Single node on list</span></span><br><span class="line">                       newTable[idx] = e;</span><br><span class="line">                   <span class="keyword">else</span> &#123; <span class="comment">// Reuse consecutive sequence at same slot</span></span><br><span class="line">                       HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                       <span class="keyword">int</span> lastIdx = idx;</span><br><span class="line">                       <span class="keyword">for</span> (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                            last != <span class="keyword">null</span>;</span><br><span class="line">                            last = last.next) &#123;</span><br><span class="line">                           <span class="keyword">int</span> k = last.hash &amp; sizeMask;</span><br><span class="line">                           <span class="keyword">if</span> (k != lastIdx) &#123;</span><br><span class="line">                               lastIdx = k;</span><br><span class="line">                               lastRun = last;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       newTable[lastIdx] = lastRun;</span><br><span class="line">                       <span class="comment">// Clone remaining nodes</span></span><br><span class="line">                       <span class="keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                           V v = p.value;</span><br><span class="line">                           <span class="keyword">int</span> h = p.hash;</span><br><span class="line">                           <span class="keyword">int</span> k = h &amp; sizeMask;</span><br><span class="line">                           HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                           newTable[k] = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">int</span> nodeIndex = node.hash &amp; sizeMask; <span class="comment">// add the new node</span></span><br><span class="line">           node.setNext(newTable[nodeIndex]);</span><br><span class="line">           newTable[nodeIndex] = node;</span><br><span class="line">           table = newTable;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><p>å’Œputç±»ä¼¼ï¼Œremoveåœ¨çœŸæ­£è·å¾—é”ä¹‹å‰ï¼Œä¹Ÿä¼šå¯¹é“¾è¡¨è¿›è¡Œéå†ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚</p>
<h2 id="getä¸containsKey"><a href="#getä¸containsKey" class="headerlink" title="getä¸containsKey"></a>getä¸containsKey</h2><p><code>get</code>ä¸<code>containsKey</code>ä¸¤ä¸ªæ–¹æ³•å‡ ä¹å®Œå…¨ä¸€è‡´ï¼šä»–ä»¬éƒ½æ²¡æœ‰ä½¿ç”¨é”ï¼Œè€Œæ˜¯é€šè¿‡Unsafeå¯¹è±¡çš„<code>getObjectVolatile()</code>æ–¹æ³•æä¾›çš„åŸå­è¯»è¯­ä¹‰ï¼Œæ¥è·å¾—Segmentä»¥åŠå¯¹åº”çš„é“¾è¡¨ï¼Œç„¶åå¯¹é“¾è¡¨éå†åˆ¤æ–­æ˜¯å¦å­˜åœ¨keyç›¸åŒçš„èŠ‚ç‚¹ä»¥åŠè·å¾—è¯¥èŠ‚ç‚¹çš„valueã€‚ä½†ç”±äºéå†è¿‡ç¨‹ä¸­å…¶ä»–çº¿ç¨‹å¯èƒ½å¯¹é“¾è¡¨ç»“æ„åšäº†è°ƒæ•´ï¼Œå› æ­¤<code>get</code>å’Œ<code>containsKey</code>è¿”å›çš„å¯èƒ½æ˜¯è¿‡æ—¶çš„æ•°æ®ï¼Œè¿™ä¸€ç‚¹æ˜¯ConcurrentHashMapåœ¨å¼±ä¸€è‡´æ€§ä¸Šçš„ä½“ç°ã€‚å¦‚æœè¦æ±‚å¼ºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆå¿…é¡»ä½¿ç”¨<code>Collections.synchronizedMap()</code>æ–¹æ³•ã€‚</p>
<h2 id="sizeã€containsValue"><a href="#sizeã€containsValue" class="headerlink" title="sizeã€containsValue"></a>sizeã€containsValue</h2><p>è¿™äº›æ–¹æ³•éƒ½æ˜¯åŸºäºæ•´ä¸ªConcurrentHashMapæ¥è¿›è¡Œæ“ä½œçš„ï¼Œä»–ä»¬çš„åŸç†ä¹ŸåŸºæœ¬ç±»ä¼¼ï¼šé¦–å…ˆä¸åŠ é”å¾ªç¯æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šå¾ªç¯æ‰€æœ‰çš„Segmentï¼ˆé€šè¿‡Unsafeçš„getObjectVolatile()ä»¥ä¿è¯åŸå­è¯»è¯­ä¹‰ï¼‰ï¼Œè·å¾—å¯¹åº”çš„å€¼ä»¥åŠæ‰€æœ‰Segmentçš„modcountä¹‹å’Œã€‚å¦‚æœè¿ç»­ä¸¤æ¬¡æ‰€æœ‰Segmentçš„modcountå’Œç›¸ç­‰ï¼Œåˆ™è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç”Ÿå…¶ä»–çº¿ç¨‹ä¿®æ”¹ConcurrentHashMapçš„æƒ…å†µï¼Œè¿”å›è·å¾—çš„å€¼ã€‚</p>
<p>å½“å¾ªç¯æ¬¡æ•°è¶…è¿‡é¢„å®šä¹‰çš„å€¼æ—¶ï¼Œè¿™æ—¶éœ€è¦å¯¹æ‰€æœ‰çš„Segmentä¾æ¬¡è¿›è¡ŒåŠ é”ï¼Œè·å–è¿”å›å€¼åå†ä¾æ¬¡è§£é”ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒåŠ é”è¿‡ç¨‹ä¸­è¦å¼ºåˆ¶åˆ›å»ºæ‰€æœ‰çš„Segmentï¼Œå¦åˆ™å®¹æ˜“å‡ºç°å…¶ä»–çº¿ç¨‹åˆ›å»ºSegmentå¹¶è¿›è¡Œputï¼Œremoveç­‰æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j =<span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line"></span><br><span class="line">ensureSegment(j).lock();<span class="comment">// force creation</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥é¿å…åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨sizeå’ŒcontainsValueæ–¹æ³•ã€‚</p>
<p>æ³¨1ï¼šmodcountåœ¨put, replace, removeä»¥åŠclearç­‰æ–¹æ³•ä¸­éƒ½ä¼šè¢«ä¿®æ”¹ã€‚</p>
<p>æ³¨2ï¼šå¯¹äºcontainsValueæ–¹æ³•æ¥è¯´ï¼Œå¦‚æœåœ¨å¾ªç¯è¿‡ç¨‹ä¸­å‘ç°åŒ¹é…valueçš„HashEntryï¼Œåˆ™ç›´æ¥è¿”å›trueã€‚</p>
<p>æœ€åï¼Œä¸HashMapä¸åŒçš„æ˜¯ï¼ŒConcurrentHashMapå¹¶ä¸å…è®¸keyæˆ–è€…valueä¸ºnullï¼ŒæŒ‰ç…§Doug Leaçš„è¯´æ³•ï¼Œè¿™ä¹ˆè®¾è®¡çš„åŸå› æ˜¯åœ¨ConcurrentHashMapä¸­ï¼Œä¸€æ—¦valueå‡ºç°nullï¼Œåˆ™ä»£è¡¨HashEntryçš„key/valueæ²¡æœ‰æ˜ å°„å®Œæˆå°±è¢«å…¶ä»–çº¿ç¨‹æ‰€è§ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚åœ¨JDK6ä¸­ï¼Œgetæ–¹æ³•çš„å®ç°ä¸­å°±æœ‰ä¸€æ®µå¯¹HashEntry.value == nullçš„é˜²å¾¡æ€§åˆ¤æ–­ã€‚ä½†Doug Leaä¹Ÿæ‰¿è®¤å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿™ç§æƒ…å†µä¼¼ä¹ä¸å¯èƒ½å‘ç”Ÿ</p>
<hr>
<h1 id="JDK8ä¸­çš„å®ç°"><a href="#JDK8ä¸­çš„å®ç°" class="headerlink" title="JDK8ä¸­çš„å®ç°"></a>JDK8ä¸­çš„å®ç°</h1><p>ConcurrentHashMapåœ¨JDK8ä¸­è¿›è¡Œäº†å·¨å¤§æ”¹åŠ¨ï¼Œå¾ˆéœ€è¦é€šè¿‡æºç æ¥å†æ¬¡å­¦ä¹ ä¸‹Doug Leaçš„å®ç°æ–¹æ³•ã€‚</p>
<p>å®ƒæ‘’å¼ƒäº†Segmentï¼ˆé”æ®µï¼‰çš„æ¦‚å¿µï¼Œè€Œæ˜¯å¯ç”¨äº†ä¸€ç§å…¨æ–°çš„æ–¹å¼å®ç°,åˆ©ç”¨CASç®—æ³•ã€‚å®ƒæ²¿ç”¨äº†ä¸å®ƒåŒæ—¶æœŸçš„HashMapç‰ˆæœ¬çš„æ€æƒ³ï¼Œåº•å±‚ä¾ç„¶ç”±â€œæ•°ç»„â€+é“¾è¡¨+çº¢é»‘æ ‘çš„æ–¹å¼æ€æƒ³ï¼Œä½†æ˜¯ä¸ºäº†åšåˆ°å¹¶å‘ï¼Œåˆå¢åŠ äº†å¾ˆå¤šè¾…åŠ©çš„ç±»ï¼Œä¾‹å¦‚TreeBinï¼ŒTraverserç­‰å¯¹è±¡å†…éƒ¨ç±»ã€‚</p>
<h2 id="é‡è¦çš„å±æ€§"><a href="#é‡è¦çš„å±æ€§" class="headerlink" title="é‡è¦çš„å±æ€§"></a>é‡è¦çš„å±æ€§</h2><p>é¦–å…ˆæ¥çœ‹å‡ ä¸ªé‡è¦çš„å±æ€§ï¼Œä¸HashMapç›¸åŒçš„å°±ä¸å†ä»‹ç»äº†ï¼Œè¿™é‡Œé‡ç‚¹è§£é‡Šä¸€ä¸‹sizeCtlè¿™ä¸ªå±æ€§ã€‚å¯ä»¥è¯´å®ƒæ˜¯ConcurrentHashMapä¸­å‡ºé•œç‡å¾ˆé«˜çš„ä¸€ä¸ªå±æ€§ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ§åˆ¶æ ‡è¯†ç¬¦ï¼Œåœ¨ä¸åŒçš„åœ°æ–¹æœ‰ä¸åŒç”¨é€”ï¼Œè€Œä¸”å®ƒçš„å–å€¼ä¸åŒï¼Œä¹Ÿä»£è¡¨ä¸åŒçš„å«ä¹‰ã€‚</p>
<ul>
<li>è´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹æ“ä½œ</li>
<li>-1ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–</li>
<li>-N è¡¨ç¤ºæœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</li>
<li>æ­£æ•°æˆ–0ä»£è¡¨hashè¡¨è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºåˆå§‹åŒ–æˆ–ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å°ï¼Œè¿™ä¸€ç‚¹ç±»ä¼¼äºæ‰©å®¹é˜ˆå€¼çš„æ¦‚å¿µã€‚è¿˜åé¢å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å€¼å§‹ç»ˆæ˜¯å½“å‰ConcurrentHashMapå®¹é‡çš„0.75å€ï¼Œè¿™ä¸loadfactoræ˜¯å¯¹åº”çš„ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç››è£…Nodeå…ƒç´ çš„æ•°ç»„ å®ƒçš„å¤§å°æ˜¯2çš„æ•´æ•°æ¬¡å¹‚</span></span><br><span class="line"><span class="comment">     * Size is always a power of two. Accessed directly by iterators.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table initialization and resizing control.  When negative, the</span></span><br><span class="line"><span class="comment">     * table is being initialized or resized: -1 for initialization,</span></span><br><span class="line"><span class="comment">     * else -(1 + the number of active resizing threads).  Otherwise,</span></span><br><span class="line"><span class="comment">     * when table is null, holds the initial table size to use upon</span></span><br><span class="line"><span class="comment">     * creation, or 0 for default. After initialization, holds the</span></span><br><span class="line"><span class="comment">     * next element count value upon which to resize the table.</span></span><br><span class="line"><span class="comment">     hashè¡¨åˆå§‹åŒ–æˆ–æ‰©å®¹æ—¶çš„ä¸€ä¸ªæ§åˆ¶ä½æ ‡è¯†é‡ã€‚</span></span><br><span class="line"><span class="comment">     è´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment">     -1ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     -N è¡¨ç¤ºæœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment">     æ­£æ•°æˆ–0ä»£è¡¨hashè¡¨è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ•°å€¼è¡¨ç¤ºåˆå§‹åŒ–æˆ–ä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„å¤§å°</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl; </span><br><span class="line">    <span class="comment">// ä»¥ä¸‹ä¸¤ä¸ªæ˜¯ç”¨æ¥æ§åˆ¶æ‰©å®¹çš„æ—¶å€™ å•çº¿ç¨‹è¿›å…¥çš„å˜é‡</span></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of bits used for generation stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     * Must be at least 6 for 32bit arrays.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> RESIZE_STAMP_BITS = <span class="number">16</span>;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The bit shift for recording size stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESIZE_STAMP_SHIFT = <span class="number">32</span> - RESIZE_STAMP_BITS;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Encodings for Node hash fields. See above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hashå€¼æ˜¯-1ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªforwardNodeèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hashå€¼æ˜¯-2  è¡¨ç¤ºè¿™æ—¶ä¸€ä¸ªTreeBinèŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>
<h2 id="é‡è¦çš„ç±»"><a href="#é‡è¦çš„ç±»" class="headerlink" title="é‡è¦çš„ç±»"></a>é‡è¦çš„ç±»</h2><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>Nodeæ˜¯æœ€æ ¸å¿ƒçš„å†…éƒ¨ç±»ï¼Œå®ƒåŒ…è£…äº†key-valueé”®å€¼å¯¹ï¼Œæ‰€æœ‰æ’å…¥ConcurrentHashMapçš„æ•°æ®éƒ½åŒ…è£…åœ¨è¿™é‡Œé¢ã€‚å®ƒä¸HashMapä¸­çš„å®šä¹‰å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯ä½†æ˜¯æœ‰ä¸€äº›å·®åˆ«å®ƒå¯¹valueå’Œnextå±æ€§è®¾ç½®äº†volatileåŒæ­¥é”(ä¸JDK7çš„Segmentç›¸åŒ)ï¼Œå®ƒä¸å…è®¸è°ƒç”¨setValueæ–¹æ³•ç›´æ¥æ”¹å˜Nodeçš„valueåŸŸï¼Œå®ƒå¢åŠ äº†findæ–¹æ³•è¾…åŠ©map.get()æ–¹æ³•ã€‚</p>
<h3 id="TreeNode"><a href="#TreeNode" class="headerlink" title="TreeNode"></a>TreeNode</h3><p>æ ‘èŠ‚ç‚¹ç±»ï¼Œå¦å¤–ä¸€ä¸ªæ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚å½“é“¾è¡¨é•¿åº¦è¿‡é•¿çš„æ—¶å€™ï¼Œä¼šè½¬æ¢ä¸ºTreeNodeã€‚ä½†æ˜¯ä¸HashMapä¸ç›¸åŒçš„æ˜¯ï¼Œå®ƒå¹¶ä¸æ˜¯ç›´æ¥è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œè€Œæ˜¯æŠŠè¿™äº›ç»“ç‚¹åŒ…è£…æˆTreeNodeæ”¾åœ¨TreeBinå¯¹è±¡ä¸­ï¼Œç”±TreeBinå®Œæˆå¯¹çº¢é»‘æ ‘çš„åŒ…è£…ã€‚è€Œä¸”TreeNodeåœ¨ConcurrentHashMapé›†æˆè‡ªNodeç±»ï¼Œè€Œå¹¶éHashMapä¸­çš„é›†æˆè‡ªLinkedHashMap.Entry&lt;K,V&gt;ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´TreeNodeå¸¦æœ‰nextæŒ‡é’ˆï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯æ–¹ä¾¿åŸºäºTreeBinçš„è®¿é—®ã€‚</p>
<h3 id="TreeBin"><a href="#TreeBin" class="headerlink" title="TreeBin"></a>TreeBin</h3><p>è¿™ä¸ªç±»å¹¶ä¸è´Ÿè´£åŒ…è£…ç”¨æˆ·çš„keyã€valueä¿¡æ¯ï¼Œè€Œæ˜¯åŒ…è£…çš„å¾ˆå¤šTreeNodeèŠ‚ç‚¹ã€‚å®ƒä»£æ›¿äº†TreeNodeçš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å®é™…çš„ConcurrentHashMapâ€œæ•°ç»„â€ä¸­ï¼Œå­˜æ”¾çš„æ˜¯TreeBinå¯¹è±¡ï¼Œè€Œä¸æ˜¯TreeNodeå¯¹è±¡ï¼Œè¿™æ˜¯ä¸HashMapçš„åŒºåˆ«ã€‚å¦å¤–è¿™ä¸ªç±»è¿˜å¸¦æœ‰äº†è¯»å†™é”ã€‚</p>
<p>è¿™é‡Œä»…è´´å‡ºå®ƒçš„æ„é€ æ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°åœ¨æ„é€ TreeBinèŠ‚ç‚¹æ—¶ï¼Œä»…ä»…æŒ‡å®šäº†å®ƒçš„hashå€¼ä¸ºTREEBINå¸¸é‡ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ªæ ‡è¯†ä¸ºã€‚åŒæ—¶ä¹Ÿçœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„çº¢é»‘æ ‘æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates bin with initial set of nodes headed by b.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TreeBin(TreeNode&lt;K,V&gt; b) &#123;</span><br><span class="line">            <span class="keyword">super</span>(TREEBIN, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.first = b;</span><br><span class="line">            TreeNode&lt;K,V&gt; r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = b, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">                next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">                x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = <span class="keyword">null</span>;</span><br><span class="line">                    x.red = <span class="keyword">false</span>;</span><br><span class="line">                    r = x;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    K k = x.key;</span><br><span class="line">                    <span class="keyword">int</span> h = x.hash;</span><br><span class="line">                    Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = r;;) &#123;</span><br><span class="line">                        <span class="keyword">int</span> dir, ph;</span><br><span class="line">                        K pk = p.key;</span><br><span class="line">                        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                            dir = -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                            dir = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                  (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                                 (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                            dir = tieBreakOrder(k, pk);</span><br><span class="line">                            TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            x.parent = xp;</span><br><span class="line">                            <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                                xp.left = x;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                xp.right = x;</span><br><span class="line">                            r = balanceInsertion(r, x);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.root = r;</span><br><span class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ForwardingNode"><a href="#ForwardingNode" class="headerlink" title="ForwardingNode"></a>ForwardingNode</h3><p>ä¸€ä¸ªç”¨äºè¿æ¥ä¸¤ä¸ªtableçš„èŠ‚ç‚¹ç±»ã€‚å®ƒåŒ…å«ä¸€ä¸ªnextTableæŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘ä¸‹ä¸€å¼ è¡¨ã€‚è€Œä¸”è¿™ä¸ªèŠ‚ç‚¹çš„key value nextæŒ‡é’ˆå…¨éƒ¨ä¸ºnullï¼Œå®ƒçš„hashå€¼ä¸º-1. è¿™é‡Œé¢å®šä¹‰çš„findçš„æ–¹æ³•æ˜¯ä»nextTableé‡Œè¿›è¡ŒæŸ¥è¯¢èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯ä»¥è‡ªèº«ä¸ºå¤´èŠ‚ç‚¹è¿›è¡ŒæŸ¥æ‰¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A node inserted at head of bins during transfer operations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">        ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">            <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// loop to avoid arbitrarily deep recursion on forwarding nodes</span></span><br><span class="line">            outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;) &#123;</span><br><span class="line">                Node&lt;K,V&gt; e; <span class="keyword">int</span> n;</span><br><span class="line">                <span class="keyword">if</span> (k == <span class="keyword">null</span> || tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">                    (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    <span class="keyword">int</span> eh; K ek;</span><br><span class="line">                    <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp;</span><br><span class="line">                        ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                        <span class="keyword">return</span> e;</span><br><span class="line">                    <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                            tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                            <span class="keyword">continue</span> outer;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Unsafeä¸CAS"><a href="#Unsafeä¸CAS" class="headerlink" title="Unsafeä¸CAS"></a>Unsafeä¸CAS</h2><p>åœ¨ConcurrentHashMapä¸­ï¼Œéšå¤„å¯ä»¥çœ‹åˆ°<code>U</code>, å¤§é‡ä½¿ç”¨äº†<code>U.compareAndSwapXXX</code>çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åˆ©ç”¨ä¸€ä¸ªCASç®—æ³•å®ç°æ— é”åŒ–çš„ä¿®æ”¹å€¼çš„æ“ä½œï¼Œä»–å¯ä»¥å¤§å¤§é™ä½é”ä»£ç†çš„æ€§èƒ½æ¶ˆè€—ã€‚è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯ä¸æ–­åœ°å»æ¯”è¾ƒå½“å‰å†…å­˜ä¸­çš„å˜é‡å€¼ä¸ä½ æŒ‡å®šçš„ä¸€ä¸ªå˜é‡å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™æ¥å—ä½ æŒ‡å®šçš„ä¿®æ”¹çš„å€¼ï¼Œå¦åˆ™æ‹’ç»ä½ çš„æ“ä½œã€‚å› ä¸ºå½“å‰çº¿ç¨‹ä¸­çš„å€¼å·²ç»ä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œä½ çš„ä¿®æ”¹å¾ˆå¯èƒ½ä¼šè¦†ç›–æ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹çš„ç»“æœã€‚è¿™ä¸€ç‚¹ä¸ä¹è§‚é”ï¼ŒSVNçš„æ€æƒ³æ˜¯æ¯”è¾ƒç±»ä¼¼çš„ã€‚</p>
<h3 id="unsafeé™æ€å—"><a href="#unsafeé™æ€å—" class="headerlink" title="unsafeé™æ€å—"></a>unsafeé™æ€å—</h3><p>unsafeä»£ç å—æ§åˆ¶äº†ä¸€äº›å±æ€§çš„ä¿®æ”¹å·¥ä½œï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„SIZECTL ã€‚åœ¨è¿™ä¸€ç‰ˆæœ¬çš„concurrentHashMapä¸­ï¼Œå¤§é‡åº”ç”¨æ¥çš„CASæ–¹æ³•è¿›è¡Œå˜é‡ã€å±æ€§çš„ä¿®æ”¹å·¥ä½œã€‚åˆ©ç”¨CASè¿›è¡Œæ— é”æ“ä½œï¼Œå¯ä»¥å¤§å¤§æé«˜æ€§èƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SIZECTL;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TRANSFERINDEX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BASECOUNT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLSBUSY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLVALUE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ABASE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; k = ConcurrentHashMap.class;</span><br><span class="line">            SIZECTL = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"sizeCtl"</span>));</span><br><span class="line">            TRANSFERINDEX = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"transferIndex"</span>));</span><br><span class="line">            BASECOUNT = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"baseCount"</span>));</span><br><span class="line">            CELLSBUSY = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"cellsBusy"</span>));</span><br><span class="line">            Class&lt;?&gt; ck = CounterCell.class;</span><br><span class="line">            CELLVALUE = U.objectFieldOffset</span><br><span class="line">                (ck.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">            Class&lt;?&gt; ak = Node[].class;</span><br><span class="line">            ABASE = U.arrayBaseOffset(ak);</span><br><span class="line">            <span class="keyword">int</span> scale = U.arrayIndexScale(ak);</span><br><span class="line">            <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"data type scale not a power of two"</span>);</span><br><span class="line">            ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•"><a href="#ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•" class="headerlink" title="ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•"></a>ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•</h3><p>ConcurrentHashMapå®šä¹‰äº†ä¸‰ä¸ªåŸå­æ“ä½œï¼Œç”¨äºå¯¹æŒ‡å®šä½ç½®çš„èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚æ­£æ˜¯è¿™äº›åŸå­æ“ä½œä¿è¯äº†ConcurrentHashMapçš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å¾—åœ¨iä½ç½®ä¸Šçš„NodeèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//åˆ©ç”¨CASç®—æ³•è®¾ç½®iä½ç½®ä¸Šçš„NodeèŠ‚ç‚¹ã€‚ä¹‹æ‰€ä»¥èƒ½å®ç°å¹¶å‘æ˜¯å› ä¸ºä»–æŒ‡å®šäº†åŸæ¥è¿™ä¸ªèŠ‚ç‚¹çš„å€¼æ˜¯å¤šå°‘</span></span><br><span class="line">		<span class="comment">//åœ¨CASç®—æ³•ä¸­ï¼Œä¼šæ¯”è¾ƒå†…å­˜ä¸­çš„å€¼ä¸ä½ æŒ‡å®šçš„è¿™ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰æ‰æ¥å—ä½ çš„ä¿®æ”¹ï¼Œå¦åˆ™æ‹’ç»ä½ çš„ä¿®æ”¹</span></span><br><span class="line">		<span class="comment">//å› æ­¤å½“å‰çº¿ç¨‹ä¸­çš„å€¼å¹¶ä¸æ˜¯æœ€æ–°çš„å€¼ï¼Œè¿™ç§ä¿®æ”¹å¯èƒ½ä¼šè¦†ç›–æ‰å…¶ä»–çº¿ç¨‹çš„ä¿®æ”¹ç»“æœ  æœ‰ç‚¹ç±»ä¼¼äºSVN</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//åˆ©ç”¨volatileæ–¹æ³•è®¾ç½®èŠ‚ç‚¹ä½ç½®çš„å€¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–æ–¹æ³•initTable"><a href="#åˆå§‹åŒ–æ–¹æ³•initTable" class="headerlink" title="åˆå§‹åŒ–æ–¹æ³•initTable"></a>åˆå§‹åŒ–æ–¹æ³•initTable</h3><p>å¯¹äºConcurrentHashMapæ¥è¯´ï¼Œè°ƒç”¨å®ƒçš„æ„é€ æ–¹æ³•ä»…ä»…æ˜¯è®¾ç½®äº†ä¸€äº›å‚æ•°è€Œå·²ã€‚è€Œæ•´ä¸ªtableçš„åˆå§‹åŒ–æ˜¯åœ¨å‘ConcurrentHashMapä¸­æ’å…¥å…ƒç´ çš„æ—¶å€™å‘ç”Ÿçš„ã€‚å¦‚è°ƒç”¨putã€computeIfAbsentã€computeã€mergeç­‰æ–¹æ³•çš„æ—¶å€™ï¼Œè°ƒç”¨æ—¶æœºæ˜¯æ£€æŸ¥table==nullã€‚</p>
<p>åˆå§‹åŒ–æ–¹æ³•ä¸»è¦åº”ç”¨äº†å…³é”®å±æ€§sizeCtl å¦‚æœè¿™ä¸ªå€¼ã€ˆ0ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–ï¼Œå°±æ”¾å¼ƒè¿™ä¸ªæ“ä½œã€‚åœ¨è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºConcurrentHashMapçš„åˆå§‹åŒ–åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆã€‚å¦‚æœè·å¾—äº†åˆå§‹åŒ–æƒé™ï¼Œå°±ç”¨CASæ–¹æ³•å°†sizeCtlç½®ä¸º-1ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹è¿›å…¥ã€‚åˆå§‹åŒ–æ•°ç»„åï¼Œå°†sizeCtlçš„å€¼æ”¹ä¸º0.75*nã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes table, using the size recorded in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        		<span class="comment">//sizeCtlè¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼ŒæŠŠçº¿ç¨‹æŒ‚èµ·ã€‚å¯¹äºtableçš„åˆå§‹åŒ–å·¥ä½œï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿›è¡Œã€‚</span></span><br><span class="line">            <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">                Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;<span class="comment">//åˆ©ç”¨CASæ–¹æ³•æŠŠsizectlçš„å€¼ç½®ä¸º-1 è¡¨ç¤ºæœ¬çº¿ç¨‹æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = tab = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);<span class="comment">//ç›¸å½“äº0.75*n è®¾ç½®ä¸€ä¸ªæ‰©å®¹çš„é˜ˆå€¼</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tab;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‰©å®¹æ–¹æ³•-transfer"><a href="#æ‰©å®¹æ–¹æ³•-transfer" class="headerlink" title="æ‰©å®¹æ–¹æ³• transfer"></a>æ‰©å®¹æ–¹æ³• transfer</h3><p>å½“ConcurrentHashMapå®¹é‡ä¸è¶³çš„æ—¶å€™ï¼Œéœ€è¦å¯¹tableè¿›è¡Œæ‰©å®¹ã€‚è¿™ä¸ªæ–¹æ³•çš„åŸºæœ¬æ€æƒ³è·ŸHashMapæ˜¯å¾ˆåƒçš„ï¼Œä½†æ˜¯ç”±äºå®ƒæ˜¯æ”¯æŒå¹¶å‘æ‰©å®¹çš„ï¼Œæ‰€ä»¥è¦å¤æ‚çš„å¤šã€‚åŸå› æ˜¯å®ƒæ”¯æŒå¤šçº¿ç¨‹è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œè€Œå¹¶æ²¡æœ‰åŠ é”ã€‚æˆ‘æƒ³è¿™æ ·åšçš„ç›®çš„ä¸ä»…ä»…æ˜¯ä¸ºäº†æ»¡è¶³concurrentçš„è¦æ±‚ï¼Œè€Œæ˜¯å¸Œæœ›åˆ©ç”¨å¹¶å‘å¤„ç†å»å‡å°‘æ‰©å®¹å¸¦æ¥çš„æ—¶é—´å½±å“ã€‚å› ä¸ºåœ¨æ‰©å®¹çš„æ—¶å€™ï¼Œæ€»æ˜¯ä¼šæ¶‰åŠåˆ°ä»ä¸€ä¸ªâ€œæ•°ç»„â€åˆ°å¦ä¸€ä¸ªâ€œæ•°ç»„â€æ‹·è´çš„æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ“ä½œèƒ½å¤Ÿå¹¶å‘è¿›è¡Œï¼Œé‚£çœŸçœŸæ˜¯æå¥½çš„äº†ã€‚</p>
<p>æ•´ä¸ªæ‰©å®¹æ“ä½œåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<ul>
<li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ„å»ºä¸€ä¸ªnextTable,å®ƒçš„å®¹é‡æ˜¯åŸæ¥çš„ä¸¤å€ï¼Œè¿™ä¸ªæ“ä½œæ˜¯å•çº¿ç¨‹å®Œæˆçš„ã€‚è¿™ä¸ªå•çº¿ç¨‹çš„ä¿è¯æ˜¯é€šè¿‡RESIZE_STAMP_SHIFTè¿™ä¸ªå¸¸é‡ç»è¿‡ä¸€æ¬¡è¿ç®—æ¥ä¿è¯çš„ï¼Œè¿™ä¸ªåœ°æ–¹åœ¨åé¢ä¼šæœ‰æåˆ°ï¼›</li>
<li>ç¬¬äºŒä¸ªéƒ¨åˆ†å°±æ˜¯å°†åŸæ¥tableä¸­çš„å…ƒç´ å¤åˆ¶åˆ°nextTableä¸­ï¼Œè¿™é‡Œå…è®¸å¤šçº¿ç¨‹è¿›è¡Œæ“ä½œã€‚</li>
</ul>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹å•çº¿ç¨‹æ˜¯å¦‚ä½•å®Œæˆçš„ï¼š</p>
<p>å®ƒçš„å¤§ä½“æ€æƒ³å°±æ˜¯éå†ã€å¤åˆ¶çš„è¿‡ç¨‹ã€‚é¦–å…ˆæ ¹æ®è¿ç®—å¾—åˆ°éœ€è¦éå†çš„æ¬¡æ•°iï¼Œç„¶ååˆ©ç”¨tabAtæ–¹æ³•è·å¾—iä½ç½®çš„å…ƒç´ ï¼š</p>
<ul>
<li>å¦‚æœè¿™ä¸ªä½ç½®ä¸ºç©ºï¼Œå°±åœ¨åŸtableä¸­çš„iä½ç½®æ”¾å…¥forwardNodeèŠ‚ç‚¹ï¼Œè¿™ä¸ªä¹Ÿæ˜¯è§¦å‘å¹¶å‘æ‰©å®¹çš„å…³é”®ç‚¹ï¼›</li>
<li>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯NodeèŠ‚ç‚¹ï¼ˆfh&gt;=0ï¼‰ï¼Œå¦‚æœå®ƒæ˜¯ä¸€ä¸ªé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œå°±æ„é€ ä¸€ä¸ªååºé“¾è¡¨ï¼ŒæŠŠä»–ä»¬åˆ†åˆ«æ”¾åœ¨nextTableçš„iå’Œi+nçš„ä½ç½®ä¸Š</li>
<li>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯TreeBinèŠ‚ç‚¹ï¼ˆfh&lt;0ï¼‰ï¼Œä¹Ÿåšä¸€ä¸ªååºå¤„ç†ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦untreefiï¼ŒæŠŠå¤„ç†çš„ç»“æœåˆ†åˆ«æ”¾åœ¨nextTableçš„iå’Œi+nçš„ä½ç½®ä¸Š</li>
<li>éå†è¿‡æ‰€æœ‰çš„èŠ‚ç‚¹ä»¥åå°±å®Œæˆäº†å¤åˆ¶å·¥ä½œï¼Œè¿™æ—¶è®©nextTableä½œä¸ºæ–°çš„tableï¼Œå¹¶ä¸”æ›´æ–°sizeCtlä¸ºæ–°å®¹é‡çš„0.75å€ ï¼Œå®Œæˆæ‰©å®¹ã€‚</li>
</ul>
<p>å†çœ‹ä¸€ä¸‹å¤šçº¿ç¨‹æ˜¯å¦‚ä½•å®Œæˆçš„ï¼š</p>
<p>åœ¨ä»£ç çš„69è¡Œæœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœéå†åˆ°çš„èŠ‚ç‚¹æ˜¯forwardèŠ‚ç‚¹ï¼Œå°±å‘åç»§ç»­éå†ï¼Œå†åŠ ä¸Šç»™èŠ‚ç‚¹ä¸Šé”çš„æœºåˆ¶ï¼Œå°±å®Œæˆäº†å¤šçº¿ç¨‹çš„æ§åˆ¶ã€‚å¤šçº¿ç¨‹éå†èŠ‚ç‚¹ï¼Œå¤„ç†äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æŠŠå¯¹åº”ç‚¹çš„å€¼setä¸ºforwardï¼Œå¦ä¸€ä¸ªçº¿ç¨‹çœ‹åˆ°forwardï¼Œå°±å‘åéå†ã€‚è¿™æ ·äº¤å‰å°±å®Œæˆäº†å¤åˆ¶å·¥ä½œã€‚è€Œä¸”è¿˜å¾ˆå¥½çš„è§£å†³äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚ è¿™ä¸ªæ–¹æ³•çš„è®¾è®¡å®åœ¨æ˜¯è®©æˆ‘è†œæ‹œã€‚</p>
<p><a href="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg" target="_blank" rel="noopener"><img src="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg" alt=""></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸€ä¸ªè¿‡æ¸¡çš„tableè¡¨  åªæœ‰åœ¨æ‰©å®¹çš„æ—¶å€™æ‰ä¼šä½¿ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Moves and/or copies the nodes in each bin to new table. See</span></span><br><span class="line"><span class="comment">     * above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">        <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">            stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">        <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];<span class="comment">//æ„é€ ä¸€ä¸ªnextTableå¯¹è±¡ å®ƒçš„å®¹é‡æ˜¯åŸæ¥çš„ä¸¤å€</span></span><br><span class="line">                nextTab = nt;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">                sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nextTable = nextTab;</span><br><span class="line">            transferIndex = n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">        ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);<span class="comment">//æ„é€ ä¸€ä¸ªè¿èŠ‚ç‚¹æŒ‡é’ˆ ç”¨äºæ ‡å¿—ä½</span></span><br><span class="line">        <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;<span class="comment">//å¹¶å‘æ‰©å®¹çš„å…³é”®å±æ€§ å¦‚æœç­‰äºtrue è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹å·²ç»å¤„ç†è¿‡</span></span><br><span class="line">        <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">            <span class="comment">//è¿™ä¸ªwhileå¾ªç¯ä½“çš„ä½œç”¨å°±æ˜¯åœ¨æ§åˆ¶i--  é€šè¿‡i--å¯ä»¥ä¾æ¬¡éå†åŸhashè¡¨ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">                <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    i = -<span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                         (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                          nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                       nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                    bound = nextBound;</span><br><span class="line">                    i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">                <span class="keyword">int</span> sc;</span><br><span class="line">                <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                	<span class="comment">//å¦‚æœæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å·²ç»å®Œæˆå¤åˆ¶å·¥ä½œ  å°±æŠŠnextTableèµ‹å€¼ç»™table æ¸…ç©ºä¸´æ—¶å¯¹è±¡nextTable</span></span><br><span class="line">                    nextTable = <span class="keyword">null</span>;</span><br><span class="line">                    table = nextTab;</span><br><span class="line">                    sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);<span class="comment">//æ‰©å®¹é˜ˆå€¼è®¾ç½®ä¸ºåŸæ¥å®¹é‡çš„1.5å€  ä¾ç„¶ç›¸å½“äºç°åœ¨å®¹é‡çš„0.75å€</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//åˆ©ç”¨CASæ–¹æ³•æ›´æ–°è¿™ä¸ªæ‰©å®¹é˜ˆå€¼ï¼Œåœ¨è¿™é‡Œé¢sizectlå€¼å‡ä¸€ï¼Œè¯´æ˜æ–°åŠ å…¥ä¸€ä¸ªçº¿ç¨‹å‚ä¸åˆ°æ‰©å®¹æ“ä½œ</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                    i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœéå†åˆ°çš„èŠ‚ç‚¹ä¸ºç©º åˆ™æ”¾å…¥ForwardingNodeæŒ‡é’ˆ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">                advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">            <span class="comment">//å¦‚æœéå†åˆ°ForwardingNodeèŠ‚ç‚¹  è¯´æ˜è¿™ä¸ªç‚¹å·²ç»è¢«å¤„ç†è¿‡äº† ç›´æ¥è·³è¿‡  è¿™é‡Œæ˜¯æ§åˆ¶å¹¶å‘æ‰©å®¹çš„æ ¸å¿ƒ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">            		<span class="comment">//èŠ‚ç‚¹ä¸Šé”</span></span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                        <span class="comment">//å¦‚æœfh&gt;=0 è¯æ˜è¿™æ˜¯ä¸€ä¸ªNodeèŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                            <span class="comment">//ä»¥ä¸‹çš„éƒ¨åˆ†åœ¨å®Œæˆçš„å·¥ä½œæ˜¯æ„é€ ä¸¤ä¸ªé“¾è¡¨  ä¸€ä¸ªæ˜¯åŸé“¾è¡¨  å¦ä¸€ä¸ªæ˜¯åŸé“¾è¡¨çš„ååºæ’åˆ—</span></span><br><span class="line">                            Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                                <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                    runBit = b;</span><br><span class="line">                                    lastRun = p;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                                ln = lastRun;</span><br><span class="line">                                hn = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                hn = lastRun;</span><br><span class="line">                                ln = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                                <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                    ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„iä½ç½®ä¸Šæ’å…¥ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„i+nçš„ä½ç½®ä¸Šæ’å…¥å¦ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                            <span class="comment">//åœ¨tableçš„iä½ç½®ä¸Šæ’å…¥forwardNodeèŠ‚ç‚¹  è¡¨ç¤ºå·²ç»å¤„ç†è¿‡è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            <span class="comment">//è®¾ç½®advanceä¸ºtrue è¿”å›åˆ°ä¸Šé¢çš„whileå¾ªç¯ä¸­ å°±å¯ä»¥æ‰§è¡Œi--æ“ä½œ</span></span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//å¯¹TreeBinå¯¹è±¡è¿›è¡Œå¤„ç†  ä¸ä¸Šé¢çš„è¿‡ç¨‹ç±»ä¼¼</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                            TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                            <span class="comment">//æ„é€ æ­£åºå’Œååºä¸¤ä¸ªé“¾è¡¨</span></span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                                TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                    (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        lo = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        loTail.next = p;</span><br><span class="line">                                    loTail = p;</span><br><span class="line">                                    ++lc;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        hi = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        hiTail.next = p;</span><br><span class="line">                                    hiTail = p;</span><br><span class="line">                                    ++hc;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//å¦‚æœæ‰©å®¹åå·²ç»ä¸å†éœ€è¦treeçš„ç»“æ„ åå‘è½¬æ¢ä¸ºé“¾è¡¨ç»“æ„</span></span><br><span class="line">                            ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                                (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                            hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                                (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                             <span class="comment">//åœ¨nextTableçš„iä½ç½®ä¸Šæ’å…¥ä¸€ä¸ªé“¾è¡¨    </span></span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            <span class="comment">//åœ¨nextTableçš„i+nçš„ä½ç½®ä¸Šæ’å…¥å¦ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                             <span class="comment">//åœ¨tableçš„iä½ç½®ä¸Šæ’å…¥forwardNodeèŠ‚ç‚¹  è¡¨ç¤ºå·²ç»å¤„ç†è¿‡è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            <span class="comment">//è®¾ç½®advanceä¸ºtrue è¿”å›åˆ°ä¸Šé¢çš„whileå¾ªç¯ä¸­ å°±å¯ä»¥æ‰§è¡Œi--æ“ä½œ</span></span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Putæ–¹æ³•"><a href="#Putæ–¹æ³•" class="headerlink" title="Putæ–¹æ³•"></a>Putæ–¹æ³•</h2><p>å‰é¢çš„æ‰€æœ‰çš„ä»‹ç»å…¶å®éƒ½ä¸ºè¿™ä¸ªæ–¹æ³•åšé“ºå«ã€‚ConcurrentHashMapæœ€å¸¸ç”¨çš„å°±æ˜¯putå’Œgetä¸¤ä¸ªæ–¹æ³•ã€‚ç°åœ¨æ¥ä»‹ç»putæ–¹æ³•ï¼Œè¿™ä¸ªputæ–¹æ³•ä¾ç„¶æ²¿ç”¨HashMapçš„putæ–¹æ³•çš„æ€æƒ³ï¼Œæ ¹æ®hashå€¼è®¡ç®—è¿™ä¸ªæ–°æ’å…¥çš„ç‚¹åœ¨tableä¸­çš„ä½ç½®iï¼Œå¦‚æœiä½ç½®æ˜¯ç©ºçš„ï¼Œç›´æ¥æ”¾è¿›å»ï¼Œå¦åˆ™è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœiä½ç½®æ˜¯æ ‘èŠ‚ç‚¹ï¼ŒæŒ‰ç…§æ ‘çš„æ–¹å¼æ’å…¥æ–°çš„èŠ‚ç‚¹ï¼Œå¦åˆ™æŠŠiæ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚ConcurrentHashMapä¸­ä¾ç„¶æ²¿ç”¨è¿™ä¸ªæ€æƒ³ï¼Œæœ‰ä¸€ä¸ªæœ€é‡è¦çš„ä¸åŒç‚¹å°±æ˜¯ConcurrentHashMapä¸å…è®¸keyæˆ–valueä¸ºnullå€¼ã€‚å¦å¤–ç”±äºæ¶‰åŠåˆ°å¤šçº¿ç¨‹ï¼Œputæ–¹æ³•å°±è¦å¤æ‚ä¸€ç‚¹ã€‚åœ¨å¤šçº¿ç¨‹ä¸­å¯èƒ½æœ‰ä»¥ä¸‹ä¸¤ä¸ªæƒ…å†µ</p>
<ol>
<li><p>å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ­£åœ¨å¯¹ConcurrentHashMapè¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå½“å‰çº¿ç¨‹ä¹Ÿè¦è¿›å…¥æ‰©å®¹çš„æ“ä½œä¸­ã€‚è¿™ä¸ªæ‰©å®¹çš„æ“ä½œä¹‹æ‰€ä»¥èƒ½è¢«æ£€æµ‹åˆ°ï¼Œæ˜¯å› ä¸ºtransferæ–¹æ³•ä¸­åœ¨ç©ºç»“ç‚¹ä¸Šæ’å…¥forwardèŠ‚ç‚¹ï¼Œå¦‚æœæ£€æµ‹åˆ°éœ€è¦æ’å…¥çš„ä½ç½®è¢«forwardèŠ‚ç‚¹å æœ‰ï¼Œå°±å¸®åŠ©è¿›è¡Œæ‰©å®¹ï¼›</p>
</li>
<li><p>å¦‚æœæ£€æµ‹åˆ°è¦æ’å…¥çš„èŠ‚ç‚¹æ˜¯éç©ºä¸”ä¸æ˜¯forwardèŠ‚ç‚¹ï¼Œå°±å¯¹è¿™ä¸ªèŠ‚ç‚¹åŠ é”ï¼Œè¿™æ ·å°±ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡è¿™ä¸ªæœ‰ä¸€äº›å½±å“æ•ˆç‡ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæ¯”hashTableçš„synchronizedè¦å¥½å¾—å¤šã€‚</p>
</li>
</ol>
<p>æ•´ä½“æµç¨‹å°±æ˜¯é¦–å…ˆå®šä¹‰ä¸å…è®¸keyæˆ–valueä¸ºnullçš„æƒ…å†µæ”¾å…¥  å¯¹äºæ¯ä¸€ä¸ªæ”¾å…¥çš„å€¼ï¼Œé¦–å…ˆåˆ©ç”¨spreadæ–¹æ³•å¯¹keyçš„hashcodeè¿›è¡Œä¸€æ¬¡hashè®¡ç®—ï¼Œç”±æ­¤æ¥ç¡®å®šè¿™ä¸ªå€¼åœ¨tableä¸­çš„ä½ç½®ã€‚</p>
<p>å¦‚æœè¿™ä¸ªä½ç½®æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç›´æ¥æ”¾å…¥ï¼Œè€Œä¸”ä¸éœ€è¦åŠ é”æ“ä½œã€‚</p>
<p> å¦‚æœè¿™ä¸ªä½ç½®å­˜åœ¨ç»“ç‚¹ï¼Œè¯´æ˜å‘ç”Ÿäº†hashç¢°æ’ï¼Œé¦–å…ˆåˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ç±»å‹ã€‚å¦‚æœæ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼ˆfh&gt;0ï¼‰,åˆ™å¾—åˆ°çš„ç»“ç‚¹å°±æ˜¯hashå€¼ç›¸åŒçš„èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚éœ€è¦ä¾æ¬¡å‘åéå†ç¡®å®šè¿™ä¸ªæ–°åŠ å…¥çš„å€¼æ‰€åœ¨ä½ç½®ã€‚å¦‚æœé‡åˆ°hashå€¼ä¸keyå€¼éƒ½ä¸æ–°åŠ å…¥èŠ‚ç‚¹æ˜¯ä¸€è‡´çš„æƒ…å†µï¼Œåˆ™åªéœ€è¦æ›´æ–°valueå€¼å³å¯ã€‚å¦åˆ™ä¾æ¬¡å‘åéå†ï¼Œç›´åˆ°é“¾è¡¨å°¾æ’å…¥è¿™ä¸ªç»“ç‚¹ã€‚å¦‚æœåŠ å…¥è¿™ä¸ªèŠ‚ç‚¹ä»¥åé“¾è¡¨é•¿åº¦å¤§äº8ï¼Œå°±æŠŠè¿™ä¸ªé“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ã€‚å¦‚æœè¿™ä¸ªèŠ‚ç‚¹çš„ç±»å‹å·²ç»æ˜¯æ ‘èŠ‚ç‚¹çš„è¯ï¼Œç›´æ¥è°ƒç”¨æ ‘èŠ‚ç‚¹çš„æ’å…¥æ–¹æ³•è¿›è¡Œæ’å…¥æ–°çš„å€¼ã€‚</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** Implementation for put and putIfAbsent */</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">   		<span class="comment">//ä¸å…è®¸ keyæˆ–valueä¸ºnull</span></span><br><span class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">       <span class="comment">//è®¡ç®—hashå€¼</span></span><br><span class="line">       <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">       <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">//æ­»å¾ªç¯ ä½•æ—¶æ’å…¥æˆåŠŸ ä½•æ—¶è·³å‡º</span></span><br><span class="line">       <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">           Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">           <span class="comment">//å¦‚æœtableä¸ºç©ºçš„è¯ï¼Œåˆå§‹åŒ–table</span></span><br><span class="line">           <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">               tab = initTable();</span><br><span class="line">           <span class="comment">//æ ¹æ®hashå€¼è®¡ç®—å‡ºåœ¨tableé‡Œé¢çš„ä½ç½® </span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">           	<span class="comment">//å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰å€¼ ï¼Œç›´æ¥æ”¾è¿›å»ï¼Œä¸éœ€è¦åŠ é”</span></span><br><span class="line">               <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                   <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//å½“é‡åˆ°è¡¨è¿æ¥ç‚¹æ—¶ï¼Œéœ€è¦è¿›è¡Œæ•´åˆè¡¨çš„æ“ä½œ</span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">               tab = helpTransfer(tab, f);</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               V oldVal = <span class="keyword">null</span>;</span><br><span class="line">               <span class="comment">//ç»“ç‚¹ä¸Šé”  è¿™é‡Œçš„ç»“ç‚¹å¯ä»¥ç†è§£ä¸ºhashå€¼ç›¸åŒç»„æˆçš„é“¾è¡¨çš„å¤´ç»“ç‚¹</span></span><br><span class="line">               <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                       <span class="comment">//fhã€‰0 è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªé“¾è¡¨çš„èŠ‚ç‚¹ ä¸æ˜¯æ ‘çš„èŠ‚ç‚¹</span></span><br><span class="line">                       <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                           binCount = <span class="number">1</span>;</span><br><span class="line">                           <span class="comment">//åœ¨è¿™é‡Œéå†é“¾è¡¨æ‰€æœ‰çš„ç»“ç‚¹</span></span><br><span class="line">                           <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                               K ek;</span><br><span class="line">                               <span class="comment">//å¦‚æœhashå€¼å’Œkeyå€¼ç›¸åŒ  åˆ™ä¿®æ”¹å¯¹åº”ç»“ç‚¹çš„valueå€¼</span></span><br><span class="line">                               <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                   ((ek = e.key) == key ||</span><br><span class="line">                                    (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                   oldVal = e.val;</span><br><span class="line">                                   <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                       e.val = value;</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                               Node&lt;K,V&gt; pred = e;</span><br><span class="line">                               <span class="comment">//å¦‚æœéå†åˆ°äº†æœ€åä¸€ä¸ªç»“ç‚¹ï¼Œé‚£ä¹ˆå°±è¯æ˜æ–°çš„èŠ‚ç‚¹éœ€è¦æ’å…¥ å°±æŠŠå®ƒæ’å…¥åœ¨é“¾è¡¨å°¾éƒ¨</span></span><br><span class="line">                               <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                   pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                             value, <span class="keyword">null</span>);</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">//å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ˜¯æ ‘èŠ‚ç‚¹ï¼Œå°±æŒ‰ç…§æ ‘çš„æ–¹å¼æ’å…¥å€¼</span></span><br><span class="line">                       <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                           Node&lt;K,V&gt; p;</span><br><span class="line">                           binCount = <span class="number">2</span>;</span><br><span class="line">                           <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                          value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               oldVal = p.val;</span><br><span class="line">                               <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                   p.val = value;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">               	<span class="comment">//å¦‚æœé“¾è¡¨é•¿åº¦å·²ç»è¾¾åˆ°ä¸´ç•Œå€¼8 å°±éœ€è¦æŠŠé“¾è¡¨è½¬æ¢ä¸ºæ ‘ç»“æ„</span></span><br><span class="line">                   <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                       treeifyBin(tab, i);</span><br><span class="line">                   <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                       <span class="keyword">return</span> oldVal;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//å°†å½“å‰ConcurrentHashMapçš„å…ƒç´ æ•°é‡+1</span></span><br><span class="line">       addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°JDK8ä¸­çš„å®ç°ä¹Ÿæ˜¯é”åˆ†ç¦»çš„æ€æƒ³ï¼Œåªæ˜¯é”ä½çš„æ˜¯ä¸€ä¸ªNodeï¼Œè€Œä¸æ˜¯JDK7ä¸­çš„Segmentï¼Œè€Œé”ä½Nodeä¹‹å‰çš„æ“ä½œæ˜¯æ— é”çš„å¹¶ä¸”ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå»ºç«‹åœ¨ä¹‹å‰æåˆ°çš„3ä¸ªåŸå­æ“ä½œä¸Šã€‚</p>
<h3 id="helpTransferæ–¹æ³•"><a href="#helpTransferæ–¹æ³•" class="headerlink" title="helpTransferæ–¹æ³•"></a>helpTransferæ–¹æ³•</h3><p>è¿™æ˜¯ä¸€ä¸ªååŠ©æ‰©å®¹çš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå½“å‰ConcurrentHashMapä¸€å®šå·²ç»æœ‰äº†nextTableå¯¹è±¡ï¼Œé¦–å…ˆæ‹¿åˆ°è¿™ä¸ªnextTableå¯¹è±¡ï¼Œè°ƒç”¨transferæ–¹æ³•ã€‚å›çœ‹ä¸Šé¢çš„transferæ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå½“æœ¬çº¿ç¨‹è¿›å…¥æ‰©å®¹æ–¹æ³•çš„æ—¶å€™ä¼šç›´æ¥è¿›å…¥å¤åˆ¶é˜¶æ®µã€‚</p>
<h3 id="treeifyBinæ–¹æ³•"><a href="#treeifyBinæ–¹æ³•" class="headerlink" title="treeifyBinæ–¹æ³•"></a>treeifyBinæ–¹æ³•</h3><p>è¿™ä¸ªæ–¹æ³•ç”¨äºå°†è¿‡é•¿çš„é“¾è¡¨è½¬æ¢ä¸ºTreeBinå¯¹è±¡ã€‚ä½†æ˜¯ä»–å¹¶ä¸æ˜¯ç›´æ¥è½¬æ¢ï¼Œè€Œæ˜¯è¿›è¡Œä¸€æ¬¡å®¹é‡åˆ¤æ–­ï¼Œå¦‚æœå®¹é‡æ²¡æœ‰è¾¾åˆ°è½¬æ¢çš„è¦æ±‚ï¼Œç›´æ¥è¿›è¡Œæ‰©å®¹æ“ä½œå¹¶è¿”å›ï¼›å¦‚æœæ»¡è¶³æ¡ä»¶æ‰é“¾è¡¨çš„ç»“æ„æŠ“æ¢ä¸ºTreeBin ï¼Œè¿™ä¸HashMapä¸åŒçš„æ˜¯ï¼Œå®ƒå¹¶æ²¡æœ‰æŠŠTreeNodeç›´æ¥æ”¾å…¥çº¢é»‘æ ‘ï¼Œè€Œæ˜¯åˆ©ç”¨äº†TreeBinè¿™ä¸ªå°å®¹å™¨æ¥å°è£…æ‰€æœ‰çš„TreeNode.</p>
<h2 id="getæ–¹æ³•"><a href="#getæ–¹æ³•" class="headerlink" title="getæ–¹æ³•"></a>getæ–¹æ³•</h2><p>getæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œç»™å®šä¸€ä¸ªkeyæ¥ç¡®å®švalueçš„æ—¶å€™ï¼Œå¿…é¡»æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶  keyç›¸åŒ  hashå€¼ç›¸åŒï¼Œå¯¹äºèŠ‚ç‚¹å¯èƒ½åœ¨é“¾è¡¨æˆ–æ ‘ä¸Šçš„æƒ…å†µï¼Œéœ€è¦åˆ†åˆ«å»æŸ¥æ‰¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">        <span class="comment">//è®¡ç®—hashå€¼</span></span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        <span class="comment">//æ ¹æ®hashå€¼ç¡®å®šèŠ‚ç‚¹ä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæœç´¢åˆ°çš„èŠ‚ç‚¹keyä¸ä¼ å…¥çš„keyç›¸åŒä¸”ä¸ä¸ºnull,ç›´æ¥è¿”å›è¿™ä¸ªèŠ‚ç‚¹	</span></span><br><span class="line">            <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœeh&lt;0 è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹åœ¨æ ‘ä¸Š ç›´æ¥å¯»æ‰¾</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">             <span class="comment">//å¦åˆ™éå†é“¾è¡¨ æ‰¾åˆ°å¯¹åº”çš„å€¼å¹¶è¿”å›</span></span><br><span class="line">            <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sizeç›¸å…³çš„æ–¹æ³•"><a href="#Sizeç›¸å…³çš„æ–¹æ³•" class="headerlink" title="Sizeç›¸å…³çš„æ–¹æ³•"></a>Sizeç›¸å…³çš„æ–¹æ³•</h2><p>å¯¹äºConcurrentHashMapæ¥è¯´ï¼Œè¿™ä¸ªtableé‡Œåˆ°åº•è£…äº†å¤šå°‘ä¸œè¥¿å…¶å®æ˜¯ä¸ªä¸ç¡®å®šçš„æ•°é‡ï¼Œå› ä¸ºä¸å¯èƒ½åœ¨è°ƒç”¨size()æ–¹æ³•çš„æ—¶å€™åƒGCçš„â€œstop the worldâ€ä¸€æ ·è®©å…¶ä»–çº¿ç¨‹éƒ½åœä¸‹æ¥è®©ä½ å»ç»Ÿè®¡ï¼Œå› æ­¤åªèƒ½è¯´è¿™ä¸ªæ•°é‡æ˜¯ä¸ªä¼°è®¡å€¼ã€‚å¯¹äºè¿™ä¸ªä¼°è®¡å€¼ï¼ŒConcurrentHashMapä¹Ÿæ˜¯å¤§è´¹å‘¨ç« æ‰è®¡ç®—å‡ºæ¥çš„ã€‚</p>
<h3 id="è¾…åŠ©å®šä¹‰"><a href="#è¾…åŠ©å®šä¹‰" class="headerlink" title="è¾…åŠ©å®šä¹‰"></a>è¾…åŠ©å®šä¹‰</h3><p>ä¸ºäº†ç»Ÿè®¡å…ƒç´ ä¸ªæ•°ï¼ŒConcurrentHashMapå®šä¹‰äº†ä¸€äº›å˜é‡å’Œä¸€ä¸ªå†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A padded cell for distributing counts.  Adapted from LongAdder</span></span><br><span class="line"><span class="comment">     * and Striped64.  See their internal docs for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">        CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/******************************************/</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®é™…ä¸Šä¿å­˜çš„æ˜¯hashmapä¸­çš„å…ƒç´ ä¸ªæ•°  åˆ©ç”¨CASé”è¿›è¡Œæ›´æ–°</span></span><br><span class="line"><span class="comment">     ä½†å®ƒå¹¶ä¸ç”¨è¿”å›å½“å‰hashmapçš„å…ƒç´ ä¸ªæ•° </span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spinlock (locked via CAS) used when resizing and/or creating CounterCells.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table of counter cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure>
<h3 id="mappingCountä¸Sizeæ–¹æ³•"><a href="#mappingCountä¸Sizeæ–¹æ³•" class="headerlink" title="mappingCountä¸Sizeæ–¹æ³•"></a>mappingCountä¸Sizeæ–¹æ³•</h3><p>mappingCountä¸sizeæ–¹æ³•çš„ç±»ä¼¼  ä»Javaå·¥ç¨‹å¸ˆç»™å‡ºçš„æ³¨é‡Šæ¥çœ‹ï¼Œåº”è¯¥ä½¿ç”¨mappingCountä»£æ›¿sizeæ–¹æ³• ä¸¤ä¸ªæ–¹æ³•éƒ½æ²¡æœ‰ç›´æ¥è¿”å›basecount è€Œæ˜¯ç»Ÿè®¡ä¸€æ¬¡è¿™ä¸ªå€¼ï¼Œè€Œè¿™ä¸ªå€¼å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå¤§æ¦‚çš„æ•°å€¼ï¼Œå› æ­¤å¯èƒ½åœ¨ç»Ÿè®¡çš„æ—¶å€™æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰§è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">                (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">                (<span class="keyword">int</span>)n);</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of mappings. This method should be used</span></span><br><span class="line"><span class="comment">     * instead of &#123;<span class="doctag">@link</span> #size&#125; because a ConcurrentHashMap may</span></span><br><span class="line"><span class="comment">     * contain more mappings than can be represented as an int. The</span></span><br><span class="line"><span class="comment">     * value returned is an estimate; the actual count may differ if</span></span><br><span class="line"><span class="comment">     * there are concurrent insertions or removals.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of mappings</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">mappingCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0L</span>) ? <span class="number">0L</span> : n; <span class="comment">// ignore transient negative values</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">        <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">        <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                    sum += a.value;<span class="comment">//æ‰€æœ‰counterçš„å€¼æ±‚å’Œ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="addCountæ–¹æ³•"><a href="#addCountæ–¹æ³•" class="headerlink" title="addCountæ–¹æ³•"></a>addCountæ–¹æ³•</h3><p>åœ¨putæ–¹æ³•ç»“å°¾å¤„è°ƒç”¨äº†addCountæ–¹æ³•ï¼ŒæŠŠå½“å‰ConcurrentHashMapçš„å…ƒç´ ä¸ªæ•°+1è¿™ä¸ªæ–¹æ³•ä¸€å…±åšäº†ä¸¤ä»¶äº‹,æ›´æ–°baseCountçš„å€¼ï¼Œæ£€æµ‹æ˜¯å¦è¿›è¡Œæ‰©å®¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">        CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">        <span class="comment">//åˆ©ç”¨CASæ–¹æ³•æ›´æ–°baseCountçš„å€¼ </span></span><br><span class="line">        <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">            !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">            CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">            <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">                (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">                !(uncontended =</span><br><span class="line">                  U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">                fullAddCount(x, uncontended);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœcheckå€¼å¤§äºç­‰äº0 åˆ™éœ€è¦æ£€éªŒæ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">            <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">                <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                        sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                        transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                     <span class="comment">//å¦‚æœå·²ç»æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ‰§è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                        transfer(tab, nt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å½“å‰çº¿ç¨‹æ˜¯å”¯ä¸€çš„æˆ–æ˜¯ç¬¬ä¸€ä¸ªå‘èµ·æ‰©å®¹çš„çº¿ç¨‹  æ­¤æ—¶nextTable=null</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                             (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                    transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">                s = sumCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>JDK6,7ä¸­çš„ConcurrentHashmapä¸»è¦ä½¿ç”¨Segmentæ¥å®ç°å‡å°é”ç²’åº¦ï¼ŒæŠŠHashMapåˆ†å‰²æˆè‹¥å¹²ä¸ªSegmentï¼Œåœ¨putçš„æ—¶å€™éœ€è¦é”ä½Segmentï¼Œgetæ—¶å€™ä¸åŠ é”ï¼Œä½¿ç”¨volatileæ¥ä¿è¯å¯è§æ€§ï¼Œå½“è¦ç»Ÿè®¡å…¨å±€æ—¶ï¼ˆæ¯”å¦‚sizeï¼‰ï¼Œé¦–å…ˆä¼šå°è¯•å¤šæ¬¡è®¡ç®—modcountæ¥ç¡®å®šï¼Œè¿™å‡ æ¬¡å°è¯•ä¸­ï¼Œæ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¿®æ”¹æ“ä½œï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›sizeã€‚å¦‚æœæœ‰ï¼Œåˆ™éœ€è¦ä¾æ¬¡é”ä½æ‰€æœ‰çš„Segmentæ¥è®¡ç®—ã€‚</p>
<p>jdk7ä¸­ConcurrentHashmapä¸­ï¼Œå½“é•¿åº¦è¿‡é•¿ç¢°æ’ä¼šå¾ˆé¢‘ç¹ï¼Œé“¾è¡¨çš„å¢æ”¹åˆ æŸ¥æ“ä½œéƒ½ä¼šæ¶ˆè€—å¾ˆé•¿çš„æ—¶é—´ï¼Œå½±å“æ€§èƒ½,æ‰€ä»¥jdk8 ä¸­å®Œå…¨é‡å†™äº†concurrentHashmap,ä»£ç é‡ä»åŸæ¥çš„1000å¤šè¡Œå˜æˆäº† 6000å¤š è¡Œï¼Œå®ç°ä¸Šä¹Ÿå’ŒåŸæ¥çš„åˆ†æ®µå¼å­˜å‚¨æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚</p>
<p>ä¸»è¦è®¾è®¡ä¸Šçš„å˜åŒ–æœ‰ä»¥ä¸‹å‡ ç‚¹: </p>
<ol>
<li>ä¸é‡‡ç”¨segmentè€Œé‡‡ç”¨nodeï¼Œé”ä½nodeæ¥å®ç°å‡å°é”ç²’åº¦ã€‚</li>
<li>è®¾è®¡äº†MOVEDçŠ¶æ€ å½“resizeçš„ä¸­è¿‡ç¨‹ä¸­ çº¿ç¨‹2è¿˜åœ¨putæ•°æ®ï¼Œçº¿ç¨‹2ä¼šå¸®åŠ©resizeã€‚<br>3, ä½¿ç”¨3ä¸ªCASæ“ä½œæ¥ç¡®ä¿nodeçš„ä¸€äº›æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ç§æ–¹å¼ä»£æ›¿äº†é”ã€‚</li>
<li>sizeCtlçš„ä¸åŒå€¼æ¥ä»£è¡¨ä¸åŒå«ä¹‰ï¼Œèµ·åˆ°äº†æ§åˆ¶çš„ä½œç”¨ã€‚</li>
</ol>
<p>è‡³äºä¸ºä»€ä¹ˆJDK8ä¸­ä½¿ç”¨synchronizedè€Œä¸æ˜¯ReentrantLockï¼Œæ˜¯å› ä¸ºJDK8ä¸­å¯¹synchronizedæœ‰äº†è¶³å¤Ÿçš„ä¼˜åŒ–å§ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="http://www.jianshu.com/p/4806633fcc55" target="_blank" rel="noopener">http://www.jianshu.com/p/4806633fcc55</a></p>
<p><a href="http://blog.csdn.net/u010723709/article/details/48007881" target="_blank" rel="noopener">http://blog.csdn.net/u010723709/article/details/48007881</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/æ•°æ®ç»“æ„/" rel="tag"># æ•°æ®ç»“æ„</a>
          
            <a href="/tags/conccurenthashmap/" rel="tag"># conccurenthashmap</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/24/understanding-raft/" rel="next" title="ä¸€ä¸ªå¾ˆå¥½ç†è§£raftçš„åŠ¨ç”»æ¼”ç¤º">
                <i class="fa fa-chevron-left"></i> ä¸€ä¸ªå¾ˆå¥½ç†è§£raftçš„åŠ¨ç”»æ¼”ç¤º
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/28/java-g1/" rel="prev" title="æ·±å…¥ç†è§£Java G1åƒåœ¾æ”¶é›†å™¨">
                æ·±å…¥ç†è§£Java G1åƒåœ¾æ”¶é›†å™¨ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars7.githubusercontent.com/u/22493186?v=4&s=460"
               alt="ejunjsh" />
          <p class="site-author-name" itemprop="name">ejunjsh</p>
           
              <p class="site-description motion-element" itemprop="description">code freak</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">153</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">148</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ejunjsh" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/339238080" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:sjj050121014@163.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      Email
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/junjie.shao.9" target="_blank" title="FB Page">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                    
                      FB Page
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#jdk6å’Œjdk7ä¸­çš„å®ç°"><span class="nav-number">1.</span> <span class="nav-text">jdk6å’Œjdk7ä¸­çš„å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#è®¾è®¡æ€è·¯"><span class="nav-number">1.1.</span> <span class="nav-text">è®¾è®¡æ€è·¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¹¶å‘åº¦ï¼ˆConcurrency-Levelï¼‰"><span class="nav-number">1.2.</span> <span class="nav-text">å¹¶å‘åº¦ï¼ˆConcurrency Levelï¼‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆ›å»ºåˆ†æ®µé”"><span class="nav-number">1.3.</span> <span class="nav-text">åˆ›å»ºåˆ†æ®µé”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#put-putIfAbsent-putAll"><span class="nav-number">1.4.</span> <span class="nav-text">put/putIfAbsent/putAll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rehash"><span class="nav-number">1.5.</span> <span class="nav-text">rehash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#remove"><span class="nav-number">1.6.</span> <span class="nav-text">remove</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getä¸containsKey"><span class="nav-number">1.7.</span> <span class="nav-text">getä¸containsKey</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sizeã€containsValue"><span class="nav-number">1.8.</span> <span class="nav-text">sizeã€containsValue</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JDK8ä¸­çš„å®ç°"><span class="nav-number">2.</span> <span class="nav-text">JDK8ä¸­çš„å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#é‡è¦çš„å±æ€§"><span class="nav-number">2.1.</span> <span class="nav-text">é‡è¦çš„å±æ€§</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é‡è¦çš„ç±»"><span class="nav-number">2.2.</span> <span class="nav-text">é‡è¦çš„ç±»</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Node"><span class="nav-number">2.2.1.</span> <span class="nav-text">Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TreeNode"><span class="nav-number">2.2.2.</span> <span class="nav-text">TreeNode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TreeBin"><span class="nav-number">2.2.3.</span> <span class="nav-text">TreeBin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ForwardingNode"><span class="nav-number">2.2.4.</span> <span class="nav-text">ForwardingNode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsafeä¸CAS"><span class="nav-number">2.3.</span> <span class="nav-text">Unsafeä¸CAS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#unsafeé™æ€å—"><span class="nav-number">2.3.1.</span> <span class="nav-text">unsafeé™æ€å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•"><span class="nav-number">2.3.2.</span> <span class="nav-text">ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆå§‹åŒ–æ–¹æ³•initTable"><span class="nav-number">2.3.3.</span> <span class="nav-text">åˆå§‹åŒ–æ–¹æ³•initTable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‰©å®¹æ–¹æ³•-transfer"><span class="nav-number">2.3.4.</span> <span class="nav-text">æ‰©å®¹æ–¹æ³• transfer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Putæ–¹æ³•"><span class="nav-number">2.4.</span> <span class="nav-text">Putæ–¹æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#helpTransferæ–¹æ³•"><span class="nav-number">2.4.1.</span> <span class="nav-text">helpTransferæ–¹æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#treeifyBinæ–¹æ³•"><span class="nav-number">2.4.2.</span> <span class="nav-text">treeifyBinæ–¹æ³•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getæ–¹æ³•"><span class="nav-number">2.5.</span> <span class="nav-text">getæ–¹æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sizeç›¸å…³çš„æ–¹æ³•"><span class="nav-number">2.6.</span> <span class="nav-text">Sizeç›¸å…³çš„æ–¹æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#è¾…åŠ©å®šä¹‰"><span class="nav-number">2.6.1.</span> <span class="nav-text">è¾…åŠ©å®šä¹‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mappingCountä¸Sizeæ–¹æ³•"><span class="nav-number">2.6.2.</span> <span class="nav-text">mappingCountä¸Sizeæ–¹æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#addCountæ–¹æ³•"><span class="nav-number">2.6.3.</span> <span class="nav-text">addCountæ–¹æ³•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">3.</span> <span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">4.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <a href="/mylove" style="border-bottom:none">
    <i class="fa fa-heart"></i>
    </a>
  </span>
  <span class="author" itemprop="copyrightHolder">ejunjsh</span>

  
</div>


  <div class="powered-by">
    Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    Theme &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Gemini
    </a>
  </div>


        







        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.2"></script>



  

  

  

  

  

  

</body>
</html>
