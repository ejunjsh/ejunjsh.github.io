<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="java,Êï∞ÊçÆÁªìÊûÑ,conccurenthashmap," />





  <link rel="alternate" href="/atom.xml" title="IdiotSky" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Âè™Ââ©‰∏ãËøô‰∏™Ê≤°Êúâmark‰∫ÜÔºåÂÅèÂÅèËøôÊó∂ÂÄôÔºåÈù¢ËØïË¢´ÈóÆÂà∞ÔºåÊÇ≤Ââß‰∫Üüò¢  jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞ËÆæËÆ°ÊÄùË∑ØConcurrentHashMapÈááÁî®‰∫ÜÂàÜÊÆµÈîÅÁöÑËÆæËÆ°ÔºåÂè™ÊúâÂú®Âêå‰∏Ä‰∏™ÂàÜÊÆµÂÜÖÊâçÂ≠òÂú®Á´ûÊÄÅÂÖ≥Á≥ªÔºå‰∏çÂêåÁöÑÂàÜÊÆµÈîÅ‰πãÈó¥Ê≤°ÊúâÈîÅÁ´û‰∫â„ÄÇÁõ∏ÊØî‰∫éÂØπÊï¥‰∏™MapÂä†ÈîÅÁöÑËÆæËÆ°ÔºåÂàÜÊÆµÈîÅÂ§ßÂ§ßÁöÑÊèêÈ´ò‰∫ÜÈ´òÂπ∂ÂèëÁéØÂ¢É‰∏ãÁöÑÂ§ÑÁêÜËÉΩÂäõ„ÄÇ‰ΩÜÂêåÊó∂ÔºåÁî±‰∫é‰∏çÊòØÂØπÊï¥‰∏™MapÂä†ÈîÅÔºåÂØºËá¥‰∏Ä‰∫õÈúÄË¶ÅÊâ´ÊèèÊï¥‰∏™MapÁöÑÊñπÊ≥ïÔºàÂ¶Çsize(), containsValue">
<meta name="keywords" content="java,Êï∞ÊçÆÁªìÊûÑ,conccurenthashmap">
<meta property="og:type" content="article">
<meta property="og:title" content="java ConcurrentHashMapËß£Êûê">
<meta property="og:url" content="http://idiotsky.top/2018/07/28/java-concurrenthashmap/index.html">
<meta property="og:site_name" content="IdiotSky">
<meta property="og:description" content="Âè™Ââ©‰∏ãËøô‰∏™Ê≤°Êúâmark‰∫ÜÔºåÂÅèÂÅèËøôÊó∂ÂÄôÔºåÈù¢ËØïË¢´ÈóÆÂà∞ÔºåÊÇ≤Ââß‰∫Üüò¢  jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞ËÆæËÆ°ÊÄùË∑ØConcurrentHashMapÈááÁî®‰∫ÜÂàÜÊÆµÈîÅÁöÑËÆæËÆ°ÔºåÂè™ÊúâÂú®Âêå‰∏Ä‰∏™ÂàÜÊÆµÂÜÖÊâçÂ≠òÂú®Á´ûÊÄÅÂÖ≥Á≥ªÔºå‰∏çÂêåÁöÑÂàÜÊÆµÈîÅ‰πãÈó¥Ê≤°ÊúâÈîÅÁ´û‰∫â„ÄÇÁõ∏ÊØî‰∫éÂØπÊï¥‰∏™MapÂä†ÈîÅÁöÑËÆæËÆ°ÔºåÂàÜÊÆµÈîÅÂ§ßÂ§ßÁöÑÊèêÈ´ò‰∫ÜÈ´òÂπ∂ÂèëÁéØÂ¢É‰∏ãÁöÑÂ§ÑÁêÜËÉΩÂäõ„ÄÇ‰ΩÜÂêåÊó∂ÔºåÁî±‰∫é‰∏çÊòØÂØπÊï¥‰∏™MapÂä†ÈîÅÔºåÂØºËá¥‰∏Ä‰∫õÈúÄË¶ÅÊâ´ÊèèÊï¥‰∏™MapÁöÑÊñπÊ≥ïÔºàÂ¶Çsize(), containsValue">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg">
<meta property="og:updated_time" content="2018-09-13T12:06:17.276Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java ConcurrentHashMapËß£Êûê">
<meta name="twitter:description" content="Âè™Ââ©‰∏ãËøô‰∏™Ê≤°Êúâmark‰∫ÜÔºåÂÅèÂÅèËøôÊó∂ÂÄôÔºåÈù¢ËØïË¢´ÈóÆÂà∞ÔºåÊÇ≤Ââß‰∫Üüò¢  jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞ËÆæËÆ°ÊÄùË∑ØConcurrentHashMapÈááÁî®‰∫ÜÂàÜÊÆµÈîÅÁöÑËÆæËÆ°ÔºåÂè™ÊúâÂú®Âêå‰∏Ä‰∏™ÂàÜÊÆµÂÜÖÊâçÂ≠òÂú®Á´ûÊÄÅÂÖ≥Á≥ªÔºå‰∏çÂêåÁöÑÂàÜÊÆµÈîÅ‰πãÈó¥Ê≤°ÊúâÈîÅÁ´û‰∫â„ÄÇÁõ∏ÊØî‰∫éÂØπÊï¥‰∏™MapÂä†ÈîÅÁöÑËÆæËÆ°ÔºåÂàÜÊÆµÈîÅÂ§ßÂ§ßÁöÑÊèêÈ´ò‰∫ÜÈ´òÂπ∂ÂèëÁéØÂ¢É‰∏ãÁöÑÂ§ÑÁêÜËÉΩÂäõ„ÄÇ‰ΩÜÂêåÊó∂ÔºåÁî±‰∫é‰∏çÊòØÂØπÊï¥‰∏™MapÂä†ÈîÅÔºåÂØºËá¥‰∏Ä‰∫õÈúÄË¶ÅÊâ´ÊèèÊï¥‰∏™MapÁöÑÊñπÊ≥ïÔºàÂ¶Çsize(), containsValue">
<meta name="twitter:image" content="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '4C652JRMON',
      apiKey: 'ef468e206fb85903f33c4fc8b4bb2cd6',
      indexName: 'myblog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://idiotsky.top/2018/07/28/java-concurrenthashmap/"/>





  <title>java ConcurrentHashMapËß£Êûê | IdiotSky</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c2da852ee703ae71196b173fd6edef51";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IdiotSky</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            Books
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://idiotsky.top/2018/07/28/java-concurrenthashmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ejunjsh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars7.githubusercontent.com/u/22493186?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IdiotSky">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">java ConcurrentHashMapËß£Êûê</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-28T15:31:20+08:00">
                28 Jul 18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>Âè™Ââ©‰∏ãËøô‰∏™Ê≤°Êúâmark‰∫ÜÔºåÂÅèÂÅèËøôÊó∂ÂÄôÔºåÈù¢ËØïË¢´ÈóÆÂà∞ÔºåÊÇ≤Ââß‰∫Üüò¢</p>
</blockquote>
<h1 id="jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞"><a href="#jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞" class="headerlink" title="jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞"></a>jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞</h1><h2 id="ËÆæËÆ°ÊÄùË∑Ø"><a href="#ËÆæËÆ°ÊÄùË∑Ø" class="headerlink" title="ËÆæËÆ°ÊÄùË∑Ø"></a>ËÆæËÆ°ÊÄùË∑Ø</h2><p>ConcurrentHashMapÈááÁî®‰∫ÜÂàÜÊÆµÈîÅÁöÑËÆæËÆ°ÔºåÂè™ÊúâÂú®Âêå‰∏Ä‰∏™ÂàÜÊÆµÂÜÖÊâçÂ≠òÂú®Á´ûÊÄÅÂÖ≥Á≥ªÔºå‰∏çÂêåÁöÑÂàÜÊÆµÈîÅ‰πãÈó¥Ê≤°ÊúâÈîÅÁ´û‰∫â„ÄÇÁõ∏ÊØî‰∫éÂØπÊï¥‰∏™MapÂä†ÈîÅÁöÑËÆæËÆ°ÔºåÂàÜÊÆµÈîÅÂ§ßÂ§ßÁöÑÊèêÈ´ò‰∫ÜÈ´òÂπ∂ÂèëÁéØÂ¢É‰∏ãÁöÑÂ§ÑÁêÜËÉΩÂäõ„ÄÇ‰ΩÜÂêåÊó∂ÔºåÁî±‰∫é‰∏çÊòØÂØπÊï¥‰∏™MapÂä†ÈîÅÔºåÂØºËá¥‰∏Ä‰∫õÈúÄË¶ÅÊâ´ÊèèÊï¥‰∏™MapÁöÑÊñπÊ≥ïÔºàÂ¶Çsize(), containsValue()ÔºâÈúÄË¶Å‰ΩøÁî®ÁâπÊÆäÁöÑÂÆûÁé∞ÔºåÂè¶Â§ñ‰∏Ä‰∫õÊñπÊ≥ïÔºàÂ¶Çclear()ÔºâÁîöËá≥ÊîæÂºÉ‰∫ÜÂØπ‰∏ÄËá¥ÊÄßÁöÑË¶ÅÊ±ÇÔºàConcurrentHashMapÊòØÂº±‰∏ÄËá¥ÊÄßÁöÑÔºâ„ÄÇ</p>
<p>ConcurrentHashMap‰∏≠ÁöÑÂàÜÊÆµÈîÅÁß∞‰∏∫SegmentÔºåÂÆÉÂç≥Á±ª‰ºº‰∫éHashMapÁöÑÁªìÊûÑÔºåÂç≥ÂÜÖÈÉ®Êã•Êúâ‰∏Ä‰∏™EntryÊï∞ÁªÑÔºåÊï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÂèàÊòØ‰∏Ä‰∏™ÈìæË°®ÔºõÂêåÊó∂ÂèàÊòØ‰∏Ä‰∏™ReentrantLockÔºàSegmentÁªßÊâø‰∫ÜReentrantLockÔºâ„ÄÇConcurrentHashMap‰∏≠ÁöÑHashEntryÁõ∏ÂØπ‰∫éHashMap‰∏≠ÁöÑEntryÊúâ‰∏ÄÂÆöÁöÑÂ∑ÆÂºÇÊÄßÔºöHashEntry‰∏≠ÁöÑvalue‰ª•ÂèänextÈÉΩË¢´volatile‰øÆÈ•∞ÔºåËøôÊ†∑Âú®Â§öÁ∫øÁ®ãËØªÂÜôËøáÁ®ã‰∏≠ËÉΩÂ§ü‰øùÊåÅÂÆÉ‰ª¨ÁöÑÂèØËßÅÊÄßÔºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HashEntry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        <span class="keyword">volatile</span> V value;</span><br><span class="line">        <span class="keyword">volatile</span> HashEntry&lt;K,V&gt; next;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="Âπ∂ÂèëÂ∫¶ÔºàConcurrency-LevelÔºâ"><a href="#Âπ∂ÂèëÂ∫¶ÔºàConcurrency-LevelÔºâ" class="headerlink" title="Âπ∂ÂèëÂ∫¶ÔºàConcurrency LevelÔºâ"></a>Âπ∂ÂèëÂ∫¶ÔºàConcurrency LevelÔºâ</h2><p>Âπ∂ÂèëÂ∫¶ÂèØ‰ª•ÁêÜËß£‰∏∫Á®ãÂ∫èËøêË°åÊó∂ËÉΩÂ§üÂêåÊó∂Êõ¥Êñ∞ConccurentHashMap‰∏î‰∏ç‰∫ßÁîüÈîÅÁ´û‰∫âÁöÑÊúÄÂ§ßÁ∫øÁ®ãÊï∞ÔºåÂÆûÈôÖ‰∏äÂ∞±ÊòØConcurrentHashMap‰∏≠ÁöÑÂàÜÊÆµÈîÅ‰∏™Êï∞ÔºåÂç≥Segment[]ÁöÑÊï∞ÁªÑÈïøÂ∫¶„ÄÇConcurrentHashMapÈªòËÆ§ÁöÑÂπ∂ÂèëÂ∫¶‰∏∫16Ôºå‰ΩÜÁî®Êà∑‰πüÂèØ‰ª•Âú®ÊûÑÈÄ†ÂáΩÊï∞‰∏≠ËÆæÁΩÆÂπ∂ÂèëÂ∫¶„ÄÇÂΩìÁî®Êà∑ËÆæÁΩÆÂπ∂ÂèëÂ∫¶Êó∂ÔºåConcurrentHashMap‰ºö‰ΩøÁî®Â§ß‰∫éÁ≠â‰∫éËØ•ÂÄºÁöÑÊúÄÂ∞è2ÂπÇÊåáÊï∞‰Ωú‰∏∫ÂÆûÈôÖÂπ∂ÂèëÂ∫¶ÔºàÂÅáÂ¶ÇÁî®Êà∑ËÆæÁΩÆÂπ∂ÂèëÂ∫¶‰∏∫17ÔºåÂÆûÈôÖÂπ∂ÂèëÂ∫¶Âàô‰∏∫32Ôºâ„ÄÇËøêË°åÊó∂ÈÄöËøáÂ∞ÜkeyÁöÑÈ´òn‰ΩçÔºà<code>n = 32 ‚Äì segmentShift</code>ÔºâÂíåÂπ∂ÂèëÂ∫¶Âáè1ÔºàsegmentMaskÔºâÂÅö‰Ωç‰∏éËøêÁÆóÂÆö‰ΩçÂà∞ÊâÄÂú®ÁöÑSegment„ÄÇsegmentShift‰∏ésegmentMaskÈÉΩÊòØÂú®ÊûÑÈÄ†ËøáÁ®ã‰∏≠Ê†πÊçÆconcurrency levelË¢´Áõ∏Â∫îÁöÑËÆ°ÁÆóÂá∫Êù•„ÄÇ</p>
<p>Â¶ÇÊûúÂπ∂ÂèëÂ∫¶ËÆæÁΩÆÁöÑËøáÂ∞èÔºå‰ºöÂ∏¶Êù•‰∏•ÈáçÁöÑÈîÅÁ´û‰∫âÈóÆÈ¢òÔºõÂ¶ÇÊûúÂπ∂ÂèëÂ∫¶ËÆæÁΩÆÁöÑËøáÂ§ßÔºåÂéüÊú¨‰Ωç‰∫éÂêå‰∏Ä‰∏™SegmentÂÜÖÁöÑËÆøÈóÆ‰ºöÊâ©Êï£Âà∞‰∏çÂêåÁöÑSegment‰∏≠ÔºåCPU cacheÂëΩ‰∏≠Áéá‰ºö‰∏ãÈôçÔºå‰ªéËÄåÂºïËµ∑Á®ãÂ∫èÊÄßËÉΩ‰∏ãÈôç„ÄÇÔºàÊñáÊ°£ÁöÑËØ¥Ê≥ïÊòØÊ†πÊçÆ‰Ω†Âπ∂ÂèëÁöÑÁ∫øÁ®ãÊï∞ÈáèÂÜ≥ÂÆöÔºåÂ§™Â§ö‰ºöÂØºÊÄßËÉΩÈôç‰ΩéÔºâ</p>
<h2 id="ÂàõÂª∫ÂàÜÊÆµÈîÅ"><a href="#ÂàõÂª∫ÂàÜÊÆµÈîÅ" class="headerlink" title="ÂàõÂª∫ÂàÜÊÆµÈîÅ"></a>ÂàõÂª∫ÂàÜÊÆµÈîÅ</h2><p>ÂíåJDK6‰∏çÂêåÔºåJDK7‰∏≠Èô§‰∫ÜÁ¨¨‰∏Ä‰∏™Segment‰πãÂ§ñÔºåÂâ©‰ΩôÁöÑSegmentsÈááÁî®ÁöÑÊòØÂª∂ËøüÂàùÂßãÂåñÁöÑÊú∫Âà∂ÔºöÊØèÊ¨°put‰πãÂâçÈÉΩÈúÄË¶ÅÊ£ÄÊü•keyÂØπÂ∫îÁöÑSegmentÊòØÂê¶‰∏∫nullÔºåÂ¶ÇÊûúÊòØÂàôË∞ÉÁî®ensureSegment()‰ª•Á°Æ‰øùÂØπÂ∫îÁöÑSegmentË¢´ÂàõÂª∫„ÄÇ</p>
<p>ensureSegmentÂèØËÉΩÂú®Âπ∂ÂèëÁéØÂ¢É‰∏ãË¢´Ë∞ÉÁî®Ôºå‰ΩÜ‰∏éÊÉ≥Ë±°‰∏≠‰∏çÂêåÔºåensureSegmentÂπ∂Êú™‰ΩøÁî®ÈîÅÊù•ÊéßÂà∂Á´û‰∫âÔºåËÄåÊòØ‰ΩøÁî®‰∫ÜUnsafeÂØπË±°ÁöÑgetObjectVolatile()Êèê‰æõÁöÑÂéüÂ≠êËØªËØ≠‰πâÁªìÂêàCASÊù•Á°Æ‰øùSegmentÂàõÂª∫ÁöÑÂéüÂ≠êÊÄß„ÄÇ‰ª£Á†ÅÊÆµÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                == <span class="keyword">null</span>) &#123; <span class="comment">// recheck</span></span><br><span class="line">                Segment&lt;K,V&gt; s = <span class="keyword">new</span> Segment&lt;K,V&gt;(lf, threshold, tab);</span><br><span class="line">                <span class="keyword">while</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))</span><br><span class="line">                       == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(ss, u, <span class="keyword">null</span>, seg = s))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="put-putIfAbsent-putAll"><a href="#put-putIfAbsent-putAll" class="headerlink" title="put/putIfAbsent/putAll"></a>put/putIfAbsent/putAll</h2><p>ÂíåJDK6‰∏ÄÊ†∑ÔºåConcurrentHashMapÁöÑputÊñπÊ≥ïË¢´‰ª£ÁêÜÂà∞‰∫ÜÂØπÂ∫îÁöÑSegmentÔºàÂÆö‰ΩçSegmentÁöÑÂéüÁêÜ‰πãÂâçÂ∑≤ÁªèÊèèËø∞ËøáÔºâ‰∏≠„ÄÇ‰∏éJDK6‰∏çÂêåÁöÑÊòØÔºåJDK7ÁâàÊú¨ÁöÑConcurrentHashMapÂú®Ëé∑ÂæóSegmentÈîÅÁöÑËøáÁ®ã‰∏≠ÔºåÂÅö‰∫Ü‰∏ÄÂÆöÁöÑ‰ºòÂåñ - Âú®ÁúüÊ≠£Áî≥ËØ∑ÈîÅ‰πãÂâçÔºåputÊñπÊ≥ï‰ºöÈÄöËøátryLock()ÊñπÊ≥ïÂ∞ùËØïËé∑ÂæóÈîÅÔºåÂú®Â∞ùËØïËé∑ÂæóÈîÅÁöÑËøáÁ®ã‰∏≠‰ºöÂØπÂØπÂ∫îhashcodeÁöÑÈìæË°®ËøõË°åÈÅçÂéÜÔºåÂ¶ÇÊûúÈÅçÂéÜÂÆåÊØï‰ªçÁÑ∂Êâæ‰∏çÂà∞‰∏ékeyÁõ∏ÂêåÁöÑHashEntryËäÇÁÇπÔºåÂàô‰∏∫ÂêéÁª≠ÁöÑputÊìç‰ΩúÊèêÂâçÂàõÂª∫‰∏Ä‰∏™HashEntry„ÄÇÂΩìtryLock‰∏ÄÂÆöÊ¨°Êï∞Âêé‰ªçÊó†Ê≥ïËé∑ÂæóÈîÅÔºåÂàôÈÄöËøálockÁî≥ËØ∑ÈîÅ„ÄÇ</p>
<p>ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåÁî±‰∫éÂú®Âπ∂ÂèëÁéØÂ¢É‰∏ãÔºåÂÖ∂‰ªñÁ∫øÁ®ãÁöÑputÔºårehashÊàñËÄÖremoveÊìç‰ΩúÂèØËÉΩ‰ºöÂØºËá¥ÈìæË°®Â§¥ÁªìÁÇπÁöÑÂèòÂåñÔºåÂõ†Ê≠§Âú®ËøáÁ®ã‰∏≠ÈúÄË¶ÅËøõË°åÊ£ÄÊü•ÔºåÂ¶ÇÊûúÂ§¥ÁªìÁÇπÂèëÁîüÂèòÂåñÂàôÈáçÊñ∞ÂØπË°®ËøõË°åÈÅçÂéÜ„ÄÇËÄåÂ¶ÇÊûúÂÖ∂‰ªñÁ∫øÁ®ãÂºïËµ∑‰∫ÜÈìæË°®‰∏≠ÁöÑÊüê‰∏™ËäÇÁÇπË¢´Âà†Èô§ÔºåÂç≥‰ΩøËØ•ÂèòÂåñÂõ†‰∏∫ÊòØÈùûÂéüÂ≠êÂÜôÊìç‰ΩúÔºàÂà†Èô§ËäÇÁÇπÂêéÈìæÊé•ÂêéÁª≠ËäÇÁÇπË∞ÉÁî®ÁöÑÊòØUnsafe.putOrderedObject()ÔºåËØ•ÊñπÊ≥ï‰∏çÊèê‰æõÂéüÂ≠êÂÜôËØ≠‰πâÔºâÂèØËÉΩÂØºËá¥ÂΩìÂâçÁ∫øÁ®ãÊó†Ê≥ïËßÇÂØüÂà∞Ôºå‰ΩÜÂõ†‰∏∫‰∏çÂΩ±ÂìçÈÅçÂéÜÁöÑÊ≠£Á°ÆÊÄßÊâÄ‰ª•ÂøΩÁï•‰∏çËÆ°„ÄÇ</p>
<p>‰πãÊâÄ‰ª•Âú®Ëé∑ÂèñÈîÅÁöÑËøáÁ®ã‰∏≠ÂØπÊï¥‰∏™ÈìæË°®ËøõË°åÈÅçÂéÜÔºå‰∏ªË¶ÅÁõÆÁöÑÊòØÂ∏åÊúõÈÅçÂéÜÁöÑÈìæË°®Ë¢´CPU cacheÊâÄÁºìÂ≠òÔºå‰∏∫ÂêéÁª≠ÂÆûÈôÖputËøáÁ®ã‰∏≠ÁöÑÈìæË°®ÈÅçÂéÜÊìç‰ΩúÊèêÂçáÊÄßËÉΩ„ÄÇ</p>
<p>Âú®Ëé∑ÂæóÈîÅ‰πãÂêéÔºåSegmentÂØπÈìæË°®ËøõË°åÈÅçÂéÜÔºåÂ¶ÇÊûúÊüê‰∏™HashEntryËäÇÁÇπÂÖ∑ÊúâÁõ∏ÂêåÁöÑkeyÔºåÂàôÊõ¥Êñ∞ËØ•HashEntryÁöÑvalueÂÄºÔºåÂê¶ÂàôÊñ∞Âª∫‰∏Ä‰∏™HashEntryËäÇÁÇπÔºåÂ∞ÜÂÆÉËÆæÁΩÆ‰∏∫ÈìæË°®ÁöÑÊñ∞headËäÇÁÇπÂπ∂Â∞ÜÂéüÂ§¥ËäÇÁÇπËÆæ‰∏∫Êñ∞headÁöÑ‰∏ã‰∏Ä‰∏™ËäÇÁÇπ„ÄÇÊñ∞Âª∫ËøáÁ®ã‰∏≠Â¶ÇÊûúËäÇÁÇπÊÄªÊï∞ÔºàÂê´Êñ∞Âª∫ÁöÑHashEntryÔºâË∂ÖËøáthresholdÔºåÂàôË∞ÉÁî®rehash()ÊñπÊ≥ïÂØπSegmentËøõË°åÊâ©ÂÆπÔºåÊúÄÂêéÂ∞ÜÊñ∞Âª∫HashEntryÂÜôÂÖ•Âà∞Êï∞ÁªÑ‰∏≠„ÄÇ</p>
<p>putÊñπÊ≥ï‰∏≠ÔºåÈìæÊé•Êñ∞ËäÇÁÇπÁöÑ‰∏ã‰∏Ä‰∏™ËäÇÁÇπÔºàHashEntry.setNext()Ôºâ‰ª•ÂèäÂ∞ÜÈìæË°®ÂÜôÂÖ•Âà∞Êï∞ÁªÑ‰∏≠ÔºàsetEntryAt()ÔºâÈÉΩÊòØÈÄöËøáUnsafeÁöÑputOrderedObject()ÊñπÊ≥ïÊù•ÂÆûÁé∞ÔºåËøôÈáåÂπ∂Êú™‰ΩøÁî®ÂÖ∑ÊúâÂéüÂ≠êÂÜôËØ≠‰πâÁöÑputObjectVolatile()ÁöÑÂéüÂõ†ÊòØÔºöJMM‰ºö‰øùËØÅËé∑ÂæóÈîÅÂà∞ÈáäÊîæÈîÅ‰πãÈó¥ÊâÄÊúâÂØπË±°ÁöÑÁä∂ÊÄÅÊõ¥Êñ∞ÈÉΩ‰ºöÂú®ÈîÅË¢´ÈáäÊîæ‰πãÂêéÊõ¥Êñ∞Âà∞‰∏ªÂ≠òÔºå‰ªéËÄå‰øùËØÅËøô‰∫õÂèòÊõ¥ÂØπÂÖ∂‰ªñÁ∫øÁ®ãÊòØÂèØËßÅÁöÑ„ÄÇ</p>
<h2 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h2><p>Áõ∏ÂØπ‰∫éHashMapÁöÑresizeÔºåConcurrentHashMapÁöÑrehashÂéüÁêÜÁ±ª‰ººÔºå‰ΩÜÊòØDoug Lea‰∏∫rehashÂÅö‰∫Ü‰∏ÄÂÆöÁöÑ‰ºòÂåñÔºåÈÅøÂÖçËÆ©ÊâÄÊúâÁöÑËäÇÁÇπÈÉΩËøõË°åÂ§çÂà∂Êìç‰ΩúÔºöÁî±‰∫éÊâ©ÂÆπÊòØÂü∫‰∫é2ÁöÑÂπÇÊåáÊù•Êìç‰ΩúÔºåÂÅáËÆæÊâ©ÂÆπÂâçÊüêHashEntryÂØπÂ∫îÂà∞Segment‰∏≠Êï∞ÁªÑÁöÑindex‰∏∫iÔºåÊï∞ÁªÑÁöÑÂÆπÈáè‰∏∫capacityÔºåÈÇ£‰πàÊâ©ÂÆπÂêéËØ•HashEntryÂØπÂ∫îÂà∞Êñ∞Êï∞ÁªÑ‰∏≠ÁöÑindexÂè™ÂèØËÉΩ‰∏∫iÊàñËÄÖi+capacityÔºåÂõ†Ê≠§Â§ßÂ§öÊï∞HashEntryËäÇÁÇπÂú®Êâ©ÂÆπÂâçÂêéindexÂèØ‰ª•‰øùÊåÅ‰∏çÂèò„ÄÇÂü∫‰∫éÊ≠§ÔºårehashÊñπÊ≥ï‰∏≠‰ºöÂÆö‰ΩçÁ¨¨‰∏Ä‰∏™ÂêéÁª≠ÊâÄÊúâËäÇÁÇπÂú®Êâ©ÂÆπÂêéindexÈÉΩ‰øùÊåÅ‰∏çÂèòÁöÑËäÇÁÇπÔºåÁÑ∂ÂêéÂ∞ÜËøô‰∏™ËäÇÁÇπ‰πãÂâçÁöÑÊâÄÊúâËäÇÁÇπÈáçÊéíÂç≥ÂèØ„ÄÇËøôÈÉ®ÂàÜ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rehash</span><span class="params">(HashEntry&lt;K,V&gt; node)</span> </span>&#123;</span><br><span class="line">           HashEntry&lt;K,V&gt;[] oldTable = table;</span><br><span class="line">           <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">           <span class="keyword">int</span> newCapacity = oldCapacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">           threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor);</span><br><span class="line">           HashEntry&lt;K,V&gt;[] newTable =</span><br><span class="line">               (HashEntry&lt;K,V&gt;[]) <span class="keyword">new</span> HashEntry[newCapacity];</span><br><span class="line">           <span class="keyword">int</span> sizeMask = newCapacity - <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; oldCapacity ; i++) &#123;</span><br><span class="line">               HashEntry&lt;K,V&gt; e = oldTable[i];</span><br><span class="line">               <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   HashEntry&lt;K,V&gt; next = e.next;</span><br><span class="line">                   <span class="keyword">int</span> idx = e.hash &amp; sizeMask;</span><br><span class="line">                   <span class="keyword">if</span> (next == <span class="keyword">null</span>)   <span class="comment">//  Single node on list</span></span><br><span class="line">                       newTable[idx] = e;</span><br><span class="line">                   <span class="keyword">else</span> &#123; <span class="comment">// Reuse consecutive sequence at same slot</span></span><br><span class="line">                       HashEntry&lt;K,V&gt; lastRun = e;</span><br><span class="line">                       <span class="keyword">int</span> lastIdx = idx;</span><br><span class="line">                       <span class="keyword">for</span> (HashEntry&lt;K,V&gt; last = next;</span><br><span class="line">                            last != <span class="keyword">null</span>;</span><br><span class="line">                            last = last.next) &#123;</span><br><span class="line">                           <span class="keyword">int</span> k = last.hash &amp; sizeMask;</span><br><span class="line">                           <span class="keyword">if</span> (k != lastIdx) &#123;</span><br><span class="line">                               lastIdx = k;</span><br><span class="line">                               lastRun = last;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       newTable[lastIdx] = lastRun;</span><br><span class="line">                       <span class="comment">// Clone remaining nodes</span></span><br><span class="line">                       <span class="keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;</span><br><span class="line">                           V v = p.value;</span><br><span class="line">                           <span class="keyword">int</span> h = p.hash;</span><br><span class="line">                           <span class="keyword">int</span> k = h &amp; sizeMask;</span><br><span class="line">                           HashEntry&lt;K,V&gt; n = newTable[k];</span><br><span class="line">                           newTable[k] = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(h, p.key, v, n);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">int</span> nodeIndex = node.hash &amp; sizeMask; <span class="comment">// add the new node</span></span><br><span class="line">           node.setNext(newTable[nodeIndex]);</span><br><span class="line">           newTable[nodeIndex] = node;</span><br><span class="line">           table = newTable;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><p>ÂíåputÁ±ª‰ººÔºåremoveÂú®ÁúüÊ≠£Ëé∑ÂæóÈîÅ‰πãÂâçÔºå‰πü‰ºöÂØπÈìæË°®ËøõË°åÈÅçÂéÜ‰ª•ÊèêÈ´òÁºìÂ≠òÂëΩ‰∏≠Áéá„ÄÇ</p>
<h2 id="get‰∏écontainsKey"><a href="#get‰∏écontainsKey" class="headerlink" title="get‰∏écontainsKey"></a>get‰∏écontainsKey</h2><p><code>get</code>‰∏é<code>containsKey</code>‰∏§‰∏™ÊñπÊ≥ïÂá†‰πéÂÆåÂÖ®‰∏ÄËá¥Ôºö‰ªñ‰ª¨ÈÉΩÊ≤°Êúâ‰ΩøÁî®ÈîÅÔºåËÄåÊòØÈÄöËøáUnsafeÂØπË±°ÁöÑ<code>getObjectVolatile()</code>ÊñπÊ≥ïÊèê‰æõÁöÑÂéüÂ≠êËØªËØ≠‰πâÔºåÊù•Ëé∑ÂæóSegment‰ª•ÂèäÂØπÂ∫îÁöÑÈìæË°®ÔºåÁÑ∂ÂêéÂØπÈìæË°®ÈÅçÂéÜÂà§Êñ≠ÊòØÂê¶Â≠òÂú®keyÁõ∏ÂêåÁöÑËäÇÁÇπ‰ª•ÂèäËé∑ÂæóËØ•ËäÇÁÇπÁöÑvalue„ÄÇ‰ΩÜÁî±‰∫éÈÅçÂéÜËøáÁ®ã‰∏≠ÂÖ∂‰ªñÁ∫øÁ®ãÂèØËÉΩÂØπÈìæË°®ÁªìÊûÑÂÅö‰∫ÜË∞ÉÊï¥ÔºåÂõ†Ê≠§<code>get</code>Âíå<code>containsKey</code>ËøîÂõûÁöÑÂèØËÉΩÊòØËøáÊó∂ÁöÑÊï∞ÊçÆÔºåËøô‰∏ÄÁÇπÊòØConcurrentHashMapÂú®Âº±‰∏ÄËá¥ÊÄß‰∏äÁöÑ‰ΩìÁé∞„ÄÇÂ¶ÇÊûúË¶ÅÊ±ÇÂº∫‰∏ÄËá¥ÊÄßÔºåÈÇ£‰πàÂøÖÈ°ª‰ΩøÁî®<code>Collections.synchronizedMap()</code>ÊñπÊ≥ï„ÄÇ</p>
<h2 id="size„ÄÅcontainsValue"><a href="#size„ÄÅcontainsValue" class="headerlink" title="size„ÄÅcontainsValue"></a>size„ÄÅcontainsValue</h2><p>Ëøô‰∫õÊñπÊ≥ïÈÉΩÊòØÂü∫‰∫éÊï¥‰∏™ConcurrentHashMapÊù•ËøõË°åÊìç‰ΩúÁöÑÔºå‰ªñ‰ª¨ÁöÑÂéüÁêÜ‰πüÂü∫Êú¨Á±ª‰ººÔºöÈ¶ñÂÖà‰∏çÂä†ÈîÅÂæ™ÁéØÊâßË°å‰ª•‰∏ãÊìç‰ΩúÔºöÂæ™ÁéØÊâÄÊúâÁöÑSegmentÔºàÈÄöËøáUnsafeÁöÑgetObjectVolatile()‰ª•‰øùËØÅÂéüÂ≠êËØªËØ≠‰πâÔºâÔºåËé∑ÂæóÂØπÂ∫îÁöÑÂÄº‰ª•ÂèäÊâÄÊúâSegmentÁöÑmodcount‰πãÂíå„ÄÇÂ¶ÇÊûúËøûÁª≠‰∏§Ê¨°ÊâÄÊúâSegmentÁöÑmodcountÂíåÁõ∏Á≠âÔºåÂàôËøáÁ®ã‰∏≠Ê≤°ÊúâÂèëÁîüÂÖ∂‰ªñÁ∫øÁ®ã‰øÆÊîπConcurrentHashMapÁöÑÊÉÖÂÜµÔºåËøîÂõûËé∑ÂæóÁöÑÂÄº„ÄÇ</p>
<p>ÂΩìÂæ™ÁéØÊ¨°Êï∞Ë∂ÖËøáÈ¢ÑÂÆö‰πâÁöÑÂÄºÊó∂ÔºåËøôÊó∂ÈúÄË¶ÅÂØπÊâÄÊúâÁöÑSegment‰æùÊ¨°ËøõË°åÂä†ÈîÅÔºåËé∑ÂèñËøîÂõûÂÄºÂêéÂÜç‰æùÊ¨°Ëß£ÈîÅ„ÄÇÂÄºÂæóÊ≥®ÊÑèÁöÑÊòØÔºåÂä†ÈîÅËøáÁ®ã‰∏≠Ë¶ÅÂº∫Âà∂ÂàõÂª∫ÊâÄÊúâÁöÑSegmentÔºåÂê¶ÂàôÂÆπÊòìÂá∫Áé∞ÂÖ∂‰ªñÁ∫øÁ®ãÂàõÂª∫SegmentÂπ∂ËøõË°åputÔºåremoveÁ≠âÊìç‰Ωú„ÄÇ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j =<span class="number">0</span>; j &lt; segments.length; ++j)</span><br><span class="line"></span><br><span class="line">ensureSegment(j).lock();<span class="comment">// force creation</span></span><br></pre></td></tr></table></figure></p>
<p>‰∏ÄËà¨Êù•ËØ¥ÔºåÂ∫îËØ•ÈÅøÂÖçÂú®Â§öÁ∫øÁ®ãÁéØÂ¢É‰∏ã‰ΩøÁî®sizeÂíåcontainsValueÊñπÊ≥ï„ÄÇ</p>
<p>Ê≥®1ÔºömodcountÂú®put, replace, remove‰ª•ÂèäclearÁ≠âÊñπÊ≥ï‰∏≠ÈÉΩ‰ºöË¢´‰øÆÊîπ„ÄÇ</p>
<p>Ê≥®2ÔºöÂØπ‰∫écontainsValueÊñπÊ≥ïÊù•ËØ¥ÔºåÂ¶ÇÊûúÂú®Âæ™ÁéØËøáÁ®ã‰∏≠ÂèëÁé∞ÂåπÈÖçvalueÁöÑHashEntryÔºåÂàôÁõ¥Êé•ËøîÂõûtrue„ÄÇ</p>
<p>ÊúÄÂêéÔºå‰∏éHashMap‰∏çÂêåÁöÑÊòØÔºåConcurrentHashMapÂπ∂‰∏çÂÖÅËÆ∏keyÊàñËÄÖvalue‰∏∫nullÔºåÊåâÁÖßDoug LeaÁöÑËØ¥Ê≥ïÔºåËøô‰πàËÆæËÆ°ÁöÑÂéüÂõ†ÊòØÂú®ConcurrentHashMap‰∏≠Ôºå‰∏ÄÊó¶valueÂá∫Áé∞nullÔºåÂàô‰ª£Ë°®HashEntryÁöÑkey/valueÊ≤°ÊúâÊò†Â∞ÑÂÆåÊàêÂ∞±Ë¢´ÂÖ∂‰ªñÁ∫øÁ®ãÊâÄËßÅÔºåÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ„ÄÇÂú®JDK6‰∏≠ÔºågetÊñπÊ≥ïÁöÑÂÆûÁé∞‰∏≠Â∞±Êúâ‰∏ÄÊÆµÂØπHashEntry.value == nullÁöÑÈò≤Âæ°ÊÄßÂà§Êñ≠„ÄÇ‰ΩÜDoug Lea‰πüÊâøËÆ§ÂÆûÈôÖËøêË°åËøáÁ®ã‰∏≠ÔºåËøôÁßçÊÉÖÂÜµ‰ºº‰πé‰∏çÂèØËÉΩÂèëÁîü</p>
<hr>
<h1 id="JDK8‰∏≠ÁöÑÂÆûÁé∞"><a href="#JDK8‰∏≠ÁöÑÂÆûÁé∞" class="headerlink" title="JDK8‰∏≠ÁöÑÂÆûÁé∞"></a>JDK8‰∏≠ÁöÑÂÆûÁé∞</h1><p>ConcurrentHashMapÂú®JDK8‰∏≠ËøõË°å‰∫ÜÂ∑®Â§ßÊîπÂä®ÔºåÂæàÈúÄË¶ÅÈÄöËøáÊ∫êÁ†ÅÊù•ÂÜçÊ¨°Â≠¶‰π†‰∏ãDoug LeaÁöÑÂÆûÁé∞ÊñπÊ≥ï„ÄÇ</p>
<p>ÂÆÉÊëíÂºÉ‰∫ÜSegmentÔºàÈîÅÊÆµÔºâÁöÑÊ¶ÇÂøµÔºåËÄåÊòØÂêØÁî®‰∫Ü‰∏ÄÁßçÂÖ®Êñ∞ÁöÑÊñπÂºèÂÆûÁé∞,Âà©Áî®CASÁÆóÊ≥ï„ÄÇÂÆÉÊ≤øÁî®‰∫Ü‰∏éÂÆÉÂêåÊó∂ÊúüÁöÑHashMapÁâàÊú¨ÁöÑÊÄùÊÉ≥ÔºåÂ∫ïÂ±Ç‰æùÁÑ∂Áî±‚ÄúÊï∞ÁªÑ‚Äù+ÈìæË°®+Á∫¢ÈªëÊ†ëÁöÑÊñπÂºèÊÄùÊÉ≥Ôºå‰ΩÜÊòØ‰∏∫‰∫ÜÂÅöÂà∞Âπ∂ÂèëÔºåÂèàÂ¢ûÂä†‰∫ÜÂæàÂ§öËæÖÂä©ÁöÑÁ±ªÔºå‰æãÂ¶ÇTreeBinÔºåTraverserÁ≠âÂØπË±°ÂÜÖÈÉ®Á±ª„ÄÇ</p>
<h2 id="ÈáçË¶ÅÁöÑÂ±ûÊÄß"><a href="#ÈáçË¶ÅÁöÑÂ±ûÊÄß" class="headerlink" title="ÈáçË¶ÅÁöÑÂ±ûÊÄß"></a>ÈáçË¶ÅÁöÑÂ±ûÊÄß</h2><p>È¶ñÂÖàÊù•ÁúãÂá†‰∏™ÈáçË¶ÅÁöÑÂ±ûÊÄßÔºå‰∏éHashMapÁõ∏ÂêåÁöÑÂ∞±‰∏çÂÜç‰ªãÁªç‰∫ÜÔºåËøôÈáåÈáçÁÇπËß£Èáä‰∏Ä‰∏ãsizeCtlËøô‰∏™Â±ûÊÄß„ÄÇÂèØ‰ª•ËØ¥ÂÆÉÊòØConcurrentHashMap‰∏≠Âá∫ÈïúÁéáÂæàÈ´òÁöÑ‰∏Ä‰∏™Â±ûÊÄßÔºåÂõ†‰∏∫ÂÆÉÊòØ‰∏Ä‰∏™ÊéßÂà∂Ê†áËØÜÁ¨¶ÔºåÂú®‰∏çÂêåÁöÑÂú∞ÊñπÊúâ‰∏çÂêåÁî®ÈÄîÔºåËÄå‰∏îÂÆÉÁöÑÂèñÂÄº‰∏çÂêåÔºå‰πü‰ª£Ë°®‰∏çÂêåÁöÑÂê´‰πâ„ÄÇ</p>
<ul>
<li>Ë¥üÊï∞‰ª£Ë°®Ê≠£Âú®ËøõË°åÂàùÂßãÂåñÊàñÊâ©ÂÆπÊìç‰Ωú</li>
<li>-1‰ª£Ë°®Ê≠£Âú®ÂàùÂßãÂåñ</li>
<li>-N Ë°®Á§∫ÊúâN-1‰∏™Á∫øÁ®ãÊ≠£Âú®ËøõË°åÊâ©ÂÆπÊìç‰Ωú</li>
<li>Ê≠£Êï∞Êàñ0‰ª£Ë°®hashË°®ËøòÊ≤°ÊúâË¢´ÂàùÂßãÂåñÔºåËøô‰∏™Êï∞ÂÄºË°®Á§∫ÂàùÂßãÂåñÊàñ‰∏ã‰∏ÄÊ¨°ËøõË°åÊâ©ÂÆπÁöÑÂ§ßÂ∞èÔºåËøô‰∏ÄÁÇπÁ±ª‰ºº‰∫éÊâ©ÂÆπÈòàÂÄºÁöÑÊ¶ÇÂøµ„ÄÇËøòÂêéÈù¢ÂèØ‰ª•ÁúãÂà∞ÔºåÂÆÉÁöÑÂÄºÂßãÁªàÊòØÂΩìÂâçConcurrentHashMapÂÆπÈáèÁöÑ0.75ÂÄçÔºåËøô‰∏éloadfactorÊòØÂØπÂ∫îÁöÑ„ÄÇ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ÁõõË£ÖNodeÂÖÉÁ¥†ÁöÑÊï∞ÁªÑ ÂÆÉÁöÑÂ§ßÂ∞èÊòØ2ÁöÑÊï¥Êï∞Ê¨°ÂπÇ</span></span><br><span class="line"><span class="comment">     * Size is always a power of two. Accessed directly by iterators.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table initialization and resizing control.  When negative, the</span></span><br><span class="line"><span class="comment">     * table is being initialized or resized: -1 for initialization,</span></span><br><span class="line"><span class="comment">     * else -(1 + the number of active resizing threads).  Otherwise,</span></span><br><span class="line"><span class="comment">     * when table is null, holds the initial table size to use upon</span></span><br><span class="line"><span class="comment">     * creation, or 0 for default. After initialization, holds the</span></span><br><span class="line"><span class="comment">     * next element count value upon which to resize the table.</span></span><br><span class="line"><span class="comment">     hashË°®ÂàùÂßãÂåñÊàñÊâ©ÂÆπÊó∂ÁöÑ‰∏Ä‰∏™ÊéßÂà∂‰ΩçÊ†áËØÜÈáè„ÄÇ</span></span><br><span class="line"><span class="comment">     Ë¥üÊï∞‰ª£Ë°®Ê≠£Âú®ËøõË°åÂàùÂßãÂåñÊàñÊâ©ÂÆπÊìç‰Ωú</span></span><br><span class="line"><span class="comment">     -1‰ª£Ë°®Ê≠£Âú®ÂàùÂßãÂåñ</span></span><br><span class="line"><span class="comment">     -N Ë°®Á§∫ÊúâN-1‰∏™Á∫øÁ®ãÊ≠£Âú®ËøõË°åÊâ©ÂÆπÊìç‰Ωú</span></span><br><span class="line"><span class="comment">     Ê≠£Êï∞Êàñ0‰ª£Ë°®hashË°®ËøòÊ≤°ÊúâË¢´ÂàùÂßãÂåñÔºåËøô‰∏™Êï∞ÂÄºË°®Á§∫ÂàùÂßãÂåñÊàñ‰∏ã‰∏ÄÊ¨°ËøõË°åÊâ©ÂÆπÁöÑÂ§ßÂ∞è</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl; </span><br><span class="line">    <span class="comment">// ‰ª•‰∏ã‰∏§‰∏™ÊòØÁî®Êù•ÊéßÂà∂Êâ©ÂÆπÁöÑÊó∂ÂÄô ÂçïÁ∫øÁ®ãËøõÂÖ•ÁöÑÂèòÈáè</span></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of bits used for generation stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     * Must be at least 6 for 32bit arrays.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> RESIZE_STAMP_BITS = <span class="number">16</span>;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The bit shift for recording size stamp in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESIZE_STAMP_SHIFT = <span class="number">32</span> - RESIZE_STAMP_BITS;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Encodings for Node hash fields. See above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hashÂÄºÊòØ-1ÔºåË°®Á§∫ËøôÊòØ‰∏Ä‰∏™forwardNodeËäÇÁÇπ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hashÂÄºÊòØ-2  Ë°®Á§∫ËøôÊó∂‰∏Ä‰∏™TreeBinËäÇÁÇπ</span></span><br></pre></td></tr></table></figure>
<h2 id="ÈáçË¶ÅÁöÑÁ±ª"><a href="#ÈáçË¶ÅÁöÑÁ±ª" class="headerlink" title="ÈáçË¶ÅÁöÑÁ±ª"></a>ÈáçË¶ÅÁöÑÁ±ª</h2><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>NodeÊòØÊúÄÊ†∏ÂøÉÁöÑÂÜÖÈÉ®Á±ªÔºåÂÆÉÂåÖË£Ö‰∫Ükey-valueÈîÆÂÄºÂØπÔºåÊâÄÊúâÊèíÂÖ•ConcurrentHashMapÁöÑÊï∞ÊçÆÈÉΩÂåÖË£ÖÂú®ËøôÈáåÈù¢„ÄÇÂÆÉ‰∏éHashMap‰∏≠ÁöÑÂÆö‰πâÂæàÁõ∏‰ººÔºå‰ΩÜÊòØ‰ΩÜÊòØÊúâ‰∏Ä‰∫õÂ∑ÆÂà´ÂÆÉÂØπvalueÂíånextÂ±ûÊÄßËÆæÁΩÆ‰∫ÜvolatileÂêåÊ≠•ÈîÅ(‰∏éJDK7ÁöÑSegmentÁõ∏Âêå)ÔºåÂÆÉ‰∏çÂÖÅËÆ∏Ë∞ÉÁî®setValueÊñπÊ≥ïÁõ¥Êé•ÊîπÂèòNodeÁöÑvalueÂüüÔºåÂÆÉÂ¢ûÂä†‰∫ÜfindÊñπÊ≥ïËæÖÂä©map.get()ÊñπÊ≥ï„ÄÇ</p>
<h3 id="TreeNode"><a href="#TreeNode" class="headerlink" title="TreeNode"></a>TreeNode</h3><p>Ê†ëËäÇÁÇπÁ±ªÔºåÂè¶Â§ñ‰∏Ä‰∏™Ê†∏ÂøÉÁöÑÊï∞ÊçÆÁªìÊûÑ„ÄÇÂΩìÈìæË°®ÈïøÂ∫¶ËøáÈïøÁöÑÊó∂ÂÄôÔºå‰ºöËΩ¨Êç¢‰∏∫TreeNode„ÄÇ‰ΩÜÊòØ‰∏éHashMap‰∏çÁõ∏ÂêåÁöÑÊòØÔºåÂÆÉÂπ∂‰∏çÊòØÁõ¥Êé•ËΩ¨Êç¢‰∏∫Á∫¢ÈªëÊ†ëÔºåËÄåÊòØÊääËøô‰∫õÁªìÁÇπÂåÖË£ÖÊàêTreeNodeÊîæÂú®TreeBinÂØπË±°‰∏≠ÔºåÁî±TreeBinÂÆåÊàêÂØπÁ∫¢ÈªëÊ†ëÁöÑÂåÖË£Ö„ÄÇËÄå‰∏îTreeNodeÂú®ConcurrentHashMapÈõÜÊàêËá™NodeÁ±ªÔºåËÄåÂπ∂ÈùûHashMap‰∏≠ÁöÑÈõÜÊàêËá™LinkedHashMap.Entry&lt;K,V&gt;Á±ªÔºå‰πüÂ∞±ÊòØËØ¥TreeNodeÂ∏¶ÊúânextÊåáÈíàÔºåËøôÊ†∑ÂÅöÁöÑÁõÆÁöÑÊòØÊñπ‰æøÂü∫‰∫éTreeBinÁöÑËÆøÈóÆ„ÄÇ</p>
<h3 id="TreeBin"><a href="#TreeBin" class="headerlink" title="TreeBin"></a>TreeBin</h3><p>Ëøô‰∏™Á±ªÂπ∂‰∏çË¥üË¥£ÂåÖË£ÖÁî®Êà∑ÁöÑkey„ÄÅvalue‰ø°ÊÅØÔºåËÄåÊòØÂåÖË£ÖÁöÑÂæàÂ§öTreeNodeËäÇÁÇπ„ÄÇÂÆÉ‰ª£Êõø‰∫ÜTreeNodeÁöÑÊ†πËäÇÁÇπÔºå‰πüÂ∞±ÊòØËØ¥Âú®ÂÆûÈôÖÁöÑConcurrentHashMap‚ÄúÊï∞ÁªÑ‚Äù‰∏≠ÔºåÂ≠òÊîæÁöÑÊòØTreeBinÂØπË±°ÔºåËÄå‰∏çÊòØTreeNodeÂØπË±°ÔºåËøôÊòØ‰∏éHashMapÁöÑÂå∫Âà´„ÄÇÂè¶Â§ñËøô‰∏™Á±ªËøòÂ∏¶Êúâ‰∫ÜËØªÂÜôÈîÅ„ÄÇ</p>
<p>ËøôÈáå‰ªÖË¥¥Âá∫ÂÆÉÁöÑÊûÑÈÄ†ÊñπÊ≥ï„ÄÇÂèØ‰ª•ÁúãÂà∞Âú®ÊûÑÈÄ†TreeBinËäÇÁÇπÊó∂Ôºå‰ªÖ‰ªÖÊåáÂÆö‰∫ÜÂÆÉÁöÑhashÂÄº‰∏∫TREEBINÂ∏∏ÈáèÔºåËøô‰πüÂ∞±ÊòØ‰∏™Ê†áËØÜ‰∏∫„ÄÇÂêåÊó∂‰πüÁúãÂà∞Êàë‰ª¨ÁÜüÊÇâÁöÑÁ∫¢ÈªëÊ†ëÊûÑÈÄ†ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Creates bin with initial set of nodes headed by b.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        TreeBin(TreeNode&lt;K,V&gt; b) &#123;</span><br><span class="line">            <span class="keyword">super</span>(TREEBIN, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.first = b;</span><br><span class="line">            TreeNode&lt;K,V&gt; r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; x = b, next; x != <span class="keyword">null</span>; x = next) &#123;</span><br><span class="line">                next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">                x.left = x.right = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    x.parent = <span class="keyword">null</span>;</span><br><span class="line">                    x.red = <span class="keyword">false</span>;</span><br><span class="line">                    r = x;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    K k = x.key;</span><br><span class="line">                    <span class="keyword">int</span> h = x.hash;</span><br><span class="line">                    Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = r;;) &#123;</span><br><span class="line">                        <span class="keyword">int</span> dir, ph;</span><br><span class="line">                        K pk = p.key;</span><br><span class="line">                        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                            dir = -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                            dir = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                  (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                                 (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>)</span><br><span class="line">                            dir = tieBreakOrder(k, pk);</span><br><span class="line">                            TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            x.parent = xp;</span><br><span class="line">                            <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                                xp.left = x;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                xp.right = x;</span><br><span class="line">                            r = balanceInsertion(r, x);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.root = r;</span><br><span class="line">            <span class="function"><span class="keyword">assert</span> <span class="title">checkInvariants</span><span class="params">(root)</span></span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ForwardingNode"><a href="#ForwardingNode" class="headerlink" title="ForwardingNode"></a>ForwardingNode</h3><p>‰∏Ä‰∏™Áî®‰∫éËøûÊé•‰∏§‰∏™tableÁöÑËäÇÁÇπÁ±ª„ÄÇÂÆÉÂåÖÂê´‰∏Ä‰∏™nextTableÊåáÈíàÔºåÁî®‰∫éÊåáÂêë‰∏ã‰∏ÄÂº†Ë°®„ÄÇËÄå‰∏îËøô‰∏™ËäÇÁÇπÁöÑkey value nextÊåáÈíàÂÖ®ÈÉ®‰∏∫nullÔºåÂÆÉÁöÑhashÂÄº‰∏∫-1. ËøôÈáåÈù¢ÂÆö‰πâÁöÑfindÁöÑÊñπÊ≥ïÊòØ‰ªénextTableÈáåËøõË°åÊü•ËØ¢ËäÇÁÇπÔºåËÄå‰∏çÊòØ‰ª•Ëá™Ë∫´‰∏∫Â§¥ËäÇÁÇπËøõË°åÊü•Êâæ„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A node inserted at head of bins during transfer operations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">        ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">            <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// loop to avoid arbitrarily deep recursion on forwarding nodes</span></span><br><span class="line">            outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;) &#123;</span><br><span class="line">                Node&lt;K,V&gt; e; <span class="keyword">int</span> n;</span><br><span class="line">                <span class="keyword">if</span> (k == <span class="keyword">null</span> || tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">                    (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    <span class="keyword">int</span> eh; K ek;</span><br><span class="line">                    <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp;</span><br><span class="line">                        ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                        <span class="keyword">return</span> e;</span><br><span class="line">                    <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                            tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                            <span class="keyword">continue</span> outer;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Unsafe‰∏éCAS"><a href="#Unsafe‰∏éCAS" class="headerlink" title="Unsafe‰∏éCAS"></a>Unsafe‰∏éCAS</h2><p>Âú®ConcurrentHashMap‰∏≠ÔºåÈöèÂ§ÑÂèØ‰ª•ÁúãÂà∞<code>U</code>, Â§ßÈáè‰ΩøÁî®‰∫Ü<code>U.compareAndSwapXXX</code>ÁöÑÊñπÊ≥ïÔºåËøô‰∏™ÊñπÊ≥ïÊòØÂà©Áî®‰∏Ä‰∏™CASÁÆóÊ≥ïÂÆûÁé∞Êó†ÈîÅÂåñÁöÑ‰øÆÊîπÂÄºÁöÑÊìç‰ΩúÔºå‰ªñÂèØ‰ª•Â§ßÂ§ßÈôç‰ΩéÈîÅ‰ª£ÁêÜÁöÑÊÄßËÉΩÊ∂àËÄó„ÄÇËøô‰∏™ÁÆóÊ≥ïÁöÑÂü∫Êú¨ÊÄùÊÉ≥Â∞±ÊòØ‰∏çÊñ≠Âú∞ÂéªÊØîËæÉÂΩìÂâçÂÜÖÂ≠ò‰∏≠ÁöÑÂèòÈáèÂÄº‰∏é‰Ω†ÊåáÂÆöÁöÑ‰∏Ä‰∏™ÂèòÈáèÂÄºÊòØÂê¶Áõ∏Á≠âÔºåÂ¶ÇÊûúÁõ∏Á≠âÔºåÂàôÊé•Âèó‰Ω†ÊåáÂÆöÁöÑ‰øÆÊîπÁöÑÂÄºÔºåÂê¶ÂàôÊãíÁªù‰Ω†ÁöÑÊìç‰Ωú„ÄÇÂõ†‰∏∫ÂΩìÂâçÁ∫øÁ®ã‰∏≠ÁöÑÂÄºÂ∑≤Áªè‰∏çÊòØÊúÄÊñ∞ÁöÑÂÄºÔºå‰Ω†ÁöÑ‰øÆÊîπÂæàÂèØËÉΩ‰ºöË¶ÜÁõñÊéâÂÖ∂‰ªñÁ∫øÁ®ã‰øÆÊîπÁöÑÁªìÊûú„ÄÇËøô‰∏ÄÁÇπ‰∏é‰πêËßÇÈîÅÔºåSVNÁöÑÊÄùÊÉ≥ÊòØÊØîËæÉÁ±ª‰ººÁöÑ„ÄÇ</p>
<h3 id="unsafeÈùôÊÄÅÂùó"><a href="#unsafeÈùôÊÄÅÂùó" class="headerlink" title="unsafeÈùôÊÄÅÂùó"></a>unsafeÈùôÊÄÅÂùó</h3><p>unsafe‰ª£Á†ÅÂùóÊéßÂà∂‰∫Ü‰∏Ä‰∫õÂ±ûÊÄßÁöÑ‰øÆÊîπÂ∑•‰ΩúÔºåÊØîÂ¶ÇÊúÄÂ∏∏Áî®ÁöÑSIZECTL „ÄÇÂú®Ëøô‰∏ÄÁâàÊú¨ÁöÑconcurrentHashMap‰∏≠ÔºåÂ§ßÈáèÂ∫îÁî®Êù•ÁöÑCASÊñπÊ≥ïËøõË°åÂèòÈáè„ÄÅÂ±ûÊÄßÁöÑ‰øÆÊîπÂ∑•‰Ωú„ÄÇÂà©Áî®CASËøõË°åÊó†ÈîÅÊìç‰ΩúÔºåÂèØ‰ª•Â§ßÂ§ßÊèêÈ´òÊÄßËÉΩ„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SIZECTL;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TRANSFERINDEX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BASECOUNT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLSBUSY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLVALUE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ABASE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASHIFT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; k = ConcurrentHashMap.class;</span><br><span class="line">            SIZECTL = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"sizeCtl"</span>));</span><br><span class="line">            TRANSFERINDEX = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"transferIndex"</span>));</span><br><span class="line">            BASECOUNT = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"baseCount"</span>));</span><br><span class="line">            CELLSBUSY = U.objectFieldOffset</span><br><span class="line">                (k.getDeclaredField(<span class="string">"cellsBusy"</span>));</span><br><span class="line">            Class&lt;?&gt; ck = CounterCell.class;</span><br><span class="line">            CELLVALUE = U.objectFieldOffset</span><br><span class="line">                (ck.getDeclaredField(<span class="string">"value"</span>));</span><br><span class="line">            Class&lt;?&gt; ak = Node[].class;</span><br><span class="line">            ABASE = U.arrayBaseOffset(ak);</span><br><span class="line">            <span class="keyword">int</span> scale = U.arrayIndexScale(ak);</span><br><span class="line">            <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"data type scale not a power of two"</span>);</span><br><span class="line">            ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="‰∏â‰∏™Ê†∏ÂøÉÊñπÊ≥ï"><a href="#‰∏â‰∏™Ê†∏ÂøÉÊñπÊ≥ï" class="headerlink" title="‰∏â‰∏™Ê†∏ÂøÉÊñπÊ≥ï"></a>‰∏â‰∏™Ê†∏ÂøÉÊñπÊ≥ï</h3><p>ConcurrentHashMapÂÆö‰πâ‰∫Ü‰∏â‰∏™ÂéüÂ≠êÊìç‰ΩúÔºåÁî®‰∫éÂØπÊåáÂÆö‰ΩçÁΩÆÁöÑËäÇÁÇπËøõË°åÊìç‰Ωú„ÄÇÊ≠£ÊòØËøô‰∫õÂéüÂ≠êÊìç‰Ωú‰øùËØÅ‰∫ÜConcurrentHashMapÁöÑÁ∫øÁ®ãÂÆâÂÖ®„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Ëé∑ÂæóÂú®i‰ΩçÁΩÆ‰∏äÁöÑNodeËäÇÁÇπ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//Âà©Áî®CASÁÆóÊ≥ïËÆæÁΩÆi‰ΩçÁΩÆ‰∏äÁöÑNodeËäÇÁÇπ„ÄÇ‰πãÊâÄ‰ª•ËÉΩÂÆûÁé∞Âπ∂ÂèëÊòØÂõ†‰∏∫‰ªñÊåáÂÆö‰∫ÜÂéüÊù•Ëøô‰∏™ËäÇÁÇπÁöÑÂÄºÊòØÂ§öÂ∞ë</span></span><br><span class="line">		<span class="comment">//Âú®CASÁÆóÊ≥ï‰∏≠Ôºå‰ºöÊØîËæÉÂÜÖÂ≠ò‰∏≠ÁöÑÂÄº‰∏é‰Ω†ÊåáÂÆöÁöÑËøô‰∏™ÂÄºÊòØÂê¶Áõ∏Á≠âÔºåÂ¶ÇÊûúÁõ∏Á≠âÊâçÊé•Âèó‰Ω†ÁöÑ‰øÆÊîπÔºåÂê¶ÂàôÊãíÁªù‰Ω†ÁöÑ‰øÆÊîπ</span></span><br><span class="line">		<span class="comment">//Âõ†Ê≠§ÂΩìÂâçÁ∫øÁ®ã‰∏≠ÁöÑÂÄºÂπ∂‰∏çÊòØÊúÄÊñ∞ÁöÑÂÄºÔºåËøôÁßç‰øÆÊîπÂèØËÉΩ‰ºöË¶ÜÁõñÊéâÂÖ∂‰ªñÁ∫øÁ®ãÁöÑ‰øÆÊîπÁªìÊûú  ÊúâÁÇπÁ±ª‰ºº‰∫éSVN</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//Âà©Áî®volatileÊñπÊ≥ïËÆæÁΩÆËäÇÁÇπ‰ΩçÁΩÆÁöÑÂÄº</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">void</span> <span class="title">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">        U.putObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="ÂàùÂßãÂåñÊñπÊ≥ïinitTable"><a href="#ÂàùÂßãÂåñÊñπÊ≥ïinitTable" class="headerlink" title="ÂàùÂßãÂåñÊñπÊ≥ïinitTable"></a>ÂàùÂßãÂåñÊñπÊ≥ïinitTable</h3><p>ÂØπ‰∫éConcurrentHashMapÊù•ËØ¥ÔºåË∞ÉÁî®ÂÆÉÁöÑÊûÑÈÄ†ÊñπÊ≥ï‰ªÖ‰ªÖÊòØËÆæÁΩÆ‰∫Ü‰∏Ä‰∫õÂèÇÊï∞ËÄåÂ∑≤„ÄÇËÄåÊï¥‰∏™tableÁöÑÂàùÂßãÂåñÊòØÂú®ÂêëConcurrentHashMap‰∏≠ÊèíÂÖ•ÂÖÉÁ¥†ÁöÑÊó∂ÂÄôÂèëÁîüÁöÑ„ÄÇÂ¶ÇË∞ÉÁî®put„ÄÅcomputeIfAbsent„ÄÅcompute„ÄÅmergeÁ≠âÊñπÊ≥ïÁöÑÊó∂ÂÄôÔºåË∞ÉÁî®Êó∂Êú∫ÊòØÊ£ÄÊü•table==null„ÄÇ</p>
<p>ÂàùÂßãÂåñÊñπÊ≥ï‰∏ªË¶ÅÂ∫îÁî®‰∫ÜÂÖ≥ÈîÆÂ±ûÊÄßsizeCtl Â¶ÇÊûúËøô‰∏™ÂÄº„Äà0ÔºåË°®Á§∫ÂÖ∂‰ªñÁ∫øÁ®ãÊ≠£Âú®ËøõË°åÂàùÂßãÂåñÔºåÂ∞±ÊîæÂºÉËøô‰∏™Êìç‰Ωú„ÄÇÂú®Ëøô‰πüÂèØ‰ª•ÁúãÂá∫ConcurrentHashMapÁöÑÂàùÂßãÂåñÂè™ËÉΩÁî±‰∏Ä‰∏™Á∫øÁ®ãÂÆåÊàê„ÄÇÂ¶ÇÊûúËé∑Âæó‰∫ÜÂàùÂßãÂåñÊùÉÈôêÔºåÂ∞±Áî®CASÊñπÊ≥ïÂ∞ÜsizeCtlÁΩÆ‰∏∫-1ÔºåÈò≤Ê≠¢ÂÖ∂‰ªñÁ∫øÁ®ãËøõÂÖ•„ÄÇÂàùÂßãÂåñÊï∞ÁªÑÂêéÔºåÂ∞ÜsizeCtlÁöÑÂÄºÊîπ‰∏∫0.75*n„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes table, using the size recorded in sizeCtl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">        <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        		<span class="comment">//sizeCtlË°®Á§∫ÊúâÂÖ∂‰ªñÁ∫øÁ®ãÊ≠£Âú®ËøõË°åÂàùÂßãÂåñÊìç‰ΩúÔºåÊääÁ∫øÁ®ãÊåÇËµ∑„ÄÇÂØπ‰∫étableÁöÑÂàùÂßãÂåñÂ∑•‰ΩúÔºåÂè™ËÉΩÊúâ‰∏Ä‰∏™Á∫øÁ®ãÂú®ËøõË°å„ÄÇ</span></span><br><span class="line">            <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">                Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;<span class="comment">//Âà©Áî®CASÊñπÊ≥ïÊääsizectlÁöÑÂÄºÁΩÆ‰∏∫-1 Ë°®Á§∫Êú¨Á∫øÁ®ãÊ≠£Âú®ËøõË°åÂàùÂßãÂåñ</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = tab = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);<span class="comment">//Áõ∏ÂΩì‰∫é0.75*n ËÆæÁΩÆ‰∏Ä‰∏™Êâ©ÂÆπÁöÑÈòàÂÄº</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tab;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Êâ©ÂÆπÊñπÊ≥ï-transfer"><a href="#Êâ©ÂÆπÊñπÊ≥ï-transfer" class="headerlink" title="Êâ©ÂÆπÊñπÊ≥ï transfer"></a>Êâ©ÂÆπÊñπÊ≥ï transfer</h3><p>ÂΩìConcurrentHashMapÂÆπÈáè‰∏çË∂≥ÁöÑÊó∂ÂÄôÔºåÈúÄË¶ÅÂØπtableËøõË°åÊâ©ÂÆπ„ÄÇËøô‰∏™ÊñπÊ≥ïÁöÑÂü∫Êú¨ÊÄùÊÉ≥Ë∑üHashMapÊòØÂæàÂÉèÁöÑÔºå‰ΩÜÊòØÁî±‰∫éÂÆÉÊòØÊîØÊåÅÂπ∂ÂèëÊâ©ÂÆπÁöÑÔºåÊâÄ‰ª•Ë¶ÅÂ§çÊùÇÁöÑÂ§ö„ÄÇÂéüÂõ†ÊòØÂÆÉÊîØÊåÅÂ§öÁ∫øÁ®ãËøõË°åÊâ©ÂÆπÊìç‰ΩúÔºåËÄåÂπ∂Ê≤°ÊúâÂä†ÈîÅ„ÄÇÊàëÊÉ≥ËøôÊ†∑ÂÅöÁöÑÁõÆÁöÑ‰∏ç‰ªÖ‰ªÖÊòØ‰∏∫‰∫ÜÊª°Ë∂≥concurrentÁöÑË¶ÅÊ±ÇÔºåËÄåÊòØÂ∏åÊúõÂà©Áî®Âπ∂ÂèëÂ§ÑÁêÜÂéªÂáèÂ∞ëÊâ©ÂÆπÂ∏¶Êù•ÁöÑÊó∂Èó¥ÂΩ±Âìç„ÄÇÂõ†‰∏∫Âú®Êâ©ÂÆπÁöÑÊó∂ÂÄôÔºåÊÄªÊòØ‰ºöÊ∂âÂèäÂà∞‰ªé‰∏Ä‰∏™‚ÄúÊï∞ÁªÑ‚ÄùÂà∞Âè¶‰∏Ä‰∏™‚ÄúÊï∞ÁªÑ‚ÄùÊã∑Ë¥ùÁöÑÊìç‰ΩúÔºåÂ¶ÇÊûúËøô‰∏™Êìç‰ΩúËÉΩÂ§üÂπ∂ÂèëËøõË°åÔºåÈÇ£ÁúüÁúüÊòØÊûÅÂ•ΩÁöÑ‰∫Ü„ÄÇ</p>
<p>Êï¥‰∏™Êâ©ÂÆπÊìç‰ΩúÂàÜ‰∏∫‰∏§‰∏™ÈÉ®ÂàÜ</p>
<ul>
<li>Á¨¨‰∏ÄÈÉ®ÂàÜÊòØÊûÑÂª∫‰∏Ä‰∏™nextTable,ÂÆÉÁöÑÂÆπÈáèÊòØÂéüÊù•ÁöÑ‰∏§ÂÄçÔºåËøô‰∏™Êìç‰ΩúÊòØÂçïÁ∫øÁ®ãÂÆåÊàêÁöÑ„ÄÇËøô‰∏™ÂçïÁ∫øÁ®ãÁöÑ‰øùËØÅÊòØÈÄöËøáRESIZE_STAMP_SHIFTËøô‰∏™Â∏∏ÈáèÁªèËøá‰∏ÄÊ¨°ËøêÁÆóÊù•‰øùËØÅÁöÑÔºåËøô‰∏™Âú∞ÊñπÂú®ÂêéÈù¢‰ºöÊúâÊèêÂà∞Ôºõ</li>
<li>Á¨¨‰∫å‰∏™ÈÉ®ÂàÜÂ∞±ÊòØÂ∞ÜÂéüÊù•table‰∏≠ÁöÑÂÖÉÁ¥†Â§çÂà∂Âà∞nextTable‰∏≠ÔºåËøôÈáåÂÖÅËÆ∏Â§öÁ∫øÁ®ãËøõË°åÊìç‰Ωú„ÄÇ</li>
</ul>
<p>ÂÖàÊù•Áúã‰∏Ä‰∏ãÂçïÁ∫øÁ®ãÊòØÂ¶Ç‰ΩïÂÆåÊàêÁöÑÔºö</p>
<p>ÂÆÉÁöÑÂ§ß‰ΩìÊÄùÊÉ≥Â∞±ÊòØÈÅçÂéÜ„ÄÅÂ§çÂà∂ÁöÑËøáÁ®ã„ÄÇÈ¶ñÂÖàÊ†πÊçÆËøêÁÆóÂæóÂà∞ÈúÄË¶ÅÈÅçÂéÜÁöÑÊ¨°Êï∞iÔºåÁÑ∂ÂêéÂà©Áî®tabAtÊñπÊ≥ïËé∑Âæói‰ΩçÁΩÆÁöÑÂÖÉÁ¥†Ôºö</p>
<ul>
<li>Â¶ÇÊûúËøô‰∏™‰ΩçÁΩÆ‰∏∫Á©∫ÔºåÂ∞±Âú®Âéütable‰∏≠ÁöÑi‰ΩçÁΩÆÊîæÂÖ•forwardNodeËäÇÁÇπÔºåËøô‰∏™‰πüÊòØËß¶ÂèëÂπ∂ÂèëÊâ©ÂÆπÁöÑÂÖ≥ÈîÆÁÇπÔºõ</li>
<li>Â¶ÇÊûúËøô‰∏™‰ΩçÁΩÆÊòØNodeËäÇÁÇπÔºàfh&gt;=0ÔºâÔºåÂ¶ÇÊûúÂÆÉÊòØ‰∏Ä‰∏™ÈìæË°®ÁöÑÂ§¥ËäÇÁÇπÔºåÂ∞±ÊûÑÈÄ†‰∏Ä‰∏™ÂèçÂ∫èÈìæË°®ÔºåÊää‰ªñ‰ª¨ÂàÜÂà´ÊîæÂú®nextTableÁöÑiÂíåi+nÁöÑ‰ΩçÁΩÆ‰∏ä</li>
<li>Â¶ÇÊûúËøô‰∏™‰ΩçÁΩÆÊòØTreeBinËäÇÁÇπÔºàfh&lt;0ÔºâÔºå‰πüÂÅö‰∏Ä‰∏™ÂèçÂ∫èÂ§ÑÁêÜÔºåÂπ∂‰∏îÂà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅuntreefiÔºåÊääÂ§ÑÁêÜÁöÑÁªìÊûúÂàÜÂà´ÊîæÂú®nextTableÁöÑiÂíåi+nÁöÑ‰ΩçÁΩÆ‰∏ä</li>
<li>ÈÅçÂéÜËøáÊâÄÊúâÁöÑËäÇÁÇπ‰ª•ÂêéÂ∞±ÂÆåÊàê‰∫ÜÂ§çÂà∂Â∑•‰ΩúÔºåËøôÊó∂ËÆ©nextTable‰Ωú‰∏∫Êñ∞ÁöÑtableÔºåÂπ∂‰∏îÊõ¥Êñ∞sizeCtl‰∏∫Êñ∞ÂÆπÈáèÁöÑ0.75ÂÄç ÔºåÂÆåÊàêÊâ©ÂÆπ„ÄÇ</li>
</ul>
<p>ÂÜçÁúã‰∏Ä‰∏ãÂ§öÁ∫øÁ®ãÊòØÂ¶Ç‰ΩïÂÆåÊàêÁöÑÔºö</p>
<p>Âú®‰ª£Á†ÅÁöÑ69Ë°åÊúâ‰∏Ä‰∏™Âà§Êñ≠ÔºåÂ¶ÇÊûúÈÅçÂéÜÂà∞ÁöÑËäÇÁÇπÊòØforwardËäÇÁÇπÔºåÂ∞±ÂêëÂêéÁªßÁª≠ÈÅçÂéÜÔºåÂÜçÂä†‰∏äÁªôËäÇÁÇπ‰∏äÈîÅÁöÑÊú∫Âà∂ÔºåÂ∞±ÂÆåÊàê‰∫ÜÂ§öÁ∫øÁ®ãÁöÑÊéßÂà∂„ÄÇÂ§öÁ∫øÁ®ãÈÅçÂéÜËäÇÁÇπÔºåÂ§ÑÁêÜ‰∫Ü‰∏Ä‰∏™ËäÇÁÇπÔºåÂ∞±ÊääÂØπÂ∫îÁÇπÁöÑÂÄºset‰∏∫forwardÔºåÂè¶‰∏Ä‰∏™Á∫øÁ®ãÁúãÂà∞forwardÔºåÂ∞±ÂêëÂêéÈÅçÂéÜ„ÄÇËøôÊ†∑‰∫§ÂèâÂ∞±ÂÆåÊàê‰∫ÜÂ§çÂà∂Â∑•‰Ωú„ÄÇËÄå‰∏îËøòÂæàÂ•ΩÁöÑËß£ÂÜ≥‰∫ÜÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÈóÆÈ¢ò„ÄÇ Ëøô‰∏™ÊñπÊ≥ïÁöÑËÆæËÆ°ÂÆûÂú®ÊòØËÆ©ÊàëËÜúÊãú„ÄÇ</p>
<p><a href="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg" target="_blank" rel="noopener"><img src="http://static.oschina.net/uploads/space/2016/0516/173132_DQMG_2243330.jpg" alt=""></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ‰∏Ä‰∏™ËøáÊ∏°ÁöÑtableË°®  Âè™ÊúâÂú®Êâ©ÂÆπÁöÑÊó∂ÂÄôÊâç‰ºö‰ΩøÁî®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Moves and/or copies the nodes in each bin to new table. See</span></span><br><span class="line"><span class="comment">     * above for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">        <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">            stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">        <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];<span class="comment">//ÊûÑÈÄ†‰∏Ä‰∏™nextTableÂØπË±° ÂÆÉÁöÑÂÆπÈáèÊòØÂéüÊù•ÁöÑ‰∏§ÂÄç</span></span><br><span class="line">                nextTab = nt;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">                sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nextTable = nextTab;</span><br><span class="line">            transferIndex = n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">        ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);<span class="comment">//ÊûÑÈÄ†‰∏Ä‰∏™ËøûËäÇÁÇπÊåáÈíà Áî®‰∫éÊ†áÂøó‰Ωç</span></span><br><span class="line">        <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;<span class="comment">//Âπ∂ÂèëÊâ©ÂÆπÁöÑÂÖ≥ÈîÆÂ±ûÊÄß Â¶ÇÊûúÁ≠â‰∫étrue ËØ¥ÊòéËøô‰∏™ËäÇÁÇπÂ∑≤ÁªèÂ§ÑÁêÜËøá</span></span><br><span class="line">        <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">            Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">            <span class="comment">//Ëøô‰∏™whileÂæ™ÁéØ‰ΩìÁöÑ‰ΩúÁî®Â∞±ÊòØÂú®ÊéßÂà∂i--  ÈÄöËøái--ÂèØ‰ª•‰æùÊ¨°ÈÅçÂéÜÂéühashË°®‰∏≠ÁöÑËäÇÁÇπ</span></span><br><span class="line">            <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">                <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">                <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    i = -<span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                         (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                          nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                       nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                    bound = nextBound;</span><br><span class="line">                    i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                    advance = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">                <span class="keyword">int</span> sc;</span><br><span class="line">                <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                	<span class="comment">//Â¶ÇÊûúÊâÄÊúâÁöÑËäÇÁÇπÈÉΩÂ∑≤ÁªèÂÆåÊàêÂ§çÂà∂Â∑•‰Ωú  Â∞±ÊäänextTableËµãÂÄºÁªôtable Ê∏ÖÁ©∫‰∏¥Êó∂ÂØπË±°nextTable</span></span><br><span class="line">                    nextTable = <span class="keyword">null</span>;</span><br><span class="line">                    table = nextTab;</span><br><span class="line">                    sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);<span class="comment">//Êâ©ÂÆπÈòàÂÄºËÆæÁΩÆ‰∏∫ÂéüÊù•ÂÆπÈáèÁöÑ1.5ÂÄç  ‰æùÁÑ∂Áõ∏ÂΩì‰∫éÁé∞Âú®ÂÆπÈáèÁöÑ0.75ÂÄç</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//Âà©Áî®CASÊñπÊ≥ïÊõ¥Êñ∞Ëøô‰∏™Êâ©ÂÆπÈòàÂÄºÔºåÂú®ËøôÈáåÈù¢sizectlÂÄºÂáè‰∏ÄÔºåËØ¥ÊòéÊñ∞Âä†ÂÖ•‰∏Ä‰∏™Á∫øÁ®ãÂèÇ‰∏éÂà∞Êâ©ÂÆπÊìç‰Ωú</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                    i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Â¶ÇÊûúÈÅçÂéÜÂà∞ÁöÑËäÇÁÇπ‰∏∫Á©∫ ÂàôÊîæÂÖ•ForwardingNodeÊåáÈíà</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">                advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">            <span class="comment">//Â¶ÇÊûúÈÅçÂéÜÂà∞ForwardingNodeËäÇÁÇπ  ËØ¥ÊòéËøô‰∏™ÁÇπÂ∑≤ÁªèË¢´Â§ÑÁêÜËøá‰∫Ü Áõ¥Êé•Ë∑≥Ëøá  ËøôÈáåÊòØÊéßÂà∂Âπ∂ÂèëÊâ©ÂÆπÁöÑÊ†∏ÂøÉ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">                advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">            		<span class="comment">//ËäÇÁÇπ‰∏äÈîÅ</span></span><br><span class="line">                <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                        <span class="comment">//Â¶ÇÊûúfh&gt;=0 ËØÅÊòéËøôÊòØ‰∏Ä‰∏™NodeËäÇÁÇπ</span></span><br><span class="line">                        <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                            <span class="comment">//‰ª•‰∏ãÁöÑÈÉ®ÂàÜÂú®ÂÆåÊàêÁöÑÂ∑•‰ΩúÊòØÊûÑÈÄ†‰∏§‰∏™ÈìæË°®  ‰∏Ä‰∏™ÊòØÂéüÈìæË°®  Âè¶‰∏Ä‰∏™ÊòØÂéüÈìæË°®ÁöÑÂèçÂ∫èÊéíÂàó</span></span><br><span class="line">                            Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                                <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                    runBit = b;</span><br><span class="line">                                    lastRun = p;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                                ln = lastRun;</span><br><span class="line">                                hn = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                hn = lastRun;</span><br><span class="line">                                ln = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                                <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                    ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//Âú®nextTableÁöÑi‰ΩçÁΩÆ‰∏äÊèíÂÖ•‰∏Ä‰∏™ÈìæË°®</span></span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            <span class="comment">//Âú®nextTableÁöÑi+nÁöÑ‰ΩçÁΩÆ‰∏äÊèíÂÖ•Âè¶‰∏Ä‰∏™ÈìæË°®</span></span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                            <span class="comment">//Âú®tableÁöÑi‰ΩçÁΩÆ‰∏äÊèíÂÖ•forwardNodeËäÇÁÇπ  Ë°®Á§∫Â∑≤ÁªèÂ§ÑÁêÜËøáËØ•ËäÇÁÇπ</span></span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            <span class="comment">//ËÆæÁΩÆadvance‰∏∫true ËøîÂõûÂà∞‰∏äÈù¢ÁöÑwhileÂæ™ÁéØ‰∏≠ Â∞±ÂèØ‰ª•ÊâßË°åi--Êìç‰Ωú</span></span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//ÂØπTreeBinÂØπË±°ËøõË°åÂ§ÑÁêÜ  ‰∏é‰∏äÈù¢ÁöÑËøáÁ®ãÁ±ª‰ºº</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                            TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                            TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                            <span class="comment">//ÊûÑÈÄ†Ê≠£Â∫èÂíåÂèçÂ∫è‰∏§‰∏™ÈìæË°®</span></span><br><span class="line">                            <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                                <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                                TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                    (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        lo = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        loTail.next = p;</span><br><span class="line">                                    loTail = p;</span><br><span class="line">                                    ++lc;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                        hi = p;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        hiTail.next = p;</span><br><span class="line">                                    hiTail = p;</span><br><span class="line">                                    ++hc;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//Â¶ÇÊûúÊâ©ÂÆπÂêéÂ∑≤Áªè‰∏çÂÜçÈúÄË¶ÅtreeÁöÑÁªìÊûÑ ÂèçÂêëËΩ¨Êç¢‰∏∫ÈìæË°®ÁªìÊûÑ</span></span><br><span class="line">                            ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                                (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                            hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                                (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                             <span class="comment">//Âú®nextTableÁöÑi‰ΩçÁΩÆ‰∏äÊèíÂÖ•‰∏Ä‰∏™ÈìæË°®    </span></span><br><span class="line">                            setTabAt(nextTab, i, ln);</span><br><span class="line">                            <span class="comment">//Âú®nextTableÁöÑi+nÁöÑ‰ΩçÁΩÆ‰∏äÊèíÂÖ•Âè¶‰∏Ä‰∏™ÈìæË°®</span></span><br><span class="line">                            setTabAt(nextTab, i + n, hn);</span><br><span class="line">                             <span class="comment">//Âú®tableÁöÑi‰ΩçÁΩÆ‰∏äÊèíÂÖ•forwardNodeËäÇÁÇπ  Ë°®Á§∫Â∑≤ÁªèÂ§ÑÁêÜËøáËØ•ËäÇÁÇπ</span></span><br><span class="line">                            setTabAt(tab, i, fwd);</span><br><span class="line">                            <span class="comment">//ËÆæÁΩÆadvance‰∏∫true ËøîÂõûÂà∞‰∏äÈù¢ÁöÑwhileÂæ™ÁéØ‰∏≠ Â∞±ÂèØ‰ª•ÊâßË°åi--Êìç‰Ωú</span></span><br><span class="line">                            advance = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="PutÊñπÊ≥ï"><a href="#PutÊñπÊ≥ï" class="headerlink" title="PutÊñπÊ≥ï"></a>PutÊñπÊ≥ï</h2><p>ÂâçÈù¢ÁöÑÊâÄÊúâÁöÑ‰ªãÁªçÂÖ∂ÂÆûÈÉΩ‰∏∫Ëøô‰∏™ÊñπÊ≥ïÂÅöÈì∫Âû´„ÄÇConcurrentHashMapÊúÄÂ∏∏Áî®ÁöÑÂ∞±ÊòØputÂíåget‰∏§‰∏™ÊñπÊ≥ï„ÄÇÁé∞Âú®Êù•‰ªãÁªçputÊñπÊ≥ïÔºåËøô‰∏™putÊñπÊ≥ï‰æùÁÑ∂Ê≤øÁî®HashMapÁöÑputÊñπÊ≥ïÁöÑÊÄùÊÉ≥ÔºåÊ†πÊçÆhashÂÄºËÆ°ÁÆóËøô‰∏™Êñ∞ÊèíÂÖ•ÁöÑÁÇπÂú®table‰∏≠ÁöÑ‰ΩçÁΩÆiÔºåÂ¶ÇÊûúi‰ΩçÁΩÆÊòØÁ©∫ÁöÑÔºåÁõ¥Êé•ÊîæËøõÂéªÔºåÂê¶ÂàôËøõË°åÂà§Êñ≠ÔºåÂ¶ÇÊûúi‰ΩçÁΩÆÊòØÊ†ëËäÇÁÇπÔºåÊåâÁÖßÊ†ëÁöÑÊñπÂºèÊèíÂÖ•Êñ∞ÁöÑËäÇÁÇπÔºåÂê¶ÂàôÊääiÊèíÂÖ•Âà∞ÈìæË°®ÁöÑÊú´Â∞æ„ÄÇConcurrentHashMap‰∏≠‰æùÁÑ∂Ê≤øÁî®Ëøô‰∏™ÊÄùÊÉ≥ÔºåÊúâ‰∏Ä‰∏™ÊúÄÈáçË¶ÅÁöÑ‰∏çÂêåÁÇπÂ∞±ÊòØConcurrentHashMap‰∏çÂÖÅËÆ∏keyÊàñvalue‰∏∫nullÂÄº„ÄÇÂè¶Â§ñÁî±‰∫éÊ∂âÂèäÂà∞Â§öÁ∫øÁ®ãÔºåputÊñπÊ≥ïÂ∞±Ë¶ÅÂ§çÊùÇ‰∏ÄÁÇπ„ÄÇÂú®Â§öÁ∫øÁ®ã‰∏≠ÂèØËÉΩÊúâ‰ª•‰∏ã‰∏§‰∏™ÊÉÖÂÜµ</p>
<ol>
<li><p>Â¶ÇÊûú‰∏Ä‰∏™ÊàñÂ§ö‰∏™Á∫øÁ®ãÊ≠£Âú®ÂØπConcurrentHashMapËøõË°åÊâ©ÂÆπÊìç‰ΩúÔºåÂΩìÂâçÁ∫øÁ®ã‰πüË¶ÅËøõÂÖ•Êâ©ÂÆπÁöÑÊìç‰Ωú‰∏≠„ÄÇËøô‰∏™Êâ©ÂÆπÁöÑÊìç‰Ωú‰πãÊâÄ‰ª•ËÉΩË¢´Ê£ÄÊµãÂà∞ÔºåÊòØÂõ†‰∏∫transferÊñπÊ≥ï‰∏≠Âú®Á©∫ÁªìÁÇπ‰∏äÊèíÂÖ•forwardËäÇÁÇπÔºåÂ¶ÇÊûúÊ£ÄÊµãÂà∞ÈúÄË¶ÅÊèíÂÖ•ÁöÑ‰ΩçÁΩÆË¢´forwardËäÇÁÇπÂç†ÊúâÔºåÂ∞±Â∏ÆÂä©ËøõË°åÊâ©ÂÆπÔºõ</p>
</li>
<li><p>Â¶ÇÊûúÊ£ÄÊµãÂà∞Ë¶ÅÊèíÂÖ•ÁöÑËäÇÁÇπÊòØÈùûÁ©∫‰∏î‰∏çÊòØforwardËäÇÁÇπÔºåÂ∞±ÂØπËøô‰∏™ËäÇÁÇπÂä†ÈîÅÔºåËøôÊ†∑Â∞±‰øùËØÅ‰∫ÜÁ∫øÁ®ãÂÆâÂÖ®„ÄÇÂ∞ΩÁÆ°Ëøô‰∏™Êúâ‰∏Ä‰∫õÂΩ±ÂìçÊïàÁéáÔºå‰ΩÜÊòØËøòÊòØ‰ºöÊØîhashTableÁöÑsynchronizedË¶ÅÂ•ΩÂæóÂ§ö„ÄÇ</p>
</li>
</ol>
<p>Êï¥‰ΩìÊµÅÁ®ãÂ∞±ÊòØÈ¶ñÂÖàÂÆö‰πâ‰∏çÂÖÅËÆ∏keyÊàñvalue‰∏∫nullÁöÑÊÉÖÂÜµÊîæÂÖ•  ÂØπ‰∫éÊØè‰∏Ä‰∏™ÊîæÂÖ•ÁöÑÂÄºÔºåÈ¶ñÂÖàÂà©Áî®spreadÊñπÊ≥ïÂØπkeyÁöÑhashcodeËøõË°å‰∏ÄÊ¨°hashËÆ°ÁÆóÔºåÁî±Ê≠§Êù•Á°ÆÂÆöËøô‰∏™ÂÄºÂú®table‰∏≠ÁöÑ‰ΩçÁΩÆ„ÄÇ</p>
<p>Â¶ÇÊûúËøô‰∏™‰ΩçÁΩÆÊòØÁ©∫ÁöÑÔºåÈÇ£‰πàÁõ¥Êé•ÊîæÂÖ•ÔºåËÄå‰∏î‰∏çÈúÄË¶ÅÂä†ÈîÅÊìç‰Ωú„ÄÇ</p>
<p> Â¶ÇÊûúËøô‰∏™‰ΩçÁΩÆÂ≠òÂú®ÁªìÁÇπÔºåËØ¥ÊòéÂèëÁîü‰∫ÜhashÁ¢∞ÊíûÔºåÈ¶ñÂÖàÂà§Êñ≠Ëøô‰∏™ËäÇÁÇπÁöÑÁ±ªÂûã„ÄÇÂ¶ÇÊûúÊòØÈìæË°®ËäÇÁÇπÔºàfh&gt;0Ôºâ,ÂàôÂæóÂà∞ÁöÑÁªìÁÇπÂ∞±ÊòØhashÂÄºÁõ∏ÂêåÁöÑËäÇÁÇπÁªÑÊàêÁöÑÈìæË°®ÁöÑÂ§¥ËäÇÁÇπ„ÄÇÈúÄË¶Å‰æùÊ¨°ÂêëÂêéÈÅçÂéÜÁ°ÆÂÆöËøô‰∏™Êñ∞Âä†ÂÖ•ÁöÑÂÄºÊâÄÂú®‰ΩçÁΩÆ„ÄÇÂ¶ÇÊûúÈÅáÂà∞hashÂÄº‰∏ékeyÂÄºÈÉΩ‰∏éÊñ∞Âä†ÂÖ•ËäÇÁÇπÊòØ‰∏ÄËá¥ÁöÑÊÉÖÂÜµÔºåÂàôÂè™ÈúÄË¶ÅÊõ¥Êñ∞valueÂÄºÂç≥ÂèØ„ÄÇÂê¶Âàô‰æùÊ¨°ÂêëÂêéÈÅçÂéÜÔºåÁõ¥Âà∞ÈìæË°®Â∞æÊèíÂÖ•Ëøô‰∏™ÁªìÁÇπ„ÄÇÂ¶ÇÊûúÂä†ÂÖ•Ëøô‰∏™ËäÇÁÇπ‰ª•ÂêéÈìæË°®ÈïøÂ∫¶Â§ß‰∫é8ÔºåÂ∞±ÊääËøô‰∏™ÈìæË°®ËΩ¨Êç¢ÊàêÁ∫¢ÈªëÊ†ë„ÄÇÂ¶ÇÊûúËøô‰∏™ËäÇÁÇπÁöÑÁ±ªÂûãÂ∑≤ÁªèÊòØÊ†ëËäÇÁÇπÁöÑËØùÔºåÁõ¥Êé•Ë∞ÉÁî®Ê†ëËäÇÁÇπÁöÑÊèíÂÖ•ÊñπÊ≥ïËøõË°åÊèíÂÖ•Êñ∞ÁöÑÂÄº„ÄÇ</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** Implementation for put and putIfAbsent */</span></span><br><span class="line">   <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">   		<span class="comment">//‰∏çÂÖÅËÆ∏ keyÊàñvalue‰∏∫null</span></span><br><span class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">       <span class="comment">//ËÆ°ÁÆóhashÂÄº</span></span><br><span class="line">       <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">       <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">//Ê≠ªÂæ™ÁéØ ‰ΩïÊó∂ÊèíÂÖ•ÊàêÂäü ‰ΩïÊó∂Ë∑≥Âá∫</span></span><br><span class="line">       <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">           Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">           <span class="comment">//Â¶ÇÊûútable‰∏∫Á©∫ÁöÑËØùÔºåÂàùÂßãÂåñtable</span></span><br><span class="line">           <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">               tab = initTable();</span><br><span class="line">           <span class="comment">//Ê†πÊçÆhashÂÄºËÆ°ÁÆóÂá∫Âú®tableÈáåÈù¢ÁöÑ‰ΩçÁΩÆ </span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">           	<span class="comment">//Â¶ÇÊûúËøô‰∏™‰ΩçÁΩÆÊ≤°ÊúâÂÄº ÔºåÁõ¥Êé•ÊîæËøõÂéªÔºå‰∏çÈúÄË¶ÅÂä†ÈîÅ</span></span><br><span class="line">               <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                   <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//ÂΩìÈÅáÂà∞Ë°®ËøûÊé•ÁÇπÊó∂ÔºåÈúÄË¶ÅËøõË°åÊï¥ÂêàË°®ÁöÑÊìç‰Ωú</span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">               tab = helpTransfer(tab, f);</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               V oldVal = <span class="keyword">null</span>;</span><br><span class="line">               <span class="comment">//ÁªìÁÇπ‰∏äÈîÅ  ËøôÈáåÁöÑÁªìÁÇπÂèØ‰ª•ÁêÜËß£‰∏∫hashÂÄºÁõ∏ÂêåÁªÑÊàêÁöÑÈìæË°®ÁöÑÂ§¥ÁªìÁÇπ</span></span><br><span class="line">               <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                       <span class="comment">//fh„Äâ0 ËØ¥ÊòéËøô‰∏™ËäÇÁÇπÊòØ‰∏Ä‰∏™ÈìæË°®ÁöÑËäÇÁÇπ ‰∏çÊòØÊ†ëÁöÑËäÇÁÇπ</span></span><br><span class="line">                       <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                           binCount = <span class="number">1</span>;</span><br><span class="line">                           <span class="comment">//Âú®ËøôÈáåÈÅçÂéÜÈìæË°®ÊâÄÊúâÁöÑÁªìÁÇπ</span></span><br><span class="line">                           <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                               K ek;</span><br><span class="line">                               <span class="comment">//Â¶ÇÊûúhashÂÄºÂíåkeyÂÄºÁõ∏Âêå  Âàô‰øÆÊîπÂØπÂ∫îÁªìÁÇπÁöÑvalueÂÄº</span></span><br><span class="line">                               <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                   ((ek = e.key) == key ||</span><br><span class="line">                                    (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                   oldVal = e.val;</span><br><span class="line">                                   <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                       e.val = value;</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                               Node&lt;K,V&gt; pred = e;</span><br><span class="line">                               <span class="comment">//Â¶ÇÊûúÈÅçÂéÜÂà∞‰∫ÜÊúÄÂêé‰∏Ä‰∏™ÁªìÁÇπÔºåÈÇ£‰πàÂ∞±ËØÅÊòéÊñ∞ÁöÑËäÇÁÇπÈúÄË¶ÅÊèíÂÖ• Â∞±ÊääÂÆÉÊèíÂÖ•Âú®ÈìæË°®Â∞æÈÉ®</span></span><br><span class="line">                               <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                   pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                             value, <span class="keyword">null</span>);</span><br><span class="line">                                   <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">//Â¶ÇÊûúËøô‰∏™ËäÇÁÇπÊòØÊ†ëËäÇÁÇπÔºåÂ∞±ÊåâÁÖßÊ†ëÁöÑÊñπÂºèÊèíÂÖ•ÂÄº</span></span><br><span class="line">                       <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                           Node&lt;K,V&gt; p;</span><br><span class="line">                           binCount = <span class="number">2</span>;</span><br><span class="line">                           <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                          value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               oldVal = p.val;</span><br><span class="line">                               <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                   p.val = value;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">               	<span class="comment">//Â¶ÇÊûúÈìæË°®ÈïøÂ∫¶Â∑≤ÁªèËææÂà∞‰∏¥ÁïåÂÄº8 Â∞±ÈúÄË¶ÅÊääÈìæË°®ËΩ¨Êç¢‰∏∫Ê†ëÁªìÊûÑ</span></span><br><span class="line">                   <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                       treeifyBin(tab, i);</span><br><span class="line">                   <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                       <span class="keyword">return</span> oldVal;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//Â∞ÜÂΩìÂâçConcurrentHashMapÁöÑÂÖÉÁ¥†Êï∞Èáè+1</span></span><br><span class="line">       addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>Êàë‰ª¨ÂèØ‰ª•ÂèëÁé∞JDK8‰∏≠ÁöÑÂÆûÁé∞‰πüÊòØÈîÅÂàÜÁ¶ªÁöÑÊÄùÊÉ≥ÔºåÂè™ÊòØÈîÅ‰ΩèÁöÑÊòØ‰∏Ä‰∏™NodeÔºåËÄå‰∏çÊòØJDK7‰∏≠ÁöÑSegmentÔºåËÄåÈîÅ‰ΩèNode‰πãÂâçÁöÑÊìç‰ΩúÊòØÊó†ÈîÅÁöÑÂπ∂‰∏î‰πüÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÔºåÂª∫Á´ãÂú®‰πãÂâçÊèêÂà∞ÁöÑ3‰∏™ÂéüÂ≠êÊìç‰Ωú‰∏ä„ÄÇ</p>
<h3 id="helpTransferÊñπÊ≥ï"><a href="#helpTransferÊñπÊ≥ï" class="headerlink" title="helpTransferÊñπÊ≥ï"></a>helpTransferÊñπÊ≥ï</h3><p>ËøôÊòØ‰∏Ä‰∏™ÂçèÂä©Êâ©ÂÆπÁöÑÊñπÊ≥ï„ÄÇËøô‰∏™ÊñπÊ≥ïË¢´Ë∞ÉÁî®ÁöÑÊó∂ÂÄôÔºåÂΩìÂâçConcurrentHashMap‰∏ÄÂÆöÂ∑≤ÁªèÊúâ‰∫ÜnextTableÂØπË±°ÔºåÈ¶ñÂÖàÊãøÂà∞Ëøô‰∏™nextTableÂØπË±°ÔºåË∞ÉÁî®transferÊñπÊ≥ï„ÄÇÂõûÁúã‰∏äÈù¢ÁöÑtransferÊñπÊ≥ïÂèØ‰ª•ÁúãÂà∞ÔºåÂΩìÊú¨Á∫øÁ®ãËøõÂÖ•Êâ©ÂÆπÊñπÊ≥ïÁöÑÊó∂ÂÄô‰ºöÁõ¥Êé•ËøõÂÖ•Â§çÂà∂Èò∂ÊÆµ„ÄÇ</p>
<h3 id="treeifyBinÊñπÊ≥ï"><a href="#treeifyBinÊñπÊ≥ï" class="headerlink" title="treeifyBinÊñπÊ≥ï"></a>treeifyBinÊñπÊ≥ï</h3><p>Ëøô‰∏™ÊñπÊ≥ïÁî®‰∫éÂ∞ÜËøáÈïøÁöÑÈìæË°®ËΩ¨Êç¢‰∏∫TreeBinÂØπË±°„ÄÇ‰ΩÜÊòØ‰ªñÂπ∂‰∏çÊòØÁõ¥Êé•ËΩ¨Êç¢ÔºåËÄåÊòØËøõË°å‰∏ÄÊ¨°ÂÆπÈáèÂà§Êñ≠ÔºåÂ¶ÇÊûúÂÆπÈáèÊ≤°ÊúâËææÂà∞ËΩ¨Êç¢ÁöÑË¶ÅÊ±ÇÔºåÁõ¥Êé•ËøõË°åÊâ©ÂÆπÊìç‰ΩúÂπ∂ËøîÂõûÔºõÂ¶ÇÊûúÊª°Ë∂≥Êù°‰ª∂ÊâçÈìæË°®ÁöÑÁªìÊûÑÊäìÊç¢‰∏∫TreeBin ÔºåËøô‰∏éHashMap‰∏çÂêåÁöÑÊòØÔºåÂÆÉÂπ∂Ê≤°ÊúâÊääTreeNodeÁõ¥Êé•ÊîæÂÖ•Á∫¢ÈªëÊ†ëÔºåËÄåÊòØÂà©Áî®‰∫ÜTreeBinËøô‰∏™Â∞èÂÆπÂô®Êù•Â∞ÅË£ÖÊâÄÊúâÁöÑTreeNode.</p>
<h2 id="getÊñπÊ≥ï"><a href="#getÊñπÊ≥ï" class="headerlink" title="getÊñπÊ≥ï"></a>getÊñπÊ≥ï</h2><p>getÊñπÊ≥ïÊØîËæÉÁÆÄÂçïÔºåÁªôÂÆö‰∏Ä‰∏™keyÊù•Á°ÆÂÆövalueÁöÑÊó∂ÂÄôÔºåÂøÖÈ°ªÊª°Ë∂≥‰∏§‰∏™Êù°‰ª∂  keyÁõ∏Âêå  hashÂÄºÁõ∏ÂêåÔºåÂØπ‰∫éËäÇÁÇπÂèØËÉΩÂú®ÈìæË°®ÊàñÊ†ë‰∏äÁöÑÊÉÖÂÜµÔºåÈúÄË¶ÅÂàÜÂà´ÂéªÊü•Êâæ„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">        <span class="comment">//ËÆ°ÁÆóhashÂÄº</span></span><br><span class="line">        <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">        <span class="comment">//Ê†πÊçÆhashÂÄºÁ°ÆÂÆöËäÇÁÇπ‰ΩçÁΩÆ</span></span><br><span class="line">        <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//Â¶ÇÊûúÊêúÁ¥¢Âà∞ÁöÑËäÇÁÇπkey‰∏é‰º†ÂÖ•ÁöÑkeyÁõ∏Âêå‰∏î‰∏ç‰∏∫null,Áõ¥Êé•ËøîÂõûËøô‰∏™ËäÇÁÇπ	</span></span><br><span class="line">            <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Â¶ÇÊûúeh&lt;0 ËØ¥ÊòéËøô‰∏™ËäÇÁÇπÂú®Ê†ë‰∏ä Áõ¥Êé•ÂØªÊâæ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">             <span class="comment">//Âê¶ÂàôÈÅçÂéÜÈìæË°® ÊâæÂà∞ÂØπÂ∫îÁöÑÂÄºÂπ∂ËøîÂõû</span></span><br><span class="line">            <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e.val;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="SizeÁõ∏ÂÖ≥ÁöÑÊñπÊ≥ï"><a href="#SizeÁõ∏ÂÖ≥ÁöÑÊñπÊ≥ï" class="headerlink" title="SizeÁõ∏ÂÖ≥ÁöÑÊñπÊ≥ï"></a>SizeÁõ∏ÂÖ≥ÁöÑÊñπÊ≥ï</h2><p>ÂØπ‰∫éConcurrentHashMapÊù•ËØ¥ÔºåËøô‰∏™tableÈáåÂà∞Â∫ïË£Ö‰∫ÜÂ§öÂ∞ë‰∏úË•øÂÖ∂ÂÆûÊòØ‰∏™‰∏çÁ°ÆÂÆöÁöÑÊï∞ÈáèÔºåÂõ†‰∏∫‰∏çÂèØËÉΩÂú®Ë∞ÉÁî®size()ÊñπÊ≥ïÁöÑÊó∂ÂÄôÂÉèGCÁöÑ‚Äústop the world‚Äù‰∏ÄÊ†∑ËÆ©ÂÖ∂‰ªñÁ∫øÁ®ãÈÉΩÂÅú‰∏ãÊù•ËÆ©‰Ω†ÂéªÁªüËÆ°ÔºåÂõ†Ê≠§Âè™ËÉΩËØ¥Ëøô‰∏™Êï∞ÈáèÊòØ‰∏™‰º∞ËÆ°ÂÄº„ÄÇÂØπ‰∫éËøô‰∏™‰º∞ËÆ°ÂÄºÔºåConcurrentHashMap‰πüÊòØÂ§ßË¥πÂë®Á´†ÊâçËÆ°ÁÆóÂá∫Êù•ÁöÑ„ÄÇ</p>
<h3 id="ËæÖÂä©ÂÆö‰πâ"><a href="#ËæÖÂä©ÂÆö‰πâ" class="headerlink" title="ËæÖÂä©ÂÆö‰πâ"></a>ËæÖÂä©ÂÆö‰πâ</h3><p>‰∏∫‰∫ÜÁªüËÆ°ÂÖÉÁ¥†‰∏™Êï∞ÔºåConcurrentHashMapÂÆö‰πâ‰∫Ü‰∏Ä‰∫õÂèòÈáèÂíå‰∏Ä‰∏™ÂÜÖÈÉ®Á±ª</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A padded cell for distributing counts.  Adapted from LongAdder</span></span><br><span class="line"><span class="comment">     * and Striped64.  See their internal docs for explanation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">        CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/******************************************/</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ÂÆûÈôÖ‰∏ä‰øùÂ≠òÁöÑÊòØhashmap‰∏≠ÁöÑÂÖÉÁ¥†‰∏™Êï∞  Âà©Áî®CASÈîÅËøõË°åÊõ¥Êñ∞</span></span><br><span class="line"><span class="comment">     ‰ΩÜÂÆÉÂπ∂‰∏çÁî®ËøîÂõûÂΩìÂâçhashmapÁöÑÂÖÉÁ¥†‰∏™Êï∞ </span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spinlock (locked via CAS) used when resizing and/or creating CounterCells.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Table of counter cells. When non-null, size is a power of 2.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure>
<h3 id="mappingCount‰∏éSizeÊñπÊ≥ï"><a href="#mappingCount‰∏éSizeÊñπÊ≥ï" class="headerlink" title="mappingCount‰∏éSizeÊñπÊ≥ï"></a>mappingCount‰∏éSizeÊñπÊ≥ï</h3><p>mappingCount‰∏ésizeÊñπÊ≥ïÁöÑÁ±ª‰ºº  ‰ªéJavaÂ∑•Á®ãÂ∏àÁªôÂá∫ÁöÑÊ≥®ÈáäÊù•ÁúãÔºåÂ∫îËØ•‰ΩøÁî®mappingCount‰ª£ÊõøsizeÊñπÊ≥ï ‰∏§‰∏™ÊñπÊ≥ïÈÉΩÊ≤°ÊúâÁõ¥Êé•ËøîÂõûbasecount ËÄåÊòØÁªüËÆ°‰∏ÄÊ¨°Ëøô‰∏™ÂÄºÔºåËÄåËøô‰∏™ÂÄºÂÖ∂ÂÆû‰πüÊòØ‰∏Ä‰∏™Â§ßÊ¶ÇÁöÑÊï∞ÂÄºÔºåÂõ†Ê≠§ÂèØËÉΩÂú®ÁªüËÆ°ÁöÑÊó∂ÂÄôÊúâÂÖ∂‰ªñÁ∫øÁ®ãÊ≠£Âú®ÊâßË°åÊèíÂÖ•ÊàñÂà†Èô§Êìç‰Ωú„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> :</span><br><span class="line">                (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :</span><br><span class="line">                (<span class="keyword">int</span>)n);</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of mappings. This method should be used</span></span><br><span class="line"><span class="comment">     * instead of &#123;<span class="doctag">@link</span> #size&#125; because a ConcurrentHashMap may</span></span><br><span class="line"><span class="comment">     * contain more mappings than can be represented as an int. The</span></span><br><span class="line"><span class="comment">     * value returned is an estimate; the actual count may differ if</span></span><br><span class="line"><span class="comment">     * there are concurrent insertions or removals.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of mappings</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">mappingCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> n = sumCount();</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0L</span>) ? <span class="number">0L</span> : n; <span class="comment">// ignore transient negative values</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">        <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">        <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                    sum += a.value;<span class="comment">//ÊâÄÊúâcounterÁöÑÂÄºÊ±ÇÂíå</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="addCountÊñπÊ≥ï"><a href="#addCountÊñπÊ≥ï" class="headerlink" title="addCountÊñπÊ≥ï"></a>addCountÊñπÊ≥ï</h3><p>Âú®putÊñπÊ≥ïÁªìÂ∞æÂ§ÑË∞ÉÁî®‰∫ÜaddCountÊñπÊ≥ïÔºåÊääÂΩìÂâçConcurrentHashMapÁöÑÂÖÉÁ¥†‰∏™Êï∞+1Ëøô‰∏™ÊñπÊ≥ï‰∏ÄÂÖ±ÂÅö‰∫Ü‰∏§‰ª∂‰∫ã,Êõ¥Êñ∞baseCountÁöÑÂÄºÔºåÊ£ÄÊµãÊòØÂê¶ËøõË°åÊâ©ÂÆπ„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">        CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">        <span class="comment">//Âà©Áî®CASÊñπÊ≥ïÊõ¥Êñ∞baseCountÁöÑÂÄº </span></span><br><span class="line">        <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">            !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">            CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">            <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">                (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">                !(uncontended =</span><br><span class="line">                  U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">                fullAddCount(x, uncontended);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Â¶ÇÊûúcheckÂÄºÂ§ß‰∫éÁ≠â‰∫é0 ÂàôÈúÄË¶ÅÊ£ÄÈ™åÊòØÂê¶ÈúÄË¶ÅËøõË°åÊâ©ÂÆπÊìç‰Ωú</span></span><br><span class="line">        <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">            <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                   (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">                <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                        sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                        transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                     <span class="comment">//Â¶ÇÊûúÂ∑≤ÁªèÊúâÂÖ∂‰ªñÁ∫øÁ®ãÂú®ÊâßË°åÊâ©ÂÆπÊìç‰Ωú</span></span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                        transfer(tab, nt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ÂΩìÂâçÁ∫øÁ®ãÊòØÂîØ‰∏ÄÁöÑÊàñÊòØÁ¨¨‰∏Ä‰∏™ÂèëËµ∑Êâ©ÂÆπÁöÑÁ∫øÁ®ã  Ê≠§Êó∂nextTable=null</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                             (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                    transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">                s = sumCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="ÊÄªÁªì"><a href="#ÊÄªÁªì" class="headerlink" title="ÊÄªÁªì"></a>ÊÄªÁªì</h1><p>JDK6,7‰∏≠ÁöÑConcurrentHashmap‰∏ªË¶Å‰ΩøÁî®SegmentÊù•ÂÆûÁé∞ÂáèÂ∞èÈîÅÁ≤íÂ∫¶ÔºåÊääHashMapÂàÜÂâ≤ÊàêËã•Âπ≤‰∏™SegmentÔºåÂú®putÁöÑÊó∂ÂÄôÈúÄË¶ÅÈîÅ‰ΩèSegmentÔºågetÊó∂ÂÄô‰∏çÂä†ÈîÅÔºå‰ΩøÁî®volatileÊù•‰øùËØÅÂèØËßÅÊÄßÔºåÂΩìË¶ÅÁªüËÆ°ÂÖ®Â±ÄÊó∂ÔºàÊØîÂ¶ÇsizeÔºâÔºåÈ¶ñÂÖà‰ºöÂ∞ùËØïÂ§öÊ¨°ËÆ°ÁÆómodcountÊù•Á°ÆÂÆöÔºåËøôÂá†Ê¨°Â∞ùËØï‰∏≠ÔºåÊòØÂê¶ÊúâÂÖ∂‰ªñÁ∫øÁ®ãËøõË°å‰∫Ü‰øÆÊîπÊìç‰ΩúÔºåÂ¶ÇÊûúÊ≤°ÊúâÔºåÂàôÁõ¥Êé•ËøîÂõûsize„ÄÇÂ¶ÇÊûúÊúâÔºåÂàôÈúÄË¶Å‰æùÊ¨°ÈîÅ‰ΩèÊâÄÊúâÁöÑSegmentÊù•ËÆ°ÁÆó„ÄÇ</p>
<p>jdk7‰∏≠ConcurrentHashmap‰∏≠ÔºåÂΩìÈïøÂ∫¶ËøáÈïøÁ¢∞Êíû‰ºöÂæàÈ¢ëÁπÅÔºåÈìæË°®ÁöÑÂ¢ûÊîπÂà†Êü•Êìç‰ΩúÈÉΩ‰ºöÊ∂àËÄóÂæàÈïøÁöÑÊó∂Èó¥ÔºåÂΩ±ÂìçÊÄßËÉΩ,ÊâÄ‰ª•jdk8 ‰∏≠ÂÆåÂÖ®ÈáçÂÜô‰∫ÜconcurrentHashmap,‰ª£Á†ÅÈáè‰ªéÂéüÊù•ÁöÑ1000Â§öË°åÂèòÊàê‰∫Ü 6000Â§ö Ë°åÔºåÂÆûÁé∞‰∏ä‰πüÂíåÂéüÊù•ÁöÑÂàÜÊÆµÂºèÂ≠òÂÇ®ÊúâÂæàÂ§ßÁöÑÂå∫Âà´„ÄÇ</p>
<p>‰∏ªË¶ÅËÆæËÆ°‰∏äÁöÑÂèòÂåñÊúâ‰ª•‰∏ãÂá†ÁÇπ: </p>
<ol>
<li>‰∏çÈááÁî®segmentËÄåÈááÁî®nodeÔºåÈîÅ‰ΩènodeÊù•ÂÆûÁé∞ÂáèÂ∞èÈîÅÁ≤íÂ∫¶„ÄÇ</li>
<li>ËÆæËÆ°‰∫ÜMOVEDÁä∂ÊÄÅ ÂΩìresizeÁöÑ‰∏≠ËøáÁ®ã‰∏≠ Á∫øÁ®ã2ËøòÂú®putÊï∞ÊçÆÔºåÁ∫øÁ®ã2‰ºöÂ∏ÆÂä©resize„ÄÇ<br>3, ‰ΩøÁî®3‰∏™CASÊìç‰ΩúÊù•Á°Æ‰øùnodeÁöÑ‰∏Ä‰∫õÊìç‰ΩúÁöÑÂéüÂ≠êÊÄßÔºåËøôÁßçÊñπÂºè‰ª£Êõø‰∫ÜÈîÅ„ÄÇ</li>
<li>sizeCtlÁöÑ‰∏çÂêåÂÄºÊù•‰ª£Ë°®‰∏çÂêåÂê´‰πâÔºåËµ∑Âà∞‰∫ÜÊéßÂà∂ÁöÑ‰ΩúÁî®„ÄÇ</li>
</ol>
<p>Ëá≥‰∫é‰∏∫‰ªÄ‰πàJDK8‰∏≠‰ΩøÁî®synchronizedËÄå‰∏çÊòØReentrantLockÔºåÊòØÂõ†‰∏∫JDK8‰∏≠ÂØπsynchronizedÊúâ‰∫ÜË∂≥Â§üÁöÑ‰ºòÂåñÂêß„ÄÇ</p>
<h1 id="ÂèÇËÄÉ"><a href="#ÂèÇËÄÉ" class="headerlink" title="ÂèÇËÄÉ"></a>ÂèÇËÄÉ</h1><p><a href="http://www.jianshu.com/p/4806633fcc55" target="_blank" rel="noopener">http://www.jianshu.com/p/4806633fcc55</a></p>
<p><a href="http://blog.csdn.net/u010723709/article/details/48007881" target="_blank" rel="noopener">http://blog.csdn.net/u010723709/article/details/48007881</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/Êï∞ÊçÆÁªìÊûÑ/" rel="tag"># Êï∞ÊçÆÁªìÊûÑ</a>
          
            <a href="/tags/conccurenthashmap/" rel="tag"># conccurenthashmap</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/24/understanding-raft/" rel="next" title="‰∏Ä‰∏™ÂæàÂ•ΩÁêÜËß£raftÁöÑÂä®ÁîªÊºîÁ§∫">
                <i class="fa fa-chevron-left"></i> ‰∏Ä‰∏™ÂæàÂ•ΩÁêÜËß£raftÁöÑÂä®ÁîªÊºîÁ§∫
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/28/java-g1/" rel="prev" title="Ê∑±ÂÖ•ÁêÜËß£Java G1ÂûÉÂúæÊî∂ÈõÜÂô®">
                Ê∑±ÂÖ•ÁêÜËß£Java G1ÂûÉÂúæÊî∂ÈõÜÂô® <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars7.githubusercontent.com/u/22493186?v=4&s=460"
               alt="ejunjsh" />
          <p class="site-author-name" itemprop="name">ejunjsh</p>
           
              <p class="site-description motion-element" itemprop="description">code freak</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">153</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">148</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ejunjsh" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/339238080" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:sjj050121014@163.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      Email
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/junjie.shao.9" target="_blank" title="FB Page">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                    
                      FB Page
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞"><span class="nav-number">1.</span> <span class="nav-text">jdk6Âíåjdk7‰∏≠ÁöÑÂÆûÁé∞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ËÆæËÆ°ÊÄùË∑Ø"><span class="nav-number">1.1.</span> <span class="nav-text">ËÆæËÆ°ÊÄùË∑Ø</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Âπ∂ÂèëÂ∫¶ÔºàConcurrency-LevelÔºâ"><span class="nav-number">1.2.</span> <span class="nav-text">Âπ∂ÂèëÂ∫¶ÔºàConcurrency LevelÔºâ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ÂàõÂª∫ÂàÜÊÆµÈîÅ"><span class="nav-number">1.3.</span> <span class="nav-text">ÂàõÂª∫ÂàÜÊÆµÈîÅ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#put-putIfAbsent-putAll"><span class="nav-number">1.4.</span> <span class="nav-text">put/putIfAbsent/putAll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rehash"><span class="nav-number">1.5.</span> <span class="nav-text">rehash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#remove"><span class="nav-number">1.6.</span> <span class="nav-text">remove</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#get‰∏écontainsKey"><span class="nav-number">1.7.</span> <span class="nav-text">get‰∏écontainsKey</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#size„ÄÅcontainsValue"><span class="nav-number">1.8.</span> <span class="nav-text">size„ÄÅcontainsValue</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JDK8‰∏≠ÁöÑÂÆûÁé∞"><span class="nav-number">2.</span> <span class="nav-text">JDK8‰∏≠ÁöÑÂÆûÁé∞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ÈáçË¶ÅÁöÑÂ±ûÊÄß"><span class="nav-number">2.1.</span> <span class="nav-text">ÈáçË¶ÅÁöÑÂ±ûÊÄß</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ÈáçË¶ÅÁöÑÁ±ª"><span class="nav-number">2.2.</span> <span class="nav-text">ÈáçË¶ÅÁöÑÁ±ª</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Node"><span class="nav-number">2.2.1.</span> <span class="nav-text">Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TreeNode"><span class="nav-number">2.2.2.</span> <span class="nav-text">TreeNode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TreeBin"><span class="nav-number">2.2.3.</span> <span class="nav-text">TreeBin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ForwardingNode"><span class="nav-number">2.2.4.</span> <span class="nav-text">ForwardingNode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsafe‰∏éCAS"><span class="nav-number">2.3.</span> <span class="nav-text">Unsafe‰∏éCAS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#unsafeÈùôÊÄÅÂùó"><span class="nav-number">2.3.1.</span> <span class="nav-text">unsafeÈùôÊÄÅÂùó</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#‰∏â‰∏™Ê†∏ÂøÉÊñπÊ≥ï"><span class="nav-number">2.3.2.</span> <span class="nav-text">‰∏â‰∏™Ê†∏ÂøÉÊñπÊ≥ï</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ÂàùÂßãÂåñÊñπÊ≥ïinitTable"><span class="nav-number">2.3.3.</span> <span class="nav-text">ÂàùÂßãÂåñÊñπÊ≥ïinitTable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Êâ©ÂÆπÊñπÊ≥ï-transfer"><span class="nav-number">2.3.4.</span> <span class="nav-text">Êâ©ÂÆπÊñπÊ≥ï transfer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PutÊñπÊ≥ï"><span class="nav-number">2.4.</span> <span class="nav-text">PutÊñπÊ≥ï</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#helpTransferÊñπÊ≥ï"><span class="nav-number">2.4.1.</span> <span class="nav-text">helpTransferÊñπÊ≥ï</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#treeifyBinÊñπÊ≥ï"><span class="nav-number">2.4.2.</span> <span class="nav-text">treeifyBinÊñπÊ≥ï</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getÊñπÊ≥ï"><span class="nav-number">2.5.</span> <span class="nav-text">getÊñπÊ≥ï</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SizeÁõ∏ÂÖ≥ÁöÑÊñπÊ≥ï"><span class="nav-number">2.6.</span> <span class="nav-text">SizeÁõ∏ÂÖ≥ÁöÑÊñπÊ≥ï</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ËæÖÂä©ÂÆö‰πâ"><span class="nav-number">2.6.1.</span> <span class="nav-text">ËæÖÂä©ÂÆö‰πâ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mappingCount‰∏éSizeÊñπÊ≥ï"><span class="nav-number">2.6.2.</span> <span class="nav-text">mappingCount‰∏éSizeÊñπÊ≥ï</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#addCountÊñπÊ≥ï"><span class="nav-number">2.6.3.</span> <span class="nav-text">addCountÊñπÊ≥ï</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ÊÄªÁªì"><span class="nav-number">3.</span> <span class="nav-text">ÊÄªÁªì</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ÂèÇËÄÉ"><span class="nav-number">4.</span> <span class="nav-text">ÂèÇËÄÉ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <a href="/mylove" style="border-bottom:none">
    <i class="fa fa-heart"></i>
    </a>
  </span>
  <span class="author" itemprop="copyrightHolder">ejunjsh</span>

  
</div>


  <div class="powered-by">
    Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    Theme &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Gemini
    </a>
  </div>


        







        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.2"></script>



  

  

  

  

  

  

</body>
</html>
