<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="java,æ•°æ®ç»“æ„,conccurenthashmap," />





  <link rel="alternate" href="/atom.xml" title="IdiotSky" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢">
<meta name="keywords" content="java,æ•°æ®ç»“æ„,conccurenthashmap">
<meta property="og:type" content="article">
<meta property="og:title" content="java concurrenthashmapè§£æ">
<meta property="og:url" content="http://idiotsky.top/2018/07/28/java-concurrenthashmap/index.html">
<meta property="og:site_name" content="IdiotSky">
<meta property="og:description" content="åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-09-11T15:30:24.223Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java concurrenthashmapè§£æ">
<meta name="twitter:description" content="åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '4C652JRMON',
      apiKey: 'ef468e206fb85903f33c4fc8b4bb2cd6',
      indexName: 'myblog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://idiotsky.top/2018/07/28/java-concurrenthashmap/"/>





  <title>java concurrenthashmapè§£æ | IdiotSky</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c2da852ee703ae71196b173fd6edef51";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IdiotSky</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            Books
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://idiotsky.top/2018/07/28/java-concurrenthashmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ejunjsh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars7.githubusercontent.com/u/22493186?v=4&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IdiotSky">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">java concurrenthashmapè§£æ</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-28T15:31:20+08:00">
                28 Jul 18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>åªå‰©ä¸‹è¿™ä¸ªæ²¡æœ‰markäº†ï¼Œååè¿™æ—¶å€™ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œæ‚²å‰§äº†ğŸ˜¢</p>
</blockquote>
<a id="more"></a>
<p>æˆ‘ä»¬å¯¹JDK1.8ç‰ˆæœ¬çš„ConcurrentHashMapè¿›è¡Œè¯´æ˜ï¼Œ1.8ç‰ˆæœ¬çš„ConcurrentHashMapç›¸æ¯”ä¹‹å‰çš„ç‰ˆæœ¬ä¸»è¦åšäº†ä¸¤å¤„æ”¹è¿›:</p>
<ul>
<li>ä½¿ç”¨CASä»£æ›¿åˆ†æ®µé”ã€‚</li>
<li>çº¢é»‘æ ‘ï¼Œè¿™ä¸€ç‚¹å’ŒHashMapæ˜¯ä¸€è‡´çš„ã€‚</li>
</ul>
<h1 id="put"><a href="#put" class="headerlink" title="put"></a>put</h1><p>æœ€æ ¸å¿ƒçš„ä¾¿æ˜¯putæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åä¸€ä¸ªå‚æ•°ä¸ºonlyIfAbsentï¼Œè¡¨ç¤ºåªæœ‰åœ¨keyå¯¹åº”çš„valueä¸å­˜åœ¨æ—¶æ‰å°†valueåŠ å…¥ï¼Œæ‰€ä»¥putValæ˜¯putå’ŒputIfAbsentä¸¤ä¸ªæ–¹æ³•çš„çœŸæ­£å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//volatileè¯»</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//èŠ‚ç‚¹æ·»åŠ </span></span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tableä¾¿æ˜¯å…¶æ•°æ®çš„å­˜æ”¾è½½ä½“:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯volatileçš„ã€‚</p>
<h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><p>å¦‚æœtableä¸ºç©ºæˆ–å¤§å°ä¸º0ï¼Œé‚£ä¹ˆå°†å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼ŒinitTable:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="comment">//volatileè¯»</span></span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//volatileè¯»</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">//sizeCtlè®¾ä¸ºå½“å‰å¤§å°çš„3 / 4</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sizeCtlæ˜¯ConcurrentHashMapçš„åˆå§‹åŒ–ï¼Œæ‰©å®¹æ“ä½œä¸­ä¸€ä¸ªè‡³å…³é‡è¦çš„æ§åˆ¶å˜é‡ï¼Œå…¶å£°æ˜:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br></pre></td></tr></table></figure>
<p>å…¶å–å€¼å¯èƒ½ä¸º:</p>
<ul>
<li>0: åˆå§‹å€¼ã€‚</li>
</ul>
<ul>
<li>-1: æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–ã€‚</li>
<li>è´Ÿå€¼(å°äº-1): è¡¨ç¤ºæ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œå› ä¸ºConcurrentHashMapæ”¯æŒå¤šçº¿ç¨‹å¹¶è¡Œæ‰©å®¹ã€‚</li>
<li>æ­£æ•°: è¡¨ç¤ºä¸‹ä¸€æ¬¡è§¦å‘æ‰©å®¹çš„ä¸´ç•Œå€¼å¤§å°ï¼Œå³å½“å‰å€¼ * 0.75(è´Ÿè½½å› å­)ã€‚</li>
</ul>
<p>ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼ŒConcurrentHashMapåªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå½“å…¶å®ƒçº¿ç¨‹ç«äº‰å¤±è´¥(sizeCtl &lt; 0)æ—¶ä¾¿ä¼šè¿›è¡Œè‡ªæ—‹ï¼Œç›´åˆ°ç«äº‰æˆåŠŸ(åˆå§‹åŒ–)çº¿ç¨‹å®Œæˆåˆå§‹åŒ–ï¼Œé‚£ä¹ˆæ­¤æ—¶tableä¾¿ä¸å†ä¸ºnullï¼Œä¹Ÿå°±é€€å‡ºäº†whileå¾ªç¯ã€‚</p>
<p>Thread.yieldæ–¹æ³•ç”¨äºæç¤ºCPUå¯ä»¥æ”¾å¼ƒå½“å‰çº¿ç¨‹çš„æ‰§è¡Œï¼Œå½“ç„¶è¿™åªæ˜¯ä¸€ä¸ªæç¤º(hint)ï¼Œè¿™é‡Œå¯¹æ­¤æ–¹æ³•çš„è°ƒç”¨æ˜¯ä¸€ä¸ªä¼˜åŒ–æ‰‹æ®µã€‚</p>
<p>å¯¹SIZECTLå­—æ®µCASæ›´æ–°çš„æˆåŠŸä¾¿æ ‡å¿—è€…çº¿ç¨‹èµ¢å¾—äº†ç«äº‰ï¼Œå¯ä»¥è¿›è¡Œåˆå§‹åŒ–å·¥ä½œäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä¸€ä¸ªæ•°ç»„çš„æ„é€ è¿‡ç¨‹ï¼Œä¸€ç›®äº†ç„¶ã€‚</p>
<h2 id="å¤´ç»“ç‚¹è®¾ç½®"><a href="#å¤´ç»“ç‚¹è®¾ç½®" class="headerlink" title="å¤´ç»“ç‚¹è®¾ç½®"></a>å¤´ç»“ç‚¹è®¾ç½®</h2><p>å¦‚æœkeyå¯¹åº”çš„binä¸ºç©ºï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°†ç»™å®šçš„èŠ‚ç‚¹ è®¾ä¸ºå¤´ç»“ç‚¹å³å¯ï¼Œè¿™é‡Œå¯¹åº”putValæºç ä¸­çš„ä¸‹é¢çš„éƒ¨åˆ†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>, <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒtabAtæ˜¯ä¸€æ¬¡volatileè¯»ï¼ŒcasTabAtä¸ºCASæ“ä½œã€‚</p>
<h2 id="èŠ‚ç‚¹æ·»åŠ "><a href="#èŠ‚ç‚¹æ·»åŠ " class="headerlink" title="èŠ‚ç‚¹æ·»åŠ "></a>èŠ‚ç‚¹æ·»åŠ </h2><p>å¦‚æœkeyå¯¹åº”çš„binä¸ä¸º nullï¼Œé‚£ä¹ˆå°±è¯´æ˜éœ€è¦è¿›è¡ŒèŠ‚ç‚¹æ·»åŠ ï¼Œä»æºç å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œå¯¹binçš„å¤´ç»“ç‚¹è¿›è¡Œäº†åŠ é”æ“ä½œã€‚æˆ‘çš„ç†è§£ä¸ºï¼Œè¿™é‡Œéœ€è¦<strong>éå†æ•´ä¸ªé“¾è¡¨æˆ–æœç´¢çº¢é»‘æ ‘ä»¥åˆ¤æ–­ç»™å®šçš„èŠ‚ç‚¹(å€¼)æ˜¯å¦å·²å­˜åœ¨ï¼ŒåŒæ—¶éœ€è¦è®°å½•é“¾è¡¨èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œä»¥å†³å®šæ˜¯å¦éœ€è¦å°†å…¶è½¬åŒ–ä¸ºçº¢é»‘æ ‘</strong>ã€‚</p>
<h2 id="è½¬ä¸ºçº¢é»‘æ ‘"><a href="#è½¬ä¸ºçº¢é»‘æ ‘" class="headerlink" title="è½¬ä¸ºçº¢é»‘æ ‘"></a>è½¬ä¸ºçº¢é»‘æ ‘</h2><p>æŒ‡putValæºç ä¸­çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">        treeifyBin(tab, i);</span><br><span class="line">    <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> oldVal;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œè¿™æ®µä»£ç æ˜¯åœ¨ä¸Šè¿°(èŠ‚ç‚¹æ·»åŠ éƒ¨åˆ†)åŒæ­¥ä»£ç å—ä¹‹å¤–æ‰§è¡Œçš„ã€‚</p>
<p>TREEIFY_THRESHOLDè¡¨ç¤ºå°†é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„é“¾è¡¨é•¿åº¦çš„ä¸´ç•Œå€¼ï¼Œé»˜è®¤ä¸º8.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            <span class="comment">//æ‰©å®¹</span></span><br><span class="line">            tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h3><p>å¦‚æœå½“å‰binçš„ä¸ªæ•°æœªè¾¾åˆ°MIN_TREEIFY_CAPACITYï¼Œé‚£ä¹ˆä¸å†è½¬ä¸ºçº¢é»‘æ ‘ï¼Œè½¬è€Œè¿›è¡Œæ‰©å®¹ã€‚MIN_TREEIFY_CAPACITYé»˜è®¤ä¸º64.tryPresize:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryPresize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">        tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="comment">//volatileè¯»ï¼Œæ²¡æœ‰æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹çš„æ“ä½œ</span></span><br><span class="line">    <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; <span class="keyword">int</span> n;</span><br><span class="line">        <span class="comment">//è¿™é‡Œå®é™…ä¸Šè¿›è¡Œäº†åˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å·²è¾¾åˆ°æœ€å¤§å€¼ï¼Œæ— æ³•å†è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//ç«äº‰å¤±è´¥</span></span><br><span class="line">                Node&lt;K,V&gt;[] nt;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆ</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ç«äº‰æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰é¢æåˆ°è¿‡äº†ï¼ŒConcurrentHashMapæ”¯æŒå¤šçº¿ç¨‹å¹¶è¡Œæ‰©å®¹ï¼Œå…·ä½“æ¥è¯´ï¼Œæ˜¯æ”¯æŒ<strong>å¤šçº¿ç¨‹å°†èŠ‚ç‚¹ä»è€çš„æ•°ç»„æ‹·è´åˆ°æ–°çš„æ•°ç»„</strong>ï¼Œè€Œæ–°æ•°ç»„åˆ›å»ºä»æ˜¯ä¸€ä¸ªçº¿ç¨‹å®Œæˆ(ä¸ç„¶å¤šä¸ªçº¿ç¨‹åˆ›å»ºå¤šä¸ªå¯¹è±¡ï¼Œæœ€ååªä½¿ç”¨ä¸€ä¸ªï¼Œè¿™ä¸æ˜¯æµªè´¹æ˜¯ä»€ä¹ˆ?)</p>
<p>ç«äº‰æˆåŠŸçš„çº¿ç¨‹ä¸ºtransferæ–¹æ³•çš„nextTabå‚æ•°ä¼ å…¥nullï¼Œè¿™å°†å¯¼è‡´æ–°æ•°ç»„çš„åˆ›å»ºã€‚ç«äº‰å¤±è´¥çš„çº¿ç¨‹å°†ä¼šåˆ¤æ–­å½“å‰èŠ‚ç‚¹è½¬ç§»å·¥ä½œæ˜¯å¦å·²ç»å®Œæˆï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œé‚£ä¹ˆæ„å‘³ç€æ‰©å®¹çš„å®Œæˆï¼Œé€€å‡ºå³å¯ï¼Œå¦‚æœæ²¡æœ‰å®Œæˆï¼Œé‚£ä¹ˆæ­¤çº¿ç¨‹å°†ä¼šè¿›è¡Œè¾…åŠ©è½¬ç§»ã€‚</p>
<p>åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆçš„æ¡ä»¶åªèƒ½ç†è§£(nt = nextTable) == null || transferIndex &lt;= 0ä¸¤ä¸ªã€‚</p>
<h4 id="è½¬ç§»"><a href="#è½¬ç§»" class="headerlink" title="è½¬ç§»"></a>è½¬ç§»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">    <span class="comment">//1. åˆ†ç‰‡</span></span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">    <span class="comment">//nextTabåˆå§‹åŒ–ï¼ŒCASä¿è¯äº†åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™é‡Œçš„ä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="comment">//åˆ†ç‰‡çš„æœ€å¤§ä¸‹æ ‡iå®é™…ä¸Šå°±æ˜¯åœ¨è¿™é‡Œå®Œæˆå‡ä¸€çš„ï¼Œå› ä¸ºä»ä¸‹é¢å¯ä»¥çœ‹å‡ºï¼Œæ¯å¤„ç†å®Œä¸€ä¸ªæ¡¶ä½ä¾¿å°†advanceè®¾ä¸ºtrue			 //ä»è€Œä¾¿åˆè¿›å…¥äº†å†…å±‚å¾ªç¯ï¼Œä½†æ˜¯æ³¨æ„ï¼Œå½“æœ€åä¸€æ¬¡(å³bound)å¤„ç†å®Œæˆæ—¶ï¼Œiä¼šè¢«å†æ¬¡å‡ä¸€ï¼Œä»è€Œå¯¼è‡´è¿›å…¥ä¸‹é¢çš„			//åˆ†æ”¯å†æ¬¡è¯»å–transferIndexï¼Œè¿™å°±è¯´æ˜äº†è½¬ç§»çº¿ç¨‹ä¼šåœ¨è½¬ç§»å®Œä¸€ä¸ªåˆ†ç‰‡åç»§ç»­å°è¯•å‰©ä½™çš„åˆ†ç‰‡(æ¡¶ä½)</span></span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//æ‰€æœ‰binå‡è½¬ç§»å®Œæ¯•</span></span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ç”³è¯·åˆ†ç‰‡</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                     (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      nextBound = (nextIndex &gt; stride ? nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="comment">//boundè¡¨ç¤ºæ­¤åˆ†ç‰‡çš„æˆªæ­¢(æœ€å°)ä¸‹æ ‡</span></span><br><span class="line">                bound = nextBound;</span><br><span class="line">                <span class="comment">//iè¡¨ç¤ºæ­¤åˆ†ç‰‡çš„æœ€å¤§ä¸‹æ ‡</span></span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//advanceæ„ä¸ºå‰è¿›ï¼Œè·³å‡ºå†…å±‚å¾ªç¯</span></span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="comment">//è¿›å…¥åˆ°è¿™é‡Œå°±æ„å‘³ç€æ‰€æœ‰çš„æ¡¶ä½éƒ½å·²è¢«å¤„ç†å®Œæ¯•æˆ–æ˜¯è¢«åŒ…å«åœ¨æŸä¸ªè½¬ç§»çº¿ç¨‹çš„ç”³è¯·åˆ†ç‰‡ä¸­(å³å¾…è½¬ç§»)</span></span><br><span class="line">            <span class="keyword">int</span> sc;</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                <span class="comment">//è¿›è¡Œæ”¶å°¾å·¥ä½œï¼Œæ­¤å·¥ä½œä¸€å®šæ˜¯ç”±æœ€åä¸€ä¸ªåˆ†ç‰‡ç”³è¯·çº¿ç¨‹è¿›è¡Œçš„ï¼Œè¿™é‡Œç”¨volatileå†™å°†nextTableç½®ä¸ºnull</span></span><br><span class="line">                <span class="comment">//ï¼ŒtableæŒ‡å‘æ–°æ•°ç»„</span></span><br><span class="line">                nextTable = <span class="keyword">null</span>;</span><br><span class="line">                table = nextTab;</span><br><span class="line">                <span class="comment">//sizeCtlè®¾ä¸ºæ–°æ•°ç»„å¤§å°çš„3 / 4</span></span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è½¬ç§»çº¿ç¨‹å¼€å§‹è½¬ç§»ä¹‹å‰ä¼šå°†sizeCtlè‡ªå¢ï¼Œè½¬ç§»å®Œæˆä¹‹åè‡ªå‡ï¼Œæ‰€ä»¥åˆ¤æ–­è½¬ç§»æ˜¯å¦å·²ç»å®Œæˆçš„æ–¹å¼ä¾¿æ˜¯sizeCtlæ˜¯			  //å¦ç­‰äºåˆå§‹å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="comment">//è¿˜æœ‰å…¶å®ƒçº¿ç¨‹å°šæœªè½¬ç§»å®Œæˆï¼Œç›´æ¥é€€å‡ºï¼Œå°†æ”¶å°¾å·¥ä½œäº¤ç»™æœ€åå®Œæˆçš„é‚£ä¸ªçº¿ç¨‹</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">//è¿›è¡Œåˆ°è¿™é‡Œå°±è¯´æ˜å½“å‰çº¿ç¨‹ä¸ºæœ€åä¸€ä¸ªå®Œæˆçš„çº¿ç¨‹ï¼Œæœ‰æ„æ€çš„æ˜¯è¿™é‡Œåˆå°†advanceç½®ä¸ºtrueä¸”iç½®ä¸ºn(åŸ)</span></span><br><span class="line">                <span class="comment">//æ•°ç»„çš„å¤§å°ï¼Œä½œç”¨å°±æ˜¯æœ€åå†å…¨éƒ¨æ‰«æä¸€éæ‰€æœ‰çš„æ¡¶ä½ï¼Œçœ‹æ˜¯å¦è¿˜æœ‰æ¼ç½‘ä¹‹é±¼</span></span><br><span class="line">                finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                i = n;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//2.</span></span><br><span class="line">            advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">//3. è½¬ç§»ç®—æ³•</span></span><br><span class="line">                <span class="comment">//åŒé‡æ£€æŸ¥</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//runBitä»£è¡¨äº†å½“å‰æ¡¶ä½æ˜¯å¦éœ€è¦ç§»åŠ¨</span></span><br><span class="line">                        <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="comment">//è¿™é‡Œæ˜¯æ‰¾å‡ºæœ€åä¸€ä¸ªå’Œå¤´ç»“ç‚¹çš„ç§»åŠ¨å±æ€§ç›¸åŒçš„</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;</span><br><span class="line">                            hn = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//æ„é€ æ— éœ€ç§»åŠ¨å’Œéœ€è¦ç§»åŠ¨çš„é“¾è¡¨</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//è®¾ç½®åˆ°æ–°æ•°ç»„</span></span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        <span class="comment">//å°†åŸæ•°ç»„çš„å½“å‰æ¡¶ä½è®¾ä¸ºMOVEDï¼Œå³å·²å¤„ç†å®Œ(è½¬ç§»)</span></span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="åˆ†ç‰‡"><a href="#åˆ†ç‰‡" class="headerlink" title="åˆ†ç‰‡"></a>åˆ†ç‰‡</h5><p>æ¯ä¸ªçº¿ç¨‹é’ˆå¯¹ä¸€ä¸ªåˆ†ç‰‡æ¥è¿›è¡Œè½¬ç§»æ“ä½œï¼Œæ‰€è°“çš„ä¸€ä¸ªåˆ†ç‰‡å…¶å®å°±æ˜¯binæ•°ç»„çš„ä¸€æ®µã€‚é»˜è®¤çš„æœ€å°åˆ†ç‰‡å¤§å°ä¸º16ï¼Œå¦‚æœæ‰€åœ¨æœºå™¨ åªæœ‰ä¸€ä¸ªCPUæ ¸å¿ƒï¼Œé‚£ä¹ˆå°±å–16ï¼Œå¦åˆ™å–(æ•°ç»„å¤§å° / 8 / CPUæ ¸å¿ƒæ•°)ä¸16çš„è¾ƒå¤§è€…ã€‚</p>
<h5 id="transferIndex"><a href="#transferIndex" class="headerlink" title="transferIndex"></a>transferIndex</h5><p>å…¨å±€å˜é‡transferIndexè¡¨ç¤ºä½äºæ­¤å€¼çš„binå°šæœªè¢«è½¬ç§»ï¼Œåˆ†ç‰‡çš„ç”³è¯·ä¾¿æ˜¯é€šè¿‡å¯¹æ­¤å˜é‡çš„CASæ“ä½œæ¥å®Œæˆï¼Œåˆå§‹å€¼ä¸ºåŸæ•°ç»„å¤§å°ï¼Œå‡ä¸º0è¡¨ç¤º æ‰€æœ‰æ¡¶ä½å‡å·²è½¬ç§»å®Œæ¯•ã€‚</p>
<h5 id="ForwardingNode"><a href="#ForwardingNode" class="headerlink" title="ForwardingNode"></a>ForwardingNode</h5><p>ä»transferæ–¹æ³•çš„æºç å¯ä»¥çœ‹å‡ºï¼Œå½“ä¸€ä¸ªæ¡¶ä½(åŸæ•°ç»„)å¤„ç†å®Œæ—¶ï¼Œä¼šå°†å…¶å¤´ç»“ç‚¹è®¾ç½®ä¸€ä¸ªForwardingNodeã€‚ç®€ç•¥ç‰ˆæºç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">    ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">        <span class="keyword">super</span>(MOVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.nextTable = tab;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å“ˆå¸Œå€¼ä¸ºMOVEDã€‚åˆ°è¿™é‡Œæˆ‘ä»¬ä¾¿å¯ä»¥ç†è§£putValæ–¹æ³•è¿™éƒ¨åˆ†æºç çš„ä½œç”¨äº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">    tab = helpTransfer(tab, f);</span><br></pre></td></tr></table></figure>
<p>helpTransferæ–¹æ³•çš„å®ç°å’ŒtryPresizeæ–¹æ³•çš„ç›¸å…³ä»£ç å¾ˆåƒï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚</p>
<h5 id="è½¬ç§»ç®—æ³•"><a href="#è½¬ç§»ç®—æ³•" class="headerlink" title="è½¬ç§»ç®—æ³•"></a>è½¬ç§»ç®—æ³•</h5><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥é“¾è¡¨ä¸ºä¾‹ï¼Œå¯¹äº2çš„æ•´æ¬¡å¹‚æ‰©å®¹æ¥è¯´ï¼ŒèŠ‚ç‚¹çš„è½¬ç§»å…¶å®åªæœ‰ä¸¤ç§æƒ…å†µ:</p>
<ul>
<li>æ— éœ€è½¬ç§»ï¼Œå³æ‰©å®¹å‰åèŠ‚ç‚¹çš„æ¡¶ä½ä¸å˜ã€‚</li>
<li>æ‰©å®¹åçš„æ¡¶ä½å·ä¸ºæ‰©å®¹å‰ + åŸæ•°ç»„çš„å¤§å°ï¼Œå‡è®¾åŸæ•°ç»„å¤§å°ä¸º8ï¼Œæ‰©å®¹åä¸º16ï¼Œæœ‰èŠ‚ç‚¹å“ˆå¸Œå€¼ä¸º11ï¼ŒåŸå…ˆåœ¨æ¡¶ä½3ï¼Œé‚£ä¹ˆæ‰©å®¹åä½3 + 8 = 11.</li>
</ul>
<p>æ‰€ä»¥å…³é”®ä¾¿åœ¨äºå¦‚ä½•åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬ç§»ã€‚è¿˜æ˜¯ä»¥å¤§å°8å’Œ16ä¸ºä¾‹ï¼Œ8çš„å–ä½™maskä¸º:</p>
<p>0111</p>
<p>è€Œ16çš„maskä¸º:</p>
<p>1111</p>
<p>æ‰€ä»¥æˆ‘ä»¬åªè¦ç”¨å“ˆå¸Œå€¼ &amp; 8ï¼Œåˆ¤æ–­ç»“æœæ˜¯å¦ä¸ºé›¶å³å¯ã€‚</p>
<h3 id="çº¢é»‘æ ‘"><a href="#çº¢é»‘æ ‘" class="headerlink" title="çº¢é»‘æ ‘"></a>çº¢é»‘æ ‘</h3><p>å†æ¥å›é¡¾ä¸€ä¸‹treeifyBinæ–¹æ³•çš„ç›¸å…³æºç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">        <span class="comment">//åŒé‡æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                    hd = p;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    tl.next = p;</span><br><span class="line">                tl = p;</span><br><span class="line">            &#125;</span><br><span class="line">            setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯è§ï¼Œå‘çº¢é»‘æ ‘çš„è½¬æ¢æ˜¯åœ¨é”çš„ä¿æŠ¤ä¸‹è¿›è¡Œçš„ï¼Œé€šè¿‡ä¸€ä¸ªforå¾ªç¯å°†æ‰€æœ‰çš„èŠ‚ç‚¹ä»¥TreeNodeåŒ…è£…èµ·æ¥ï¼Œæ³¨æ„ï¼Œåœ¨å¾ªç¯é‡Œåªæ˜¯é€šè¿‡nextå±æ€§è¿›è¡Œè¿æ¥ï¼Œæ­¤æ—¶å®é™…ä¸Šè¿˜æ˜¯ä¸€ä¸ªé“¾è¡¨å½¢æ€ï¼Œè€ŒçœŸæ­£çš„è½¬åŒ–æ˜¯åœ¨TreeBinçš„æ„é€ å™¨ä¸­å®Œæˆçš„ã€‚</p>
<p>å’ŒForwardingNodeä¸€æ ·ï¼ŒTreeBinåŒæ ·å…·æœ‰ç‰¹æ®Šçš„å“ˆå¸Œå€¼:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<h1 id="get"><a href="#get" class="headerlink" title="get"></a>get</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">    <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp; (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="comment">//å‘½ä¸­å¤´ç»“ç‚¹</span></span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//éå†å½“å‰æ¡¶ä½çš„èŠ‚ç‚¹é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰æ„æ€çš„åœ¨äºç¬¬äºŒä¸ªåˆ†æ”¯ï¼Œå³å“ˆå¸Œå€¼å°äºé›¶ã€‚ä»ä¸Šé¢putæ–¹æ³•éƒ¨åˆ†å¯ä»¥å¾—çŸ¥ï¼Œå…±æœ‰ä¸¤ç§æƒ…å†µèŠ‚ç‚¹çš„å“ˆå¸Œå€¼å°äº0:</p>
<ul>
<li>ForwardingNodeï¼Œå·²è¢«è½¬ç§»ã€‚</li>
<li>TreeBinï¼Œçº¢é»‘æ ‘èŠ‚ç‚¹ã€‚</li>
</ul>
<h2 id="ForwardingNode-1"><a href="#ForwardingNode-1" class="headerlink" title="ForwardingNode"></a>ForwardingNode</h2><p>findæ–¹æ³•æºç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">    outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span> || tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">            (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> eh; K ek;</span><br><span class="line">            <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp; ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e;</span><br><span class="line">            <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                    <span class="comment">//è·³è½¬åˆ°nextTableæœç´¢</span></span><br><span class="line">                    tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                    <span class="keyword">continue</span> outer;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">//çº¢é»‘æ ‘</span></span><br><span class="line">                    <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="çº¢é»‘æ ‘-1"><a href="#çº¢é»‘æ ‘-1" class="headerlink" title="çº¢é»‘æ ‘"></a>çº¢é»‘æ ‘</h2><p>TreeBin.find:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; e = first; e != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">            <span class="keyword">int</span> s; K ek;</span><br><span class="line">            <span class="keyword">if</span> (((s = lockState) &amp; (WAITER|WRITER)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == h &amp;&amp; ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">                e = e.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, LOCKSTATE, s, s + READER)) &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    p = ((r = root) == <span class="keyword">null</span> ? <span class="keyword">null</span> : r.findTreeNode(h, k, <span class="keyword">null</span>));</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    Thread w;</span><br><span class="line">                    <span class="keyword">if</span> (U.getAndAddInt(<span class="keyword">this</span>, LOCKSTATE, -READER) ==</span><br><span class="line">                        (READER|WAITER) &amp;&amp; (w = waiter) != <span class="keyword">null</span>)</span><br><span class="line">                        LockSupport.unpark(w);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä½¿ç”¨äº†è¯»å†™é”çš„æ–¹å¼ï¼Œè€ŒåŠ é”çš„æ–¹å¼å’ŒAQSä¸€ä¸ªå¥—è·¯ã€‚å½“å¯ä»¥è·å¾—è¯»é”æ—¶ï¼Œé‡‡ç”¨æœç´¢çº¢é»‘æ ‘çš„æ–¹æ³•è¿›è¡ŒèŠ‚ç‚¹æœç´¢ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦æ˜¯O(LogN)ï¼Œè€Œå¦‚æœè·å¾—è¯»é”å¤±è´¥(å³è¡¨ç¤ºå½“å‰æœ‰å…¶å®ƒçº¿ç¨‹æ­£åœ¨<strong>æ”¹å˜æ ‘çš„ç»“æ„</strong>ï¼Œæ¯”å¦‚è¿›è¡Œçº¢é»‘æ ‘çš„å†å¹³è¡¡)ï¼Œé‚£ä¹ˆå°†é‡‡ç”¨çº¿æ€§çš„æœç´¢ç­–ç•¥ã€‚</p>
<p>ä¸ºä»€ä¹ˆå¯ä»¥è¿›è¡Œçº¿æ€§æœç´¢å‘¢?å› ä¸ºçº¢é»‘æ ‘çš„èŠ‚ç‚¹TreeNodeç»§æ‰¿è‡ªNodeï¼Œæ‰€ä»¥<strong>ä»ç„¶ä¿ç•™æœ‰nextæŒ‡é’ˆ(å³çº¿æ€§éå†çš„èƒ½åŠ›)</strong>ã€‚è¿™ä¸€ç‚¹å¯ä»¥ä»put-è½¬ä¸ºçº¢é»‘æ ‘-çº¢é»‘æ ‘ä¸€èŠ‚å¾—åˆ°åæ˜ ï¼Œçº¿æ€§æœç´¢çš„çº¿ç¨‹å®‰å…¨æ€§é€šè¿‡nextå±æ€§æ¥ä¿è¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br></pre></td></tr></table></figure>
<p>TreeBinçš„æ„é€ å™¨åŒæ ·å¯¹æ ‘çš„ç»“æ„è¿›è¡Œäº†æ”¹å˜ï¼ŒConcurrentHashMapä½¿ç”¨volatileè¯»å†™æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‘å¸ƒã€‚</p>
<p>ä»è¯»å†™é”çš„å¼•å…¥å¯ä»¥çœ‹å‡ºï¼ŒConcurrentHashMapä¸ºä¿è¯æœ€å¤§ç¨‹åº¦çš„å¹¶è¡Œæ‰§è¡Œä½œå‡ºçš„åŠªåŠ›ã€‚putTreeValæ–¹æ³•åªæœ‰åœ¨æ›´æ–°æ ‘çš„ç»“æ„æ—¶æ‰ä¼šåŠ¨ç”¨é”:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lockRoot();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    root = balanceInsertion(root, x);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    unlockRoot();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºè¯»æ²¡æœ‰åŠ é”ï¼Œæ‰€ä»¥çº¿ç¨‹å¯ä»¥çœ‹åˆ°æ­£åœ¨è¿›è¡Œè¿ç§»çš„æ¡¶ï¼Œä½†è¿™å…¶å®å¹¶ä¸ä¼šå½±å“æ­£ç¡®æ€§ï¼Œå› ä¸ºè¿ç§»æ˜¯æ„é€ äº†æ–°çš„é“¾è¡¨ï¼Œå¹¶ä¸ä¼šå½±å“åŸæœ‰çš„æ¡¶ã€‚</p>
<h1 id="è®¡æ•°"><a href="#è®¡æ•°" class="headerlink" title="è®¡æ•°"></a>è®¡æ•°</h1><p>åœ¨putValæ–¹æ³•çš„ç»“å°¾é€šè¿‡è°ƒç”¨addCountæ–¹æ³•(ç•¥å»å¤§å°æ£€æŸ¥ï¼Œæ‰©å®¹éƒ¨åˆ†ï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒè®¡æ•°)è¿›è¡Œè®¡æ•°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">    CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">    <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">        !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">        CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®¡æ•°çš„å…³é”®ä¾¿æ˜¯counterCellså±æ€§:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure>
<p>CounterCellæ˜¯ConcurrentHashMapdçš„å†…éƒ¨ç±»:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterCell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    CounterCell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Contendedæ³¨è§£çš„ä½œç”¨æ˜¯å°†ç±»çš„å­—æ®µä»¥64å­—èŠ‚çš„å¡«å……è¡ŒåŒ…å›´ä»¥è§£å†³ä¼ªå…±äº«é—®é¢˜ã€‚å…¶å®è¿™é‡Œçš„è®¡æ•°æ–¹å¼å°±æ˜¯æ”¹ç¼–è‡ªLongAdderï¼Œä»¥æœ€å¤§ç¨‹åº¦åœ°é™ä½CASå¤±è´¥ç©ºè½¬çš„å‡ ç‡ã€‚</p>
<p>æ¡ä»¶åˆ¤æ–­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> || !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éå¸¸æœ‰æ„æ€ ï¼Œå¦‚æœcounterCellsä¸ºnullï¼Œé‚£ä¹ˆå°è¯•ç”¨baseCountè¿›è¡Œè®¡æ•°ï¼Œå¦‚æœäº‹å®ä¸Šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆ–å¤šä¸ªçº¿ç¨‹å•ç«äº‰çš„é¢‘ç‡è¾ƒä½ï¼Œå¯¹baseCountçš„CASæ“ä½œå¹¶ä¸ä¼šå¤±è´¥ï¼Œæ‰€ä»¥å¯ä»¥å¾—åˆ°ç»“è®º : <strong>å¦‚æœç«äº‰ç¨‹åº¦è¾ƒä½(æ²¡æœ‰CASå¤±è´¥)ï¼Œé‚£ä¹ˆå…¶å®ç”¨çš„æ˜¯volatileå˜é‡baseCountæ¥è®¡æ•°ï¼Œåªæœ‰å½“çº¿ç¨‹ç«äº‰ä¸¥é‡(å‡ºç°CASå¤±è´¥)æ—¶æ‰ä¼šæ”¹ç”¨LongAdderçš„æ–¹å¼</strong>ã€‚</p>
<p>baseCountå£°æ˜å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br></pre></td></tr></table></figure>
<p>å†æ¥çœ‹ä¸€ä¸‹ä»€ä¹ˆæ¡ä»¶ä¸‹ä¼šè§¦å‘fullAddCountæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">    !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ThreadLocalRandom.getProbe()çš„è¿”å›å€¼å†³å®šäº†çº¿ç¨‹å’Œå“ªä¸€ä¸ªCounterCellç›¸å…³è”ï¼ŒæŸ¥çœ‹æºç å¯ä»¥å‘ç°ï¼Œæ­¤æ–¹æ³•è¿”å›çš„å…¶å®æ˜¯Threadçš„ä¸‹åˆ—å­—æ®µçš„å€¼:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended(<span class="string">"tlr"</span>)</span><br><span class="line"><span class="keyword">int</span> threadLocalRandomProbe;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æš‚ä¸”ä¸ç®¡è¿™ä¸ªå€¼æ˜¯æ€ä¹ˆç®—å‡ºæ¥ï¼Œå°†å…¶å½“åšä¸€ä¸ª<strong>çº¿ç¨‹å”¯ä¸€</strong>çš„å€¼å³å¯ã€‚æ‰€ä»¥fullAddCountæ‰§è¡Œçš„æ¡ä»¶æ˜¯(æˆ–):</p>
<ul>
<li>CounterCellæ•°ç»„ä¸ºnullã€‚</li>
<li>CounterCellæ•°ç»„å¤§å°ä¸º0.</li>
<li>CounterCellæ•°ç»„çº¿ç¨‹å¯¹åº”çš„ä¸‹æ ‡å€¼ä¸ºnullã€‚</li>
<li>CASæ›´æ–°çº¿ç¨‹ç‰¹å®šçš„CounterCellå¤±è´¥ã€‚</li>
</ul>
<p>fullAddCountæ–¹æ³•çš„å®ç°å…¶å®å’ŒLongAdderçš„çˆ¶ç±»Striped64çš„longAccumulateå¤§ä½“ä¸€è‡´:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">fullAddCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">if</span> ((h = ThreadLocalRandom.getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        ThreadLocalRandom.localInit();      <span class="comment">// force initialization</span></span><br><span class="line">        h = ThreadLocalRandom.getProbe();</span><br><span class="line">        wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        CounterCell[] as; CounterCell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="comment">//1.</span></span><br><span class="line">        <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;            <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                    CounterCell r = <span class="keyword">new</span> CounterCell(x); <span class="comment">// Optimistic create</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            CounterCell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = counterCells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created)</span><br><span class="line">                            <span class="comment">//æ–°Cellåˆ›å»ºæˆåŠŸï¼Œé€€å‡ºæ–¹æ³•</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       <span class="comment">// CAS already known to fail</span></span><br><span class="line">                wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (counterCells != as || n &gt;= NCPU)</span><br><span class="line">                collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                collide = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//æ‰©å®¹</span></span><br><span class="line">                    <span class="keyword">if</span> (counterCells == as) &#123;<span class="comment">// Expand table unless stale</span></span><br><span class="line">                        CounterCell[] rs = <span class="keyword">new</span> CounterCell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        counterCells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//rehash</span></span><br><span class="line">            h = ThreadLocalRandom.advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; counterCells == as &amp;&amp; U.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//è·å¾—é”ä¹‹åå†æ¬¡æ£€æµ‹æ˜¯å¦å·²è¢«åˆå§‹åŒ–</span></span><br><span class="line">                <span class="keyword">if</span> (counterCells == as) &#123;</span><br><span class="line">                    CounterCell[] rs = <span class="keyword">new</span> CounterCell[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> CounterCell(x);</span><br><span class="line">                    counterCells = rs;</span><br><span class="line">                    init = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//é”é‡Šæ”¾</span></span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="comment">//è®¡æ•°æˆåŠŸï¼Œé€€å‡ºæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//3. </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, v = baseCount, v + x))</span><br><span class="line">            <span class="keyword">break</span>;                          <span class="comment">// Fall back on using base</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨åˆå§‹æƒ…å†µä¸‹probeå…¶å®æ˜¯0çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€å¼€å§‹çš„æ—¶å€™éƒ½æ˜¯æ›´æ–°åˆ°ç¬¬ä¸€ä¸ªcellä¸­çš„ï¼Œç›´åˆ°å‡ºç°CASå¤±è´¥ã€‚</p>
<p>æ•´ä¸ªæ–¹æ³•çš„é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œæˆ‘ä»¬æŒ‰ç…§ä¸Šé¢åˆ—å‡ºçš„fullAddCountæ‰§è¡Œæ¡ä»¶è¿›è¡Œå¯¹åº”è¯´æ˜ã€‚</p>
<h2 id="cellæ•°ç»„ä¸ºnullæˆ–empty"><a href="#cellæ•°ç»„ä¸ºnullæˆ–empty" class="headerlink" title="cellæ•°ç»„ä¸ºnullæˆ–empty"></a>cellæ•°ç»„ä¸ºnullæˆ–empty</h2><p>å®¹æ˜“çœ‹å‡ºï¼Œè¿™é‡Œå¯¹åº”çš„æ˜¯fullAddCountæ–¹æ³•çš„æºç 2å¤„ã€‚cellBusyçš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå…¶å®å°†å…¶å½“åšé”æ¥ä½¿ç”¨ï¼Œå³åªå…è®¸åœ¨æŸä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡ŒCounterCellæ•°ç»„çš„åˆå§‹åŒ–æˆ–æ‰©å®¹ï¼Œå…¶å€¼ä¸º1è¯´æ˜æœ‰çº¿ç¨‹æ­£åœ¨è¿›è¡Œä¸Šè¿°æ“ä½œã€‚</p>
<p>é»˜è®¤åˆ›å»ºäº†å¤§å°ä¸º2çš„CounterCellæ•°ç»„ã€‚</p>
<h2 id="ä¸‹æ ‡ä¸ºnullæˆ–CASå¤±è´¥"><a href="#ä¸‹æ ‡ä¸ºnullæˆ–CASå¤±è´¥" class="headerlink" title="ä¸‹æ ‡ä¸ºnullæˆ–CASå¤±è´¥"></a>ä¸‹æ ‡ä¸ºnullæˆ–CASå¤±è´¥</h2><p>è¿™é‡Œä¾¿å¯¹åº”æºç çš„1å¤„ï¼Œå„ç§æ¡ä»¶åˆ†æ”¯ä¸å†å±•å¼€è¯¦ç»†æè¿°ï¼Œæ³¨æ„ä¸€ä¸‹å‡ ç‚¹:</p>
<h3 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h3><p>å½“Cellæ•°ç»„ä¸ä¸ºnullå’Œemptyæ—¶ï¼Œæ¯æ¬¡å¾ªç¯ä¾¿ä¼šå¯¼è‡´é‡æ–°å“ˆå¸Œå€¼ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ç”¨å†æ¬¡ç”Ÿæˆå“ˆå¸Œå€¼çš„æ–¹å¼é™ä½çº¿ç¨‹ç«äº‰ã€‚</p>
<h3 id="æœ€å¤§CounterCellæ•°"><a href="#æœ€å¤§CounterCellæ•°" class="headerlink" title="æœ€å¤§CounterCellæ•°"></a>æœ€å¤§CounterCellæ•°</h3><p>å–NCPU:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡ä»ä¸Šé¢æ‰©å®¹éƒ¨åˆ†æºç å¯ä»¥çœ‹å‡ºï¼Œæœ€å¤§å€¼å¹¶ä¸ä¸€å®šæ˜¯NCPUï¼Œå› ä¸ºé‡‡ç”¨çš„æ˜¯2å€æ‰©å®¹ï¼Œå‡†ç¡®æ¥è¯´æ˜¯æœ€å°çš„å¤§äºç­‰äºNCPUçš„2çš„æ•´æ¬¡å¹‚(åˆå§‹å¤§å°ä¸º2)ã€‚</p>
<p>æ³¨æ„ä¸‹é¢è¿™ä¸ªåˆ†æ”¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (counterCells != as || n &gt;= NCPU)</span><br><span class="line">    collide = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>
<p>æ­¤åˆ†æ”¯ä¼šå°†collideç½®ä¸ºfalseï¼Œä»è€Œè‡´ä½¿ä¸‹æ¬¡å¾ªç¯<code>else if (!collide)</code>å¿…å®šå¾—åˆ°æ»¡è¶³ï¼Œè¿™ä¹Ÿå°±ä¿è¯äº†æ‰©å®¹åˆ†æ”¯ä¸ä¼šè¢«æ‰§è¡Œã€‚</p>
<h2 id="baseCountåˆ†æ”¯"><a href="#baseCountåˆ†æ”¯" class="headerlink" title="baseCountåˆ†æ”¯"></a>baseCountåˆ†æ”¯</h2><p>è¿˜ä¼šå°è¯•å¯¹æ­¤å˜é‡è¿›è¡Œæ›´æ–°ï¼Œæœ‰æ„æ€ã€‚</p>
<h1 id="size"><a href="#size" class="headerlink" title="size"></a>size</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> n = sumCount();</span><br><span class="line">    <span class="keyword">return</span> ((n &lt; <span class="number">0L</span>) ? <span class="number">0</span> : (n &gt; (<span class="keyword">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE : (<span class="keyword">int</span>)n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒåœ¨äºsumCountæ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">    <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ±‚å’Œçš„æ—¶å€™<strong>å¸¦ä¸Šäº†baseCount</strong>ï¼Œå‰©ä¸‹çš„å°± ä¸€ç›®äº†ç„¶äº†ã€‚</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/æ•°æ®ç»“æ„/" rel="tag"># æ•°æ®ç»“æ„</a>
          
            <a href="/tags/conccurenthashmap/" rel="tag"># conccurenthashmap</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/24/understanding-raft/" rel="next" title="ä¸€ä¸ªå¾ˆå¥½ç†è§£raftçš„åŠ¨ç”»æ¼”ç¤º">
                <i class="fa fa-chevron-left"></i> ä¸€ä¸ªå¾ˆå¥½ç†è§£raftçš„åŠ¨ç”»æ¼”ç¤º
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/28/java-g1/" rel="prev" title="æ·±å…¥ç†è§£Java G1åƒåœ¾æ”¶é›†å™¨">
                æ·±å…¥ç†è§£Java G1åƒåœ¾æ”¶é›†å™¨ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars7.githubusercontent.com/u/22493186?v=4&s=460"
               alt="ejunjsh" />
          <p class="site-author-name" itemprop="name">ejunjsh</p>
           
              <p class="site-description motion-element" itemprop="description">code freak</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">152</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">147</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ejunjsh" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/339238080" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:sjj050121014@163.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      Email
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/junjie.shao.9" target="_blank" title="FB Page">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                    
                      FB Page
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#put"><span class="nav-number">1.</span> <span class="nav-text">put</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆå§‹åŒ–"><span class="nav-number">1.1.</span> <span class="nav-text">åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¤´ç»“ç‚¹è®¾ç½®"><span class="nav-number">1.2.</span> <span class="nav-text">å¤´ç»“ç‚¹è®¾ç½®</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#èŠ‚ç‚¹æ·»åŠ "><span class="nav-number">1.3.</span> <span class="nav-text">èŠ‚ç‚¹æ·»åŠ </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è½¬ä¸ºçº¢é»‘æ ‘"><span class="nav-number">1.4.</span> <span class="nav-text">è½¬ä¸ºçº¢é»‘æ ‘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‰©å®¹"><span class="nav-number">1.4.1.</span> <span class="nav-text">æ‰©å®¹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#è½¬ç§»"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">è½¬ç§»</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#åˆ†ç‰‡"><span class="nav-number">1.4.1.1.1.</span> <span class="nav-text">åˆ†ç‰‡</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#transferIndex"><span class="nav-number">1.4.1.1.2.</span> <span class="nav-text">transferIndex</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ForwardingNode"><span class="nav-number">1.4.1.1.3.</span> <span class="nav-text">ForwardingNode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#è½¬ç§»ç®—æ³•"><span class="nav-number">1.4.1.1.4.</span> <span class="nav-text">è½¬ç§»ç®—æ³•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#çº¢é»‘æ ‘"><span class="nav-number">1.4.2.</span> <span class="nav-text">çº¢é»‘æ ‘</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#get"><span class="nav-number">2.</span> <span class="nav-text">get</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ForwardingNode-1"><span class="nav-number">2.1.</span> <span class="nav-text">ForwardingNode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#çº¢é»‘æ ‘-1"><span class="nav-number">2.2.</span> <span class="nav-text">çº¢é»‘æ ‘</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#è®¡æ•°"><span class="nav-number">3.</span> <span class="nav-text">è®¡æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#cellæ•°ç»„ä¸ºnullæˆ–empty"><span class="nav-number">3.1.</span> <span class="nav-text">cellæ•°ç»„ä¸ºnullæˆ–empty</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸‹æ ‡ä¸ºnullæˆ–CASå¤±è´¥"><span class="nav-number">3.2.</span> <span class="nav-text">ä¸‹æ ‡ä¸ºnullæˆ–CASå¤±è´¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#rehash"><span class="nav-number">3.2.1.</span> <span class="nav-text">rehash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æœ€å¤§CounterCellæ•°"><span class="nav-number">3.2.2.</span> <span class="nav-text">æœ€å¤§CounterCellæ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#baseCountåˆ†æ”¯"><span class="nav-number">3.3.</span> <span class="nav-text">baseCountåˆ†æ”¯</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#size"><span class="nav-number">4.</span> <span class="nav-text">size</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <a href="/mylove" style="border-bottom:none">
    <i class="fa fa-heart"></i>
    </a>
  </span>
  <span class="author" itemprop="copyrightHolder">ejunjsh</span>

  
</div>


  <div class="powered-by">
    Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    Theme &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Gemini
    </a>
  </div>


        







        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.2"></script>



  

  

  

  

  

  

</body>
</html>
